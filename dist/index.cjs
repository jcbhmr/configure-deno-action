import("data:text/javascript;base64,aW1wb3J0IHsgY3JlYXRlUmVxdWlyZSB9IGZyb20gIm5vZGU6bW9kdWxlIjsKaW1wb3J0IHJlcXVpcmUkJDAkMSBmcm9tICJvcyI7CmltcG9ydCAqIGFzIHJlcXVpcmUkJDAgZnJvbSAiZnMiOwppbXBvcnQgcmVxdWlyZSQkMF9fZGVmYXVsdCwgeyByZWFscGF0aFN5bmMgYXMgcmVhbHBhdGhTeW5jJDEsIGxzdGF0U3luYywgcmVhZGRpciwgcmVhZGRpclN5bmMsIHJlYWRsaW5rU3luYyB9IGZyb20gImZzIjsKaW1wb3J0IGNyeXB0byBmcm9tICJjcnlwdG8iOwppbXBvcnQgcmVxdWlyZSQkMCQyLCB7IHdpbjMyLCBwb3NpeCB9IGZyb20gInBhdGgiOwppbXBvcnQgcmVxdWlyZSQkMiQxIGZyb20gImh0dHAiOwppbXBvcnQgcmVxdWlyZSQkMyBmcm9tICJodHRwcyI7CmltcG9ydCAibmV0IjsKaW1wb3J0IHJlcXVpcmUkJDEgZnJvbSAidGxzIjsKaW1wb3J0IHJlcXVpcmUkJDQsIHsgRXZlbnRFbWl0dGVyIH0gZnJvbSAiZXZlbnRzIjsKaW1wb3J0ICJhc3NlcnQiOwppbXBvcnQgcmVxdWlyZSQkNiBmcm9tICJ1dGlsIjsKaW1wb3J0IHsgQnVmZmVyIGFzIEJ1ZmZlciQxIH0gZnJvbSAibm9kZTpidWZmZXIiOwppbXBvcnQgcGF0aCQ0LCB7IGpvaW4gfSBmcm9tICJub2RlOnBhdGgiOwppbXBvcnQgY2hpbGRQcm9jZXNzLCB7IENoaWxkUHJvY2VzcyB9IGZyb20gIm5vZGU6Y2hpbGRfcHJvY2VzcyI7CmltcG9ydCBwcm9jZXNzJDIgZnJvbSAibm9kZTpwcm9jZXNzIjsKaW1wb3J0IHJlcXVpcmUkJDAkMyBmcm9tICJjaGlsZF9wcm9jZXNzIjsKaW1wb3J0IHVybCBmcm9tICJub2RlOnVybCI7CmltcG9ydCBvcyQyLCB7IGNvbnN0YW50cywgdG1wZGlyIH0gZnJvbSAibm9kZTpvcyI7CmltcG9ydCB7IGNyZWF0ZVdyaXRlU3RyZWFtLCByZWFkRmlsZVN5bmMsIGNyZWF0ZVJlYWRTdHJlYW0gfSBmcm9tICJub2RlOmZzIjsKaW1wb3J0IHsgc2V0VGltZW91dCBhcyBzZXRUaW1lb3V0JDEgfSBmcm9tICJub2RlOnRpbWVycy9wcm9taXNlcyI7CmltcG9ydCBTdHJlYW0gZnJvbSAic3RyZWFtIjsKaW1wb3J0IHsgZGVidWdsb2cgfSBmcm9tICJub2RlOnV0aWwiOwppbXBvcnQgeyBmaWxlVVJMVG9QYXRoIH0gZnJvbSAidXJsIjsKaW1wb3J0IHsgbHN0YXQsIHJlYWRkaXIgYXMgcmVhZGRpciQxLCByZWFkbGluaywgcmVhbHBhdGggfSBmcm9tICJmcy9wcm9taXNlcyI7CmltcG9ydCB7IFN0cmluZ0RlY29kZXIgfSBmcm9tICJzdHJpbmdfZGVjb2RlciI7CmltcG9ydCB7IHBpcGVsaW5lIH0gZnJvbSAibm9kZTpzdHJlYW0vcHJvbWlzZXMiOwp2YXIgY29tbW9uanNHbG9iYWwgPSB0eXBlb2YgZ2xvYmFsVGhpcyAhPT0gInVuZGVmaW5lZCIgPyBnbG9iYWxUaGlzIDogdHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgPyB3aW5kb3cgOiB0eXBlb2YgZ2xvYmFsICE9PSAidW5kZWZpbmVkIiA/IGdsb2JhbCA6IHR5cGVvZiBzZWxmICE9PSAidW5kZWZpbmVkIiA/IHNlbGYgOiB7fTsKZnVuY3Rpb24gZ2V0RGVmYXVsdEV4cG9ydEZyb21DanMoeCkgewogIHJldHVybiB4ICYmIHguX19lc01vZHVsZSAmJiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoeCwgImRlZmF1bHQiKSA/IHhbImRlZmF1bHQiXSA6IHg7Cn0KZnVuY3Rpb24gZ2V0QXVnbWVudGVkTmFtZXNwYWNlKG4pIHsKICBpZiAobi5fX2VzTW9kdWxlKQogICAgcmV0dXJuIG47CiAgdmFyIGYgPSBuLmRlZmF1bHQ7CiAgaWYgKHR5cGVvZiBmID09ICJmdW5jdGlvbiIpIHsKICAgIHZhciBhID0gZnVuY3Rpb24gYTIoKSB7CiAgICAgIGlmICh0aGlzIGluc3RhbmNlb2YgYTIpIHsKICAgICAgICByZXR1cm4gUmVmbGVjdC5jb25zdHJ1Y3QoZiwgYXJndW1lbnRzLCB0aGlzLmNvbnN0cnVjdG9yKTsKICAgICAgfQogICAgICByZXR1cm4gZi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfTsKICAgIGEucHJvdG90eXBlID0gZi5wcm90b3R5cGU7CiAgfSBlbHNlCiAgICBhID0ge307CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGEsICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsKICBPYmplY3Qua2V5cyhuKS5mb3JFYWNoKGZ1bmN0aW9uKGspIHsKICAgIHZhciBkID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihuLCBrKTsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShhLCBrLCBkLmdldCA/IGQgOiB7CiAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIG5ba107CiAgICAgIH0KICAgIH0pOwogIH0pOwogIHJldHVybiBhOwp9CnZhciBjb3JlJDEgPSB7fTsKdmFyIGNvbW1hbmQgPSB7fTsKdmFyIHV0aWxzID0ge307Ck9iamVjdC5kZWZpbmVQcm9wZXJ0eSh1dGlscywgIl9fZXNNb2R1bGUiLCB7IHZhbHVlOiB0cnVlIH0pOwp1dGlscy50b0NvbW1hbmRQcm9wZXJ0aWVzID0gdXRpbHMudG9Db21tYW5kVmFsdWUgPSB2b2lkIDA7CmZ1bmN0aW9uIHRvQ29tbWFuZFZhbHVlKGlucHV0KSB7CiAgaWYgKGlucHV0ID09PSBudWxsIHx8IGlucHV0ID09PSB2b2lkIDApIHsKICAgIHJldHVybiAiIjsKICB9IGVsc2UgaWYgKHR5cGVvZiBpbnB1dCA9PT0gInN0cmluZyIgfHwgaW5wdXQgaW5zdGFuY2VvZiBTdHJpbmcpIHsKICAgIHJldHVybiBpbnB1dDsKICB9CiAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KGlucHV0KTsKfQp1dGlscy50b0NvbW1hbmRWYWx1ZSA9IHRvQ29tbWFuZFZhbHVlOwpmdW5jdGlvbiB0b0NvbW1hbmRQcm9wZXJ0aWVzKGFubm90YXRpb25Qcm9wZXJ0aWVzKSB7CiAgaWYgKCFPYmplY3Qua2V5cyhhbm5vdGF0aW9uUHJvcGVydGllcykubGVuZ3RoKSB7CiAgICByZXR1cm4ge307CiAgfQogIHJldHVybiB7CiAgICB0aXRsZTogYW5ub3RhdGlvblByb3BlcnRpZXMudGl0bGUsCiAgICBmaWxlOiBhbm5vdGF0aW9uUHJvcGVydGllcy5maWxlLAogICAgbGluZTogYW5ub3RhdGlvblByb3BlcnRpZXMuc3RhcnRMaW5lLAogICAgZW5kTGluZTogYW5ub3RhdGlvblByb3BlcnRpZXMuZW5kTGluZSwKICAgIGNvbDogYW5ub3RhdGlvblByb3BlcnRpZXMuc3RhcnRDb2x1bW4sCiAgICBlbmRDb2x1bW46IGFubm90YXRpb25Qcm9wZXJ0aWVzLmVuZENvbHVtbgogIH07Cn0KdXRpbHMudG9Db21tYW5kUHJvcGVydGllcyA9IHRvQ29tbWFuZFByb3BlcnRpZXM7CnZhciBfX2NyZWF0ZUJpbmRpbmckMSA9IGNvbW1vbmpzR2xvYmFsICYmIGNvbW1vbmpzR2xvYmFsLl9fY3JlYXRlQmluZGluZyB8fCAoT2JqZWN0LmNyZWF0ZSA/IGZ1bmN0aW9uKG8sIG0sIGssIGsyKSB7CiAgaWYgKGsyID09PSB2b2lkIDApCiAgICBrMiA9IGs7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG8sIGsyLCB7IGVudW1lcmFibGU6IHRydWUsIGdldDogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gbVtrXTsKICB9IH0pOwp9IDogZnVuY3Rpb24obywgbSwgaywgazIpIHsKICBpZiAoazIgPT09IHZvaWQgMCkKICAgIGsyID0gazsKICBvW2syXSA9IG1ba107Cn0pOwp2YXIgX19zZXRNb2R1bGVEZWZhdWx0JDEgPSBjb21tb25qc0dsb2JhbCAmJiBjb21tb25qc0dsb2JhbC5fX3NldE1vZHVsZURlZmF1bHQgfHwgKE9iamVjdC5jcmVhdGUgPyBmdW5jdGlvbihvLCB2KSB7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG8sICJkZWZhdWx0IiwgeyBlbnVtZXJhYmxlOiB0cnVlLCB2YWx1ZTogdiB9KTsKfSA6IGZ1bmN0aW9uKG8sIHYpIHsKICBvWyJkZWZhdWx0Il0gPSB2Owp9KTsKdmFyIF9faW1wb3J0U3RhciQxID0gY29tbW9uanNHbG9iYWwgJiYgY29tbW9uanNHbG9iYWwuX19pbXBvcnRTdGFyIHx8IGZ1bmN0aW9uKG1vZCkgewogIGlmIChtb2QgJiYgbW9kLl9fZXNNb2R1bGUpCiAgICByZXR1cm4gbW9kOwogIHZhciByZXN1bHQgPSB7fTsKICBpZiAobW9kICE9IG51bGwpIHsKICAgIGZvciAodmFyIGsgaW4gbW9kKQogICAgICBpZiAoayAhPT0gImRlZmF1bHQiICYmIE9iamVjdC5oYXNPd25Qcm9wZXJ0eS5jYWxsKG1vZCwgaykpCiAgICAgICAgX19jcmVhdGVCaW5kaW5nJDEocmVzdWx0LCBtb2QsIGspOwogIH0KICBfX3NldE1vZHVsZURlZmF1bHQkMShyZXN1bHQsIG1vZCk7CiAgcmV0dXJuIHJlc3VsdDsKfTsKT2JqZWN0LmRlZmluZVByb3BlcnR5KGNvbW1hbmQsICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsKY29tbWFuZC5pc3N1ZSA9IGNvbW1hbmQuaXNzdWVDb21tYW5kID0gdm9pZCAwOwpjb25zdCBvcyQxID0gX19pbXBvcnRTdGFyJDEocmVxdWlyZSQkMCQxKTsKY29uc3QgdXRpbHNfMSQxID0gdXRpbHM7CmZ1bmN0aW9uIGlzc3VlQ29tbWFuZChjb21tYW5kMiwgcHJvcGVydGllcywgbWVzc2FnZSkgewogIGNvbnN0IGNtZCA9IG5ldyBDb21tYW5kKGNvbW1hbmQyLCBwcm9wZXJ0aWVzLCBtZXNzYWdlKTsKICBwcm9jZXNzLnN0ZG91dC53cml0ZShjbWQudG9TdHJpbmcoKSArIG9zJDEuRU9MKTsKfQpjb21tYW5kLmlzc3VlQ29tbWFuZCA9IGlzc3VlQ29tbWFuZDsKZnVuY3Rpb24gaXNzdWUobmFtZSwgbWVzc2FnZSA9ICIiKSB7CiAgaXNzdWVDb21tYW5kKG5hbWUsIHt9LCBtZXNzYWdlKTsKfQpjb21tYW5kLmlzc3VlID0gaXNzdWU7CmNvbnN0IENNRF9TVFJJTkcgPSAiOjoiOwpjbGFzcyBDb21tYW5kIHsKICBjb25zdHJ1Y3Rvcihjb21tYW5kMiwgcHJvcGVydGllcywgbWVzc2FnZSkgewogICAgaWYgKCFjb21tYW5kMikgewogICAgICBjb21tYW5kMiA9ICJtaXNzaW5nLmNvbW1hbmQiOwogICAgfQogICAgdGhpcy5jb21tYW5kID0gY29tbWFuZDI7CiAgICB0aGlzLnByb3BlcnRpZXMgPSBwcm9wZXJ0aWVzOwogICAgdGhpcy5tZXNzYWdlID0gbWVzc2FnZTsKICB9CiAgdG9TdHJpbmcoKSB7CiAgICBsZXQgY21kU3RyID0gQ01EX1NUUklORyArIHRoaXMuY29tbWFuZDsKICAgIGlmICh0aGlzLnByb3BlcnRpZXMgJiYgT2JqZWN0LmtleXModGhpcy5wcm9wZXJ0aWVzKS5sZW5ndGggPiAwKSB7CiAgICAgIGNtZFN0ciArPSAiICI7CiAgICAgIGxldCBmaXJzdCA9IHRydWU7CiAgICAgIGZvciAoY29uc3Qga2V5IGluIHRoaXMucHJvcGVydGllcykgewogICAgICAgIGlmICh0aGlzLnByb3BlcnRpZXMuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgY29uc3QgdmFsID0gdGhpcy5wcm9wZXJ0aWVzW2tleV07CiAgICAgICAgICBpZiAodmFsKSB7CiAgICAgICAgICAgIGlmIChmaXJzdCkgewogICAgICAgICAgICAgIGZpcnN0ID0gZmFsc2U7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY21kU3RyICs9ICIsIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjbWRTdHIgKz0gYCR7a2V5fT0ke2VzY2FwZVByb3BlcnR5KHZhbCl9YDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGNtZFN0ciArPSBgJHtDTURfU1RSSU5HfSR7ZXNjYXBlRGF0YSh0aGlzLm1lc3NhZ2UpfWA7CiAgICByZXR1cm4gY21kU3RyOwogIH0KfQpmdW5jdGlvbiBlc2NhcGVEYXRhKHMpIHsKICByZXR1cm4gdXRpbHNfMSQxLnRvQ29tbWFuZFZhbHVlKHMpLnJlcGxhY2UoLyUvZywgIiUyNSIpLnJlcGxhY2UoL1xyL2csICIlMEQiKS5yZXBsYWNlKC9cbi9nLCAiJTBBIik7Cn0KZnVuY3Rpb24gZXNjYXBlUHJvcGVydHkocykgewogIHJldHVybiB1dGlsc18xJDEudG9Db21tYW5kVmFsdWUocykucmVwbGFjZSgvJS9nLCAiJTI1IikucmVwbGFjZSgvXHIvZywgIiUwRCIpLnJlcGxhY2UoL1xuL2csICIlMEEiKS5yZXBsYWNlKC86L2csICIlM0EiKS5yZXBsYWNlKC8sL2csICIlMkMiKTsKfQp2YXIgZmlsZUNvbW1hbmQgPSB7fTsKY29uc3Qgcm5kczhQb29sID0gbmV3IFVpbnQ4QXJyYXkoMjU2KTsKbGV0IHBvb2xQdHIgPSBybmRzOFBvb2wubGVuZ3RoOwpmdW5jdGlvbiBybmcoKSB7CiAgaWYgKHBvb2xQdHIgPiBybmRzOFBvb2wubGVuZ3RoIC0gMTYpIHsKICAgIGNyeXB0by5yYW5kb21GaWxsU3luYyhybmRzOFBvb2wpOwogICAgcG9vbFB0ciA9IDA7CiAgfQogIHJldHVybiBybmRzOFBvb2wuc2xpY2UocG9vbFB0ciwgcG9vbFB0ciArPSAxNik7Cn0KY29uc3QgUkVHRVggPSAvXig/OlswLTlhLWZdezh9LVswLTlhLWZdezR9LVsxLTVdWzAtOWEtZl17M30tWzg5YWJdWzAtOWEtZl17M30tWzAtOWEtZl17MTJ9fDAwMDAwMDAwLTAwMDAtMDAwMC0wMDAwLTAwMDAwMDAwMDAwMCkkL2k7CmZ1bmN0aW9uIHZhbGlkYXRlKHV1aWQpIHsKICByZXR1cm4gdHlwZW9mIHV1aWQgPT09ICJzdHJpbmciICYmIFJFR0VYLnRlc3QodXVpZCk7Cn0KY29uc3QgYnl0ZVRvSGV4ID0gW107CmZvciAobGV0IGkgPSAwOyBpIDwgMjU2OyArK2kpIHsKICBieXRlVG9IZXgucHVzaCgoaSArIDI1NikudG9TdHJpbmcoMTYpLnN1YnN0cigxKSk7Cn0KZnVuY3Rpb24gc3RyaW5naWZ5KGFyciwgb2Zmc2V0ID0gMCkgewogIGNvbnN0IHV1aWQgPSAoYnl0ZVRvSGV4W2FycltvZmZzZXQgKyAwXV0gKyBieXRlVG9IZXhbYXJyW29mZnNldCArIDFdXSArIGJ5dGVUb0hleFthcnJbb2Zmc2V0ICsgMl1dICsgYnl0ZVRvSGV4W2FycltvZmZzZXQgKyAzXV0gKyAiLSIgKyBieXRlVG9IZXhbYXJyW29mZnNldCArIDRdXSArIGJ5dGVUb0hleFthcnJbb2Zmc2V0ICsgNV1dICsgIi0iICsgYnl0ZVRvSGV4W2FycltvZmZzZXQgKyA2XV0gKyBieXRlVG9IZXhbYXJyW29mZnNldCArIDddXSArICItIiArIGJ5dGVUb0hleFthcnJbb2Zmc2V0ICsgOF1dICsgYnl0ZVRvSGV4W2FycltvZmZzZXQgKyA5XV0gKyAiLSIgKyBieXRlVG9IZXhbYXJyW29mZnNldCArIDEwXV0gKyBieXRlVG9IZXhbYXJyW29mZnNldCArIDExXV0gKyBieXRlVG9IZXhbYXJyW29mZnNldCArIDEyXV0gKyBieXRlVG9IZXhbYXJyW29mZnNldCArIDEzXV0gKyBieXRlVG9IZXhbYXJyW29mZnNldCArIDE0XV0gKyBieXRlVG9IZXhbYXJyW29mZnNldCArIDE1XV0pLnRvTG93ZXJDYXNlKCk7CiAgaWYgKCF2YWxpZGF0ZSh1dWlkKSkgewogICAgdGhyb3cgVHlwZUVycm9yKCJTdHJpbmdpZmllZCBVVUlEIGlzIGludmFsaWQiKTsKICB9CiAgcmV0dXJuIHV1aWQ7Cn0KbGV0IF9ub2RlSWQ7CmxldCBfY2xvY2tzZXE7CmxldCBfbGFzdE1TZWNzID0gMDsKbGV0IF9sYXN0TlNlY3MgPSAwOwpmdW5jdGlvbiB2MShvcHRpb25zLCBidWYsIG9mZnNldCkgewogIGxldCBpID0gYnVmICYmIG9mZnNldCB8fCAwOwogIGNvbnN0IGIgPSBidWYgfHwgbmV3IEFycmF5KDE2KTsKICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICBsZXQgbm9kZSA9IG9wdGlvbnMubm9kZSB8fCBfbm9kZUlkOwogIGxldCBjbG9ja3NlcSA9IG9wdGlvbnMuY2xvY2tzZXEgIT09IHZvaWQgMCA/IG9wdGlvbnMuY2xvY2tzZXEgOiBfY2xvY2tzZXE7CiAgaWYgKG5vZGUgPT0gbnVsbCB8fCBjbG9ja3NlcSA9PSBudWxsKSB7CiAgICBjb25zdCBzZWVkQnl0ZXMgPSBvcHRpb25zLnJhbmRvbSB8fCAob3B0aW9ucy5ybmcgfHwgcm5nKSgpOwogICAgaWYgKG5vZGUgPT0gbnVsbCkgewogICAgICBub2RlID0gX25vZGVJZCA9IFtzZWVkQnl0ZXNbMF0gfCAxLCBzZWVkQnl0ZXNbMV0sIHNlZWRCeXRlc1syXSwgc2VlZEJ5dGVzWzNdLCBzZWVkQnl0ZXNbNF0sIHNlZWRCeXRlc1s1XV07CiAgICB9CiAgICBpZiAoY2xvY2tzZXEgPT0gbnVsbCkgewogICAgICBjbG9ja3NlcSA9IF9jbG9ja3NlcSA9IChzZWVkQnl0ZXNbNl0gPDwgOCB8IHNlZWRCeXRlc1s3XSkgJiAxNjM4MzsKICAgIH0KICB9CiAgbGV0IG1zZWNzID0gb3B0aW9ucy5tc2VjcyAhPT0gdm9pZCAwID8gb3B0aW9ucy5tc2VjcyA6IERhdGUubm93KCk7CiAgbGV0IG5zZWNzID0gb3B0aW9ucy5uc2VjcyAhPT0gdm9pZCAwID8gb3B0aW9ucy5uc2VjcyA6IF9sYXN0TlNlY3MgKyAxOwogIGNvbnN0IGR0ID0gbXNlY3MgLSBfbGFzdE1TZWNzICsgKG5zZWNzIC0gX2xhc3ROU2VjcykgLyAxZTQ7CiAgaWYgKGR0IDwgMCAmJiBvcHRpb25zLmNsb2Nrc2VxID09PSB2b2lkIDApIHsKICAgIGNsb2Nrc2VxID0gY2xvY2tzZXEgKyAxICYgMTYzODM7CiAgfQogIGlmICgoZHQgPCAwIHx8IG1zZWNzID4gX2xhc3RNU2VjcykgJiYgb3B0aW9ucy5uc2VjcyA9PT0gdm9pZCAwKSB7CiAgICBuc2VjcyA9IDA7CiAgfQogIGlmIChuc2VjcyA+PSAxZTQpIHsKICAgIHRocm93IG5ldyBFcnJvcigidXVpZC52MSgpOiBDYW4ndCBjcmVhdGUgbW9yZSB0aGFuIDEwTSB1dWlkcy9zZWMiKTsKICB9CiAgX2xhc3RNU2VjcyA9IG1zZWNzOwogIF9sYXN0TlNlY3MgPSBuc2VjczsKICBfY2xvY2tzZXEgPSBjbG9ja3NlcTsKICBtc2VjcyArPSAxMjIxOTI5MjhlNTsKICBjb25zdCB0bCA9ICgobXNlY3MgJiAyNjg0MzU0NTUpICogMWU0ICsgbnNlY3MpICUgNDI5NDk2NzI5NjsKICBiW2krK10gPSB0bCA+Pj4gMjQgJiAyNTU7CiAgYltpKytdID0gdGwgPj4+IDE2ICYgMjU1OwogIGJbaSsrXSA9IHRsID4+PiA4ICYgMjU1OwogIGJbaSsrXSA9IHRsICYgMjU1OwogIGNvbnN0IHRtaCA9IG1zZWNzIC8gNDI5NDk2NzI5NiAqIDFlNCAmIDI2ODQzNTQ1NTsKICBiW2krK10gPSB0bWggPj4+IDggJiAyNTU7CiAgYltpKytdID0gdG1oICYgMjU1OwogIGJbaSsrXSA9IHRtaCA+Pj4gMjQgJiAxNSB8IDE2OwogIGJbaSsrXSA9IHRtaCA+Pj4gMTYgJiAyNTU7CiAgYltpKytdID0gY2xvY2tzZXEgPj4+IDggfCAxMjg7CiAgYltpKytdID0gY2xvY2tzZXEgJiAyNTU7CiAgZm9yIChsZXQgbiA9IDA7IG4gPCA2OyArK24pIHsKICAgIGJbaSArIG5dID0gbm9kZVtuXTsKICB9CiAgcmV0dXJuIGJ1ZiB8fCBzdHJpbmdpZnkoYik7Cn0KZnVuY3Rpb24gcGFyc2UkMih1dWlkKSB7CiAgaWYgKCF2YWxpZGF0ZSh1dWlkKSkgewogICAgdGhyb3cgVHlwZUVycm9yKCJJbnZhbGlkIFVVSUQiKTsKICB9CiAgbGV0IHY7CiAgY29uc3QgYXJyID0gbmV3IFVpbnQ4QXJyYXkoMTYpOwogIGFyclswXSA9ICh2ID0gcGFyc2VJbnQodXVpZC5zbGljZSgwLCA4KSwgMTYpKSA+Pj4gMjQ7CiAgYXJyWzFdID0gdiA+Pj4gMTYgJiAyNTU7CiAgYXJyWzJdID0gdiA+Pj4gOCAmIDI1NTsKICBhcnJbM10gPSB2ICYgMjU1OwogIGFycls0XSA9ICh2ID0gcGFyc2VJbnQodXVpZC5zbGljZSg5LCAxMyksIDE2KSkgPj4+IDg7CiAgYXJyWzVdID0gdiAmIDI1NTsKICBhcnJbNl0gPSAodiA9IHBhcnNlSW50KHV1aWQuc2xpY2UoMTQsIDE4KSwgMTYpKSA+Pj4gODsKICBhcnJbN10gPSB2ICYgMjU1OwogIGFycls4XSA9ICh2ID0gcGFyc2VJbnQodXVpZC5zbGljZSgxOSwgMjMpLCAxNikpID4+PiA4OwogIGFycls5XSA9IHYgJiAyNTU7CiAgYXJyWzEwXSA9ICh2ID0gcGFyc2VJbnQodXVpZC5zbGljZSgyNCwgMzYpLCAxNikpIC8gMTA5OTUxMTYyNzc3NiAmIDI1NTsKICBhcnJbMTFdID0gdiAvIDQyOTQ5NjcyOTYgJiAyNTU7CiAgYXJyWzEyXSA9IHYgPj4+IDI0ICYgMjU1OwogIGFyclsxM10gPSB2ID4+PiAxNiAmIDI1NTsKICBhcnJbMTRdID0gdiA+Pj4gOCAmIDI1NTsKICBhcnJbMTVdID0gdiAmIDI1NTsKICByZXR1cm4gYXJyOwp9CmZ1bmN0aW9uIHN0cmluZ1RvQnl0ZXMoc3RyKSB7CiAgc3RyID0gdW5lc2NhcGUoZW5jb2RlVVJJQ29tcG9uZW50KHN0cikpOwogIGNvbnN0IGJ5dGVzID0gW107CiAgZm9yIChsZXQgaSA9IDA7IGkgPCBzdHIubGVuZ3RoOyArK2kpIHsKICAgIGJ5dGVzLnB1c2goc3RyLmNoYXJDb2RlQXQoaSkpOwogIH0KICByZXR1cm4gYnl0ZXM7Cn0KY29uc3QgRE5TID0gIjZiYTdiODEwLTlkYWQtMTFkMS04MGI0LTAwYzA0ZmQ0MzBjOCI7CmNvbnN0IFVSTCQxID0gIjZiYTdiODExLTlkYWQtMTFkMS04MGI0LTAwYzA0ZmQ0MzBjOCI7CmZ1bmN0aW9uIHYzNShuYW1lLCB2ZXJzaW9uMiwgaGFzaGZ1bmMpIHsKICBmdW5jdGlvbiBnZW5lcmF0ZVVVSUQodmFsdWUsIG5hbWVzcGFjZSwgYnVmLCBvZmZzZXQpIHsKICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciKSB7CiAgICAgIHZhbHVlID0gc3RyaW5nVG9CeXRlcyh2YWx1ZSk7CiAgICB9CiAgICBpZiAodHlwZW9mIG5hbWVzcGFjZSA9PT0gInN0cmluZyIpIHsKICAgICAgbmFtZXNwYWNlID0gcGFyc2UkMihuYW1lc3BhY2UpOwogICAgfQogICAgaWYgKG5hbWVzcGFjZS5sZW5ndGggIT09IDE2KSB7CiAgICAgIHRocm93IFR5cGVFcnJvcigiTmFtZXNwYWNlIG11c3QgYmUgYXJyYXktbGlrZSAoMTYgaXRlcmFibGUgaW50ZWdlciB2YWx1ZXMsIDAtMjU1KSIpOwogICAgfQogICAgbGV0IGJ5dGVzID0gbmV3IFVpbnQ4QXJyYXkoMTYgKyB2YWx1ZS5sZW5ndGgpOwogICAgYnl0ZXMuc2V0KG5hbWVzcGFjZSk7CiAgICBieXRlcy5zZXQodmFsdWUsIG5hbWVzcGFjZS5sZW5ndGgpOwogICAgYnl0ZXMgPSBoYXNoZnVuYyhieXRlcyk7CiAgICBieXRlc1s2XSA9IGJ5dGVzWzZdICYgMTUgfCB2ZXJzaW9uMjsKICAgIGJ5dGVzWzhdID0gYnl0ZXNbOF0gJiA2MyB8IDEyODsKICAgIGlmIChidWYpIHsKICAgICAgb2Zmc2V0ID0gb2Zmc2V0IHx8IDA7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMTY7ICsraSkgewogICAgICAgIGJ1ZltvZmZzZXQgKyBpXSA9IGJ5dGVzW2ldOwogICAgICB9CiAgICAgIHJldHVybiBidWY7CiAgICB9CiAgICByZXR1cm4gc3RyaW5naWZ5KGJ5dGVzKTsKICB9CiAgdHJ5IHsKICAgIGdlbmVyYXRlVVVJRC5uYW1lID0gbmFtZTsKICB9IGNhdGNoIChlcnIpIHsKICB9CiAgZ2VuZXJhdGVVVUlELkROUyA9IEROUzsKICBnZW5lcmF0ZVVVSUQuVVJMID0gVVJMJDE7CiAgcmV0dXJuIGdlbmVyYXRlVVVJRDsKfQpmdW5jdGlvbiBtZDUoYnl0ZXMpIHsKICBpZiAoQXJyYXkuaXNBcnJheShieXRlcykpIHsKICAgIGJ5dGVzID0gQnVmZmVyLmZyb20oYnl0ZXMpOwogIH0gZWxzZSBpZiAodHlwZW9mIGJ5dGVzID09PSAic3RyaW5nIikgewogICAgYnl0ZXMgPSBCdWZmZXIuZnJvbShieXRlcywgInV0ZjgiKTsKICB9CiAgcmV0dXJuIGNyeXB0by5jcmVhdGVIYXNoKCJtZDUiKS51cGRhdGUoYnl0ZXMpLmRpZ2VzdCgpOwp9CmNvbnN0IHYzID0gdjM1KCJ2MyIsIDQ4LCBtZDUpOwpjb25zdCB2MyQxID0gdjM7CmZ1bmN0aW9uIHY0KG9wdGlvbnMsIGJ1Ziwgb2Zmc2V0KSB7CiAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgY29uc3Qgcm5kcyA9IG9wdGlvbnMucmFuZG9tIHx8IChvcHRpb25zLnJuZyB8fCBybmcpKCk7CiAgcm5kc1s2XSA9IHJuZHNbNl0gJiAxNSB8IDY0OwogIHJuZHNbOF0gPSBybmRzWzhdICYgNjMgfCAxMjg7CiAgaWYgKGJ1ZikgewogICAgb2Zmc2V0ID0gb2Zmc2V0IHx8IDA7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDE2OyArK2kpIHsKICAgICAgYnVmW29mZnNldCArIGldID0gcm5kc1tpXTsKICAgIH0KICAgIHJldHVybiBidWY7CiAgfQogIHJldHVybiBzdHJpbmdpZnkocm5kcyk7Cn0KZnVuY3Rpb24gc2hhMShieXRlcykgewogIGlmIChBcnJheS5pc0FycmF5KGJ5dGVzKSkgewogICAgYnl0ZXMgPSBCdWZmZXIuZnJvbShieXRlcyk7CiAgfSBlbHNlIGlmICh0eXBlb2YgYnl0ZXMgPT09ICJzdHJpbmciKSB7CiAgICBieXRlcyA9IEJ1ZmZlci5mcm9tKGJ5dGVzLCAidXRmOCIpOwogIH0KICByZXR1cm4gY3J5cHRvLmNyZWF0ZUhhc2goInNoYTEiKS51cGRhdGUoYnl0ZXMpLmRpZ2VzdCgpOwp9CmNvbnN0IHY1ID0gdjM1KCJ2NSIsIDgwLCBzaGExKTsKY29uc3QgdjUkMSA9IHY1Owpjb25zdCBuaWwgPSAiMDAwMDAwMDAtMDAwMC0wMDAwLTAwMDAtMDAwMDAwMDAwMDAwIjsKZnVuY3Rpb24gdmVyc2lvbiQxKHV1aWQpIHsKICBpZiAoIXZhbGlkYXRlKHV1aWQpKSB7CiAgICB0aHJvdyBUeXBlRXJyb3IoIkludmFsaWQgVVVJRCIpOwogIH0KICByZXR1cm4gcGFyc2VJbnQodXVpZC5zdWJzdHIoMTQsIDEpLCAxNik7Cn0KY29uc3QgZXNtTm9kZSA9IC8qIEBfX1BVUkVfXyAqLyBPYmplY3QuZnJlZXplKC8qIEBfX1BVUkVfXyAqLyBPYmplY3QuZGVmaW5lUHJvcGVydHkoewogIF9fcHJvdG9fXzogbnVsbCwKICBOSUw6IG5pbCwKICBwYXJzZTogcGFyc2UkMiwKICBzdHJpbmdpZnksCiAgdjEsCiAgdjM6IHYzJDEsCiAgdjQsCiAgdjU6IHY1JDEsCiAgdmFsaWRhdGUsCiAgdmVyc2lvbjogdmVyc2lvbiQxCn0sIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSkpOwpjb25zdCByZXF1aXJlJCQyID0gLyogQF9fUFVSRV9fICovIGdldEF1Z21lbnRlZE5hbWVzcGFjZShlc21Ob2RlKTsKdmFyIF9fY3JlYXRlQmluZGluZyA9IGNvbW1vbmpzR2xvYmFsICYmIGNvbW1vbmpzR2xvYmFsLl9fY3JlYXRlQmluZGluZyB8fCAoT2JqZWN0LmNyZWF0ZSA/IGZ1bmN0aW9uKG8sIG0sIGssIGsyKSB7CiAgaWYgKGsyID09PSB2b2lkIDApCiAgICBrMiA9IGs7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG8sIGsyLCB7IGVudW1lcmFibGU6IHRydWUsIGdldDogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gbVtrXTsKICB9IH0pOwp9IDogZnVuY3Rpb24obywgbSwgaywgazIpIHsKICBpZiAoazIgPT09IHZvaWQgMCkKICAgIGsyID0gazsKICBvW2syXSA9IG1ba107Cn0pOwp2YXIgX19zZXRNb2R1bGVEZWZhdWx0ID0gY29tbW9uanNHbG9iYWwgJiYgY29tbW9uanNHbG9iYWwuX19zZXRNb2R1bGVEZWZhdWx0IHx8IChPYmplY3QuY3JlYXRlID8gZnVuY3Rpb24obywgdikgewogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvLCAiZGVmYXVsdCIsIHsgZW51bWVyYWJsZTogdHJ1ZSwgdmFsdWU6IHYgfSk7Cn0gOiBmdW5jdGlvbihvLCB2KSB7CiAgb1siZGVmYXVsdCJdID0gdjsKfSk7CnZhciBfX2ltcG9ydFN0YXIgPSBjb21tb25qc0dsb2JhbCAmJiBjb21tb25qc0dsb2JhbC5fX2ltcG9ydFN0YXIgfHwgZnVuY3Rpb24obW9kKSB7CiAgaWYgKG1vZCAmJiBtb2QuX19lc01vZHVsZSkKICAgIHJldHVybiBtb2Q7CiAgdmFyIHJlc3VsdCA9IHt9OwogIGlmIChtb2QgIT0gbnVsbCkgewogICAgZm9yICh2YXIgayBpbiBtb2QpCiAgICAgIGlmIChrICE9PSAiZGVmYXVsdCIgJiYgT2JqZWN0Lmhhc093blByb3BlcnR5LmNhbGwobW9kLCBrKSkKICAgICAgICBfX2NyZWF0ZUJpbmRpbmcocmVzdWx0LCBtb2QsIGspOwogIH0KICBfX3NldE1vZHVsZURlZmF1bHQocmVzdWx0LCBtb2QpOwogIHJldHVybiByZXN1bHQ7Cn07Ck9iamVjdC5kZWZpbmVQcm9wZXJ0eShmaWxlQ29tbWFuZCwgIl9fZXNNb2R1bGUiLCB7IHZhbHVlOiB0cnVlIH0pOwpmaWxlQ29tbWFuZC5wcmVwYXJlS2V5VmFsdWVNZXNzYWdlID0gZmlsZUNvbW1hbmQuaXNzdWVGaWxlQ29tbWFuZCA9IHZvaWQgMDsKY29uc3QgZnMkMSA9IF9faW1wb3J0U3RhcihyZXF1aXJlJCQwX19kZWZhdWx0KTsKY29uc3Qgb3MgPSBfX2ltcG9ydFN0YXIocmVxdWlyZSQkMCQxKTsKY29uc3QgdXVpZF8xID0gcmVxdWlyZSQkMjsKY29uc3QgdXRpbHNfMSA9IHV0aWxzOwpmdW5jdGlvbiBpc3N1ZUZpbGVDb21tYW5kKGNvbW1hbmQyLCBtZXNzYWdlKSB7CiAgY29uc3QgZmlsZVBhdGggPSBwcm9jZXNzLmVudltgR0lUSFVCXyR7Y29tbWFuZDJ9YF07CiAgaWYgKCFmaWxlUGF0aCkgewogICAgdGhyb3cgbmV3IEVycm9yKGBVbmFibGUgdG8gZmluZCBlbnZpcm9ubWVudCB2YXJpYWJsZSBmb3IgZmlsZSBjb21tYW5kICR7Y29tbWFuZDJ9YCk7CiAgfQogIGlmICghZnMkMS5leGlzdHNTeW5jKGZpbGVQYXRoKSkgewogICAgdGhyb3cgbmV3IEVycm9yKGBNaXNzaW5nIGZpbGUgYXQgcGF0aDogJHtmaWxlUGF0aH1gKTsKICB9CiAgZnMkMS5hcHBlbmRGaWxlU3luYyhmaWxlUGF0aCwgYCR7dXRpbHNfMS50b0NvbW1hbmRWYWx1ZShtZXNzYWdlKX0ke29zLkVPTH1gLCB7CiAgICBlbmNvZGluZzogInV0ZjgiCiAgfSk7Cn0KZmlsZUNvbW1hbmQuaXNzdWVGaWxlQ29tbWFuZCA9IGlzc3VlRmlsZUNvbW1hbmQ7CmZ1bmN0aW9uIHByZXBhcmVLZXlWYWx1ZU1lc3NhZ2Uoa2V5LCB2YWx1ZSkgewogIGNvbnN0IGRlbGltaXRlciA9IGBnaGFkZWxpbWl0ZXJfJHt1dWlkXzEudjQoKX1gOwogIGNvbnN0IGNvbnZlcnRlZFZhbHVlID0gdXRpbHNfMS50b0NvbW1hbmRWYWx1ZSh2YWx1ZSk7CiAgaWYgKGtleS5pbmNsdWRlcyhkZWxpbWl0ZXIpKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQgaW5wdXQ6IG5hbWUgc2hvdWxkIG5vdCBjb250YWluIHRoZSBkZWxpbWl0ZXIgIiR7ZGVsaW1pdGVyfSJgKTsKICB9CiAgaWYgKGNvbnZlcnRlZFZhbHVlLmluY2x1ZGVzKGRlbGltaXRlcikpIHsKICAgIHRocm93IG5ldyBFcnJvcihgVW5leHBlY3RlZCBpbnB1dDogdmFsdWUgc2hvdWxkIG5vdCBjb250YWluIHRoZSBkZWxpbWl0ZXIgIiR7ZGVsaW1pdGVyfSJgKTsKICB9CiAgcmV0dXJuIGAke2tleX08PCR7ZGVsaW1pdGVyfSR7b3MuRU9MfSR7Y29udmVydGVkVmFsdWV9JHtvcy5FT0x9JHtkZWxpbWl0ZXJ9YDsKfQpmaWxlQ29tbWFuZC5wcmVwYXJlS2V5VmFsdWVNZXNzYWdlID0gcHJlcGFyZUtleVZhbHVlTWVzc2FnZTsKdmFyIG9pZGNVdGlscyA9IHt9Owp2YXIgbGliID0ge307CnZhciBwcm94eSA9IHt9OwpPYmplY3QuZGVmaW5lUHJvcGVydHkocHJveHksICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsKcHJveHkuY2hlY2tCeXBhc3MgPSBwcm94eS5nZXRQcm94eVVybCA9IHZvaWQgMDsKZnVuY3Rpb24gZ2V0UHJveHlVcmwocmVxVXJsKSB7CiAgY29uc3QgdXNpbmdTc2wgPSByZXFVcmwucHJvdG9jb2wgPT09ICJodHRwczoiOwogIGlmIChjaGVja0J5cGFzcyhyZXFVcmwpKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICBjb25zdCBwcm94eVZhciA9ICgoKSA9PiB7CiAgICBpZiAodXNpbmdTc2wpIHsKICAgICAgcmV0dXJuIHByb2Nlc3MuZW52WyJodHRwc19wcm94eSJdIHx8IHByb2Nlc3MuZW52WyJIVFRQU19QUk9YWSJdOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHByb2Nlc3MuZW52WyJodHRwX3Byb3h5Il0gfHwgcHJvY2Vzcy5lbnZbIkhUVFBfUFJPWFkiXTsKICAgIH0KICB9KSgpOwogIGlmIChwcm94eVZhcikgewogICAgdHJ5IHsKICAgICAgcmV0dXJuIG5ldyBVUkwocHJveHlWYXIpOwogICAgfSBjYXRjaCAoX2EpIHsKICAgICAgaWYgKCFwcm94eVZhci5zdGFydHNXaXRoKCJodHRwOi8vIikgJiYgIXByb3h5VmFyLnN0YXJ0c1dpdGgoImh0dHBzOi8vIikpCiAgICAgICAgcmV0dXJuIG5ldyBVUkwoYGh0dHA6Ly8ke3Byb3h5VmFyfWApOwogICAgfQogIH0gZWxzZSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KfQpwcm94eS5nZXRQcm94eVVybCA9IGdldFByb3h5VXJsOwpmdW5jdGlvbiBjaGVja0J5cGFzcyhyZXFVcmwpIHsKICBpZiAoIXJlcVVybC5ob3N0bmFtZSkgewogICAgcmV0dXJuIGZhbHNlOwogIH0KICBjb25zdCByZXFIb3N0ID0gcmVxVXJsLmhvc3RuYW1lOwogIGlmIChpc0xvb3BiYWNrQWRkcmVzcyhyZXFIb3N0KSkgewogICAgcmV0dXJuIHRydWU7CiAgfQogIGNvbnN0IG5vUHJveHkgPSBwcm9jZXNzLmVudlsibm9fcHJveHkiXSB8fCBwcm9jZXNzLmVudlsiTk9fUFJPWFkiXSB8fCAiIjsKICBpZiAoIW5vUHJveHkpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgbGV0IHJlcVBvcnQ7CiAgaWYgKHJlcVVybC5wb3J0KSB7CiAgICByZXFQb3J0ID0gTnVtYmVyKHJlcVVybC5wb3J0KTsKICB9IGVsc2UgaWYgKHJlcVVybC5wcm90b2NvbCA9PT0gImh0dHA6IikgewogICAgcmVxUG9ydCA9IDgwOwogIH0gZWxzZSBpZiAocmVxVXJsLnByb3RvY29sID09PSAiaHR0cHM6IikgewogICAgcmVxUG9ydCA9IDQ0MzsKICB9CiAgY29uc3QgdXBwZXJSZXFIb3N0cyA9IFtyZXFVcmwuaG9zdG5hbWUudG9VcHBlckNhc2UoKV07CiAgaWYgKHR5cGVvZiByZXFQb3J0ID09PSAibnVtYmVyIikgewogICAgdXBwZXJSZXFIb3N0cy5wdXNoKGAke3VwcGVyUmVxSG9zdHNbMF19OiR7cmVxUG9ydH1gKTsKICB9CiAgZm9yIChjb25zdCB1cHBlck5vUHJveHlJdGVtIG9mIG5vUHJveHkuc3BsaXQoIiwiKS5tYXAoKHgpID0+IHgudHJpbSgpLnRvVXBwZXJDYXNlKCkpLmZpbHRlcigoeCkgPT4geCkpIHsKICAgIGlmICh1cHBlck5vUHJveHlJdGVtID09PSAiKiIgfHwgdXBwZXJSZXFIb3N0cy5zb21lKCh4KSA9PiB4ID09PSB1cHBlck5vUHJveHlJdGVtIHx8IHguZW5kc1dpdGgoYC4ke3VwcGVyTm9Qcm94eUl0ZW19YCkgfHwgdXBwZXJOb1Byb3h5SXRlbS5zdGFydHNXaXRoKCIuIikgJiYgeC5lbmRzV2l0aChgJHt1cHBlck5vUHJveHlJdGVtfWApKSkgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICB9CiAgcmV0dXJuIGZhbHNlOwp9CnByb3h5LmNoZWNrQnlwYXNzID0gY2hlY2tCeXBhc3M7CmZ1bmN0aW9uIGlzTG9vcGJhY2tBZGRyZXNzKGhvc3QpIHsKICBjb25zdCBob3N0TG93ZXIgPSBob3N0LnRvTG93ZXJDYXNlKCk7CiAgcmV0dXJuIGhvc3RMb3dlciA9PT0gImxvY2FsaG9zdCIgfHwgaG9zdExvd2VyLnN0YXJ0c1dpdGgoIjEyNy4iKSB8fCBob3N0TG93ZXIuc3RhcnRzV2l0aCgiWzo6MV0iKSB8fCBob3N0TG93ZXIuc3RhcnRzV2l0aCgiWzA6MDowOjA6MDowOjA6MV0iKTsKfQp2YXIgdHVubmVsJDEgPSB7fTsKdmFyIHRscyA9IHJlcXVpcmUkJDE7CnZhciBodHRwID0gcmVxdWlyZSQkMiQxOwp2YXIgaHR0cHMgPSByZXF1aXJlJCQzOwp2YXIgZXZlbnRzID0gcmVxdWlyZSQkNDsKdmFyIHV0aWwgPSByZXF1aXJlJCQ2Owp0dW5uZWwkMS5odHRwT3Zlckh0dHAgPSBodHRwT3Zlckh0dHA7CnR1bm5lbCQxLmh0dHBzT3Zlckh0dHAgPSBodHRwc092ZXJIdHRwOwp0dW5uZWwkMS5odHRwT3Zlckh0dHBzID0gaHR0cE92ZXJIdHRwczsKdHVubmVsJDEuaHR0cHNPdmVySHR0cHMgPSBodHRwc092ZXJIdHRwczsKZnVuY3Rpb24gaHR0cE92ZXJIdHRwKG9wdGlvbnMpIHsKICB2YXIgYWdlbnQgPSBuZXcgVHVubmVsaW5nQWdlbnQob3B0aW9ucyk7CiAgYWdlbnQucmVxdWVzdCA9IGh0dHAucmVxdWVzdDsKICByZXR1cm4gYWdlbnQ7Cn0KZnVuY3Rpb24gaHR0cHNPdmVySHR0cChvcHRpb25zKSB7CiAgdmFyIGFnZW50ID0gbmV3IFR1bm5lbGluZ0FnZW50KG9wdGlvbnMpOwogIGFnZW50LnJlcXVlc3QgPSBodHRwLnJlcXVlc3Q7CiAgYWdlbnQuY3JlYXRlU29ja2V0ID0gY3JlYXRlU2VjdXJlU29ja2V0OwogIGFnZW50LmRlZmF1bHRQb3J0ID0gNDQzOwogIHJldHVybiBhZ2VudDsKfQpmdW5jdGlvbiBodHRwT3Zlckh0dHBzKG9wdGlvbnMpIHsKICB2YXIgYWdlbnQgPSBuZXcgVHVubmVsaW5nQWdlbnQob3B0aW9ucyk7CiAgYWdlbnQucmVxdWVzdCA9IGh0dHBzLnJlcXVlc3Q7CiAgcmV0dXJuIGFnZW50Owp9CmZ1bmN0aW9uIGh0dHBzT3Zlckh0dHBzKG9wdGlvbnMpIHsKICB2YXIgYWdlbnQgPSBuZXcgVHVubmVsaW5nQWdlbnQob3B0aW9ucyk7CiAgYWdlbnQucmVxdWVzdCA9IGh0dHBzLnJlcXVlc3Q7CiAgYWdlbnQuY3JlYXRlU29ja2V0ID0gY3JlYXRlU2VjdXJlU29ja2V0OwogIGFnZW50LmRlZmF1bHRQb3J0ID0gNDQzOwogIHJldHVybiBhZ2VudDsKfQpmdW5jdGlvbiBUdW5uZWxpbmdBZ2VudChvcHRpb25zKSB7CiAgdmFyIHNlbGYyID0gdGhpczsKICBzZWxmMi5vcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICBzZWxmMi5wcm94eU9wdGlvbnMgPSBzZWxmMi5vcHRpb25zLnByb3h5IHx8IHt9OwogIHNlbGYyLm1heFNvY2tldHMgPSBzZWxmMi5vcHRpb25zLm1heFNvY2tldHMgfHwgaHR0cC5BZ2VudC5kZWZhdWx0TWF4U29ja2V0czsKICBzZWxmMi5yZXF1ZXN0cyA9IFtdOwogIHNlbGYyLnNvY2tldHMgPSBbXTsKICBzZWxmMi5vbigiZnJlZSIsIGZ1bmN0aW9uIG9uRnJlZShzb2NrZXQsIGhvc3QsIHBvcnQsIGxvY2FsQWRkcmVzcykgewogICAgdmFyIG9wdGlvbnMyID0gdG9PcHRpb25zKGhvc3QsIHBvcnQsIGxvY2FsQWRkcmVzcyk7CiAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gc2VsZjIucmVxdWVzdHMubGVuZ3RoOyBpIDwgbGVuOyArK2kpIHsKICAgICAgdmFyIHBlbmRpbmcgPSBzZWxmMi5yZXF1ZXN0c1tpXTsKICAgICAgaWYgKHBlbmRpbmcuaG9zdCA9PT0gb3B0aW9uczIuaG9zdCAmJiBwZW5kaW5nLnBvcnQgPT09IG9wdGlvbnMyLnBvcnQpIHsKICAgICAgICBzZWxmMi5yZXF1ZXN0cy5zcGxpY2UoaSwgMSk7CiAgICAgICAgcGVuZGluZy5yZXF1ZXN0Lm9uU29ja2V0KHNvY2tldCk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICB9CiAgICBzb2NrZXQuZGVzdHJveSgpOwogICAgc2VsZjIucmVtb3ZlU29ja2V0KHNvY2tldCk7CiAgfSk7Cn0KdXRpbC5pbmhlcml0cyhUdW5uZWxpbmdBZ2VudCwgZXZlbnRzLkV2ZW50RW1pdHRlcik7ClR1bm5lbGluZ0FnZW50LnByb3RvdHlwZS5hZGRSZXF1ZXN0ID0gZnVuY3Rpb24gYWRkUmVxdWVzdChyZXEsIGhvc3QsIHBvcnQsIGxvY2FsQWRkcmVzcykgewogIHZhciBzZWxmMiA9IHRoaXM7CiAgdmFyIG9wdGlvbnMgPSBtZXJnZU9wdGlvbnMoeyByZXF1ZXN0OiByZXEgfSwgc2VsZjIub3B0aW9ucywgdG9PcHRpb25zKGhvc3QsIHBvcnQsIGxvY2FsQWRkcmVzcykpOwogIGlmIChzZWxmMi5zb2NrZXRzLmxlbmd0aCA+PSB0aGlzLm1heFNvY2tldHMpIHsKICAgIHNlbGYyLnJlcXVlc3RzLnB1c2gob3B0aW9ucyk7CiAgICByZXR1cm47CiAgfQogIHNlbGYyLmNyZWF0ZVNvY2tldChvcHRpb25zLCBmdW5jdGlvbihzb2NrZXQpIHsKICAgIHNvY2tldC5vbigiZnJlZSIsIG9uRnJlZSk7CiAgICBzb2NrZXQub24oImNsb3NlIiwgb25DbG9zZU9yUmVtb3ZlKTsKICAgIHNvY2tldC5vbigiYWdlbnRSZW1vdmUiLCBvbkNsb3NlT3JSZW1vdmUpOwogICAgcmVxLm9uU29ja2V0KHNvY2tldCk7CiAgICBmdW5jdGlvbiBvbkZyZWUoKSB7CiAgICAgIHNlbGYyLmVtaXQoImZyZWUiLCBzb2NrZXQsIG9wdGlvbnMpOwogICAgfQogICAgZnVuY3Rpb24gb25DbG9zZU9yUmVtb3ZlKGVycikgewogICAgICBzZWxmMi5yZW1vdmVTb2NrZXQoc29ja2V0KTsKICAgICAgc29ja2V0LnJlbW92ZUxpc3RlbmVyKCJmcmVlIiwgb25GcmVlKTsKICAgICAgc29ja2V0LnJlbW92ZUxpc3RlbmVyKCJjbG9zZSIsIG9uQ2xvc2VPclJlbW92ZSk7CiAgICAgIHNvY2tldC5yZW1vdmVMaXN0ZW5lcigiYWdlbnRSZW1vdmUiLCBvbkNsb3NlT3JSZW1vdmUpOwogICAgfQogIH0pOwp9OwpUdW5uZWxpbmdBZ2VudC5wcm90b3R5cGUuY3JlYXRlU29ja2V0ID0gZnVuY3Rpb24gY3JlYXRlU29ja2V0KG9wdGlvbnMsIGNiKSB7CiAgdmFyIHNlbGYyID0gdGhpczsKICB2YXIgcGxhY2Vob2xkZXIgPSB7fTsKICBzZWxmMi5zb2NrZXRzLnB1c2gocGxhY2Vob2xkZXIpOwogIHZhciBjb25uZWN0T3B0aW9ucyA9IG1lcmdlT3B0aW9ucyh7fSwgc2VsZjIucHJveHlPcHRpb25zLCB7CiAgICBtZXRob2Q6ICJDT05ORUNUIiwKICAgIHBhdGg6IG9wdGlvbnMuaG9zdCArICI6IiArIG9wdGlvbnMucG9ydCwKICAgIGFnZW50OiBmYWxzZSwKICAgIGhlYWRlcnM6IHsKICAgICAgaG9zdDogb3B0aW9ucy5ob3N0ICsgIjoiICsgb3B0aW9ucy5wb3J0CiAgICB9CiAgfSk7CiAgaWYgKG9wdGlvbnMubG9jYWxBZGRyZXNzKSB7CiAgICBjb25uZWN0T3B0aW9ucy5sb2NhbEFkZHJlc3MgPSBvcHRpb25zLmxvY2FsQWRkcmVzczsKICB9CiAgaWYgKGNvbm5lY3RPcHRpb25zLnByb3h5QXV0aCkgewogICAgY29ubmVjdE9wdGlvbnMuaGVhZGVycyA9IGNvbm5lY3RPcHRpb25zLmhlYWRlcnMgfHwge307CiAgICBjb25uZWN0T3B0aW9ucy5oZWFkZXJzWyJQcm94eS1BdXRob3JpemF0aW9uIl0gPSAiQmFzaWMgIiArIG5ldyBCdWZmZXIoY29ubmVjdE9wdGlvbnMucHJveHlBdXRoKS50b1N0cmluZygiYmFzZTY0Iik7CiAgfQogIGRlYnVnKCJtYWtpbmcgQ09OTkVDVCByZXF1ZXN0Iik7CiAgdmFyIGNvbm5lY3RSZXEgPSBzZWxmMi5yZXF1ZXN0KGNvbm5lY3RPcHRpb25zKTsKICBjb25uZWN0UmVxLnVzZUNodW5rZWRFbmNvZGluZ0J5RGVmYXVsdCA9IGZhbHNlOwogIGNvbm5lY3RSZXEub25jZSgicmVzcG9uc2UiLCBvblJlc3BvbnNlKTsKICBjb25uZWN0UmVxLm9uY2UoInVwZ3JhZGUiLCBvblVwZ3JhZGUpOwogIGNvbm5lY3RSZXEub25jZSgiY29ubmVjdCIsIG9uQ29ubmVjdCk7CiAgY29ubmVjdFJlcS5vbmNlKCJlcnJvciIsIG9uRXJyb3IpOwogIGNvbm5lY3RSZXEuZW5kKCk7CiAgZnVuY3Rpb24gb25SZXNwb25zZShyZXMpIHsKICAgIHJlcy51cGdyYWRlID0gdHJ1ZTsKICB9CiAgZnVuY3Rpb24gb25VcGdyYWRlKHJlcywgc29ja2V0LCBoZWFkKSB7CiAgICBwcm9jZXNzLm5leHRUaWNrKGZ1bmN0aW9uKCkgewogICAgICBvbkNvbm5lY3QocmVzLCBzb2NrZXQsIGhlYWQpOwogICAgfSk7CiAgfQogIGZ1bmN0aW9uIG9uQ29ubmVjdChyZXMsIHNvY2tldCwgaGVhZCkgewogICAgY29ubmVjdFJlcS5yZW1vdmVBbGxMaXN0ZW5lcnMoKTsKICAgIHNvY2tldC5yZW1vdmVBbGxMaXN0ZW5lcnMoKTsKICAgIGlmIChyZXMuc3RhdHVzQ29kZSAhPT0gMjAwKSB7CiAgICAgIGRlYnVnKAogICAgICAgICJ0dW5uZWxpbmcgc29ja2V0IGNvdWxkIG5vdCBiZSBlc3RhYmxpc2hlZCwgc3RhdHVzQ29kZT0lZCIsCiAgICAgICAgcmVzLnN0YXR1c0NvZGUKICAgICAgKTsKICAgICAgc29ja2V0LmRlc3Ryb3koKTsKICAgICAgdmFyIGVycm9yID0gbmV3IEVycm9yKCJ0dW5uZWxpbmcgc29ja2V0IGNvdWxkIG5vdCBiZSBlc3RhYmxpc2hlZCwgc3RhdHVzQ29kZT0iICsgcmVzLnN0YXR1c0NvZGUpOwogICAgICBlcnJvci5jb2RlID0gIkVDT05OUkVTRVQiOwogICAgICBvcHRpb25zLnJlcXVlc3QuZW1pdCgiZXJyb3IiLCBlcnJvcik7CiAgICAgIHNlbGYyLnJlbW92ZVNvY2tldChwbGFjZWhvbGRlcik7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChoZWFkLmxlbmd0aCA+IDApIHsKICAgICAgZGVidWcoImdvdCBpbGxlZ2FsIHJlc3BvbnNlIGJvZHkgZnJvbSBwcm94eSIpOwogICAgICBzb2NrZXQuZGVzdHJveSgpOwogICAgICB2YXIgZXJyb3IgPSBuZXcgRXJyb3IoImdvdCBpbGxlZ2FsIHJlc3BvbnNlIGJvZHkgZnJvbSBwcm94eSIpOwogICAgICBlcnJvci5jb2RlID0gIkVDT05OUkVTRVQiOwogICAgICBvcHRpb25zLnJlcXVlc3QuZW1pdCgiZXJyb3IiLCBlcnJvcik7CiAgICAgIHNlbGYyLnJlbW92ZVNvY2tldChwbGFjZWhvbGRlcik7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGRlYnVnKCJ0dW5uZWxpbmcgY29ubmVjdGlvbiBoYXMgZXN0YWJsaXNoZWQiKTsKICAgIHNlbGYyLnNvY2tldHNbc2VsZjIuc29ja2V0cy5pbmRleE9mKHBsYWNlaG9sZGVyKV0gPSBzb2NrZXQ7CiAgICByZXR1cm4gY2Ioc29ja2V0KTsKICB9CiAgZnVuY3Rpb24gb25FcnJvcihjYXVzZSkgewogICAgY29ubmVjdFJlcS5yZW1vdmVBbGxMaXN0ZW5lcnMoKTsKICAgIGRlYnVnKAogICAgICAidHVubmVsaW5nIHNvY2tldCBjb3VsZCBub3QgYmUgZXN0YWJsaXNoZWQsIGNhdXNlPSVzXG4iLAogICAgICBjYXVzZS5tZXNzYWdlLAogICAgICBjYXVzZS5zdGFjawogICAgKTsKICAgIHZhciBlcnJvciA9IG5ldyBFcnJvcigidHVubmVsaW5nIHNvY2tldCBjb3VsZCBub3QgYmUgZXN0YWJsaXNoZWQsIGNhdXNlPSIgKyBjYXVzZS5tZXNzYWdlKTsKICAgIGVycm9yLmNvZGUgPSAiRUNPTk5SRVNFVCI7CiAgICBvcHRpb25zLnJlcXVlc3QuZW1pdCgiZXJyb3IiLCBlcnJvcik7CiAgICBzZWxmMi5yZW1vdmVTb2NrZXQocGxhY2Vob2xkZXIpOwogIH0KfTsKVHVubmVsaW5nQWdlbnQucHJvdG90eXBlLnJlbW92ZVNvY2tldCA9IGZ1bmN0aW9uIHJlbW92ZVNvY2tldChzb2NrZXQpIHsKICB2YXIgcG9zID0gdGhpcy5zb2NrZXRzLmluZGV4T2Yoc29ja2V0KTsKICBpZiAocG9zID09PSAtMSkgewogICAgcmV0dXJuOwogIH0KICB0aGlzLnNvY2tldHMuc3BsaWNlKHBvcywgMSk7CiAgdmFyIHBlbmRpbmcgPSB0aGlzLnJlcXVlc3RzLnNoaWZ0KCk7CiAgaWYgKHBlbmRpbmcpIHsKICAgIHRoaXMuY3JlYXRlU29ja2V0KHBlbmRpbmcsIGZ1bmN0aW9uKHNvY2tldDIpIHsKICAgICAgcGVuZGluZy5yZXF1ZXN0Lm9uU29ja2V0KHNvY2tldDIpOwogICAgfSk7CiAgfQp9OwpmdW5jdGlvbiBjcmVhdGVTZWN1cmVTb2NrZXQob3B0aW9ucywgY2IpIHsKICB2YXIgc2VsZjIgPSB0aGlzOwogIFR1bm5lbGluZ0FnZW50LnByb3RvdHlwZS5jcmVhdGVTb2NrZXQuY2FsbChzZWxmMiwgb3B0aW9ucywgZnVuY3Rpb24oc29ja2V0KSB7CiAgICB2YXIgaG9zdEhlYWRlciA9IG9wdGlvbnMucmVxdWVzdC5nZXRIZWFkZXIoImhvc3QiKTsKICAgIHZhciB0bHNPcHRpb25zID0gbWVyZ2VPcHRpb25zKHt9LCBzZWxmMi5vcHRpb25zLCB7CiAgICAgIHNvY2tldCwKICAgICAgc2VydmVybmFtZTogaG9zdEhlYWRlciA/IGhvc3RIZWFkZXIucmVwbGFjZSgvOi4qJC8sICIiKSA6IG9wdGlvbnMuaG9zdAogICAgfSk7CiAgICB2YXIgc2VjdXJlU29ja2V0ID0gdGxzLmNvbm5lY3QoMCwgdGxzT3B0aW9ucyk7CiAgICBzZWxmMi5zb2NrZXRzW3NlbGYyLnNvY2tldHMuaW5kZXhPZihzb2NrZXQpXSA9IHNlY3VyZVNvY2tldDsKICAgIGNiKHNlY3VyZVNvY2tldCk7CiAgfSk7Cn0KZnVuY3Rpb24gdG9PcHRpb25zKGhvc3QsIHBvcnQsIGxvY2FsQWRkcmVzcykgewogIGlmICh0eXBlb2YgaG9zdCA9PT0gInN0cmluZyIpIHsKICAgIHJldHVybiB7CiAgICAgIGhvc3QsCiAgICAgIHBvcnQsCiAgICAgIGxvY2FsQWRkcmVzcwogICAgfTsKICB9CiAgcmV0dXJuIGhvc3Q7Cn0KZnVuY3Rpb24gbWVyZ2VPcHRpb25zKHRhcmdldCkgewogIGZvciAodmFyIGkgPSAxLCBsZW4gPSBhcmd1bWVudHMubGVuZ3RoOyBpIDwgbGVuOyArK2kpIHsKICAgIHZhciBvdmVycmlkZXMgPSBhcmd1bWVudHNbaV07CiAgICBpZiAodHlwZW9mIG92ZXJyaWRlcyA9PT0gIm9iamVjdCIpIHsKICAgICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhvdmVycmlkZXMpOwogICAgICBmb3IgKHZhciBqID0gMCwga2V5TGVuID0ga2V5cy5sZW5ndGg7IGogPCBrZXlMZW47ICsraikgewogICAgICAgIHZhciBrID0ga2V5c1tqXTsKICAgICAgICBpZiAob3ZlcnJpZGVzW2tdICE9PSB2b2lkIDApIHsKICAgICAgICAgIHRhcmdldFtrXSA9IG92ZXJyaWRlc1trXTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CiAgcmV0dXJuIHRhcmdldDsKfQp2YXIgZGVidWc7CmlmIChwcm9jZXNzLmVudi5OT0RFX0RFQlVHICYmIC9cYnR1bm5lbFxiLy50ZXN0KHByb2Nlc3MuZW52Lk5PREVfREVCVUcpKSB7CiAgZGVidWcgPSBmdW5jdGlvbigpIHsKICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgIGlmICh0eXBlb2YgYXJnc1swXSA9PT0gInN0cmluZyIpIHsKICAgICAgYXJnc1swXSA9ICJUVU5ORUw6ICIgKyBhcmdzWzBdOwogICAgfSBlbHNlIHsKICAgICAgYXJncy51bnNoaWZ0KCJUVU5ORUw6Iik7CiAgICB9CiAgICBjb25zb2xlLmVycm9yLmFwcGx5KGNvbnNvbGUsIGFyZ3MpOwogIH07Cn0gZWxzZSB7CiAgZGVidWcgPSBmdW5jdGlvbigpIHsKICB9Owp9CnR1bm5lbCQxLmRlYnVnID0gZGVidWc7CnZhciB0dW5uZWwgPSB0dW5uZWwkMTsKKGZ1bmN0aW9uKGV4cG9ydHMpIHsKICB2YXIgX19jcmVhdGVCaW5kaW5nMiA9IGNvbW1vbmpzR2xvYmFsICYmIGNvbW1vbmpzR2xvYmFsLl9fY3JlYXRlQmluZGluZyB8fCAoT2JqZWN0LmNyZWF0ZSA/IGZ1bmN0aW9uKG8sIG0sIGssIGsyKSB7CiAgICBpZiAoazIgPT09IHZvaWQgMCkKICAgICAgazIgPSBrOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG8sIGsyLCB7IGVudW1lcmFibGU6IHRydWUsIGdldDogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBtW2tdOwogICAgfSB9KTsKICB9IDogZnVuY3Rpb24obywgbSwgaywgazIpIHsKICAgIGlmIChrMiA9PT0gdm9pZCAwKQogICAgICBrMiA9IGs7CiAgICBvW2syXSA9IG1ba107CiAgfSk7CiAgdmFyIF9fc2V0TW9kdWxlRGVmYXVsdDIgPSBjb21tb25qc0dsb2JhbCAmJiBjb21tb25qc0dsb2JhbC5fX3NldE1vZHVsZURlZmF1bHQgfHwgKE9iamVjdC5jcmVhdGUgPyBmdW5jdGlvbihvLCB2KSB7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkobywgImRlZmF1bHQiLCB7IGVudW1lcmFibGU6IHRydWUsIHZhbHVlOiB2IH0pOwogIH0gOiBmdW5jdGlvbihvLCB2KSB7CiAgICBvWyJkZWZhdWx0Il0gPSB2OwogIH0pOwogIHZhciBfX2ltcG9ydFN0YXIyID0gY29tbW9uanNHbG9iYWwgJiYgY29tbW9uanNHbG9iYWwuX19pbXBvcnRTdGFyIHx8IGZ1bmN0aW9uKG1vZCkgewogICAgaWYgKG1vZCAmJiBtb2QuX19lc01vZHVsZSkKICAgICAgcmV0dXJuIG1vZDsKICAgIHZhciByZXN1bHQgPSB7fTsKICAgIGlmIChtb2QgIT0gbnVsbCkgewogICAgICBmb3IgKHZhciBrIGluIG1vZCkKICAgICAgICBpZiAoayAhPT0gImRlZmF1bHQiICYmIE9iamVjdC5oYXNPd25Qcm9wZXJ0eS5jYWxsKG1vZCwgaykpCiAgICAgICAgICBfX2NyZWF0ZUJpbmRpbmcyKHJlc3VsdCwgbW9kLCBrKTsKICAgIH0KICAgIF9fc2V0TW9kdWxlRGVmYXVsdDIocmVzdWx0LCBtb2QpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9OwogIHZhciBfX2F3YWl0ZXIyID0gY29tbW9uanNHbG9iYWwgJiYgY29tbW9uanNHbG9iYWwuX19hd2FpdGVyIHx8IGZ1bmN0aW9uKHRoaXNBcmcsIF9hcmd1bWVudHMsIFAsIGdlbmVyYXRvcikgewogICAgZnVuY3Rpb24gYWRvcHQodmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlIGluc3RhbmNlb2YgUCA/IHZhbHVlIDogbmV3IFAoZnVuY3Rpb24ocmVzb2x2ZSkgewogICAgICAgIHJlc29sdmUodmFsdWUpOwogICAgICB9KTsKICAgIH0KICAgIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIGZ1bmN0aW9uIGZ1bGZpbGxlZCh2YWx1ZSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICBzdGVwKGdlbmVyYXRvci5uZXh0KHZhbHVlKSk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgcmVqZWN0KGUpOwogICAgICAgIH0KICAgICAgfQogICAgICBmdW5jdGlvbiByZWplY3RlZCh2YWx1ZSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICBzdGVwKGdlbmVyYXRvclsidGhyb3ciXSh2YWx1ZSkpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIHJlamVjdChlKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgZnVuY3Rpb24gc3RlcChyZXN1bHQpIHsKICAgICAgICByZXN1bHQuZG9uZSA/IHJlc29sdmUocmVzdWx0LnZhbHVlKSA6IGFkb3B0KHJlc3VsdC52YWx1ZSkudGhlbihmdWxmaWxsZWQsIHJlamVjdGVkKTsKICAgICAgfQogICAgICBzdGVwKChnZW5lcmF0b3IgPSBnZW5lcmF0b3IuYXBwbHkodGhpc0FyZywgX2FyZ3VtZW50cyB8fCBbXSkpLm5leHQoKSk7CiAgICB9KTsKICB9OwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsgdmFsdWU6IHRydWUgfSk7CiAgZXhwb3J0cy5IdHRwQ2xpZW50ID0gZXhwb3J0cy5pc0h0dHBzID0gZXhwb3J0cy5IdHRwQ2xpZW50UmVzcG9uc2UgPSBleHBvcnRzLkh0dHBDbGllbnRFcnJvciA9IGV4cG9ydHMuZ2V0UHJveHlVcmwgPSBleHBvcnRzLk1lZGlhVHlwZXMgPSBleHBvcnRzLkhlYWRlcnMgPSBleHBvcnRzLkh0dHBDb2RlcyA9IHZvaWQgMDsKICBjb25zdCBodHRwMiA9IF9faW1wb3J0U3RhcjIocmVxdWlyZSQkMiQxKTsKICBjb25zdCBodHRwczIgPSBfX2ltcG9ydFN0YXIyKHJlcXVpcmUkJDMpOwogIGNvbnN0IHBtID0gX19pbXBvcnRTdGFyMihwcm94eSk7CiAgY29uc3QgdHVubmVsJDEyID0gX19pbXBvcnRTdGFyMih0dW5uZWwpOwogIHZhciBIdHRwQ29kZXM7CiAgKGZ1bmN0aW9uKEh0dHBDb2RlczIpIHsKICAgIEh0dHBDb2RlczJbSHR0cENvZGVzMlsiT0siXSA9IDIwMF0gPSAiT0siOwogICAgSHR0cENvZGVzMltIdHRwQ29kZXMyWyJNdWx0aXBsZUNob2ljZXMiXSA9IDMwMF0gPSAiTXVsdGlwbGVDaG9pY2VzIjsKICAgIEh0dHBDb2RlczJbSHR0cENvZGVzMlsiTW92ZWRQZXJtYW5lbnRseSJdID0gMzAxXSA9ICJNb3ZlZFBlcm1hbmVudGx5IjsKICAgIEh0dHBDb2RlczJbSHR0cENvZGVzMlsiUmVzb3VyY2VNb3ZlZCJdID0gMzAyXSA9ICJSZXNvdXJjZU1vdmVkIjsKICAgIEh0dHBDb2RlczJbSHR0cENvZGVzMlsiU2VlT3RoZXIiXSA9IDMwM10gPSAiU2VlT3RoZXIiOwogICAgSHR0cENvZGVzMltIdHRwQ29kZXMyWyJOb3RNb2RpZmllZCJdID0gMzA0XSA9ICJOb3RNb2RpZmllZCI7CiAgICBIdHRwQ29kZXMyW0h0dHBDb2RlczJbIlVzZVByb3h5Il0gPSAzMDVdID0gIlVzZVByb3h5IjsKICAgIEh0dHBDb2RlczJbSHR0cENvZGVzMlsiU3dpdGNoUHJveHkiXSA9IDMwNl0gPSAiU3dpdGNoUHJveHkiOwogICAgSHR0cENvZGVzMltIdHRwQ29kZXMyWyJUZW1wb3JhcnlSZWRpcmVjdCJdID0gMzA3XSA9ICJUZW1wb3JhcnlSZWRpcmVjdCI7CiAgICBIdHRwQ29kZXMyW0h0dHBDb2RlczJbIlBlcm1hbmVudFJlZGlyZWN0Il0gPSAzMDhdID0gIlBlcm1hbmVudFJlZGlyZWN0IjsKICAgIEh0dHBDb2RlczJbSHR0cENvZGVzMlsiQmFkUmVxdWVzdCJdID0gNDAwXSA9ICJCYWRSZXF1ZXN0IjsKICAgIEh0dHBDb2RlczJbSHR0cENvZGVzMlsiVW5hdXRob3JpemVkIl0gPSA0MDFdID0gIlVuYXV0aG9yaXplZCI7CiAgICBIdHRwQ29kZXMyW0h0dHBDb2RlczJbIlBheW1lbnRSZXF1aXJlZCJdID0gNDAyXSA9ICJQYXltZW50UmVxdWlyZWQiOwogICAgSHR0cENvZGVzMltIdHRwQ29kZXMyWyJGb3JiaWRkZW4iXSA9IDQwM10gPSAiRm9yYmlkZGVuIjsKICAgIEh0dHBDb2RlczJbSHR0cENvZGVzMlsiTm90Rm91bmQiXSA9IDQwNF0gPSAiTm90Rm91bmQiOwogICAgSHR0cENvZGVzMltIdHRwQ29kZXMyWyJNZXRob2ROb3RBbGxvd2VkIl0gPSA0MDVdID0gIk1ldGhvZE5vdEFsbG93ZWQiOwogICAgSHR0cENvZGVzMltIdHRwQ29kZXMyWyJOb3RBY2NlcHRhYmxlIl0gPSA0MDZdID0gIk5vdEFjY2VwdGFibGUiOwogICAgSHR0cENvZGVzMltIdHRwQ29kZXMyWyJQcm94eUF1dGhlbnRpY2F0aW9uUmVxdWlyZWQiXSA9IDQwN10gPSAiUHJveHlBdXRoZW50aWNhdGlvblJlcXVpcmVkIjsKICAgIEh0dHBDb2RlczJbSHR0cENvZGVzMlsiUmVxdWVzdFRpbWVvdXQiXSA9IDQwOF0gPSAiUmVxdWVzdFRpbWVvdXQiOwogICAgSHR0cENvZGVzMltIdHRwQ29kZXMyWyJDb25mbGljdCJdID0gNDA5XSA9ICJDb25mbGljdCI7CiAgICBIdHRwQ29kZXMyW0h0dHBDb2RlczJbIkdvbmUiXSA9IDQxMF0gPSAiR29uZSI7CiAgICBIdHRwQ29kZXMyW0h0dHBDb2RlczJbIlRvb01hbnlSZXF1ZXN0cyJdID0gNDI5XSA9ICJUb29NYW55UmVxdWVzdHMiOwogICAgSHR0cENvZGVzMltIdHRwQ29kZXMyWyJJbnRlcm5hbFNlcnZlckVycm9yIl0gPSA1MDBdID0gIkludGVybmFsU2VydmVyRXJyb3IiOwogICAgSHR0cENvZGVzMltIdHRwQ29kZXMyWyJOb3RJbXBsZW1lbnRlZCJdID0gNTAxXSA9ICJOb3RJbXBsZW1lbnRlZCI7CiAgICBIdHRwQ29kZXMyW0h0dHBDb2RlczJbIkJhZEdhdGV3YXkiXSA9IDUwMl0gPSAiQmFkR2F0ZXdheSI7CiAgICBIdHRwQ29kZXMyW0h0dHBDb2RlczJbIlNlcnZpY2VVbmF2YWlsYWJsZSJdID0gNTAzXSA9ICJTZXJ2aWNlVW5hdmFpbGFibGUiOwogICAgSHR0cENvZGVzMltIdHRwQ29kZXMyWyJHYXRld2F5VGltZW91dCJdID0gNTA0XSA9ICJHYXRld2F5VGltZW91dCI7CiAgfSkoSHR0cENvZGVzID0gZXhwb3J0cy5IdHRwQ29kZXMgfHwgKGV4cG9ydHMuSHR0cENvZGVzID0ge30pKTsKICB2YXIgSGVhZGVyczsKICAoZnVuY3Rpb24oSGVhZGVyczIpIHsKICAgIEhlYWRlcnMyWyJBY2NlcHQiXSA9ICJhY2NlcHQiOwogICAgSGVhZGVyczJbIkNvbnRlbnRUeXBlIl0gPSAiY29udGVudC10eXBlIjsKICB9KShIZWFkZXJzID0gZXhwb3J0cy5IZWFkZXJzIHx8IChleHBvcnRzLkhlYWRlcnMgPSB7fSkpOwogIHZhciBNZWRpYVR5cGVzOwogIChmdW5jdGlvbihNZWRpYVR5cGVzMikgewogICAgTWVkaWFUeXBlczJbIkFwcGxpY2F0aW9uSnNvbiJdID0gImFwcGxpY2F0aW9uL2pzb24iOwogIH0pKE1lZGlhVHlwZXMgPSBleHBvcnRzLk1lZGlhVHlwZXMgfHwgKGV4cG9ydHMuTWVkaWFUeXBlcyA9IHt9KSk7CiAgZnVuY3Rpb24gZ2V0UHJveHlVcmwyKHNlcnZlclVybCkgewogICAgY29uc3QgcHJveHlVcmwgPSBwbS5nZXRQcm94eVVybChuZXcgVVJMKHNlcnZlclVybCkpOwogICAgcmV0dXJuIHByb3h5VXJsID8gcHJveHlVcmwuaHJlZiA6ICIiOwogIH0KICBleHBvcnRzLmdldFByb3h5VXJsID0gZ2V0UHJveHlVcmwyOwogIGNvbnN0IEh0dHBSZWRpcmVjdENvZGVzID0gWwogICAgSHR0cENvZGVzLk1vdmVkUGVybWFuZW50bHksCiAgICBIdHRwQ29kZXMuUmVzb3VyY2VNb3ZlZCwKICAgIEh0dHBDb2Rlcy5TZWVPdGhlciwKICAgIEh0dHBDb2Rlcy5UZW1wb3JhcnlSZWRpcmVjdCwKICAgIEh0dHBDb2Rlcy5QZXJtYW5lbnRSZWRpcmVjdAogIF07CiAgY29uc3QgSHR0cFJlc3BvbnNlUmV0cnlDb2RlcyA9IFsKICAgIEh0dHBDb2Rlcy5CYWRHYXRld2F5LAogICAgSHR0cENvZGVzLlNlcnZpY2VVbmF2YWlsYWJsZSwKICAgIEh0dHBDb2Rlcy5HYXRld2F5VGltZW91dAogIF07CiAgY29uc3QgUmV0cnlhYmxlSHR0cFZlcmJzID0gWyJPUFRJT05TIiwgIkdFVCIsICJERUxFVEUiLCAiSEVBRCJdOwogIGNvbnN0IEV4cG9uZW50aWFsQmFja29mZkNlaWxpbmcgPSAxMDsKICBjb25zdCBFeHBvbmVudGlhbEJhY2tvZmZUaW1lU2xpY2UgPSA1OwogIGNsYXNzIEh0dHBDbGllbnRFcnJvciBleHRlbmRzIEVycm9yIHsKICAgIGNvbnN0cnVjdG9yKG1lc3NhZ2UsIHN0YXR1c0NvZGUpIHsKICAgICAgc3VwZXIobWVzc2FnZSk7CiAgICAgIHRoaXMubmFtZSA9ICJIdHRwQ2xpZW50RXJyb3IiOwogICAgICB0aGlzLnN0YXR1c0NvZGUgPSBzdGF0dXNDb2RlOwogICAgICBPYmplY3Quc2V0UHJvdG90eXBlT2YodGhpcywgSHR0cENsaWVudEVycm9yLnByb3RvdHlwZSk7CiAgICB9CiAgfQogIGV4cG9ydHMuSHR0cENsaWVudEVycm9yID0gSHR0cENsaWVudEVycm9yOwogIGNsYXNzIEh0dHBDbGllbnRSZXNwb25zZSB7CiAgICBjb25zdHJ1Y3RvcihtZXNzYWdlKSB7CiAgICAgIHRoaXMubWVzc2FnZSA9IG1lc3NhZ2U7CiAgICB9CiAgICByZWFkQm9keSgpIHsKICAgICAgcmV0dXJuIF9fYXdhaXRlcjIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7CiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiBfX2F3YWl0ZXIyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkgewogICAgICAgICAgbGV0IG91dHB1dCA9IEJ1ZmZlci5hbGxvYygwKTsKICAgICAgICAgIHRoaXMubWVzc2FnZS5vbigiZGF0YSIsIChjaHVuaykgPT4gewogICAgICAgICAgICBvdXRwdXQgPSBCdWZmZXIuY29uY2F0KFtvdXRwdXQsIGNodW5rXSk7CiAgICAgICAgICB9KTsKICAgICAgICAgIHRoaXMubWVzc2FnZS5vbigiZW5kIiwgKCkgPT4gewogICAgICAgICAgICByZXNvbHZlKG91dHB1dC50b1N0cmluZygpKTsKICAgICAgICAgIH0pOwogICAgICAgIH0pKTsKICAgICAgfSk7CiAgICB9CiAgICByZWFkQm9keUJ1ZmZlcigpIHsKICAgICAgcmV0dXJuIF9fYXdhaXRlcjIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7CiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiBfX2F3YWl0ZXIyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkgewogICAgICAgICAgY29uc3QgY2h1bmtzID0gW107CiAgICAgICAgICB0aGlzLm1lc3NhZ2Uub24oImRhdGEiLCAoY2h1bmspID0+IHsKICAgICAgICAgICAgY2h1bmtzLnB1c2goY2h1bmspOwogICAgICAgICAgfSk7CiAgICAgICAgICB0aGlzLm1lc3NhZ2Uub24oImVuZCIsICgpID0+IHsKICAgICAgICAgICAgcmVzb2x2ZShCdWZmZXIuY29uY2F0KGNodW5rcykpOwogICAgICAgICAgfSk7CiAgICAgICAgfSkpOwogICAgICB9KTsKICAgIH0KICB9CiAgZXhwb3J0cy5IdHRwQ2xpZW50UmVzcG9uc2UgPSBIdHRwQ2xpZW50UmVzcG9uc2U7CiAgZnVuY3Rpb24gaXNIdHRwcyhyZXF1ZXN0VXJsKSB7CiAgICBjb25zdCBwYXJzZWRVcmwgPSBuZXcgVVJMKHJlcXVlc3RVcmwpOwogICAgcmV0dXJuIHBhcnNlZFVybC5wcm90b2NvbCA9PT0gImh0dHBzOiI7CiAgfQogIGV4cG9ydHMuaXNIdHRwcyA9IGlzSHR0cHM7CiAgY2xhc3MgSHR0cENsaWVudCB7CiAgICBjb25zdHJ1Y3Rvcih1c2VyQWdlbnQsIGhhbmRsZXJzLCByZXF1ZXN0T3B0aW9ucykgewogICAgICB0aGlzLl9pZ25vcmVTc2xFcnJvciA9IGZhbHNlOwogICAgICB0aGlzLl9hbGxvd1JlZGlyZWN0cyA9IHRydWU7CiAgICAgIHRoaXMuX2FsbG93UmVkaXJlY3REb3duZ3JhZGUgPSBmYWxzZTsKICAgICAgdGhpcy5fbWF4UmVkaXJlY3RzID0gNTA7CiAgICAgIHRoaXMuX2FsbG93UmV0cmllcyA9IGZhbHNlOwogICAgICB0aGlzLl9tYXhSZXRyaWVzID0gMTsKICAgICAgdGhpcy5fa2VlcEFsaXZlID0gZmFsc2U7CiAgICAgIHRoaXMuX2Rpc3Bvc2VkID0gZmFsc2U7CiAgICAgIHRoaXMudXNlckFnZW50ID0gdXNlckFnZW50OwogICAgICB0aGlzLmhhbmRsZXJzID0gaGFuZGxlcnMgfHwgW107CiAgICAgIHRoaXMucmVxdWVzdE9wdGlvbnMgPSByZXF1ZXN0T3B0aW9uczsKICAgICAgaWYgKHJlcXVlc3RPcHRpb25zKSB7CiAgICAgICAgaWYgKHJlcXVlc3RPcHRpb25zLmlnbm9yZVNzbEVycm9yICE9IG51bGwpIHsKICAgICAgICAgIHRoaXMuX2lnbm9yZVNzbEVycm9yID0gcmVxdWVzdE9wdGlvbnMuaWdub3JlU3NsRXJyb3I7CiAgICAgICAgfQogICAgICAgIHRoaXMuX3NvY2tldFRpbWVvdXQgPSByZXF1ZXN0T3B0aW9ucy5zb2NrZXRUaW1lb3V0OwogICAgICAgIGlmIChyZXF1ZXN0T3B0aW9ucy5hbGxvd1JlZGlyZWN0cyAhPSBudWxsKSB7CiAgICAgICAgICB0aGlzLl9hbGxvd1JlZGlyZWN0cyA9IHJlcXVlc3RPcHRpb25zLmFsbG93UmVkaXJlY3RzOwogICAgICAgIH0KICAgICAgICBpZiAocmVxdWVzdE9wdGlvbnMuYWxsb3dSZWRpcmVjdERvd25ncmFkZSAhPSBudWxsKSB7CiAgICAgICAgICB0aGlzLl9hbGxvd1JlZGlyZWN0RG93bmdyYWRlID0gcmVxdWVzdE9wdGlvbnMuYWxsb3dSZWRpcmVjdERvd25ncmFkZTsKICAgICAgICB9CiAgICAgICAgaWYgKHJlcXVlc3RPcHRpb25zLm1heFJlZGlyZWN0cyAhPSBudWxsKSB7CiAgICAgICAgICB0aGlzLl9tYXhSZWRpcmVjdHMgPSBNYXRoLm1heChyZXF1ZXN0T3B0aW9ucy5tYXhSZWRpcmVjdHMsIDApOwogICAgICAgIH0KICAgICAgICBpZiAocmVxdWVzdE9wdGlvbnMua2VlcEFsaXZlICE9IG51bGwpIHsKICAgICAgICAgIHRoaXMuX2tlZXBBbGl2ZSA9IHJlcXVlc3RPcHRpb25zLmtlZXBBbGl2ZTsKICAgICAgICB9CiAgICAgICAgaWYgKHJlcXVlc3RPcHRpb25zLmFsbG93UmV0cmllcyAhPSBudWxsKSB7CiAgICAgICAgICB0aGlzLl9hbGxvd1JldHJpZXMgPSByZXF1ZXN0T3B0aW9ucy5hbGxvd1JldHJpZXM7CiAgICAgICAgfQogICAgICAgIGlmIChyZXF1ZXN0T3B0aW9ucy5tYXhSZXRyaWVzICE9IG51bGwpIHsKICAgICAgICAgIHRoaXMuX21heFJldHJpZXMgPSByZXF1ZXN0T3B0aW9ucy5tYXhSZXRyaWVzOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgb3B0aW9ucyhyZXF1ZXN0VXJsLCBhZGRpdGlvbmFsSGVhZGVycykgewogICAgICByZXR1cm4gX19hd2FpdGVyMih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5yZXF1ZXN0KCJPUFRJT05TIiwgcmVxdWVzdFVybCwgbnVsbCwgYWRkaXRpb25hbEhlYWRlcnMgfHwge30pOwogICAgICB9KTsKICAgIH0KICAgIGdldChyZXF1ZXN0VXJsLCBhZGRpdGlvbmFsSGVhZGVycykgewogICAgICByZXR1cm4gX19hd2FpdGVyMih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5yZXF1ZXN0KCJHRVQiLCByZXF1ZXN0VXJsLCBudWxsLCBhZGRpdGlvbmFsSGVhZGVycyB8fCB7fSk7CiAgICAgIH0pOwogICAgfQogICAgZGVsKHJlcXVlc3RVcmwsIGFkZGl0aW9uYWxIZWFkZXJzKSB7CiAgICAgIHJldHVybiBfX2F3YWl0ZXIyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkgewogICAgICAgIHJldHVybiB0aGlzLnJlcXVlc3QoIkRFTEVURSIsIHJlcXVlc3RVcmwsIG51bGwsIGFkZGl0aW9uYWxIZWFkZXJzIHx8IHt9KTsKICAgICAgfSk7CiAgICB9CiAgICBwb3N0KHJlcXVlc3RVcmwsIGRhdGEsIGFkZGl0aW9uYWxIZWFkZXJzKSB7CiAgICAgIHJldHVybiBfX2F3YWl0ZXIyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkgewogICAgICAgIHJldHVybiB0aGlzLnJlcXVlc3QoIlBPU1QiLCByZXF1ZXN0VXJsLCBkYXRhLCBhZGRpdGlvbmFsSGVhZGVycyB8fCB7fSk7CiAgICAgIH0pOwogICAgfQogICAgcGF0Y2gocmVxdWVzdFVybCwgZGF0YSwgYWRkaXRpb25hbEhlYWRlcnMpIHsKICAgICAgcmV0dXJuIF9fYXdhaXRlcjIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMucmVxdWVzdCgiUEFUQ0giLCByZXF1ZXN0VXJsLCBkYXRhLCBhZGRpdGlvbmFsSGVhZGVycyB8fCB7fSk7CiAgICAgIH0pOwogICAgfQogICAgcHV0KHJlcXVlc3RVcmwsIGRhdGEsIGFkZGl0aW9uYWxIZWFkZXJzKSB7CiAgICAgIHJldHVybiBfX2F3YWl0ZXIyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkgewogICAgICAgIHJldHVybiB0aGlzLnJlcXVlc3QoIlBVVCIsIHJlcXVlc3RVcmwsIGRhdGEsIGFkZGl0aW9uYWxIZWFkZXJzIHx8IHt9KTsKICAgICAgfSk7CiAgICB9CiAgICBoZWFkKHJlcXVlc3RVcmwsIGFkZGl0aW9uYWxIZWFkZXJzKSB7CiAgICAgIHJldHVybiBfX2F3YWl0ZXIyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkgewogICAgICAgIHJldHVybiB0aGlzLnJlcXVlc3QoIkhFQUQiLCByZXF1ZXN0VXJsLCBudWxsLCBhZGRpdGlvbmFsSGVhZGVycyB8fCB7fSk7CiAgICAgIH0pOwogICAgfQogICAgc2VuZFN0cmVhbSh2ZXJiLCByZXF1ZXN0VXJsLCBzdHJlYW0yLCBhZGRpdGlvbmFsSGVhZGVycykgewogICAgICByZXR1cm4gX19hd2FpdGVyMih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5yZXF1ZXN0KHZlcmIsIHJlcXVlc3RVcmwsIHN0cmVhbTIsIGFkZGl0aW9uYWxIZWFkZXJzKTsKICAgICAgfSk7CiAgICB9CiAgICAvKioKICAgICAqIEdldHMgYSB0eXBlZCBvYmplY3QgZnJvbSBhbiBlbmRwb2ludAogICAgICogQmUgYXdhcmUgdGhhdCBub3QgZm91bmQgcmV0dXJucyBhIG51bGwuICBPdGhlciBlcnJvcnMgKDR4eCwgNXh4KSByZWplY3QgdGhlIHByb21pc2UKICAgICAqLwogICAgZ2V0SnNvbihyZXF1ZXN0VXJsLCBhZGRpdGlvbmFsSGVhZGVycyA9IHt9KSB7CiAgICAgIHJldHVybiBfX2F3YWl0ZXIyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkgewogICAgICAgIGFkZGl0aW9uYWxIZWFkZXJzW0hlYWRlcnMuQWNjZXB0XSA9IHRoaXMuX2dldEV4aXN0aW5nT3JEZWZhdWx0SGVhZGVyKGFkZGl0aW9uYWxIZWFkZXJzLCBIZWFkZXJzLkFjY2VwdCwgTWVkaWFUeXBlcy5BcHBsaWNhdGlvbkpzb24pOwogICAgICAgIGNvbnN0IHJlcyA9IHlpZWxkIHRoaXMuZ2V0KHJlcXVlc3RVcmwsIGFkZGl0aW9uYWxIZWFkZXJzKTsKICAgICAgICByZXR1cm4gdGhpcy5fcHJvY2Vzc1Jlc3BvbnNlKHJlcywgdGhpcy5yZXF1ZXN0T3B0aW9ucyk7CiAgICAgIH0pOwogICAgfQogICAgcG9zdEpzb24ocmVxdWVzdFVybCwgb2JqLCBhZGRpdGlvbmFsSGVhZGVycyA9IHt9KSB7CiAgICAgIHJldHVybiBfX2F3YWl0ZXIyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkgewogICAgICAgIGNvbnN0IGRhdGEgPSBKU09OLnN0cmluZ2lmeShvYmosIG51bGwsIDIpOwogICAgICAgIGFkZGl0aW9uYWxIZWFkZXJzW0hlYWRlcnMuQWNjZXB0XSA9IHRoaXMuX2dldEV4aXN0aW5nT3JEZWZhdWx0SGVhZGVyKGFkZGl0aW9uYWxIZWFkZXJzLCBIZWFkZXJzLkFjY2VwdCwgTWVkaWFUeXBlcy5BcHBsaWNhdGlvbkpzb24pOwogICAgICAgIGFkZGl0aW9uYWxIZWFkZXJzW0hlYWRlcnMuQ29udGVudFR5cGVdID0gdGhpcy5fZ2V0RXhpc3RpbmdPckRlZmF1bHRIZWFkZXIoYWRkaXRpb25hbEhlYWRlcnMsIEhlYWRlcnMuQ29udGVudFR5cGUsIE1lZGlhVHlwZXMuQXBwbGljYXRpb25Kc29uKTsKICAgICAgICBjb25zdCByZXMgPSB5aWVsZCB0aGlzLnBvc3QocmVxdWVzdFVybCwgZGF0YSwgYWRkaXRpb25hbEhlYWRlcnMpOwogICAgICAgIHJldHVybiB0aGlzLl9wcm9jZXNzUmVzcG9uc2UocmVzLCB0aGlzLnJlcXVlc3RPcHRpb25zKTsKICAgICAgfSk7CiAgICB9CiAgICBwdXRKc29uKHJlcXVlc3RVcmwsIG9iaiwgYWRkaXRpb25hbEhlYWRlcnMgPSB7fSkgewogICAgICByZXR1cm4gX19hd2FpdGVyMih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHsKICAgICAgICBjb25zdCBkYXRhID0gSlNPTi5zdHJpbmdpZnkob2JqLCBudWxsLCAyKTsKICAgICAgICBhZGRpdGlvbmFsSGVhZGVyc1tIZWFkZXJzLkFjY2VwdF0gPSB0aGlzLl9nZXRFeGlzdGluZ09yRGVmYXVsdEhlYWRlcihhZGRpdGlvbmFsSGVhZGVycywgSGVhZGVycy5BY2NlcHQsIE1lZGlhVHlwZXMuQXBwbGljYXRpb25Kc29uKTsKICAgICAgICBhZGRpdGlvbmFsSGVhZGVyc1tIZWFkZXJzLkNvbnRlbnRUeXBlXSA9IHRoaXMuX2dldEV4aXN0aW5nT3JEZWZhdWx0SGVhZGVyKGFkZGl0aW9uYWxIZWFkZXJzLCBIZWFkZXJzLkNvbnRlbnRUeXBlLCBNZWRpYVR5cGVzLkFwcGxpY2F0aW9uSnNvbik7CiAgICAgICAgY29uc3QgcmVzID0geWllbGQgdGhpcy5wdXQocmVxdWVzdFVybCwgZGF0YSwgYWRkaXRpb25hbEhlYWRlcnMpOwogICAgICAgIHJldHVybiB0aGlzLl9wcm9jZXNzUmVzcG9uc2UocmVzLCB0aGlzLnJlcXVlc3RPcHRpb25zKTsKICAgICAgfSk7CiAgICB9CiAgICBwYXRjaEpzb24ocmVxdWVzdFVybCwgb2JqLCBhZGRpdGlvbmFsSGVhZGVycyA9IHt9KSB7CiAgICAgIHJldHVybiBfX2F3YWl0ZXIyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkgewogICAgICAgIGNvbnN0IGRhdGEgPSBKU09OLnN0cmluZ2lmeShvYmosIG51bGwsIDIpOwogICAgICAgIGFkZGl0aW9uYWxIZWFkZXJzW0hlYWRlcnMuQWNjZXB0XSA9IHRoaXMuX2dldEV4aXN0aW5nT3JEZWZhdWx0SGVhZGVyKGFkZGl0aW9uYWxIZWFkZXJzLCBIZWFkZXJzLkFjY2VwdCwgTWVkaWFUeXBlcy5BcHBsaWNhdGlvbkpzb24pOwogICAgICAgIGFkZGl0aW9uYWxIZWFkZXJzW0hlYWRlcnMuQ29udGVudFR5cGVdID0gdGhpcy5fZ2V0RXhpc3RpbmdPckRlZmF1bHRIZWFkZXIoYWRkaXRpb25hbEhlYWRlcnMsIEhlYWRlcnMuQ29udGVudFR5cGUsIE1lZGlhVHlwZXMuQXBwbGljYXRpb25Kc29uKTsKICAgICAgICBjb25zdCByZXMgPSB5aWVsZCB0aGlzLnBhdGNoKHJlcXVlc3RVcmwsIGRhdGEsIGFkZGl0aW9uYWxIZWFkZXJzKTsKICAgICAgICByZXR1cm4gdGhpcy5fcHJvY2Vzc1Jlc3BvbnNlKHJlcywgdGhpcy5yZXF1ZXN0T3B0aW9ucyk7CiAgICAgIH0pOwogICAgfQogICAgLyoqCiAgICAgKiBNYWtlcyBhIHJhdyBodHRwIHJlcXVlc3QuCiAgICAgKiBBbGwgb3RoZXIgbWV0aG9kcyBzdWNoIGFzIGdldCwgcG9zdCwgcGF0Y2gsIGFuZCByZXF1ZXN0IHVsdGltYXRlbHkgY2FsbCB0aGlzLgogICAgICogUHJlZmVyIGdldCwgZGVsLCBwb3N0IGFuZCBwYXRjaAogICAgICovCiAgICByZXF1ZXN0KHZlcmIsIHJlcXVlc3RVcmwsIGRhdGEsIGhlYWRlcnMpIHsKICAgICAgcmV0dXJuIF9fYXdhaXRlcjIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7CiAgICAgICAgaWYgKHRoaXMuX2Rpc3Bvc2VkKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNsaWVudCBoYXMgYWxyZWFkeSBiZWVuIGRpc3Bvc2VkLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBwYXJzZWRVcmwgPSBuZXcgVVJMKHJlcXVlc3RVcmwpOwogICAgICAgIGxldCBpbmZvID0gdGhpcy5fcHJlcGFyZVJlcXVlc3QodmVyYiwgcGFyc2VkVXJsLCBoZWFkZXJzKTsKICAgICAgICBjb25zdCBtYXhUcmllcyA9IHRoaXMuX2FsbG93UmV0cmllcyAmJiBSZXRyeWFibGVIdHRwVmVyYnMuaW5jbHVkZXModmVyYikgPyB0aGlzLl9tYXhSZXRyaWVzICsgMSA6IDE7CiAgICAgICAgbGV0IG51bVRyaWVzID0gMDsKICAgICAgICBsZXQgcmVzcG9uc2U7CiAgICAgICAgZG8gewogICAgICAgICAgcmVzcG9uc2UgPSB5aWVsZCB0aGlzLnJlcXVlc3RSYXcoaW5mbywgZGF0YSk7CiAgICAgICAgICBpZiAocmVzcG9uc2UgJiYgcmVzcG9uc2UubWVzc2FnZSAmJiByZXNwb25zZS5tZXNzYWdlLnN0YXR1c0NvZGUgPT09IEh0dHBDb2Rlcy5VbmF1dGhvcml6ZWQpIHsKICAgICAgICAgICAgbGV0IGF1dGhlbnRpY2F0aW9uSGFuZGxlcjsKICAgICAgICAgICAgZm9yIChjb25zdCBoYW5kbGVyIG9mIHRoaXMuaGFuZGxlcnMpIHsKICAgICAgICAgICAgICBpZiAoaGFuZGxlci5jYW5IYW5kbGVBdXRoZW50aWNhdGlvbihyZXNwb25zZSkpIHsKICAgICAgICAgICAgICAgIGF1dGhlbnRpY2F0aW9uSGFuZGxlciA9IGhhbmRsZXI7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGF1dGhlbnRpY2F0aW9uSGFuZGxlcikgewogICAgICAgICAgICAgIHJldHVybiBhdXRoZW50aWNhdGlvbkhhbmRsZXIuaGFuZGxlQXV0aGVudGljYXRpb24odGhpcywgaW5mbywgZGF0YSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBsZXQgcmVkaXJlY3RzUmVtYWluaW5nID0gdGhpcy5fbWF4UmVkaXJlY3RzOwogICAgICAgICAgd2hpbGUgKHJlc3BvbnNlLm1lc3NhZ2Uuc3RhdHVzQ29kZSAmJiBIdHRwUmVkaXJlY3RDb2Rlcy5pbmNsdWRlcyhyZXNwb25zZS5tZXNzYWdlLnN0YXR1c0NvZGUpICYmIHRoaXMuX2FsbG93UmVkaXJlY3RzICYmIHJlZGlyZWN0c1JlbWFpbmluZyA+IDApIHsKICAgICAgICAgICAgY29uc3QgcmVkaXJlY3RVcmwgPSByZXNwb25zZS5tZXNzYWdlLmhlYWRlcnNbImxvY2F0aW9uIl07CiAgICAgICAgICAgIGlmICghcmVkaXJlY3RVcmwpIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb25zdCBwYXJzZWRSZWRpcmVjdFVybCA9IG5ldyBVUkwocmVkaXJlY3RVcmwpOwogICAgICAgICAgICBpZiAocGFyc2VkVXJsLnByb3RvY29sID09PSAiaHR0cHM6IiAmJiBwYXJzZWRVcmwucHJvdG9jb2wgIT09IHBhcnNlZFJlZGlyZWN0VXJsLnByb3RvY29sICYmICF0aGlzLl9hbGxvd1JlZGlyZWN0RG93bmdyYWRlKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJSZWRpcmVjdCBmcm9tIEhUVFBTIHRvIEhUVFAgcHJvdG9jb2wuIFRoaXMgZG93bmdyYWRlIGlzIG5vdCBhbGxvd2VkIGZvciBzZWN1cml0eSByZWFzb25zLiBJZiB5b3Ugd2FudCB0byBhbGxvdyB0aGlzIGJlaGF2aW9yLCBzZXQgdGhlIGFsbG93UmVkaXJlY3REb3duZ3JhZGUgb3B0aW9uIHRvIHRydWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgeWllbGQgcmVzcG9uc2UucmVhZEJvZHkoKTsKICAgICAgICAgICAgaWYgKHBhcnNlZFJlZGlyZWN0VXJsLmhvc3RuYW1lICE9PSBwYXJzZWRVcmwuaG9zdG5hbWUpIHsKICAgICAgICAgICAgICBmb3IgKGNvbnN0IGhlYWRlciBpbiBoZWFkZXJzKSB7CiAgICAgICAgICAgICAgICBpZiAoaGVhZGVyLnRvTG93ZXJDYXNlKCkgPT09ICJhdXRob3JpemF0aW9uIikgewogICAgICAgICAgICAgICAgICBkZWxldGUgaGVhZGVyc1toZWFkZXJdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpbmZvID0gdGhpcy5fcHJlcGFyZVJlcXVlc3QodmVyYiwgcGFyc2VkUmVkaXJlY3RVcmwsIGhlYWRlcnMpOwogICAgICAgICAgICByZXNwb25zZSA9IHlpZWxkIHRoaXMucmVxdWVzdFJhdyhpbmZvLCBkYXRhKTsKICAgICAgICAgICAgcmVkaXJlY3RzUmVtYWluaW5nLS07CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIXJlc3BvbnNlLm1lc3NhZ2Uuc3RhdHVzQ29kZSB8fCAhSHR0cFJlc3BvbnNlUmV0cnlDb2Rlcy5pbmNsdWRlcyhyZXNwb25zZS5tZXNzYWdlLnN0YXR1c0NvZGUpKSB7CiAgICAgICAgICAgIHJldHVybiByZXNwb25zZTsKICAgICAgICAgIH0KICAgICAgICAgIG51bVRyaWVzICs9IDE7CiAgICAgICAgICBpZiAobnVtVHJpZXMgPCBtYXhUcmllcykgewogICAgICAgICAgICB5aWVsZCByZXNwb25zZS5yZWFkQm9keSgpOwogICAgICAgICAgICB5aWVsZCB0aGlzLl9wZXJmb3JtRXhwb25lbnRpYWxCYWNrb2ZmKG51bVRyaWVzKTsKICAgICAgICAgIH0KICAgICAgICB9IHdoaWxlIChudW1UcmllcyA8IG1heFRyaWVzKTsKICAgICAgICByZXR1cm4gcmVzcG9uc2U7CiAgICAgIH0pOwogICAgfQogICAgLyoqCiAgICAgKiBOZWVkcyB0byBiZSBjYWxsZWQgaWYga2VlcEFsaXZlIGlzIHNldCB0byB0cnVlIGluIHJlcXVlc3Qgb3B0aW9ucy4KICAgICAqLwogICAgZGlzcG9zZSgpIHsKICAgICAgaWYgKHRoaXMuX2FnZW50KSB7CiAgICAgICAgdGhpcy5fYWdlbnQuZGVzdHJveSgpOwogICAgICB9CiAgICAgIHRoaXMuX2Rpc3Bvc2VkID0gdHJ1ZTsKICAgIH0KICAgIC8qKgogICAgICogUmF3IHJlcXVlc3QuCiAgICAgKiBAcGFyYW0gaW5mbwogICAgICogQHBhcmFtIGRhdGEKICAgICAqLwogICAgcmVxdWVzdFJhdyhpbmZvLCBkYXRhKSB7CiAgICAgIHJldHVybiBfX2F3YWl0ZXIyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkgewogICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgICAgICBmdW5jdGlvbiBjYWxsYmFja0ZvclJlc3VsdChlcnIsIHJlcykgewogICAgICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICAgICAgcmVqZWN0KGVycik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoIXJlcykgewogICAgICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IoIlVua25vd24gZXJyb3IiKSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVzb2x2ZShyZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLnJlcXVlc3RSYXdXaXRoQ2FsbGJhY2soaW5mbywgZGF0YSwgY2FsbGJhY2tGb3JSZXN1bHQpOwogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0KICAgIC8qKgogICAgICogUmF3IHJlcXVlc3Qgd2l0aCBjYWxsYmFjay4KICAgICAqIEBwYXJhbSBpbmZvCiAgICAgKiBAcGFyYW0gZGF0YQogICAgICogQHBhcmFtIG9uUmVzdWx0CiAgICAgKi8KICAgIHJlcXVlc3RSYXdXaXRoQ2FsbGJhY2soaW5mbywgZGF0YSwgb25SZXN1bHQpIHsKICAgICAgaWYgKHR5cGVvZiBkYXRhID09PSAic3RyaW5nIikgewogICAgICAgIGlmICghaW5mby5vcHRpb25zLmhlYWRlcnMpIHsKICAgICAgICAgIGluZm8ub3B0aW9ucy5oZWFkZXJzID0ge307CiAgICAgICAgfQogICAgICAgIGluZm8ub3B0aW9ucy5oZWFkZXJzWyJDb250ZW50LUxlbmd0aCJdID0gQnVmZmVyLmJ5dGVMZW5ndGgoZGF0YSwgInV0ZjgiKTsKICAgICAgfQogICAgICBsZXQgY2FsbGJhY2tDYWxsZWQgPSBmYWxzZTsKICAgICAgZnVuY3Rpb24gaGFuZGxlUmVzdWx0KGVyciwgcmVzKSB7CiAgICAgICAgaWYgKCFjYWxsYmFja0NhbGxlZCkgewogICAgICAgICAgY2FsbGJhY2tDYWxsZWQgPSB0cnVlOwogICAgICAgICAgb25SZXN1bHQoZXJyLCByZXMpOwogICAgICAgIH0KICAgICAgfQogICAgICBjb25zdCByZXEgPSBpbmZvLmh0dHBNb2R1bGUucmVxdWVzdChpbmZvLm9wdGlvbnMsIChtc2cpID0+IHsKICAgICAgICBjb25zdCByZXMgPSBuZXcgSHR0cENsaWVudFJlc3BvbnNlKG1zZyk7CiAgICAgICAgaGFuZGxlUmVzdWx0KHZvaWQgMCwgcmVzKTsKICAgICAgfSk7CiAgICAgIGxldCBzb2NrZXQ7CiAgICAgIHJlcS5vbigic29ja2V0IiwgKHNvY2spID0+IHsKICAgICAgICBzb2NrZXQgPSBzb2NrOwogICAgICB9KTsKICAgICAgcmVxLnNldFRpbWVvdXQodGhpcy5fc29ja2V0VGltZW91dCB8fCAzICogNmU0LCAoKSA9PiB7CiAgICAgICAgaWYgKHNvY2tldCkgewogICAgICAgICAgc29ja2V0LmVuZCgpOwogICAgICAgIH0KICAgICAgICBoYW5kbGVSZXN1bHQobmV3IEVycm9yKGBSZXF1ZXN0IHRpbWVvdXQ6ICR7aW5mby5vcHRpb25zLnBhdGh9YCkpOwogICAgICB9KTsKICAgICAgcmVxLm9uKCJlcnJvciIsIGZ1bmN0aW9uKGVycikgewogICAgICAgIGhhbmRsZVJlc3VsdChlcnIpOwogICAgICB9KTsKICAgICAgaWYgKGRhdGEgJiYgdHlwZW9mIGRhdGEgPT09ICJzdHJpbmciKSB7CiAgICAgICAgcmVxLndyaXRlKGRhdGEsICJ1dGY4Iik7CiAgICAgIH0KICAgICAgaWYgKGRhdGEgJiYgdHlwZW9mIGRhdGEgIT09ICJzdHJpbmciKSB7CiAgICAgICAgZGF0YS5vbigiY2xvc2UiLCBmdW5jdGlvbigpIHsKICAgICAgICAgIHJlcS5lbmQoKTsKICAgICAgICB9KTsKICAgICAgICBkYXRhLnBpcGUocmVxKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXEuZW5kKCk7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogR2V0cyBhbiBodHRwIGFnZW50LiBUaGlzIGZ1bmN0aW9uIGlzIHVzZWZ1bCB3aGVuIHlvdSBuZWVkIGFuIGh0dHAgYWdlbnQgdGhhdCBoYW5kbGVzCiAgICAgKiByb3V0aW5nIHRocm91Z2ggYSBwcm94eSBzZXJ2ZXIgLSBkZXBlbmRpbmcgdXBvbiB0aGUgdXJsIGFuZCBwcm94eSBlbnZpcm9ubWVudCB2YXJpYWJsZXMuCiAgICAgKiBAcGFyYW0gc2VydmVyVXJsICBUaGUgc2VydmVyIFVSTCB3aGVyZSB0aGUgcmVxdWVzdCB3aWxsIGJlIHNlbnQuIEZvciBleGFtcGxlLCBodHRwczovL2FwaS5naXRodWIuY29tCiAgICAgKi8KICAgIGdldEFnZW50KHNlcnZlclVybCkgewogICAgICBjb25zdCBwYXJzZWRVcmwgPSBuZXcgVVJMKHNlcnZlclVybCk7CiAgICAgIHJldHVybiB0aGlzLl9nZXRBZ2VudChwYXJzZWRVcmwpOwogICAgfQogICAgX3ByZXBhcmVSZXF1ZXN0KG1ldGhvZCwgcmVxdWVzdFVybCwgaGVhZGVycykgewogICAgICBjb25zdCBpbmZvID0ge307CiAgICAgIGluZm8ucGFyc2VkVXJsID0gcmVxdWVzdFVybDsKICAgICAgY29uc3QgdXNpbmdTc2wgPSBpbmZvLnBhcnNlZFVybC5wcm90b2NvbCA9PT0gImh0dHBzOiI7CiAgICAgIGluZm8uaHR0cE1vZHVsZSA9IHVzaW5nU3NsID8gaHR0cHMyIDogaHR0cDI7CiAgICAgIGNvbnN0IGRlZmF1bHRQb3J0ID0gdXNpbmdTc2wgPyA0NDMgOiA4MDsKICAgICAgaW5mby5vcHRpb25zID0ge307CiAgICAgIGluZm8ub3B0aW9ucy5ob3N0ID0gaW5mby5wYXJzZWRVcmwuaG9zdG5hbWU7CiAgICAgIGluZm8ub3B0aW9ucy5wb3J0ID0gaW5mby5wYXJzZWRVcmwucG9ydCA/IHBhcnNlSW50KGluZm8ucGFyc2VkVXJsLnBvcnQpIDogZGVmYXVsdFBvcnQ7CiAgICAgIGluZm8ub3B0aW9ucy5wYXRoID0gKGluZm8ucGFyc2VkVXJsLnBhdGhuYW1lIHx8ICIiKSArIChpbmZvLnBhcnNlZFVybC5zZWFyY2ggfHwgIiIpOwogICAgICBpbmZvLm9wdGlvbnMubWV0aG9kID0gbWV0aG9kOwogICAgICBpbmZvLm9wdGlvbnMuaGVhZGVycyA9IHRoaXMuX21lcmdlSGVhZGVycyhoZWFkZXJzKTsKICAgICAgaWYgKHRoaXMudXNlckFnZW50ICE9IG51bGwpIHsKICAgICAgICBpbmZvLm9wdGlvbnMuaGVhZGVyc1sidXNlci1hZ2VudCJdID0gdGhpcy51c2VyQWdlbnQ7CiAgICAgIH0KICAgICAgaW5mby5vcHRpb25zLmFnZW50ID0gdGhpcy5fZ2V0QWdlbnQoaW5mby5wYXJzZWRVcmwpOwogICAgICBpZiAodGhpcy5oYW5kbGVycykgewogICAgICAgIGZvciAoY29uc3QgaGFuZGxlciBvZiB0aGlzLmhhbmRsZXJzKSB7CiAgICAgICAgICBoYW5kbGVyLnByZXBhcmVSZXF1ZXN0KGluZm8ub3B0aW9ucyk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBpbmZvOwogICAgfQogICAgX21lcmdlSGVhZGVycyhoZWFkZXJzKSB7CiAgICAgIGlmICh0aGlzLnJlcXVlc3RPcHRpb25zICYmIHRoaXMucmVxdWVzdE9wdGlvbnMuaGVhZGVycykgewogICAgICAgIHJldHVybiBPYmplY3QuYXNzaWduKHt9LCBsb3dlcmNhc2VLZXlzKHRoaXMucmVxdWVzdE9wdGlvbnMuaGVhZGVycyksIGxvd2VyY2FzZUtleXMoaGVhZGVycyB8fCB7fSkpOwogICAgICB9CiAgICAgIHJldHVybiBsb3dlcmNhc2VLZXlzKGhlYWRlcnMgfHwge30pOwogICAgfQogICAgX2dldEV4aXN0aW5nT3JEZWZhdWx0SGVhZGVyKGFkZGl0aW9uYWxIZWFkZXJzLCBoZWFkZXIsIF9kZWZhdWx0KSB7CiAgICAgIGxldCBjbGllbnRIZWFkZXI7CiAgICAgIGlmICh0aGlzLnJlcXVlc3RPcHRpb25zICYmIHRoaXMucmVxdWVzdE9wdGlvbnMuaGVhZGVycykgewogICAgICAgIGNsaWVudEhlYWRlciA9IGxvd2VyY2FzZUtleXModGhpcy5yZXF1ZXN0T3B0aW9ucy5oZWFkZXJzKVtoZWFkZXJdOwogICAgICB9CiAgICAgIHJldHVybiBhZGRpdGlvbmFsSGVhZGVyc1toZWFkZXJdIHx8IGNsaWVudEhlYWRlciB8fCBfZGVmYXVsdDsKICAgIH0KICAgIF9nZXRBZ2VudChwYXJzZWRVcmwpIHsKICAgICAgbGV0IGFnZW50OwogICAgICBjb25zdCBwcm94eVVybCA9IHBtLmdldFByb3h5VXJsKHBhcnNlZFVybCk7CiAgICAgIGNvbnN0IHVzZVByb3h5ID0gcHJveHlVcmwgJiYgcHJveHlVcmwuaG9zdG5hbWU7CiAgICAgIGlmICh0aGlzLl9rZWVwQWxpdmUgJiYgdXNlUHJveHkpIHsKICAgICAgICBhZ2VudCA9IHRoaXMuX3Byb3h5QWdlbnQ7CiAgICAgIH0KICAgICAgaWYgKHRoaXMuX2tlZXBBbGl2ZSAmJiAhdXNlUHJveHkpIHsKICAgICAgICBhZ2VudCA9IHRoaXMuX2FnZW50OwogICAgICB9CiAgICAgIGlmIChhZ2VudCkgewogICAgICAgIHJldHVybiBhZ2VudDsKICAgICAgfQogICAgICBjb25zdCB1c2luZ1NzbCA9IHBhcnNlZFVybC5wcm90b2NvbCA9PT0gImh0dHBzOiI7CiAgICAgIGxldCBtYXhTb2NrZXRzID0gMTAwOwogICAgICBpZiAodGhpcy5yZXF1ZXN0T3B0aW9ucykgewogICAgICAgIG1heFNvY2tldHMgPSB0aGlzLnJlcXVlc3RPcHRpb25zLm1heFNvY2tldHMgfHwgaHR0cDIuZ2xvYmFsQWdlbnQubWF4U29ja2V0czsKICAgICAgfQogICAgICBpZiAocHJveHlVcmwgJiYgcHJveHlVcmwuaG9zdG5hbWUpIHsKICAgICAgICBjb25zdCBhZ2VudE9wdGlvbnMgPSB7CiAgICAgICAgICBtYXhTb2NrZXRzLAogICAgICAgICAga2VlcEFsaXZlOiB0aGlzLl9rZWVwQWxpdmUsCiAgICAgICAgICBwcm94eTogT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHt9LCAocHJveHlVcmwudXNlcm5hbWUgfHwgcHJveHlVcmwucGFzc3dvcmQpICYmIHsKICAgICAgICAgICAgcHJveHlBdXRoOiBgJHtwcm94eVVybC51c2VybmFtZX06JHtwcm94eVVybC5wYXNzd29yZH1gCiAgICAgICAgICB9KSwgeyBob3N0OiBwcm94eVVybC5ob3N0bmFtZSwgcG9ydDogcHJveHlVcmwucG9ydCB9KQogICAgICAgIH07CiAgICAgICAgbGV0IHR1bm5lbEFnZW50OwogICAgICAgIGNvbnN0IG92ZXJIdHRwcyA9IHByb3h5VXJsLnByb3RvY29sID09PSAiaHR0cHM6IjsKICAgICAgICBpZiAodXNpbmdTc2wpIHsKICAgICAgICAgIHR1bm5lbEFnZW50ID0gb3Zlckh0dHBzID8gdHVubmVsJDEyLmh0dHBzT3Zlckh0dHBzIDogdHVubmVsJDEyLmh0dHBzT3Zlckh0dHA7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHR1bm5lbEFnZW50ID0gb3Zlckh0dHBzID8gdHVubmVsJDEyLmh0dHBPdmVySHR0cHMgOiB0dW5uZWwkMTIuaHR0cE92ZXJIdHRwOwogICAgICAgIH0KICAgICAgICBhZ2VudCA9IHR1bm5lbEFnZW50KGFnZW50T3B0aW9ucyk7CiAgICAgICAgdGhpcy5fcHJveHlBZ2VudCA9IGFnZW50OwogICAgICB9CiAgICAgIGlmICh0aGlzLl9rZWVwQWxpdmUgJiYgIWFnZW50KSB7CiAgICAgICAgY29uc3Qgb3B0aW9ucyA9IHsga2VlcEFsaXZlOiB0aGlzLl9rZWVwQWxpdmUsIG1heFNvY2tldHMgfTsKICAgICAgICBhZ2VudCA9IHVzaW5nU3NsID8gbmV3IGh0dHBzMi5BZ2VudChvcHRpb25zKSA6IG5ldyBodHRwMi5BZ2VudChvcHRpb25zKTsKICAgICAgICB0aGlzLl9hZ2VudCA9IGFnZW50OwogICAgICB9CiAgICAgIGlmICghYWdlbnQpIHsKICAgICAgICBhZ2VudCA9IHVzaW5nU3NsID8gaHR0cHMyLmdsb2JhbEFnZW50IDogaHR0cDIuZ2xvYmFsQWdlbnQ7CiAgICAgIH0KICAgICAgaWYgKHVzaW5nU3NsICYmIHRoaXMuX2lnbm9yZVNzbEVycm9yKSB7CiAgICAgICAgYWdlbnQub3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oYWdlbnQub3B0aW9ucyB8fCB7fSwgewogICAgICAgICAgcmVqZWN0VW5hdXRob3JpemVkOiBmYWxzZQogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJldHVybiBhZ2VudDsKICAgIH0KICAgIF9wZXJmb3JtRXhwb25lbnRpYWxCYWNrb2ZmKHJldHJ5TnVtYmVyKSB7CiAgICAgIHJldHVybiBfX2F3YWl0ZXIyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkgewogICAgICAgIHJldHJ5TnVtYmVyID0gTWF0aC5taW4oRXhwb25lbnRpYWxCYWNrb2ZmQ2VpbGluZywgcmV0cnlOdW1iZXIpOwogICAgICAgIGNvbnN0IG1zID0gRXhwb25lbnRpYWxCYWNrb2ZmVGltZVNsaWNlICogTWF0aC5wb3coMiwgcmV0cnlOdW1iZXIpOwogICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gc2V0VGltZW91dCgoKSA9PiByZXNvbHZlKCksIG1zKSk7CiAgICAgIH0pOwogICAgfQogICAgX3Byb2Nlc3NSZXNwb25zZShyZXMsIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIF9fYXdhaXRlcjIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7CiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IF9fYXdhaXRlcjIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7CiAgICAgICAgICBjb25zdCBzdGF0dXNDb2RlID0gcmVzLm1lc3NhZ2Uuc3RhdHVzQ29kZSB8fCAwOwogICAgICAgICAgY29uc3QgcmVzcG9uc2UgPSB7CiAgICAgICAgICAgIHN0YXR1c0NvZGUsCiAgICAgICAgICAgIHJlc3VsdDogbnVsbCwKICAgICAgICAgICAgaGVhZGVyczoge30KICAgICAgICAgIH07CiAgICAgICAgICBpZiAoc3RhdHVzQ29kZSA9PT0gSHR0cENvZGVzLk5vdEZvdW5kKSB7CiAgICAgICAgICAgIHJlc29sdmUocmVzcG9uc2UpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZGF0ZVRpbWVEZXNlcmlhbGl6ZXIoa2V5LCB2YWx1ZSkgewogICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgIGNvbnN0IGEgPSBuZXcgRGF0ZSh2YWx1ZSk7CiAgICAgICAgICAgICAgaWYgKCFpc05hTihhLnZhbHVlT2YoKSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBhOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgICBsZXQgb2JqOwogICAgICAgICAgbGV0IGNvbnRlbnRzOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29udGVudHMgPSB5aWVsZCByZXMucmVhZEJvZHkoKTsKICAgICAgICAgICAgaWYgKGNvbnRlbnRzICYmIGNvbnRlbnRzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLmRlc2VyaWFsaXplRGF0ZXMpIHsKICAgICAgICAgICAgICAgIG9iaiA9IEpTT04ucGFyc2UoY29udGVudHMsIGRhdGVUaW1lRGVzZXJpYWxpemVyKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgb2JqID0gSlNPTi5wYXJzZShjb250ZW50cyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlc3BvbnNlLnJlc3VsdCA9IG9iajsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXNwb25zZS5oZWFkZXJzID0gcmVzLm1lc3NhZ2UuaGVhZGVyczsKICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgfQogICAgICAgICAgaWYgKHN0YXR1c0NvZGUgPiAyOTkpIHsKICAgICAgICAgICAgbGV0IG1zZzsKICAgICAgICAgICAgaWYgKG9iaiAmJiBvYmoubWVzc2FnZSkgewogICAgICAgICAgICAgIG1zZyA9IG9iai5tZXNzYWdlOwogICAgICAgICAgICB9IGVsc2UgaWYgKGNvbnRlbnRzICYmIGNvbnRlbnRzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICBtc2cgPSBjb250ZW50czsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBtc2cgPSBgRmFpbGVkIHJlcXVlc3Q6ICgke3N0YXR1c0NvZGV9KWA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29uc3QgZXJyID0gbmV3IEh0dHBDbGllbnRFcnJvcihtc2csIHN0YXR1c0NvZGUpOwogICAgICAgICAgICBlcnIucmVzdWx0ID0gcmVzcG9uc2UucmVzdWx0OwogICAgICAgICAgICByZWplY3QoZXJyKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlc29sdmUocmVzcG9uc2UpOwogICAgICAgICAgfQogICAgICAgIH0pKTsKICAgICAgfSk7CiAgICB9CiAgfQogIGV4cG9ydHMuSHR0cENsaWVudCA9IEh0dHBDbGllbnQ7CiAgY29uc3QgbG93ZXJjYXNlS2V5cyA9IChvYmopID0+IE9iamVjdC5rZXlzKG9iaikucmVkdWNlKChjLCBrKSA9PiAoY1trLnRvTG93ZXJDYXNlKCldID0gb2JqW2tdLCBjKSwge30pOwp9KShsaWIpOwp2YXIgYXV0aCA9IHt9Owp2YXIgX19hd2FpdGVyID0gY29tbW9uanNHbG9iYWwgJiYgY29tbW9uanNHbG9iYWwuX19hd2FpdGVyIHx8IGZ1bmN0aW9uKHRoaXNBcmcsIF9hcmd1bWVudHMsIFAsIGdlbmVyYXRvcikgewogIGZ1bmN0aW9uIGFkb3B0KHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWUgaW5zdGFuY2VvZiBQID8gdmFsdWUgOiBuZXcgUChmdW5jdGlvbihyZXNvbHZlKSB7CiAgICAgIHJlc29sdmUodmFsdWUpOwogICAgfSk7CiAgfQogIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICBmdW5jdGlvbiBmdWxmaWxsZWQodmFsdWUpIHsKICAgICAgdHJ5IHsKICAgICAgICBzdGVwKGdlbmVyYXRvci5uZXh0KHZhbHVlKSk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICByZWplY3QoZSk7CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIHJlamVjdGVkKHZhbHVlKSB7CiAgICAgIHRyeSB7CiAgICAgICAgc3RlcChnZW5lcmF0b3JbInRocm93Il0odmFsdWUpKTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIHJlamVjdChlKTsKICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gc3RlcChyZXN1bHQpIHsKICAgICAgcmVzdWx0LmRvbmUgPyByZXNvbHZlKHJlc3VsdC52YWx1ZSkgOiBhZG9wdChyZXN1bHQudmFsdWUpLnRoZW4oZnVsZmlsbGVkLCByZWplY3RlZCk7CiAgICB9CiAgICBzdGVwKChnZW5lcmF0b3IgPSBnZW5lcmF0b3IuYXBwbHkodGhpc0FyZywgX2FyZ3VtZW50cyB8fCBbXSkpLm5leHQoKSk7CiAgfSk7Cn07Ck9iamVjdC5kZWZpbmVQcm9wZXJ0eShhdXRoLCAiX19lc01vZHVsZSIsIHsgdmFsdWU6IHRydWUgfSk7CmF1dGguUGVyc29uYWxBY2Nlc3NUb2tlbkNyZWRlbnRpYWxIYW5kbGVyID0gYXV0aC5CZWFyZXJDcmVkZW50aWFsSGFuZGxlciA9IGF1dGguQmFzaWNDcmVkZW50aWFsSGFuZGxlciA9IHZvaWQgMDsKY2xhc3MgQmFzaWNDcmVkZW50aWFsSGFuZGxlciB7CiAgY29uc3RydWN0b3IodXNlcm5hbWUsIHBhc3N3b3JkKSB7CiAgICB0aGlzLnVzZXJuYW1lID0gdXNlcm5hbWU7CiAgICB0aGlzLnBhc3N3b3JkID0gcGFzc3dvcmQ7CiAgfQogIHByZXBhcmVSZXF1ZXN0KG9wdGlvbnMpIHsKICAgIGlmICghb3B0aW9ucy5oZWFkZXJzKSB7CiAgICAgIHRocm93IEVycm9yKCJUaGUgcmVxdWVzdCBoYXMgbm8gaGVhZGVycyIpOwogICAgfQogICAgb3B0aW9ucy5oZWFkZXJzWyJBdXRob3JpemF0aW9uIl0gPSBgQmFzaWMgJHtCdWZmZXIuZnJvbShgJHt0aGlzLnVzZXJuYW1lfToke3RoaXMucGFzc3dvcmR9YCkudG9TdHJpbmcoImJhc2U2NCIpfWA7CiAgfQogIC8vIFRoaXMgaGFuZGxlciBjYW5ub3QgaGFuZGxlIDQwMQogIGNhbkhhbmRsZUF1dGhlbnRpY2F0aW9uKCkgewogICAgcmV0dXJuIGZhbHNlOwogIH0KICBoYW5kbGVBdXRoZW50aWNhdGlvbigpIHsKICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigibm90IGltcGxlbWVudGVkIik7CiAgICB9KTsKICB9Cn0KYXV0aC5CYXNpY0NyZWRlbnRpYWxIYW5kbGVyID0gQmFzaWNDcmVkZW50aWFsSGFuZGxlcjsKY2xhc3MgQmVhcmVyQ3JlZGVudGlhbEhhbmRsZXIgewogIGNvbnN0cnVjdG9yKHRva2VuKSB7CiAgICB0aGlzLnRva2VuID0gdG9rZW47CiAgfQogIC8vIGN1cnJlbnRseSBpbXBsZW1lbnRzIHByZS1hdXRob3JpemF0aW9uCiAgLy8gVE9ETzogc3VwcG9ydCBwcmVBdXRoID0gZmFsc2Ugd2hlcmUgaXQgaG9va3Mgb24gNDAxCiAgcHJlcGFyZVJlcXVlc3Qob3B0aW9ucykgewogICAgaWYgKCFvcHRpb25zLmhlYWRlcnMpIHsKICAgICAgdGhyb3cgRXJyb3IoIlRoZSByZXF1ZXN0IGhhcyBubyBoZWFkZXJzIik7CiAgICB9CiAgICBvcHRpb25zLmhlYWRlcnNbIkF1dGhvcml6YXRpb24iXSA9IGBCZWFyZXIgJHt0aGlzLnRva2VufWA7CiAgfQogIC8vIFRoaXMgaGFuZGxlciBjYW5ub3QgaGFuZGxlIDQwMQogIGNhbkhhbmRsZUF1dGhlbnRpY2F0aW9uKCkgewogICAgcmV0dXJuIGZhbHNlOwogIH0KICBoYW5kbGVBdXRoZW50aWNhdGlvbigpIHsKICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigibm90IGltcGxlbWVudGVkIik7CiAgICB9KTsKICB9Cn0KYXV0aC5CZWFyZXJDcmVkZW50aWFsSGFuZGxlciA9IEJlYXJlckNyZWRlbnRpYWxIYW5kbGVyOwpjbGFzcyBQZXJzb25hbEFjY2Vzc1Rva2VuQ3JlZGVudGlhbEhhbmRsZXIgewogIGNvbnN0cnVjdG9yKHRva2VuKSB7CiAgICB0aGlzLnRva2VuID0gdG9rZW47CiAgfQogIC8vIGN1cnJlbnRseSBpbXBsZW1lbnRzIHByZS1hdXRob3JpemF0aW9uCiAgLy8gVE9ETzogc3VwcG9ydCBwcmVBdXRoID0gZmFsc2Ugd2hlcmUgaXQgaG9va3Mgb24gNDAxCiAgcHJlcGFyZVJlcXVlc3Qob3B0aW9ucykgewogICAgaWYgKCFvcHRpb25zLmhlYWRlcnMpIHsKICAgICAgdGhyb3cgRXJyb3IoIlRoZSByZXF1ZXN0IGhhcyBubyBoZWFkZXJzIik7CiAgICB9CiAgICBvcHRpb25zLmhlYWRlcnNbIkF1dGhvcml6YXRpb24iXSA9IGBCYXNpYyAke0J1ZmZlci5mcm9tKGBQQVQ6JHt0aGlzLnRva2VufWApLnRvU3RyaW5nKCJiYXNlNjQiKX1gOwogIH0KICAvLyBUaGlzIGhhbmRsZXIgY2Fubm90IGhhbmRsZSA0MDEKICBjYW5IYW5kbGVBdXRoZW50aWNhdGlvbigpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgaGFuZGxlQXV0aGVudGljYXRpb24oKSB7CiAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIm5vdCBpbXBsZW1lbnRlZCIpOwogICAgfSk7CiAgfQp9CmF1dGguUGVyc29uYWxBY2Nlc3NUb2tlbkNyZWRlbnRpYWxIYW5kbGVyID0gUGVyc29uYWxBY2Nlc3NUb2tlbkNyZWRlbnRpYWxIYW5kbGVyOwp2YXIgaGFzUmVxdWlyZWRPaWRjVXRpbHM7CmZ1bmN0aW9uIHJlcXVpcmVPaWRjVXRpbHMoKSB7CiAgaWYgKGhhc1JlcXVpcmVkT2lkY1V0aWxzKQogICAgcmV0dXJuIG9pZGNVdGlsczsKICBoYXNSZXF1aXJlZE9pZGNVdGlscyA9IDE7CiAgdmFyIF9fYXdhaXRlcjIgPSBjb21tb25qc0dsb2JhbCAmJiBjb21tb25qc0dsb2JhbC5fX2F3YWl0ZXIgfHwgZnVuY3Rpb24odGhpc0FyZywgX2FyZ3VtZW50cywgUCwgZ2VuZXJhdG9yKSB7CiAgICBmdW5jdGlvbiBhZG9wdCh2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUgaW5zdGFuY2VvZiBQID8gdmFsdWUgOiBuZXcgUChmdW5jdGlvbihyZXNvbHZlKSB7CiAgICAgICAgcmVzb2x2ZSh2YWx1ZSk7CiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIG5ldyAoUCB8fCAoUCA9IFByb21pc2UpKShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICAgICAgZnVuY3Rpb24gZnVsZmlsbGVkKHZhbHVlKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHN0ZXAoZ2VuZXJhdG9yLm5leHQodmFsdWUpKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICByZWplY3QoZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGZ1bmN0aW9uIHJlamVjdGVkKHZhbHVlKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHN0ZXAoZ2VuZXJhdG9yWyJ0aHJvdyJdKHZhbHVlKSk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgcmVqZWN0KGUpOwogICAgICAgIH0KICAgICAgfQogICAgICBmdW5jdGlvbiBzdGVwKHJlc3VsdCkgewogICAgICAgIHJlc3VsdC5kb25lID8gcmVzb2x2ZShyZXN1bHQudmFsdWUpIDogYWRvcHQocmVzdWx0LnZhbHVlKS50aGVuKGZ1bGZpbGxlZCwgcmVqZWN0ZWQpOwogICAgICB9CiAgICAgIHN0ZXAoKGdlbmVyYXRvciA9IGdlbmVyYXRvci5hcHBseSh0aGlzQXJnLCBfYXJndW1lbnRzIHx8IFtdKSkubmV4dCgpKTsKICAgIH0pOwogIH07CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9pZGNVdGlscywgIl9fZXNNb2R1bGUiLCB7IHZhbHVlOiB0cnVlIH0pOwogIG9pZGNVdGlscy5PaWRjQ2xpZW50ID0gdm9pZCAwOwogIGNvbnN0IGh0dHBfY2xpZW50XzEgPSBsaWI7CiAgY29uc3QgYXV0aF8xID0gYXV0aDsKICBjb25zdCBjb3JlXzEgPSByZXF1aXJlQ29yZSgpOwogIGNsYXNzIE9pZGNDbGllbnQgewogICAgc3RhdGljIGNyZWF0ZUh0dHBDbGllbnQoYWxsb3dSZXRyeSA9IHRydWUsIG1heFJldHJ5ID0gMTApIHsKICAgICAgY29uc3QgcmVxdWVzdE9wdGlvbnMgPSB7CiAgICAgICAgYWxsb3dSZXRyaWVzOiBhbGxvd1JldHJ5LAogICAgICAgIG1heFJldHJpZXM6IG1heFJldHJ5CiAgICAgIH07CiAgICAgIHJldHVybiBuZXcgaHR0cF9jbGllbnRfMS5IdHRwQ2xpZW50KCJhY3Rpb25zL29pZGMtY2xpZW50IiwgW25ldyBhdXRoXzEuQmVhcmVyQ3JlZGVudGlhbEhhbmRsZXIoT2lkY0NsaWVudC5nZXRSZXF1ZXN0VG9rZW4oKSldLCByZXF1ZXN0T3B0aW9ucyk7CiAgICB9CiAgICBzdGF0aWMgZ2V0UmVxdWVzdFRva2VuKCkgewogICAgICBjb25zdCB0b2tlbiA9IHByb2Nlc3MuZW52WyJBQ1RJT05TX0lEX1RPS0VOX1JFUVVFU1RfVE9LRU4iXTsKICAgICAgaWYgKCF0b2tlbikgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5hYmxlIHRvIGdldCBBQ1RJT05TX0lEX1RPS0VOX1JFUVVFU1RfVE9LRU4gZW52IHZhcmlhYmxlIik7CiAgICAgIH0KICAgICAgcmV0dXJuIHRva2VuOwogICAgfQogICAgc3RhdGljIGdldElEVG9rZW5VcmwoKSB7CiAgICAgIGNvbnN0IHJ1bnRpbWVVcmwgPSBwcm9jZXNzLmVudlsiQUNUSU9OU19JRF9UT0tFTl9SRVFVRVNUX1VSTCJdOwogICAgICBpZiAoIXJ1bnRpbWVVcmwpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuYWJsZSB0byBnZXQgQUNUSU9OU19JRF9UT0tFTl9SRVFVRVNUX1VSTCBlbnYgdmFyaWFibGUiKTsKICAgICAgfQogICAgICByZXR1cm4gcnVudGltZVVybDsKICAgIH0KICAgIHN0YXRpYyBnZXRDYWxsKGlkX3Rva2VuX3VybCkgewogICAgICB2YXIgX2E7CiAgICAgIHJldHVybiBfX2F3YWl0ZXIyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkgewogICAgICAgIGNvbnN0IGh0dHBjbGllbnQgPSBPaWRjQ2xpZW50LmNyZWF0ZUh0dHBDbGllbnQoKTsKICAgICAgICBjb25zdCByZXMgPSB5aWVsZCBodHRwY2xpZW50LmdldEpzb24oaWRfdG9rZW5fdXJsKS5jYXRjaCgoZXJyb3IpID0+IHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRmFpbGVkIHRvIGdldCBJRCBUb2tlbi4gCiAKICAgICAgICBFcnJvciBDb2RlIDogJHtlcnJvci5zdGF0dXNDb2RlfQogCiAgICAgICAgRXJyb3IgTWVzc2FnZTogJHtlcnJvci5tZXNzYWdlfWApOwogICAgICAgIH0pOwogICAgICAgIGNvbnN0IGlkX3Rva2VuID0gKF9hID0gcmVzLnJlc3VsdCkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnZhbHVlOwogICAgICAgIGlmICghaWRfdG9rZW4pIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUmVzcG9uc2UganNvbiBib2R5IGRvIG5vdCBoYXZlIElEIFRva2VuIGZpZWxkIik7CiAgICAgICAgfQogICAgICAgIHJldHVybiBpZF90b2tlbjsKICAgICAgfSk7CiAgICB9CiAgICBzdGF0aWMgZ2V0SURUb2tlbihhdWRpZW5jZSkgewogICAgICByZXR1cm4gX19hd2FpdGVyMih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHsKICAgICAgICB0cnkgewogICAgICAgICAgbGV0IGlkX3Rva2VuX3VybCA9IE9pZGNDbGllbnQuZ2V0SURUb2tlblVybCgpOwogICAgICAgICAgaWYgKGF1ZGllbmNlKSB7CiAgICAgICAgICAgIGNvbnN0IGVuY29kZWRBdWRpZW5jZSA9IGVuY29kZVVSSUNvbXBvbmVudChhdWRpZW5jZSk7CiAgICAgICAgICAgIGlkX3Rva2VuX3VybCA9IGAke2lkX3Rva2VuX3VybH0mYXVkaWVuY2U9JHtlbmNvZGVkQXVkaWVuY2V9YDsKICAgICAgICAgIH0KICAgICAgICAgIGNvcmVfMS5kZWJ1ZyhgSUQgdG9rZW4gdXJsIGlzICR7aWRfdG9rZW5fdXJsfWApOwogICAgICAgICAgY29uc3QgaWRfdG9rZW4gPSB5aWVsZCBPaWRjQ2xpZW50LmdldENhbGwoaWRfdG9rZW5fdXJsKTsKICAgICAgICAgIGNvcmVfMS5zZXRTZWNyZXQoaWRfdG9rZW4pOwogICAgICAgICAgcmV0dXJuIGlkX3Rva2VuOwogICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEVycm9yIG1lc3NhZ2U6ICR7ZXJyb3IubWVzc2FnZX1gKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0KICBvaWRjVXRpbHMuT2lkY0NsaWVudCA9IE9pZGNDbGllbnQ7CiAgcmV0dXJuIG9pZGNVdGlsczsKfQp2YXIgc3VtbWFyeSA9IHt9Owp2YXIgaGFzUmVxdWlyZWRTdW1tYXJ5OwpmdW5jdGlvbiByZXF1aXJlU3VtbWFyeSgpIHsKICBpZiAoaGFzUmVxdWlyZWRTdW1tYXJ5KQogICAgcmV0dXJuIHN1bW1hcnk7CiAgaGFzUmVxdWlyZWRTdW1tYXJ5ID0gMTsKICAoZnVuY3Rpb24oZXhwb3J0cykgewogICAgdmFyIF9fYXdhaXRlcjIgPSBjb21tb25qc0dsb2JhbCAmJiBjb21tb25qc0dsb2JhbC5fX2F3YWl0ZXIgfHwgZnVuY3Rpb24odGhpc0FyZywgX2FyZ3VtZW50cywgUCwgZ2VuZXJhdG9yKSB7CiAgICAgIGZ1bmN0aW9uIGFkb3B0KHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlIGluc3RhbmNlb2YgUCA/IHZhbHVlIDogbmV3IFAoZnVuY3Rpb24ocmVzb2x2ZSkgewogICAgICAgICAgcmVzb2x2ZSh2YWx1ZSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgcmV0dXJuIG5ldyAoUCB8fCAoUCA9IFByb21pc2UpKShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICBmdW5jdGlvbiBmdWxmaWxsZWQodmFsdWUpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHN0ZXAoZ2VuZXJhdG9yLm5leHQodmFsdWUpKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgcmVqZWN0KGUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWplY3RlZCh2YWx1ZSkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgc3RlcChnZW5lcmF0b3JbInRocm93Il0odmFsdWUpKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgcmVqZWN0KGUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzdGVwKHJlc3VsdCkgewogICAgICAgICAgcmVzdWx0LmRvbmUgPyByZXNvbHZlKHJlc3VsdC52YWx1ZSkgOiBhZG9wdChyZXN1bHQudmFsdWUpLnRoZW4oZnVsZmlsbGVkLCByZWplY3RlZCk7CiAgICAgICAgfQogICAgICAgIHN0ZXAoKGdlbmVyYXRvciA9IGdlbmVyYXRvci5hcHBseSh0aGlzQXJnLCBfYXJndW1lbnRzIHx8IFtdKSkubmV4dCgpKTsKICAgICAgfSk7CiAgICB9OwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsKICAgIGV4cG9ydHMuc3VtbWFyeSA9IGV4cG9ydHMubWFya2Rvd25TdW1tYXJ5ID0gZXhwb3J0cy5TVU1NQVJZX0RPQ1NfVVJMID0gZXhwb3J0cy5TVU1NQVJZX0VOVl9WQVIgPSB2b2lkIDA7CiAgICBjb25zdCBvc18xID0gcmVxdWlyZSQkMCQxOwogICAgY29uc3QgZnNfMSA9IHJlcXVpcmUkJDBfX2RlZmF1bHQ7CiAgICBjb25zdCB7IGFjY2VzcywgYXBwZW5kRmlsZSwgd3JpdGVGaWxlIH0gPSBmc18xLnByb21pc2VzOwogICAgZXhwb3J0cy5TVU1NQVJZX0VOVl9WQVIgPSAiR0lUSFVCX1NURVBfU1VNTUFSWSI7CiAgICBleHBvcnRzLlNVTU1BUllfRE9DU19VUkwgPSAiaHR0cHM6Ly9kb2NzLmdpdGh1Yi5jb20vYWN0aW9ucy91c2luZy13b3JrZmxvd3Mvd29ya2Zsb3ctY29tbWFuZHMtZm9yLWdpdGh1Yi1hY3Rpb25zI2FkZGluZy1hLWpvYi1zdW1tYXJ5IjsKICAgIGNsYXNzIFN1bW1hcnkgewogICAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgICB0aGlzLl9idWZmZXIgPSAiIjsKICAgICAgfQogICAgICAvKioKICAgICAgICogRmluZHMgdGhlIHN1bW1hcnkgZmlsZSBwYXRoIGZyb20gdGhlIGVudmlyb25tZW50LCByZWplY3RzIGlmIGVudiB2YXIgaXMgbm90IGZvdW5kIG9yIGZpbGUgZG9lcyBub3QgZXhpc3QKICAgICAgICogQWxzbyBjaGVja3Mgci93IHBlcm1pc3Npb25zLgogICAgICAgKgogICAgICAgKiBAcmV0dXJucyBzdGVwIHN1bW1hcnkgZmlsZSBwYXRoCiAgICAgICAqLwogICAgICBmaWxlUGF0aCgpIHsKICAgICAgICByZXR1cm4gX19hd2FpdGVyMih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHsKICAgICAgICAgIGlmICh0aGlzLl9maWxlUGF0aCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fZmlsZVBhdGg7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBwYXRoRnJvbUVudiA9IHByb2Nlc3MuZW52W2V4cG9ydHMuU1VNTUFSWV9FTlZfVkFSXTsKICAgICAgICAgIGlmICghcGF0aEZyb21FbnYpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmFibGUgdG8gZmluZCBlbnZpcm9ubWVudCB2YXJpYWJsZSBmb3IgJCR7ZXhwb3J0cy5TVU1NQVJZX0VOVl9WQVJ9LiBDaGVjayBpZiB5b3VyIHJ1bnRpbWUgZW52aXJvbm1lbnQgc3VwcG9ydHMgam9iIHN1bW1hcmllcy5gKTsKICAgICAgICAgIH0KICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHlpZWxkIGFjY2VzcyhwYXRoRnJvbUVudiwgZnNfMS5jb25zdGFudHMuUl9PSyB8IGZzXzEuY29uc3RhbnRzLldfT0spOwogICAgICAgICAgfSBjYXRjaCAoX2EpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmFibGUgdG8gYWNjZXNzIHN1bW1hcnkgZmlsZTogJyR7cGF0aEZyb21FbnZ9Jy4gQ2hlY2sgaWYgdGhlIGZpbGUgaGFzIGNvcnJlY3QgcmVhZC93cml0ZSBwZXJtaXNzaW9ucy5gKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuX2ZpbGVQYXRoID0gcGF0aEZyb21FbnY7CiAgICAgICAgICByZXR1cm4gdGhpcy5fZmlsZVBhdGg7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgLyoqCiAgICAgICAqIFdyYXBzIGNvbnRlbnQgaW4gYW4gSFRNTCB0YWcsIGFkZGluZyBhbnkgSFRNTCBhdHRyaWJ1dGVzCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSB0YWcgSFRNTCB0YWcgdG8gd3JhcAogICAgICAgKiBAcGFyYW0ge3N0cmluZyB8IG51bGx9IGNvbnRlbnQgY29udGVudCB3aXRoaW4gdGhlIHRhZwogICAgICAgKiBAcGFyYW0ge1thdHRyaWJ1dGU6IHN0cmluZ106IHN0cmluZ30gYXR0cnMga2V5LXZhbHVlIGxpc3Qgb2YgSFRNTCBhdHRyaWJ1dGVzIHRvIGFkZAogICAgICAgKgogICAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBjb250ZW50IHdyYXBwZWQgaW4gSFRNTCBlbGVtZW50CiAgICAgICAqLwogICAgICB3cmFwKHRhZywgY29udGVudCwgYXR0cnMgPSB7fSkgewogICAgICAgIGNvbnN0IGh0bWxBdHRycyA9IE9iamVjdC5lbnRyaWVzKGF0dHJzKS5tYXAoKFtrZXksIHZhbHVlXSkgPT4gYCAke2tleX09IiR7dmFsdWV9ImApLmpvaW4oIiIpOwogICAgICAgIGlmICghY29udGVudCkgewogICAgICAgICAgcmV0dXJuIGA8JHt0YWd9JHtodG1sQXR0cnN9PmA7CiAgICAgICAgfQogICAgICAgIHJldHVybiBgPCR7dGFnfSR7aHRtbEF0dHJzfT4ke2NvbnRlbnR9PC8ke3RhZ30+YDsKICAgICAgfQogICAgICAvKioKICAgICAgICogV3JpdGVzIHRleHQgaW4gdGhlIGJ1ZmZlciB0byB0aGUgc3VtbWFyeSBidWZmZXIgZmlsZSBhbmQgZW1wdGllcyBidWZmZXIuIFdpbGwgYXBwZW5kIGJ5IGRlZmF1bHQuCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7U3VtbWFyeVdyaXRlT3B0aW9uc30gW29wdGlvbnNdIChvcHRpb25hbCkgb3B0aW9ucyBmb3Igd3JpdGUgb3BlcmF0aW9uCiAgICAgICAqCiAgICAgICAqIEByZXR1cm5zIHtQcm9taXNlPFN1bW1hcnk+fSBzdW1tYXJ5IGluc3RhbmNlCiAgICAgICAqLwogICAgICB3cml0ZShvcHRpb25zKSB7CiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcjIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7CiAgICAgICAgICBjb25zdCBvdmVyd3JpdGUgPSAhIShvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMub3ZlcndyaXRlKTsKICAgICAgICAgIGNvbnN0IGZpbGVQYXRoID0geWllbGQgdGhpcy5maWxlUGF0aCgpOwogICAgICAgICAgY29uc3Qgd3JpdGVGdW5jID0gb3ZlcndyaXRlID8gd3JpdGVGaWxlIDogYXBwZW5kRmlsZTsKICAgICAgICAgIHlpZWxkIHdyaXRlRnVuYyhmaWxlUGF0aCwgdGhpcy5fYnVmZmVyLCB7IGVuY29kaW5nOiAidXRmOCIgfSk7CiAgICAgICAgICByZXR1cm4gdGhpcy5lbXB0eUJ1ZmZlcigpOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIC8qKgogICAgICAgKiBDbGVhcnMgdGhlIHN1bW1hcnkgYnVmZmVyIGFuZCB3aXBlcyB0aGUgc3VtbWFyeSBmaWxlCiAgICAgICAqCiAgICAgICAqIEByZXR1cm5zIHtTdW1tYXJ5fSBzdW1tYXJ5IGluc3RhbmNlCiAgICAgICAqLwogICAgICBjbGVhcigpIHsKICAgICAgICByZXR1cm4gX19hd2FpdGVyMih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHsKICAgICAgICAgIHJldHVybiB0aGlzLmVtcHR5QnVmZmVyKCkud3JpdGUoeyBvdmVyd3JpdGU6IHRydWUgfSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgLyoqCiAgICAgICAqIFJldHVybnMgdGhlIGN1cnJlbnQgc3VtbWFyeSBidWZmZXIgYXMgYSBzdHJpbmcKICAgICAgICoKICAgICAgICogQHJldHVybnMge3N0cmluZ30gc3RyaW5nIG9mIHN1bW1hcnkgYnVmZmVyCiAgICAgICAqLwogICAgICBzdHJpbmdpZnkoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2J1ZmZlcjsKICAgICAgfQogICAgICAvKioKICAgICAgICogSWYgdGhlIHN1bW1hcnkgYnVmZmVyIGlzIGVtcHR5CiAgICAgICAqCiAgICAgICAqIEByZXR1cm5zIHtib29sZW59IHRydWUgaWYgdGhlIGJ1ZmZlciBpcyBlbXB0eQogICAgICAgKi8KICAgICAgaXNFbXB0eUJ1ZmZlcigpIHsKICAgICAgICByZXR1cm4gdGhpcy5fYnVmZmVyLmxlbmd0aCA9PT0gMDsKICAgICAgfQogICAgICAvKioKICAgICAgICogUmVzZXRzIHRoZSBzdW1tYXJ5IGJ1ZmZlciB3aXRob3V0IHdyaXRpbmcgdG8gc3VtbWFyeSBmaWxlCiAgICAgICAqCiAgICAgICAqIEByZXR1cm5zIHtTdW1tYXJ5fSBzdW1tYXJ5IGluc3RhbmNlCiAgICAgICAqLwogICAgICBlbXB0eUJ1ZmZlcigpIHsKICAgICAgICB0aGlzLl9idWZmZXIgPSAiIjsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQogICAgICAvKioKICAgICAgICogQWRkcyByYXcgdGV4dCB0byB0aGUgc3VtbWFyeSBidWZmZXIKICAgICAgICoKICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHRleHQgY29udGVudCB0byBhZGQKICAgICAgICogQHBhcmFtIHtib29sZWFufSBbYWRkRU9MPWZhbHNlXSAob3B0aW9uYWwpIGFwcGVuZCBhbiBFT0wgdG8gdGhlIHJhdyB0ZXh0IChkZWZhdWx0OiBmYWxzZSkKICAgICAgICoKICAgICAgICogQHJldHVybnMge1N1bW1hcnl9IHN1bW1hcnkgaW5zdGFuY2UKICAgICAgICovCiAgICAgIGFkZFJhdyh0ZXh0LCBhZGRFT0wgPSBmYWxzZSkgewogICAgICAgIHRoaXMuX2J1ZmZlciArPSB0ZXh0OwogICAgICAgIHJldHVybiBhZGRFT0wgPyB0aGlzLmFkZEVPTCgpIDogdGhpczsKICAgICAgfQogICAgICAvKioKICAgICAgICogQWRkcyB0aGUgb3BlcmF0aW5nIHN5c3RlbS1zcGVjaWZpYyBlbmQtb2YtbGluZSBtYXJrZXIgdG8gdGhlIGJ1ZmZlcgogICAgICAgKgogICAgICAgKiBAcmV0dXJucyB7U3VtbWFyeX0gc3VtbWFyeSBpbnN0YW5jZQogICAgICAgKi8KICAgICAgYWRkRU9MKCkgewogICAgICAgIHJldHVybiB0aGlzLmFkZFJhdyhvc18xLkVPTCk7CiAgICAgIH0KICAgICAgLyoqCiAgICAgICAqIEFkZHMgYW4gSFRNTCBjb2RlYmxvY2sgdG8gdGhlIHN1bW1hcnkgYnVmZmVyCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBjb2RlIGNvbnRlbnQgdG8gcmVuZGVyIHdpdGhpbiBmZW5jZWQgY29kZSBibG9jawogICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbGFuZyAob3B0aW9uYWwpIGxhbmd1YWdlIHRvIHN5bnRheCBoaWdobGlnaHQgY29kZQogICAgICAgKgogICAgICAgKiBAcmV0dXJucyB7U3VtbWFyeX0gc3VtbWFyeSBpbnN0YW5jZQogICAgICAgKi8KICAgICAgYWRkQ29kZUJsb2NrKGNvZGUsIGxhbmcpIHsKICAgICAgICBjb25zdCBhdHRycyA9IE9iamVjdC5hc3NpZ24oe30sIGxhbmcgJiYgeyBsYW5nIH0pOwogICAgICAgIGNvbnN0IGVsZW1lbnQgPSB0aGlzLndyYXAoInByZSIsIHRoaXMud3JhcCgiY29kZSIsIGNvZGUpLCBhdHRycyk7CiAgICAgICAgcmV0dXJuIHRoaXMuYWRkUmF3KGVsZW1lbnQpLmFkZEVPTCgpOwogICAgICB9CiAgICAgIC8qKgogICAgICAgKiBBZGRzIGFuIEhUTUwgbGlzdCB0byB0aGUgc3VtbWFyeSBidWZmZXIKICAgICAgICoKICAgICAgICogQHBhcmFtIHtzdHJpbmdbXX0gaXRlbXMgbGlzdCBvZiBpdGVtcyB0byByZW5kZXIKICAgICAgICogQHBhcmFtIHtib29sZWFufSBbb3JkZXJlZD1mYWxzZV0gKG9wdGlvbmFsKSBpZiB0aGUgcmVuZGVyZWQgbGlzdCBzaG91bGQgYmUgb3JkZXJlZCBvciBub3QgKGRlZmF1bHQ6IGZhbHNlKQogICAgICAgKgogICAgICAgKiBAcmV0dXJucyB7U3VtbWFyeX0gc3VtbWFyeSBpbnN0YW5jZQogICAgICAgKi8KICAgICAgYWRkTGlzdChpdGVtcywgb3JkZXJlZCA9IGZhbHNlKSB7CiAgICAgICAgY29uc3QgdGFnID0gb3JkZXJlZCA/ICJvbCIgOiAidWwiOwogICAgICAgIGNvbnN0IGxpc3RJdGVtcyA9IGl0ZW1zLm1hcCgoaXRlbSkgPT4gdGhpcy53cmFwKCJsaSIsIGl0ZW0pKS5qb2luKCIiKTsKICAgICAgICBjb25zdCBlbGVtZW50ID0gdGhpcy53cmFwKHRhZywgbGlzdEl0ZW1zKTsKICAgICAgICByZXR1cm4gdGhpcy5hZGRSYXcoZWxlbWVudCkuYWRkRU9MKCk7CiAgICAgIH0KICAgICAgLyoqCiAgICAgICAqIEFkZHMgYW4gSFRNTCB0YWJsZSB0byB0aGUgc3VtbWFyeSBidWZmZXIKICAgICAgICoKICAgICAgICogQHBhcmFtIHtTdW1tYXJ5VGFibGVDZWxsW119IHJvd3MgdGFibGUgcm93cwogICAgICAgKgogICAgICAgKiBAcmV0dXJucyB7U3VtbWFyeX0gc3VtbWFyeSBpbnN0YW5jZQogICAgICAgKi8KICAgICAgYWRkVGFibGUocm93cykgewogICAgICAgIGNvbnN0IHRhYmxlQm9keSA9IHJvd3MubWFwKChyb3cpID0+IHsKICAgICAgICAgIGNvbnN0IGNlbGxzID0gcm93Lm1hcCgoY2VsbCkgPT4gewogICAgICAgICAgICBpZiAodHlwZW9mIGNlbGwgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMud3JhcCgidGQiLCBjZWxsKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb25zdCB7IGhlYWRlciwgZGF0YSwgY29sc3Bhbiwgcm93c3BhbiB9ID0gY2VsbDsKICAgICAgICAgICAgY29uc3QgdGFnID0gaGVhZGVyID8gInRoIiA6ICJ0ZCI7CiAgICAgICAgICAgIGNvbnN0IGF0dHJzID0gT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHt9LCBjb2xzcGFuICYmIHsgY29sc3BhbiB9KSwgcm93c3BhbiAmJiB7IHJvd3NwYW4gfSk7CiAgICAgICAgICAgIHJldHVybiB0aGlzLndyYXAodGFnLCBkYXRhLCBhdHRycyk7CiAgICAgICAgICB9KS5qb2luKCIiKTsKICAgICAgICAgIHJldHVybiB0aGlzLndyYXAoInRyIiwgY2VsbHMpOwogICAgICAgIH0pLmpvaW4oIiIpOwogICAgICAgIGNvbnN0IGVsZW1lbnQgPSB0aGlzLndyYXAoInRhYmxlIiwgdGFibGVCb2R5KTsKICAgICAgICByZXR1cm4gdGhpcy5hZGRSYXcoZWxlbWVudCkuYWRkRU9MKCk7CiAgICAgIH0KICAgICAgLyoqCiAgICAgICAqIEFkZHMgYSBjb2xsYXBzYWJsZSBIVE1MIGRldGFpbHMgZWxlbWVudCB0byB0aGUgc3VtbWFyeSBidWZmZXIKICAgICAgICoKICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGxhYmVsIHRleHQgZm9yIHRoZSBjbG9zZWQgc3RhdGUKICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGNvbnRlbnQgY29sbGFwc2FibGUgY29udGVudAogICAgICAgKgogICAgICAgKiBAcmV0dXJucyB7U3VtbWFyeX0gc3VtbWFyeSBpbnN0YW5jZQogICAgICAgKi8KICAgICAgYWRkRGV0YWlscyhsYWJlbCwgY29udGVudCkgewogICAgICAgIGNvbnN0IGVsZW1lbnQgPSB0aGlzLndyYXAoImRldGFpbHMiLCB0aGlzLndyYXAoInN1bW1hcnkiLCBsYWJlbCkgKyBjb250ZW50KTsKICAgICAgICByZXR1cm4gdGhpcy5hZGRSYXcoZWxlbWVudCkuYWRkRU9MKCk7CiAgICAgIH0KICAgICAgLyoqCiAgICAgICAqIEFkZHMgYW4gSFRNTCBpbWFnZSB0YWcgdG8gdGhlIHN1bW1hcnkgYnVmZmVyCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBzcmMgcGF0aCB0byB0aGUgaW1hZ2UgeW91IHRvIGVtYmVkCiAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBhbHQgdGV4dCBkZXNjcmlwdGlvbiBvZiB0aGUgaW1hZ2UKICAgICAgICogQHBhcmFtIHtTdW1tYXJ5SW1hZ2VPcHRpb25zfSBvcHRpb25zIChvcHRpb25hbCkgYWRkaXRpb24gaW1hZ2UgYXR0cmlidXRlcwogICAgICAgKgogICAgICAgKiBAcmV0dXJucyB7U3VtbWFyeX0gc3VtbWFyeSBpbnN0YW5jZQogICAgICAgKi8KICAgICAgYWRkSW1hZ2Uoc3JjLCBhbHQsIG9wdGlvbnMpIHsKICAgICAgICBjb25zdCB7IHdpZHRoLCBoZWlnaHQgfSA9IG9wdGlvbnMgfHwge307CiAgICAgICAgY29uc3QgYXR0cnMgPSBPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oe30sIHdpZHRoICYmIHsgd2lkdGggfSksIGhlaWdodCAmJiB7IGhlaWdodCB9KTsKICAgICAgICBjb25zdCBlbGVtZW50ID0gdGhpcy53cmFwKCJpbWciLCBudWxsLCBPYmplY3QuYXNzaWduKHsgc3JjLCBhbHQgfSwgYXR0cnMpKTsKICAgICAgICByZXR1cm4gdGhpcy5hZGRSYXcoZWxlbWVudCkuYWRkRU9MKCk7CiAgICAgIH0KICAgICAgLyoqCiAgICAgICAqIEFkZHMgYW4gSFRNTCBzZWN0aW9uIGhlYWRpbmcgZWxlbWVudAogICAgICAgKgogICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdGV4dCBoZWFkaW5nIHRleHQKICAgICAgICogQHBhcmFtIHtudW1iZXIgfCBzdHJpbmd9IFtsZXZlbD0xXSAob3B0aW9uYWwpIHRoZSBoZWFkaW5nIGxldmVsLCBkZWZhdWx0OiAxCiAgICAgICAqCiAgICAgICAqIEByZXR1cm5zIHtTdW1tYXJ5fSBzdW1tYXJ5IGluc3RhbmNlCiAgICAgICAqLwogICAgICBhZGRIZWFkaW5nKHRleHQsIGxldmVsKSB7CiAgICAgICAgY29uc3QgdGFnID0gYGgke2xldmVsfWA7CiAgICAgICAgY29uc3QgYWxsb3dlZFRhZyA9IFsiaDEiLCAiaDIiLCAiaDMiLCAiaDQiLCAiaDUiLCAiaDYiXS5pbmNsdWRlcyh0YWcpID8gdGFnIDogImgxIjsKICAgICAgICBjb25zdCBlbGVtZW50ID0gdGhpcy53cmFwKGFsbG93ZWRUYWcsIHRleHQpOwogICAgICAgIHJldHVybiB0aGlzLmFkZFJhdyhlbGVtZW50KS5hZGRFT0woKTsKICAgICAgfQogICAgICAvKioKICAgICAgICogQWRkcyBhbiBIVE1MIHRoZW1hdGljIGJyZWFrICg8aHI+KSB0byB0aGUgc3VtbWFyeSBidWZmZXIKICAgICAgICoKICAgICAgICogQHJldHVybnMge1N1bW1hcnl9IHN1bW1hcnkgaW5zdGFuY2UKICAgICAgICovCiAgICAgIGFkZFNlcGFyYXRvcigpIHsKICAgICAgICBjb25zdCBlbGVtZW50ID0gdGhpcy53cmFwKCJociIsIG51bGwpOwogICAgICAgIHJldHVybiB0aGlzLmFkZFJhdyhlbGVtZW50KS5hZGRFT0woKTsKICAgICAgfQogICAgICAvKioKICAgICAgICogQWRkcyBhbiBIVE1MIGxpbmUgYnJlYWsgKDxicj4pIHRvIHRoZSBzdW1tYXJ5IGJ1ZmZlcgogICAgICAgKgogICAgICAgKiBAcmV0dXJucyB7U3VtbWFyeX0gc3VtbWFyeSBpbnN0YW5jZQogICAgICAgKi8KICAgICAgYWRkQnJlYWsoKSB7CiAgICAgICAgY29uc3QgZWxlbWVudCA9IHRoaXMud3JhcCgiYnIiLCBudWxsKTsKICAgICAgICByZXR1cm4gdGhpcy5hZGRSYXcoZWxlbWVudCkuYWRkRU9MKCk7CiAgICAgIH0KICAgICAgLyoqCiAgICAgICAqIEFkZHMgYW4gSFRNTCBibG9ja3F1b3RlIHRvIHRoZSBzdW1tYXJ5IGJ1ZmZlcgogICAgICAgKgogICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdGV4dCBxdW90ZSB0ZXh0CiAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBjaXRlIChvcHRpb25hbCkgY2l0YXRpb24gdXJsCiAgICAgICAqCiAgICAgICAqIEByZXR1cm5zIHtTdW1tYXJ5fSBzdW1tYXJ5IGluc3RhbmNlCiAgICAgICAqLwogICAgICBhZGRRdW90ZSh0ZXh0LCBjaXRlKSB7CiAgICAgICAgY29uc3QgYXR0cnMgPSBPYmplY3QuYXNzaWduKHt9LCBjaXRlICYmIHsgY2l0ZSB9KTsKICAgICAgICBjb25zdCBlbGVtZW50ID0gdGhpcy53cmFwKCJibG9ja3F1b3RlIiwgdGV4dCwgYXR0cnMpOwogICAgICAgIHJldHVybiB0aGlzLmFkZFJhdyhlbGVtZW50KS5hZGRFT0woKTsKICAgICAgfQogICAgICAvKioKICAgICAgICogQWRkcyBhbiBIVE1MIGFuY2hvciB0YWcgdG8gdGhlIHN1bW1hcnkgYnVmZmVyCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSB0ZXh0IGxpbmsgdGV4dC9jb250ZW50CiAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBocmVmIGh5cGVybGluawogICAgICAgKgogICAgICAgKiBAcmV0dXJucyB7U3VtbWFyeX0gc3VtbWFyeSBpbnN0YW5jZQogICAgICAgKi8KICAgICAgYWRkTGluayh0ZXh0LCBocmVmKSB7CiAgICAgICAgY29uc3QgZWxlbWVudCA9IHRoaXMud3JhcCgiYSIsIHRleHQsIHsgaHJlZiB9KTsKICAgICAgICByZXR1cm4gdGhpcy5hZGRSYXcoZWxlbWVudCkuYWRkRU9MKCk7CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IF9zdW1tYXJ5ID0gbmV3IFN1bW1hcnkoKTsKICAgIGV4cG9ydHMubWFya2Rvd25TdW1tYXJ5ID0gX3N1bW1hcnk7CiAgICBleHBvcnRzLnN1bW1hcnkgPSBfc3VtbWFyeTsKICB9KShzdW1tYXJ5KTsKICByZXR1cm4gc3VtbWFyeTsKfQp2YXIgcGF0aFV0aWxzID0ge307CnZhciBoYXNSZXF1aXJlZFBhdGhVdGlsczsKZnVuY3Rpb24gcmVxdWlyZVBhdGhVdGlscygpIHsKICBpZiAoaGFzUmVxdWlyZWRQYXRoVXRpbHMpCiAgICByZXR1cm4gcGF0aFV0aWxzOwogIGhhc1JlcXVpcmVkUGF0aFV0aWxzID0gMTsKICB2YXIgX19jcmVhdGVCaW5kaW5nMiA9IGNvbW1vbmpzR2xvYmFsICYmIGNvbW1vbmpzR2xvYmFsLl9fY3JlYXRlQmluZGluZyB8fCAoT2JqZWN0LmNyZWF0ZSA/IGZ1bmN0aW9uKG8sIG0sIGssIGsyKSB7CiAgICBpZiAoazIgPT09IHZvaWQgMCkKICAgICAgazIgPSBrOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG8sIGsyLCB7IGVudW1lcmFibGU6IHRydWUsIGdldDogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBtW2tdOwogICAgfSB9KTsKICB9IDogZnVuY3Rpb24obywgbSwgaywgazIpIHsKICAgIGlmIChrMiA9PT0gdm9pZCAwKQogICAgICBrMiA9IGs7CiAgICBvW2syXSA9IG1ba107CiAgfSk7CiAgdmFyIF9fc2V0TW9kdWxlRGVmYXVsdDIgPSBjb21tb25qc0dsb2JhbCAmJiBjb21tb25qc0dsb2JhbC5fX3NldE1vZHVsZURlZmF1bHQgfHwgKE9iamVjdC5jcmVhdGUgPyBmdW5jdGlvbihvLCB2KSB7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkobywgImRlZmF1bHQiLCB7IGVudW1lcmFibGU6IHRydWUsIHZhbHVlOiB2IH0pOwogIH0gOiBmdW5jdGlvbihvLCB2KSB7CiAgICBvWyJkZWZhdWx0Il0gPSB2OwogIH0pOwogIHZhciBfX2ltcG9ydFN0YXIyID0gY29tbW9uanNHbG9iYWwgJiYgY29tbW9uanNHbG9iYWwuX19pbXBvcnRTdGFyIHx8IGZ1bmN0aW9uKG1vZCkgewogICAgaWYgKG1vZCAmJiBtb2QuX19lc01vZHVsZSkKICAgICAgcmV0dXJuIG1vZDsKICAgIHZhciByZXN1bHQgPSB7fTsKICAgIGlmIChtb2QgIT0gbnVsbCkgewogICAgICBmb3IgKHZhciBrIGluIG1vZCkKICAgICAgICBpZiAoayAhPT0gImRlZmF1bHQiICYmIE9iamVjdC5oYXNPd25Qcm9wZXJ0eS5jYWxsKG1vZCwgaykpCiAgICAgICAgICBfX2NyZWF0ZUJpbmRpbmcyKHJlc3VsdCwgbW9kLCBrKTsKICAgIH0KICAgIF9fc2V0TW9kdWxlRGVmYXVsdDIocmVzdWx0LCBtb2QpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9OwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShwYXRoVXRpbHMsICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsKICBwYXRoVXRpbHMudG9QbGF0Zm9ybVBhdGggPSBwYXRoVXRpbHMudG9XaW4zMlBhdGggPSBwYXRoVXRpbHMudG9Qb3NpeFBhdGggPSB2b2lkIDA7CiAgY29uc3QgcGF0aDIgPSBfX2ltcG9ydFN0YXIyKHJlcXVpcmUkJDAkMik7CiAgZnVuY3Rpb24gdG9Qb3NpeFBhdGgocHRoKSB7CiAgICByZXR1cm4gcHRoLnJlcGxhY2UoL1tcXF0vZywgIi8iKTsKICB9CiAgcGF0aFV0aWxzLnRvUG9zaXhQYXRoID0gdG9Qb3NpeFBhdGg7CiAgZnVuY3Rpb24gdG9XaW4zMlBhdGgocHRoKSB7CiAgICByZXR1cm4gcHRoLnJlcGxhY2UoL1svXS9nLCAiXFwiKTsKICB9CiAgcGF0aFV0aWxzLnRvV2luMzJQYXRoID0gdG9XaW4zMlBhdGg7CiAgZnVuY3Rpb24gdG9QbGF0Zm9ybVBhdGgocHRoKSB7CiAgICByZXR1cm4gcHRoLnJlcGxhY2UoL1svXFxdL2csIHBhdGgyLnNlcCk7CiAgfQogIHBhdGhVdGlscy50b1BsYXRmb3JtUGF0aCA9IHRvUGxhdGZvcm1QYXRoOwogIHJldHVybiBwYXRoVXRpbHM7Cn0KdmFyIGhhc1JlcXVpcmVkQ29yZTsKZnVuY3Rpb24gcmVxdWlyZUNvcmUoKSB7CiAgaWYgKGhhc1JlcXVpcmVkQ29yZSkKICAgIHJldHVybiBjb3JlJDE7CiAgaGFzUmVxdWlyZWRDb3JlID0gMTsKICAoZnVuY3Rpb24oZXhwb3J0cykgewogICAgdmFyIF9fY3JlYXRlQmluZGluZzIgPSBjb21tb25qc0dsb2JhbCAmJiBjb21tb25qc0dsb2JhbC5fX2NyZWF0ZUJpbmRpbmcgfHwgKE9iamVjdC5jcmVhdGUgPyBmdW5jdGlvbihvLCBtLCBrLCBrMikgewogICAgICBpZiAoazIgPT09IHZvaWQgMCkKICAgICAgICBrMiA9IGs7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvLCBrMiwgeyBlbnVtZXJhYmxlOiB0cnVlLCBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBtW2tdOwogICAgICB9IH0pOwogICAgfSA6IGZ1bmN0aW9uKG8sIG0sIGssIGsyKSB7CiAgICAgIGlmIChrMiA9PT0gdm9pZCAwKQogICAgICAgIGsyID0gazsKICAgICAgb1trMl0gPSBtW2tdOwogICAgfSk7CiAgICB2YXIgX19zZXRNb2R1bGVEZWZhdWx0MiA9IGNvbW1vbmpzR2xvYmFsICYmIGNvbW1vbmpzR2xvYmFsLl9fc2V0TW9kdWxlRGVmYXVsdCB8fCAoT2JqZWN0LmNyZWF0ZSA/IGZ1bmN0aW9uKG8sIHYpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG8sICJkZWZhdWx0IiwgeyBlbnVtZXJhYmxlOiB0cnVlLCB2YWx1ZTogdiB9KTsKICAgIH0gOiBmdW5jdGlvbihvLCB2KSB7CiAgICAgIG9bImRlZmF1bHQiXSA9IHY7CiAgICB9KTsKICAgIHZhciBfX2ltcG9ydFN0YXIyID0gY29tbW9uanNHbG9iYWwgJiYgY29tbW9uanNHbG9iYWwuX19pbXBvcnRTdGFyIHx8IGZ1bmN0aW9uKG1vZCkgewogICAgICBpZiAobW9kICYmIG1vZC5fX2VzTW9kdWxlKQogICAgICAgIHJldHVybiBtb2Q7CiAgICAgIHZhciByZXN1bHQgPSB7fTsKICAgICAgaWYgKG1vZCAhPSBudWxsKSB7CiAgICAgICAgZm9yICh2YXIgayBpbiBtb2QpCiAgICAgICAgICBpZiAoayAhPT0gImRlZmF1bHQiICYmIE9iamVjdC5oYXNPd25Qcm9wZXJ0eS5jYWxsKG1vZCwgaykpCiAgICAgICAgICAgIF9fY3JlYXRlQmluZGluZzIocmVzdWx0LCBtb2QsIGspOwogICAgICB9CiAgICAgIF9fc2V0TW9kdWxlRGVmYXVsdDIocmVzdWx0LCBtb2QpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICAgIHZhciBfX2F3YWl0ZXIyID0gY29tbW9uanNHbG9iYWwgJiYgY29tbW9uanNHbG9iYWwuX19hd2FpdGVyIHx8IGZ1bmN0aW9uKHRoaXNBcmcsIF9hcmd1bWVudHMsIFAsIGdlbmVyYXRvcikgewogICAgICBmdW5jdGlvbiBhZG9wdCh2YWx1ZSkgewogICAgICAgIHJldHVybiB2YWx1ZSBpbnN0YW5jZW9mIFAgPyB2YWx1ZSA6IG5ldyBQKGZ1bmN0aW9uKHJlc29sdmUpIHsKICAgICAgICAgIHJlc29sdmUodmFsdWUpOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgZnVuY3Rpb24gZnVsZmlsbGVkKHZhbHVlKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBzdGVwKGdlbmVyYXRvci5uZXh0KHZhbHVlKSk7CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIHJlamVjdChlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVqZWN0ZWQodmFsdWUpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHN0ZXAoZ2VuZXJhdG9yWyJ0aHJvdyJdKHZhbHVlKSk7CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIHJlamVjdChlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3RlcChyZXN1bHQpIHsKICAgICAgICAgIHJlc3VsdC5kb25lID8gcmVzb2x2ZShyZXN1bHQudmFsdWUpIDogYWRvcHQocmVzdWx0LnZhbHVlKS50aGVuKGZ1bGZpbGxlZCwgcmVqZWN0ZWQpOwogICAgICAgIH0KICAgICAgICBzdGVwKChnZW5lcmF0b3IgPSBnZW5lcmF0b3IuYXBwbHkodGhpc0FyZywgX2FyZ3VtZW50cyB8fCBbXSkpLm5leHQoKSk7CiAgICAgIH0pOwogICAgfTsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsgdmFsdWU6IHRydWUgfSk7CiAgICBleHBvcnRzLmdldElEVG9rZW4gPSBleHBvcnRzLmdldFN0YXRlID0gZXhwb3J0cy5zYXZlU3RhdGUgPSBleHBvcnRzLmdyb3VwID0gZXhwb3J0cy5lbmRHcm91cCA9IGV4cG9ydHMuc3RhcnRHcm91cCA9IGV4cG9ydHMuaW5mbyA9IGV4cG9ydHMubm90aWNlID0gZXhwb3J0cy53YXJuaW5nID0gZXhwb3J0cy5lcnJvciA9IGV4cG9ydHMuZGVidWcgPSBleHBvcnRzLmlzRGVidWcgPSBleHBvcnRzLnNldEZhaWxlZCA9IGV4cG9ydHMuc2V0Q29tbWFuZEVjaG8gPSBleHBvcnRzLnNldE91dHB1dCA9IGV4cG9ydHMuZ2V0Qm9vbGVhbklucHV0ID0gZXhwb3J0cy5nZXRNdWx0aWxpbmVJbnB1dCA9IGV4cG9ydHMuZ2V0SW5wdXQgPSBleHBvcnRzLmFkZFBhdGggPSBleHBvcnRzLnNldFNlY3JldCA9IGV4cG9ydHMuZXhwb3J0VmFyaWFibGUgPSBleHBvcnRzLkV4aXRDb2RlID0gdm9pZCAwOwogICAgY29uc3QgY29tbWFuZF8xID0gY29tbWFuZDsKICAgIGNvbnN0IGZpbGVfY29tbWFuZF8xID0gZmlsZUNvbW1hbmQ7CiAgICBjb25zdCB1dGlsc18xMiA9IHV0aWxzOwogICAgY29uc3Qgb3MyID0gX19pbXBvcnRTdGFyMihyZXF1aXJlJCQwJDEpOwogICAgY29uc3QgcGF0aDIgPSBfX2ltcG9ydFN0YXIyKHJlcXVpcmUkJDAkMik7CiAgICBjb25zdCBvaWRjX3V0aWxzXzEgPSByZXF1aXJlT2lkY1V0aWxzKCk7CiAgICB2YXIgRXhpdENvZGU7CiAgICAoZnVuY3Rpb24oRXhpdENvZGUyKSB7CiAgICAgIEV4aXRDb2RlMltFeGl0Q29kZTJbIlN1Y2Nlc3MiXSA9IDBdID0gIlN1Y2Nlc3MiOwogICAgICBFeGl0Q29kZTJbRXhpdENvZGUyWyJGYWlsdXJlIl0gPSAxXSA9ICJGYWlsdXJlIjsKICAgIH0pKEV4aXRDb2RlID0gZXhwb3J0cy5FeGl0Q29kZSB8fCAoZXhwb3J0cy5FeGl0Q29kZSA9IHt9KSk7CiAgICBmdW5jdGlvbiBleHBvcnRWYXJpYWJsZShuYW1lLCB2YWwpIHsKICAgICAgY29uc3QgY29udmVydGVkVmFsID0gdXRpbHNfMTIudG9Db21tYW5kVmFsdWUodmFsKTsKICAgICAgcHJvY2Vzcy5lbnZbbmFtZV0gPSBjb252ZXJ0ZWRWYWw7CiAgICAgIGNvbnN0IGZpbGVQYXRoID0gcHJvY2Vzcy5lbnZbIkdJVEhVQl9FTlYiXSB8fCAiIjsKICAgICAgaWYgKGZpbGVQYXRoKSB7CiAgICAgICAgcmV0dXJuIGZpbGVfY29tbWFuZF8xLmlzc3VlRmlsZUNvbW1hbmQoIkVOViIsIGZpbGVfY29tbWFuZF8xLnByZXBhcmVLZXlWYWx1ZU1lc3NhZ2UobmFtZSwgdmFsKSk7CiAgICAgIH0KICAgICAgY29tbWFuZF8xLmlzc3VlQ29tbWFuZCgic2V0LWVudiIsIHsgbmFtZSB9LCBjb252ZXJ0ZWRWYWwpOwogICAgfQogICAgZXhwb3J0cy5leHBvcnRWYXJpYWJsZSA9IGV4cG9ydFZhcmlhYmxlOwogICAgZnVuY3Rpb24gc2V0U2VjcmV0KHNlY3JldCkgewogICAgICBjb21tYW5kXzEuaXNzdWVDb21tYW5kKCJhZGQtbWFzayIsIHt9LCBzZWNyZXQpOwogICAgfQogICAgZXhwb3J0cy5zZXRTZWNyZXQgPSBzZXRTZWNyZXQ7CiAgICBmdW5jdGlvbiBhZGRQYXRoKGlucHV0UGF0aCkgewogICAgICBjb25zdCBmaWxlUGF0aCA9IHByb2Nlc3MuZW52WyJHSVRIVUJfUEFUSCJdIHx8ICIiOwogICAgICBpZiAoZmlsZVBhdGgpIHsKICAgICAgICBmaWxlX2NvbW1hbmRfMS5pc3N1ZUZpbGVDb21tYW5kKCJQQVRIIiwgaW5wdXRQYXRoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb21tYW5kXzEuaXNzdWVDb21tYW5kKCJhZGQtcGF0aCIsIHt9LCBpbnB1dFBhdGgpOwogICAgICB9CiAgICAgIHByb2Nlc3MuZW52WyJQQVRIIl0gPSBgJHtpbnB1dFBhdGh9JHtwYXRoMi5kZWxpbWl0ZXJ9JHtwcm9jZXNzLmVudlsiUEFUSCJdfWA7CiAgICB9CiAgICBleHBvcnRzLmFkZFBhdGggPSBhZGRQYXRoOwogICAgZnVuY3Rpb24gZ2V0SW5wdXQyKG5hbWUsIG9wdGlvbnMpIHsKICAgICAgY29uc3QgdmFsID0gcHJvY2Vzcy5lbnZbYElOUFVUXyR7bmFtZS5yZXBsYWNlKC8gL2csICJfIikudG9VcHBlckNhc2UoKX1gXSB8fCAiIjsKICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5yZXF1aXJlZCAmJiAhdmFsKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnB1dCByZXF1aXJlZCBhbmQgbm90IHN1cHBsaWVkOiAke25hbWV9YCk7CiAgICAgIH0KICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy50cmltV2hpdGVzcGFjZSA9PT0gZmFsc2UpIHsKICAgICAgICByZXR1cm4gdmFsOwogICAgICB9CiAgICAgIHJldHVybiB2YWwudHJpbSgpOwogICAgfQogICAgZXhwb3J0cy5nZXRJbnB1dCA9IGdldElucHV0MjsKICAgIGZ1bmN0aW9uIGdldE11bHRpbGluZUlucHV0KG5hbWUsIG9wdGlvbnMpIHsKICAgICAgY29uc3QgaW5wdXRzID0gZ2V0SW5wdXQyKG5hbWUsIG9wdGlvbnMpLnNwbGl0KCJcbiIpLmZpbHRlcigoeCkgPT4geCAhPT0gIiIpOwogICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLnRyaW1XaGl0ZXNwYWNlID09PSBmYWxzZSkgewogICAgICAgIHJldHVybiBpbnB1dHM7CiAgICAgIH0KICAgICAgcmV0dXJuIGlucHV0cy5tYXAoKGlucHV0KSA9PiBpbnB1dC50cmltKCkpOwogICAgfQogICAgZXhwb3J0cy5nZXRNdWx0aWxpbmVJbnB1dCA9IGdldE11bHRpbGluZUlucHV0OwogICAgZnVuY3Rpb24gZ2V0Qm9vbGVhbklucHV0KG5hbWUsIG9wdGlvbnMpIHsKICAgICAgY29uc3QgdHJ1ZVZhbHVlID0gWyJ0cnVlIiwgIlRydWUiLCAiVFJVRSJdOwogICAgICBjb25zdCBmYWxzZVZhbHVlID0gWyJmYWxzZSIsICJGYWxzZSIsICJGQUxTRSJdOwogICAgICBjb25zdCB2YWwgPSBnZXRJbnB1dDIobmFtZSwgb3B0aW9ucyk7CiAgICAgIGlmICh0cnVlVmFsdWUuaW5jbHVkZXModmFsKSkKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgaWYgKGZhbHNlVmFsdWUuaW5jbHVkZXModmFsKSkKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoYElucHV0IGRvZXMgbm90IG1lZXQgWUFNTCAxLjIgIkNvcmUgU2NoZW1hIiBzcGVjaWZpY2F0aW9uOiAke25hbWV9ClN1cHBvcnQgYm9vbGVhbiBpbnB1dCBsaXN0OiBcYHRydWUgfCBUcnVlIHwgVFJVRSB8IGZhbHNlIHwgRmFsc2UgfCBGQUxTRVxgYCk7CiAgICB9CiAgICBleHBvcnRzLmdldEJvb2xlYW5JbnB1dCA9IGdldEJvb2xlYW5JbnB1dDsKICAgIGZ1bmN0aW9uIHNldE91dHB1dChuYW1lLCB2YWx1ZSkgewogICAgICBjb25zdCBmaWxlUGF0aCA9IHByb2Nlc3MuZW52WyJHSVRIVUJfT1VUUFVUIl0gfHwgIiI7CiAgICAgIGlmIChmaWxlUGF0aCkgewogICAgICAgIHJldHVybiBmaWxlX2NvbW1hbmRfMS5pc3N1ZUZpbGVDb21tYW5kKCJPVVRQVVQiLCBmaWxlX2NvbW1hbmRfMS5wcmVwYXJlS2V5VmFsdWVNZXNzYWdlKG5hbWUsIHZhbHVlKSk7CiAgICAgIH0KICAgICAgcHJvY2Vzcy5zdGRvdXQud3JpdGUob3MyLkVPTCk7CiAgICAgIGNvbW1hbmRfMS5pc3N1ZUNvbW1hbmQoInNldC1vdXRwdXQiLCB7IG5hbWUgfSwgdXRpbHNfMTIudG9Db21tYW5kVmFsdWUodmFsdWUpKTsKICAgIH0KICAgIGV4cG9ydHMuc2V0T3V0cHV0ID0gc2V0T3V0cHV0OwogICAgZnVuY3Rpb24gc2V0Q29tbWFuZEVjaG8oZW5hYmxlZCkgewogICAgICBjb21tYW5kXzEuaXNzdWUoImVjaG8iLCBlbmFibGVkID8gIm9uIiA6ICJvZmYiKTsKICAgIH0KICAgIGV4cG9ydHMuc2V0Q29tbWFuZEVjaG8gPSBzZXRDb21tYW5kRWNobzsKICAgIGZ1bmN0aW9uIHNldEZhaWxlZChtZXNzYWdlKSB7CiAgICAgIHByb2Nlc3MuZXhpdENvZGUgPSBFeGl0Q29kZS5GYWlsdXJlOwogICAgICBlcnJvcihtZXNzYWdlKTsKICAgIH0KICAgIGV4cG9ydHMuc2V0RmFpbGVkID0gc2V0RmFpbGVkOwogICAgZnVuY3Rpb24gaXNEZWJ1ZygpIHsKICAgICAgcmV0dXJuIHByb2Nlc3MuZW52WyJSVU5ORVJfREVCVUciXSA9PT0gIjEiOwogICAgfQogICAgZXhwb3J0cy5pc0RlYnVnID0gaXNEZWJ1ZzsKICAgIGZ1bmN0aW9uIGRlYnVnMihtZXNzYWdlKSB7CiAgICAgIGNvbW1hbmRfMS5pc3N1ZUNvbW1hbmQoImRlYnVnIiwge30sIG1lc3NhZ2UpOwogICAgfQogICAgZXhwb3J0cy5kZWJ1ZyA9IGRlYnVnMjsKICAgIGZ1bmN0aW9uIGVycm9yKG1lc3NhZ2UsIHByb3BlcnRpZXMgPSB7fSkgewogICAgICBjb21tYW5kXzEuaXNzdWVDb21tYW5kKCJlcnJvciIsIHV0aWxzXzEyLnRvQ29tbWFuZFByb3BlcnRpZXMocHJvcGVydGllcyksIG1lc3NhZ2UgaW5zdGFuY2VvZiBFcnJvciA/IG1lc3NhZ2UudG9TdHJpbmcoKSA6IG1lc3NhZ2UpOwogICAgfQogICAgZXhwb3J0cy5lcnJvciA9IGVycm9yOwogICAgZnVuY3Rpb24gd2FybmluZyhtZXNzYWdlLCBwcm9wZXJ0aWVzID0ge30pIHsKICAgICAgY29tbWFuZF8xLmlzc3VlQ29tbWFuZCgid2FybmluZyIsIHV0aWxzXzEyLnRvQ29tbWFuZFByb3BlcnRpZXMocHJvcGVydGllcyksIG1lc3NhZ2UgaW5zdGFuY2VvZiBFcnJvciA/IG1lc3NhZ2UudG9TdHJpbmcoKSA6IG1lc3NhZ2UpOwogICAgfQogICAgZXhwb3J0cy53YXJuaW5nID0gd2FybmluZzsKICAgIGZ1bmN0aW9uIG5vdGljZShtZXNzYWdlLCBwcm9wZXJ0aWVzID0ge30pIHsKICAgICAgY29tbWFuZF8xLmlzc3VlQ29tbWFuZCgibm90aWNlIiwgdXRpbHNfMTIudG9Db21tYW5kUHJvcGVydGllcyhwcm9wZXJ0aWVzKSwgbWVzc2FnZSBpbnN0YW5jZW9mIEVycm9yID8gbWVzc2FnZS50b1N0cmluZygpIDogbWVzc2FnZSk7CiAgICB9CiAgICBleHBvcnRzLm5vdGljZSA9IG5vdGljZTsKICAgIGZ1bmN0aW9uIGluZm8obWVzc2FnZSkgewogICAgICBwcm9jZXNzLnN0ZG91dC53cml0ZShtZXNzYWdlICsgb3MyLkVPTCk7CiAgICB9CiAgICBleHBvcnRzLmluZm8gPSBpbmZvOwogICAgZnVuY3Rpb24gc3RhcnRHcm91cChuYW1lKSB7CiAgICAgIGNvbW1hbmRfMS5pc3N1ZSgiZ3JvdXAiLCBuYW1lKTsKICAgIH0KICAgIGV4cG9ydHMuc3RhcnRHcm91cCA9IHN0YXJ0R3JvdXA7CiAgICBmdW5jdGlvbiBlbmRHcm91cCgpIHsKICAgICAgY29tbWFuZF8xLmlzc3VlKCJlbmRncm91cCIpOwogICAgfQogICAgZXhwb3J0cy5lbmRHcm91cCA9IGVuZEdyb3VwOwogICAgZnVuY3Rpb24gZ3JvdXAobmFtZSwgZm4pIHsKICAgICAgcmV0dXJuIF9fYXdhaXRlcjIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7CiAgICAgICAgc3RhcnRHcm91cChuYW1lKTsKICAgICAgICBsZXQgcmVzdWx0OwogICAgICAgIHRyeSB7CiAgICAgICAgICByZXN1bHQgPSB5aWVsZCBmbigpOwogICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICBlbmRHcm91cCgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9KTsKICAgIH0KICAgIGV4cG9ydHMuZ3JvdXAgPSBncm91cDsKICAgIGZ1bmN0aW9uIHNhdmVTdGF0ZShuYW1lLCB2YWx1ZSkgewogICAgICBjb25zdCBmaWxlUGF0aCA9IHByb2Nlc3MuZW52WyJHSVRIVUJfU1RBVEUiXSB8fCAiIjsKICAgICAgaWYgKGZpbGVQYXRoKSB7CiAgICAgICAgcmV0dXJuIGZpbGVfY29tbWFuZF8xLmlzc3VlRmlsZUNvbW1hbmQoIlNUQVRFIiwgZmlsZV9jb21tYW5kXzEucHJlcGFyZUtleVZhbHVlTWVzc2FnZShuYW1lLCB2YWx1ZSkpOwogICAgICB9CiAgICAgIGNvbW1hbmRfMS5pc3N1ZUNvbW1hbmQoInNhdmUtc3RhdGUiLCB7IG5hbWUgfSwgdXRpbHNfMTIudG9Db21tYW5kVmFsdWUodmFsdWUpKTsKICAgIH0KICAgIGV4cG9ydHMuc2F2ZVN0YXRlID0gc2F2ZVN0YXRlOwogICAgZnVuY3Rpb24gZ2V0U3RhdGUobmFtZSkgewogICAgICByZXR1cm4gcHJvY2Vzcy5lbnZbYFNUQVRFXyR7bmFtZX1gXSB8fCAiIjsKICAgIH0KICAgIGV4cG9ydHMuZ2V0U3RhdGUgPSBnZXRTdGF0ZTsKICAgIGZ1bmN0aW9uIGdldElEVG9rZW4oYXVkKSB7CiAgICAgIHJldHVybiBfX2F3YWl0ZXIyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkgewogICAgICAgIHJldHVybiB5aWVsZCBvaWRjX3V0aWxzXzEuT2lkY0NsaWVudC5nZXRJRFRva2VuKGF1ZCk7CiAgICAgIH0pOwogICAgfQogICAgZXhwb3J0cy5nZXRJRFRva2VuID0gZ2V0SURUb2tlbjsKICAgIHZhciBzdW1tYXJ5XzEgPSByZXF1aXJlU3VtbWFyeSgpOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJzdW1tYXJ5IiwgeyBlbnVtZXJhYmxlOiB0cnVlLCBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gc3VtbWFyeV8xLnN1bW1hcnk7CiAgICB9IH0pOwogICAgdmFyIHN1bW1hcnlfMiA9IHJlcXVpcmVTdW1tYXJ5KCk7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIm1hcmtkb3duU3VtbWFyeSIsIHsgZW51bWVyYWJsZTogdHJ1ZSwgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHN1bW1hcnlfMi5tYXJrZG93blN1bW1hcnk7CiAgICB9IH0pOwogICAgdmFyIHBhdGhfdXRpbHNfMSA9IHJlcXVpcmVQYXRoVXRpbHMoKTsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAidG9Qb3NpeFBhdGgiLCB7IGVudW1lcmFibGU6IHRydWUsIGdldDogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBwYXRoX3V0aWxzXzEudG9Qb3NpeFBhdGg7CiAgICB9IH0pOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJ0b1dpbjMyUGF0aCIsIHsgZW51bWVyYWJsZTogdHJ1ZSwgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHBhdGhfdXRpbHNfMS50b1dpbjMyUGF0aDsKICAgIH0gfSk7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgInRvUGxhdGZvcm1QYXRoIiwgeyBlbnVtZXJhYmxlOiB0cnVlLCBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gcGF0aF91dGlsc18xLnRvUGxhdGZvcm1QYXRoOwogICAgfSB9KTsKICB9KShjb3JlJDEpOwogIHJldHVybiBjb3JlJDE7Cn0KdmFyIGNvcmVFeHBvcnRzID0gcmVxdWlyZUNvcmUoKTsKdmFyIGNyb3NzU3Bhd24kMSA9IHsgZXhwb3J0czoge30gfTsKdmFyIHdpbmRvd3M7CnZhciBoYXNSZXF1aXJlZFdpbmRvd3M7CmZ1bmN0aW9uIHJlcXVpcmVXaW5kb3dzKCkgewogIGlmIChoYXNSZXF1aXJlZFdpbmRvd3MpCiAgICByZXR1cm4gd2luZG93czsKICBoYXNSZXF1aXJlZFdpbmRvd3MgPSAxOwogIHdpbmRvd3MgPSBpc2V4ZTI7CiAgaXNleGUyLnN5bmMgPSBzeW5jMjsKICB2YXIgZnMyID0gcmVxdWlyZSQkMF9fZGVmYXVsdDsKICBmdW5jdGlvbiBjaGVja1BhdGhFeHQocGF0aDIsIG9wdGlvbnMpIHsKICAgIHZhciBwYXRoZXh0ID0gb3B0aW9ucy5wYXRoRXh0ICE9PSB2b2lkIDAgPyBvcHRpb25zLnBhdGhFeHQgOiBwcm9jZXNzLmVudi5QQVRIRVhUOwogICAgaWYgKCFwYXRoZXh0KSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgcGF0aGV4dCA9IHBhdGhleHQuc3BsaXQoIjsiKTsKICAgIGlmIChwYXRoZXh0LmluZGV4T2YoIiIpICE9PSAtMSkgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcGF0aGV4dC5sZW5ndGg7IGkrKykgewogICAgICB2YXIgcCA9IHBhdGhleHRbaV0udG9Mb3dlckNhc2UoKTsKICAgICAgaWYgKHAgJiYgcGF0aDIuc3Vic3RyKC1wLmxlbmd0aCkudG9Mb3dlckNhc2UoKSA9PT0gcCkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIGZ1bmN0aW9uIGNoZWNrU3RhdChzdGF0LCBwYXRoMiwgb3B0aW9ucykgewogICAgaWYgKCFzdGF0LmlzU3ltYm9saWNMaW5rKCkgJiYgIXN0YXQuaXNGaWxlKCkpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgcmV0dXJuIGNoZWNrUGF0aEV4dChwYXRoMiwgb3B0aW9ucyk7CiAgfQogIGZ1bmN0aW9uIGlzZXhlMihwYXRoMiwgb3B0aW9ucywgY2IpIHsKICAgIGZzMi5zdGF0KHBhdGgyLCBmdW5jdGlvbihlciwgc3RhdCkgewogICAgICBjYihlciwgZXIgPyBmYWxzZSA6IGNoZWNrU3RhdChzdGF0LCBwYXRoMiwgb3B0aW9ucykpOwogICAgfSk7CiAgfQogIGZ1bmN0aW9uIHN5bmMyKHBhdGgyLCBvcHRpb25zKSB7CiAgICByZXR1cm4gY2hlY2tTdGF0KGZzMi5zdGF0U3luYyhwYXRoMiksIHBhdGgyLCBvcHRpb25zKTsKICB9CiAgcmV0dXJuIHdpbmRvd3M7Cn0KdmFyIG1vZGU7CnZhciBoYXNSZXF1aXJlZE1vZGU7CmZ1bmN0aW9uIHJlcXVpcmVNb2RlKCkgewogIGlmIChoYXNSZXF1aXJlZE1vZGUpCiAgICByZXR1cm4gbW9kZTsKICBoYXNSZXF1aXJlZE1vZGUgPSAxOwogIG1vZGUgPSBpc2V4ZTI7CiAgaXNleGUyLnN5bmMgPSBzeW5jMjsKICB2YXIgZnMyID0gcmVxdWlyZSQkMF9fZGVmYXVsdDsKICBmdW5jdGlvbiBpc2V4ZTIocGF0aDIsIG9wdGlvbnMsIGNiKSB7CiAgICBmczIuc3RhdChwYXRoMiwgZnVuY3Rpb24oZXIsIHN0YXQpIHsKICAgICAgY2IoZXIsIGVyID8gZmFsc2UgOiBjaGVja1N0YXQoc3RhdCwgb3B0aW9ucykpOwogICAgfSk7CiAgfQogIGZ1bmN0aW9uIHN5bmMyKHBhdGgyLCBvcHRpb25zKSB7CiAgICByZXR1cm4gY2hlY2tTdGF0KGZzMi5zdGF0U3luYyhwYXRoMiksIG9wdGlvbnMpOwogIH0KICBmdW5jdGlvbiBjaGVja1N0YXQoc3RhdCwgb3B0aW9ucykgewogICAgcmV0dXJuIHN0YXQuaXNGaWxlKCkgJiYgY2hlY2tNb2RlKHN0YXQsIG9wdGlvbnMpOwogIH0KICBmdW5jdGlvbiBjaGVja01vZGUoc3RhdCwgb3B0aW9ucykgewogICAgdmFyIG1vZCA9IHN0YXQubW9kZTsKICAgIHZhciB1aWQgPSBzdGF0LnVpZDsKICAgIHZhciBnaWQgPSBzdGF0LmdpZDsKICAgIHZhciBteVVpZCA9IG9wdGlvbnMudWlkICE9PSB2b2lkIDAgPyBvcHRpb25zLnVpZCA6IHByb2Nlc3MuZ2V0dWlkICYmIHByb2Nlc3MuZ2V0dWlkKCk7CiAgICB2YXIgbXlHaWQgPSBvcHRpb25zLmdpZCAhPT0gdm9pZCAwID8gb3B0aW9ucy5naWQgOiBwcm9jZXNzLmdldGdpZCAmJiBwcm9jZXNzLmdldGdpZCgpOwogICAgdmFyIHUgPSBwYXJzZUludCgiMTAwIiwgOCk7CiAgICB2YXIgZyA9IHBhcnNlSW50KCIwMTAiLCA4KTsKICAgIHZhciBvID0gcGFyc2VJbnQoIjAwMSIsIDgpOwogICAgdmFyIHVnID0gdSB8IGc7CiAgICB2YXIgcmV0ID0gbW9kICYgbyB8fCBtb2QgJiBnICYmIGdpZCA9PT0gbXlHaWQgfHwgbW9kICYgdSAmJiB1aWQgPT09IG15VWlkIHx8IG1vZCAmIHVnICYmIG15VWlkID09PSAwOwogICAgcmV0dXJuIHJldDsKICB9CiAgcmV0dXJuIG1vZGU7Cn0KdmFyIGNvcmU7CmlmIChwcm9jZXNzLnBsYXRmb3JtID09PSAid2luMzIiIHx8IGNvbW1vbmpzR2xvYmFsLlRFU1RJTkdfV0lORE9XUykgewogIGNvcmUgPSByZXF1aXJlV2luZG93cygpOwp9IGVsc2UgewogIGNvcmUgPSByZXF1aXJlTW9kZSgpOwp9CnZhciBpc2V4ZV8xID0gaXNleGUkMTsKaXNleGUkMS5zeW5jID0gc3luYyQxOwpmdW5jdGlvbiBpc2V4ZSQxKHBhdGgyLCBvcHRpb25zLCBjYikgewogIGlmICh0eXBlb2Ygb3B0aW9ucyA9PT0gImZ1bmN0aW9uIikgewogICAgY2IgPSBvcHRpb25zOwogICAgb3B0aW9ucyA9IHt9OwogIH0KICBpZiAoIWNiKSB7CiAgICBpZiAodHlwZW9mIFByb21pc2UgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiY2FsbGJhY2sgbm90IHByb3ZpZGVkIik7CiAgICB9CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIGlzZXhlJDEocGF0aDIsIG9wdGlvbnMgfHwge30sIGZ1bmN0aW9uKGVyLCBpcykgewogICAgICAgIGlmIChlcikgewogICAgICAgICAgcmVqZWN0KGVyKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVzb2x2ZShpcyk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0pOwogIH0KICBjb3JlKHBhdGgyLCBvcHRpb25zIHx8IHt9LCBmdW5jdGlvbihlciwgaXMpIHsKICAgIGlmIChlcikgewogICAgICBpZiAoZXIuY29kZSA9PT0gIkVBQ0NFUyIgfHwgb3B0aW9ucyAmJiBvcHRpb25zLmlnbm9yZUVycm9ycykgewogICAgICAgIGVyID0gbnVsbDsKICAgICAgICBpcyA9IGZhbHNlOwogICAgICB9CiAgICB9CiAgICBjYihlciwgaXMpOwogIH0pOwp9CmZ1bmN0aW9uIHN5bmMkMShwYXRoMiwgb3B0aW9ucykgewogIHRyeSB7CiAgICByZXR1cm4gY29yZS5zeW5jKHBhdGgyLCBvcHRpb25zIHx8IHt9KTsKICB9IGNhdGNoIChlcikgewogICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5pZ25vcmVFcnJvcnMgfHwgZXIuY29kZSA9PT0gIkVBQ0NFUyIpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSBlbHNlIHsKICAgICAgdGhyb3cgZXI7CiAgICB9CiAgfQp9CmNvbnN0IGlzV2luZG93cyA9IHByb2Nlc3MucGxhdGZvcm0gPT09ICJ3aW4zMiIgfHwgcHJvY2Vzcy5lbnYuT1NUWVBFID09PSAiY3lnd2luIiB8fCBwcm9jZXNzLmVudi5PU1RZUEUgPT09ICJtc3lzIjsKY29uc3QgcGF0aCQzID0gcmVxdWlyZSQkMCQyOwpjb25zdCBDT0xPTiA9IGlzV2luZG93cyA/ICI7IiA6ICI6IjsKY29uc3QgaXNleGUgPSBpc2V4ZV8xOwpjb25zdCBnZXROb3RGb3VuZEVycm9yID0gKGNtZCkgPT4gT2JqZWN0LmFzc2lnbihuZXcgRXJyb3IoYG5vdCBmb3VuZDogJHtjbWR9YCksIHsgY29kZTogIkVOT0VOVCIgfSk7CmNvbnN0IGdldFBhdGhJbmZvID0gKGNtZCwgb3B0KSA9PiB7CiAgY29uc3QgY29sb24gPSBvcHQuY29sb24gfHwgQ09MT047CiAgY29uc3QgcGF0aEVudiA9IGNtZC5tYXRjaCgvXC8vKSB8fCBpc1dpbmRvd3MgJiYgY21kLm1hdGNoKC9cXC8pID8gWyIiXSA6IFsKICAgIC8vIHdpbmRvd3MgYWx3YXlzIGNoZWNrcyB0aGUgY3dkIGZpcnN0CiAgICAuLi5pc1dpbmRvd3MgPyBbcHJvY2Vzcy5jd2QoKV0gOiBbXSwKICAgIC4uLihvcHQucGF0aCB8fCBwcm9jZXNzLmVudi5QQVRIIHx8IC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0OiB2ZXJ5IHVudXN1YWwgKi8KICAgICIiKS5zcGxpdChjb2xvbikKICBdOwogIGNvbnN0IHBhdGhFeHRFeGUgPSBpc1dpbmRvd3MgPyBvcHQucGF0aEV4dCB8fCBwcm9jZXNzLmVudi5QQVRIRVhUIHx8ICIuRVhFOy5DTUQ7LkJBVDsuQ09NIiA6ICIiOwogIGNvbnN0IHBhdGhFeHQgPSBpc1dpbmRvd3MgPyBwYXRoRXh0RXhlLnNwbGl0KGNvbG9uKSA6IFsiIl07CiAgaWYgKGlzV2luZG93cykgewogICAgaWYgKGNtZC5pbmRleE9mKCIuIikgIT09IC0xICYmIHBhdGhFeHRbMF0gIT09ICIiKQogICAgICBwYXRoRXh0LnVuc2hpZnQoIiIpOwogIH0KICByZXR1cm4gewogICAgcGF0aEVudiwKICAgIHBhdGhFeHQsCiAgICBwYXRoRXh0RXhlCiAgfTsKfTsKY29uc3Qgd2hpY2gkMSA9IChjbWQsIG9wdCwgY2IpID0+IHsKICBpZiAodHlwZW9mIG9wdCA9PT0gImZ1bmN0aW9uIikgewogICAgY2IgPSBvcHQ7CiAgICBvcHQgPSB7fTsKICB9CiAgaWYgKCFvcHQpCiAgICBvcHQgPSB7fTsKICBjb25zdCB7IHBhdGhFbnYsIHBhdGhFeHQsIHBhdGhFeHRFeGUgfSA9IGdldFBhdGhJbmZvKGNtZCwgb3B0KTsKICBjb25zdCBmb3VuZCA9IFtdOwogIGNvbnN0IHN0ZXAgPSAoaSkgPT4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgaWYgKGkgPT09IHBhdGhFbnYubGVuZ3RoKQogICAgICByZXR1cm4gb3B0LmFsbCAmJiBmb3VuZC5sZW5ndGggPyByZXNvbHZlKGZvdW5kKSA6IHJlamVjdChnZXROb3RGb3VuZEVycm9yKGNtZCkpOwogICAgY29uc3QgcHBSYXcgPSBwYXRoRW52W2ldOwogICAgY29uc3QgcGF0aFBhcnQgPSAvXiIuKiIkLy50ZXN0KHBwUmF3KSA/IHBwUmF3LnNsaWNlKDEsIC0xKSA6IHBwUmF3OwogICAgY29uc3QgcENtZCA9IHBhdGgkMy5qb2luKHBhdGhQYXJ0LCBjbWQpOwogICAgY29uc3QgcCA9ICFwYXRoUGFydCAmJiAvXlwuW1xcXC9dLy50ZXN0KGNtZCkgPyBjbWQuc2xpY2UoMCwgMikgKyBwQ21kIDogcENtZDsKICAgIHJlc29sdmUoc3ViU3RlcChwLCBpLCAwKSk7CiAgfSk7CiAgY29uc3Qgc3ViU3RlcCA9IChwLCBpLCBpaSkgPT4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgaWYgKGlpID09PSBwYXRoRXh0Lmxlbmd0aCkKICAgICAgcmV0dXJuIHJlc29sdmUoc3RlcChpICsgMSkpOwogICAgY29uc3QgZXh0MiA9IHBhdGhFeHRbaWldOwogICAgaXNleGUocCArIGV4dDIsIHsgcGF0aEV4dDogcGF0aEV4dEV4ZSB9LCAoZXIsIGlzKSA9PiB7CiAgICAgIGlmICghZXIgJiYgaXMpIHsKICAgICAgICBpZiAob3B0LmFsbCkKICAgICAgICAgIGZvdW5kLnB1c2gocCArIGV4dDIpOwogICAgICAgIGVsc2UKICAgICAgICAgIHJldHVybiByZXNvbHZlKHAgKyBleHQyKTsKICAgICAgfQogICAgICByZXR1cm4gcmVzb2x2ZShzdWJTdGVwKHAsIGksIGlpICsgMSkpOwogICAgfSk7CiAgfSk7CiAgcmV0dXJuIGNiID8gc3RlcCgwKS50aGVuKChyZXMpID0+IGNiKG51bGwsIHJlcyksIGNiKSA6IHN0ZXAoMCk7Cn07CmNvbnN0IHdoaWNoU3luYyA9IChjbWQsIG9wdCkgPT4gewogIG9wdCA9IG9wdCB8fCB7fTsKICBjb25zdCB7IHBhdGhFbnYsIHBhdGhFeHQsIHBhdGhFeHRFeGUgfSA9IGdldFBhdGhJbmZvKGNtZCwgb3B0KTsKICBjb25zdCBmb3VuZCA9IFtdOwogIGZvciAobGV0IGkgPSAwOyBpIDwgcGF0aEVudi5sZW5ndGg7IGkrKykgewogICAgY29uc3QgcHBSYXcgPSBwYXRoRW52W2ldOwogICAgY29uc3QgcGF0aFBhcnQgPSAvXiIuKiIkLy50ZXN0KHBwUmF3KSA/IHBwUmF3LnNsaWNlKDEsIC0xKSA6IHBwUmF3OwogICAgY29uc3QgcENtZCA9IHBhdGgkMy5qb2luKHBhdGhQYXJ0LCBjbWQpOwogICAgY29uc3QgcCA9ICFwYXRoUGFydCAmJiAvXlwuW1xcXC9dLy50ZXN0KGNtZCkgPyBjbWQuc2xpY2UoMCwgMikgKyBwQ21kIDogcENtZDsKICAgIGZvciAobGV0IGogPSAwOyBqIDwgcGF0aEV4dC5sZW5ndGg7IGorKykgewogICAgICBjb25zdCBjdXIgPSBwICsgcGF0aEV4dFtqXTsKICAgICAgdHJ5IHsKICAgICAgICBjb25zdCBpcyA9IGlzZXhlLnN5bmMoY3VyLCB7IHBhdGhFeHQ6IHBhdGhFeHRFeGUgfSk7CiAgICAgICAgaWYgKGlzKSB7CiAgICAgICAgICBpZiAob3B0LmFsbCkKICAgICAgICAgICAgZm91bmQucHVzaChjdXIpOwogICAgICAgICAgZWxzZQogICAgICAgICAgICByZXR1cm4gY3VyOwogICAgICAgIH0KICAgICAgfSBjYXRjaCAoZXgpIHsKICAgICAgfQogICAgfQogIH0KICBpZiAob3B0LmFsbCAmJiBmb3VuZC5sZW5ndGgpCiAgICByZXR1cm4gZm91bmQ7CiAgaWYgKG9wdC5ub3Rocm93KQogICAgcmV0dXJuIG51bGw7CiAgdGhyb3cgZ2V0Tm90Rm91bmRFcnJvcihjbWQpOwp9Owp2YXIgd2hpY2hfMSA9IHdoaWNoJDE7CndoaWNoJDEuc3luYyA9IHdoaWNoU3luYzsKdmFyIHBhdGhLZXkkMiA9IHsgZXhwb3J0czoge30gfTsKY29uc3QgcGF0aEtleSQxID0gKG9wdGlvbnMgPSB7fSkgPT4gewogIGNvbnN0IGVudmlyb25tZW50ID0gb3B0aW9ucy5lbnYgfHwgcHJvY2Vzcy5lbnY7CiAgY29uc3QgcGxhdGZvcm0gPSBvcHRpb25zLnBsYXRmb3JtIHx8IHByb2Nlc3MucGxhdGZvcm07CiAgaWYgKHBsYXRmb3JtICE9PSAid2luMzIiKSB7CiAgICByZXR1cm4gIlBBVEgiOwogIH0KICByZXR1cm4gT2JqZWN0LmtleXMoZW52aXJvbm1lbnQpLnJldmVyc2UoKS5maW5kKChrZXkpID0+IGtleS50b1VwcGVyQ2FzZSgpID09PSAiUEFUSCIpIHx8ICJQYXRoIjsKfTsKcGF0aEtleSQyLmV4cG9ydHMgPSBwYXRoS2V5JDE7CnBhdGhLZXkkMi5leHBvcnRzLmRlZmF1bHQgPSBwYXRoS2V5JDE7CnZhciBwYXRoS2V5RXhwb3J0cyA9IHBhdGhLZXkkMi5leHBvcnRzOwpjb25zdCBwYXRoJDIgPSByZXF1aXJlJCQwJDI7CmNvbnN0IHdoaWNoID0gd2hpY2hfMTsKY29uc3QgZ2V0UGF0aEtleSA9IHBhdGhLZXlFeHBvcnRzOwpmdW5jdGlvbiByZXNvbHZlQ29tbWFuZEF0dGVtcHQocGFyc2VkLCB3aXRob3V0UGF0aEV4dCkgewogIGNvbnN0IGVudiA9IHBhcnNlZC5vcHRpb25zLmVudiB8fCBwcm9jZXNzLmVudjsKICBjb25zdCBjd2QgPSBwcm9jZXNzLmN3ZCgpOwogIGNvbnN0IGhhc0N1c3RvbUN3ZCA9IHBhcnNlZC5vcHRpb25zLmN3ZCAhPSBudWxsOwogIGNvbnN0IHNob3VsZFN3aXRjaEN3ZCA9IGhhc0N1c3RvbUN3ZCAmJiBwcm9jZXNzLmNoZGlyICE9PSB2b2lkIDAgJiYgIXByb2Nlc3MuY2hkaXIuZGlzYWJsZWQ7CiAgaWYgKHNob3VsZFN3aXRjaEN3ZCkgewogICAgdHJ5IHsKICAgICAgcHJvY2Vzcy5jaGRpcihwYXJzZWQub3B0aW9ucy5jd2QpOwogICAgfSBjYXRjaCAoZXJyKSB7CiAgICB9CiAgfQogIGxldCByZXNvbHZlZDsKICB0cnkgewogICAgcmVzb2x2ZWQgPSB3aGljaC5zeW5jKHBhcnNlZC5jb21tYW5kLCB7CiAgICAgIHBhdGg6IGVudltnZXRQYXRoS2V5KHsgZW52IH0pXSwKICAgICAgcGF0aEV4dDogd2l0aG91dFBhdGhFeHQgPyBwYXRoJDIuZGVsaW1pdGVyIDogdm9pZCAwCiAgICB9KTsKICB9IGNhdGNoIChlKSB7CiAgfSBmaW5hbGx5IHsKICAgIGlmIChzaG91bGRTd2l0Y2hDd2QpIHsKICAgICAgcHJvY2Vzcy5jaGRpcihjd2QpOwogICAgfQogIH0KICBpZiAocmVzb2x2ZWQpIHsKICAgIHJlc29sdmVkID0gcGF0aCQyLnJlc29sdmUoaGFzQ3VzdG9tQ3dkID8gcGFyc2VkLm9wdGlvbnMuY3dkIDogIiIsIHJlc29sdmVkKTsKICB9CiAgcmV0dXJuIHJlc29sdmVkOwp9CmZ1bmN0aW9uIHJlc29sdmVDb21tYW5kJDEocGFyc2VkKSB7CiAgcmV0dXJuIHJlc29sdmVDb21tYW5kQXR0ZW1wdChwYXJzZWQpIHx8IHJlc29sdmVDb21tYW5kQXR0ZW1wdChwYXJzZWQsIHRydWUpOwp9CnZhciByZXNvbHZlQ29tbWFuZF8xID0gcmVzb2x2ZUNvbW1hbmQkMTsKdmFyIF9lc2NhcGUgPSB7fTsKY29uc3QgbWV0YUNoYXJzUmVnRXhwID0gLyhbKClcXVslIV4iYDw+Jnw7LCAqP10pL2c7CmZ1bmN0aW9uIGVzY2FwZUNvbW1hbmQoYXJnKSB7CiAgYXJnID0gYXJnLnJlcGxhY2UobWV0YUNoYXJzUmVnRXhwLCAiXiQxIik7CiAgcmV0dXJuIGFyZzsKfQpmdW5jdGlvbiBlc2NhcGVBcmd1bWVudChhcmcsIGRvdWJsZUVzY2FwZU1ldGFDaGFycykgewogIGFyZyA9IGAke2FyZ31gOwogIGFyZyA9IGFyZy5yZXBsYWNlKC8oXFwqKSIvZywgJyQxJDFcXCInKTsKICBhcmcgPSBhcmcucmVwbGFjZSgvKFxcKikkLywgIiQxJDEiKTsKICBhcmcgPSBgIiR7YXJnfSJgOwogIGFyZyA9IGFyZy5yZXBsYWNlKG1ldGFDaGFyc1JlZ0V4cCwgIl4kMSIpOwogIGlmIChkb3VibGVFc2NhcGVNZXRhQ2hhcnMpIHsKICAgIGFyZyA9IGFyZy5yZXBsYWNlKG1ldGFDaGFyc1JlZ0V4cCwgIl4kMSIpOwogIH0KICByZXR1cm4gYXJnOwp9Cl9lc2NhcGUuY29tbWFuZCA9IGVzY2FwZUNvbW1hbmQ7Cl9lc2NhcGUuYXJndW1lbnQgPSBlc2NhcGVBcmd1bWVudDsKdmFyIHNoZWJhbmdSZWdleCQxID0gL14jISguKikvOwpjb25zdCBzaGViYW5nUmVnZXggPSBzaGViYW5nUmVnZXgkMTsKdmFyIHNoZWJhbmdDb21tYW5kJDEgPSAoc3RyaW5nID0gIiIpID0+IHsKICBjb25zdCBtYXRjaDIgPSBzdHJpbmcubWF0Y2goc2hlYmFuZ1JlZ2V4KTsKICBpZiAoIW1hdGNoMikgewogICAgcmV0dXJuIG51bGw7CiAgfQogIGNvbnN0IFtwYXRoMiwgYXJndW1lbnRdID0gbWF0Y2gyWzBdLnJlcGxhY2UoLyMhID8vLCAiIikuc3BsaXQoIiAiKTsKICBjb25zdCBiaW5hcnkgPSBwYXRoMi5zcGxpdCgiLyIpLnBvcCgpOwogIGlmIChiaW5hcnkgPT09ICJlbnYiKSB7CiAgICByZXR1cm4gYXJndW1lbnQ7CiAgfQogIHJldHVybiBhcmd1bWVudCA/IGAke2JpbmFyeX0gJHthcmd1bWVudH1gIDogYmluYXJ5Owp9Owpjb25zdCBmcyA9IHJlcXVpcmUkJDBfX2RlZmF1bHQ7CmNvbnN0IHNoZWJhbmdDb21tYW5kID0gc2hlYmFuZ0NvbW1hbmQkMTsKZnVuY3Rpb24gcmVhZFNoZWJhbmckMShjb21tYW5kMikgewogIGNvbnN0IHNpemUgPSAxNTA7CiAgY29uc3QgYnVmZmVyID0gQnVmZmVyLmFsbG9jKHNpemUpOwogIGxldCBmZDsKICB0cnkgewogICAgZmQgPSBmcy5vcGVuU3luYyhjb21tYW5kMiwgInIiKTsKICAgIGZzLnJlYWRTeW5jKGZkLCBidWZmZXIsIDAsIHNpemUsIDApOwogICAgZnMuY2xvc2VTeW5jKGZkKTsKICB9IGNhdGNoIChlKSB7CiAgfQogIHJldHVybiBzaGViYW5nQ29tbWFuZChidWZmZXIudG9TdHJpbmcoKSk7Cn0KdmFyIHJlYWRTaGViYW5nXzEgPSByZWFkU2hlYmFuZyQxOwpjb25zdCBwYXRoJDEgPSByZXF1aXJlJCQwJDI7CmNvbnN0IHJlc29sdmVDb21tYW5kID0gcmVzb2x2ZUNvbW1hbmRfMTsKY29uc3QgZXNjYXBlJDEgPSBfZXNjYXBlOwpjb25zdCByZWFkU2hlYmFuZyA9IHJlYWRTaGViYW5nXzE7CmNvbnN0IGlzV2luJDEgPSBwcm9jZXNzLnBsYXRmb3JtID09PSAid2luMzIiOwpjb25zdCBpc0V4ZWN1dGFibGVSZWdFeHAgPSAvXC4oPzpjb218ZXhlKSQvaTsKY29uc3QgaXNDbWRTaGltUmVnRXhwID0gL25vZGVfbW9kdWxlc1tcXC9dLmJpbltcXC9dW15cXC9dK1wuY21kJC9pOwpmdW5jdGlvbiBkZXRlY3RTaGViYW5nKHBhcnNlZCkgewogIHBhcnNlZC5maWxlID0gcmVzb2x2ZUNvbW1hbmQocGFyc2VkKTsKICBjb25zdCBzaGViYW5nID0gcGFyc2VkLmZpbGUgJiYgcmVhZFNoZWJhbmcocGFyc2VkLmZpbGUpOwogIGlmIChzaGViYW5nKSB7CiAgICBwYXJzZWQuYXJncy51bnNoaWZ0KHBhcnNlZC5maWxlKTsKICAgIHBhcnNlZC5jb21tYW5kID0gc2hlYmFuZzsKICAgIHJldHVybiByZXNvbHZlQ29tbWFuZChwYXJzZWQpOwogIH0KICByZXR1cm4gcGFyc2VkLmZpbGU7Cn0KZnVuY3Rpb24gcGFyc2VOb25TaGVsbChwYXJzZWQpIHsKICBpZiAoIWlzV2luJDEpIHsKICAgIHJldHVybiBwYXJzZWQ7CiAgfQogIGNvbnN0IGNvbW1hbmRGaWxlID0gZGV0ZWN0U2hlYmFuZyhwYXJzZWQpOwogIGNvbnN0IG5lZWRzU2hlbGwgPSAhaXNFeGVjdXRhYmxlUmVnRXhwLnRlc3QoY29tbWFuZEZpbGUpOwogIGlmIChwYXJzZWQub3B0aW9ucy5mb3JjZVNoZWxsIHx8IG5lZWRzU2hlbGwpIHsKICAgIGNvbnN0IG5lZWRzRG91YmxlRXNjYXBlTWV0YUNoYXJzID0gaXNDbWRTaGltUmVnRXhwLnRlc3QoY29tbWFuZEZpbGUpOwogICAgcGFyc2VkLmNvbW1hbmQgPSBwYXRoJDEubm9ybWFsaXplKHBhcnNlZC5jb21tYW5kKTsKICAgIHBhcnNlZC5jb21tYW5kID0gZXNjYXBlJDEuY29tbWFuZChwYXJzZWQuY29tbWFuZCk7CiAgICBwYXJzZWQuYXJncyA9IHBhcnNlZC5hcmdzLm1hcCgoYXJnKSA9PiBlc2NhcGUkMS5hcmd1bWVudChhcmcsIG5lZWRzRG91YmxlRXNjYXBlTWV0YUNoYXJzKSk7CiAgICBjb25zdCBzaGVsbENvbW1hbmQgPSBbcGFyc2VkLmNvbW1hbmRdLmNvbmNhdChwYXJzZWQuYXJncykuam9pbigiICIpOwogICAgcGFyc2VkLmFyZ3MgPSBbIi9kIiwgIi9zIiwgIi9jIiwgYCIke3NoZWxsQ29tbWFuZH0iYF07CiAgICBwYXJzZWQuY29tbWFuZCA9IHByb2Nlc3MuZW52LmNvbXNwZWMgfHwgImNtZC5leGUiOwogICAgcGFyc2VkLm9wdGlvbnMud2luZG93c1ZlcmJhdGltQXJndW1lbnRzID0gdHJ1ZTsKICB9CiAgcmV0dXJuIHBhcnNlZDsKfQpmdW5jdGlvbiBwYXJzZSQxKGNvbW1hbmQyLCBhcmdzLCBvcHRpb25zKSB7CiAgaWYgKGFyZ3MgJiYgIUFycmF5LmlzQXJyYXkoYXJncykpIHsKICAgIG9wdGlvbnMgPSBhcmdzOwogICAgYXJncyA9IG51bGw7CiAgfQogIGFyZ3MgPSBhcmdzID8gYXJncy5zbGljZSgwKSA6IFtdOwogIG9wdGlvbnMgPSBPYmplY3QuYXNzaWduKHt9LCBvcHRpb25zKTsKICBjb25zdCBwYXJzZWQgPSB7CiAgICBjb21tYW5kOiBjb21tYW5kMiwKICAgIGFyZ3MsCiAgICBvcHRpb25zLAogICAgZmlsZTogdm9pZCAwLAogICAgb3JpZ2luYWw6IHsKICAgICAgY29tbWFuZDogY29tbWFuZDIsCiAgICAgIGFyZ3MKICAgIH0KICB9OwogIHJldHVybiBvcHRpb25zLnNoZWxsID8gcGFyc2VkIDogcGFyc2VOb25TaGVsbChwYXJzZWQpOwp9CnZhciBwYXJzZV8xID0gcGFyc2UkMTsKY29uc3QgaXNXaW4gPSBwcm9jZXNzLnBsYXRmb3JtID09PSAid2luMzIiOwpmdW5jdGlvbiBub3RGb3VuZEVycm9yKG9yaWdpbmFsLCBzeXNjYWxsKSB7CiAgcmV0dXJuIE9iamVjdC5hc3NpZ24obmV3IEVycm9yKGAke3N5c2NhbGx9ICR7b3JpZ2luYWwuY29tbWFuZH0gRU5PRU5UYCksIHsKICAgIGNvZGU6ICJFTk9FTlQiLAogICAgZXJybm86ICJFTk9FTlQiLAogICAgc3lzY2FsbDogYCR7c3lzY2FsbH0gJHtvcmlnaW5hbC5jb21tYW5kfWAsCiAgICBwYXRoOiBvcmlnaW5hbC5jb21tYW5kLAogICAgc3Bhd25hcmdzOiBvcmlnaW5hbC5hcmdzCiAgfSk7Cn0KZnVuY3Rpb24gaG9va0NoaWxkUHJvY2VzcyhjcDIsIHBhcnNlZCkgewogIGlmICghaXNXaW4pIHsKICAgIHJldHVybjsKICB9CiAgY29uc3Qgb3JpZ2luYWxFbWl0ID0gY3AyLmVtaXQ7CiAgY3AyLmVtaXQgPSBmdW5jdGlvbihuYW1lLCBhcmcxKSB7CiAgICBpZiAobmFtZSA9PT0gImV4aXQiKSB7CiAgICAgIGNvbnN0IGVyciA9IHZlcmlmeUVOT0VOVChhcmcxLCBwYXJzZWQpOwogICAgICBpZiAoZXJyKSB7CiAgICAgICAgcmV0dXJuIG9yaWdpbmFsRW1pdC5jYWxsKGNwMiwgImVycm9yIiwgZXJyKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIG9yaWdpbmFsRW1pdC5hcHBseShjcDIsIGFyZ3VtZW50cyk7CiAgfTsKfQpmdW5jdGlvbiB2ZXJpZnlFTk9FTlQoc3RhdHVzLCBwYXJzZWQpIHsKICBpZiAoaXNXaW4gJiYgc3RhdHVzID09PSAxICYmICFwYXJzZWQuZmlsZSkgewogICAgcmV0dXJuIG5vdEZvdW5kRXJyb3IocGFyc2VkLm9yaWdpbmFsLCAic3Bhd24iKTsKICB9CiAgcmV0dXJuIG51bGw7Cn0KZnVuY3Rpb24gdmVyaWZ5RU5PRU5UU3luYyhzdGF0dXMsIHBhcnNlZCkgewogIGlmIChpc1dpbiAmJiBzdGF0dXMgPT09IDEgJiYgIXBhcnNlZC5maWxlKSB7CiAgICByZXR1cm4gbm90Rm91bmRFcnJvcihwYXJzZWQub3JpZ2luYWwsICJzcGF3blN5bmMiKTsKICB9CiAgcmV0dXJuIG51bGw7Cn0KdmFyIGVub2VudCQxID0gewogIGhvb2tDaGlsZFByb2Nlc3MsCiAgdmVyaWZ5RU5PRU5ULAogIHZlcmlmeUVOT0VOVFN5bmMsCiAgbm90Rm91bmRFcnJvcgp9Owpjb25zdCBjcCA9IHJlcXVpcmUkJDAkMzsKY29uc3QgcGFyc2UgPSBwYXJzZV8xOwpjb25zdCBlbm9lbnQgPSBlbm9lbnQkMTsKZnVuY3Rpb24gc3Bhd24oY29tbWFuZDIsIGFyZ3MsIG9wdGlvbnMpIHsKICBjb25zdCBwYXJzZWQgPSBwYXJzZShjb21tYW5kMiwgYXJncywgb3B0aW9ucyk7CiAgY29uc3Qgc3Bhd25lZCA9IGNwLnNwYXduKHBhcnNlZC5jb21tYW5kLCBwYXJzZWQuYXJncywgcGFyc2VkLm9wdGlvbnMpOwogIGVub2VudC5ob29rQ2hpbGRQcm9jZXNzKHNwYXduZWQsIHBhcnNlZCk7CiAgcmV0dXJuIHNwYXduZWQ7Cn0KZnVuY3Rpb24gc3Bhd25TeW5jKGNvbW1hbmQyLCBhcmdzLCBvcHRpb25zKSB7CiAgY29uc3QgcGFyc2VkID0gcGFyc2UoY29tbWFuZDIsIGFyZ3MsIG9wdGlvbnMpOwogIGNvbnN0IHJlc3VsdCA9IGNwLnNwYXduU3luYyhwYXJzZWQuY29tbWFuZCwgcGFyc2VkLmFyZ3MsIHBhcnNlZC5vcHRpb25zKTsKICByZXN1bHQuZXJyb3IgPSByZXN1bHQuZXJyb3IgfHwgZW5vZW50LnZlcmlmeUVOT0VOVFN5bmMocmVzdWx0LnN0YXR1cywgcGFyc2VkKTsKICByZXR1cm4gcmVzdWx0Owp9CmNyb3NzU3Bhd24kMS5leHBvcnRzID0gc3Bhd247CmNyb3NzU3Bhd24kMS5leHBvcnRzLnNwYXduID0gc3Bhd247CmNyb3NzU3Bhd24kMS5leHBvcnRzLnN5bmMgPSBzcGF3blN5bmM7CmNyb3NzU3Bhd24kMS5leHBvcnRzLl9wYXJzZSA9IHBhcnNlOwpjcm9zc1NwYXduJDEuZXhwb3J0cy5fZW5vZW50ID0gZW5vZW50Owp2YXIgY3Jvc3NTcGF3bkV4cG9ydHMgPSBjcm9zc1NwYXduJDEuZXhwb3J0czsKY29uc3QgY3Jvc3NTcGF3biA9IC8qIEBfX1BVUkVfXyAqLyBnZXREZWZhdWx0RXhwb3J0RnJvbUNqcyhjcm9zc1NwYXduRXhwb3J0cyk7CmZ1bmN0aW9uIHN0cmlwRmluYWxOZXdsaW5lKGlucHV0KSB7CiAgY29uc3QgTEYgPSB0eXBlb2YgaW5wdXQgPT09ICJzdHJpbmciID8gIlxuIiA6ICJcbiIuY2hhckNvZGVBdCgpOwogIGNvbnN0IENSID0gdHlwZW9mIGlucHV0ID09PSAic3RyaW5nIiA/ICJcciIgOiAiXHIiLmNoYXJDb2RlQXQoKTsKICBpZiAoaW5wdXRbaW5wdXQubGVuZ3RoIC0gMV0gPT09IExGKSB7CiAgICBpbnB1dCA9IGlucHV0LnNsaWNlKDAsIC0xKTsKICB9CiAgaWYgKGlucHV0W2lucHV0Lmxlbmd0aCAtIDFdID09PSBDUikgewogICAgaW5wdXQgPSBpbnB1dC5zbGljZSgwLCAtMSk7CiAgfQogIHJldHVybiBpbnB1dDsKfQpmdW5jdGlvbiBwYXRoS2V5KG9wdGlvbnMgPSB7fSkgewogIGNvbnN0IHsKICAgIGVudiA9IHByb2Nlc3MuZW52LAogICAgcGxhdGZvcm0gPSBwcm9jZXNzLnBsYXRmb3JtCiAgfSA9IG9wdGlvbnM7CiAgaWYgKHBsYXRmb3JtICE9PSAid2luMzIiKSB7CiAgICByZXR1cm4gIlBBVEgiOwogIH0KICByZXR1cm4gT2JqZWN0LmtleXMoZW52KS5yZXZlcnNlKCkuZmluZCgoa2V5KSA9PiBrZXkudG9VcHBlckNhc2UoKSA9PT0gIlBBVEgiKSB8fCAiUGF0aCI7Cn0KZnVuY3Rpb24gbnBtUnVuUGF0aChvcHRpb25zID0ge30pIHsKICBjb25zdCB7CiAgICBjd2QgPSBwcm9jZXNzJDIuY3dkKCksCiAgICBwYXRoOiBwYXRoXyA9IHByb2Nlc3MkMi5lbnZbcGF0aEtleSgpXSwKICAgIGV4ZWNQYXRoID0gcHJvY2VzcyQyLmV4ZWNQYXRoCiAgfSA9IG9wdGlvbnM7CiAgbGV0IHByZXZpb3VzOwogIGNvbnN0IGN3ZFN0cmluZyA9IGN3ZCBpbnN0YW5jZW9mIFVSTCA/IHVybC5maWxlVVJMVG9QYXRoKGN3ZCkgOiBjd2Q7CiAgbGV0IGN3ZFBhdGggPSBwYXRoJDQucmVzb2x2ZShjd2RTdHJpbmcpOwogIGNvbnN0IHJlc3VsdCA9IFtdOwogIHdoaWxlIChwcmV2aW91cyAhPT0gY3dkUGF0aCkgewogICAgcmVzdWx0LnB1c2gocGF0aCQ0LmpvaW4oY3dkUGF0aCwgIm5vZGVfbW9kdWxlcy8uYmluIikpOwogICAgcHJldmlvdXMgPSBjd2RQYXRoOwogICAgY3dkUGF0aCA9IHBhdGgkNC5yZXNvbHZlKGN3ZFBhdGgsICIuLiIpOwogIH0KICByZXN1bHQucHVzaChwYXRoJDQucmVzb2x2ZShjd2RTdHJpbmcsIGV4ZWNQYXRoLCAiLi4iKSk7CiAgcmV0dXJuIFsuLi5yZXN1bHQsIHBhdGhfXS5qb2luKHBhdGgkNC5kZWxpbWl0ZXIpOwp9CmZ1bmN0aW9uIG5wbVJ1blBhdGhFbnYoeyBlbnYgPSBwcm9jZXNzJDIuZW52LCAuLi5vcHRpb25zIH0gPSB7fSkgewogIGVudiA9IHsgLi4uZW52IH07CiAgY29uc3QgcGF0aDIgPSBwYXRoS2V5KHsgZW52IH0pOwogIG9wdGlvbnMucGF0aCA9IGVudltwYXRoMl07CiAgZW52W3BhdGgyXSA9IG5wbVJ1blBhdGgob3B0aW9ucyk7CiAgcmV0dXJuIGVudjsKfQpjb25zdCBjb3B5UHJvcGVydHkgPSAodG8sIGZyb20sIHByb3BlcnR5LCBpZ25vcmVOb25Db25maWd1cmFibGUpID0+IHsKICBpZiAocHJvcGVydHkgPT09ICJsZW5ndGgiIHx8IHByb3BlcnR5ID09PSAicHJvdG90eXBlIikgewogICAgcmV0dXJuOwogIH0KICBpZiAocHJvcGVydHkgPT09ICJhcmd1bWVudHMiIHx8IHByb3BlcnR5ID09PSAiY2FsbGVyIikgewogICAgcmV0dXJuOwogIH0KICBjb25zdCB0b0Rlc2NyaXB0b3IgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHRvLCBwcm9wZXJ0eSk7CiAgY29uc3QgZnJvbURlc2NyaXB0b3IgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGZyb20sIHByb3BlcnR5KTsKICBpZiAoIWNhbkNvcHlQcm9wZXJ0eSh0b0Rlc2NyaXB0b3IsIGZyb21EZXNjcmlwdG9yKSAmJiBpZ25vcmVOb25Db25maWd1cmFibGUpIHsKICAgIHJldHVybjsKICB9CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRvLCBwcm9wZXJ0eSwgZnJvbURlc2NyaXB0b3IpOwp9Owpjb25zdCBjYW5Db3B5UHJvcGVydHkgPSBmdW5jdGlvbih0b0Rlc2NyaXB0b3IsIGZyb21EZXNjcmlwdG9yKSB7CiAgcmV0dXJuIHRvRGVzY3JpcHRvciA9PT0gdm9pZCAwIHx8IHRvRGVzY3JpcHRvci5jb25maWd1cmFibGUgfHwgdG9EZXNjcmlwdG9yLndyaXRhYmxlID09PSBmcm9tRGVzY3JpcHRvci53cml0YWJsZSAmJiB0b0Rlc2NyaXB0b3IuZW51bWVyYWJsZSA9PT0gZnJvbURlc2NyaXB0b3IuZW51bWVyYWJsZSAmJiB0b0Rlc2NyaXB0b3IuY29uZmlndXJhYmxlID09PSBmcm9tRGVzY3JpcHRvci5jb25maWd1cmFibGUgJiYgKHRvRGVzY3JpcHRvci53cml0YWJsZSB8fCB0b0Rlc2NyaXB0b3IudmFsdWUgPT09IGZyb21EZXNjcmlwdG9yLnZhbHVlKTsKfTsKY29uc3QgY2hhbmdlUHJvdG90eXBlID0gKHRvLCBmcm9tKSA9PiB7CiAgY29uc3QgZnJvbVByb3RvdHlwZSA9IE9iamVjdC5nZXRQcm90b3R5cGVPZihmcm9tKTsKICBpZiAoZnJvbVByb3RvdHlwZSA9PT0gT2JqZWN0LmdldFByb3RvdHlwZU9mKHRvKSkgewogICAgcmV0dXJuOwogIH0KICBPYmplY3Quc2V0UHJvdG90eXBlT2YodG8sIGZyb21Qcm90b3R5cGUpOwp9Owpjb25zdCB3cmFwcGVkVG9TdHJpbmcgPSAod2l0aE5hbWUsIGZyb21Cb2R5KSA9PiBgLyogV3JhcHBlZCAke3dpdGhOYW1lfSovCiR7ZnJvbUJvZHl9YDsKY29uc3QgdG9TdHJpbmdEZXNjcmlwdG9yID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihGdW5jdGlvbi5wcm90b3R5cGUsICJ0b1N0cmluZyIpOwpjb25zdCB0b1N0cmluZ05hbWUgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKEZ1bmN0aW9uLnByb3RvdHlwZS50b1N0cmluZywgIm5hbWUiKTsKY29uc3QgY2hhbmdlVG9TdHJpbmcgPSAodG8sIGZyb20sIG5hbWUpID0+IHsKICBjb25zdCB3aXRoTmFtZSA9IG5hbWUgPT09ICIiID8gIiIgOiBgd2l0aCAke25hbWUudHJpbSgpfSgpIGA7CiAgY29uc3QgbmV3VG9TdHJpbmcgPSB3cmFwcGVkVG9TdHJpbmcuYmluZChudWxsLCB3aXRoTmFtZSwgZnJvbS50b1N0cmluZygpKTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkobmV3VG9TdHJpbmcsICJuYW1lIiwgdG9TdHJpbmdOYW1lKTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkodG8sICJ0b1N0cmluZyIsIHsgLi4udG9TdHJpbmdEZXNjcmlwdG9yLCB2YWx1ZTogbmV3VG9TdHJpbmcgfSk7Cn07CmZ1bmN0aW9uIG1pbWljRnVuY3Rpb24odG8sIGZyb20sIHsgaWdub3JlTm9uQ29uZmlndXJhYmxlID0gZmFsc2UgfSA9IHt9KSB7CiAgY29uc3QgeyBuYW1lIH0gPSB0bzsKICBmb3IgKGNvbnN0IHByb3BlcnR5IG9mIFJlZmxlY3Qub3duS2V5cyhmcm9tKSkgewogICAgY29weVByb3BlcnR5KHRvLCBmcm9tLCBwcm9wZXJ0eSwgaWdub3JlTm9uQ29uZmlndXJhYmxlKTsKICB9CiAgY2hhbmdlUHJvdG90eXBlKHRvLCBmcm9tKTsKICBjaGFuZ2VUb1N0cmluZyh0bywgZnJvbSwgbmFtZSk7CiAgcmV0dXJuIHRvOwp9CmNvbnN0IGNhbGxlZEZ1bmN0aW9ucyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgV2Vha01hcCgpOwpjb25zdCBvbmV0aW1lID0gKGZ1bmN0aW9uXywgb3B0aW9ucyA9IHt9KSA9PiB7CiAgaWYgKHR5cGVvZiBmdW5jdGlvbl8gIT09ICJmdW5jdGlvbiIpIHsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkV4cGVjdGVkIGEgZnVuY3Rpb24iKTsKICB9CiAgbGV0IHJldHVyblZhbHVlOwogIGxldCBjYWxsQ291bnQgPSAwOwogIGNvbnN0IGZ1bmN0aW9uTmFtZSA9IGZ1bmN0aW9uXy5kaXNwbGF5TmFtZSB8fCBmdW5jdGlvbl8ubmFtZSB8fCAiPGFub255bW91cz4iOwogIGNvbnN0IG9uZXRpbWUyID0gZnVuY3Rpb24oLi4uYXJndW1lbnRzXykgewogICAgY2FsbGVkRnVuY3Rpb25zLnNldChvbmV0aW1lMiwgKytjYWxsQ291bnQpOwogICAgaWYgKGNhbGxDb3VudCA9PT0gMSkgewogICAgICByZXR1cm5WYWx1ZSA9IGZ1bmN0aW9uXy5hcHBseSh0aGlzLCBhcmd1bWVudHNfKTsKICAgICAgZnVuY3Rpb25fID0gbnVsbDsKICAgIH0gZWxzZSBpZiAob3B0aW9ucy50aHJvdyA9PT0gdHJ1ZSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoYEZ1bmN0aW9uIFxgJHtmdW5jdGlvbk5hbWV9XGAgY2FuIG9ubHkgYmUgY2FsbGVkIG9uY2VgKTsKICAgIH0KICAgIHJldHVybiByZXR1cm5WYWx1ZTsKICB9OwogIG1pbWljRnVuY3Rpb24ob25ldGltZTIsIGZ1bmN0aW9uXyk7CiAgY2FsbGVkRnVuY3Rpb25zLnNldChvbmV0aW1lMiwgY2FsbENvdW50KTsKICByZXR1cm4gb25ldGltZTI7Cn07Cm9uZXRpbWUuY2FsbENvdW50ID0gKGZ1bmN0aW9uXykgPT4gewogIGlmICghY2FsbGVkRnVuY3Rpb25zLmhhcyhmdW5jdGlvbl8pKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSBnaXZlbiBmdW5jdGlvbiBcYCR7ZnVuY3Rpb25fLm5hbWV9XGAgaXMgbm90IHdyYXBwZWQgYnkgdGhlIFxgb25ldGltZVxgIHBhY2thZ2VgKTsKICB9CiAgcmV0dXJuIGNhbGxlZEZ1bmN0aW9ucy5nZXQoZnVuY3Rpb25fKTsKfTsKY29uc3QgZ2V0UmVhbHRpbWVTaWduYWxzID0gKCkgPT4gewogIGNvbnN0IGxlbmd0aCA9IFNJR1JUTUFYIC0gU0lHUlRNSU4gKyAxOwogIHJldHVybiBBcnJheS5mcm9tKHsgbGVuZ3RoIH0sIGdldFJlYWx0aW1lU2lnbmFsKTsKfTsKY29uc3QgZ2V0UmVhbHRpbWVTaWduYWwgPSAodmFsdWUsIGluZGV4KSA9PiAoewogIG5hbWU6IGBTSUdSVCR7aW5kZXggKyAxfWAsCiAgbnVtYmVyOiBTSUdSVE1JTiArIGluZGV4LAogIGFjdGlvbjogInRlcm1pbmF0ZSIsCiAgZGVzY3JpcHRpb246ICJBcHBsaWNhdGlvbi1zcGVjaWZpYyBzaWduYWwgKHJlYWx0aW1lKSIsCiAgc3RhbmRhcmQ6ICJwb3NpeCIKfSk7CmNvbnN0IFNJR1JUTUlOID0gMzQ7CmNvbnN0IFNJR1JUTUFYID0gNjQ7CmNvbnN0IFNJR05BTFMgPSBbCiAgewogICAgbmFtZTogIlNJR0hVUCIsCiAgICBudW1iZXI6IDEsCiAgICBhY3Rpb246ICJ0ZXJtaW5hdGUiLAogICAgZGVzY3JpcHRpb246ICJUZXJtaW5hbCBjbG9zZWQiLAogICAgc3RhbmRhcmQ6ICJwb3NpeCIKICB9LAogIHsKICAgIG5hbWU6ICJTSUdJTlQiLAogICAgbnVtYmVyOiAyLAogICAgYWN0aW9uOiAidGVybWluYXRlIiwKICAgIGRlc2NyaXB0aW9uOiAiVXNlciBpbnRlcnJ1cHRpb24gd2l0aCBDVFJMLUMiLAogICAgc3RhbmRhcmQ6ICJhbnNpIgogIH0sCiAgewogICAgbmFtZTogIlNJR1FVSVQiLAogICAgbnVtYmVyOiAzLAogICAgYWN0aW9uOiAiY29yZSIsCiAgICBkZXNjcmlwdGlvbjogIlVzZXIgaW50ZXJydXB0aW9uIHdpdGggQ1RSTC1cXCIsCiAgICBzdGFuZGFyZDogInBvc2l4IgogIH0sCiAgewogICAgbmFtZTogIlNJR0lMTCIsCiAgICBudW1iZXI6IDQsCiAgICBhY3Rpb246ICJjb3JlIiwKICAgIGRlc2NyaXB0aW9uOiAiSW52YWxpZCBtYWNoaW5lIGluc3RydWN0aW9uIiwKICAgIHN0YW5kYXJkOiAiYW5zaSIKICB9LAogIHsKICAgIG5hbWU6ICJTSUdUUkFQIiwKICAgIG51bWJlcjogNSwKICAgIGFjdGlvbjogImNvcmUiLAogICAgZGVzY3JpcHRpb246ICJEZWJ1Z2dlciBicmVha3BvaW50IiwKICAgIHN0YW5kYXJkOiAicG9zaXgiCiAgfSwKICB7CiAgICBuYW1lOiAiU0lHQUJSVCIsCiAgICBudW1iZXI6IDYsCiAgICBhY3Rpb246ICJjb3JlIiwKICAgIGRlc2NyaXB0aW9uOiAiQWJvcnRlZCIsCiAgICBzdGFuZGFyZDogImFuc2kiCiAgfSwKICB7CiAgICBuYW1lOiAiU0lHSU9UIiwKICAgIG51bWJlcjogNiwKICAgIGFjdGlvbjogImNvcmUiLAogICAgZGVzY3JpcHRpb246ICJBYm9ydGVkIiwKICAgIHN0YW5kYXJkOiAiYnNkIgogIH0sCiAgewogICAgbmFtZTogIlNJR0JVUyIsCiAgICBudW1iZXI6IDcsCiAgICBhY3Rpb246ICJjb3JlIiwKICAgIGRlc2NyaXB0aW9uOiAiQnVzIGVycm9yIGR1ZSB0byBtaXNhbGlnbmVkLCBub24tZXhpc3RpbmcgYWRkcmVzcyBvciBwYWdpbmcgZXJyb3IiLAogICAgc3RhbmRhcmQ6ICJic2QiCiAgfSwKICB7CiAgICBuYW1lOiAiU0lHRU1UIiwKICAgIG51bWJlcjogNywKICAgIGFjdGlvbjogInRlcm1pbmF0ZSIsCiAgICBkZXNjcmlwdGlvbjogIkNvbW1hbmQgc2hvdWxkIGJlIGVtdWxhdGVkIGJ1dCBpcyBub3QgaW1wbGVtZW50ZWQiLAogICAgc3RhbmRhcmQ6ICJvdGhlciIKICB9LAogIHsKICAgIG5hbWU6ICJTSUdGUEUiLAogICAgbnVtYmVyOiA4LAogICAgYWN0aW9uOiAiY29yZSIsCiAgICBkZXNjcmlwdGlvbjogIkZsb2F0aW5nIHBvaW50IGFyaXRobWV0aWMgZXJyb3IiLAogICAgc3RhbmRhcmQ6ICJhbnNpIgogIH0sCiAgewogICAgbmFtZTogIlNJR0tJTEwiLAogICAgbnVtYmVyOiA5LAogICAgYWN0aW9uOiAidGVybWluYXRlIiwKICAgIGRlc2NyaXB0aW9uOiAiRm9yY2VkIHRlcm1pbmF0aW9uIiwKICAgIHN0YW5kYXJkOiAicG9zaXgiLAogICAgZm9yY2VkOiB0cnVlCiAgfSwKICB7CiAgICBuYW1lOiAiU0lHVVNSMSIsCiAgICBudW1iZXI6IDEwLAogICAgYWN0aW9uOiAidGVybWluYXRlIiwKICAgIGRlc2NyaXB0aW9uOiAiQXBwbGljYXRpb24tc3BlY2lmaWMgc2lnbmFsIiwKICAgIHN0YW5kYXJkOiAicG9zaXgiCiAgfSwKICB7CiAgICBuYW1lOiAiU0lHU0VHViIsCiAgICBudW1iZXI6IDExLAogICAgYWN0aW9uOiAiY29yZSIsCiAgICBkZXNjcmlwdGlvbjogIlNlZ21lbnRhdGlvbiBmYXVsdCIsCiAgICBzdGFuZGFyZDogImFuc2kiCiAgfSwKICB7CiAgICBuYW1lOiAiU0lHVVNSMiIsCiAgICBudW1iZXI6IDEyLAogICAgYWN0aW9uOiAidGVybWluYXRlIiwKICAgIGRlc2NyaXB0aW9uOiAiQXBwbGljYXRpb24tc3BlY2lmaWMgc2lnbmFsIiwKICAgIHN0YW5kYXJkOiAicG9zaXgiCiAgfSwKICB7CiAgICBuYW1lOiAiU0lHUElQRSIsCiAgICBudW1iZXI6IDEzLAogICAgYWN0aW9uOiAidGVybWluYXRlIiwKICAgIGRlc2NyaXB0aW9uOiAiQnJva2VuIHBpcGUgb3Igc29ja2V0IiwKICAgIHN0YW5kYXJkOiAicG9zaXgiCiAgfSwKICB7CiAgICBuYW1lOiAiU0lHQUxSTSIsCiAgICBudW1iZXI6IDE0LAogICAgYWN0aW9uOiAidGVybWluYXRlIiwKICAgIGRlc2NyaXB0aW9uOiAiVGltZW91dCBvciB0aW1lciIsCiAgICBzdGFuZGFyZDogInBvc2l4IgogIH0sCiAgewogICAgbmFtZTogIlNJR1RFUk0iLAogICAgbnVtYmVyOiAxNSwKICAgIGFjdGlvbjogInRlcm1pbmF0ZSIsCiAgICBkZXNjcmlwdGlvbjogIlRlcm1pbmF0aW9uIiwKICAgIHN0YW5kYXJkOiAiYW5zaSIKICB9LAogIHsKICAgIG5hbWU6ICJTSUdTVEtGTFQiLAogICAgbnVtYmVyOiAxNiwKICAgIGFjdGlvbjogInRlcm1pbmF0ZSIsCiAgICBkZXNjcmlwdGlvbjogIlN0YWNrIGlzIGVtcHR5IG9yIG92ZXJmbG93ZWQiLAogICAgc3RhbmRhcmQ6ICJvdGhlciIKICB9LAogIHsKICAgIG5hbWU6ICJTSUdDSExEIiwKICAgIG51bWJlcjogMTcsCiAgICBhY3Rpb246ICJpZ25vcmUiLAogICAgZGVzY3JpcHRpb246ICJDaGlsZCBwcm9jZXNzIHRlcm1pbmF0ZWQsIHBhdXNlZCBvciB1bnBhdXNlZCIsCiAgICBzdGFuZGFyZDogInBvc2l4IgogIH0sCiAgewogICAgbmFtZTogIlNJR0NMRCIsCiAgICBudW1iZXI6IDE3LAogICAgYWN0aW9uOiAiaWdub3JlIiwKICAgIGRlc2NyaXB0aW9uOiAiQ2hpbGQgcHJvY2VzcyB0ZXJtaW5hdGVkLCBwYXVzZWQgb3IgdW5wYXVzZWQiLAogICAgc3RhbmRhcmQ6ICJvdGhlciIKICB9LAogIHsKICAgIG5hbWU6ICJTSUdDT05UIiwKICAgIG51bWJlcjogMTgsCiAgICBhY3Rpb246ICJ1bnBhdXNlIiwKICAgIGRlc2NyaXB0aW9uOiAiVW5wYXVzZWQiLAogICAgc3RhbmRhcmQ6ICJwb3NpeCIsCiAgICBmb3JjZWQ6IHRydWUKICB9LAogIHsKICAgIG5hbWU6ICJTSUdTVE9QIiwKICAgIG51bWJlcjogMTksCiAgICBhY3Rpb246ICJwYXVzZSIsCiAgICBkZXNjcmlwdGlvbjogIlBhdXNlZCIsCiAgICBzdGFuZGFyZDogInBvc2l4IiwKICAgIGZvcmNlZDogdHJ1ZQogIH0sCiAgewogICAgbmFtZTogIlNJR1RTVFAiLAogICAgbnVtYmVyOiAyMCwKICAgIGFjdGlvbjogInBhdXNlIiwKICAgIGRlc2NyaXB0aW9uOiAnUGF1c2VkIHVzaW5nIENUUkwtWiBvciAic3VzcGVuZCInLAogICAgc3RhbmRhcmQ6ICJwb3NpeCIKICB9LAogIHsKICAgIG5hbWU6ICJTSUdUVElOIiwKICAgIG51bWJlcjogMjEsCiAgICBhY3Rpb246ICJwYXVzZSIsCiAgICBkZXNjcmlwdGlvbjogIkJhY2tncm91bmQgcHJvY2VzcyBjYW5ub3QgcmVhZCB0ZXJtaW5hbCBpbnB1dCIsCiAgICBzdGFuZGFyZDogInBvc2l4IgogIH0sCiAgewogICAgbmFtZTogIlNJR0JSRUFLIiwKICAgIG51bWJlcjogMjEsCiAgICBhY3Rpb246ICJ0ZXJtaW5hdGUiLAogICAgZGVzY3JpcHRpb246ICJVc2VyIGludGVycnVwdGlvbiB3aXRoIENUUkwtQlJFQUsiLAogICAgc3RhbmRhcmQ6ICJvdGhlciIKICB9LAogIHsKICAgIG5hbWU6ICJTSUdUVE9VIiwKICAgIG51bWJlcjogMjIsCiAgICBhY3Rpb246ICJwYXVzZSIsCiAgICBkZXNjcmlwdGlvbjogIkJhY2tncm91bmQgcHJvY2VzcyBjYW5ub3Qgd3JpdGUgdG8gdGVybWluYWwgb3V0cHV0IiwKICAgIHN0YW5kYXJkOiAicG9zaXgiCiAgfSwKICB7CiAgICBuYW1lOiAiU0lHVVJHIiwKICAgIG51bWJlcjogMjMsCiAgICBhY3Rpb246ICJpZ25vcmUiLAogICAgZGVzY3JpcHRpb246ICJTb2NrZXQgcmVjZWl2ZWQgb3V0LW9mLWJhbmQgZGF0YSIsCiAgICBzdGFuZGFyZDogImJzZCIKICB9LAogIHsKICAgIG5hbWU6ICJTSUdYQ1BVIiwKICAgIG51bWJlcjogMjQsCiAgICBhY3Rpb246ICJjb3JlIiwKICAgIGRlc2NyaXB0aW9uOiAiUHJvY2VzcyB0aW1lZCBvdXQiLAogICAgc3RhbmRhcmQ6ICJic2QiCiAgfSwKICB7CiAgICBuYW1lOiAiU0lHWEZTWiIsCiAgICBudW1iZXI6IDI1LAogICAgYWN0aW9uOiAiY29yZSIsCiAgICBkZXNjcmlwdGlvbjogIkZpbGUgdG9vIGJpZyIsCiAgICBzdGFuZGFyZDogImJzZCIKICB9LAogIHsKICAgIG5hbWU6ICJTSUdWVEFMUk0iLAogICAgbnVtYmVyOiAyNiwKICAgIGFjdGlvbjogInRlcm1pbmF0ZSIsCiAgICBkZXNjcmlwdGlvbjogIlRpbWVvdXQgb3IgdGltZXIiLAogICAgc3RhbmRhcmQ6ICJic2QiCiAgfSwKICB7CiAgICBuYW1lOiAiU0lHUFJPRiIsCiAgICBudW1iZXI6IDI3LAogICAgYWN0aW9uOiAidGVybWluYXRlIiwKICAgIGRlc2NyaXB0aW9uOiAiVGltZW91dCBvciB0aW1lciIsCiAgICBzdGFuZGFyZDogImJzZCIKICB9LAogIHsKICAgIG5hbWU6ICJTSUdXSU5DSCIsCiAgICBudW1iZXI6IDI4LAogICAgYWN0aW9uOiAiaWdub3JlIiwKICAgIGRlc2NyaXB0aW9uOiAiVGVybWluYWwgd2luZG93IHNpemUgY2hhbmdlZCIsCiAgICBzdGFuZGFyZDogImJzZCIKICB9LAogIHsKICAgIG5hbWU6ICJTSUdJTyIsCiAgICBudW1iZXI6IDI5LAogICAgYWN0aW9uOiAidGVybWluYXRlIiwKICAgIGRlc2NyaXB0aW9uOiAiSS9PIGlzIGF2YWlsYWJsZSIsCiAgICBzdGFuZGFyZDogIm90aGVyIgogIH0sCiAgewogICAgbmFtZTogIlNJR1BPTEwiLAogICAgbnVtYmVyOiAyOSwKICAgIGFjdGlvbjogInRlcm1pbmF0ZSIsCiAgICBkZXNjcmlwdGlvbjogIldhdGNoZWQgZXZlbnQiLAogICAgc3RhbmRhcmQ6ICJvdGhlciIKICB9LAogIHsKICAgIG5hbWU6ICJTSUdJTkZPIiwKICAgIG51bWJlcjogMjksCiAgICBhY3Rpb246ICJpZ25vcmUiLAogICAgZGVzY3JpcHRpb246ICJSZXF1ZXN0IGZvciBwcm9jZXNzIGluZm9ybWF0aW9uIiwKICAgIHN0YW5kYXJkOiAib3RoZXIiCiAgfSwKICB7CiAgICBuYW1lOiAiU0lHUFdSIiwKICAgIG51bWJlcjogMzAsCiAgICBhY3Rpb246ICJ0ZXJtaW5hdGUiLAogICAgZGVzY3JpcHRpb246ICJEZXZpY2UgcnVubmluZyBvdXQgb2YgcG93ZXIiLAogICAgc3RhbmRhcmQ6ICJzeXN0ZW12IgogIH0sCiAgewogICAgbmFtZTogIlNJR1NZUyIsCiAgICBudW1iZXI6IDMxLAogICAgYWN0aW9uOiAiY29yZSIsCiAgICBkZXNjcmlwdGlvbjogIkludmFsaWQgc3lzdGVtIGNhbGwiLAogICAgc3RhbmRhcmQ6ICJvdGhlciIKICB9LAogIHsKICAgIG5hbWU6ICJTSUdVTlVTRUQiLAogICAgbnVtYmVyOiAzMSwKICAgIGFjdGlvbjogInRlcm1pbmF0ZSIsCiAgICBkZXNjcmlwdGlvbjogIkludmFsaWQgc3lzdGVtIGNhbGwiLAogICAgc3RhbmRhcmQ6ICJvdGhlciIKICB9Cl07CmNvbnN0IGdldFNpZ25hbHMgPSAoKSA9PiB7CiAgY29uc3QgcmVhbHRpbWVTaWduYWxzID0gZ2V0UmVhbHRpbWVTaWduYWxzKCk7CiAgY29uc3Qgc2lnbmFsczIgPSBbLi4uU0lHTkFMUywgLi4ucmVhbHRpbWVTaWduYWxzXS5tYXAobm9ybWFsaXplU2lnbmFsKTsKICByZXR1cm4gc2lnbmFsczI7Cn07CmNvbnN0IG5vcm1hbGl6ZVNpZ25hbCA9ICh7CiAgbmFtZSwKICBudW1iZXI6IGRlZmF1bHROdW1iZXIsCiAgZGVzY3JpcHRpb24sCiAgYWN0aW9uLAogIGZvcmNlZCA9IGZhbHNlLAogIHN0YW5kYXJkCn0pID0+IHsKICBjb25zdCB7CiAgICBzaWduYWxzOiB7IFtuYW1lXTogY29uc3RhbnRTaWduYWwgfQogIH0gPSBjb25zdGFudHM7CiAgY29uc3Qgc3VwcG9ydGVkID0gY29uc3RhbnRTaWduYWwgIT09IHZvaWQgMDsKICBjb25zdCBudW1iZXIgPSBzdXBwb3J0ZWQgPyBjb25zdGFudFNpZ25hbCA6IGRlZmF1bHROdW1iZXI7CiAgcmV0dXJuIHsgbmFtZSwgbnVtYmVyLCBkZXNjcmlwdGlvbiwgc3VwcG9ydGVkLCBhY3Rpb24sIGZvcmNlZCwgc3RhbmRhcmQgfTsKfTsKY29uc3QgZ2V0U2lnbmFsc0J5TmFtZSA9ICgpID0+IHsKICBjb25zdCBzaWduYWxzMiA9IGdldFNpZ25hbHMoKTsKICByZXR1cm4gT2JqZWN0LmZyb21FbnRyaWVzKHNpZ25hbHMyLm1hcChnZXRTaWduYWxCeU5hbWUpKTsKfTsKY29uc3QgZ2V0U2lnbmFsQnlOYW1lID0gKHsKICBuYW1lLAogIG51bWJlciwKICBkZXNjcmlwdGlvbiwKICBzdXBwb3J0ZWQsCiAgYWN0aW9uLAogIGZvcmNlZCwKICBzdGFuZGFyZAp9KSA9PiBbbmFtZSwgeyBuYW1lLCBudW1iZXIsIGRlc2NyaXB0aW9uLCBzdXBwb3J0ZWQsIGFjdGlvbiwgZm9yY2VkLCBzdGFuZGFyZCB9XTsKY29uc3Qgc2lnbmFsc0J5TmFtZSA9IGdldFNpZ25hbHNCeU5hbWUoKTsKY29uc3QgZ2V0U2lnbmFsc0J5TnVtYmVyID0gKCkgPT4gewogIGNvbnN0IHNpZ25hbHMyID0gZ2V0U2lnbmFscygpOwogIGNvbnN0IGxlbmd0aCA9IFNJR1JUTUFYICsgMTsKICBjb25zdCBzaWduYWxzQSA9IEFycmF5LmZyb20oCiAgICB7IGxlbmd0aCB9LAogICAgKHZhbHVlLCBudW1iZXIpID0+IGdldFNpZ25hbEJ5TnVtYmVyKG51bWJlciwgc2lnbmFsczIpCiAgKTsKICByZXR1cm4gT2JqZWN0LmFzc2lnbih7fSwgLi4uc2lnbmFsc0EpOwp9Owpjb25zdCBnZXRTaWduYWxCeU51bWJlciA9IChudW1iZXIsIHNpZ25hbHMyKSA9PiB7CiAgY29uc3Qgc2lnbmFsID0gZmluZFNpZ25hbEJ5TnVtYmVyKG51bWJlciwgc2lnbmFsczIpOwogIGlmIChzaWduYWwgPT09IHZvaWQgMCkgewogICAgcmV0dXJuIHt9OwogIH0KICBjb25zdCB7IG5hbWUsIGRlc2NyaXB0aW9uLCBzdXBwb3J0ZWQsIGFjdGlvbiwgZm9yY2VkLCBzdGFuZGFyZCB9ID0gc2lnbmFsOwogIHJldHVybiB7CiAgICBbbnVtYmVyXTogewogICAgICBuYW1lLAogICAgICBudW1iZXIsCiAgICAgIGRlc2NyaXB0aW9uLAogICAgICBzdXBwb3J0ZWQsCiAgICAgIGFjdGlvbiwKICAgICAgZm9yY2VkLAogICAgICBzdGFuZGFyZAogICAgfQogIH07Cn07CmNvbnN0IGZpbmRTaWduYWxCeU51bWJlciA9IChudW1iZXIsIHNpZ25hbHMyKSA9PiB7CiAgY29uc3Qgc2lnbmFsID0gc2lnbmFsczIuZmluZCgoeyBuYW1lIH0pID0+IGNvbnN0YW50cy5zaWduYWxzW25hbWVdID09PSBudW1iZXIpOwogIGlmIChzaWduYWwgIT09IHZvaWQgMCkgewogICAgcmV0dXJuIHNpZ25hbDsKICB9CiAgcmV0dXJuIHNpZ25hbHMyLmZpbmQoKHNpZ25hbEEpID0+IHNpZ25hbEEubnVtYmVyID09PSBudW1iZXIpOwp9OwpnZXRTaWduYWxzQnlOdW1iZXIoKTsKY29uc3QgZ2V0RXJyb3JQcmVmaXggPSAoeyB0aW1lZE91dCwgdGltZW91dCwgZXJyb3JDb2RlLCBzaWduYWwsIHNpZ25hbERlc2NyaXB0aW9uLCBleGl0Q29kZSwgaXNDYW5jZWxlZCB9KSA9PiB7CiAgaWYgKHRpbWVkT3V0KSB7CiAgICByZXR1cm4gYHRpbWVkIG91dCBhZnRlciAke3RpbWVvdXR9IG1pbGxpc2Vjb25kc2A7CiAgfQogIGlmIChpc0NhbmNlbGVkKSB7CiAgICByZXR1cm4gIndhcyBjYW5jZWxlZCI7CiAgfQogIGlmIChlcnJvckNvZGUgIT09IHZvaWQgMCkgewogICAgcmV0dXJuIGBmYWlsZWQgd2l0aCAke2Vycm9yQ29kZX1gOwogIH0KICBpZiAoc2lnbmFsICE9PSB2b2lkIDApIHsKICAgIHJldHVybiBgd2FzIGtpbGxlZCB3aXRoICR7c2lnbmFsfSAoJHtzaWduYWxEZXNjcmlwdGlvbn0pYDsKICB9CiAgaWYgKGV4aXRDb2RlICE9PSB2b2lkIDApIHsKICAgIHJldHVybiBgZmFpbGVkIHdpdGggZXhpdCBjb2RlICR7ZXhpdENvZGV9YDsKICB9CiAgcmV0dXJuICJmYWlsZWQiOwp9Owpjb25zdCBtYWtlRXJyb3IgPSAoewogIHN0ZG91dCwKICBzdGRlcnIsCiAgYWxsLAogIGVycm9yLAogIHNpZ25hbCwKICBleGl0Q29kZSwKICBjb21tYW5kOiBjb21tYW5kMiwKICBlc2NhcGVkQ29tbWFuZCwKICB0aW1lZE91dCwKICBpc0NhbmNlbGVkLAogIGtpbGxlZCwKICBwYXJzZWQ6IHsgb3B0aW9uczogeyB0aW1lb3V0LCBjd2QgPSBwcm9jZXNzJDIuY3dkKCkgfSB9Cn0pID0+IHsKICBleGl0Q29kZSA9IGV4aXRDb2RlID09PSBudWxsID8gdm9pZCAwIDogZXhpdENvZGU7CiAgc2lnbmFsID0gc2lnbmFsID09PSBudWxsID8gdm9pZCAwIDogc2lnbmFsOwogIGNvbnN0IHNpZ25hbERlc2NyaXB0aW9uID0gc2lnbmFsID09PSB2b2lkIDAgPyB2b2lkIDAgOiBzaWduYWxzQnlOYW1lW3NpZ25hbF0uZGVzY3JpcHRpb247CiAgY29uc3QgZXJyb3JDb2RlID0gZXJyb3IgJiYgZXJyb3IuY29kZTsKICBjb25zdCBwcmVmaXggPSBnZXRFcnJvclByZWZpeCh7IHRpbWVkT3V0LCB0aW1lb3V0LCBlcnJvckNvZGUsIHNpZ25hbCwgc2lnbmFsRGVzY3JpcHRpb24sIGV4aXRDb2RlLCBpc0NhbmNlbGVkIH0pOwogIGNvbnN0IGV4ZWNhTWVzc2FnZSA9IGBDb21tYW5kICR7cHJlZml4fTogJHtjb21tYW5kMn1gOwogIGNvbnN0IGlzRXJyb3IgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoZXJyb3IpID09PSAiW29iamVjdCBFcnJvcl0iOwogIGNvbnN0IHNob3J0TWVzc2FnZSA9IGlzRXJyb3IgPyBgJHtleGVjYU1lc3NhZ2V9CiR7ZXJyb3IubWVzc2FnZX1gIDogZXhlY2FNZXNzYWdlOwogIGNvbnN0IG1lc3NhZ2UgPSBbc2hvcnRNZXNzYWdlLCBzdGRlcnIsIHN0ZG91dF0uZmlsdGVyKEJvb2xlYW4pLmpvaW4oIlxuIik7CiAgaWYgKGlzRXJyb3IpIHsKICAgIGVycm9yLm9yaWdpbmFsTWVzc2FnZSA9IGVycm9yLm1lc3NhZ2U7CiAgICBlcnJvci5tZXNzYWdlID0gbWVzc2FnZTsKICB9IGVsc2UgewogICAgZXJyb3IgPSBuZXcgRXJyb3IobWVzc2FnZSk7CiAgfQogIGVycm9yLnNob3J0TWVzc2FnZSA9IHNob3J0TWVzc2FnZTsKICBlcnJvci5jb21tYW5kID0gY29tbWFuZDI7CiAgZXJyb3IuZXNjYXBlZENvbW1hbmQgPSBlc2NhcGVkQ29tbWFuZDsKICBlcnJvci5leGl0Q29kZSA9IGV4aXRDb2RlOwogIGVycm9yLnNpZ25hbCA9IHNpZ25hbDsKICBlcnJvci5zaWduYWxEZXNjcmlwdGlvbiA9IHNpZ25hbERlc2NyaXB0aW9uOwogIGVycm9yLnN0ZG91dCA9IHN0ZG91dDsKICBlcnJvci5zdGRlcnIgPSBzdGRlcnI7CiAgZXJyb3IuY3dkID0gY3dkOwogIGlmIChhbGwgIT09IHZvaWQgMCkgewogICAgZXJyb3IuYWxsID0gYWxsOwogIH0KICBpZiAoImJ1ZmZlcmVkRGF0YSIgaW4gZXJyb3IpIHsKICAgIGRlbGV0ZSBlcnJvci5idWZmZXJlZERhdGE7CiAgfQogIGVycm9yLmZhaWxlZCA9IHRydWU7CiAgZXJyb3IudGltZWRPdXQgPSBCb29sZWFuKHRpbWVkT3V0KTsKICBlcnJvci5pc0NhbmNlbGVkID0gaXNDYW5jZWxlZDsKICBlcnJvci5raWxsZWQgPSBraWxsZWQgJiYgIXRpbWVkT3V0OwogIHJldHVybiBlcnJvcjsKfTsKY29uc3QgYWxpYXNlcyA9IFsic3RkaW4iLCAic3Rkb3V0IiwgInN0ZGVyciJdOwpjb25zdCBoYXNBbGlhcyA9IChvcHRpb25zKSA9PiBhbGlhc2VzLnNvbWUoKGFsaWFzKSA9PiBvcHRpb25zW2FsaWFzXSAhPT0gdm9pZCAwKTsKY29uc3Qgbm9ybWFsaXplU3RkaW8gPSAob3B0aW9ucykgPT4gewogIGlmICghb3B0aW9ucykgewogICAgcmV0dXJuOwogIH0KICBjb25zdCB7IHN0ZGlvIH0gPSBvcHRpb25zOwogIGlmIChzdGRpbyA9PT0gdm9pZCAwKSB7CiAgICByZXR1cm4gYWxpYXNlcy5tYXAoKGFsaWFzKSA9PiBvcHRpb25zW2FsaWFzXSk7CiAgfQogIGlmIChoYXNBbGlhcyhvcHRpb25zKSkgewogICAgdGhyb3cgbmV3IEVycm9yKGBJdCdzIG5vdCBwb3NzaWJsZSB0byBwcm92aWRlIFxgc3RkaW9cYCBpbiBjb21iaW5hdGlvbiB3aXRoIG9uZSBvZiAke2FsaWFzZXMubWFwKChhbGlhcykgPT4gYFxgJHthbGlhc31cYGApLmpvaW4oIiwgIil9YCk7CiAgfQogIGlmICh0eXBlb2Ygc3RkaW8gPT09ICJzdHJpbmciKSB7CiAgICByZXR1cm4gc3RkaW87CiAgfQogIGlmICghQXJyYXkuaXNBcnJheShzdGRpbykpIHsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoYEV4cGVjdGVkIFxgc3RkaW9cYCB0byBiZSBvZiB0eXBlIFxgc3RyaW5nXGAgb3IgXGBBcnJheVxgLCBnb3QgXGAke3R5cGVvZiBzdGRpb31cYGApOwogIH0KICBjb25zdCBsZW5ndGggPSBNYXRoLm1heChzdGRpby5sZW5ndGgsIGFsaWFzZXMubGVuZ3RoKTsKICByZXR1cm4gQXJyYXkuZnJvbSh7IGxlbmd0aCB9LCAodmFsdWUsIGluZGV4KSA9PiBzdGRpb1tpbmRleF0pOwp9Owpjb25zdCBzaWduYWxzID0gW107CnNpZ25hbHMucHVzaCgiU0lHSFVQIiwgIlNJR0lOVCIsICJTSUdURVJNIik7CmlmIChwcm9jZXNzLnBsYXRmb3JtICE9PSAid2luMzIiKSB7CiAgc2lnbmFscy5wdXNoKAogICAgIlNJR0FMUk0iLAogICAgIlNJR0FCUlQiLAogICAgIlNJR1ZUQUxSTSIsCiAgICAiU0lHWENQVSIsCiAgICAiU0lHWEZTWiIsCiAgICAiU0lHVVNSMiIsCiAgICAiU0lHVFJBUCIsCiAgICAiU0lHU1lTIiwKICAgICJTSUdRVUlUIiwKICAgICJTSUdJT1QiCiAgICAvLyBzaG91bGQgZGV0ZWN0IHByb2ZpbGVyIGFuZCBlbmFibGUvZGlzYWJsZSBhY2NvcmRpbmdseS4KICAgIC8vIHNlZSAjMjEKICAgIC8vICdTSUdQUk9GJwogICk7Cn0KaWYgKHByb2Nlc3MucGxhdGZvcm0gPT09ICJsaW51eCIpIHsKICBzaWduYWxzLnB1c2goIlNJR0lPIiwgIlNJR1BPTEwiLCAiU0lHUFdSIiwgIlNJR1NUS0ZMVCIpOwp9CmNvbnN0IHByb2Nlc3NPayA9IChwcm9jZXNzMikgPT4gISFwcm9jZXNzMiAmJiB0eXBlb2YgcHJvY2VzczIgPT09ICJvYmplY3QiICYmIHR5cGVvZiBwcm9jZXNzMi5yZW1vdmVMaXN0ZW5lciA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgcHJvY2VzczIuZW1pdCA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgcHJvY2VzczIucmVhbGx5RXhpdCA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgcHJvY2VzczIubGlzdGVuZXJzID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBwcm9jZXNzMi5raWxsID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBwcm9jZXNzMi5waWQgPT09ICJudW1iZXIiICYmIHR5cGVvZiBwcm9jZXNzMi5vbiA9PT0gImZ1bmN0aW9uIjsKY29uc3Qga0V4aXRFbWl0dGVyID0gU3ltYm9sLmZvcigic2lnbmFsLWV4aXQgZW1pdHRlciIpOwpjb25zdCBnbG9iYWwkMSA9IGdsb2JhbFRoaXM7CmNvbnN0IE9iamVjdERlZmluZVByb3BlcnR5ID0gT2JqZWN0LmRlZmluZVByb3BlcnR5LmJpbmQoT2JqZWN0KTsKY2xhc3MgRW1pdHRlciB7CiAgZW1pdHRlZCA9IHsKICAgIGFmdGVyRXhpdDogZmFsc2UsCiAgICBleGl0OiBmYWxzZQogIH07CiAgbGlzdGVuZXJzID0gewogICAgYWZ0ZXJFeGl0OiBbXSwKICAgIGV4aXQ6IFtdCiAgfTsKICBjb3VudCA9IDA7CiAgaWQgPSBNYXRoLnJhbmRvbSgpOwogIGNvbnN0cnVjdG9yKCkgewogICAgaWYgKGdsb2JhbCQxW2tFeGl0RW1pdHRlcl0pIHsKICAgICAgcmV0dXJuIGdsb2JhbCQxW2tFeGl0RW1pdHRlcl07CiAgICB9CiAgICBPYmplY3REZWZpbmVQcm9wZXJ0eShnbG9iYWwkMSwga0V4aXRFbWl0dGVyLCB7CiAgICAgIHZhbHVlOiB0aGlzLAogICAgICB3cml0YWJsZTogZmFsc2UsCiAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICBjb25maWd1cmFibGU6IGZhbHNlCiAgICB9KTsKICB9CiAgb24oZXYsIGZuKSB7CiAgICB0aGlzLmxpc3RlbmVyc1tldl0ucHVzaChmbik7CiAgfQogIHJlbW92ZUxpc3RlbmVyKGV2LCBmbikgewogICAgY29uc3QgbGlzdCA9IHRoaXMubGlzdGVuZXJzW2V2XTsKICAgIGNvbnN0IGkgPSBsaXN0LmluZGV4T2YoZm4pOwogICAgaWYgKGkgPT09IC0xKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChpID09PSAwICYmIGxpc3QubGVuZ3RoID09PSAxKSB7CiAgICAgIGxpc3QubGVuZ3RoID0gMDsKICAgIH0gZWxzZSB7CiAgICAgIGxpc3Quc3BsaWNlKGksIDEpOwogICAgfQogIH0KICBlbWl0KGV2LCBjb2RlLCBzaWduYWwpIHsKICAgIGlmICh0aGlzLmVtaXR0ZWRbZXZdKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHRoaXMuZW1pdHRlZFtldl0gPSB0cnVlOwogICAgbGV0IHJldCA9IGZhbHNlOwogICAgZm9yIChjb25zdCBmbiBvZiB0aGlzLmxpc3RlbmVyc1tldl0pIHsKICAgICAgcmV0ID0gZm4oY29kZSwgc2lnbmFsKSA9PT0gdHJ1ZSB8fCByZXQ7CiAgICB9CiAgICBpZiAoZXYgPT09ICJleGl0IikgewogICAgICByZXQgPSB0aGlzLmVtaXQoImFmdGVyRXhpdCIsIGNvZGUsIHNpZ25hbCkgfHwgcmV0OwogICAgfQogICAgcmV0dXJuIHJldDsKICB9Cn0KY2xhc3MgU2lnbmFsRXhpdEJhc2Ugewp9CmNvbnN0IHNpZ25hbEV4aXRXcmFwID0gKGhhbmRsZXIpID0+IHsKICByZXR1cm4gewogICAgb25FeGl0KGNiLCBvcHRzKSB7CiAgICAgIHJldHVybiBoYW5kbGVyLm9uRXhpdChjYiwgb3B0cyk7CiAgICB9LAogICAgbG9hZCgpIHsKICAgICAgcmV0dXJuIGhhbmRsZXIubG9hZCgpOwogICAgfSwKICAgIHVubG9hZCgpIHsKICAgICAgcmV0dXJuIGhhbmRsZXIudW5sb2FkKCk7CiAgICB9CiAgfTsKfTsKY2xhc3MgU2lnbmFsRXhpdEZhbGxiYWNrIGV4dGVuZHMgU2lnbmFsRXhpdEJhc2UgewogIG9uRXhpdCgpIHsKICAgIHJldHVybiAoKSA9PiB7CiAgICB9OwogIH0KICBsb2FkKCkgewogIH0KICB1bmxvYWQoKSB7CiAgfQp9CmNsYXNzIFNpZ25hbEV4aXQgZXh0ZW5kcyBTaWduYWxFeGl0QmFzZSB7CiAgLy8gIlNJR0hVUCIgdGhyb3dzIGFuIGBFTk9TWVNgIGVycm9yIG9uIFdpbmRvd3MsCiAgLy8gc28gdXNlIGEgc3VwcG9ydGVkIHNpZ25hbCBpbnN0ZWFkCiAgLyogYzggaWdub3JlIHN0YXJ0ICovCiAgI2h1cFNpZyA9IHByb2Nlc3MkMS5wbGF0Zm9ybSA9PT0gIndpbjMyIiA/ICJTSUdJTlQiIDogIlNJR0hVUCI7CiAgLyogYzggaWdub3JlIHN0b3AgKi8KICAjZW1pdHRlciA9IG5ldyBFbWl0dGVyKCk7CiAgI3Byb2Nlc3M7CiAgI29yaWdpbmFsUHJvY2Vzc0VtaXQ7CiAgI29yaWdpbmFsUHJvY2Vzc1JlYWxseUV4aXQ7CiAgI3NpZ0xpc3RlbmVycyA9IHt9OwogICNsb2FkZWQgPSBmYWxzZTsKICBjb25zdHJ1Y3Rvcihwcm9jZXNzMikgewogICAgc3VwZXIoKTsKICAgIHRoaXMuI3Byb2Nlc3MgPSBwcm9jZXNzMjsKICAgIHRoaXMuI3NpZ0xpc3RlbmVycyA9IHt9OwogICAgZm9yIChjb25zdCBzaWcgb2Ygc2lnbmFscykgewogICAgICB0aGlzLiNzaWdMaXN0ZW5lcnNbc2lnXSA9ICgpID0+IHsKICAgICAgICBjb25zdCBsaXN0ZW5lcnMgPSB0aGlzLiNwcm9jZXNzLmxpc3RlbmVycyhzaWcpOwogICAgICAgIGxldCB7IGNvdW50IH0gPSB0aGlzLiNlbWl0dGVyOwogICAgICAgIGNvbnN0IHAgPSBwcm9jZXNzMjsKICAgICAgICBpZiAodHlwZW9mIHAuX19zaWduYWxfZXhpdF9lbWl0dGVyX18gPT09ICJvYmplY3QiICYmIHR5cGVvZiBwLl9fc2lnbmFsX2V4aXRfZW1pdHRlcl9fLmNvdW50ID09PSAibnVtYmVyIikgewogICAgICAgICAgY291bnQgKz0gcC5fX3NpZ25hbF9leGl0X2VtaXR0ZXJfXy5jb3VudDsKICAgICAgICB9CiAgICAgICAgaWYgKGxpc3RlbmVycy5sZW5ndGggPT09IGNvdW50KSB7CiAgICAgICAgICB0aGlzLnVubG9hZCgpOwogICAgICAgICAgY29uc3QgcmV0ID0gdGhpcy4jZW1pdHRlci5lbWl0KCJleGl0IiwgbnVsbCwgc2lnKTsKICAgICAgICAgIGNvbnN0IHMgPSBzaWcgPT09ICJTSUdIVVAiID8gdGhpcy4jaHVwU2lnIDogc2lnOwogICAgICAgICAgaWYgKCFyZXQpCiAgICAgICAgICAgIHByb2Nlc3MyLmtpbGwocHJvY2VzczIucGlkLCBzKTsKICAgICAgICB9CiAgICAgIH07CiAgICB9CiAgICB0aGlzLiNvcmlnaW5hbFByb2Nlc3NSZWFsbHlFeGl0ID0gcHJvY2VzczIucmVhbGx5RXhpdDsKICAgIHRoaXMuI29yaWdpbmFsUHJvY2Vzc0VtaXQgPSBwcm9jZXNzMi5lbWl0OwogIH0KICBvbkV4aXQoY2IsIG9wdHMpIHsKICAgIGlmICghcHJvY2Vzc09rKHRoaXMuI3Byb2Nlc3MpKSB7CiAgICAgIHJldHVybiAoKSA9PiB7CiAgICAgIH07CiAgICB9CiAgICBpZiAodGhpcy4jbG9hZGVkID09PSBmYWxzZSkgewogICAgICB0aGlzLmxvYWQoKTsKICAgIH0KICAgIGNvbnN0IGV2ID0gb3B0cz8uYWx3YXlzTGFzdCA/ICJhZnRlckV4aXQiIDogImV4aXQiOwogICAgdGhpcy4jZW1pdHRlci5vbihldiwgY2IpOwogICAgcmV0dXJuICgpID0+IHsKICAgICAgdGhpcy4jZW1pdHRlci5yZW1vdmVMaXN0ZW5lcihldiwgY2IpOwogICAgICBpZiAodGhpcy4jZW1pdHRlci5saXN0ZW5lcnNbImV4aXQiXS5sZW5ndGggPT09IDAgJiYgdGhpcy4jZW1pdHRlci5saXN0ZW5lcnNbImFmdGVyRXhpdCJdLmxlbmd0aCA9PT0gMCkgewogICAgICAgIHRoaXMudW5sb2FkKCk7CiAgICAgIH0KICAgIH07CiAgfQogIGxvYWQoKSB7CiAgICBpZiAodGhpcy4jbG9hZGVkKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuI2xvYWRlZCA9IHRydWU7CiAgICB0aGlzLiNlbWl0dGVyLmNvdW50ICs9IDE7CiAgICBmb3IgKGNvbnN0IHNpZyBvZiBzaWduYWxzKSB7CiAgICAgIHRyeSB7CiAgICAgICAgY29uc3QgZm4gPSB0aGlzLiNzaWdMaXN0ZW5lcnNbc2lnXTsKICAgICAgICBpZiAoZm4pCiAgICAgICAgICB0aGlzLiNwcm9jZXNzLm9uKHNpZywgZm4pOwogICAgICB9IGNhdGNoIChfKSB7CiAgICAgIH0KICAgIH0KICAgIHRoaXMuI3Byb2Nlc3MuZW1pdCA9IChldiwgLi4uYSkgPT4gewogICAgICByZXR1cm4gdGhpcy4jcHJvY2Vzc0VtaXQoZXYsIC4uLmEpOwogICAgfTsKICAgIHRoaXMuI3Byb2Nlc3MucmVhbGx5RXhpdCA9IChjb2RlKSA9PiB7CiAgICAgIHJldHVybiB0aGlzLiNwcm9jZXNzUmVhbGx5RXhpdChjb2RlKTsKICAgIH07CiAgfQogIHVubG9hZCgpIHsKICAgIGlmICghdGhpcy4jbG9hZGVkKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuI2xvYWRlZCA9IGZhbHNlOwogICAgc2lnbmFscy5mb3JFYWNoKChzaWcpID0+IHsKICAgICAgY29uc3QgbGlzdGVuZXIgPSB0aGlzLiNzaWdMaXN0ZW5lcnNbc2lnXTsKICAgICAgaWYgKCFsaXN0ZW5lcikgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiTGlzdGVuZXIgbm90IGRlZmluZWQgZm9yIHNpZ25hbDogIiArIHNpZyk7CiAgICAgIH0KICAgICAgdHJ5IHsKICAgICAgICB0aGlzLiNwcm9jZXNzLnJlbW92ZUxpc3RlbmVyKHNpZywgbGlzdGVuZXIpOwogICAgICB9IGNhdGNoIChfKSB7CiAgICAgIH0KICAgIH0pOwogICAgdGhpcy4jcHJvY2Vzcy5lbWl0ID0gdGhpcy4jb3JpZ2luYWxQcm9jZXNzRW1pdDsKICAgIHRoaXMuI3Byb2Nlc3MucmVhbGx5RXhpdCA9IHRoaXMuI29yaWdpbmFsUHJvY2Vzc1JlYWxseUV4aXQ7CiAgICB0aGlzLiNlbWl0dGVyLmNvdW50IC09IDE7CiAgfQogICNwcm9jZXNzUmVhbGx5RXhpdChjb2RlKSB7CiAgICBpZiAoIXByb2Nlc3NPayh0aGlzLiNwcm9jZXNzKSkgewogICAgICByZXR1cm4gMDsKICAgIH0KICAgIHRoaXMuI3Byb2Nlc3MuZXhpdENvZGUgPSBjb2RlIHx8IDA7CiAgICB0aGlzLiNlbWl0dGVyLmVtaXQoImV4aXQiLCB0aGlzLiNwcm9jZXNzLmV4aXRDb2RlLCBudWxsKTsKICAgIHJldHVybiB0aGlzLiNvcmlnaW5hbFByb2Nlc3NSZWFsbHlFeGl0LmNhbGwodGhpcy4jcHJvY2VzcywgdGhpcy4jcHJvY2Vzcy5leGl0Q29kZSk7CiAgfQogICNwcm9jZXNzRW1pdChldiwgLi4uYXJncykgewogICAgY29uc3Qgb2cgPSB0aGlzLiNvcmlnaW5hbFByb2Nlc3NFbWl0OwogICAgaWYgKGV2ID09PSAiZXhpdCIgJiYgcHJvY2Vzc09rKHRoaXMuI3Byb2Nlc3MpKSB7CiAgICAgIGlmICh0eXBlb2YgYXJnc1swXSA9PT0gIm51bWJlciIpIHsKICAgICAgICB0aGlzLiNwcm9jZXNzLmV4aXRDb2RlID0gYXJnc1swXTsKICAgICAgfQogICAgICBjb25zdCByZXQgPSBvZy5jYWxsKHRoaXMuI3Byb2Nlc3MsIGV2LCAuLi5hcmdzKTsKICAgICAgdGhpcy4jZW1pdHRlci5lbWl0KCJleGl0IiwgdGhpcy4jcHJvY2Vzcy5leGl0Q29kZSwgbnVsbCk7CiAgICAgIHJldHVybiByZXQ7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gb2cuY2FsbCh0aGlzLiNwcm9jZXNzLCBldiwgLi4uYXJncyk7CiAgICB9CiAgfQp9CmNvbnN0IHByb2Nlc3MkMSA9IGdsb2JhbFRoaXMucHJvY2VzczsKY29uc3QgewogIC8qKgogICAqIENhbGxlZCB3aGVuIHRoZSBwcm9jZXNzIGlzIGV4aXRpbmcsIHdoZXRoZXIgdmlhIHNpZ25hbCwgZXhwbGljaXQKICAgKiBleGl0LCBvciBydW5uaW5nIG91dCBvZiBzdHVmZiB0byBkby4KICAgKgogICAqIElmIHRoZSBnbG9iYWwgcHJvY2VzcyBvYmplY3QgaXMgbm90IHN1aXRhYmxlIGZvciBpbnN0cnVtZW50YXRpb24sCiAgICogdGhlbiB0aGlzIHdpbGwgYmUgYSBuby1vcC4KICAgKgogICAqIFJldHVybnMgYSBmdW5jdGlvbiB0aGF0IG1heSBiZSB1c2VkIHRvIHVubG9hZCBzaWduYWwtZXhpdC4KICAgKi8KICBvbkV4aXQsCiAgLyoqCiAgICogTG9hZCB0aGUgbGlzdGVuZXJzLiAgTGlrZWx5IHlvdSBuZXZlciBuZWVkIHRvIGNhbGwgdGhpcywgdW5sZXNzCiAgICogZG9pbmcgYSByYXRoZXIgZGVlcCBpbnRlZ3JhdGlvbiB3aXRoIHNpZ25hbC1leGl0IGZ1bmN0aW9uYWxpdHkuCiAgICogTW9zdGx5IGV4cG9zZWQgZm9yIHRoZSBiZW5lZml0IG9mIHRlc3RpbmcuCiAgICoKICAgKiBAaW50ZXJuYWwKICAgKi8KICBsb2FkLAogIC8qKgogICAqIFVubG9hZCB0aGUgbGlzdGVuZXJzLiAgTGlrZWx5IHlvdSBuZXZlciBuZWVkIHRvIGNhbGwgdGhpcywgdW5sZXNzCiAgICogZG9pbmcgYSByYXRoZXIgZGVlcCBpbnRlZ3JhdGlvbiB3aXRoIHNpZ25hbC1leGl0IGZ1bmN0aW9uYWxpdHkuCiAgICogTW9zdGx5IGV4cG9zZWQgZm9yIHRoZSBiZW5lZml0IG9mIHRlc3RpbmcuCiAgICoKICAgKiBAaW50ZXJuYWwKICAgKi8KICB1bmxvYWQKfSA9IHNpZ25hbEV4aXRXcmFwKHByb2Nlc3NPayhwcm9jZXNzJDEpID8gbmV3IFNpZ25hbEV4aXQocHJvY2VzcyQxKSA6IG5ldyBTaWduYWxFeGl0RmFsbGJhY2soKSk7CmNvbnN0IERFRkFVTFRfRk9SQ0VfS0lMTF9USU1FT1VUID0gMWUzICogNTsKY29uc3Qgc3Bhd25lZEtpbGwgPSAoa2lsbCwgc2lnbmFsID0gIlNJR1RFUk0iLCBvcHRpb25zID0ge30pID0+IHsKICBjb25zdCBraWxsUmVzdWx0ID0ga2lsbChzaWduYWwpOwogIHNldEtpbGxUaW1lb3V0KGtpbGwsIHNpZ25hbCwgb3B0aW9ucywga2lsbFJlc3VsdCk7CiAgcmV0dXJuIGtpbGxSZXN1bHQ7Cn07CmNvbnN0IHNldEtpbGxUaW1lb3V0ID0gKGtpbGwsIHNpZ25hbCwgb3B0aW9ucywga2lsbFJlc3VsdCkgPT4gewogIGlmICghc2hvdWxkRm9yY2VLaWxsKHNpZ25hbCwgb3B0aW9ucywga2lsbFJlc3VsdCkpIHsKICAgIHJldHVybjsKICB9CiAgY29uc3QgdGltZW91dCA9IGdldEZvcmNlS2lsbEFmdGVyVGltZW91dChvcHRpb25zKTsKICBjb25zdCB0ID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICBraWxsKCJTSUdLSUxMIik7CiAgfSwgdGltZW91dCk7CiAgaWYgKHQudW5yZWYpIHsKICAgIHQudW5yZWYoKTsKICB9Cn07CmNvbnN0IHNob3VsZEZvcmNlS2lsbCA9IChzaWduYWwsIHsgZm9yY2VLaWxsQWZ0ZXJUaW1lb3V0IH0sIGtpbGxSZXN1bHQpID0+IGlzU2lndGVybShzaWduYWwpICYmIGZvcmNlS2lsbEFmdGVyVGltZW91dCAhPT0gZmFsc2UgJiYga2lsbFJlc3VsdDsKY29uc3QgaXNTaWd0ZXJtID0gKHNpZ25hbCkgPT4gc2lnbmFsID09PSBvcyQyLmNvbnN0YW50cy5zaWduYWxzLlNJR1RFUk0gfHwgdHlwZW9mIHNpZ25hbCA9PT0gInN0cmluZyIgJiYgc2lnbmFsLnRvVXBwZXJDYXNlKCkgPT09ICJTSUdURVJNIjsKY29uc3QgZ2V0Rm9yY2VLaWxsQWZ0ZXJUaW1lb3V0ID0gKHsgZm9yY2VLaWxsQWZ0ZXJUaW1lb3V0ID0gdHJ1ZSB9KSA9PiB7CiAgaWYgKGZvcmNlS2lsbEFmdGVyVGltZW91dCA9PT0gdHJ1ZSkgewogICAgcmV0dXJuIERFRkFVTFRfRk9SQ0VfS0lMTF9USU1FT1VUOwogIH0KICBpZiAoIU51bWJlci5pc0Zpbml0ZShmb3JjZUtpbGxBZnRlclRpbWVvdXQpIHx8IGZvcmNlS2lsbEFmdGVyVGltZW91dCA8IDApIHsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoYEV4cGVjdGVkIHRoZSBcYGZvcmNlS2lsbEFmdGVyVGltZW91dFxgIG9wdGlvbiB0byBiZSBhIG5vbi1uZWdhdGl2ZSBpbnRlZ2VyLCBnb3QgXGAke2ZvcmNlS2lsbEFmdGVyVGltZW91dH1cYCAoJHt0eXBlb2YgZm9yY2VLaWxsQWZ0ZXJUaW1lb3V0fSlgKTsKICB9CiAgcmV0dXJuIGZvcmNlS2lsbEFmdGVyVGltZW91dDsKfTsKY29uc3Qgc3Bhd25lZENhbmNlbCA9IChzcGF3bmVkLCBjb250ZXh0KSA9PiB7CiAgY29uc3Qga2lsbFJlc3VsdCA9IHNwYXduZWQua2lsbCgpOwogIGlmIChraWxsUmVzdWx0KSB7CiAgICBjb250ZXh0LmlzQ2FuY2VsZWQgPSB0cnVlOwogIH0KfTsKY29uc3QgdGltZW91dEtpbGwgPSAoc3Bhd25lZCwgc2lnbmFsLCByZWplY3QpID0+IHsKICBzcGF3bmVkLmtpbGwoc2lnbmFsKTsKICByZWplY3QoT2JqZWN0LmFzc2lnbihuZXcgRXJyb3IoIlRpbWVkIG91dCIpLCB7IHRpbWVkT3V0OiB0cnVlLCBzaWduYWwgfSkpOwp9Owpjb25zdCBzZXR1cFRpbWVvdXQgPSAoc3Bhd25lZCwgeyB0aW1lb3V0LCBraWxsU2lnbmFsID0gIlNJR1RFUk0iIH0sIHNwYXduZWRQcm9taXNlKSA9PiB7CiAgaWYgKHRpbWVvdXQgPT09IDAgfHwgdGltZW91dCA9PT0gdm9pZCAwKSB7CiAgICByZXR1cm4gc3Bhd25lZFByb21pc2U7CiAgfQogIGxldCB0aW1lb3V0SWQ7CiAgY29uc3QgdGltZW91dFByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICB0aW1lb3V0SWQgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgdGltZW91dEtpbGwoc3Bhd25lZCwga2lsbFNpZ25hbCwgcmVqZWN0KTsKICAgIH0sIHRpbWVvdXQpOwogIH0pOwogIGNvbnN0IHNhZmVTcGF3bmVkUHJvbWlzZSA9IHNwYXduZWRQcm9taXNlLmZpbmFsbHkoKCkgPT4gewogICAgY2xlYXJUaW1lb3V0KHRpbWVvdXRJZCk7CiAgfSk7CiAgcmV0dXJuIFByb21pc2UucmFjZShbdGltZW91dFByb21pc2UsIHNhZmVTcGF3bmVkUHJvbWlzZV0pOwp9Owpjb25zdCB2YWxpZGF0ZVRpbWVvdXQgPSAoeyB0aW1lb3V0IH0pID0+IHsKICBpZiAodGltZW91dCAhPT0gdm9pZCAwICYmICghTnVtYmVyLmlzRmluaXRlKHRpbWVvdXQpIHx8IHRpbWVvdXQgPCAwKSkgewogICAgdGhyb3cgbmV3IFR5cGVFcnJvcihgRXhwZWN0ZWQgdGhlIFxgdGltZW91dFxgIG9wdGlvbiB0byBiZSBhIG5vbi1uZWdhdGl2ZSBpbnRlZ2VyLCBnb3QgXGAke3RpbWVvdXR9XGAgKCR7dHlwZW9mIHRpbWVvdXR9KWApOwogIH0KfTsKY29uc3Qgc2V0RXhpdEhhbmRsZXIgPSBhc3luYyAoc3Bhd25lZCwgeyBjbGVhbnVwLCBkZXRhY2hlZCB9LCB0aW1lZFByb21pc2UpID0+IHsKICBpZiAoIWNsZWFudXAgfHwgZGV0YWNoZWQpIHsKICAgIHJldHVybiB0aW1lZFByb21pc2U7CiAgfQogIGNvbnN0IHJlbW92ZUV4aXRIYW5kbGVyID0gb25FeGl0KCgpID0+IHsKICAgIHNwYXduZWQua2lsbCgpOwogIH0pOwogIHJldHVybiB0aW1lZFByb21pc2UuZmluYWxseSgoKSA9PiB7CiAgICByZW1vdmVFeGl0SGFuZGxlcigpOwogIH0pOwp9OwpmdW5jdGlvbiBpc1N0cmVhbSQxKHN0cmVhbTIpIHsKICByZXR1cm4gc3RyZWFtMiAhPT0gbnVsbCAmJiB0eXBlb2Ygc3RyZWFtMiA9PT0gIm9iamVjdCIgJiYgdHlwZW9mIHN0cmVhbTIucGlwZSA9PT0gImZ1bmN0aW9uIjsKfQpmdW5jdGlvbiBpc1dyaXRhYmxlU3RyZWFtKHN0cmVhbTIpIHsKICByZXR1cm4gaXNTdHJlYW0kMShzdHJlYW0yKSAmJiBzdHJlYW0yLndyaXRhYmxlICE9PSBmYWxzZSAmJiB0eXBlb2Ygc3RyZWFtMi5fd3JpdGUgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIHN0cmVhbTIuX3dyaXRhYmxlU3RhdGUgPT09ICJvYmplY3QiOwp9CmNvbnN0IGlzRXhlY2FDaGlsZFByb2Nlc3MgPSAodGFyZ2V0KSA9PiB0YXJnZXQgaW5zdGFuY2VvZiBDaGlsZFByb2Nlc3MgJiYgdHlwZW9mIHRhcmdldC50aGVuID09PSAiZnVuY3Rpb24iOwpjb25zdCBwaXBlVG9UYXJnZXQgPSAoc3Bhd25lZCwgc3RyZWFtTmFtZSwgdGFyZ2V0KSA9PiB7CiAgaWYgKHR5cGVvZiB0YXJnZXQgPT09ICJzdHJpbmciKSB7CiAgICBzcGF3bmVkW3N0cmVhbU5hbWVdLnBpcGUoY3JlYXRlV3JpdGVTdHJlYW0odGFyZ2V0KSk7CiAgICByZXR1cm4gc3Bhd25lZDsKICB9CiAgaWYgKGlzV3JpdGFibGVTdHJlYW0odGFyZ2V0KSkgewogICAgc3Bhd25lZFtzdHJlYW1OYW1lXS5waXBlKHRhcmdldCk7CiAgICByZXR1cm4gc3Bhd25lZDsKICB9CiAgaWYgKCFpc0V4ZWNhQ2hpbGRQcm9jZXNzKHRhcmdldCkpIHsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIlRoZSBzZWNvbmQgYXJndW1lbnQgbXVzdCBiZSBhIHN0cmluZywgYSBzdHJlYW0gb3IgYW4gRXhlY2EgY2hpbGQgcHJvY2Vzcy4iKTsKICB9CiAgaWYgKCFpc1dyaXRhYmxlU3RyZWFtKHRhcmdldC5zdGRpbikpIHsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIlRoZSB0YXJnZXQgY2hpbGQgcHJvY2VzcydzIHN0ZGluIG11c3QgYmUgYXZhaWxhYmxlLiIpOwogIH0KICBzcGF3bmVkW3N0cmVhbU5hbWVdLnBpcGUodGFyZ2V0LnN0ZGluKTsKICByZXR1cm4gdGFyZ2V0Owp9Owpjb25zdCBhZGRQaXBlTWV0aG9kcyA9IChzcGF3bmVkKSA9PiB7CiAgaWYgKHNwYXduZWQuc3Rkb3V0ICE9PSBudWxsKSB7CiAgICBzcGF3bmVkLnBpcGVTdGRvdXQgPSBwaXBlVG9UYXJnZXQuYmluZCh2b2lkIDAsIHNwYXduZWQsICJzdGRvdXQiKTsKICB9CiAgaWYgKHNwYXduZWQuc3RkZXJyICE9PSBudWxsKSB7CiAgICBzcGF3bmVkLnBpcGVTdGRlcnIgPSBwaXBlVG9UYXJnZXQuYmluZCh2b2lkIDAsIHNwYXduZWQsICJzdGRlcnIiKTsKICB9CiAgaWYgKHNwYXduZWQuYWxsICE9PSB2b2lkIDApIHsKICAgIHNwYXduZWQucGlwZUFsbCA9IHBpcGVUb1RhcmdldC5iaW5kKHZvaWQgMCwgc3Bhd25lZCwgImFsbCIpOwogIH0KfTsKY29uc3QgZ2V0U3RyZWFtQ29udGVudHMgPSBhc3luYyAoc3RyZWFtMiwgeyBpbml0LCBjb252ZXJ0Q2h1bmssIGdldFNpemUsIHRydW5jYXRlQ2h1bmssIGFkZENodW5rLCBnZXRGaW5hbENodW5rLCBmaW5hbGl6ZSB9LCB7IG1heEJ1ZmZlciA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWSB9ID0ge30pID0+IHsKICBpZiAoIWlzQXN5bmNJdGVyYWJsZShzdHJlYW0yKSkgewogICAgdGhyb3cgbmV3IEVycm9yKCJUaGUgZmlyc3QgYXJndW1lbnQgbXVzdCBiZSBhIFJlYWRhYmxlLCBhIFJlYWRhYmxlU3RyZWFtLCBvciBhbiBhc3luYyBpdGVyYWJsZS4iKTsKICB9CiAgY29uc3Qgc3RhdGUgPSBpbml0KCk7CiAgc3RhdGUubGVuZ3RoID0gMDsKICB0cnkgewogICAgZm9yIGF3YWl0IChjb25zdCBjaHVuayBvZiBzdHJlYW0yKSB7CiAgICAgIGNvbnN0IGNodW5rVHlwZSA9IGdldENodW5rVHlwZShjaHVuayk7CiAgICAgIGNvbnN0IGNvbnZlcnRlZENodW5rID0gY29udmVydENodW5rW2NodW5rVHlwZV0oY2h1bmssIHN0YXRlKTsKICAgICAgYXBwZW5kQ2h1bmsoeyBjb252ZXJ0ZWRDaHVuaywgc3RhdGUsIGdldFNpemUsIHRydW5jYXRlQ2h1bmssIGFkZENodW5rLCBtYXhCdWZmZXIgfSk7CiAgICB9CiAgICBhcHBlbmRGaW5hbENodW5rKHsgc3RhdGUsIGNvbnZlcnRDaHVuaywgZ2V0U2l6ZSwgdHJ1bmNhdGVDaHVuaywgYWRkQ2h1bmssIGdldEZpbmFsQ2h1bmssIG1heEJ1ZmZlciB9KTsKICAgIHJldHVybiBmaW5hbGl6ZShzdGF0ZSk7CiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIGVycm9yLmJ1ZmZlcmVkRGF0YSA9IGZpbmFsaXplKHN0YXRlKTsKICAgIHRocm93IGVycm9yOwogIH0KfTsKY29uc3QgYXBwZW5kRmluYWxDaHVuayA9ICh7IHN0YXRlLCBnZXRTaXplLCB0cnVuY2F0ZUNodW5rLCBhZGRDaHVuaywgZ2V0RmluYWxDaHVuaywgbWF4QnVmZmVyIH0pID0+IHsKICBjb25zdCBjb252ZXJ0ZWRDaHVuayA9IGdldEZpbmFsQ2h1bmsoc3RhdGUpOwogIGlmIChjb252ZXJ0ZWRDaHVuayAhPT0gdm9pZCAwKSB7CiAgICBhcHBlbmRDaHVuayh7IGNvbnZlcnRlZENodW5rLCBzdGF0ZSwgZ2V0U2l6ZSwgdHJ1bmNhdGVDaHVuaywgYWRkQ2h1bmssIG1heEJ1ZmZlciB9KTsKICB9Cn07CmNvbnN0IGFwcGVuZENodW5rID0gKHsgY29udmVydGVkQ2h1bmssIHN0YXRlLCBnZXRTaXplLCB0cnVuY2F0ZUNodW5rLCBhZGRDaHVuaywgbWF4QnVmZmVyIH0pID0+IHsKICBjb25zdCBjaHVua1NpemUgPSBnZXRTaXplKGNvbnZlcnRlZENodW5rKTsKICBjb25zdCBuZXdMZW5ndGggPSBzdGF0ZS5sZW5ndGggKyBjaHVua1NpemU7CiAgaWYgKG5ld0xlbmd0aCA8PSBtYXhCdWZmZXIpIHsKICAgIGFkZE5ld0NodW5rKGNvbnZlcnRlZENodW5rLCBzdGF0ZSwgYWRkQ2h1bmssIG5ld0xlbmd0aCk7CiAgICByZXR1cm47CiAgfQogIGNvbnN0IHRydW5jYXRlZENodW5rID0gdHJ1bmNhdGVDaHVuayhjb252ZXJ0ZWRDaHVuaywgbWF4QnVmZmVyIC0gc3RhdGUubGVuZ3RoKTsKICBpZiAodHJ1bmNhdGVkQ2h1bmsgIT09IHZvaWQgMCkgewogICAgYWRkTmV3Q2h1bmsodHJ1bmNhdGVkQ2h1bmssIHN0YXRlLCBhZGRDaHVuaywgbWF4QnVmZmVyKTsKICB9CiAgdGhyb3cgbmV3IE1heEJ1ZmZlckVycm9yKCk7Cn07CmNvbnN0IGFkZE5ld0NodW5rID0gKGNvbnZlcnRlZENodW5rLCBzdGF0ZSwgYWRkQ2h1bmssIG5ld0xlbmd0aCkgPT4gewogIHN0YXRlLmNvbnRlbnRzID0gYWRkQ2h1bmsoY29udmVydGVkQ2h1bmssIHN0YXRlLCBuZXdMZW5ndGgpOwogIHN0YXRlLmxlbmd0aCA9IG5ld0xlbmd0aDsKfTsKY29uc3QgaXNBc3luY0l0ZXJhYmxlID0gKHN0cmVhbTIpID0+IHR5cGVvZiBzdHJlYW0yID09PSAib2JqZWN0IiAmJiBzdHJlYW0yICE9PSBudWxsICYmIHR5cGVvZiBzdHJlYW0yW1N5bWJvbC5hc3luY0l0ZXJhdG9yXSA9PT0gImZ1bmN0aW9uIjsKY29uc3QgZ2V0Q2h1bmtUeXBlID0gKGNodW5rKSA9PiB7CiAgY29uc3QgdHlwZU9mQ2h1bmsgPSB0eXBlb2YgY2h1bms7CiAgaWYgKHR5cGVPZkNodW5rID09PSAic3RyaW5nIikgewogICAgcmV0dXJuICJzdHJpbmciOwogIH0KICBpZiAodHlwZU9mQ2h1bmsgIT09ICJvYmplY3QiIHx8IGNodW5rID09PSBudWxsKSB7CiAgICByZXR1cm4gIm90aGVycyI7CiAgfQogIGlmIChnbG9iYWxUaGlzLkJ1ZmZlcj8uaXNCdWZmZXIoY2h1bmspKSB7CiAgICByZXR1cm4gImJ1ZmZlciI7CiAgfQogIGNvbnN0IHByb3RvdHlwZU5hbWUgPSBvYmplY3RUb1N0cmluZy5jYWxsKGNodW5rKTsKICBpZiAocHJvdG90eXBlTmFtZSA9PT0gIltvYmplY3QgQXJyYXlCdWZmZXJdIikgewogICAgcmV0dXJuICJhcnJheUJ1ZmZlciI7CiAgfQogIGlmIChwcm90b3R5cGVOYW1lID09PSAiW29iamVjdCBEYXRhVmlld10iKSB7CiAgICByZXR1cm4gImRhdGFWaWV3IjsKICB9CiAgaWYgKE51bWJlci5pc0ludGVnZXIoY2h1bmsuYnl0ZUxlbmd0aCkgJiYgTnVtYmVyLmlzSW50ZWdlcihjaHVuay5ieXRlT2Zmc2V0KSAmJiBvYmplY3RUb1N0cmluZy5jYWxsKGNodW5rLmJ1ZmZlcikgPT09ICJbb2JqZWN0IEFycmF5QnVmZmVyXSIpIHsKICAgIHJldHVybiAidHlwZWRBcnJheSI7CiAgfQogIHJldHVybiAib3RoZXJzIjsKfTsKY29uc3QgeyB0b1N0cmluZzogb2JqZWN0VG9TdHJpbmcgfSA9IE9iamVjdC5wcm90b3R5cGU7CmNsYXNzIE1heEJ1ZmZlckVycm9yIGV4dGVuZHMgRXJyb3IgewogIG5hbWUgPSAiTWF4QnVmZmVyRXJyb3IiOwogIGNvbnN0cnVjdG9yKCkgewogICAgc3VwZXIoIm1heEJ1ZmZlciBleGNlZWRlZCIpOwogIH0KfQpjb25zdCBpZGVudGl0eSA9ICh2YWx1ZSkgPT4gdmFsdWU7CmNvbnN0IG5vb3AgPSAoKSA9PiB2b2lkIDA7CmNvbnN0IGdldENvbnRlbnRzUHJvcCA9ICh7IGNvbnRlbnRzIH0pID0+IGNvbnRlbnRzOwpjb25zdCB0aHJvd09iamVjdFN0cmVhbSA9IChjaHVuaykgPT4gewogIHRocm93IG5ldyBFcnJvcihgU3RyZWFtcyBpbiBvYmplY3QgbW9kZSBhcmUgbm90IHN1cHBvcnRlZDogJHtTdHJpbmcoY2h1bmspfWApOwp9Owpjb25zdCBnZXRMZW5ndGhQcm9wID0gKGNvbnZlcnRlZENodW5rKSA9PiBjb252ZXJ0ZWRDaHVuay5sZW5ndGg7CmFzeW5jIGZ1bmN0aW9uIGdldFN0cmVhbUFzQXJyYXlCdWZmZXIoc3RyZWFtMiwgb3B0aW9ucykgewogIHJldHVybiBnZXRTdHJlYW1Db250ZW50cyhzdHJlYW0yLCBhcnJheUJ1ZmZlck1ldGhvZHMsIG9wdGlvbnMpOwp9CmNvbnN0IGluaXRBcnJheUJ1ZmZlciA9ICgpID0+ICh7IGNvbnRlbnRzOiBuZXcgQXJyYXlCdWZmZXIoMCkgfSk7CmNvbnN0IHVzZVRleHRFbmNvZGVyID0gKGNodW5rKSA9PiB0ZXh0RW5jb2Rlci5lbmNvZGUoY2h1bmspOwpjb25zdCB0ZXh0RW5jb2RlciA9IG5ldyBUZXh0RW5jb2RlcigpOwpjb25zdCB1c2VVaW50OEFycmF5ID0gKGNodW5rKSA9PiBuZXcgVWludDhBcnJheShjaHVuayk7CmNvbnN0IHVzZVVpbnQ4QXJyYXlXaXRoT2Zmc2V0ID0gKGNodW5rKSA9PiBuZXcgVWludDhBcnJheShjaHVuay5idWZmZXIsIGNodW5rLmJ5dGVPZmZzZXQsIGNodW5rLmJ5dGVMZW5ndGgpOwpjb25zdCB0cnVuY2F0ZUFycmF5QnVmZmVyQ2h1bmsgPSAoY29udmVydGVkQ2h1bmssIGNodW5rU2l6ZSkgPT4gY29udmVydGVkQ2h1bmsuc2xpY2UoMCwgY2h1bmtTaXplKTsKY29uc3QgYWRkQXJyYXlCdWZmZXJDaHVuayA9IChjb252ZXJ0ZWRDaHVuaywgeyBjb250ZW50cywgbGVuZ3RoOiBwcmV2aW91c0xlbmd0aCB9LCBsZW5ndGgpID0+IHsKICBjb25zdCBuZXdDb250ZW50cyA9IGhhc0FycmF5QnVmZmVyUmVzaXplKCkgPyByZXNpemVBcnJheUJ1ZmZlcihjb250ZW50cywgbGVuZ3RoKSA6IHJlc2l6ZUFycmF5QnVmZmVyU2xvdyhjb250ZW50cywgbGVuZ3RoKTsKICBuZXcgVWludDhBcnJheShuZXdDb250ZW50cykuc2V0KGNvbnZlcnRlZENodW5rLCBwcmV2aW91c0xlbmd0aCk7CiAgcmV0dXJuIG5ld0NvbnRlbnRzOwp9Owpjb25zdCByZXNpemVBcnJheUJ1ZmZlclNsb3cgPSAoY29udGVudHMsIGxlbmd0aCkgPT4gewogIGlmIChsZW5ndGggPD0gY29udGVudHMuYnl0ZUxlbmd0aCkgewogICAgcmV0dXJuIGNvbnRlbnRzOwogIH0KICBjb25zdCBhcnJheUJ1ZmZlciA9IG5ldyBBcnJheUJ1ZmZlcihnZXROZXdDb250ZW50c0xlbmd0aChsZW5ndGgpKTsKICBuZXcgVWludDhBcnJheShhcnJheUJ1ZmZlcikuc2V0KG5ldyBVaW50OEFycmF5KGNvbnRlbnRzKSwgMCk7CiAgcmV0dXJuIGFycmF5QnVmZmVyOwp9Owpjb25zdCByZXNpemVBcnJheUJ1ZmZlciA9IChjb250ZW50cywgbGVuZ3RoKSA9PiB7CiAgaWYgKGxlbmd0aCA8PSBjb250ZW50cy5tYXhCeXRlTGVuZ3RoKSB7CiAgICBjb250ZW50cy5yZXNpemUobGVuZ3RoKTsKICAgIHJldHVybiBjb250ZW50czsKICB9CiAgY29uc3QgYXJyYXlCdWZmZXIgPSBuZXcgQXJyYXlCdWZmZXIobGVuZ3RoLCB7IG1heEJ5dGVMZW5ndGg6IGdldE5ld0NvbnRlbnRzTGVuZ3RoKGxlbmd0aCkgfSk7CiAgbmV3IFVpbnQ4QXJyYXkoYXJyYXlCdWZmZXIpLnNldChuZXcgVWludDhBcnJheShjb250ZW50cyksIDApOwogIHJldHVybiBhcnJheUJ1ZmZlcjsKfTsKY29uc3QgZ2V0TmV3Q29udGVudHNMZW5ndGggPSAobGVuZ3RoKSA9PiBTQ0FMRV9GQUNUT1IgKiogTWF0aC5jZWlsKE1hdGgubG9nKGxlbmd0aCkgLyBNYXRoLmxvZyhTQ0FMRV9GQUNUT1IpKTsKY29uc3QgU0NBTEVfRkFDVE9SID0gMjsKY29uc3QgZmluYWxpemVBcnJheUJ1ZmZlciA9ICh7IGNvbnRlbnRzLCBsZW5ndGggfSkgPT4gaGFzQXJyYXlCdWZmZXJSZXNpemUoKSA/IGNvbnRlbnRzIDogY29udGVudHMuc2xpY2UoMCwgbGVuZ3RoKTsKY29uc3QgaGFzQXJyYXlCdWZmZXJSZXNpemUgPSAoKSA9PiAicmVzaXplIiBpbiBBcnJheUJ1ZmZlci5wcm90b3R5cGU7CmNvbnN0IGFycmF5QnVmZmVyTWV0aG9kcyA9IHsKICBpbml0OiBpbml0QXJyYXlCdWZmZXIsCiAgY29udmVydENodW5rOiB7CiAgICBzdHJpbmc6IHVzZVRleHRFbmNvZGVyLAogICAgYnVmZmVyOiB1c2VVaW50OEFycmF5LAogICAgYXJyYXlCdWZmZXI6IHVzZVVpbnQ4QXJyYXksCiAgICBkYXRhVmlldzogdXNlVWludDhBcnJheVdpdGhPZmZzZXQsCiAgICB0eXBlZEFycmF5OiB1c2VVaW50OEFycmF5V2l0aE9mZnNldCwKICAgIG90aGVyczogdGhyb3dPYmplY3RTdHJlYW0KICB9LAogIGdldFNpemU6IGdldExlbmd0aFByb3AsCiAgdHJ1bmNhdGVDaHVuazogdHJ1bmNhdGVBcnJheUJ1ZmZlckNodW5rLAogIGFkZENodW5rOiBhZGRBcnJheUJ1ZmZlckNodW5rLAogIGdldEZpbmFsQ2h1bms6IG5vb3AsCiAgZmluYWxpemU6IGZpbmFsaXplQXJyYXlCdWZmZXIKfTsKYXN5bmMgZnVuY3Rpb24gZ2V0U3RyZWFtQXNCdWZmZXIoc3RyZWFtMiwgb3B0aW9ucykgewogIGlmICghKCJCdWZmZXIiIGluIGdsb2JhbFRoaXMpKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoImdldFN0cmVhbUFzQnVmZmVyKCkgaXMgb25seSBzdXBwb3J0ZWQgaW4gTm9kZS5qcyIpOwogIH0KICB0cnkgewogICAgcmV0dXJuIGFycmF5QnVmZmVyVG9Ob2RlQnVmZmVyKGF3YWl0IGdldFN0cmVhbUFzQXJyYXlCdWZmZXIoc3RyZWFtMiwgb3B0aW9ucykpOwogIH0gY2F0Y2ggKGVycm9yKSB7CiAgICBpZiAoZXJyb3IuYnVmZmVyZWREYXRhICE9PSB2b2lkIDApIHsKICAgICAgZXJyb3IuYnVmZmVyZWREYXRhID0gYXJyYXlCdWZmZXJUb05vZGVCdWZmZXIoZXJyb3IuYnVmZmVyZWREYXRhKTsKICAgIH0KICAgIHRocm93IGVycm9yOwogIH0KfQpjb25zdCBhcnJheUJ1ZmZlclRvTm9kZUJ1ZmZlciA9IChhcnJheUJ1ZmZlcikgPT4gZ2xvYmFsVGhpcy5CdWZmZXIuZnJvbShhcnJheUJ1ZmZlcik7CmFzeW5jIGZ1bmN0aW9uIGdldFN0cmVhbUFzU3RyaW5nKHN0cmVhbTIsIG9wdGlvbnMpIHsKICByZXR1cm4gZ2V0U3RyZWFtQ29udGVudHMoc3RyZWFtMiwgc3RyaW5nTWV0aG9kcywgb3B0aW9ucyk7Cn0KY29uc3QgaW5pdFN0cmluZyA9ICgpID0+ICh7IGNvbnRlbnRzOiAiIiwgdGV4dERlY29kZXI6IG5ldyBUZXh0RGVjb2RlcigpIH0pOwpjb25zdCB1c2VUZXh0RGVjb2RlciA9IChjaHVuaywgeyB0ZXh0RGVjb2RlciB9KSA9PiB0ZXh0RGVjb2Rlci5kZWNvZGUoY2h1bmssIHsgc3RyZWFtOiB0cnVlIH0pOwpjb25zdCBhZGRTdHJpbmdDaHVuayA9IChjb252ZXJ0ZWRDaHVuaywgeyBjb250ZW50cyB9KSA9PiBjb250ZW50cyArIGNvbnZlcnRlZENodW5rOwpjb25zdCB0cnVuY2F0ZVN0cmluZ0NodW5rID0gKGNvbnZlcnRlZENodW5rLCBjaHVua1NpemUpID0+IGNvbnZlcnRlZENodW5rLnNsaWNlKDAsIGNodW5rU2l6ZSk7CmNvbnN0IGdldEZpbmFsU3RyaW5nQ2h1bmsgPSAoeyB0ZXh0RGVjb2RlciB9KSA9PiB7CiAgY29uc3QgZmluYWxDaHVuayA9IHRleHREZWNvZGVyLmRlY29kZSgpOwogIHJldHVybiBmaW5hbENodW5rID09PSAiIiA/IHZvaWQgMCA6IGZpbmFsQ2h1bms7Cn07CmNvbnN0IHN0cmluZ01ldGhvZHMgPSB7CiAgaW5pdDogaW5pdFN0cmluZywKICBjb252ZXJ0Q2h1bms6IHsKICAgIHN0cmluZzogaWRlbnRpdHksCiAgICBidWZmZXI6IHVzZVRleHREZWNvZGVyLAogICAgYXJyYXlCdWZmZXI6IHVzZVRleHREZWNvZGVyLAogICAgZGF0YVZpZXc6IHVzZVRleHREZWNvZGVyLAogICAgdHlwZWRBcnJheTogdXNlVGV4dERlY29kZXIsCiAgICBvdGhlcnM6IHRocm93T2JqZWN0U3RyZWFtCiAgfSwKICBnZXRTaXplOiBnZXRMZW5ndGhQcm9wLAogIHRydW5jYXRlQ2h1bms6IHRydW5jYXRlU3RyaW5nQ2h1bmssCiAgYWRkQ2h1bms6IGFkZFN0cmluZ0NodW5rLAogIGdldEZpbmFsQ2h1bms6IGdldEZpbmFsU3RyaW5nQ2h1bmssCiAgZmluYWxpemU6IGdldENvbnRlbnRzUHJvcAp9Owpjb25zdCB7IFBhc3NUaHJvdWdoIH0gPSBTdHJlYW07CnZhciBtZXJnZVN0cmVhbSA9IGZ1bmN0aW9uKCkgewogIHZhciBzb3VyY2VzID0gW107CiAgdmFyIG91dHB1dCA9IG5ldyBQYXNzVGhyb3VnaCh7IG9iamVjdE1vZGU6IHRydWUgfSk7CiAgb3V0cHV0LnNldE1heExpc3RlbmVycygwKTsKICBvdXRwdXQuYWRkID0gYWRkOwogIG91dHB1dC5pc0VtcHR5ID0gaXNFbXB0eTsKICBvdXRwdXQub24oInVucGlwZSIsIHJlbW92ZSk7CiAgQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKS5mb3JFYWNoKGFkZCk7CiAgcmV0dXJuIG91dHB1dDsKICBmdW5jdGlvbiBhZGQoc291cmNlKSB7CiAgICBpZiAoQXJyYXkuaXNBcnJheShzb3VyY2UpKSB7CiAgICAgIHNvdXJjZS5mb3JFYWNoKGFkZCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgc291cmNlcy5wdXNoKHNvdXJjZSk7CiAgICBzb3VyY2Uub25jZSgiZW5kIiwgcmVtb3ZlLmJpbmQobnVsbCwgc291cmNlKSk7CiAgICBzb3VyY2Uub25jZSgiZXJyb3IiLCBvdXRwdXQuZW1pdC5iaW5kKG91dHB1dCwgImVycm9yIikpOwogICAgc291cmNlLnBpcGUob3V0cHV0LCB7IGVuZDogZmFsc2UgfSk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgZnVuY3Rpb24gaXNFbXB0eSgpIHsKICAgIHJldHVybiBzb3VyY2VzLmxlbmd0aCA9PSAwOwogIH0KICBmdW5jdGlvbiByZW1vdmUoc291cmNlKSB7CiAgICBzb3VyY2VzID0gc291cmNlcy5maWx0ZXIoZnVuY3Rpb24oaXQpIHsKICAgICAgcmV0dXJuIGl0ICE9PSBzb3VyY2U7CiAgICB9KTsKICAgIGlmICghc291cmNlcy5sZW5ndGggJiYgb3V0cHV0LnJlYWRhYmxlKSB7CiAgICAgIG91dHB1dC5lbmQoKTsKICAgIH0KICB9Cn07CmNvbnN0IG1lcmdlU3RyZWFtJDEgPSAvKiBAX19QVVJFX18gKi8gZ2V0RGVmYXVsdEV4cG9ydEZyb21DanMobWVyZ2VTdHJlYW0pOwpjb25zdCB2YWxpZGF0ZUlucHV0T3B0aW9ucyA9IChpbnB1dCkgPT4gewogIGlmIChpbnB1dCAhPT0gdm9pZCAwKSB7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJUaGUgYGlucHV0YCBhbmQgYGlucHV0RmlsZWAgb3B0aW9ucyBjYW5ub3QgYmUgYm90aCBzZXQuIik7CiAgfQp9Owpjb25zdCBnZXRJbnB1dFN5bmMgPSAoeyBpbnB1dCwgaW5wdXRGaWxlIH0pID0+IHsKICBpZiAodHlwZW9mIGlucHV0RmlsZSAhPT0gInN0cmluZyIpIHsKICAgIHJldHVybiBpbnB1dDsKICB9CiAgdmFsaWRhdGVJbnB1dE9wdGlvbnMoaW5wdXQpOwogIHJldHVybiByZWFkRmlsZVN5bmMoaW5wdXRGaWxlKTsKfTsKY29uc3QgaGFuZGxlSW5wdXRTeW5jID0gKG9wdGlvbnMpID0+IHsKICBjb25zdCBpbnB1dCA9IGdldElucHV0U3luYyhvcHRpb25zKTsKICBpZiAoaXNTdHJlYW0kMShpbnB1dCkpIHsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIlRoZSBgaW5wdXRgIG9wdGlvbiBjYW5ub3QgYmUgYSBzdHJlYW0gaW4gc3luYyBtb2RlIik7CiAgfQogIHJldHVybiBpbnB1dDsKfTsKY29uc3QgZ2V0SW5wdXQgPSAoeyBpbnB1dCwgaW5wdXRGaWxlIH0pID0+IHsKICBpZiAodHlwZW9mIGlucHV0RmlsZSAhPT0gInN0cmluZyIpIHsKICAgIHJldHVybiBpbnB1dDsKICB9CiAgdmFsaWRhdGVJbnB1dE9wdGlvbnMoaW5wdXQpOwogIHJldHVybiBjcmVhdGVSZWFkU3RyZWFtKGlucHV0RmlsZSk7Cn07CmNvbnN0IGhhbmRsZUlucHV0ID0gKHNwYXduZWQsIG9wdGlvbnMpID0+IHsKICBjb25zdCBpbnB1dCA9IGdldElucHV0KG9wdGlvbnMpOwogIGlmIChpbnB1dCA9PT0gdm9pZCAwKSB7CiAgICByZXR1cm47CiAgfQogIGlmIChpc1N0cmVhbSQxKGlucHV0KSkgewogICAgaW5wdXQucGlwZShzcGF3bmVkLnN0ZGluKTsKICB9IGVsc2UgewogICAgc3Bhd25lZC5zdGRpbi5lbmQoaW5wdXQpOwogIH0KfTsKY29uc3QgbWFrZUFsbFN0cmVhbSA9IChzcGF3bmVkLCB7IGFsbCB9KSA9PiB7CiAgaWYgKCFhbGwgfHwgIXNwYXduZWQuc3Rkb3V0ICYmICFzcGF3bmVkLnN0ZGVycikgewogICAgcmV0dXJuOwogIH0KICBjb25zdCBtaXhlZCA9IG1lcmdlU3RyZWFtJDEoKTsKICBpZiAoc3Bhd25lZC5zdGRvdXQpIHsKICAgIG1peGVkLmFkZChzcGF3bmVkLnN0ZG91dCk7CiAgfQogIGlmIChzcGF3bmVkLnN0ZGVycikgewogICAgbWl4ZWQuYWRkKHNwYXduZWQuc3RkZXJyKTsKICB9CiAgcmV0dXJuIG1peGVkOwp9Owpjb25zdCBnZXRCdWZmZXJlZERhdGEgPSBhc3luYyAoc3RyZWFtMiwgc3RyZWFtUHJvbWlzZSkgPT4gewogIGlmICghc3RyZWFtMiB8fCBzdHJlYW1Qcm9taXNlID09PSB2b2lkIDApIHsKICAgIHJldHVybjsKICB9CiAgYXdhaXQgc2V0VGltZW91dCQxKDApOwogIHN0cmVhbTIuZGVzdHJveSgpOwogIHRyeSB7CiAgICByZXR1cm4gYXdhaXQgc3RyZWFtUHJvbWlzZTsKICB9IGNhdGNoIChlcnJvcikgewogICAgcmV0dXJuIGVycm9yLmJ1ZmZlcmVkRGF0YTsKICB9Cn07CmNvbnN0IGdldFN0cmVhbVByb21pc2UgPSAoc3RyZWFtMiwgeyBlbmNvZGluZywgYnVmZmVyLCBtYXhCdWZmZXIgfSkgPT4gewogIGlmICghc3RyZWFtMiB8fCAhYnVmZmVyKSB7CiAgICByZXR1cm47CiAgfQogIGlmIChlbmNvZGluZyA9PT0gInV0ZjgiIHx8IGVuY29kaW5nID09PSAidXRmLTgiKSB7CiAgICByZXR1cm4gZ2V0U3RyZWFtQXNTdHJpbmcoc3RyZWFtMiwgeyBtYXhCdWZmZXIgfSk7CiAgfQogIGlmIChlbmNvZGluZyA9PT0gbnVsbCB8fCBlbmNvZGluZyA9PT0gImJ1ZmZlciIpIHsKICAgIHJldHVybiBnZXRTdHJlYW1Bc0J1ZmZlcihzdHJlYW0yLCB7IG1heEJ1ZmZlciB9KTsKICB9CiAgcmV0dXJuIGFwcGx5RW5jb2Rpbmcoc3RyZWFtMiwgbWF4QnVmZmVyLCBlbmNvZGluZyk7Cn07CmNvbnN0IGFwcGx5RW5jb2RpbmcgPSBhc3luYyAoc3RyZWFtMiwgbWF4QnVmZmVyLCBlbmNvZGluZykgPT4gewogIGNvbnN0IGJ1ZmZlciA9IGF3YWl0IGdldFN0cmVhbUFzQnVmZmVyKHN0cmVhbTIsIHsgbWF4QnVmZmVyIH0pOwogIHJldHVybiBidWZmZXIudG9TdHJpbmcoZW5jb2RpbmcpOwp9Owpjb25zdCBnZXRTcGF3bmVkUmVzdWx0ID0gYXN5bmMgKHsgc3Rkb3V0LCBzdGRlcnIsIGFsbCB9LCB7IGVuY29kaW5nLCBidWZmZXIsIG1heEJ1ZmZlciB9LCBwcm9jZXNzRG9uZSkgPT4gewogIGNvbnN0IHN0ZG91dFByb21pc2UgPSBnZXRTdHJlYW1Qcm9taXNlKHN0ZG91dCwgeyBlbmNvZGluZywgYnVmZmVyLCBtYXhCdWZmZXIgfSk7CiAgY29uc3Qgc3RkZXJyUHJvbWlzZSA9IGdldFN0cmVhbVByb21pc2Uoc3RkZXJyLCB7IGVuY29kaW5nLCBidWZmZXIsIG1heEJ1ZmZlciB9KTsKICBjb25zdCBhbGxQcm9taXNlID0gZ2V0U3RyZWFtUHJvbWlzZShhbGwsIHsgZW5jb2RpbmcsIGJ1ZmZlciwgbWF4QnVmZmVyOiBtYXhCdWZmZXIgKiAyIH0pOwogIHRyeSB7CiAgICByZXR1cm4gYXdhaXQgUHJvbWlzZS5hbGwoW3Byb2Nlc3NEb25lLCBzdGRvdXRQcm9taXNlLCBzdGRlcnJQcm9taXNlLCBhbGxQcm9taXNlXSk7CiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIHJldHVybiBQcm9taXNlLmFsbChbCiAgICAgIHsgZXJyb3IsIHNpZ25hbDogZXJyb3Iuc2lnbmFsLCB0aW1lZE91dDogZXJyb3IudGltZWRPdXQgfSwKICAgICAgZ2V0QnVmZmVyZWREYXRhKHN0ZG91dCwgc3Rkb3V0UHJvbWlzZSksCiAgICAgIGdldEJ1ZmZlcmVkRGF0YShzdGRlcnIsIHN0ZGVyclByb21pc2UpLAogICAgICBnZXRCdWZmZXJlZERhdGEoYWxsLCBhbGxQcm9taXNlKQogICAgXSk7CiAgfQp9Owpjb25zdCBuYXRpdmVQcm9taXNlUHJvdG90eXBlID0gKC8qIEBfX1BVUkVfXyAqLyAoYXN5bmMgKCkgPT4gewp9KSgpKS5jb25zdHJ1Y3Rvci5wcm90b3R5cGU7CmNvbnN0IGRlc2NyaXB0b3JzID0gWyJ0aGVuIiwgImNhdGNoIiwgImZpbmFsbHkiXS5tYXAoKHByb3BlcnR5KSA9PiBbCiAgcHJvcGVydHksCiAgUmVmbGVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IobmF0aXZlUHJvbWlzZVByb3RvdHlwZSwgcHJvcGVydHkpCl0pOwpjb25zdCBtZXJnZVByb21pc2UgPSAoc3Bhd25lZCwgcHJvbWlzZSkgPT4gewogIGZvciAoY29uc3QgW3Byb3BlcnR5LCBkZXNjcmlwdG9yXSBvZiBkZXNjcmlwdG9ycykgewogICAgY29uc3QgdmFsdWUgPSB0eXBlb2YgcHJvbWlzZSA9PT0gImZ1bmN0aW9uIiA/ICguLi5hcmdzKSA9PiBSZWZsZWN0LmFwcGx5KGRlc2NyaXB0b3IudmFsdWUsIHByb21pc2UoKSwgYXJncykgOiBkZXNjcmlwdG9yLnZhbHVlLmJpbmQocHJvbWlzZSk7CiAgICBSZWZsZWN0LmRlZmluZVByb3BlcnR5KHNwYXduZWQsIHByb3BlcnR5LCB7IC4uLmRlc2NyaXB0b3IsIHZhbHVlIH0pOwogIH0KfTsKY29uc3QgZ2V0U3Bhd25lZFByb21pc2UgPSAoc3Bhd25lZCkgPT4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogIHNwYXduZWQub24oImV4aXQiLCAoZXhpdENvZGUsIHNpZ25hbCkgPT4gewogICAgcmVzb2x2ZSh7IGV4aXRDb2RlLCBzaWduYWwgfSk7CiAgfSk7CiAgc3Bhd25lZC5vbigiZXJyb3IiLCAoZXJyb3IpID0+IHsKICAgIHJlamVjdChlcnJvcik7CiAgfSk7CiAgaWYgKHNwYXduZWQuc3RkaW4pIHsKICAgIHNwYXduZWQuc3RkaW4ub24oImVycm9yIiwgKGVycm9yKSA9PiB7CiAgICAgIHJlamVjdChlcnJvcik7CiAgICB9KTsKICB9Cn0pOwpjb25zdCBub3JtYWxpemVBcmdzID0gKGZpbGUsIGFyZ3MgPSBbXSkgPT4gewogIGlmICghQXJyYXkuaXNBcnJheShhcmdzKSkgewogICAgcmV0dXJuIFtmaWxlXTsKICB9CiAgcmV0dXJuIFtmaWxlLCAuLi5hcmdzXTsKfTsKY29uc3QgTk9fRVNDQVBFX1JFR0VYUCA9IC9eW1x3Li1dKyQvOwpjb25zdCBlc2NhcGVBcmcgPSAoYXJnKSA9PiB7CiAgaWYgKHR5cGVvZiBhcmcgIT09ICJzdHJpbmciIHx8IE5PX0VTQ0FQRV9SRUdFWFAudGVzdChhcmcpKSB7CiAgICByZXR1cm4gYXJnOwogIH0KICByZXR1cm4gYCIke2FyZy5yZXBsYWNlQWxsKCciJywgJ1xcIicpfSJgOwp9Owpjb25zdCBqb2luQ29tbWFuZCA9IChmaWxlLCBhcmdzKSA9PiBub3JtYWxpemVBcmdzKGZpbGUsIGFyZ3MpLmpvaW4oIiAiKTsKY29uc3QgZ2V0RXNjYXBlZENvbW1hbmQgPSAoZmlsZSwgYXJncykgPT4gbm9ybWFsaXplQXJncyhmaWxlLCBhcmdzKS5tYXAoKGFyZykgPT4gZXNjYXBlQXJnKGFyZykpLmpvaW4oIiAiKTsKY29uc3QgU1BBQ0VTX1JFR0VYUCA9IC8gKy9nOwpjb25zdCBwYXJzZUV4cHJlc3Npb24gPSAoZXhwcmVzc2lvbikgPT4gewogIGNvbnN0IHR5cGVPZkV4cHJlc3Npb24gPSB0eXBlb2YgZXhwcmVzc2lvbjsKICBpZiAodHlwZU9mRXhwcmVzc2lvbiA9PT0gInN0cmluZyIpIHsKICAgIHJldHVybiBleHByZXNzaW9uOwogIH0KICBpZiAodHlwZU9mRXhwcmVzc2lvbiA9PT0gIm51bWJlciIpIHsKICAgIHJldHVybiBTdHJpbmcoZXhwcmVzc2lvbik7CiAgfQogIGlmICh0eXBlT2ZFeHByZXNzaW9uID09PSAib2JqZWN0IiAmJiBleHByZXNzaW9uICE9PSBudWxsICYmICEoZXhwcmVzc2lvbiBpbnN0YW5jZW9mIENoaWxkUHJvY2VzcykgJiYgInN0ZG91dCIgaW4gZXhwcmVzc2lvbikgewogICAgY29uc3QgdHlwZU9mU3Rkb3V0ID0gdHlwZW9mIGV4cHJlc3Npb24uc3Rkb3V0OwogICAgaWYgKHR5cGVPZlN0ZG91dCA9PT0gInN0cmluZyIpIHsKICAgICAgcmV0dXJuIGV4cHJlc3Npb24uc3Rkb3V0OwogICAgfQogICAgaWYgKEJ1ZmZlciQxLmlzQnVmZmVyKGV4cHJlc3Npb24uc3Rkb3V0KSkgewogICAgICByZXR1cm4gZXhwcmVzc2lvbi5zdGRvdXQudG9TdHJpbmcoKTsKICAgIH0KICAgIHRocm93IG5ldyBUeXBlRXJyb3IoYFVuZXhwZWN0ZWQgIiR7dHlwZU9mU3Rkb3V0fSIgc3Rkb3V0IGluIHRlbXBsYXRlIGV4cHJlc3Npb25gKTsKICB9CiAgdGhyb3cgbmV3IFR5cGVFcnJvcihgVW5leHBlY3RlZCAiJHt0eXBlT2ZFeHByZXNzaW9ufSIgaW4gdGVtcGxhdGUgZXhwcmVzc2lvbmApOwp9Owpjb25zdCBjb25jYXRUb2tlbnMgPSAodG9rZW5zLCBuZXh0VG9rZW5zLCBpc05ldykgPT4gaXNOZXcgfHwgdG9rZW5zLmxlbmd0aCA9PT0gMCB8fCBuZXh0VG9rZW5zLmxlbmd0aCA9PT0gMCA/IFsuLi50b2tlbnMsIC4uLm5leHRUb2tlbnNdIDogWwogIC4uLnRva2Vucy5zbGljZSgwLCAtMSksCiAgYCR7dG9rZW5zLmF0KC0xKX0ke25leHRUb2tlbnNbMF19YCwKICAuLi5uZXh0VG9rZW5zLnNsaWNlKDEpCl07CmNvbnN0IHBhcnNlVGVtcGxhdGUgPSAoeyB0ZW1wbGF0ZXMsIGV4cHJlc3Npb25zLCB0b2tlbnMsIGluZGV4LCB0ZW1wbGF0ZSB9KSA9PiB7CiAgY29uc3QgdGVtcGxhdGVTdHJpbmcgPSB0ZW1wbGF0ZSA/PyB0ZW1wbGF0ZXMucmF3W2luZGV4XTsKICBjb25zdCB0ZW1wbGF0ZVRva2VucyA9IHRlbXBsYXRlU3RyaW5nLnNwbGl0KFNQQUNFU19SRUdFWFApLmZpbHRlcihCb29sZWFuKTsKICBjb25zdCBuZXdUb2tlbnMgPSBjb25jYXRUb2tlbnMoCiAgICB0b2tlbnMsCiAgICB0ZW1wbGF0ZVRva2VucywKICAgIHRlbXBsYXRlU3RyaW5nLnN0YXJ0c1dpdGgoIiAiKQogICk7CiAgaWYgKGluZGV4ID09PSBleHByZXNzaW9ucy5sZW5ndGgpIHsKICAgIHJldHVybiBuZXdUb2tlbnM7CiAgfQogIGNvbnN0IGV4cHJlc3Npb24gPSBleHByZXNzaW9uc1tpbmRleF07CiAgY29uc3QgZXhwcmVzc2lvblRva2VucyA9IEFycmF5LmlzQXJyYXkoZXhwcmVzc2lvbikgPyBleHByZXNzaW9uLm1hcCgoZXhwcmVzc2lvbjIpID0+IHBhcnNlRXhwcmVzc2lvbihleHByZXNzaW9uMikpIDogW3BhcnNlRXhwcmVzc2lvbihleHByZXNzaW9uKV07CiAgcmV0dXJuIGNvbmNhdFRva2VucygKICAgIG5ld1Rva2VucywKICAgIGV4cHJlc3Npb25Ub2tlbnMsCiAgICB0ZW1wbGF0ZVN0cmluZy5lbmRzV2l0aCgiICIpCiAgKTsKfTsKY29uc3QgcGFyc2VUZW1wbGF0ZXMgPSAodGVtcGxhdGVzLCBleHByZXNzaW9ucykgPT4gewogIGxldCB0b2tlbnMgPSBbXTsKICBmb3IgKGNvbnN0IFtpbmRleCwgdGVtcGxhdGVdIG9mIHRlbXBsYXRlcy5lbnRyaWVzKCkpIHsKICAgIHRva2VucyA9IHBhcnNlVGVtcGxhdGUoeyB0ZW1wbGF0ZXMsIGV4cHJlc3Npb25zLCB0b2tlbnMsIGluZGV4LCB0ZW1wbGF0ZSB9KTsKICB9CiAgcmV0dXJuIHRva2VuczsKfTsKY29uc3QgdmVyYm9zZURlZmF1bHQgPSBkZWJ1Z2xvZygiZXhlY2EiKS5lbmFibGVkOwpjb25zdCBwYWRGaWVsZCA9IChmaWVsZCwgcGFkZGluZykgPT4gU3RyaW5nKGZpZWxkKS5wYWRTdGFydChwYWRkaW5nLCAiMCIpOwpjb25zdCBnZXRUaW1lc3RhbXAgPSAoKSA9PiB7CiAgY29uc3QgZGF0ZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgpOwogIHJldHVybiBgJHtwYWRGaWVsZChkYXRlLmdldEhvdXJzKCksIDIpfToke3BhZEZpZWxkKGRhdGUuZ2V0TWludXRlcygpLCAyKX06JHtwYWRGaWVsZChkYXRlLmdldFNlY29uZHMoKSwgMil9LiR7cGFkRmllbGQoZGF0ZS5nZXRNaWxsaXNlY29uZHMoKSwgMyl9YDsKfTsKY29uc3QgbG9nQ29tbWFuZCA9IChlc2NhcGVkQ29tbWFuZCwgeyB2ZXJib3NlIH0pID0+IHsKICBpZiAoIXZlcmJvc2UpIHsKICAgIHJldHVybjsKICB9CiAgcHJvY2VzcyQyLnN0ZGVyci53cml0ZShgWyR7Z2V0VGltZXN0YW1wKCl9XSAke2VzY2FwZWRDb21tYW5kfQpgKTsKfTsKY29uc3QgREVGQVVMVF9NQVhfQlVGRkVSID0gMWUzICogMWUzICogMTAwOwpjb25zdCBnZXRFbnYgPSAoeyBlbnY6IGVudk9wdGlvbiwgZXh0ZW5kRW52LCBwcmVmZXJMb2NhbCwgbG9jYWxEaXIsIGV4ZWNQYXRoIH0pID0+IHsKICBjb25zdCBlbnYgPSBleHRlbmRFbnYgPyB7IC4uLnByb2Nlc3MkMi5lbnYsIC4uLmVudk9wdGlvbiB9IDogZW52T3B0aW9uOwogIGlmIChwcmVmZXJMb2NhbCkgewogICAgcmV0dXJuIG5wbVJ1blBhdGhFbnYoeyBlbnYsIGN3ZDogbG9jYWxEaXIsIGV4ZWNQYXRoIH0pOwogIH0KICByZXR1cm4gZW52Owp9Owpjb25zdCBoYW5kbGVBcmd1bWVudHMgPSAoZmlsZSwgYXJncywgb3B0aW9ucyA9IHt9KSA9PiB7CiAgY29uc3QgcGFyc2VkID0gY3Jvc3NTcGF3bi5fcGFyc2UoZmlsZSwgYXJncywgb3B0aW9ucyk7CiAgZmlsZSA9IHBhcnNlZC5jb21tYW5kOwogIGFyZ3MgPSBwYXJzZWQuYXJnczsKICBvcHRpb25zID0gcGFyc2VkLm9wdGlvbnM7CiAgb3B0aW9ucyA9IHsKICAgIG1heEJ1ZmZlcjogREVGQVVMVF9NQVhfQlVGRkVSLAogICAgYnVmZmVyOiB0cnVlLAogICAgc3RyaXBGaW5hbE5ld2xpbmU6IHRydWUsCiAgICBleHRlbmRFbnY6IHRydWUsCiAgICBwcmVmZXJMb2NhbDogZmFsc2UsCiAgICBsb2NhbERpcjogb3B0aW9ucy5jd2QgfHwgcHJvY2VzcyQyLmN3ZCgpLAogICAgZXhlY1BhdGg6IHByb2Nlc3MkMi5leGVjUGF0aCwKICAgIGVuY29kaW5nOiAidXRmOCIsCiAgICByZWplY3Q6IHRydWUsCiAgICBjbGVhbnVwOiB0cnVlLAogICAgYWxsOiBmYWxzZSwKICAgIHdpbmRvd3NIaWRlOiB0cnVlLAogICAgdmVyYm9zZTogdmVyYm9zZURlZmF1bHQsCiAgICAuLi5vcHRpb25zCiAgfTsKICBvcHRpb25zLmVudiA9IGdldEVudihvcHRpb25zKTsKICBvcHRpb25zLnN0ZGlvID0gbm9ybWFsaXplU3RkaW8ob3B0aW9ucyk7CiAgaWYgKHByb2Nlc3MkMi5wbGF0Zm9ybSA9PT0gIndpbjMyIiAmJiBwYXRoJDQuYmFzZW5hbWUoZmlsZSwgIi5leGUiKSA9PT0gImNtZCIpIHsKICAgIGFyZ3MudW5zaGlmdCgiL3EiKTsKICB9CiAgcmV0dXJuIHsgZmlsZSwgYXJncywgb3B0aW9ucywgcGFyc2VkIH07Cn07CmNvbnN0IGhhbmRsZU91dHB1dCA9IChvcHRpb25zLCB2YWx1ZSwgZXJyb3IpID0+IHsKICBpZiAodHlwZW9mIHZhbHVlICE9PSAic3RyaW5nIiAmJiAhQnVmZmVyJDEuaXNCdWZmZXIodmFsdWUpKSB7CiAgICByZXR1cm4gZXJyb3IgPT09IHZvaWQgMCA/IHZvaWQgMCA6ICIiOwogIH0KICBpZiAob3B0aW9ucy5zdHJpcEZpbmFsTmV3bGluZSkgewogICAgcmV0dXJuIHN0cmlwRmluYWxOZXdsaW5lKHZhbHVlKTsKICB9CiAgcmV0dXJuIHZhbHVlOwp9OwpmdW5jdGlvbiBleGVjYShmaWxlLCBhcmdzLCBvcHRpb25zKSB7CiAgY29uc3QgcGFyc2VkID0gaGFuZGxlQXJndW1lbnRzKGZpbGUsIGFyZ3MsIG9wdGlvbnMpOwogIGNvbnN0IGNvbW1hbmQyID0gam9pbkNvbW1hbmQoZmlsZSwgYXJncyk7CiAgY29uc3QgZXNjYXBlZENvbW1hbmQgPSBnZXRFc2NhcGVkQ29tbWFuZChmaWxlLCBhcmdzKTsKICBsb2dDb21tYW5kKGVzY2FwZWRDb21tYW5kLCBwYXJzZWQub3B0aW9ucyk7CiAgdmFsaWRhdGVUaW1lb3V0KHBhcnNlZC5vcHRpb25zKTsKICBsZXQgc3Bhd25lZDsKICB0cnkgewogICAgc3Bhd25lZCA9IGNoaWxkUHJvY2Vzcy5zcGF3bihwYXJzZWQuZmlsZSwgcGFyc2VkLmFyZ3MsIHBhcnNlZC5vcHRpb25zKTsKICB9IGNhdGNoIChlcnJvcikgewogICAgY29uc3QgZHVtbXlTcGF3bmVkID0gbmV3IGNoaWxkUHJvY2Vzcy5DaGlsZFByb2Nlc3MoKTsKICAgIGNvbnN0IGVycm9yUHJvbWlzZSA9IFByb21pc2UucmVqZWN0KG1ha2VFcnJvcih7CiAgICAgIGVycm9yLAogICAgICBzdGRvdXQ6ICIiLAogICAgICBzdGRlcnI6ICIiLAogICAgICBhbGw6ICIiLAogICAgICBjb21tYW5kOiBjb21tYW5kMiwKICAgICAgZXNjYXBlZENvbW1hbmQsCiAgICAgIHBhcnNlZCwKICAgICAgdGltZWRPdXQ6IGZhbHNlLAogICAgICBpc0NhbmNlbGVkOiBmYWxzZSwKICAgICAga2lsbGVkOiBmYWxzZQogICAgfSkpOwogICAgbWVyZ2VQcm9taXNlKGR1bW15U3Bhd25lZCwgZXJyb3JQcm9taXNlKTsKICAgIHJldHVybiBkdW1teVNwYXduZWQ7CiAgfQogIGNvbnN0IHNwYXduZWRQcm9taXNlID0gZ2V0U3Bhd25lZFByb21pc2Uoc3Bhd25lZCk7CiAgY29uc3QgdGltZWRQcm9taXNlID0gc2V0dXBUaW1lb3V0KHNwYXduZWQsIHBhcnNlZC5vcHRpb25zLCBzcGF3bmVkUHJvbWlzZSk7CiAgY29uc3QgcHJvY2Vzc0RvbmUgPSBzZXRFeGl0SGFuZGxlcihzcGF3bmVkLCBwYXJzZWQub3B0aW9ucywgdGltZWRQcm9taXNlKTsKICBjb25zdCBjb250ZXh0ID0geyBpc0NhbmNlbGVkOiBmYWxzZSB9OwogIHNwYXduZWQua2lsbCA9IHNwYXduZWRLaWxsLmJpbmQobnVsbCwgc3Bhd25lZC5raWxsLmJpbmQoc3Bhd25lZCkpOwogIHNwYXduZWQuY2FuY2VsID0gc3Bhd25lZENhbmNlbC5iaW5kKG51bGwsIHNwYXduZWQsIGNvbnRleHQpOwogIGNvbnN0IGhhbmRsZVByb21pc2UgPSBhc3luYyAoKSA9PiB7CiAgICBjb25zdCBbeyBlcnJvciwgZXhpdENvZGUsIHNpZ25hbCwgdGltZWRPdXQgfSwgc3Rkb3V0UmVzdWx0LCBzdGRlcnJSZXN1bHQsIGFsbFJlc3VsdF0gPSBhd2FpdCBnZXRTcGF3bmVkUmVzdWx0KHNwYXduZWQsIHBhcnNlZC5vcHRpb25zLCBwcm9jZXNzRG9uZSk7CiAgICBjb25zdCBzdGRvdXQgPSBoYW5kbGVPdXRwdXQocGFyc2VkLm9wdGlvbnMsIHN0ZG91dFJlc3VsdCk7CiAgICBjb25zdCBzdGRlcnIgPSBoYW5kbGVPdXRwdXQocGFyc2VkLm9wdGlvbnMsIHN0ZGVyclJlc3VsdCk7CiAgICBjb25zdCBhbGwgPSBoYW5kbGVPdXRwdXQocGFyc2VkLm9wdGlvbnMsIGFsbFJlc3VsdCk7CiAgICBpZiAoZXJyb3IgfHwgZXhpdENvZGUgIT09IDAgfHwgc2lnbmFsICE9PSBudWxsKSB7CiAgICAgIGNvbnN0IHJldHVybmVkRXJyb3IgPSBtYWtlRXJyb3IoewogICAgICAgIGVycm9yLAogICAgICAgIGV4aXRDb2RlLAogICAgICAgIHNpZ25hbCwKICAgICAgICBzdGRvdXQsCiAgICAgICAgc3RkZXJyLAogICAgICAgIGFsbCwKICAgICAgICBjb21tYW5kOiBjb21tYW5kMiwKICAgICAgICBlc2NhcGVkQ29tbWFuZCwKICAgICAgICBwYXJzZWQsCiAgICAgICAgdGltZWRPdXQsCiAgICAgICAgaXNDYW5jZWxlZDogcGFyc2VkLm9wdGlvbnMuc2lnbmFsID8gcGFyc2VkLm9wdGlvbnMuc2lnbmFsLmFib3J0ZWQgOiBmYWxzZSwKICAgICAgICBraWxsZWQ6IHNwYXduZWQua2lsbGVkCiAgICAgIH0pOwogICAgICBpZiAoIXBhcnNlZC5vcHRpb25zLnJlamVjdCkgewogICAgICAgIHJldHVybiByZXR1cm5lZEVycm9yOwogICAgICB9CiAgICAgIHRocm93IHJldHVybmVkRXJyb3I7CiAgICB9CiAgICByZXR1cm4gewogICAgICBjb21tYW5kOiBjb21tYW5kMiwKICAgICAgZXNjYXBlZENvbW1hbmQsCiAgICAgIGV4aXRDb2RlOiAwLAogICAgICBzdGRvdXQsCiAgICAgIHN0ZGVyciwKICAgICAgYWxsLAogICAgICBmYWlsZWQ6IGZhbHNlLAogICAgICB0aW1lZE91dDogZmFsc2UsCiAgICAgIGlzQ2FuY2VsZWQ6IGZhbHNlLAogICAgICBraWxsZWQ6IGZhbHNlCiAgICB9OwogIH07CiAgY29uc3QgaGFuZGxlUHJvbWlzZU9uY2UgPSBvbmV0aW1lKGhhbmRsZVByb21pc2UpOwogIGhhbmRsZUlucHV0KHNwYXduZWQsIHBhcnNlZC5vcHRpb25zKTsKICBzcGF3bmVkLmFsbCA9IG1ha2VBbGxTdHJlYW0oc3Bhd25lZCwgcGFyc2VkLm9wdGlvbnMpOwogIGFkZFBpcGVNZXRob2RzKHNwYXduZWQpOwogIG1lcmdlUHJvbWlzZShzcGF3bmVkLCBoYW5kbGVQcm9taXNlT25jZSk7CiAgcmV0dXJuIHNwYXduZWQ7Cn0KZnVuY3Rpb24gZXhlY2FTeW5jKGZpbGUsIGFyZ3MsIG9wdGlvbnMpIHsKICBjb25zdCBwYXJzZWQgPSBoYW5kbGVBcmd1bWVudHMoZmlsZSwgYXJncywgb3B0aW9ucyk7CiAgY29uc3QgY29tbWFuZDIgPSBqb2luQ29tbWFuZChmaWxlLCBhcmdzKTsKICBjb25zdCBlc2NhcGVkQ29tbWFuZCA9IGdldEVzY2FwZWRDb21tYW5kKGZpbGUsIGFyZ3MpOwogIGxvZ0NvbW1hbmQoZXNjYXBlZENvbW1hbmQsIHBhcnNlZC5vcHRpb25zKTsKICBjb25zdCBpbnB1dCA9IGhhbmRsZUlucHV0U3luYyhwYXJzZWQub3B0aW9ucyk7CiAgbGV0IHJlc3VsdDsKICB0cnkgewogICAgcmVzdWx0ID0gY2hpbGRQcm9jZXNzLnNwYXduU3luYyhwYXJzZWQuZmlsZSwgcGFyc2VkLmFyZ3MsIHsgLi4ucGFyc2VkLm9wdGlvbnMsIGlucHV0IH0pOwogIH0gY2F0Y2ggKGVycm9yKSB7CiAgICB0aHJvdyBtYWtlRXJyb3IoewogICAgICBlcnJvciwKICAgICAgc3Rkb3V0OiAiIiwKICAgICAgc3RkZXJyOiAiIiwKICAgICAgYWxsOiAiIiwKICAgICAgY29tbWFuZDogY29tbWFuZDIsCiAgICAgIGVzY2FwZWRDb21tYW5kLAogICAgICBwYXJzZWQsCiAgICAgIHRpbWVkT3V0OiBmYWxzZSwKICAgICAgaXNDYW5jZWxlZDogZmFsc2UsCiAgICAgIGtpbGxlZDogZmFsc2UKICAgIH0pOwogIH0KICBjb25zdCBzdGRvdXQgPSBoYW5kbGVPdXRwdXQocGFyc2VkLm9wdGlvbnMsIHJlc3VsdC5zdGRvdXQsIHJlc3VsdC5lcnJvcik7CiAgY29uc3Qgc3RkZXJyID0gaGFuZGxlT3V0cHV0KHBhcnNlZC5vcHRpb25zLCByZXN1bHQuc3RkZXJyLCByZXN1bHQuZXJyb3IpOwogIGlmIChyZXN1bHQuZXJyb3IgfHwgcmVzdWx0LnN0YXR1cyAhPT0gMCB8fCByZXN1bHQuc2lnbmFsICE9PSBudWxsKSB7CiAgICBjb25zdCBlcnJvciA9IG1ha2VFcnJvcih7CiAgICAgIHN0ZG91dCwKICAgICAgc3RkZXJyLAogICAgICBlcnJvcjogcmVzdWx0LmVycm9yLAogICAgICBzaWduYWw6IHJlc3VsdC5zaWduYWwsCiAgICAgIGV4aXRDb2RlOiByZXN1bHQuc3RhdHVzLAogICAgICBjb21tYW5kOiBjb21tYW5kMiwKICAgICAgZXNjYXBlZENvbW1hbmQsCiAgICAgIHBhcnNlZCwKICAgICAgdGltZWRPdXQ6IHJlc3VsdC5lcnJvciAmJiByZXN1bHQuZXJyb3IuY29kZSA9PT0gIkVUSU1FRE9VVCIsCiAgICAgIGlzQ2FuY2VsZWQ6IGZhbHNlLAogICAgICBraWxsZWQ6IHJlc3VsdC5zaWduYWwgIT09IG51bGwKICAgIH0pOwogICAgaWYgKCFwYXJzZWQub3B0aW9ucy5yZWplY3QpIHsKICAgICAgcmV0dXJuIGVycm9yOwogICAgfQogICAgdGhyb3cgZXJyb3I7CiAgfQogIHJldHVybiB7CiAgICBjb21tYW5kOiBjb21tYW5kMiwKICAgIGVzY2FwZWRDb21tYW5kLAogICAgZXhpdENvZGU6IDAsCiAgICBzdGRvdXQsCiAgICBzdGRlcnIsCiAgICBmYWlsZWQ6IGZhbHNlLAogICAgdGltZWRPdXQ6IGZhbHNlLAogICAgaXNDYW5jZWxlZDogZmFsc2UsCiAgICBraWxsZWQ6IGZhbHNlCiAgfTsKfQpjb25zdCBub3JtYWxpemVTY3JpcHRTdGRpbiA9ICh7IGlucHV0LCBpbnB1dEZpbGUsIHN0ZGlvIH0pID0+IGlucHV0ID09PSB2b2lkIDAgJiYgaW5wdXRGaWxlID09PSB2b2lkIDAgJiYgc3RkaW8gPT09IHZvaWQgMCA/IHsgc3RkaW46ICJpbmhlcml0IiB9IDoge307CmNvbnN0IG5vcm1hbGl6ZVNjcmlwdE9wdGlvbnMgPSAob3B0aW9ucyA9IHt9KSA9PiAoewogIHByZWZlckxvY2FsOiB0cnVlLAogIC4uLm5vcm1hbGl6ZVNjcmlwdFN0ZGluKG9wdGlvbnMpLAogIC4uLm9wdGlvbnMKfSk7CmZ1bmN0aW9uIGNyZWF0ZSQob3B0aW9ucykgewogIGZ1bmN0aW9uICQyKHRlbXBsYXRlc09yT3B0aW9ucywgLi4uZXhwcmVzc2lvbnMpIHsKICAgIGlmICghQXJyYXkuaXNBcnJheSh0ZW1wbGF0ZXNPck9wdGlvbnMpKSB7CiAgICAgIHJldHVybiBjcmVhdGUkKHsgLi4ub3B0aW9ucywgLi4udGVtcGxhdGVzT3JPcHRpb25zIH0pOwogICAgfQogICAgY29uc3QgW2ZpbGUsIC4uLmFyZ3NdID0gcGFyc2VUZW1wbGF0ZXModGVtcGxhdGVzT3JPcHRpb25zLCBleHByZXNzaW9ucyk7CiAgICByZXR1cm4gZXhlY2EoZmlsZSwgYXJncywgbm9ybWFsaXplU2NyaXB0T3B0aW9ucyhvcHRpb25zKSk7CiAgfQogICQyLnN5bmMgPSAodGVtcGxhdGVzLCAuLi5leHByZXNzaW9ucykgPT4gewogICAgaWYgKCFBcnJheS5pc0FycmF5KHRlbXBsYXRlcykpIHsKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiUGxlYXNlIHVzZSAkKG9wdGlvbnMpLnN5bmNgY29tbWFuZGAgaW5zdGVhZCBvZiAkLnN5bmMob3B0aW9ucylgY29tbWFuZGAuIik7CiAgICB9CiAgICBjb25zdCBbZmlsZSwgLi4uYXJnc10gPSBwYXJzZVRlbXBsYXRlcyh0ZW1wbGF0ZXMsIGV4cHJlc3Npb25zKTsKICAgIHJldHVybiBleGVjYVN5bmMoZmlsZSwgYXJncywgbm9ybWFsaXplU2NyaXB0T3B0aW9ucyhvcHRpb25zKSk7CiAgfTsKICByZXR1cm4gJDI7Cn0KY29uc3QgJCA9IGNyZWF0ZSQoKTsKdmFyIGJhbGFuY2VkTWF0Y2ggPSBiYWxhbmNlZCQxOwpmdW5jdGlvbiBiYWxhbmNlZCQxKGEsIGIsIHN0cikgewogIGlmIChhIGluc3RhbmNlb2YgUmVnRXhwKQogICAgYSA9IG1heWJlTWF0Y2goYSwgc3RyKTsKICBpZiAoYiBpbnN0YW5jZW9mIFJlZ0V4cCkKICAgIGIgPSBtYXliZU1hdGNoKGIsIHN0cik7CiAgdmFyIHIgPSByYW5nZShhLCBiLCBzdHIpOwogIHJldHVybiByICYmIHsKICAgIHN0YXJ0OiByWzBdLAogICAgZW5kOiByWzFdLAogICAgcHJlOiBzdHIuc2xpY2UoMCwgclswXSksCiAgICBib2R5OiBzdHIuc2xpY2UoclswXSArIGEubGVuZ3RoLCByWzFdKSwKICAgIHBvc3Q6IHN0ci5zbGljZShyWzFdICsgYi5sZW5ndGgpCiAgfTsKfQpmdW5jdGlvbiBtYXliZU1hdGNoKHJlZywgc3RyKSB7CiAgdmFyIG0gPSBzdHIubWF0Y2gocmVnKTsKICByZXR1cm4gbSA/IG1bMF0gOiBudWxsOwp9CmJhbGFuY2VkJDEucmFuZ2UgPSByYW5nZTsKZnVuY3Rpb24gcmFuZ2UoYSwgYiwgc3RyKSB7CiAgdmFyIGJlZ3MsIGJlZywgbGVmdCwgcmlnaHQsIHJlc3VsdDsKICB2YXIgYWkgPSBzdHIuaW5kZXhPZihhKTsKICB2YXIgYmkgPSBzdHIuaW5kZXhPZihiLCBhaSArIDEpOwogIHZhciBpID0gYWk7CiAgaWYgKGFpID49IDAgJiYgYmkgPiAwKSB7CiAgICBpZiAoYSA9PT0gYikgewogICAgICByZXR1cm4gW2FpLCBiaV07CiAgICB9CiAgICBiZWdzID0gW107CiAgICBsZWZ0ID0gc3RyLmxlbmd0aDsKICAgIHdoaWxlIChpID49IDAgJiYgIXJlc3VsdCkgewogICAgICBpZiAoaSA9PSBhaSkgewogICAgICAgIGJlZ3MucHVzaChpKTsKICAgICAgICBhaSA9IHN0ci5pbmRleE9mKGEsIGkgKyAxKTsKICAgICAgfSBlbHNlIGlmIChiZWdzLmxlbmd0aCA9PSAxKSB7CiAgICAgICAgcmVzdWx0ID0gW2JlZ3MucG9wKCksIGJpXTsKICAgICAgfSBlbHNlIHsKICAgICAgICBiZWcgPSBiZWdzLnBvcCgpOwogICAgICAgIGlmIChiZWcgPCBsZWZ0KSB7CiAgICAgICAgICBsZWZ0ID0gYmVnOwogICAgICAgICAgcmlnaHQgPSBiaTsKICAgICAgICB9CiAgICAgICAgYmkgPSBzdHIuaW5kZXhPZihiLCBpICsgMSk7CiAgICAgIH0KICAgICAgaSA9IGFpIDwgYmkgJiYgYWkgPj0gMCA/IGFpIDogYmk7CiAgICB9CiAgICBpZiAoYmVncy5sZW5ndGgpIHsKICAgICAgcmVzdWx0ID0gW2xlZnQsIHJpZ2h0XTsKICAgIH0KICB9CiAgcmV0dXJuIHJlc3VsdDsKfQp2YXIgYmFsYW5jZWQgPSBiYWxhbmNlZE1hdGNoOwp2YXIgYnJhY2VFeHBhbnNpb24gPSBleHBhbmRUb3A7CnZhciBlc2NTbGFzaCA9ICJcMFNMQVNIIiArIE1hdGgucmFuZG9tKCkgKyAiXDAiOwp2YXIgZXNjT3BlbiA9ICJcME9QRU4iICsgTWF0aC5yYW5kb20oKSArICJcMCI7CnZhciBlc2NDbG9zZSA9ICJcMENMT1NFIiArIE1hdGgucmFuZG9tKCkgKyAiXDAiOwp2YXIgZXNjQ29tbWEgPSAiXDBDT01NQSIgKyBNYXRoLnJhbmRvbSgpICsgIlwwIjsKdmFyIGVzY1BlcmlvZCA9ICJcMFBFUklPRCIgKyBNYXRoLnJhbmRvbSgpICsgIlwwIjsKZnVuY3Rpb24gbnVtZXJpYyhzdHIpIHsKICByZXR1cm4gcGFyc2VJbnQoc3RyLCAxMCkgPT0gc3RyID8gcGFyc2VJbnQoc3RyLCAxMCkgOiBzdHIuY2hhckNvZGVBdCgwKTsKfQpmdW5jdGlvbiBlc2NhcGVCcmFjZXMoc3RyKSB7CiAgcmV0dXJuIHN0ci5zcGxpdCgiXFxcXCIpLmpvaW4oZXNjU2xhc2gpLnNwbGl0KCJcXHsiKS5qb2luKGVzY09wZW4pLnNwbGl0KCJcXH0iKS5qb2luKGVzY0Nsb3NlKS5zcGxpdCgiXFwsIikuam9pbihlc2NDb21tYSkuc3BsaXQoIlxcLiIpLmpvaW4oZXNjUGVyaW9kKTsKfQpmdW5jdGlvbiB1bmVzY2FwZUJyYWNlcyhzdHIpIHsKICByZXR1cm4gc3RyLnNwbGl0KGVzY1NsYXNoKS5qb2luKCJcXCIpLnNwbGl0KGVzY09wZW4pLmpvaW4oInsiKS5zcGxpdChlc2NDbG9zZSkuam9pbigifSIpLnNwbGl0KGVzY0NvbW1hKS5qb2luKCIsIikuc3BsaXQoZXNjUGVyaW9kKS5qb2luKCIuIik7Cn0KZnVuY3Rpb24gcGFyc2VDb21tYVBhcnRzKHN0cikgewogIGlmICghc3RyKQogICAgcmV0dXJuIFsiIl07CiAgdmFyIHBhcnRzID0gW107CiAgdmFyIG0gPSBiYWxhbmNlZCgieyIsICJ9Iiwgc3RyKTsKICBpZiAoIW0pCiAgICByZXR1cm4gc3RyLnNwbGl0KCIsIik7CiAgdmFyIHByZSA9IG0ucHJlOwogIHZhciBib2R5ID0gbS5ib2R5OwogIHZhciBwb3N0ID0gbS5wb3N0OwogIHZhciBwID0gcHJlLnNwbGl0KCIsIik7CiAgcFtwLmxlbmd0aCAtIDFdICs9ICJ7IiArIGJvZHkgKyAifSI7CiAgdmFyIHBvc3RQYXJ0cyA9IHBhcnNlQ29tbWFQYXJ0cyhwb3N0KTsKICBpZiAocG9zdC5sZW5ndGgpIHsKICAgIHBbcC5sZW5ndGggLSAxXSArPSBwb3N0UGFydHMuc2hpZnQoKTsKICAgIHAucHVzaC5hcHBseShwLCBwb3N0UGFydHMpOwogIH0KICBwYXJ0cy5wdXNoLmFwcGx5KHBhcnRzLCBwKTsKICByZXR1cm4gcGFydHM7Cn0KZnVuY3Rpb24gZXhwYW5kVG9wKHN0cikgewogIGlmICghc3RyKQogICAgcmV0dXJuIFtdOwogIGlmIChzdHIuc3Vic3RyKDAsIDIpID09PSAie30iKSB7CiAgICBzdHIgPSAiXFx7XFx9IiArIHN0ci5zdWJzdHIoMik7CiAgfQogIHJldHVybiBleHBhbmQoZXNjYXBlQnJhY2VzKHN0ciksIHRydWUpLm1hcCh1bmVzY2FwZUJyYWNlcyk7Cn0KZnVuY3Rpb24gZW1icmFjZShzdHIpIHsKICByZXR1cm4gInsiICsgc3RyICsgIn0iOwp9CmZ1bmN0aW9uIGlzUGFkZGVkKGVsKSB7CiAgcmV0dXJuIC9eLT8wXGQvLnRlc3QoZWwpOwp9CmZ1bmN0aW9uIGx0ZShpLCB5KSB7CiAgcmV0dXJuIGkgPD0geTsKfQpmdW5jdGlvbiBndGUoaSwgeSkgewogIHJldHVybiBpID49IHk7Cn0KZnVuY3Rpb24gZXhwYW5kKHN0ciwgaXNUb3ApIHsKICB2YXIgZXhwYW5zaW9ucyA9IFtdOwogIHZhciBtID0gYmFsYW5jZWQoInsiLCAifSIsIHN0cik7CiAgaWYgKCFtKQogICAgcmV0dXJuIFtzdHJdOwogIHZhciBwcmUgPSBtLnByZTsKICB2YXIgcG9zdCA9IG0ucG9zdC5sZW5ndGggPyBleHBhbmQobS5wb3N0LCBmYWxzZSkgOiBbIiJdOwogIGlmICgvXCQkLy50ZXN0KG0ucHJlKSkgewogICAgZm9yICh2YXIgayA9IDA7IGsgPCBwb3N0Lmxlbmd0aDsgaysrKSB7CiAgICAgIHZhciBleHBhbnNpb24gPSBwcmUgKyAieyIgKyBtLmJvZHkgKyAifSIgKyBwb3N0W2tdOwogICAgICBleHBhbnNpb25zLnB1c2goZXhwYW5zaW9uKTsKICAgIH0KICB9IGVsc2UgewogICAgdmFyIGlzTnVtZXJpY1NlcXVlbmNlID0gL14tP1xkK1wuXC4tP1xkKyg/OlwuXC4tP1xkKyk/JC8udGVzdChtLmJvZHkpOwogICAgdmFyIGlzQWxwaGFTZXF1ZW5jZSA9IC9eW2EtekEtWl1cLlwuW2EtekEtWl0oPzpcLlwuLT9cZCspPyQvLnRlc3QobS5ib2R5KTsKICAgIHZhciBpc1NlcXVlbmNlID0gaXNOdW1lcmljU2VxdWVuY2UgfHwgaXNBbHBoYVNlcXVlbmNlOwogICAgdmFyIGlzT3B0aW9ucyA9IG0uYm9keS5pbmRleE9mKCIsIikgPj0gMDsKICAgIGlmICghaXNTZXF1ZW5jZSAmJiAhaXNPcHRpb25zKSB7CiAgICAgIGlmIChtLnBvc3QubWF0Y2goLywuKlx9LykpIHsKICAgICAgICBzdHIgPSBtLnByZSArICJ7IiArIG0uYm9keSArIGVzY0Nsb3NlICsgbS5wb3N0OwogICAgICAgIHJldHVybiBleHBhbmQoc3RyKTsKICAgICAgfQogICAgICByZXR1cm4gW3N0cl07CiAgICB9CiAgICB2YXIgbjsKICAgIGlmIChpc1NlcXVlbmNlKSB7CiAgICAgIG4gPSBtLmJvZHkuc3BsaXQoL1wuXC4vKTsKICAgIH0gZWxzZSB7CiAgICAgIG4gPSBwYXJzZUNvbW1hUGFydHMobS5ib2R5KTsKICAgICAgaWYgKG4ubGVuZ3RoID09PSAxKSB7CiAgICAgICAgbiA9IGV4cGFuZChuWzBdLCBmYWxzZSkubWFwKGVtYnJhY2UpOwogICAgICAgIGlmIChuLmxlbmd0aCA9PT0gMSkgewogICAgICAgICAgcmV0dXJuIHBvc3QubWFwKGZ1bmN0aW9uKHApIHsKICAgICAgICAgICAgcmV0dXJuIG0ucHJlICsgblswXSArIHA7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHZhciBOOwogICAgaWYgKGlzU2VxdWVuY2UpIHsKICAgICAgdmFyIHggPSBudW1lcmljKG5bMF0pOwogICAgICB2YXIgeSA9IG51bWVyaWMoblsxXSk7CiAgICAgIHZhciB3aWR0aCA9IE1hdGgubWF4KG5bMF0ubGVuZ3RoLCBuWzFdLmxlbmd0aCk7CiAgICAgIHZhciBpbmNyID0gbi5sZW5ndGggPT0gMyA/IE1hdGguYWJzKG51bWVyaWMoblsyXSkpIDogMTsKICAgICAgdmFyIHRlc3QgPSBsdGU7CiAgICAgIHZhciByZXZlcnNlID0geSA8IHg7CiAgICAgIGlmIChyZXZlcnNlKSB7CiAgICAgICAgaW5jciAqPSAtMTsKICAgICAgICB0ZXN0ID0gZ3RlOwogICAgICB9CiAgICAgIHZhciBwYWQgPSBuLnNvbWUoaXNQYWRkZWQpOwogICAgICBOID0gW107CiAgICAgIGZvciAodmFyIGkgPSB4OyB0ZXN0KGksIHkpOyBpICs9IGluY3IpIHsKICAgICAgICB2YXIgYzsKICAgICAgICBpZiAoaXNBbHBoYVNlcXVlbmNlKSB7CiAgICAgICAgICBjID0gU3RyaW5nLmZyb21DaGFyQ29kZShpKTsKICAgICAgICAgIGlmIChjID09PSAiXFwiKQogICAgICAgICAgICBjID0gIiI7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGMgPSBTdHJpbmcoaSk7CiAgICAgICAgICBpZiAocGFkKSB7CiAgICAgICAgICAgIHZhciBuZWVkID0gd2lkdGggLSBjLmxlbmd0aDsKICAgICAgICAgICAgaWYgKG5lZWQgPiAwKSB7CiAgICAgICAgICAgICAgdmFyIHogPSBuZXcgQXJyYXkobmVlZCArIDEpLmpvaW4oIjAiKTsKICAgICAgICAgICAgICBpZiAoaSA8IDApCiAgICAgICAgICAgICAgICBjID0gIi0iICsgeiArIGMuc2xpY2UoMSk7CiAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgYyA9IHogKyBjOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIE4ucHVzaChjKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgTiA9IFtdOwogICAgICBmb3IgKHZhciBqID0gMDsgaiA8IG4ubGVuZ3RoOyBqKyspIHsKICAgICAgICBOLnB1c2guYXBwbHkoTiwgZXhwYW5kKG5bal0sIGZhbHNlKSk7CiAgICAgIH0KICAgIH0KICAgIGZvciAodmFyIGogPSAwOyBqIDwgTi5sZW5ndGg7IGorKykgewogICAgICBmb3IgKHZhciBrID0gMDsgayA8IHBvc3QubGVuZ3RoOyBrKyspIHsKICAgICAgICB2YXIgZXhwYW5zaW9uID0gcHJlICsgTltqXSArIHBvc3Rba107CiAgICAgICAgaWYgKCFpc1RvcCB8fCBpc1NlcXVlbmNlIHx8IGV4cGFuc2lvbikKICAgICAgICAgIGV4cGFuc2lvbnMucHVzaChleHBhbnNpb24pOwogICAgICB9CiAgICB9CiAgfQogIHJldHVybiBleHBhbnNpb25zOwp9CmNvbnN0IGV4cGFuZCQxID0gLyogQF9fUFVSRV9fICovIGdldERlZmF1bHRFeHBvcnRGcm9tQ2pzKGJyYWNlRXhwYW5zaW9uKTsKY29uc3QgTUFYX1BBVFRFUk5fTEVOR1RIID0gMTAyNCAqIDY0Owpjb25zdCBhc3NlcnRWYWxpZFBhdHRlcm4gPSAocGF0dGVybikgPT4gewogIGlmICh0eXBlb2YgcGF0dGVybiAhPT0gInN0cmluZyIpIHsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoImludmFsaWQgcGF0dGVybiIpOwogIH0KICBpZiAocGF0dGVybi5sZW5ndGggPiBNQVhfUEFUVEVSTl9MRU5HVEgpIHsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoInBhdHRlcm4gaXMgdG9vIGxvbmciKTsKICB9Cn07CmNvbnN0IHBvc2l4Q2xhc3NlcyA9IHsKICAiWzphbG51bTpdIjogWyJcXHB7TH1cXHB7Tmx9XFxwe05kfSIsIHRydWVdLAogICJbOmFscGhhOl0iOiBbIlxccHtMfVxccHtObH0iLCB0cnVlXSwKICAiWzphc2NpaTpdIjogWyJcXHgwMC1cXHg3ZiIsIGZhbHNlXSwKICAiWzpibGFuazpdIjogWyJcXHB7WnN9XFx0IiwgdHJ1ZV0sCiAgIls6Y250cmw6XSI6IFsiXFxwe0NjfSIsIHRydWVdLAogICJbOmRpZ2l0Ol0iOiBbIlxccHtOZH0iLCB0cnVlXSwKICAiWzpncmFwaDpdIjogWyJcXHB7Wn1cXHB7Q30iLCB0cnVlLCB0cnVlXSwKICAiWzpsb3dlcjpdIjogWyJcXHB7TGx9IiwgdHJ1ZV0sCiAgIls6cHJpbnQ6XSI6IFsiXFxwe0N9IiwgdHJ1ZV0sCiAgIls6cHVuY3Q6XSI6IFsiXFxwe1B9IiwgdHJ1ZV0sCiAgIls6c3BhY2U6XSI6IFsiXFxwe1p9XFx0XFxyXFxuXFx2XFxmIiwgdHJ1ZV0sCiAgIls6dXBwZXI6XSI6IFsiXFxwe0x1fSIsIHRydWVdLAogICJbOndvcmQ6XSI6IFsiXFxwe0x9XFxwe05sfVxccHtOZH1cXHB7UGN9IiwgdHJ1ZV0sCiAgIls6eGRpZ2l0Ol0iOiBbIkEtRmEtZjAtOSIsIGZhbHNlXQp9Owpjb25zdCBicmFjZUVzY2FwZSA9IChzKSA9PiBzLnJlcGxhY2UoL1tbXF1cXC1dL2csICJcXCQmIik7CmNvbnN0IHJlZ2V4cEVzY2FwZSA9IChzKSA9PiBzLnJlcGxhY2UoL1stW1xde30oKSorPy4sXFxeJHwjXHNdL2csICJcXCQmIik7CmNvbnN0IHJhbmdlc1RvU3RyaW5nID0gKHJhbmdlcykgPT4gcmFuZ2VzLmpvaW4oIiIpOwpjb25zdCBwYXJzZUNsYXNzID0gKGdsb2IyLCBwb3NpdGlvbikgPT4gewogIGNvbnN0IHBvcyA9IHBvc2l0aW9uOwogIGlmIChnbG9iMi5jaGFyQXQocG9zKSAhPT0gIlsiKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoIm5vdCBpbiBhIGJyYWNlIGV4cHJlc3Npb24iKTsKICB9CiAgY29uc3QgcmFuZ2VzID0gW107CiAgY29uc3QgbmVncyA9IFtdOwogIGxldCBpID0gcG9zICsgMTsKICBsZXQgc2F3U3RhcnQgPSBmYWxzZTsKICBsZXQgdWZsYWcgPSBmYWxzZTsKICBsZXQgZXNjYXBpbmcgPSBmYWxzZTsKICBsZXQgbmVnYXRlID0gZmFsc2U7CiAgbGV0IGVuZFBvcyA9IHBvczsKICBsZXQgcmFuZ2VTdGFydCA9ICIiOwogIFdISUxFOgogICAgd2hpbGUgKGkgPCBnbG9iMi5sZW5ndGgpIHsKICAgICAgY29uc3QgYyA9IGdsb2IyLmNoYXJBdChpKTsKICAgICAgaWYgKChjID09PSAiISIgfHwgYyA9PT0gIl4iKSAmJiBpID09PSBwb3MgKyAxKSB7CiAgICAgICAgbmVnYXRlID0gdHJ1ZTsKICAgICAgICBpKys7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgaWYgKGMgPT09ICJdIiAmJiBzYXdTdGFydCAmJiAhZXNjYXBpbmcpIHsKICAgICAgICBlbmRQb3MgPSBpICsgMTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgICBzYXdTdGFydCA9IHRydWU7CiAgICAgIGlmIChjID09PSAiXFwiKSB7CiAgICAgICAgaWYgKCFlc2NhcGluZykgewogICAgICAgICAgZXNjYXBpbmcgPSB0cnVlOwogICAgICAgICAgaSsrOwogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChjID09PSAiWyIgJiYgIWVzY2FwaW5nKSB7CiAgICAgICAgZm9yIChjb25zdCBbY2xzLCBbdW5pcCwgdSwgbmVnXV0gb2YgT2JqZWN0LmVudHJpZXMocG9zaXhDbGFzc2VzKSkgewogICAgICAgICAgaWYgKGdsb2IyLnN0YXJ0c1dpdGgoY2xzLCBpKSkgewogICAgICAgICAgICBpZiAocmFuZ2VTdGFydCkgewogICAgICAgICAgICAgIHJldHVybiBbIiQuIiwgZmFsc2UsIGdsb2IyLmxlbmd0aCAtIHBvcywgdHJ1ZV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaSArPSBjbHMubGVuZ3RoOwogICAgICAgICAgICBpZiAobmVnKQogICAgICAgICAgICAgIG5lZ3MucHVzaCh1bmlwKTsKICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgIHJhbmdlcy5wdXNoKHVuaXApOwogICAgICAgICAgICB1ZmxhZyA9IHVmbGFnIHx8IHU7CiAgICAgICAgICAgIGNvbnRpbnVlIFdISUxFOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICBlc2NhcGluZyA9IGZhbHNlOwogICAgICBpZiAocmFuZ2VTdGFydCkgewogICAgICAgIGlmIChjID4gcmFuZ2VTdGFydCkgewogICAgICAgICAgcmFuZ2VzLnB1c2goYnJhY2VFc2NhcGUocmFuZ2VTdGFydCkgKyAiLSIgKyBicmFjZUVzY2FwZShjKSk7CiAgICAgICAgfSBlbHNlIGlmIChjID09PSByYW5nZVN0YXJ0KSB7CiAgICAgICAgICByYW5nZXMucHVzaChicmFjZUVzY2FwZShjKSk7CiAgICAgICAgfQogICAgICAgIHJhbmdlU3RhcnQgPSAiIjsKICAgICAgICBpKys7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgaWYgKGdsb2IyLnN0YXJ0c1dpdGgoIi1dIiwgaSArIDEpKSB7CiAgICAgICAgcmFuZ2VzLnB1c2goYnJhY2VFc2NhcGUoYyArICItIikpOwogICAgICAgIGkgKz0gMjsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBpZiAoZ2xvYjIuc3RhcnRzV2l0aCgiLSIsIGkgKyAxKSkgewogICAgICAgIHJhbmdlU3RhcnQgPSBjOwogICAgICAgIGkgKz0gMjsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICByYW5nZXMucHVzaChicmFjZUVzY2FwZShjKSk7CiAgICAgIGkrKzsKICAgIH0KICBpZiAoZW5kUG9zIDwgaSkgewogICAgcmV0dXJuIFsiIiwgZmFsc2UsIDAsIGZhbHNlXTsKICB9CiAgaWYgKCFyYW5nZXMubGVuZ3RoICYmICFuZWdzLmxlbmd0aCkgewogICAgcmV0dXJuIFsiJC4iLCBmYWxzZSwgZ2xvYjIubGVuZ3RoIC0gcG9zLCB0cnVlXTsKICB9CiAgaWYgKG5lZ3MubGVuZ3RoID09PSAwICYmIHJhbmdlcy5sZW5ndGggPT09IDEgJiYgL15cXD8uJC8udGVzdChyYW5nZXNbMF0pICYmICFuZWdhdGUpIHsKICAgIGNvbnN0IHIgPSByYW5nZXNbMF0ubGVuZ3RoID09PSAyID8gcmFuZ2VzWzBdLnNsaWNlKC0xKSA6IHJhbmdlc1swXTsKICAgIHJldHVybiBbcmVnZXhwRXNjYXBlKHIpLCBmYWxzZSwgZW5kUG9zIC0gcG9zLCBmYWxzZV07CiAgfQogIGNvbnN0IHNyYW5nZXMgPSAiWyIgKyAobmVnYXRlID8gIl4iIDogIiIpICsgcmFuZ2VzVG9TdHJpbmcocmFuZ2VzKSArICJdIjsKICBjb25zdCBzbmVncyA9ICJbIiArIChuZWdhdGUgPyAiIiA6ICJeIikgKyByYW5nZXNUb1N0cmluZyhuZWdzKSArICJdIjsKICBjb25zdCBjb21iID0gcmFuZ2VzLmxlbmd0aCAmJiBuZWdzLmxlbmd0aCA/ICIoIiArIHNyYW5nZXMgKyAifCIgKyBzbmVncyArICIpIiA6IHJhbmdlcy5sZW5ndGggPyBzcmFuZ2VzIDogc25lZ3M7CiAgcmV0dXJuIFtjb21iLCB1ZmxhZywgZW5kUG9zIC0gcG9zLCB0cnVlXTsKfTsKY29uc3QgdW5lc2NhcGUkMSA9IChzLCB7IHdpbmRvd3NQYXRoc05vRXNjYXBlID0gZmFsc2UgfSA9IHt9KSA9PiB7CiAgcmV0dXJuIHdpbmRvd3NQYXRoc05vRXNjYXBlID8gcy5yZXBsYWNlKC9cWyhbXlwvXFxdKVxdL2csICIkMSIpIDogcy5yZXBsYWNlKC8oKD8hXFwpLnxeKVxbKFteXC9cXF0pXF0vZywgIiQxJDIiKS5yZXBsYWNlKC9cXChbXlwvXSkvZywgIiQxIik7Cn07CmNvbnN0IHR5cGVzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoWyIhIiwgIj8iLCAiKyIsICIqIiwgIkAiXSk7CmNvbnN0IGlzRXh0Z2xvYlR5cGUgPSAoYykgPT4gdHlwZXMuaGFzKGMpOwpjb25zdCBzdGFydE5vVHJhdmVyc2FsID0gIig/ISg/Ol58LylcXC5cXC4/KD86JHwvKSkiOwpjb25zdCBzdGFydE5vRG90ID0gIig/IVxcLikiOwpjb25zdCBhZGRQYXR0ZXJuU3RhcnQgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldChbIlsiLCAiLiJdKTsKY29uc3QganVzdERvdHMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldChbIi4uIiwgIi4iXSk7CmNvbnN0IHJlU3BlY2lhbHMgPSBuZXcgU2V0KCIoKS4qe30rP1tdXiRcXCEiKTsKY29uc3QgcmVnRXhwRXNjYXBlJDEgPSAocykgPT4gcy5yZXBsYWNlKC9bLVtcXXt9KCkqKz8uLFxcXiR8I1xzXS9nLCAiXFwkJiIpOwpjb25zdCBxbWFyayQxID0gIlteL10iOwpjb25zdCBzdGFyJDEgPSBxbWFyayQxICsgIio/IjsKY29uc3Qgc3Rhck5vRW1wdHkgPSBxbWFyayQxICsgIis/IjsKY2xhc3MgQVNUIHsKICB0eXBlOwogICNyb290OwogICNoYXNNYWdpYzsKICAjdWZsYWcgPSBmYWxzZTsKICAjcGFydHMgPSBbXTsKICAjcGFyZW50OwogICNwYXJlbnRJbmRleDsKICAjbmVnczsKICAjZmlsbGVkTmVncyA9IGZhbHNlOwogICNvcHRpb25zOwogICN0b1N0cmluZzsKICAvLyBzZXQgdG8gdHJ1ZSBpZiBpdCdzIGFuIGV4dGdsb2Igd2l0aCBubyBjaGlsZHJlbgogIC8vICh3aGljaCByZWFsbHkgbWVhbnMgb25lIGNoaWxkIG9mICcnKQogICNlbXB0eUV4dCA9IGZhbHNlOwogIGNvbnN0cnVjdG9yKHR5cGUsIHBhcmVudCwgb3B0aW9ucyA9IHt9KSB7CiAgICB0aGlzLnR5cGUgPSB0eXBlOwogICAgaWYgKHR5cGUpCiAgICAgIHRoaXMuI2hhc01hZ2ljID0gdHJ1ZTsKICAgIHRoaXMuI3BhcmVudCA9IHBhcmVudDsKICAgIHRoaXMuI3Jvb3QgPSB0aGlzLiNwYXJlbnQgPyB0aGlzLiNwYXJlbnQuI3Jvb3QgOiB0aGlzOwogICAgdGhpcy4jb3B0aW9ucyA9IHRoaXMuI3Jvb3QgPT09IHRoaXMgPyBvcHRpb25zIDogdGhpcy4jcm9vdC4jb3B0aW9uczsKICAgIHRoaXMuI25lZ3MgPSB0aGlzLiNyb290ID09PSB0aGlzID8gW10gOiB0aGlzLiNyb290LiNuZWdzOwogICAgaWYgKHR5cGUgPT09ICIhIiAmJiAhdGhpcy4jcm9vdC4jZmlsbGVkTmVncykKICAgICAgdGhpcy4jbmVncy5wdXNoKHRoaXMpOwogICAgdGhpcy4jcGFyZW50SW5kZXggPSB0aGlzLiNwYXJlbnQgPyB0aGlzLiNwYXJlbnQuI3BhcnRzLmxlbmd0aCA6IDA7CiAgfQogIGdldCBoYXNNYWdpYygpIHsKICAgIGlmICh0aGlzLiNoYXNNYWdpYyAhPT0gdm9pZCAwKQogICAgICByZXR1cm4gdGhpcy4jaGFzTWFnaWM7CiAgICBmb3IgKGNvbnN0IHAgb2YgdGhpcy4jcGFydHMpIHsKICAgICAgaWYgKHR5cGVvZiBwID09PSAic3RyaW5nIikKICAgICAgICBjb250aW51ZTsKICAgICAgaWYgKHAudHlwZSB8fCBwLmhhc01hZ2ljKQogICAgICAgIHJldHVybiB0aGlzLiNoYXNNYWdpYyA9IHRydWU7CiAgICB9CiAgICByZXR1cm4gdGhpcy4jaGFzTWFnaWM7CiAgfQogIC8vIHJlY29uc3RydWN0cyB0aGUgcGF0dGVybgogIHRvU3RyaW5nKCkgewogICAgaWYgKHRoaXMuI3RvU3RyaW5nICE9PSB2b2lkIDApCiAgICAgIHJldHVybiB0aGlzLiN0b1N0cmluZzsKICAgIGlmICghdGhpcy50eXBlKSB7CiAgICAgIHJldHVybiB0aGlzLiN0b1N0cmluZyA9IHRoaXMuI3BhcnRzLm1hcCgocCkgPT4gU3RyaW5nKHApKS5qb2luKCIiKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiB0aGlzLiN0b1N0cmluZyA9IHRoaXMudHlwZSArICIoIiArIHRoaXMuI3BhcnRzLm1hcCgocCkgPT4gU3RyaW5nKHApKS5qb2luKCJ8IikgKyAiKSI7CiAgICB9CiAgfQogICNmaWxsTmVncygpIHsKICAgIGlmICh0aGlzICE9PSB0aGlzLiNyb290KQogICAgICB0aHJvdyBuZXcgRXJyb3IoInNob3VsZCBvbmx5IGNhbGwgb24gcm9vdCIpOwogICAgaWYgKHRoaXMuI2ZpbGxlZE5lZ3MpCiAgICAgIHJldHVybiB0aGlzOwogICAgdGhpcy50b1N0cmluZygpOwogICAgdGhpcy4jZmlsbGVkTmVncyA9IHRydWU7CiAgICBsZXQgbjsKICAgIHdoaWxlIChuID0gdGhpcy4jbmVncy5wb3AoKSkgewogICAgICBpZiAobi50eXBlICE9PSAiISIpCiAgICAgICAgY29udGludWU7CiAgICAgIGxldCBwID0gbjsKICAgICAgbGV0IHBwID0gcC4jcGFyZW50OwogICAgICB3aGlsZSAocHApIHsKICAgICAgICBmb3IgKGxldCBpID0gcC4jcGFyZW50SW5kZXggKyAxOyAhcHAudHlwZSAmJiBpIDwgcHAuI3BhcnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBmb3IgKGNvbnN0IHBhcnQgb2Ygbi4jcGFydHMpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBwYXJ0ID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigic3RyaW5nIHBhcnQgaW4gZXh0Z2xvYiBBU1Q/PyIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHBhcnQuY29weUluKHBwLiNwYXJ0c1tpXSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHAgPSBwcDsKICAgICAgICBwcCA9IHAuI3BhcmVudDsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQogIHB1c2goLi4ucGFydHMpIHsKICAgIGZvciAoY29uc3QgcCBvZiBwYXJ0cykgewogICAgICBpZiAocCA9PT0gIiIpCiAgICAgICAgY29udGludWU7CiAgICAgIGlmICh0eXBlb2YgcCAhPT0gInN0cmluZyIgJiYgIShwIGluc3RhbmNlb2YgQVNUICYmIHAuI3BhcmVudCA9PT0gdGhpcykpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImludmFsaWQgcGFydDogIiArIHApOwogICAgICB9CiAgICAgIHRoaXMuI3BhcnRzLnB1c2gocCk7CiAgICB9CiAgfQogIHRvSlNPTigpIHsKICAgIGNvbnN0IHJldCA9IHRoaXMudHlwZSA9PT0gbnVsbCA/IHRoaXMuI3BhcnRzLnNsaWNlKCkubWFwKChwKSA9PiB0eXBlb2YgcCA9PT0gInN0cmluZyIgPyBwIDogcC50b0pTT04oKSkgOiBbdGhpcy50eXBlLCAuLi50aGlzLiNwYXJ0cy5tYXAoKHApID0+IHAudG9KU09OKCkpXTsKICAgIGlmICh0aGlzLmlzU3RhcnQoKSAmJiAhdGhpcy50eXBlKQogICAgICByZXQudW5zaGlmdChbXSk7CiAgICBpZiAodGhpcy5pc0VuZCgpICYmICh0aGlzID09PSB0aGlzLiNyb290IHx8IHRoaXMuI3Jvb3QuI2ZpbGxlZE5lZ3MgJiYgdGhpcy4jcGFyZW50Py50eXBlID09PSAiISIpKSB7CiAgICAgIHJldC5wdXNoKHt9KTsKICAgIH0KICAgIHJldHVybiByZXQ7CiAgfQogIGlzU3RhcnQoKSB7CiAgICBpZiAodGhpcy4jcm9vdCA9PT0gdGhpcykKICAgICAgcmV0dXJuIHRydWU7CiAgICBpZiAoIXRoaXMuI3BhcmVudD8uaXNTdGFydCgpKQogICAgICByZXR1cm4gZmFsc2U7CiAgICBpZiAodGhpcy4jcGFyZW50SW5kZXggPT09IDApCiAgICAgIHJldHVybiB0cnVlOwogICAgY29uc3QgcCA9IHRoaXMuI3BhcmVudDsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy4jcGFyZW50SW5kZXg7IGkrKykgewogICAgICBjb25zdCBwcCA9IHAuI3BhcnRzW2ldOwogICAgICBpZiAoIShwcCBpbnN0YW5jZW9mIEFTVCAmJiBwcC50eXBlID09PSAiISIpKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgaXNFbmQoKSB7CiAgICBpZiAodGhpcy4jcm9vdCA9PT0gdGhpcykKICAgICAgcmV0dXJuIHRydWU7CiAgICBpZiAodGhpcy4jcGFyZW50Py50eXBlID09PSAiISIpCiAgICAgIHJldHVybiB0cnVlOwogICAgaWYgKCF0aGlzLiNwYXJlbnQ/LmlzRW5kKCkpCiAgICAgIHJldHVybiBmYWxzZTsKICAgIGlmICghdGhpcy50eXBlKQogICAgICByZXR1cm4gdGhpcy4jcGFyZW50Py5pc0VuZCgpOwogICAgY29uc3QgcGwgPSB0aGlzLiNwYXJlbnQgPyB0aGlzLiNwYXJlbnQuI3BhcnRzLmxlbmd0aCA6IDA7CiAgICByZXR1cm4gdGhpcy4jcGFyZW50SW5kZXggPT09IHBsIC0gMTsKICB9CiAgY29weUluKHBhcnQpIHsKICAgIGlmICh0eXBlb2YgcGFydCA9PT0gInN0cmluZyIpCiAgICAgIHRoaXMucHVzaChwYXJ0KTsKICAgIGVsc2UKICAgICAgdGhpcy5wdXNoKHBhcnQuY2xvbmUodGhpcykpOwogIH0KICBjbG9uZShwYXJlbnQpIHsKICAgIGNvbnN0IGMgPSBuZXcgQVNUKHRoaXMudHlwZSwgcGFyZW50KTsKICAgIGZvciAoY29uc3QgcCBvZiB0aGlzLiNwYXJ0cykgewogICAgICBjLmNvcHlJbihwKTsKICAgIH0KICAgIHJldHVybiBjOwogIH0KICBzdGF0aWMgI3BhcnNlQVNUKHN0ciwgYXN0LCBwb3MsIG9wdCkgewogICAgbGV0IGVzY2FwaW5nID0gZmFsc2U7CiAgICBsZXQgaW5CcmFjZSA9IGZhbHNlOwogICAgbGV0IGJyYWNlU3RhcnQgPSAtMTsKICAgIGxldCBicmFjZU5lZyA9IGZhbHNlOwogICAgaWYgKGFzdC50eXBlID09PSBudWxsKSB7CiAgICAgIGxldCBpMiA9IHBvczsKICAgICAgbGV0IGFjYzIgPSAiIjsKICAgICAgd2hpbGUgKGkyIDwgc3RyLmxlbmd0aCkgewogICAgICAgIGNvbnN0IGMgPSBzdHIuY2hhckF0KGkyKyspOwogICAgICAgIGlmIChlc2NhcGluZyB8fCBjID09PSAiXFwiKSB7CiAgICAgICAgICBlc2NhcGluZyA9ICFlc2NhcGluZzsKICAgICAgICAgIGFjYzIgKz0gYzsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgICBpZiAoaW5CcmFjZSkgewogICAgICAgICAgaWYgKGkyID09PSBicmFjZVN0YXJ0ICsgMSkgewogICAgICAgICAgICBpZiAoYyA9PT0gIl4iIHx8IGMgPT09ICIhIikgewogICAgICAgICAgICAgIGJyYWNlTmVnID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChjID09PSAiXSIgJiYgIShpMiA9PT0gYnJhY2VTdGFydCArIDIgJiYgYnJhY2VOZWcpKSB7CiAgICAgICAgICAgIGluQnJhY2UgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGFjYzIgKz0gYzsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0gZWxzZSBpZiAoYyA9PT0gIlsiKSB7CiAgICAgICAgICBpbkJyYWNlID0gdHJ1ZTsKICAgICAgICAgIGJyYWNlU3RhcnQgPSBpMjsKICAgICAgICAgIGJyYWNlTmVnID0gZmFsc2U7CiAgICAgICAgICBhY2MyICs9IGM7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgaWYgKCFvcHQubm9leHQgJiYgaXNFeHRnbG9iVHlwZShjKSAmJiBzdHIuY2hhckF0KGkyKSA9PT0gIigiKSB7CiAgICAgICAgICBhc3QucHVzaChhY2MyKTsKICAgICAgICAgIGFjYzIgPSAiIjsKICAgICAgICAgIGNvbnN0IGV4dDIgPSBuZXcgQVNUKGMsIGFzdCk7CiAgICAgICAgICBpMiA9IEFTVC4jcGFyc2VBU1Qoc3RyLCBleHQyLCBpMiwgb3B0KTsKICAgICAgICAgIGFzdC5wdXNoKGV4dDIpOwogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIGFjYzIgKz0gYzsKICAgICAgfQogICAgICBhc3QucHVzaChhY2MyKTsKICAgICAgcmV0dXJuIGkyOwogICAgfQogICAgbGV0IGkgPSBwb3MgKyAxOwogICAgbGV0IHBhcnQgPSBuZXcgQVNUKG51bGwsIGFzdCk7CiAgICBjb25zdCBwYXJ0cyA9IFtdOwogICAgbGV0IGFjYyA9ICIiOwogICAgd2hpbGUgKGkgPCBzdHIubGVuZ3RoKSB7CiAgICAgIGNvbnN0IGMgPSBzdHIuY2hhckF0KGkrKyk7CiAgICAgIGlmIChlc2NhcGluZyB8fCBjID09PSAiXFwiKSB7CiAgICAgICAgZXNjYXBpbmcgPSAhZXNjYXBpbmc7CiAgICAgICAgYWNjICs9IGM7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgaWYgKGluQnJhY2UpIHsKICAgICAgICBpZiAoaSA9PT0gYnJhY2VTdGFydCArIDEpIHsKICAgICAgICAgIGlmIChjID09PSAiXiIgfHwgYyA9PT0gIiEiKSB7CiAgICAgICAgICAgIGJyYWNlTmVnID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKGMgPT09ICJdIiAmJiAhKGkgPT09IGJyYWNlU3RhcnQgKyAyICYmIGJyYWNlTmVnKSkgewogICAgICAgICAgaW5CcmFjZSA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBhY2MgKz0gYzsKICAgICAgICBjb250aW51ZTsKICAgICAgfSBlbHNlIGlmIChjID09PSAiWyIpIHsKICAgICAgICBpbkJyYWNlID0gdHJ1ZTsKICAgICAgICBicmFjZVN0YXJ0ID0gaTsKICAgICAgICBicmFjZU5lZyA9IGZhbHNlOwogICAgICAgIGFjYyArPSBjOwogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGlmIChpc0V4dGdsb2JUeXBlKGMpICYmIHN0ci5jaGFyQXQoaSkgPT09ICIoIikgewogICAgICAgIHBhcnQucHVzaChhY2MpOwogICAgICAgIGFjYyA9ICIiOwogICAgICAgIGNvbnN0IGV4dDIgPSBuZXcgQVNUKGMsIHBhcnQpOwogICAgICAgIHBhcnQucHVzaChleHQyKTsKICAgICAgICBpID0gQVNULiNwYXJzZUFTVChzdHIsIGV4dDIsIGksIG9wdCk7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgaWYgKGMgPT09ICJ8IikgewogICAgICAgIHBhcnQucHVzaChhY2MpOwogICAgICAgIGFjYyA9ICIiOwogICAgICAgIHBhcnRzLnB1c2gocGFydCk7CiAgICAgICAgcGFydCA9IG5ldyBBU1QobnVsbCwgYXN0KTsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBpZiAoYyA9PT0gIikiKSB7CiAgICAgICAgaWYgKGFjYyA9PT0gIiIgJiYgYXN0LiNwYXJ0cy5sZW5ndGggPT09IDApIHsKICAgICAgICAgIGFzdC4jZW1wdHlFeHQgPSB0cnVlOwogICAgICAgIH0KICAgICAgICBwYXJ0LnB1c2goYWNjKTsKICAgICAgICBhY2MgPSAiIjsKICAgICAgICBhc3QucHVzaCguLi5wYXJ0cywgcGFydCk7CiAgICAgICAgcmV0dXJuIGk7CiAgICAgIH0KICAgICAgYWNjICs9IGM7CiAgICB9CiAgICBhc3QudHlwZSA9IG51bGw7CiAgICBhc3QuI2hhc01hZ2ljID0gdm9pZCAwOwogICAgYXN0LiNwYXJ0cyA9IFtzdHIuc3Vic3RyaW5nKHBvcyAtIDEpXTsKICAgIHJldHVybiBpOwogIH0KICBzdGF0aWMgZnJvbUdsb2IocGF0dGVybiwgb3B0aW9ucyA9IHt9KSB7CiAgICBjb25zdCBhc3QgPSBuZXcgQVNUKG51bGwsIHZvaWQgMCwgb3B0aW9ucyk7CiAgICBBU1QuI3BhcnNlQVNUKHBhdHRlcm4sIGFzdCwgMCwgb3B0aW9ucyk7CiAgICByZXR1cm4gYXN0OwogIH0KICAvLyByZXR1cm5zIHRoZSByZWd1bGFyIGV4cHJlc3Npb24gaWYgdGhlcmUncyBtYWdpYywgb3IgdGhlIHVuZXNjYXBlZAogIC8vIHN0cmluZyBpZiBub3QuCiAgdG9NTVBhdHRlcm4oKSB7CiAgICBpZiAodGhpcyAhPT0gdGhpcy4jcm9vdCkKICAgICAgcmV0dXJuIHRoaXMuI3Jvb3QudG9NTVBhdHRlcm4oKTsKICAgIGNvbnN0IGdsb2IyID0gdGhpcy50b1N0cmluZygpOwogICAgY29uc3QgW3JlLCBib2R5LCBoYXNNYWdpYzIsIHVmbGFnXSA9IHRoaXMudG9SZWdFeHBTb3VyY2UoKTsKICAgIGNvbnN0IGFueU1hZ2ljID0gaGFzTWFnaWMyIHx8IHRoaXMuI2hhc01hZ2ljIHx8IHRoaXMuI29wdGlvbnMubm9jYXNlICYmICF0aGlzLiNvcHRpb25zLm5vY2FzZU1hZ2ljT25seSAmJiBnbG9iMi50b1VwcGVyQ2FzZSgpICE9PSBnbG9iMi50b0xvd2VyQ2FzZSgpOwogICAgaWYgKCFhbnlNYWdpYykgewogICAgICByZXR1cm4gYm9keTsKICAgIH0KICAgIGNvbnN0IGZsYWdzID0gKHRoaXMuI29wdGlvbnMubm9jYXNlID8gImkiIDogIiIpICsgKHVmbGFnID8gInUiIDogIiIpOwogICAgcmV0dXJuIE9iamVjdC5hc3NpZ24obmV3IFJlZ0V4cChgXiR7cmV9JGAsIGZsYWdzKSwgewogICAgICBfc3JjOiByZSwKICAgICAgX2dsb2I6IGdsb2IyCiAgICB9KTsKICB9CiAgLy8gcmV0dXJucyB0aGUgc3RyaW5nIG1hdGNoLCB0aGUgcmVnZXhwIHNvdXJjZSwgd2hldGhlciB0aGVyZSdzIG1hZ2ljCiAgLy8gaW4gdGhlIHJlZ2V4cCAoc28gYSByZWd1bGFyIGV4cHJlc3Npb24gaXMgcmVxdWlyZWQpIGFuZCB3aGV0aGVyIG9yCiAgLy8gbm90IHRoZSB1ZmxhZyBpcyBuZWVkZWQgZm9yIHRoZSByZWd1bGFyIGV4cHJlc3Npb24gKGZvciBwb3NpeCBjbGFzc2VzKQogIC8vIFRPRE86IGluc3RlYWQgb2YgaW5qZWN0aW5nIHRoZSBzdGFydC9lbmQgYXQgdGhpcyBwb2ludCwganVzdCByZXR1cm4KICAvLyB0aGUgQk9EWSBvZiB0aGUgcmVnZXhwLCBhbG9uZyB3aXRoIHRoZSBzdGFydC9lbmQgcG9ydGlvbnMgc3VpdGFibGUKICAvLyBmb3IgYmluZGluZyB0aGUgc3RhcnQvZW5kIGluIGVpdGhlciBhIGpvaW5lZCBmdWxsLXBhdGggbWFrZVJlIGNvbnRleHQKICAvLyAod2hlcmUgd2UgYmluZCB0byAoXnwvKSwgb3IgYSBzdGFuZGFsb25lIG1hdGNoUGFydCBjb250ZXh0ICh3aGVyZQogIC8vIHdlIGJpbmQgdG8gXiwgYW5kIG5vdCAvKS4gIE90aGVyd2lzZSBzbGFzaGVzIGdldCBkdXBlZCEKICAvLwogIC8vIEluIHBhcnQtbWF0Y2hpbmcgbW9kZSwgdGhlIHN0YXJ0IGlzOgogIC8vIC0gaWYgbm90IGlzU3RhcnQ6IG5vdGhpbmcKICAvLyAtIGlmIHRyYXZlcnNhbCBwb3NzaWJsZSwgYnV0IG5vdCBhbGxvd2VkOiBeKD8hXC5cLj8kKQogIC8vIC0gaWYgZG90cyBhbGxvd2VkIG9yIG5vdCBwb3NzaWJsZTogXgogIC8vIC0gaWYgZG90cyBwb3NzaWJsZSBhbmQgbm90IGFsbG93ZWQ6IF4oPyFcLikKICAvLyBlbmQgaXM6CiAgLy8gLSBpZiBub3QgaXNFbmQoKTogbm90aGluZwogIC8vIC0gZWxzZTogJAogIC8vCiAgLy8gSW4gZnVsbC1wYXRoIG1hdGNoaW5nIG1vZGUsIHdlIHB1dCB0aGUgc2xhc2ggYXQgdGhlIFNUQVJUIG9mIHRoZQogIC8vIHBhdHRlcm4sIHNvIHN0YXJ0IGlzOgogIC8vIC0gaWYgZmlyc3QgcGF0dGVybjogc2FtZSBhcyBwYXJ0LW1hdGNoaW5nIG1vZGUKICAvLyAtIGlmIG5vdCBpc1N0YXJ0KCk6IG5vdGhpbmcKICAvLyAtIGlmIHRyYXZlcnNhbCBwb3NzaWJsZSwgYnV0IG5vdCBhbGxvd2VkOiAvKD8hXC5cLj8oPzokfC8pKQogIC8vIC0gaWYgZG90cyBhbGxvd2VkIG9yIG5vdCBwb3NzaWJsZTogLwogIC8vIC0gaWYgZG90cyBwb3NzaWJsZSBhbmQgbm90IGFsbG93ZWQ6IC8oPyFcLikKICAvLyBlbmQgaXM6CiAgLy8gLSBpZiBsYXN0IHBhdHRlcm4sIHNhbWUgYXMgcGFydC1tYXRjaGluZyBtb2RlCiAgLy8gLSBlbHNlIG5vdGhpbmcKICAvLwogIC8vIEFsd2F5cyBwdXQgdGhlICg/OiR8Lykgb24gbmVnYXRlZCB0YWlscywgdGhvdWdoLCBiZWNhdXNlIHRoYXQgaGFzIHRvIGJlCiAgLy8gdGhlcmUgdG8gYmluZCB0aGUgZW5kIG9mIHRoZSBuZWdhdGVkIHBhdHRlcm4gcG9ydGlvbiwgYW5kIGl0J3MgZWFzaWVyIHRvCiAgLy8ganVzdCBzdGljayBpdCBpbiBub3cgcmF0aGVyIHRoYW4gdHJ5IHRvIGluamVjdCBpdCBsYXRlciBpbiB0aGUgbWlkZGxlIG9mCiAgLy8gdGhlIHBhdHRlcm4uCiAgLy8KICAvLyBXZSBjYW4ganVzdCBhbHdheXMgcmV0dXJuIHRoZSBzYW1lIGVuZCwgYW5kIGxlYXZlIGl0IHVwIHRvIHRoZSBjYWxsZXIKICAvLyB0byBrbm93IHdoZXRoZXIgaXQncyBnb2luZyB0byBiZSB1c2VkIGpvaW5lZCBvciBpbiBwYXJ0cy4KICAvLyBBbmQsIGlmIHRoZSBzdGFydCBpcyBhZGp1c3RlZCBzbGlnaHRseSwgY2FuIGRvIHRoZSBzYW1lIHRoZXJlOgogIC8vIC0gaWYgbm90IGlzU3RhcnQ6IG5vdGhpbmcKICAvLyAtIGlmIHRyYXZlcnNhbCBwb3NzaWJsZSwgYnV0IG5vdCBhbGxvd2VkOiAoPzovfF4pKD8hXC5cLj8kKQogIC8vIC0gaWYgZG90cyBhbGxvd2VkIG9yIG5vdCBwb3NzaWJsZTogKD86L3xeKQogIC8vIC0gaWYgZG90cyBwb3NzaWJsZSBhbmQgbm90IGFsbG93ZWQ6ICg/Oi98XikoPyFcLikKICAvLwogIC8vIEJ1dCBpdCdzIGJldHRlciB0byBoYXZlIGEgc2ltcGxlciBiaW5kaW5nIHdpdGhvdXQgYSBjb25kaXRpb25hbCwgZm9yCiAgLy8gcGVyZm9ybWFuY2UsIHNvIHByb2JhYmx5IGJldHRlciB0byByZXR1cm4gYm90aCBzdGFydCBvcHRpb25zLgogIC8vCiAgLy8gVGhlbiB0aGUgY2FsbGVyIGp1c3QgaWdub3JlcyB0aGUgZW5kIGlmIGl0J3Mgbm90IHRoZSBmaXJzdCBwYXR0ZXJuLAogIC8vIGFuZCB0aGUgc3RhcnQgYWx3YXlzIGdldHMgYXBwbGllZC4KICAvLwogIC8vIEJ1dCB0aGF0J3MgYWx3YXlzIGdvaW5nIHRvIGJlICQgaWYgaXQncyB0aGUgZW5kaW5nIHBhdHRlcm4sIG9yIG5vdGhpbmcsCiAgLy8gc28gdGhlIGNhbGxlciBjYW4ganVzdCBhdHRhY2ggJCBhdCB0aGUgZW5kIG9mIHRoZSBwYXR0ZXJuIHdoZW4gYnVpbGRpbmcuCiAgLy8KICAvLyBTbyB0aGUgdG9kbyBpczoKICAvLyAtIGJldHRlciBkZXRlY3Qgd2hhdCBraW5kIG9mIHN0YXJ0IGlzIG5lZWRlZAogIC8vIC0gcmV0dXJuIGJvdGggZmxhdm9ycyBvZiBzdGFydGluZyBwYXR0ZXJuCiAgLy8gLSBhdHRhY2ggJCBhdCB0aGUgZW5kIG9mIHRoZSBwYXR0ZXJuIHdoZW4gY3JlYXRpbmcgdGhlIGFjdHVhbCBSZWdFeHAKICAvLwogIC8vIEFoLCBidXQgd2FpdCwgbm8sIHRoYXQgYWxsIG9ubHkgYXBwbGllcyB0byB0aGUgcm9vdCB3aGVuIHRoZSBmaXJzdCBwYXR0ZXJuCiAgLy8gaXMgbm90IGFuIGV4dGdsb2IuIElmIHRoZSBmaXJzdCBwYXR0ZXJuIElTIGFuIGV4dGdsb2IsIHRoZW4gd2UgbmVlZCBhbGwKICAvLyB0aGF0IGRvdCBwcmV2ZW50aW9uIGJpeiB0byBsaXZlIGluIHRoZSBleHRnbG9iIHBvcnRpb25zLCBiZWNhdXNlIGVnCiAgLy8gKygqfC54KikgY2FuIG1hdGNoIC54eSBidXQgbm90IC55eC4KICAvLwogIC8vIFNvLCByZXR1cm4gdGhlIHR3byBmbGF2b3JzIGlmIGl0J3MgI3Jvb3QgYW5kIHRoZSBmaXJzdCBjaGlsZCBpcyBub3QgYW4KICAvLyBBU1QsIG90aGVyd2lzZSBsZWF2ZSBpdCB0byB0aGUgY2hpbGQgQVNUIHRvIGhhbmRsZSBpdCwgYW5kIHRoZXJlLAogIC8vIHVzZSB0aGUgKD86XnwvKSBzdHlsZSBvZiBzdGFydCBiaW5kaW5nLgogIC8vCiAgLy8gRXZlbiBzaW1wbGlmaWVkIGZ1cnRoZXI6CiAgLy8gLSBTaW5jZSB0aGUgc3RhcnQgZm9yIGEgam9pbiBpcyBlZyAvKD8hXC4pIGFuZCB0aGUgc3RhcnQgZm9yIGEgcGFydAogIC8vIGlzIF4oPyFcLiksIHdlIGNhbiBqdXN0IHByZXBlbmQgKD8hXC4pIHRvIHRoZSBwYXR0ZXJuIChlaXRoZXIgcm9vdAogIC8vIG9yIHN0YXJ0IG9yIHdoYXRldmVyKSBhbmQgcHJlcGVuZCBeIG9yIC8gYXQgdGhlIFJlZ2V4cCBjb25zdHJ1Y3Rpb24uCiAgdG9SZWdFeHBTb3VyY2UoYWxsb3dEb3QpIHsKICAgIGNvbnN0IGRvdCA9IGFsbG93RG90ID8/ICEhdGhpcy4jb3B0aW9ucy5kb3Q7CiAgICBpZiAodGhpcy4jcm9vdCA9PT0gdGhpcykKICAgICAgdGhpcy4jZmlsbE5lZ3MoKTsKICAgIGlmICghdGhpcy50eXBlKSB7CiAgICAgIGNvbnN0IG5vRW1wdHkgPSB0aGlzLmlzU3RhcnQoKSAmJiB0aGlzLmlzRW5kKCk7CiAgICAgIGNvbnN0IHNyYyA9IHRoaXMuI3BhcnRzLm1hcCgocCkgPT4gewogICAgICAgIGNvbnN0IFtyZSwgXywgaGFzTWFnaWMyLCB1ZmxhZ10gPSB0eXBlb2YgcCA9PT0gInN0cmluZyIgPyBBU1QuI3BhcnNlR2xvYihwLCB0aGlzLiNoYXNNYWdpYywgbm9FbXB0eSkgOiBwLnRvUmVnRXhwU291cmNlKGFsbG93RG90KTsKICAgICAgICB0aGlzLiNoYXNNYWdpYyA9IHRoaXMuI2hhc01hZ2ljIHx8IGhhc01hZ2ljMjsKICAgICAgICB0aGlzLiN1ZmxhZyA9IHRoaXMuI3VmbGFnIHx8IHVmbGFnOwogICAgICAgIHJldHVybiByZTsKICAgICAgfSkuam9pbigiIik7CiAgICAgIGxldCBzdGFydDIgPSAiIjsKICAgICAgaWYgKHRoaXMuaXNTdGFydCgpKSB7CiAgICAgICAgaWYgKHR5cGVvZiB0aGlzLiNwYXJ0c1swXSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgIGNvbnN0IGRvdFRyYXZBbGxvd2VkID0gdGhpcy4jcGFydHMubGVuZ3RoID09PSAxICYmIGp1c3REb3RzLmhhcyh0aGlzLiNwYXJ0c1swXSk7CiAgICAgICAgICBpZiAoIWRvdFRyYXZBbGxvd2VkKSB7CiAgICAgICAgICAgIGNvbnN0IGFwcyA9IGFkZFBhdHRlcm5TdGFydDsKICAgICAgICAgICAgY29uc3QgbmVlZE5vVHJhdiA9ICgKICAgICAgICAgICAgICAvLyBkb3RzIGFyZSBhbGxvd2VkLCBhbmQgdGhlIHBhdHRlcm4gc3RhcnRzIHdpdGggWyBvciAuCiAgICAgICAgICAgICAgZG90ICYmIGFwcy5oYXMoc3JjLmNoYXJBdCgwKSkgfHwgLy8gdGhlIHBhdHRlcm4gc3RhcnRzIHdpdGggXC4sIGFuZCB0aGVuIFsgb3IgLgogICAgICAgICAgICAgIHNyYy5zdGFydHNXaXRoKCJcXC4iKSAmJiBhcHMuaGFzKHNyYy5jaGFyQXQoMikpIHx8IC8vIHRoZSBwYXR0ZXJuIHN0YXJ0cyB3aXRoIFwuXC4sIGFuZCB0aGVuIFsgb3IgLgogICAgICAgICAgICAgIHNyYy5zdGFydHNXaXRoKCJcXC5cXC4iKSAmJiBhcHMuaGFzKHNyYy5jaGFyQXQoNCkpCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGNvbnN0IG5lZWROb0RvdCA9ICFkb3QgJiYgIWFsbG93RG90ICYmIGFwcy5oYXMoc3JjLmNoYXJBdCgwKSk7CiAgICAgICAgICAgIHN0YXJ0MiA9IG5lZWROb1RyYXYgPyBzdGFydE5vVHJhdmVyc2FsIDogbmVlZE5vRG90ID8gc3RhcnROb0RvdCA6ICIiOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICBsZXQgZW5kID0gIiI7CiAgICAgIGlmICh0aGlzLmlzRW5kKCkgJiYgdGhpcy4jcm9vdC4jZmlsbGVkTmVncyAmJiB0aGlzLiNwYXJlbnQ/LnR5cGUgPT09ICIhIikgewogICAgICAgIGVuZCA9ICIoPzokfFxcLykiOwogICAgICB9CiAgICAgIGNvbnN0IGZpbmFsMiA9IHN0YXJ0MiArIHNyYyArIGVuZDsKICAgICAgcmV0dXJuIFsKICAgICAgICBmaW5hbDIsCiAgICAgICAgdW5lc2NhcGUkMShzcmMpLAogICAgICAgIHRoaXMuI2hhc01hZ2ljID0gISF0aGlzLiNoYXNNYWdpYywKICAgICAgICB0aGlzLiN1ZmxhZwogICAgICBdOwogICAgfQogICAgY29uc3QgcmVwZWF0ZWQgPSB0aGlzLnR5cGUgPT09ICIqIiB8fCB0aGlzLnR5cGUgPT09ICIrIjsKICAgIGNvbnN0IHN0YXJ0ID0gdGhpcy50eXBlID09PSAiISIgPyAiKD86KD8hKD86IiA6ICIoPzoiOwogICAgbGV0IGJvZHkgPSB0aGlzLiNwYXJ0c1RvUmVnRXhwKGRvdCk7CiAgICBpZiAodGhpcy5pc1N0YXJ0KCkgJiYgdGhpcy5pc0VuZCgpICYmICFib2R5ICYmIHRoaXMudHlwZSAhPT0gIiEiKSB7CiAgICAgIGNvbnN0IHMgPSB0aGlzLnRvU3RyaW5nKCk7CiAgICAgIHRoaXMuI3BhcnRzID0gW3NdOwogICAgICB0aGlzLnR5cGUgPSBudWxsOwogICAgICB0aGlzLiNoYXNNYWdpYyA9IHZvaWQgMDsKICAgICAgcmV0dXJuIFtzLCB1bmVzY2FwZSQxKHRoaXMudG9TdHJpbmcoKSksIGZhbHNlLCBmYWxzZV07CiAgICB9CiAgICBsZXQgYm9keURvdEFsbG93ZWQgPSAhcmVwZWF0ZWQgfHwgYWxsb3dEb3QgfHwgZG90IHx8ICFzdGFydE5vRG90ID8gIiIgOiB0aGlzLiNwYXJ0c1RvUmVnRXhwKHRydWUpOwogICAgaWYgKGJvZHlEb3RBbGxvd2VkID09PSBib2R5KSB7CiAgICAgIGJvZHlEb3RBbGxvd2VkID0gIiI7CiAgICB9CiAgICBpZiAoYm9keURvdEFsbG93ZWQpIHsKICAgICAgYm9keSA9IGAoPzoke2JvZHl9KSg/OiR7Ym9keURvdEFsbG93ZWR9KSo/YDsKICAgIH0KICAgIGxldCBmaW5hbCA9ICIiOwogICAgaWYgKHRoaXMudHlwZSA9PT0gIiEiICYmIHRoaXMuI2VtcHR5RXh0KSB7CiAgICAgIGZpbmFsID0gKHRoaXMuaXNTdGFydCgpICYmICFkb3QgPyBzdGFydE5vRG90IDogIiIpICsgc3Rhck5vRW1wdHk7CiAgICB9IGVsc2UgewogICAgICBjb25zdCBjbG9zZSA9IHRoaXMudHlwZSA9PT0gIiEiID8gKAogICAgICAgIC8vICEoKSBtdXN0IG1hdGNoIHNvbWV0aGluZyxidXQgISh4KSBjYW4gbWF0Y2ggJycKICAgICAgICAiKSkiICsgKHRoaXMuaXNTdGFydCgpICYmICFkb3QgJiYgIWFsbG93RG90ID8gc3RhcnROb0RvdCA6ICIiKSArIHN0YXIkMSArICIpIgogICAgICApIDogdGhpcy50eXBlID09PSAiQCIgPyAiKSIgOiB0aGlzLnR5cGUgPT09ICI/IiA/ICIpPyIgOiB0aGlzLnR5cGUgPT09ICIrIiAmJiBib2R5RG90QWxsb3dlZCA/ICIpIiA6IHRoaXMudHlwZSA9PT0gIioiICYmIGJvZHlEb3RBbGxvd2VkID8gYCk/YCA6IGApJHt0aGlzLnR5cGV9YDsKICAgICAgZmluYWwgPSBzdGFydCArIGJvZHkgKyBjbG9zZTsKICAgIH0KICAgIHJldHVybiBbCiAgICAgIGZpbmFsLAogICAgICB1bmVzY2FwZSQxKGJvZHkpLAogICAgICB0aGlzLiNoYXNNYWdpYyA9ICEhdGhpcy4jaGFzTWFnaWMsCiAgICAgIHRoaXMuI3VmbGFnCiAgICBdOwogIH0KICAjcGFydHNUb1JlZ0V4cChkb3QpIHsKICAgIHJldHVybiB0aGlzLiNwYXJ0cy5tYXAoKHApID0+IHsKICAgICAgaWYgKHR5cGVvZiBwID09PSAic3RyaW5nIikgewogICAgICAgIHRocm93IG5ldyBFcnJvcigic3RyaW5nIHR5cGUgaW4gZXh0Z2xvYiBhc3Q/PyIpOwogICAgICB9CiAgICAgIGNvbnN0IFtyZSwgXywgX2hhc01hZ2ljLCB1ZmxhZ10gPSBwLnRvUmVnRXhwU291cmNlKGRvdCk7CiAgICAgIHRoaXMuI3VmbGFnID0gdGhpcy4jdWZsYWcgfHwgdWZsYWc7CiAgICAgIHJldHVybiByZTsKICAgIH0pLmZpbHRlcigocCkgPT4gISh0aGlzLmlzU3RhcnQoKSAmJiB0aGlzLmlzRW5kKCkpIHx8ICEhcCkuam9pbigifCIpOwogIH0KICBzdGF0aWMgI3BhcnNlR2xvYihnbG9iMiwgaGFzTWFnaWMyLCBub0VtcHR5ID0gZmFsc2UpIHsKICAgIGxldCBlc2NhcGluZyA9IGZhbHNlOwogICAgbGV0IHJlID0gIiI7CiAgICBsZXQgdWZsYWcgPSBmYWxzZTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZ2xvYjIubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgYyA9IGdsb2IyLmNoYXJBdChpKTsKICAgICAgaWYgKGVzY2FwaW5nKSB7CiAgICAgICAgZXNjYXBpbmcgPSBmYWxzZTsKICAgICAgICByZSArPSAocmVTcGVjaWFscy5oYXMoYykgPyAiXFwiIDogIiIpICsgYzsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBpZiAoYyA9PT0gIlxcIikgewogICAgICAgIGlmIChpID09PSBnbG9iMi5sZW5ndGggLSAxKSB7CiAgICAgICAgICByZSArPSAiXFxcXCI7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGVzY2FwaW5nID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgaWYgKGMgPT09ICJbIikgewogICAgICAgIGNvbnN0IFtzcmMsIG5lZWRVZmxhZywgY29uc3VtZWQsIG1hZ2ljXSA9IHBhcnNlQ2xhc3MoZ2xvYjIsIGkpOwogICAgICAgIGlmIChjb25zdW1lZCkgewogICAgICAgICAgcmUgKz0gc3JjOwogICAgICAgICAgdWZsYWcgPSB1ZmxhZyB8fCBuZWVkVWZsYWc7CiAgICAgICAgICBpICs9IGNvbnN1bWVkIC0gMTsKICAgICAgICAgIGhhc01hZ2ljMiA9IGhhc01hZ2ljMiB8fCBtYWdpYzsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoYyA9PT0gIioiKSB7CiAgICAgICAgaWYgKG5vRW1wdHkgJiYgZ2xvYjIgPT09ICIqIikKICAgICAgICAgIHJlICs9IHN0YXJOb0VtcHR5OwogICAgICAgIGVsc2UKICAgICAgICAgIHJlICs9IHN0YXIkMTsKICAgICAgICBoYXNNYWdpYzIgPSB0cnVlOwogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGlmIChjID09PSAiPyIpIHsKICAgICAgICByZSArPSBxbWFyayQxOwogICAgICAgIGhhc01hZ2ljMiA9IHRydWU7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgcmUgKz0gcmVnRXhwRXNjYXBlJDEoYyk7CiAgICB9CiAgICByZXR1cm4gW3JlLCB1bmVzY2FwZSQxKGdsb2IyKSwgISFoYXNNYWdpYzIsIHVmbGFnXTsKICB9Cn0KY29uc3QgZXNjYXBlID0gKHMsIHsgd2luZG93c1BhdGhzTm9Fc2NhcGUgPSBmYWxzZSB9ID0ge30pID0+IHsKICByZXR1cm4gd2luZG93c1BhdGhzTm9Fc2NhcGUgPyBzLnJlcGxhY2UoL1s/KigpW1xdXS9nLCAiWyQmXSIpIDogcy5yZXBsYWNlKC9bPyooKVtcXVxcXS9nLCAiXFwkJiIpOwp9Owpjb25zdCBtaW5pbWF0Y2ggPSAocCwgcGF0dGVybiwgb3B0aW9ucyA9IHt9KSA9PiB7CiAgYXNzZXJ0VmFsaWRQYXR0ZXJuKHBhdHRlcm4pOwogIGlmICghb3B0aW9ucy5ub2NvbW1lbnQgJiYgcGF0dGVybi5jaGFyQXQoMCkgPT09ICIjIikgewogICAgcmV0dXJuIGZhbHNlOwogIH0KICByZXR1cm4gbmV3IE1pbmltYXRjaChwYXR0ZXJuLCBvcHRpb25zKS5tYXRjaChwKTsKfTsKY29uc3Qgc3RhckRvdEV4dFJFID0gL15cKisoW14rQCE/XCpcW1woXSopJC87CmNvbnN0IHN0YXJEb3RFeHRUZXN0ID0gKGV4dDIpID0+IChmKSA9PiAhZi5zdGFydHNXaXRoKCIuIikgJiYgZi5lbmRzV2l0aChleHQyKTsKY29uc3Qgc3RhckRvdEV4dFRlc3REb3QgPSAoZXh0MikgPT4gKGYpID0+IGYuZW5kc1dpdGgoZXh0Mik7CmNvbnN0IHN0YXJEb3RFeHRUZXN0Tm9jYXNlID0gKGV4dDIpID0+IHsKICBleHQyID0gZXh0Mi50b0xvd2VyQ2FzZSgpOwogIHJldHVybiAoZikgPT4gIWYuc3RhcnRzV2l0aCgiLiIpICYmIGYudG9Mb3dlckNhc2UoKS5lbmRzV2l0aChleHQyKTsKfTsKY29uc3Qgc3RhckRvdEV4dFRlc3ROb2Nhc2VEb3QgPSAoZXh0MikgPT4gewogIGV4dDIgPSBleHQyLnRvTG93ZXJDYXNlKCk7CiAgcmV0dXJuIChmKSA9PiBmLnRvTG93ZXJDYXNlKCkuZW5kc1dpdGgoZXh0Mik7Cn07CmNvbnN0IHN0YXJEb3RTdGFyUkUgPSAvXlwqK1wuXCorJC87CmNvbnN0IHN0YXJEb3RTdGFyVGVzdCA9IChmKSA9PiAhZi5zdGFydHNXaXRoKCIuIikgJiYgZi5pbmNsdWRlcygiLiIpOwpjb25zdCBzdGFyRG90U3RhclRlc3REb3QgPSAoZikgPT4gZiAhPT0gIi4iICYmIGYgIT09ICIuLiIgJiYgZi5pbmNsdWRlcygiLiIpOwpjb25zdCBkb3RTdGFyUkUgPSAvXlwuXCorJC87CmNvbnN0IGRvdFN0YXJUZXN0ID0gKGYpID0+IGYgIT09ICIuIiAmJiBmICE9PSAiLi4iICYmIGYuc3RhcnRzV2l0aCgiLiIpOwpjb25zdCBzdGFyUkUgPSAvXlwqKyQvOwpjb25zdCBzdGFyVGVzdCA9IChmKSA9PiBmLmxlbmd0aCAhPT0gMCAmJiAhZi5zdGFydHNXaXRoKCIuIik7CmNvbnN0IHN0YXJUZXN0RG90ID0gKGYpID0+IGYubGVuZ3RoICE9PSAwICYmIGYgIT09ICIuIiAmJiBmICE9PSAiLi4iOwpjb25zdCBxbWFya3NSRSA9IC9eXD8rKFteK0AhP1wqXFtcKF0qKT8kLzsKY29uc3QgcW1hcmtzVGVzdE5vY2FzZSA9IChbJDAsIGV4dDIgPSAiIl0pID0+IHsKICBjb25zdCBub2V4dCA9IHFtYXJrc1Rlc3ROb0V4dChbJDBdKTsKICBpZiAoIWV4dDIpCiAgICByZXR1cm4gbm9leHQ7CiAgZXh0MiA9IGV4dDIudG9Mb3dlckNhc2UoKTsKICByZXR1cm4gKGYpID0+IG5vZXh0KGYpICYmIGYudG9Mb3dlckNhc2UoKS5lbmRzV2l0aChleHQyKTsKfTsKY29uc3QgcW1hcmtzVGVzdE5vY2FzZURvdCA9IChbJDAsIGV4dDIgPSAiIl0pID0+IHsKICBjb25zdCBub2V4dCA9IHFtYXJrc1Rlc3ROb0V4dERvdChbJDBdKTsKICBpZiAoIWV4dDIpCiAgICByZXR1cm4gbm9leHQ7CiAgZXh0MiA9IGV4dDIudG9Mb3dlckNhc2UoKTsKICByZXR1cm4gKGYpID0+IG5vZXh0KGYpICYmIGYudG9Mb3dlckNhc2UoKS5lbmRzV2l0aChleHQyKTsKfTsKY29uc3QgcW1hcmtzVGVzdERvdCA9IChbJDAsIGV4dDIgPSAiIl0pID0+IHsKICBjb25zdCBub2V4dCA9IHFtYXJrc1Rlc3ROb0V4dERvdChbJDBdKTsKICByZXR1cm4gIWV4dDIgPyBub2V4dCA6IChmKSA9PiBub2V4dChmKSAmJiBmLmVuZHNXaXRoKGV4dDIpOwp9Owpjb25zdCBxbWFya3NUZXN0ID0gKFskMCwgZXh0MiA9ICIiXSkgPT4gewogIGNvbnN0IG5vZXh0ID0gcW1hcmtzVGVzdE5vRXh0KFskMF0pOwogIHJldHVybiAhZXh0MiA/IG5vZXh0IDogKGYpID0+IG5vZXh0KGYpICYmIGYuZW5kc1dpdGgoZXh0Mik7Cn07CmNvbnN0IHFtYXJrc1Rlc3ROb0V4dCA9IChbJDBdKSA9PiB7CiAgY29uc3QgbGVuID0gJDAubGVuZ3RoOwogIHJldHVybiAoZikgPT4gZi5sZW5ndGggPT09IGxlbiAmJiAhZi5zdGFydHNXaXRoKCIuIik7Cn07CmNvbnN0IHFtYXJrc1Rlc3ROb0V4dERvdCA9IChbJDBdKSA9PiB7CiAgY29uc3QgbGVuID0gJDAubGVuZ3RoOwogIHJldHVybiAoZikgPT4gZi5sZW5ndGggPT09IGxlbiAmJiBmICE9PSAiLiIgJiYgZiAhPT0gIi4uIjsKfTsKY29uc3QgZGVmYXVsdFBsYXRmb3JtJDIgPSB0eXBlb2YgcHJvY2VzcyA9PT0gIm9iamVjdCIgJiYgcHJvY2VzcyA/IHR5cGVvZiBwcm9jZXNzLmVudiA9PT0gIm9iamVjdCIgJiYgcHJvY2Vzcy5lbnYgJiYgcHJvY2Vzcy5lbnYuX19NSU5JTUFUQ0hfVEVTVElOR19QTEFURk9STV9fIHx8IHByb2Nlc3MucGxhdGZvcm0gOiAicG9zaXgiOwpjb25zdCBwYXRoID0gewogIHdpbjMyOiB7IHNlcDogIlxcIiB9LAogIHBvc2l4OiB7IHNlcDogIi8iIH0KfTsKY29uc3Qgc2VwID0gZGVmYXVsdFBsYXRmb3JtJDIgPT09ICJ3aW4zMiIgPyBwYXRoLndpbjMyLnNlcCA6IHBhdGgucG9zaXguc2VwOwptaW5pbWF0Y2guc2VwID0gc2VwOwpjb25zdCBHTE9CU1RBUiA9IFN5bWJvbCgiZ2xvYnN0YXIgKioiKTsKbWluaW1hdGNoLkdMT0JTVEFSID0gR0xPQlNUQVI7CmNvbnN0IHFtYXJrID0gIlteL10iOwpjb25zdCBzdGFyID0gcW1hcmsgKyAiKj8iOwpjb25zdCB0d29TdGFyRG90ID0gIig/Oig/ISg/OlxcL3xeKSg/OlxcLnsxLDJ9KSgkfFxcLykpLikqPyI7CmNvbnN0IHR3b1N0YXJOb0RvdCA9ICIoPzooPyEoPzpcXC98XilcXC4pLikqPyI7CmNvbnN0IGZpbHRlciA9IChwYXR0ZXJuLCBvcHRpb25zID0ge30pID0+IChwKSA9PiBtaW5pbWF0Y2gocCwgcGF0dGVybiwgb3B0aW9ucyk7Cm1pbmltYXRjaC5maWx0ZXIgPSBmaWx0ZXI7CmNvbnN0IGV4dCA9IChhLCBiID0ge30pID0+IE9iamVjdC5hc3NpZ24oe30sIGEsIGIpOwpjb25zdCBkZWZhdWx0cyA9IChkZWYpID0+IHsKICBpZiAoIWRlZiB8fCB0eXBlb2YgZGVmICE9PSAib2JqZWN0IiB8fCAhT2JqZWN0LmtleXMoZGVmKS5sZW5ndGgpIHsKICAgIHJldHVybiBtaW5pbWF0Y2g7CiAgfQogIGNvbnN0IG9yaWcgPSBtaW5pbWF0Y2g7CiAgY29uc3QgbSA9IChwLCBwYXR0ZXJuLCBvcHRpb25zID0ge30pID0+IG9yaWcocCwgcGF0dGVybiwgZXh0KGRlZiwgb3B0aW9ucykpOwogIHJldHVybiBPYmplY3QuYXNzaWduKG0sIHsKICAgIE1pbmltYXRjaDogY2xhc3MgTWluaW1hdGNoIGV4dGVuZHMgb3JpZy5NaW5pbWF0Y2ggewogICAgICBjb25zdHJ1Y3RvcihwYXR0ZXJuLCBvcHRpb25zID0ge30pIHsKICAgICAgICBzdXBlcihwYXR0ZXJuLCBleHQoZGVmLCBvcHRpb25zKSk7CiAgICAgIH0KICAgICAgc3RhdGljIGRlZmF1bHRzKG9wdGlvbnMpIHsKICAgICAgICByZXR1cm4gb3JpZy5kZWZhdWx0cyhleHQoZGVmLCBvcHRpb25zKSkuTWluaW1hdGNoOwogICAgICB9CiAgICB9LAogICAgQVNUOiBjbGFzcyBBU1QgZXh0ZW5kcyBvcmlnLkFTVCB7CiAgICAgIC8qIGM4IGlnbm9yZSBzdGFydCAqLwogICAgICBjb25zdHJ1Y3Rvcih0eXBlLCBwYXJlbnQsIG9wdGlvbnMgPSB7fSkgewogICAgICAgIHN1cGVyKHR5cGUsIHBhcmVudCwgZXh0KGRlZiwgb3B0aW9ucykpOwogICAgICB9CiAgICAgIC8qIGM4IGlnbm9yZSBzdG9wICovCiAgICAgIHN0YXRpYyBmcm9tR2xvYihwYXR0ZXJuLCBvcHRpb25zID0ge30pIHsKICAgICAgICByZXR1cm4gb3JpZy5BU1QuZnJvbUdsb2IocGF0dGVybiwgZXh0KGRlZiwgb3B0aW9ucykpOwogICAgICB9CiAgICB9LAogICAgdW5lc2NhcGU6IChzLCBvcHRpb25zID0ge30pID0+IG9yaWcudW5lc2NhcGUocywgZXh0KGRlZiwgb3B0aW9ucykpLAogICAgZXNjYXBlOiAocywgb3B0aW9ucyA9IHt9KSA9PiBvcmlnLmVzY2FwZShzLCBleHQoZGVmLCBvcHRpb25zKSksCiAgICBmaWx0ZXI6IChwYXR0ZXJuLCBvcHRpb25zID0ge30pID0+IG9yaWcuZmlsdGVyKHBhdHRlcm4sIGV4dChkZWYsIG9wdGlvbnMpKSwKICAgIGRlZmF1bHRzOiAob3B0aW9ucykgPT4gb3JpZy5kZWZhdWx0cyhleHQoZGVmLCBvcHRpb25zKSksCiAgICBtYWtlUmU6IChwYXR0ZXJuLCBvcHRpb25zID0ge30pID0+IG9yaWcubWFrZVJlKHBhdHRlcm4sIGV4dChkZWYsIG9wdGlvbnMpKSwKICAgIGJyYWNlRXhwYW5kOiAocGF0dGVybiwgb3B0aW9ucyA9IHt9KSA9PiBvcmlnLmJyYWNlRXhwYW5kKHBhdHRlcm4sIGV4dChkZWYsIG9wdGlvbnMpKSwKICAgIG1hdGNoOiAobGlzdCwgcGF0dGVybiwgb3B0aW9ucyA9IHt9KSA9PiBvcmlnLm1hdGNoKGxpc3QsIHBhdHRlcm4sIGV4dChkZWYsIG9wdGlvbnMpKSwKICAgIHNlcDogb3JpZy5zZXAsCiAgICBHTE9CU1RBUgogIH0pOwp9OwptaW5pbWF0Y2guZGVmYXVsdHMgPSBkZWZhdWx0czsKY29uc3QgYnJhY2VFeHBhbmQgPSAocGF0dGVybiwgb3B0aW9ucyA9IHt9KSA9PiB7CiAgYXNzZXJ0VmFsaWRQYXR0ZXJuKHBhdHRlcm4pOwogIGlmIChvcHRpb25zLm5vYnJhY2UgfHwgIS9ceyg/Oig/IVx7KS4pKlx9Ly50ZXN0KHBhdHRlcm4pKSB7CiAgICByZXR1cm4gW3BhdHRlcm5dOwogIH0KICByZXR1cm4gZXhwYW5kJDEocGF0dGVybik7Cn07Cm1pbmltYXRjaC5icmFjZUV4cGFuZCA9IGJyYWNlRXhwYW5kOwpjb25zdCBtYWtlUmUgPSAocGF0dGVybiwgb3B0aW9ucyA9IHt9KSA9PiBuZXcgTWluaW1hdGNoKHBhdHRlcm4sIG9wdGlvbnMpLm1ha2VSZSgpOwptaW5pbWF0Y2gubWFrZVJlID0gbWFrZVJlOwpjb25zdCBtYXRjaCA9IChsaXN0LCBwYXR0ZXJuLCBvcHRpb25zID0ge30pID0+IHsKICBjb25zdCBtbSA9IG5ldyBNaW5pbWF0Y2gocGF0dGVybiwgb3B0aW9ucyk7CiAgbGlzdCA9IGxpc3QuZmlsdGVyKChmKSA9PiBtbS5tYXRjaChmKSk7CiAgaWYgKG1tLm9wdGlvbnMubm9udWxsICYmICFsaXN0Lmxlbmd0aCkgewogICAgbGlzdC5wdXNoKHBhdHRlcm4pOwogIH0KICByZXR1cm4gbGlzdDsKfTsKbWluaW1hdGNoLm1hdGNoID0gbWF0Y2g7CmNvbnN0IGdsb2JNYWdpYyA9IC9bPypdfFsrQCFdXCguKj9cKXxcW3xcXS87CmNvbnN0IHJlZ0V4cEVzY2FwZSA9IChzKSA9PiBzLnJlcGxhY2UoL1stW1xde30oKSorPy4sXFxeJHwjXHNdL2csICJcXCQmIik7CmNsYXNzIE1pbmltYXRjaCB7CiAgb3B0aW9uczsKICBzZXQ7CiAgcGF0dGVybjsKICB3aW5kb3dzUGF0aHNOb0VzY2FwZTsKICBub25lZ2F0ZTsKICBuZWdhdGU7CiAgY29tbWVudDsKICBlbXB0eTsKICBwcmVzZXJ2ZU11bHRpcGxlU2xhc2hlczsKICBwYXJ0aWFsOwogIGdsb2JTZXQ7CiAgZ2xvYlBhcnRzOwogIG5vY2FzZTsKICBpc1dpbmRvd3M7CiAgcGxhdGZvcm07CiAgd2luZG93c05vTWFnaWNSb290OwogIHJlZ2V4cDsKICBjb25zdHJ1Y3RvcihwYXR0ZXJuLCBvcHRpb25zID0ge30pIHsKICAgIGFzc2VydFZhbGlkUGF0dGVybihwYXR0ZXJuKTsKICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgdGhpcy5vcHRpb25zID0gb3B0aW9uczsKICAgIHRoaXMucGF0dGVybiA9IHBhdHRlcm47CiAgICB0aGlzLnBsYXRmb3JtID0gb3B0aW9ucy5wbGF0Zm9ybSB8fCBkZWZhdWx0UGxhdGZvcm0kMjsKICAgIHRoaXMuaXNXaW5kb3dzID0gdGhpcy5wbGF0Zm9ybSA9PT0gIndpbjMyIjsKICAgIHRoaXMud2luZG93c1BhdGhzTm9Fc2NhcGUgPSAhIW9wdGlvbnMud2luZG93c1BhdGhzTm9Fc2NhcGUgfHwgb3B0aW9ucy5hbGxvd1dpbmRvd3NFc2NhcGUgPT09IGZhbHNlOwogICAgaWYgKHRoaXMud2luZG93c1BhdGhzTm9Fc2NhcGUpIHsKICAgICAgdGhpcy5wYXR0ZXJuID0gdGhpcy5wYXR0ZXJuLnJlcGxhY2UoL1xcL2csICIvIik7CiAgICB9CiAgICB0aGlzLnByZXNlcnZlTXVsdGlwbGVTbGFzaGVzID0gISFvcHRpb25zLnByZXNlcnZlTXVsdGlwbGVTbGFzaGVzOwogICAgdGhpcy5yZWdleHAgPSBudWxsOwogICAgdGhpcy5uZWdhdGUgPSBmYWxzZTsKICAgIHRoaXMubm9uZWdhdGUgPSAhIW9wdGlvbnMubm9uZWdhdGU7CiAgICB0aGlzLmNvbW1lbnQgPSBmYWxzZTsKICAgIHRoaXMuZW1wdHkgPSBmYWxzZTsKICAgIHRoaXMucGFydGlhbCA9ICEhb3B0aW9ucy5wYXJ0aWFsOwogICAgdGhpcy5ub2Nhc2UgPSAhIXRoaXMub3B0aW9ucy5ub2Nhc2U7CiAgICB0aGlzLndpbmRvd3NOb01hZ2ljUm9vdCA9IG9wdGlvbnMud2luZG93c05vTWFnaWNSb290ICE9PSB2b2lkIDAgPyBvcHRpb25zLndpbmRvd3NOb01hZ2ljUm9vdCA6ICEhKHRoaXMuaXNXaW5kb3dzICYmIHRoaXMubm9jYXNlKTsKICAgIHRoaXMuZ2xvYlNldCA9IFtdOwogICAgdGhpcy5nbG9iUGFydHMgPSBbXTsKICAgIHRoaXMuc2V0ID0gW107CiAgICB0aGlzLm1ha2UoKTsKICB9CiAgaGFzTWFnaWMoKSB7CiAgICBpZiAodGhpcy5vcHRpb25zLm1hZ2ljYWxCcmFjZXMgJiYgdGhpcy5zZXQubGVuZ3RoID4gMSkgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIGZvciAoY29uc3QgcGF0dGVybiBvZiB0aGlzLnNldCkgewogICAgICBmb3IgKGNvbnN0IHBhcnQgb2YgcGF0dGVybikgewogICAgICAgIGlmICh0eXBlb2YgcGFydCAhPT0gInN0cmluZyIpCiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGZhbHNlOwogIH0KICBkZWJ1ZyguLi5fKSB7CiAgfQogIG1ha2UoKSB7CiAgICBjb25zdCBwYXR0ZXJuID0gdGhpcy5wYXR0ZXJuOwogICAgY29uc3Qgb3B0aW9ucyA9IHRoaXMub3B0aW9uczsKICAgIGlmICghb3B0aW9ucy5ub2NvbW1lbnQgJiYgcGF0dGVybi5jaGFyQXQoMCkgPT09ICIjIikgewogICAgICB0aGlzLmNvbW1lbnQgPSB0cnVlOwogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoIXBhdHRlcm4pIHsKICAgICAgdGhpcy5lbXB0eSA9IHRydWU7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMucGFyc2VOZWdhdGUoKTsKICAgIHRoaXMuZ2xvYlNldCA9IFsuLi5uZXcgU2V0KHRoaXMuYnJhY2VFeHBhbmQoKSldOwogICAgaWYgKG9wdGlvbnMuZGVidWcpIHsKICAgICAgdGhpcy5kZWJ1ZyA9ICguLi5hcmdzKSA9PiBjb25zb2xlLmVycm9yKC4uLmFyZ3MpOwogICAgfQogICAgdGhpcy5kZWJ1Zyh0aGlzLnBhdHRlcm4sIHRoaXMuZ2xvYlNldCk7CiAgICBjb25zdCByYXdHbG9iUGFydHMgPSB0aGlzLmdsb2JTZXQubWFwKChzKSA9PiB0aGlzLnNsYXNoU3BsaXQocykpOwogICAgdGhpcy5nbG9iUGFydHMgPSB0aGlzLnByZXByb2Nlc3MocmF3R2xvYlBhcnRzKTsKICAgIHRoaXMuZGVidWcodGhpcy5wYXR0ZXJuLCB0aGlzLmdsb2JQYXJ0cyk7CiAgICBsZXQgc2V0ID0gdGhpcy5nbG9iUGFydHMubWFwKChzLCBfLCBfXykgPT4gewogICAgICBpZiAodGhpcy5pc1dpbmRvd3MgJiYgdGhpcy53aW5kb3dzTm9NYWdpY1Jvb3QpIHsKICAgICAgICBjb25zdCBpc1VOQyA9IHNbMF0gPT09ICIiICYmIHNbMV0gPT09ICIiICYmIChzWzJdID09PSAiPyIgfHwgIWdsb2JNYWdpYy50ZXN0KHNbMl0pKSAmJiAhZ2xvYk1hZ2ljLnRlc3Qoc1szXSk7CiAgICAgICAgY29uc3QgaXNEcml2ZSA9IC9eW2Etel06L2kudGVzdChzWzBdKTsKICAgICAgICBpZiAoaXNVTkMpIHsKICAgICAgICAgIHJldHVybiBbLi4ucy5zbGljZSgwLCA0KSwgLi4ucy5zbGljZSg0KS5tYXAoKHNzKSA9PiB0aGlzLnBhcnNlKHNzKSldOwogICAgICAgIH0gZWxzZSBpZiAoaXNEcml2ZSkgewogICAgICAgICAgcmV0dXJuIFtzWzBdLCAuLi5zLnNsaWNlKDEpLm1hcCgoc3MpID0+IHRoaXMucGFyc2Uoc3MpKV07CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBzLm1hcCgoc3MpID0+IHRoaXMucGFyc2Uoc3MpKTsKICAgIH0pOwogICAgdGhpcy5kZWJ1Zyh0aGlzLnBhdHRlcm4sIHNldCk7CiAgICB0aGlzLnNldCA9IHNldC5maWx0ZXIoKHMpID0+IHMuaW5kZXhPZihmYWxzZSkgPT09IC0xKTsKICAgIGlmICh0aGlzLmlzV2luZG93cykgewogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuc2V0Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgcCA9IHRoaXMuc2V0W2ldOwogICAgICAgIGlmIChwWzBdID09PSAiIiAmJiBwWzFdID09PSAiIiAmJiB0aGlzLmdsb2JQYXJ0c1tpXVsyXSA9PT0gIj8iICYmIHR5cGVvZiBwWzNdID09PSAic3RyaW5nIiAmJiAvXlthLXpdOiQvaS50ZXN0KHBbM10pKSB7CiAgICAgICAgICBwWzJdID0gIj8iOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgdGhpcy5kZWJ1Zyh0aGlzLnBhdHRlcm4sIHRoaXMuc2V0KTsKICB9CiAgLy8gdmFyaW91cyB0cmFuc2Zvcm1zIHRvIGVxdWl2YWxlbnQgcGF0dGVybiBzZXRzIHRoYXQgYXJlCiAgLy8gZmFzdGVyIHRvIHByb2Nlc3MgaW4gYSBmaWxlc3lzdGVtIHdhbGsuICBUaGUgZ29hbCBpcyB0bwogIC8vIGVsaW1pbmF0ZSB3aGF0IHdlIGNhbiwgYW5kIHB1c2ggYWxsICoqIHBhdHRlcm5zIGFzIGZhcgogIC8vIHRvIHRoZSByaWdodCBhcyBwb3NzaWJsZSwgZXZlbiBpZiBpdCBpbmNyZWFzZXMgdGhlIG51bWJlcgogIC8vIG9mIHBhdHRlcm5zIHRoYXQgd2UgaGF2ZSB0byBwcm9jZXNzLgogIHByZXByb2Nlc3MoZ2xvYlBhcnRzKSB7CiAgICBpZiAodGhpcy5vcHRpb25zLm5vZ2xvYnN0YXIpIHsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBnbG9iUGFydHMubGVuZ3RoOyBpKyspIHsKICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IGdsb2JQYXJ0c1tpXS5sZW5ndGg7IGorKykgewogICAgICAgICAgaWYgKGdsb2JQYXJ0c1tpXVtqXSA9PT0gIioqIikgewogICAgICAgICAgICBnbG9iUGFydHNbaV1bal0gPSAiKiI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBjb25zdCB7IG9wdGltaXphdGlvbkxldmVsID0gMSB9ID0gdGhpcy5vcHRpb25zOwogICAgaWYgKG9wdGltaXphdGlvbkxldmVsID49IDIpIHsKICAgICAgZ2xvYlBhcnRzID0gdGhpcy5maXJzdFBoYXNlUHJlUHJvY2VzcyhnbG9iUGFydHMpOwogICAgICBnbG9iUGFydHMgPSB0aGlzLnNlY29uZFBoYXNlUHJlUHJvY2VzcyhnbG9iUGFydHMpOwogICAgfSBlbHNlIGlmIChvcHRpbWl6YXRpb25MZXZlbCA+PSAxKSB7CiAgICAgIGdsb2JQYXJ0cyA9IHRoaXMubGV2ZWxPbmVPcHRpbWl6ZShnbG9iUGFydHMpOwogICAgfSBlbHNlIHsKICAgICAgZ2xvYlBhcnRzID0gdGhpcy5hZGphc2NlbnRHbG9ic3Rhck9wdGltaXplKGdsb2JQYXJ0cyk7CiAgICB9CiAgICByZXR1cm4gZ2xvYlBhcnRzOwogIH0KICAvLyBqdXN0IGdldCByaWQgb2YgYWRqYXNjZW50ICoqIHBvcnRpb25zCiAgYWRqYXNjZW50R2xvYnN0YXJPcHRpbWl6ZShnbG9iUGFydHMpIHsKICAgIHJldHVybiBnbG9iUGFydHMubWFwKChwYXJ0cykgPT4gewogICAgICBsZXQgZ3MgPSAtMTsKICAgICAgd2hpbGUgKC0xICE9PSAoZ3MgPSBwYXJ0cy5pbmRleE9mKCIqKiIsIGdzICsgMSkpKSB7CiAgICAgICAgbGV0IGkgPSBnczsKICAgICAgICB3aGlsZSAocGFydHNbaSArIDFdID09PSAiKioiKSB7CiAgICAgICAgICBpKys7CiAgICAgICAgfQogICAgICAgIGlmIChpICE9PSBncykgewogICAgICAgICAgcGFydHMuc3BsaWNlKGdzLCBpIC0gZ3MpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gcGFydHM7CiAgICB9KTsKICB9CiAgLy8gZ2V0IHJpZCBvZiBhZGphc2NlbnQgKiogYW5kIHJlc29sdmUgLi4gcG9ydGlvbnMKICBsZXZlbE9uZU9wdGltaXplKGdsb2JQYXJ0cykgewogICAgcmV0dXJuIGdsb2JQYXJ0cy5tYXAoKHBhcnRzKSA9PiB7CiAgICAgIHBhcnRzID0gcGFydHMucmVkdWNlKChzZXQsIHBhcnQpID0+IHsKICAgICAgICBjb25zdCBwcmV2ID0gc2V0W3NldC5sZW5ndGggLSAxXTsKICAgICAgICBpZiAocGFydCA9PT0gIioqIiAmJiBwcmV2ID09PSAiKioiKSB7CiAgICAgICAgICByZXR1cm4gc2V0OwogICAgICAgIH0KICAgICAgICBpZiAocGFydCA9PT0gIi4uIikgewogICAgICAgICAgaWYgKHByZXYgJiYgcHJldiAhPT0gIi4uIiAmJiBwcmV2ICE9PSAiLiIgJiYgcHJldiAhPT0gIioqIikgewogICAgICAgICAgICBzZXQucG9wKCk7CiAgICAgICAgICAgIHJldHVybiBzZXQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHNldC5wdXNoKHBhcnQpOwogICAgICAgIHJldHVybiBzZXQ7CiAgICAgIH0sIFtdKTsKICAgICAgcmV0dXJuIHBhcnRzLmxlbmd0aCA9PT0gMCA/IFsiIl0gOiBwYXJ0czsKICAgIH0pOwogIH0KICBsZXZlbFR3b0ZpbGVPcHRpbWl6ZShwYXJ0cykgewogICAgaWYgKCFBcnJheS5pc0FycmF5KHBhcnRzKSkgewogICAgICBwYXJ0cyA9IHRoaXMuc2xhc2hTcGxpdChwYXJ0cyk7CiAgICB9CiAgICBsZXQgZGlkU29tZXRoaW5nID0gZmFsc2U7CiAgICBkbyB7CiAgICAgIGRpZFNvbWV0aGluZyA9IGZhbHNlOwogICAgICBpZiAoIXRoaXMucHJlc2VydmVNdWx0aXBsZVNsYXNoZXMpIHsKICAgICAgICBmb3IgKGxldCBpID0gMTsgaSA8IHBhcnRzLmxlbmd0aCAtIDE7IGkrKykgewogICAgICAgICAgY29uc3QgcCA9IHBhcnRzW2ldOwogICAgICAgICAgaWYgKGkgPT09IDEgJiYgcCA9PT0gIiIgJiYgcGFydHNbMF0gPT09ICIiKQogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIGlmIChwID09PSAiLiIgfHwgcCA9PT0gIiIpIHsKICAgICAgICAgICAgZGlkU29tZXRoaW5nID0gdHJ1ZTsKICAgICAgICAgICAgcGFydHMuc3BsaWNlKGksIDEpOwogICAgICAgICAgICBpLS07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChwYXJ0c1swXSA9PT0gIi4iICYmIHBhcnRzLmxlbmd0aCA9PT0gMiAmJiAocGFydHNbMV0gPT09ICIuIiB8fCBwYXJ0c1sxXSA9PT0gIiIpKSB7CiAgICAgICAgICBkaWRTb21ldGhpbmcgPSB0cnVlOwogICAgICAgICAgcGFydHMucG9wKCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGxldCBkZCA9IDA7CiAgICAgIHdoaWxlICgtMSAhPT0gKGRkID0gcGFydHMuaW5kZXhPZigiLi4iLCBkZCArIDEpKSkgewogICAgICAgIGNvbnN0IHAgPSBwYXJ0c1tkZCAtIDFdOwogICAgICAgIGlmIChwICYmIHAgIT09ICIuIiAmJiBwICE9PSAiLi4iICYmIHAgIT09ICIqKiIpIHsKICAgICAgICAgIGRpZFNvbWV0aGluZyA9IHRydWU7CiAgICAgICAgICBwYXJ0cy5zcGxpY2UoZGQgLSAxLCAyKTsKICAgICAgICAgIGRkIC09IDI7CiAgICAgICAgfQogICAgICB9CiAgICB9IHdoaWxlIChkaWRTb21ldGhpbmcpOwogICAgcmV0dXJuIHBhcnRzLmxlbmd0aCA9PT0gMCA/IFsiIl0gOiBwYXJ0czsKICB9CiAgLy8gRmlyc3QgcGhhc2U6IHNpbmdsZS1wYXR0ZXJuIHByb2Nlc3NpbmcKICAvLyA8cHJlPiBpcyAxIG9yIG1vcmUgcG9ydGlvbnMKICAvLyA8cmVzdD4gaXMgMSBvciBtb3JlIHBvcnRpb25zCiAgLy8gPHA+IGlzIGFueSBwb3J0aW9uIG90aGVyIHRoYW4gLiwgLi4sICcnLCBvciAqKgogIC8vIDxlPiBpcyAuIG9yICcnCiAgLy8KICAvLyAqKi8uLiBpcyAqYnJ1dGFsKiBmb3IgZmlsZXN5c3RlbSB3YWxraW5nIHBlcmZvcm1hbmNlLCBiZWNhdXNlCiAgLy8gaXQgZWZmZWN0aXZlbHkgcmVzZXRzIHRoZSByZWN1cnNpdmUgd2FsayBlYWNoIHRpbWUgaXQgb2NjdXJzLAogIC8vIGFuZCAqKiBjYW5ub3QgYmUgcmVkdWNlZCBvdXQgYnkgYSAuLiBwYXR0ZXJuIHBhcnQgbGlrZSBhIHJlZ2V4cAogIC8vIG9yIG1vc3Qgc3RyaW5ncyAob3RoZXIgdGhhbiAuLiwgLiwgYW5kICcnKSBjYW4gYmUuCiAgLy8KICAvLyA8cHJlPi8qKi8uLi88cD4vPHA+LzxyZXN0PiAtPiB7PHByZT4vLi4vPHA+LzxwPi88cmVzdD4sPHByZT4vKiovPHA+LzxwPi88cmVzdD59CiAgLy8gPHByZT4vPGU+LzxyZXN0PiAtPiA8cHJlPi88cmVzdD4KICAvLyA8cHJlPi88cD4vLi4vPHJlc3Q+IC0+IDxwcmU+LzxyZXN0PgogIC8vICoqLyoqLzxyZXN0PiAtPiAqKi88cmVzdD4KICAvLwogIC8vICoqLyovPHJlc3Q+IC0+ICovKiovPHJlc3Q+IDw9PSBub3QgdmFsaWQgYmVjYXVzZSAqKiBkb2Vzbid0IGZvbGxvdwogIC8vIHRoaXMgV09VTEQgYmUgYWxsb3dlZCBpZiAqKiBkaWQgZm9sbG93IHN5bWxpbmtzLCBvciAqIGRpZG4ndAogIGZpcnN0UGhhc2VQcmVQcm9jZXNzKGdsb2JQYXJ0cykgewogICAgbGV0IGRpZFNvbWV0aGluZyA9IGZhbHNlOwogICAgZG8gewogICAgICBkaWRTb21ldGhpbmcgPSBmYWxzZTsKICAgICAgZm9yIChsZXQgcGFydHMgb2YgZ2xvYlBhcnRzKSB7CiAgICAgICAgbGV0IGdzID0gLTE7CiAgICAgICAgd2hpbGUgKC0xICE9PSAoZ3MgPSBwYXJ0cy5pbmRleE9mKCIqKiIsIGdzICsgMSkpKSB7CiAgICAgICAgICBsZXQgZ3NzID0gZ3M7CiAgICAgICAgICB3aGlsZSAocGFydHNbZ3NzICsgMV0gPT09ICIqKiIpIHsKICAgICAgICAgICAgZ3NzKys7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZ3NzID4gZ3MpIHsKICAgICAgICAgICAgcGFydHMuc3BsaWNlKGdzICsgMSwgZ3NzIC0gZ3MpOwogICAgICAgICAgfQogICAgICAgICAgbGV0IG5leHQgPSBwYXJ0c1tncyArIDFdOwogICAgICAgICAgY29uc3QgcCA9IHBhcnRzW2dzICsgMl07CiAgICAgICAgICBjb25zdCBwMiA9IHBhcnRzW2dzICsgM107CiAgICAgICAgICBpZiAobmV4dCAhPT0gIi4uIikKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICBpZiAoIXAgfHwgcCA9PT0gIi4iIHx8IHAgPT09ICIuLiIgfHwgIXAyIHx8IHAyID09PSAiLiIgfHwgcDIgPT09ICIuLiIpIHsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICBkaWRTb21ldGhpbmcgPSB0cnVlOwogICAgICAgICAgcGFydHMuc3BsaWNlKGdzLCAxKTsKICAgICAgICAgIGNvbnN0IG90aGVyID0gcGFydHMuc2xpY2UoMCk7CiAgICAgICAgICBvdGhlcltnc10gPSAiKioiOwogICAgICAgICAgZ2xvYlBhcnRzLnB1c2gob3RoZXIpOwogICAgICAgICAgZ3MtLTsKICAgICAgICB9CiAgICAgICAgaWYgKCF0aGlzLnByZXNlcnZlTXVsdGlwbGVTbGFzaGVzKSB7CiAgICAgICAgICBmb3IgKGxldCBpID0gMTsgaSA8IHBhcnRzLmxlbmd0aCAtIDE7IGkrKykgewogICAgICAgICAgICBjb25zdCBwID0gcGFydHNbaV07CiAgICAgICAgICAgIGlmIChpID09PSAxICYmIHAgPT09ICIiICYmIHBhcnRzWzBdID09PSAiIikKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgaWYgKHAgPT09ICIuIiB8fCBwID09PSAiIikgewogICAgICAgICAgICAgIGRpZFNvbWV0aGluZyA9IHRydWU7CiAgICAgICAgICAgICAgcGFydHMuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgIGktLTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHBhcnRzWzBdID09PSAiLiIgJiYgcGFydHMubGVuZ3RoID09PSAyICYmIChwYXJ0c1sxXSA9PT0gIi4iIHx8IHBhcnRzWzFdID09PSAiIikpIHsKICAgICAgICAgICAgZGlkU29tZXRoaW5nID0gdHJ1ZTsKICAgICAgICAgICAgcGFydHMucG9wKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGxldCBkZCA9IDA7CiAgICAgICAgd2hpbGUgKC0xICE9PSAoZGQgPSBwYXJ0cy5pbmRleE9mKCIuLiIsIGRkICsgMSkpKSB7CiAgICAgICAgICBjb25zdCBwID0gcGFydHNbZGQgLSAxXTsKICAgICAgICAgIGlmIChwICYmIHAgIT09ICIuIiAmJiBwICE9PSAiLi4iICYmIHAgIT09ICIqKiIpIHsKICAgICAgICAgICAgZGlkU29tZXRoaW5nID0gdHJ1ZTsKICAgICAgICAgICAgY29uc3QgbmVlZERvdCA9IGRkID09PSAxICYmIHBhcnRzW2RkICsgMV0gPT09ICIqKiI7CiAgICAgICAgICAgIGNvbnN0IHNwbGluID0gbmVlZERvdCA/IFsiLiJdIDogW107CiAgICAgICAgICAgIHBhcnRzLnNwbGljZShkZCAtIDEsIDIsIC4uLnNwbGluKTsKICAgICAgICAgICAgaWYgKHBhcnRzLmxlbmd0aCA9PT0gMCkKICAgICAgICAgICAgICBwYXJ0cy5wdXNoKCIiKTsKICAgICAgICAgICAgZGQgLT0gMjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0gd2hpbGUgKGRpZFNvbWV0aGluZyk7CiAgICByZXR1cm4gZ2xvYlBhcnRzOwogIH0KICAvLyBzZWNvbmQgcGhhc2U6IG11bHRpLXBhdHRlcm4gZGVkdXBlcwogIC8vIHs8cHJlPi8qLzxyZXN0Piw8cHJlPi88cD4vPHJlc3Q+fSAtPiA8cHJlPi8qLzxyZXN0PgogIC8vIHs8cHJlPi88cmVzdD4sPHByZT4vPHJlc3Q+fSAtPiA8cHJlPi88cmVzdD4KICAvLyB7PHByZT4vKiovPHJlc3Q+LDxwcmU+LzxyZXN0Pn0gLT4gPHByZT4vKiovPHJlc3Q+CiAgLy8KICAvLyB7PHByZT4vKiovPHJlc3Q+LDxwcmU+LyoqLzxwPi88cmVzdD59IC0+IDxwcmU+LyoqLzxyZXN0PgogIC8vIF4tLSBub3QgdmFsaWQgYmVjYXVzZSAqKiBkb2Vucyd0IGZvbGxvdyBzeW1saW5rcwogIHNlY29uZFBoYXNlUHJlUHJvY2VzcyhnbG9iUGFydHMpIHsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZ2xvYlBhcnRzLmxlbmd0aCAtIDE7IGkrKykgewogICAgICBmb3IgKGxldCBqID0gaSArIDE7IGogPCBnbG9iUGFydHMubGVuZ3RoOyBqKyspIHsKICAgICAgICBjb25zdCBtYXRjaGVkID0gdGhpcy5wYXJ0c01hdGNoKGdsb2JQYXJ0c1tpXSwgZ2xvYlBhcnRzW2pdLCAhdGhpcy5wcmVzZXJ2ZU11bHRpcGxlU2xhc2hlcyk7CiAgICAgICAgaWYgKCFtYXRjaGVkKQogICAgICAgICAgY29udGludWU7CiAgICAgICAgZ2xvYlBhcnRzW2ldID0gbWF0Y2hlZDsKICAgICAgICBnbG9iUGFydHNbal0gPSBbXTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGdsb2JQYXJ0cy5maWx0ZXIoKGdzKSA9PiBncy5sZW5ndGgpOwogIH0KICBwYXJ0c01hdGNoKGEsIGIsIGVtcHR5R1NNYXRjaCA9IGZhbHNlKSB7CiAgICBsZXQgYWkgPSAwOwogICAgbGV0IGJpID0gMDsKICAgIGxldCByZXN1bHQgPSBbXTsKICAgIGxldCB3aGljaDIgPSAiIjsKICAgIHdoaWxlIChhaSA8IGEubGVuZ3RoICYmIGJpIDwgYi5sZW5ndGgpIHsKICAgICAgaWYgKGFbYWldID09PSBiW2JpXSkgewogICAgICAgIHJlc3VsdC5wdXNoKHdoaWNoMiA9PT0gImIiID8gYltiaV0gOiBhW2FpXSk7CiAgICAgICAgYWkrKzsKICAgICAgICBiaSsrOwogICAgICB9IGVsc2UgaWYgKGVtcHR5R1NNYXRjaCAmJiBhW2FpXSA9PT0gIioqIiAmJiBiW2JpXSA9PT0gYVthaSArIDFdKSB7CiAgICAgICAgcmVzdWx0LnB1c2goYVthaV0pOwogICAgICAgIGFpKys7CiAgICAgIH0gZWxzZSBpZiAoZW1wdHlHU01hdGNoICYmIGJbYmldID09PSAiKioiICYmIGFbYWldID09PSBiW2JpICsgMV0pIHsKICAgICAgICByZXN1bHQucHVzaChiW2JpXSk7CiAgICAgICAgYmkrKzsKICAgICAgfSBlbHNlIGlmIChhW2FpXSA9PT0gIioiICYmIGJbYmldICYmICh0aGlzLm9wdGlvbnMuZG90IHx8ICFiW2JpXS5zdGFydHNXaXRoKCIuIikpICYmIGJbYmldICE9PSAiKioiKSB7CiAgICAgICAgaWYgKHdoaWNoMiA9PT0gImIiKQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIHdoaWNoMiA9ICJhIjsKICAgICAgICByZXN1bHQucHVzaChhW2FpXSk7CiAgICAgICAgYWkrKzsKICAgICAgICBiaSsrOwogICAgICB9IGVsc2UgaWYgKGJbYmldID09PSAiKiIgJiYgYVthaV0gJiYgKHRoaXMub3B0aW9ucy5kb3QgfHwgIWFbYWldLnN0YXJ0c1dpdGgoIi4iKSkgJiYgYVthaV0gIT09ICIqKiIpIHsKICAgICAgICBpZiAod2hpY2gyID09PSAiYSIpCiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgd2hpY2gyID0gImIiOwogICAgICAgIHJlc3VsdC5wdXNoKGJbYmldKTsKICAgICAgICBhaSsrOwogICAgICAgIGJpKys7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gYS5sZW5ndGggPT09IGIubGVuZ3RoICYmIHJlc3VsdDsKICB9CiAgcGFyc2VOZWdhdGUoKSB7CiAgICBpZiAodGhpcy5ub25lZ2F0ZSkKICAgICAgcmV0dXJuOwogICAgY29uc3QgcGF0dGVybiA9IHRoaXMucGF0dGVybjsKICAgIGxldCBuZWdhdGUgPSBmYWxzZTsKICAgIGxldCBuZWdhdGVPZmZzZXQgPSAwOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwYXR0ZXJuLmxlbmd0aCAmJiBwYXR0ZXJuLmNoYXJBdChpKSA9PT0gIiEiOyBpKyspIHsKICAgICAgbmVnYXRlID0gIW5lZ2F0ZTsKICAgICAgbmVnYXRlT2Zmc2V0Kys7CiAgICB9CiAgICBpZiAobmVnYXRlT2Zmc2V0KQogICAgICB0aGlzLnBhdHRlcm4gPSBwYXR0ZXJuLnNsaWNlKG5lZ2F0ZU9mZnNldCk7CiAgICB0aGlzLm5lZ2F0ZSA9IG5lZ2F0ZTsKICB9CiAgLy8gc2V0IHBhcnRpYWwgdG8gdHJ1ZSB0byB0ZXN0IGlmLCBmb3IgZXhhbXBsZSwKICAvLyAiL2EvYiIgbWF0Y2hlcyB0aGUgc3RhcnQgb2YgIi8qL2IvKi9kIgogIC8vIFBhcnRpYWwgbWVhbnMsIGlmIHlvdSBydW4gb3V0IG9mIGZpbGUgYmVmb3JlIHlvdSBydW4KICAvLyBvdXQgb2YgcGF0dGVybiwgdGhlbiB0aGF0J3MgZmluZSwgYXMgbG9uZyBhcyBhbGwKICAvLyB0aGUgcGFydHMgbWF0Y2guCiAgbWF0Y2hPbmUoZmlsZSwgcGF0dGVybiwgcGFydGlhbCA9IGZhbHNlKSB7CiAgICBjb25zdCBvcHRpb25zID0gdGhpcy5vcHRpb25zOwogICAgaWYgKHRoaXMuaXNXaW5kb3dzKSB7CiAgICAgIGNvbnN0IGZpbGVEcml2ZSA9IHR5cGVvZiBmaWxlWzBdID09PSAic3RyaW5nIiAmJiAvXlthLXpdOiQvaS50ZXN0KGZpbGVbMF0pOwogICAgICBjb25zdCBmaWxlVU5DID0gIWZpbGVEcml2ZSAmJiBmaWxlWzBdID09PSAiIiAmJiBmaWxlWzFdID09PSAiIiAmJiBmaWxlWzJdID09PSAiPyIgJiYgL15bYS16XTokL2kudGVzdChmaWxlWzNdKTsKICAgICAgY29uc3QgcGF0dGVybkRyaXZlID0gdHlwZW9mIHBhdHRlcm5bMF0gPT09ICJzdHJpbmciICYmIC9eW2Etel06JC9pLnRlc3QocGF0dGVyblswXSk7CiAgICAgIGNvbnN0IHBhdHRlcm5VTkMgPSAhcGF0dGVybkRyaXZlICYmIHBhdHRlcm5bMF0gPT09ICIiICYmIHBhdHRlcm5bMV0gPT09ICIiICYmIHBhdHRlcm5bMl0gPT09ICI/IiAmJiB0eXBlb2YgcGF0dGVyblszXSA9PT0gInN0cmluZyIgJiYgL15bYS16XTokL2kudGVzdChwYXR0ZXJuWzNdKTsKICAgICAgY29uc3QgZmRpID0gZmlsZVVOQyA/IDMgOiBmaWxlRHJpdmUgPyAwIDogdm9pZCAwOwogICAgICBjb25zdCBwZGkgPSBwYXR0ZXJuVU5DID8gMyA6IHBhdHRlcm5Ecml2ZSA/IDAgOiB2b2lkIDA7CiAgICAgIGlmICh0eXBlb2YgZmRpID09PSAibnVtYmVyIiAmJiB0eXBlb2YgcGRpID09PSAibnVtYmVyIikgewogICAgICAgIGNvbnN0IFtmZCwgcGRdID0gW2ZpbGVbZmRpXSwgcGF0dGVybltwZGldXTsKICAgICAgICBpZiAoZmQudG9Mb3dlckNhc2UoKSA9PT0gcGQudG9Mb3dlckNhc2UoKSkgewogICAgICAgICAgcGF0dGVybltwZGldID0gZmQ7CiAgICAgICAgICBpZiAocGRpID4gZmRpKSB7CiAgICAgICAgICAgIHBhdHRlcm4gPSBwYXR0ZXJuLnNsaWNlKHBkaSk7CiAgICAgICAgICB9IGVsc2UgaWYgKGZkaSA+IHBkaSkgewogICAgICAgICAgICBmaWxlID0gZmlsZS5zbGljZShmZGkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogICAgY29uc3QgeyBvcHRpbWl6YXRpb25MZXZlbCA9IDEgfSA9IHRoaXMub3B0aW9uczsKICAgIGlmIChvcHRpbWl6YXRpb25MZXZlbCA+PSAyKSB7CiAgICAgIGZpbGUgPSB0aGlzLmxldmVsVHdvRmlsZU9wdGltaXplKGZpbGUpOwogICAgfQogICAgdGhpcy5kZWJ1ZygibWF0Y2hPbmUiLCB0aGlzLCB7IGZpbGUsIHBhdHRlcm4gfSk7CiAgICB0aGlzLmRlYnVnKCJtYXRjaE9uZSIsIGZpbGUubGVuZ3RoLCBwYXR0ZXJuLmxlbmd0aCk7CiAgICBmb3IgKHZhciBmaSA9IDAsIHBpID0gMCwgZmwgPSBmaWxlLmxlbmd0aCwgcGwgPSBwYXR0ZXJuLmxlbmd0aDsgZmkgPCBmbCAmJiBwaSA8IHBsOyBmaSsrLCBwaSsrKSB7CiAgICAgIHRoaXMuZGVidWcoIm1hdGNoT25lIGxvb3AiKTsKICAgICAgdmFyIHAgPSBwYXR0ZXJuW3BpXTsKICAgICAgdmFyIGYgPSBmaWxlW2ZpXTsKICAgICAgdGhpcy5kZWJ1ZyhwYXR0ZXJuLCBwLCBmKTsKICAgICAgaWYgKHAgPT09IGZhbHNlKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIGlmIChwID09PSBHTE9CU1RBUikgewogICAgICAgIHRoaXMuZGVidWcoIkdMT0JTVEFSIiwgW3BhdHRlcm4sIHAsIGZdKTsKICAgICAgICB2YXIgZnIgPSBmaTsKICAgICAgICB2YXIgcHIgPSBwaSArIDE7CiAgICAgICAgaWYgKHByID09PSBwbCkgewogICAgICAgICAgdGhpcy5kZWJ1ZygiKiogYXQgdGhlIGVuZCIpOwogICAgICAgICAgZm9yICg7IGZpIDwgZmw7IGZpKyspIHsKICAgICAgICAgICAgaWYgKGZpbGVbZmldID09PSAiLiIgfHwgZmlsZVtmaV0gPT09ICIuLiIgfHwgIW9wdGlvbnMuZG90ICYmIGZpbGVbZmldLmNoYXJBdCgwKSA9PT0gIi4iKQogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICB3aGlsZSAoZnIgPCBmbCkgewogICAgICAgICAgdmFyIHN3YWxsb3dlZSA9IGZpbGVbZnJdOwogICAgICAgICAgdGhpcy5kZWJ1ZygiXG5nbG9ic3RhciB3aGlsZSIsIGZpbGUsIGZyLCBwYXR0ZXJuLCBwciwgc3dhbGxvd2VlKTsKICAgICAgICAgIGlmICh0aGlzLm1hdGNoT25lKGZpbGUuc2xpY2UoZnIpLCBwYXR0ZXJuLnNsaWNlKHByKSwgcGFydGlhbCkpIHsKICAgICAgICAgICAgdGhpcy5kZWJ1ZygiZ2xvYnN0YXIgZm91bmQgbWF0Y2ghIiwgZnIsIGZsLCBzd2FsbG93ZWUpOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChzd2FsbG93ZWUgPT09ICIuIiB8fCBzd2FsbG93ZWUgPT09ICIuLiIgfHwgIW9wdGlvbnMuZG90ICYmIHN3YWxsb3dlZS5jaGFyQXQoMCkgPT09ICIuIikgewogICAgICAgICAgICAgIHRoaXMuZGVidWcoImRvdCBkZXRlY3RlZCEiLCBmaWxlLCBmciwgcGF0dGVybiwgcHIpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZGVidWcoImdsb2JzdGFyIHN3YWxsb3cgYSBzZWdtZW50LCBhbmQgY29udGludWUiKTsKICAgICAgICAgICAgZnIrKzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHBhcnRpYWwpIHsKICAgICAgICAgIHRoaXMuZGVidWcoIlxuPj4+IG5vIG1hdGNoLCBwYXJ0aWFsPyIsIGZpbGUsIGZyLCBwYXR0ZXJuLCBwcik7CiAgICAgICAgICBpZiAoZnIgPT09IGZsKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgbGV0IGhpdDsKICAgICAgaWYgKHR5cGVvZiBwID09PSAic3RyaW5nIikgewogICAgICAgIGhpdCA9IGYgPT09IHA7CiAgICAgICAgdGhpcy5kZWJ1Zygic3RyaW5nIG1hdGNoIiwgcCwgZiwgaGl0KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBoaXQgPSBwLnRlc3QoZik7CiAgICAgICAgdGhpcy5kZWJ1ZygicGF0dGVybiBtYXRjaCIsIHAsIGYsIGhpdCk7CiAgICAgIH0KICAgICAgaWYgKCFoaXQpCiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgaWYgKGZpID09PSBmbCAmJiBwaSA9PT0gcGwpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9IGVsc2UgaWYgKGZpID09PSBmbCkgewogICAgICByZXR1cm4gcGFydGlhbDsKICAgIH0gZWxzZSBpZiAocGkgPT09IHBsKSB7CiAgICAgIHJldHVybiBmaSA9PT0gZmwgLSAxICYmIGZpbGVbZmldID09PSAiIjsKICAgIH0gZWxzZSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigid3RmPyIpOwogICAgfQogIH0KICBicmFjZUV4cGFuZCgpIHsKICAgIHJldHVybiBicmFjZUV4cGFuZCh0aGlzLnBhdHRlcm4sIHRoaXMub3B0aW9ucyk7CiAgfQogIHBhcnNlKHBhdHRlcm4pIHsKICAgIGFzc2VydFZhbGlkUGF0dGVybihwYXR0ZXJuKTsKICAgIGNvbnN0IG9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CiAgICBpZiAocGF0dGVybiA9PT0gIioqIikKICAgICAgcmV0dXJuIEdMT0JTVEFSOwogICAgaWYgKHBhdHRlcm4gPT09ICIiKQogICAgICByZXR1cm4gIiI7CiAgICBsZXQgbTsKICAgIGxldCBmYXN0VGVzdCA9IG51bGw7CiAgICBpZiAobSA9IHBhdHRlcm4ubWF0Y2goc3RhclJFKSkgewogICAgICBmYXN0VGVzdCA9IG9wdGlvbnMuZG90ID8gc3RhclRlc3REb3QgOiBzdGFyVGVzdDsKICAgIH0gZWxzZSBpZiAobSA9IHBhdHRlcm4ubWF0Y2goc3RhckRvdEV4dFJFKSkgewogICAgICBmYXN0VGVzdCA9IChvcHRpb25zLm5vY2FzZSA/IG9wdGlvbnMuZG90ID8gc3RhckRvdEV4dFRlc3ROb2Nhc2VEb3QgOiBzdGFyRG90RXh0VGVzdE5vY2FzZSA6IG9wdGlvbnMuZG90ID8gc3RhckRvdEV4dFRlc3REb3QgOiBzdGFyRG90RXh0VGVzdCkobVsxXSk7CiAgICB9IGVsc2UgaWYgKG0gPSBwYXR0ZXJuLm1hdGNoKHFtYXJrc1JFKSkgewogICAgICBmYXN0VGVzdCA9IChvcHRpb25zLm5vY2FzZSA/IG9wdGlvbnMuZG90ID8gcW1hcmtzVGVzdE5vY2FzZURvdCA6IHFtYXJrc1Rlc3ROb2Nhc2UgOiBvcHRpb25zLmRvdCA/IHFtYXJrc1Rlc3REb3QgOiBxbWFya3NUZXN0KShtKTsKICAgIH0gZWxzZSBpZiAobSA9IHBhdHRlcm4ubWF0Y2goc3RhckRvdFN0YXJSRSkpIHsKICAgICAgZmFzdFRlc3QgPSBvcHRpb25zLmRvdCA/IHN0YXJEb3RTdGFyVGVzdERvdCA6IHN0YXJEb3RTdGFyVGVzdDsKICAgIH0gZWxzZSBpZiAobSA9IHBhdHRlcm4ubWF0Y2goZG90U3RhclJFKSkgewogICAgICBmYXN0VGVzdCA9IGRvdFN0YXJUZXN0OwogICAgfQogICAgY29uc3QgcmUgPSBBU1QuZnJvbUdsb2IocGF0dGVybiwgdGhpcy5vcHRpb25zKS50b01NUGF0dGVybigpOwogICAgcmV0dXJuIGZhc3RUZXN0ID8gT2JqZWN0LmFzc2lnbihyZSwgeyB0ZXN0OiBmYXN0VGVzdCB9KSA6IHJlOwogIH0KICBtYWtlUmUoKSB7CiAgICBpZiAodGhpcy5yZWdleHAgfHwgdGhpcy5yZWdleHAgPT09IGZhbHNlKQogICAgICByZXR1cm4gdGhpcy5yZWdleHA7CiAgICBjb25zdCBzZXQgPSB0aGlzLnNldDsKICAgIGlmICghc2V0Lmxlbmd0aCkgewogICAgICB0aGlzLnJlZ2V4cCA9IGZhbHNlOwogICAgICByZXR1cm4gdGhpcy5yZWdleHA7CiAgICB9CiAgICBjb25zdCBvcHRpb25zID0gdGhpcy5vcHRpb25zOwogICAgY29uc3QgdHdvU3RhciA9IG9wdGlvbnMubm9nbG9ic3RhciA/IHN0YXIgOiBvcHRpb25zLmRvdCA/IHR3b1N0YXJEb3QgOiB0d29TdGFyTm9Eb3Q7CiAgICBjb25zdCBmbGFncyA9IG5ldyBTZXQob3B0aW9ucy5ub2Nhc2UgPyBbImkiXSA6IFtdKTsKICAgIGxldCByZSA9IHNldC5tYXAoKHBhdHRlcm4pID0+IHsKICAgICAgY29uc3QgcHAgPSBwYXR0ZXJuLm1hcCgocCkgPT4gewogICAgICAgIGlmIChwIGluc3RhbmNlb2YgUmVnRXhwKSB7CiAgICAgICAgICBmb3IgKGNvbnN0IGYgb2YgcC5mbGFncy5zcGxpdCgiIikpCiAgICAgICAgICAgIGZsYWdzLmFkZChmKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHR5cGVvZiBwID09PSAic3RyaW5nIiA/IHJlZ0V4cEVzY2FwZShwKSA6IHAgPT09IEdMT0JTVEFSID8gR0xPQlNUQVIgOiBwLl9zcmM7CiAgICAgIH0pOwogICAgICBwcC5mb3JFYWNoKChwLCBpKSA9PiB7CiAgICAgICAgY29uc3QgbmV4dCA9IHBwW2kgKyAxXTsKICAgICAgICBjb25zdCBwcmV2ID0gcHBbaSAtIDFdOwogICAgICAgIGlmIChwICE9PSBHTE9CU1RBUiB8fCBwcmV2ID09PSBHTE9CU1RBUikgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAocHJldiA9PT0gdm9pZCAwKSB7CiAgICAgICAgICBpZiAobmV4dCAhPT0gdm9pZCAwICYmIG5leHQgIT09IEdMT0JTVEFSKSB7CiAgICAgICAgICAgIHBwW2kgKyAxXSA9ICIoPzpcXC98IiArIHR3b1N0YXIgKyAiXFwvKT8iICsgbmV4dDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHBwW2ldID0gdHdvU3RhcjsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKG5leHQgPT09IHZvaWQgMCkgewogICAgICAgICAgcHBbaSAtIDFdID0gcHJldiArICIoPzpcXC98IiArIHR3b1N0YXIgKyAiKT8iOwogICAgICAgIH0gZWxzZSBpZiAobmV4dCAhPT0gR0xPQlNUQVIpIHsKICAgICAgICAgIHBwW2kgLSAxXSA9IHByZXYgKyAiKD86XFwvfFxcLyIgKyB0d29TdGFyICsgIlxcLykiICsgbmV4dDsKICAgICAgICAgIHBwW2kgKyAxXSA9IEdMT0JTVEFSOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHJldHVybiBwcC5maWx0ZXIoKHApID0+IHAgIT09IEdMT0JTVEFSKS5qb2luKCIvIik7CiAgICB9KS5qb2luKCJ8Iik7CiAgICBjb25zdCBbb3BlbiwgY2xvc2VdID0gc2V0Lmxlbmd0aCA+IDEgPyBbIig/OiIsICIpIl0gOiBbIiIsICIiXTsKICAgIHJlID0gIl4iICsgb3BlbiArIHJlICsgY2xvc2UgKyAiJCI7CiAgICBpZiAodGhpcy5uZWdhdGUpCiAgICAgIHJlID0gIl4oPyEiICsgcmUgKyAiKS4rJCI7CiAgICB0cnkgewogICAgICB0aGlzLnJlZ2V4cCA9IG5ldyBSZWdFeHAocmUsIFsuLi5mbGFnc10uam9pbigiIikpOwogICAgfSBjYXRjaCAoZXgpIHsKICAgICAgdGhpcy5yZWdleHAgPSBmYWxzZTsKICAgIH0KICAgIHJldHVybiB0aGlzLnJlZ2V4cDsKICB9CiAgc2xhc2hTcGxpdChwKSB7CiAgICBpZiAodGhpcy5wcmVzZXJ2ZU11bHRpcGxlU2xhc2hlcykgewogICAgICByZXR1cm4gcC5zcGxpdCgiLyIpOwogICAgfSBlbHNlIGlmICh0aGlzLmlzV2luZG93cyAmJiAvXlwvXC9bXlwvXSsvLnRlc3QocCkpIHsKICAgICAgcmV0dXJuIFsiIiwgLi4ucC5zcGxpdCgvXC8rLyldOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHAuc3BsaXQoL1wvKy8pOwogICAgfQogIH0KICBtYXRjaChmLCBwYXJ0aWFsID0gdGhpcy5wYXJ0aWFsKSB7CiAgICB0aGlzLmRlYnVnKCJtYXRjaCIsIGYsIHRoaXMucGF0dGVybik7CiAgICBpZiAodGhpcy5jb21tZW50KSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIGlmICh0aGlzLmVtcHR5KSB7CiAgICAgIHJldHVybiBmID09PSAiIjsKICAgIH0KICAgIGlmIChmID09PSAiLyIgJiYgcGFydGlhbCkgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIGNvbnN0IG9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CiAgICBpZiAodGhpcy5pc1dpbmRvd3MpIHsKICAgICAgZiA9IGYuc3BsaXQoIlxcIikuam9pbigiLyIpOwogICAgfQogICAgY29uc3QgZmYgPSB0aGlzLnNsYXNoU3BsaXQoZik7CiAgICB0aGlzLmRlYnVnKHRoaXMucGF0dGVybiwgInNwbGl0IiwgZmYpOwogICAgY29uc3Qgc2V0ID0gdGhpcy5zZXQ7CiAgICB0aGlzLmRlYnVnKHRoaXMucGF0dGVybiwgInNldCIsIHNldCk7CiAgICBsZXQgZmlsZW5hbWUgPSBmZltmZi5sZW5ndGggLSAxXTsKICAgIGlmICghZmlsZW5hbWUpIHsKICAgICAgZm9yIChsZXQgaSA9IGZmLmxlbmd0aCAtIDI7ICFmaWxlbmFtZSAmJiBpID49IDA7IGktLSkgewogICAgICAgIGZpbGVuYW1lID0gZmZbaV07CiAgICAgIH0KICAgIH0KICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc2V0Lmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IHBhdHRlcm4gPSBzZXRbaV07CiAgICAgIGxldCBmaWxlID0gZmY7CiAgICAgIGlmIChvcHRpb25zLm1hdGNoQmFzZSAmJiBwYXR0ZXJuLmxlbmd0aCA9PT0gMSkgewogICAgICAgIGZpbGUgPSBbZmlsZW5hbWVdOwogICAgICB9CiAgICAgIGNvbnN0IGhpdCA9IHRoaXMubWF0Y2hPbmUoZmlsZSwgcGF0dGVybiwgcGFydGlhbCk7CiAgICAgIGlmIChoaXQpIHsKICAgICAgICBpZiAob3B0aW9ucy5mbGlwTmVnYXRlKSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuICF0aGlzLm5lZ2F0ZTsKICAgICAgfQogICAgfQogICAgaWYgKG9wdGlvbnMuZmxpcE5lZ2F0ZSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICByZXR1cm4gdGhpcy5uZWdhdGU7CiAgfQogIHN0YXRpYyBkZWZhdWx0cyhkZWYpIHsKICAgIHJldHVybiBtaW5pbWF0Y2guZGVmYXVsdHMoZGVmKS5NaW5pbWF0Y2g7CiAgfQp9Cm1pbmltYXRjaC5BU1QgPSBBU1Q7Cm1pbmltYXRjaC5NaW5pbWF0Y2ggPSBNaW5pbWF0Y2g7Cm1pbmltYXRjaC5lc2NhcGUgPSBlc2NhcGU7Cm1pbmltYXRjaC51bmVzY2FwZSA9IHVuZXNjYXBlJDE7CmNvbnN0IHBlcmYgPSB0eXBlb2YgcGVyZm9ybWFuY2UgPT09ICJvYmplY3QiICYmIHBlcmZvcm1hbmNlICYmIHR5cGVvZiBwZXJmb3JtYW5jZS5ub3cgPT09ICJmdW5jdGlvbiIgPyBwZXJmb3JtYW5jZSA6IERhdGU7CmNvbnN0IHdhcm5lZCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CmNvbnN0IFBST0NFU1MgPSB0eXBlb2YgcHJvY2VzcyA9PT0gIm9iamVjdCIgJiYgISFwcm9jZXNzID8gcHJvY2VzcyA6IHt9Owpjb25zdCBlbWl0V2FybmluZyA9IChtc2csIHR5cGUsIGNvZGUsIGZuKSA9PiB7CiAgdHlwZW9mIFBST0NFU1MuZW1pdFdhcm5pbmcgPT09ICJmdW5jdGlvbiIgPyBQUk9DRVNTLmVtaXRXYXJuaW5nKG1zZywgdHlwZSwgY29kZSwgZm4pIDogY29uc29sZS5lcnJvcihgWyR7Y29kZX1dICR7dHlwZX06ICR7bXNnfWApOwp9OwpsZXQgQUMgPSBnbG9iYWxUaGlzLkFib3J0Q29udHJvbGxlcjsKbGV0IEFTID0gZ2xvYmFsVGhpcy5BYm9ydFNpZ25hbDsKaWYgKHR5cGVvZiBBQyA9PT0gInVuZGVmaW5lZCIpIHsKICBBUyA9IGNsYXNzIEFib3J0U2lnbmFsIHsKICAgIG9uYWJvcnQ7CiAgICBfb25hYm9ydCA9IFtdOwogICAgcmVhc29uOwogICAgYWJvcnRlZCA9IGZhbHNlOwogICAgYWRkRXZlbnRMaXN0ZW5lcihfLCBmbikgewogICAgICB0aGlzLl9vbmFib3J0LnB1c2goZm4pOwogICAgfQogIH07CiAgQUMgPSBjbGFzcyBBYm9ydENvbnRyb2xsZXIgewogICAgY29uc3RydWN0b3IoKSB7CiAgICAgIHdhcm5BQ1BvbHlmaWxsKCk7CiAgICB9CiAgICBzaWduYWwgPSBuZXcgQVMoKTsKICAgIGFib3J0KHJlYXNvbikgewogICAgICBpZiAodGhpcy5zaWduYWwuYWJvcnRlZCkKICAgICAgICByZXR1cm47CiAgICAgIHRoaXMuc2lnbmFsLnJlYXNvbiA9IHJlYXNvbjsKICAgICAgdGhpcy5zaWduYWwuYWJvcnRlZCA9IHRydWU7CiAgICAgIGZvciAoY29uc3QgZm4gb2YgdGhpcy5zaWduYWwuX29uYWJvcnQpIHsKICAgICAgICBmbihyZWFzb24pOwogICAgICB9CiAgICAgIHRoaXMuc2lnbmFsLm9uYWJvcnQ/LihyZWFzb24pOwogICAgfQogIH07CiAgbGV0IHByaW50QUNQb2x5ZmlsbFdhcm5pbmcgPSBQUk9DRVNTLmVudj8uTFJVX0NBQ0hFX0lHTk9SRV9BQ19XQVJOSU5HICE9PSAiMSI7CiAgY29uc3Qgd2FybkFDUG9seWZpbGwgPSAoKSA9PiB7CiAgICBpZiAoIXByaW50QUNQb2x5ZmlsbFdhcm5pbmcpCiAgICAgIHJldHVybjsKICAgIHByaW50QUNQb2x5ZmlsbFdhcm5pbmcgPSBmYWxzZTsKICAgIGVtaXRXYXJuaW5nKCJBYm9ydENvbnRyb2xsZXIgaXMgbm90IGRlZmluZWQuIElmIHVzaW5nIGxydS1jYWNoZSBpbiBub2RlIDE0LCBsb2FkIGFuIEFib3J0Q29udHJvbGxlciBwb2x5ZmlsbCBmcm9tIHRoZSBgbm9kZS1hYm9ydC1jb250cm9sbGVyYCBwYWNrYWdlLiBBIG1pbmltYWwgcG9seWZpbGwgaXMgcHJvdmlkZWQgZm9yIHVzZSBieSBMUlVDYWNoZS5mZXRjaCgpLCBidXQgaXQgc2hvdWxkIG5vdCBiZSByZWxpZWQgdXBvbiBpbiBvdGhlciBjb250ZXh0cyAoZWcsIHBhc3NpbmcgaXQgdG8gb3RoZXIgQVBJcyB0aGF0IHVzZSBBYm9ydENvbnRyb2xsZXIvQWJvcnRTaWduYWwgbWlnaHQgaGF2ZSB1bmRlc2lyYWJsZSBlZmZlY3RzKS4gWW91IG1heSBkaXNhYmxlIHRoaXMgd2l0aCBMUlVfQ0FDSEVfSUdOT1JFX0FDX1dBUk5JTkc9MSBpbiB0aGUgZW52LiIsICJOT19BQk9SVF9DT05UUk9MTEVSIiwgIkVOT1RTVVAiLCB3YXJuQUNQb2x5ZmlsbCk7CiAgfTsKfQpjb25zdCBzaG91bGRXYXJuID0gKGNvZGUpID0+ICF3YXJuZWQuaGFzKGNvZGUpOwpjb25zdCBpc1Bvc0ludCA9IChuKSA9PiBuICYmIG4gPT09IE1hdGguZmxvb3IobikgJiYgbiA+IDAgJiYgaXNGaW5pdGUobik7CmNvbnN0IGdldFVpbnRBcnJheSA9IChtYXgpID0+ICFpc1Bvc0ludChtYXgpID8gbnVsbCA6IG1heCA8PSBNYXRoLnBvdygyLCA4KSA/IFVpbnQ4QXJyYXkgOiBtYXggPD0gTWF0aC5wb3coMiwgMTYpID8gVWludDE2QXJyYXkgOiBtYXggPD0gTWF0aC5wb3coMiwgMzIpID8gVWludDMyQXJyYXkgOiBtYXggPD0gTnVtYmVyLk1BWF9TQUZFX0lOVEVHRVIgPyBaZXJvQXJyYXkgOiBudWxsOwpjbGFzcyBaZXJvQXJyYXkgZXh0ZW5kcyBBcnJheSB7CiAgY29uc3RydWN0b3Ioc2l6ZSkgewogICAgc3VwZXIoc2l6ZSk7CiAgICB0aGlzLmZpbGwoMCk7CiAgfQp9CmNsYXNzIFN0YWNrIHsKICBoZWFwOwogIGxlbmd0aDsKICAvLyBwcml2YXRlIGNvbnN0cnVjdG9yCiAgc3RhdGljICNjb25zdHJ1Y3RpbmcgPSBmYWxzZTsKICBzdGF0aWMgY3JlYXRlKG1heCkgewogICAgY29uc3QgSGVhcENscyA9IGdldFVpbnRBcnJheShtYXgpOwogICAgaWYgKCFIZWFwQ2xzKQogICAgICByZXR1cm4gW107CiAgICBTdGFjay4jY29uc3RydWN0aW5nID0gdHJ1ZTsKICAgIGNvbnN0IHMgPSBuZXcgU3RhY2sobWF4LCBIZWFwQ2xzKTsKICAgIFN0YWNrLiNjb25zdHJ1Y3RpbmcgPSBmYWxzZTsKICAgIHJldHVybiBzOwogIH0KICBjb25zdHJ1Y3RvcihtYXgsIEhlYXBDbHMpIHsKICAgIGlmICghU3RhY2suI2NvbnN0cnVjdGluZykgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJpbnN0YW50aWF0ZSBTdGFjayB1c2luZyBTdGFjay5jcmVhdGUobikiKTsKICAgIH0KICAgIHRoaXMuaGVhcCA9IG5ldyBIZWFwQ2xzKG1heCk7CiAgICB0aGlzLmxlbmd0aCA9IDA7CiAgfQogIHB1c2gobikgewogICAgdGhpcy5oZWFwW3RoaXMubGVuZ3RoKytdID0gbjsKICB9CiAgcG9wKCkgewogICAgcmV0dXJuIHRoaXMuaGVhcFstLXRoaXMubGVuZ3RoXTsKICB9Cn0KY2xhc3MgTFJVQ2FjaGUgewogIC8vIHByb3BlcnRpZXMgY29taW5nIGluIGZyb20gdGhlIG9wdGlvbnMgb2YgdGhlc2UsIG9ubHkgbWF4IGFuZCBtYXhTaXplCiAgLy8gcmVhbGx5ICpuZWVkKiB0byBiZSBwcm90ZWN0ZWQuIFRoZSByZXN0IGNhbiBiZSBtb2RpZmllZCwgYXMgdGhleSBqdXN0CiAgLy8gc2V0IGRlZmF1bHRzIGZvciB2YXJpb3VzIG1ldGhvZHMuCiAgI21heDsKICAjbWF4U2l6ZTsKICAjZGlzcG9zZTsKICAjZGlzcG9zZUFmdGVyOwogICNmZXRjaE1ldGhvZDsKICAvKioKICAgKiB7QGxpbmsgTFJVQ2FjaGUuT3B0aW9uc0Jhc2UudHRsfQogICAqLwogIHR0bDsKICAvKioKICAgKiB7QGxpbmsgTFJVQ2FjaGUuT3B0aW9uc0Jhc2UudHRsUmVzb2x1dGlvbn0KICAgKi8KICB0dGxSZXNvbHV0aW9uOwogIC8qKgogICAqIHtAbGluayBMUlVDYWNoZS5PcHRpb25zQmFzZS50dGxBdXRvcHVyZ2V9CiAgICovCiAgdHRsQXV0b3B1cmdlOwogIC8qKgogICAqIHtAbGluayBMUlVDYWNoZS5PcHRpb25zQmFzZS51cGRhdGVBZ2VPbkdldH0KICAgKi8KICB1cGRhdGVBZ2VPbkdldDsKICAvKioKICAgKiB7QGxpbmsgTFJVQ2FjaGUuT3B0aW9uc0Jhc2UudXBkYXRlQWdlT25IYXN9CiAgICovCiAgdXBkYXRlQWdlT25IYXM7CiAgLyoqCiAgICoge0BsaW5rIExSVUNhY2hlLk9wdGlvbnNCYXNlLmFsbG93U3RhbGV9CiAgICovCiAgYWxsb3dTdGFsZTsKICAvKioKICAgKiB7QGxpbmsgTFJVQ2FjaGUuT3B0aW9uc0Jhc2Uubm9EaXNwb3NlT25TZXR9CiAgICovCiAgbm9EaXNwb3NlT25TZXQ7CiAgLyoqCiAgICoge0BsaW5rIExSVUNhY2hlLk9wdGlvbnNCYXNlLm5vVXBkYXRlVFRMfQogICAqLwogIG5vVXBkYXRlVFRMOwogIC8qKgogICAqIHtAbGluayBMUlVDYWNoZS5PcHRpb25zQmFzZS5tYXhFbnRyeVNpemV9CiAgICovCiAgbWF4RW50cnlTaXplOwogIC8qKgogICAqIHtAbGluayBMUlVDYWNoZS5PcHRpb25zQmFzZS5zaXplQ2FsY3VsYXRpb259CiAgICovCiAgc2l6ZUNhbGN1bGF0aW9uOwogIC8qKgogICAqIHtAbGluayBMUlVDYWNoZS5PcHRpb25zQmFzZS5ub0RlbGV0ZU9uRmV0Y2hSZWplY3Rpb259CiAgICovCiAgbm9EZWxldGVPbkZldGNoUmVqZWN0aW9uOwogIC8qKgogICAqIHtAbGluayBMUlVDYWNoZS5PcHRpb25zQmFzZS5ub0RlbGV0ZU9uU3RhbGVHZXR9CiAgICovCiAgbm9EZWxldGVPblN0YWxlR2V0OwogIC8qKgogICAqIHtAbGluayBMUlVDYWNoZS5PcHRpb25zQmFzZS5hbGxvd1N0YWxlT25GZXRjaEFib3J0fQogICAqLwogIGFsbG93U3RhbGVPbkZldGNoQWJvcnQ7CiAgLyoqCiAgICoge0BsaW5rIExSVUNhY2hlLk9wdGlvbnNCYXNlLmFsbG93U3RhbGVPbkZldGNoUmVqZWN0aW9ufQogICAqLwogIGFsbG93U3RhbGVPbkZldGNoUmVqZWN0aW9uOwogIC8qKgogICAqIHtAbGluayBMUlVDYWNoZS5PcHRpb25zQmFzZS5pZ25vcmVGZXRjaEFib3J0fQogICAqLwogIGlnbm9yZUZldGNoQWJvcnQ7CiAgLy8gY29tcHV0ZWQgcHJvcGVydGllcwogICNzaXplOwogICNjYWxjdWxhdGVkU2l6ZTsKICAja2V5TWFwOwogICNrZXlMaXN0OwogICN2YWxMaXN0OwogICNuZXh0OwogICNwcmV2OwogICNoZWFkOwogICN0YWlsOwogICNmcmVlOwogICNkaXNwb3NlZDsKICAjc2l6ZXM7CiAgI3N0YXJ0czsKICAjdHRsczsKICAjaGFzRGlzcG9zZTsKICAjaGFzRmV0Y2hNZXRob2Q7CiAgI2hhc0Rpc3Bvc2VBZnRlcjsKICAvKioKICAgKiBEbyBub3QgY2FsbCB0aGlzIG1ldGhvZCB1bmxlc3MgeW91IG5lZWQgdG8gaW5zcGVjdCB0aGUKICAgKiBpbm5lciB3b3JraW5ncyBvZiB0aGUgY2FjaGUuICBJZiBhbnl0aGluZyByZXR1cm5lZCBieSB0aGlzCiAgICogb2JqZWN0IGlzIG1vZGlmaWVkIGluIGFueSB3YXksIHN0cmFuZ2UgYnJlYWthZ2UgbWF5IG9jY3VyLgogICAqCiAgICogVGhlc2UgZmllbGRzIGFyZSBwcml2YXRlIGZvciBhIHJlYXNvbiEKICAgKgogICAqIEBpbnRlcm5hbAogICAqLwogIHN0YXRpYyB1bnNhZmVFeHBvc2VJbnRlcm5hbHMoYykgewogICAgcmV0dXJuIHsKICAgICAgLy8gcHJvcGVydGllcwogICAgICBzdGFydHM6IGMuI3N0YXJ0cywKICAgICAgdHRsczogYy4jdHRscywKICAgICAgc2l6ZXM6IGMuI3NpemVzLAogICAgICBrZXlNYXA6IGMuI2tleU1hcCwKICAgICAga2V5TGlzdDogYy4ja2V5TGlzdCwKICAgICAgdmFsTGlzdDogYy4jdmFsTGlzdCwKICAgICAgbmV4dDogYy4jbmV4dCwKICAgICAgcHJldjogYy4jcHJldiwKICAgICAgZ2V0IGhlYWQoKSB7CiAgICAgICAgcmV0dXJuIGMuI2hlYWQ7CiAgICAgIH0sCiAgICAgIGdldCB0YWlsKCkgewogICAgICAgIHJldHVybiBjLiN0YWlsOwogICAgICB9LAogICAgICBmcmVlOiBjLiNmcmVlLAogICAgICAvLyBtZXRob2RzCiAgICAgIGlzQmFja2dyb3VuZEZldGNoOiAocCkgPT4gYy4jaXNCYWNrZ3JvdW5kRmV0Y2gocCksCiAgICAgIGJhY2tncm91bmRGZXRjaDogKGssIGluZGV4LCBvcHRpb25zLCBjb250ZXh0KSA9PiBjLiNiYWNrZ3JvdW5kRmV0Y2goaywgaW5kZXgsIG9wdGlvbnMsIGNvbnRleHQpLAogICAgICBtb3ZlVG9UYWlsOiAoaW5kZXgpID0+IGMuI21vdmVUb1RhaWwoaW5kZXgpLAogICAgICBpbmRleGVzOiAob3B0aW9ucykgPT4gYy4jaW5kZXhlcyhvcHRpb25zKSwKICAgICAgcmluZGV4ZXM6IChvcHRpb25zKSA9PiBjLiNyaW5kZXhlcyhvcHRpb25zKSwKICAgICAgaXNTdGFsZTogKGluZGV4KSA9PiBjLiNpc1N0YWxlKGluZGV4KQogICAgfTsKICB9CiAgLy8gUHJvdGVjdGVkIHJlYWQtb25seSBtZW1iZXJzCiAgLyoqCiAgICoge0BsaW5rIExSVUNhY2hlLk9wdGlvbnNCYXNlLm1heH0gKHJlYWQtb25seSkKICAgKi8KICBnZXQgbWF4KCkgewogICAgcmV0dXJuIHRoaXMuI21heDsKICB9CiAgLyoqCiAgICoge0BsaW5rIExSVUNhY2hlLk9wdGlvbnNCYXNlLm1heFNpemV9IChyZWFkLW9ubHkpCiAgICovCiAgZ2V0IG1heFNpemUoKSB7CiAgICByZXR1cm4gdGhpcy4jbWF4U2l6ZTsKICB9CiAgLyoqCiAgICogVGhlIHRvdGFsIGNvbXB1dGVkIHNpemUgb2YgaXRlbXMgaW4gdGhlIGNhY2hlIChyZWFkLW9ubHkpCiAgICovCiAgZ2V0IGNhbGN1bGF0ZWRTaXplKCkgewogICAgcmV0dXJuIHRoaXMuI2NhbGN1bGF0ZWRTaXplOwogIH0KICAvKioKICAgKiBUaGUgbnVtYmVyIG9mIGl0ZW1zIHN0b3JlZCBpbiB0aGUgY2FjaGUgKHJlYWQtb25seSkKICAgKi8KICBnZXQgc2l6ZSgpIHsKICAgIHJldHVybiB0aGlzLiNzaXplOwogIH0KICAvKioKICAgKiB7QGxpbmsgTFJVQ2FjaGUuT3B0aW9uc0Jhc2UuZmV0Y2hNZXRob2R9IChyZWFkLW9ubHkpCiAgICovCiAgZ2V0IGZldGNoTWV0aG9kKCkgewogICAgcmV0dXJuIHRoaXMuI2ZldGNoTWV0aG9kOwogIH0KICAvKioKICAgKiB7QGxpbmsgTFJVQ2FjaGUuT3B0aW9uc0Jhc2UuZGlzcG9zZX0gKHJlYWQtb25seSkKICAgKi8KICBnZXQgZGlzcG9zZSgpIHsKICAgIHJldHVybiB0aGlzLiNkaXNwb3NlOwogIH0KICAvKioKICAgKiB7QGxpbmsgTFJVQ2FjaGUuT3B0aW9uc0Jhc2UuZGlzcG9zZUFmdGVyfSAocmVhZC1vbmx5KQogICAqLwogIGdldCBkaXNwb3NlQWZ0ZXIoKSB7CiAgICByZXR1cm4gdGhpcy4jZGlzcG9zZUFmdGVyOwogIH0KICBjb25zdHJ1Y3RvcihvcHRpb25zKSB7CiAgICBjb25zdCB7IG1heCA9IDAsIHR0bCwgdHRsUmVzb2x1dGlvbiA9IDEsIHR0bEF1dG9wdXJnZSwgdXBkYXRlQWdlT25HZXQsIHVwZGF0ZUFnZU9uSGFzLCBhbGxvd1N0YWxlLCBkaXNwb3NlLCBkaXNwb3NlQWZ0ZXIsIG5vRGlzcG9zZU9uU2V0LCBub1VwZGF0ZVRUTCwgbWF4U2l6ZSA9IDAsIG1heEVudHJ5U2l6ZSA9IDAsIHNpemVDYWxjdWxhdGlvbiwgZmV0Y2hNZXRob2QsIG5vRGVsZXRlT25GZXRjaFJlamVjdGlvbiwgbm9EZWxldGVPblN0YWxlR2V0LCBhbGxvd1N0YWxlT25GZXRjaFJlamVjdGlvbiwgYWxsb3dTdGFsZU9uRmV0Y2hBYm9ydCwgaWdub3JlRmV0Y2hBYm9ydCB9ID0gb3B0aW9uczsKICAgIGlmIChtYXggIT09IDAgJiYgIWlzUG9zSW50KG1heCkpIHsKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigibWF4IG9wdGlvbiBtdXN0IGJlIGEgbm9ubmVnYXRpdmUgaW50ZWdlciIpOwogICAgfQogICAgY29uc3QgVWludEFycmF5ID0gbWF4ID8gZ2V0VWludEFycmF5KG1heCkgOiBBcnJheTsKICAgIGlmICghVWludEFycmF5KSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiaW52YWxpZCBtYXggdmFsdWU6ICIgKyBtYXgpOwogICAgfQogICAgdGhpcy4jbWF4ID0gbWF4OwogICAgdGhpcy4jbWF4U2l6ZSA9IG1heFNpemU7CiAgICB0aGlzLm1heEVudHJ5U2l6ZSA9IG1heEVudHJ5U2l6ZSB8fCB0aGlzLiNtYXhTaXplOwogICAgdGhpcy5zaXplQ2FsY3VsYXRpb24gPSBzaXplQ2FsY3VsYXRpb247CiAgICBpZiAodGhpcy5zaXplQ2FsY3VsYXRpb24pIHsKICAgICAgaWYgKCF0aGlzLiNtYXhTaXplICYmICF0aGlzLm1heEVudHJ5U2l6ZSkgewogICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoImNhbm5vdCBzZXQgc2l6ZUNhbGN1bGF0aW9uIHdpdGhvdXQgc2V0dGluZyBtYXhTaXplIG9yIG1heEVudHJ5U2l6ZSIpOwogICAgICB9CiAgICAgIGlmICh0eXBlb2YgdGhpcy5zaXplQ2FsY3VsYXRpb24gIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJzaXplQ2FsY3VsYXRpb24gc2V0IHRvIG5vbi1mdW5jdGlvbiIpOwogICAgICB9CiAgICB9CiAgICBpZiAoZmV0Y2hNZXRob2QgIT09IHZvaWQgMCAmJiB0eXBlb2YgZmV0Y2hNZXRob2QgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiZmV0Y2hNZXRob2QgbXVzdCBiZSBhIGZ1bmN0aW9uIGlmIHNwZWNpZmllZCIpOwogICAgfQogICAgdGhpcy4jZmV0Y2hNZXRob2QgPSBmZXRjaE1ldGhvZDsKICAgIHRoaXMuI2hhc0ZldGNoTWV0aG9kID0gISFmZXRjaE1ldGhvZDsKICAgIHRoaXMuI2tleU1hcCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICB0aGlzLiNrZXlMaXN0ID0gbmV3IEFycmF5KG1heCkuZmlsbCh2b2lkIDApOwogICAgdGhpcy4jdmFsTGlzdCA9IG5ldyBBcnJheShtYXgpLmZpbGwodm9pZCAwKTsKICAgIHRoaXMuI25leHQgPSBuZXcgVWludEFycmF5KG1heCk7CiAgICB0aGlzLiNwcmV2ID0gbmV3IFVpbnRBcnJheShtYXgpOwogICAgdGhpcy4jaGVhZCA9IDA7CiAgICB0aGlzLiN0YWlsID0gMDsKICAgIHRoaXMuI2ZyZWUgPSBTdGFjay5jcmVhdGUobWF4KTsKICAgIHRoaXMuI3NpemUgPSAwOwogICAgdGhpcy4jY2FsY3VsYXRlZFNpemUgPSAwOwogICAgaWYgKHR5cGVvZiBkaXNwb3NlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIHRoaXMuI2Rpc3Bvc2UgPSBkaXNwb3NlOwogICAgfQogICAgaWYgKHR5cGVvZiBkaXNwb3NlQWZ0ZXIgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgdGhpcy4jZGlzcG9zZUFmdGVyID0gZGlzcG9zZUFmdGVyOwogICAgICB0aGlzLiNkaXNwb3NlZCA9IFtdOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy4jZGlzcG9zZUFmdGVyID0gdm9pZCAwOwogICAgICB0aGlzLiNkaXNwb3NlZCA9IHZvaWQgMDsKICAgIH0KICAgIHRoaXMuI2hhc0Rpc3Bvc2UgPSAhIXRoaXMuI2Rpc3Bvc2U7CiAgICB0aGlzLiNoYXNEaXNwb3NlQWZ0ZXIgPSAhIXRoaXMuI2Rpc3Bvc2VBZnRlcjsKICAgIHRoaXMubm9EaXNwb3NlT25TZXQgPSAhIW5vRGlzcG9zZU9uU2V0OwogICAgdGhpcy5ub1VwZGF0ZVRUTCA9ICEhbm9VcGRhdGVUVEw7CiAgICB0aGlzLm5vRGVsZXRlT25GZXRjaFJlamVjdGlvbiA9ICEhbm9EZWxldGVPbkZldGNoUmVqZWN0aW9uOwogICAgdGhpcy5hbGxvd1N0YWxlT25GZXRjaFJlamVjdGlvbiA9ICEhYWxsb3dTdGFsZU9uRmV0Y2hSZWplY3Rpb247CiAgICB0aGlzLmFsbG93U3RhbGVPbkZldGNoQWJvcnQgPSAhIWFsbG93U3RhbGVPbkZldGNoQWJvcnQ7CiAgICB0aGlzLmlnbm9yZUZldGNoQWJvcnQgPSAhIWlnbm9yZUZldGNoQWJvcnQ7CiAgICBpZiAodGhpcy5tYXhFbnRyeVNpemUgIT09IDApIHsKICAgICAgaWYgKHRoaXMuI21heFNpemUgIT09IDApIHsKICAgICAgICBpZiAoIWlzUG9zSW50KHRoaXMuI21heFNpemUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJtYXhTaXplIG11c3QgYmUgYSBwb3NpdGl2ZSBpbnRlZ2VyIGlmIHNwZWNpZmllZCIpOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoIWlzUG9zSW50KHRoaXMubWF4RW50cnlTaXplKSkgewogICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIm1heEVudHJ5U2l6ZSBtdXN0IGJlIGEgcG9zaXRpdmUgaW50ZWdlciBpZiBzcGVjaWZpZWQiKTsKICAgICAgfQogICAgICB0aGlzLiNpbml0aWFsaXplU2l6ZVRyYWNraW5nKCk7CiAgICB9CiAgICB0aGlzLmFsbG93U3RhbGUgPSAhIWFsbG93U3RhbGU7CiAgICB0aGlzLm5vRGVsZXRlT25TdGFsZUdldCA9ICEhbm9EZWxldGVPblN0YWxlR2V0OwogICAgdGhpcy51cGRhdGVBZ2VPbkdldCA9ICEhdXBkYXRlQWdlT25HZXQ7CiAgICB0aGlzLnVwZGF0ZUFnZU9uSGFzID0gISF1cGRhdGVBZ2VPbkhhczsKICAgIHRoaXMudHRsUmVzb2x1dGlvbiA9IGlzUG9zSW50KHR0bFJlc29sdXRpb24pIHx8IHR0bFJlc29sdXRpb24gPT09IDAgPyB0dGxSZXNvbHV0aW9uIDogMTsKICAgIHRoaXMudHRsQXV0b3B1cmdlID0gISF0dGxBdXRvcHVyZ2U7CiAgICB0aGlzLnR0bCA9IHR0bCB8fCAwOwogICAgaWYgKHRoaXMudHRsKSB7CiAgICAgIGlmICghaXNQb3NJbnQodGhpcy50dGwpKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigidHRsIG11c3QgYmUgYSBwb3NpdGl2ZSBpbnRlZ2VyIGlmIHNwZWNpZmllZCIpOwogICAgICB9CiAgICAgIHRoaXMuI2luaXRpYWxpemVUVExUcmFja2luZygpOwogICAgfQogICAgaWYgKHRoaXMuI21heCA9PT0gMCAmJiB0aGlzLnR0bCA9PT0gMCAmJiB0aGlzLiNtYXhTaXplID09PSAwKSB7CiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkF0IGxlYXN0IG9uZSBvZiBtYXgsIG1heFNpemUsIG9yIHR0bCBpcyByZXF1aXJlZCIpOwogICAgfQogICAgaWYgKCF0aGlzLnR0bEF1dG9wdXJnZSAmJiAhdGhpcy4jbWF4ICYmICF0aGlzLiNtYXhTaXplKSB7CiAgICAgIGNvbnN0IGNvZGUgPSAiTFJVX0NBQ0hFX1VOQk9VTkRFRCI7CiAgICAgIGlmIChzaG91bGRXYXJuKGNvZGUpKSB7CiAgICAgICAgd2FybmVkLmFkZChjb2RlKTsKICAgICAgICBjb25zdCBtc2cgPSAiVFRMIGNhY2hpbmcgd2l0aG91dCB0dGxBdXRvcHVyZ2UsIG1heCwgb3IgbWF4U2l6ZSBjYW4gcmVzdWx0IGluIHVuYm91bmRlZCBtZW1vcnkgY29uc3VtcHRpb24uIjsKICAgICAgICBlbWl0V2FybmluZyhtc2csICJVbmJvdW5kZWRDYWNoZVdhcm5pbmciLCBjb2RlLCBMUlVDYWNoZSk7CiAgICAgIH0KICAgIH0KICB9CiAgLyoqCiAgICogUmV0dXJuIHRoZSByZW1haW5pbmcgVFRMIHRpbWUgZm9yIGEgZ2l2ZW4gZW50cnkga2V5CiAgICovCiAgZ2V0UmVtYWluaW5nVFRMKGtleSkgewogICAgcmV0dXJuIHRoaXMuI2tleU1hcC5oYXMoa2V5KSA/IEluZmluaXR5IDogMDsKICB9CiAgI2luaXRpYWxpemVUVExUcmFja2luZygpIHsKICAgIGNvbnN0IHR0bHMgPSBuZXcgWmVyb0FycmF5KHRoaXMuI21heCk7CiAgICBjb25zdCBzdGFydHMgPSBuZXcgWmVyb0FycmF5KHRoaXMuI21heCk7CiAgICB0aGlzLiN0dGxzID0gdHRsczsKICAgIHRoaXMuI3N0YXJ0cyA9IHN0YXJ0czsKICAgIHRoaXMuI3NldEl0ZW1UVEwgPSAoaW5kZXgsIHR0bCwgc3RhcnQgPSBwZXJmLm5vdygpKSA9PiB7CiAgICAgIHN0YXJ0c1tpbmRleF0gPSB0dGwgIT09IDAgPyBzdGFydCA6IDA7CiAgICAgIHR0bHNbaW5kZXhdID0gdHRsOwogICAgICBpZiAodHRsICE9PSAwICYmIHRoaXMudHRsQXV0b3B1cmdlKSB7CiAgICAgICAgY29uc3QgdCA9IHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgaWYgKHRoaXMuI2lzU3RhbGUoaW5kZXgpKSB7CiAgICAgICAgICAgIHRoaXMuZGVsZXRlKHRoaXMuI2tleUxpc3RbaW5kZXhdKTsKICAgICAgICAgIH0KICAgICAgICB9LCB0dGwgKyAxKTsKICAgICAgICBpZiAodC51bnJlZikgewogICAgICAgICAgdC51bnJlZigpOwogICAgICAgIH0KICAgICAgfQogICAgfTsKICAgIHRoaXMuI3VwZGF0ZUl0ZW1BZ2UgPSAoaW5kZXgpID0+IHsKICAgICAgc3RhcnRzW2luZGV4XSA9IHR0bHNbaW5kZXhdICE9PSAwID8gcGVyZi5ub3coKSA6IDA7CiAgICB9OwogICAgdGhpcy4jc3RhdHVzVFRMID0gKHN0YXR1cywgaW5kZXgpID0+IHsKICAgICAgaWYgKHR0bHNbaW5kZXhdKSB7CiAgICAgICAgY29uc3QgdHRsID0gdHRsc1tpbmRleF07CiAgICAgICAgY29uc3Qgc3RhcnQgPSBzdGFydHNbaW5kZXhdOwogICAgICAgIHN0YXR1cy50dGwgPSB0dGw7CiAgICAgICAgc3RhdHVzLnN0YXJ0ID0gc3RhcnQ7CiAgICAgICAgc3RhdHVzLm5vdyA9IGNhY2hlZE5vdyB8fCBnZXROb3coKTsKICAgICAgICBjb25zdCBhZ2UgPSBzdGF0dXMubm93IC0gc3RhcnQ7CiAgICAgICAgc3RhdHVzLnJlbWFpbmluZ1RUTCA9IHR0bCAtIGFnZTsKICAgICAgfQogICAgfTsKICAgIGxldCBjYWNoZWROb3cgPSAwOwogICAgY29uc3QgZ2V0Tm93ID0gKCkgPT4gewogICAgICBjb25zdCBuID0gcGVyZi5ub3coKTsKICAgICAgaWYgKHRoaXMudHRsUmVzb2x1dGlvbiA+IDApIHsKICAgICAgICBjYWNoZWROb3cgPSBuOwogICAgICAgIGNvbnN0IHQgPSBzZXRUaW1lb3V0KCgpID0+IGNhY2hlZE5vdyA9IDAsIHRoaXMudHRsUmVzb2x1dGlvbik7CiAgICAgICAgaWYgKHQudW5yZWYpIHsKICAgICAgICAgIHQudW5yZWYoKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIG47CiAgICB9OwogICAgdGhpcy5nZXRSZW1haW5pbmdUVEwgPSAoa2V5KSA9PiB7CiAgICAgIGNvbnN0IGluZGV4ID0gdGhpcy4ja2V5TWFwLmdldChrZXkpOwogICAgICBpZiAoaW5kZXggPT09IHZvaWQgMCkgewogICAgICAgIHJldHVybiAwOwogICAgICB9CiAgICAgIGNvbnN0IHR0bCA9IHR0bHNbaW5kZXhdOwogICAgICBjb25zdCBzdGFydCA9IHN0YXJ0c1tpbmRleF07CiAgICAgIGlmICh0dGwgPT09IDAgfHwgc3RhcnQgPT09IDApIHsKICAgICAgICByZXR1cm4gSW5maW5pdHk7CiAgICAgIH0KICAgICAgY29uc3QgYWdlID0gKGNhY2hlZE5vdyB8fCBnZXROb3coKSkgLSBzdGFydDsKICAgICAgcmV0dXJuIHR0bCAtIGFnZTsKICAgIH07CiAgICB0aGlzLiNpc1N0YWxlID0gKGluZGV4KSA9PiB7CiAgICAgIHJldHVybiB0dGxzW2luZGV4XSAhPT0gMCAmJiBzdGFydHNbaW5kZXhdICE9PSAwICYmIChjYWNoZWROb3cgfHwgZ2V0Tm93KCkpIC0gc3RhcnRzW2luZGV4XSA+IHR0bHNbaW5kZXhdOwogICAgfTsKICB9CiAgLy8gY29uZGl0aW9uYWxseSBzZXQgcHJpdmF0ZSBtZXRob2RzIHJlbGF0ZWQgdG8gVFRMCiAgI3VwZGF0ZUl0ZW1BZ2UgPSAoKSA9PiB7CiAgfTsKICAjc3RhdHVzVFRMID0gKCkgPT4gewogIH07CiAgI3NldEl0ZW1UVEwgPSAoKSA9PiB7CiAgfTsKICAvKiBjOCBpZ25vcmUgc3RvcCAqLwogICNpc1N0YWxlID0gKCkgPT4gZmFsc2U7CiAgI2luaXRpYWxpemVTaXplVHJhY2tpbmcoKSB7CiAgICBjb25zdCBzaXplcyA9IG5ldyBaZXJvQXJyYXkodGhpcy4jbWF4KTsKICAgIHRoaXMuI2NhbGN1bGF0ZWRTaXplID0gMDsKICAgIHRoaXMuI3NpemVzID0gc2l6ZXM7CiAgICB0aGlzLiNyZW1vdmVJdGVtU2l6ZSA9IChpbmRleCkgPT4gewogICAgICB0aGlzLiNjYWxjdWxhdGVkU2l6ZSAtPSBzaXplc1tpbmRleF07CiAgICAgIHNpemVzW2luZGV4XSA9IDA7CiAgICB9OwogICAgdGhpcy4jcmVxdWlyZVNpemUgPSAoaywgdiwgc2l6ZSwgc2l6ZUNhbGN1bGF0aW9uKSA9PiB7CiAgICAgIGlmICh0aGlzLiNpc0JhY2tncm91bmRGZXRjaCh2KSkgewogICAgICAgIHJldHVybiAwOwogICAgICB9CiAgICAgIGlmICghaXNQb3NJbnQoc2l6ZSkpIHsKICAgICAgICBpZiAoc2l6ZUNhbGN1bGF0aW9uKSB7CiAgICAgICAgICBpZiAodHlwZW9mIHNpemVDYWxjdWxhdGlvbiAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJzaXplQ2FsY3VsYXRpb24gbXVzdCBiZSBhIGZ1bmN0aW9uIik7CiAgICAgICAgICB9CiAgICAgICAgICBzaXplID0gc2l6ZUNhbGN1bGF0aW9uKHYsIGspOwogICAgICAgICAgaWYgKCFpc1Bvc0ludChzaXplKSkgewogICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJzaXplQ2FsY3VsYXRpb24gcmV0dXJuIGludmFsaWQgKGV4cGVjdCBwb3NpdGl2ZSBpbnRlZ2VyKSIpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJpbnZhbGlkIHNpemUgdmFsdWUgKG11c3QgYmUgcG9zaXRpdmUgaW50ZWdlcikuIFdoZW4gbWF4U2l6ZSBvciBtYXhFbnRyeVNpemUgaXMgdXNlZCwgc2l6ZUNhbGN1bGF0aW9uIG9yIHNpemUgbXVzdCBiZSBzZXQuIik7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBzaXplOwogICAgfTsKICAgIHRoaXMuI2FkZEl0ZW1TaXplID0gKGluZGV4LCBzaXplLCBzdGF0dXMpID0+IHsKICAgICAgc2l6ZXNbaW5kZXhdID0gc2l6ZTsKICAgICAgaWYgKHRoaXMuI21heFNpemUpIHsKICAgICAgICBjb25zdCBtYXhTaXplID0gdGhpcy4jbWF4U2l6ZSAtIHNpemVzW2luZGV4XTsKICAgICAgICB3aGlsZSAodGhpcy4jY2FsY3VsYXRlZFNpemUgPiBtYXhTaXplKSB7CiAgICAgICAgICB0aGlzLiNldmljdCh0cnVlKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgdGhpcy4jY2FsY3VsYXRlZFNpemUgKz0gc2l6ZXNbaW5kZXhdOwogICAgICBpZiAoc3RhdHVzKSB7CiAgICAgICAgc3RhdHVzLmVudHJ5U2l6ZSA9IHNpemU7CiAgICAgICAgc3RhdHVzLnRvdGFsQ2FsY3VsYXRlZFNpemUgPSB0aGlzLiNjYWxjdWxhdGVkU2l6ZTsKICAgICAgfQogICAgfTsKICB9CiAgI3JlbW92ZUl0ZW1TaXplID0gKF9pKSA9PiB7CiAgfTsKICAjYWRkSXRlbVNpemUgPSAoX2ksIF9zLCBfc3QpID0+IHsKICB9OwogICNyZXF1aXJlU2l6ZSA9IChfaywgX3YsIHNpemUsIHNpemVDYWxjdWxhdGlvbikgPT4gewogICAgaWYgKHNpemUgfHwgc2l6ZUNhbGN1bGF0aW9uKSB7CiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoImNhbm5vdCBzZXQgc2l6ZSB3aXRob3V0IHNldHRpbmcgbWF4U2l6ZSBvciBtYXhFbnRyeVNpemUgb24gY2FjaGUiKTsKICAgIH0KICAgIHJldHVybiAwOwogIH07CiAgKiNpbmRleGVzKHsgYWxsb3dTdGFsZSA9IHRoaXMuYWxsb3dTdGFsZSB9ID0ge30pIHsKICAgIGlmICh0aGlzLiNzaXplKSB7CiAgICAgIGZvciAobGV0IGkgPSB0aGlzLiN0YWlsOyB0cnVlOyApIHsKICAgICAgICBpZiAoIXRoaXMuI2lzVmFsaWRJbmRleChpKSkgewogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICAgIGlmIChhbGxvd1N0YWxlIHx8ICF0aGlzLiNpc1N0YWxlKGkpKSB7CiAgICAgICAgICB5aWVsZCBpOwogICAgICAgIH0KICAgICAgICBpZiAoaSA9PT0gdGhpcy4jaGVhZCkgewogICAgICAgICAgYnJlYWs7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGkgPSB0aGlzLiNwcmV2W2ldOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KICAqI3JpbmRleGVzKHsgYWxsb3dTdGFsZSA9IHRoaXMuYWxsb3dTdGFsZSB9ID0ge30pIHsKICAgIGlmICh0aGlzLiNzaXplKSB7CiAgICAgIGZvciAobGV0IGkgPSB0aGlzLiNoZWFkOyB0cnVlOyApIHsKICAgICAgICBpZiAoIXRoaXMuI2lzVmFsaWRJbmRleChpKSkgewogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICAgIGlmIChhbGxvd1N0YWxlIHx8ICF0aGlzLiNpc1N0YWxlKGkpKSB7CiAgICAgICAgICB5aWVsZCBpOwogICAgICAgIH0KICAgICAgICBpZiAoaSA9PT0gdGhpcy4jdGFpbCkgewogICAgICAgICAgYnJlYWs7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGkgPSB0aGlzLiNuZXh0W2ldOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KICAjaXNWYWxpZEluZGV4KGluZGV4KSB7CiAgICByZXR1cm4gaW5kZXggIT09IHZvaWQgMCAmJiB0aGlzLiNrZXlNYXAuZ2V0KHRoaXMuI2tleUxpc3RbaW5kZXhdKSA9PT0gaW5kZXg7CiAgfQogIC8qKgogICAqIFJldHVybiBhIGdlbmVyYXRvciB5aWVsZGluZyBgW2tleSwgdmFsdWVdYCBwYWlycywKICAgKiBpbiBvcmRlciBmcm9tIG1vc3QgcmVjZW50bHkgdXNlZCB0byBsZWFzdCByZWNlbnRseSB1c2VkLgogICAqLwogICplbnRyaWVzKCkgewogICAgZm9yIChjb25zdCBpIG9mIHRoaXMuI2luZGV4ZXMoKSkgewogICAgICBpZiAodGhpcy4jdmFsTGlzdFtpXSAhPT0gdm9pZCAwICYmIHRoaXMuI2tleUxpc3RbaV0gIT09IHZvaWQgMCAmJiAhdGhpcy4jaXNCYWNrZ3JvdW5kRmV0Y2godGhpcy4jdmFsTGlzdFtpXSkpIHsKICAgICAgICB5aWVsZCBbdGhpcy4ja2V5TGlzdFtpXSwgdGhpcy4jdmFsTGlzdFtpXV07CiAgICAgIH0KICAgIH0KICB9CiAgLyoqCiAgICogSW52ZXJzZSBvcmRlciB2ZXJzaW9uIG9mIHtAbGluayBMUlVDYWNoZS5lbnRyaWVzfQogICAqCiAgICogUmV0dXJuIGEgZ2VuZXJhdG9yIHlpZWxkaW5nIGBba2V5LCB2YWx1ZV1gIHBhaXJzLAogICAqIGluIG9yZGVyIGZyb20gbGVhc3QgcmVjZW50bHkgdXNlZCB0byBtb3N0IHJlY2VudGx5IHVzZWQuCiAgICovCiAgKnJlbnRyaWVzKCkgewogICAgZm9yIChjb25zdCBpIG9mIHRoaXMuI3JpbmRleGVzKCkpIHsKICAgICAgaWYgKHRoaXMuI3ZhbExpc3RbaV0gIT09IHZvaWQgMCAmJiB0aGlzLiNrZXlMaXN0W2ldICE9PSB2b2lkIDAgJiYgIXRoaXMuI2lzQmFja2dyb3VuZEZldGNoKHRoaXMuI3ZhbExpc3RbaV0pKSB7CiAgICAgICAgeWllbGQgW3RoaXMuI2tleUxpc3RbaV0sIHRoaXMuI3ZhbExpc3RbaV1dOwogICAgICB9CiAgICB9CiAgfQogIC8qKgogICAqIFJldHVybiBhIGdlbmVyYXRvciB5aWVsZGluZyB0aGUga2V5cyBpbiB0aGUgY2FjaGUsCiAgICogaW4gb3JkZXIgZnJvbSBtb3N0IHJlY2VudGx5IHVzZWQgdG8gbGVhc3QgcmVjZW50bHkgdXNlZC4KICAgKi8KICAqa2V5cygpIHsKICAgIGZvciAoY29uc3QgaSBvZiB0aGlzLiNpbmRleGVzKCkpIHsKICAgICAgY29uc3QgayA9IHRoaXMuI2tleUxpc3RbaV07CiAgICAgIGlmIChrICE9PSB2b2lkIDAgJiYgIXRoaXMuI2lzQmFja2dyb3VuZEZldGNoKHRoaXMuI3ZhbExpc3RbaV0pKSB7CiAgICAgICAgeWllbGQgazsKICAgICAgfQogICAgfQogIH0KICAvKioKICAgKiBJbnZlcnNlIG9yZGVyIHZlcnNpb24gb2Yge0BsaW5rIExSVUNhY2hlLmtleXN9CiAgICoKICAgKiBSZXR1cm4gYSBnZW5lcmF0b3IgeWllbGRpbmcgdGhlIGtleXMgaW4gdGhlIGNhY2hlLAogICAqIGluIG9yZGVyIGZyb20gbGVhc3QgcmVjZW50bHkgdXNlZCB0byBtb3N0IHJlY2VudGx5IHVzZWQuCiAgICovCiAgKnJrZXlzKCkgewogICAgZm9yIChjb25zdCBpIG9mIHRoaXMuI3JpbmRleGVzKCkpIHsKICAgICAgY29uc3QgayA9IHRoaXMuI2tleUxpc3RbaV07CiAgICAgIGlmIChrICE9PSB2b2lkIDAgJiYgIXRoaXMuI2lzQmFja2dyb3VuZEZldGNoKHRoaXMuI3ZhbExpc3RbaV0pKSB7CiAgICAgICAgeWllbGQgazsKICAgICAgfQogICAgfQogIH0KICAvKioKICAgKiBSZXR1cm4gYSBnZW5lcmF0b3IgeWllbGRpbmcgdGhlIHZhbHVlcyBpbiB0aGUgY2FjaGUsCiAgICogaW4gb3JkZXIgZnJvbSBtb3N0IHJlY2VudGx5IHVzZWQgdG8gbGVhc3QgcmVjZW50bHkgdXNlZC4KICAgKi8KICAqdmFsdWVzKCkgewogICAgZm9yIChjb25zdCBpIG9mIHRoaXMuI2luZGV4ZXMoKSkgewogICAgICBjb25zdCB2ID0gdGhpcy4jdmFsTGlzdFtpXTsKICAgICAgaWYgKHYgIT09IHZvaWQgMCAmJiAhdGhpcy4jaXNCYWNrZ3JvdW5kRmV0Y2godGhpcy4jdmFsTGlzdFtpXSkpIHsKICAgICAgICB5aWVsZCB0aGlzLiN2YWxMaXN0W2ldOwogICAgICB9CiAgICB9CiAgfQogIC8qKgogICAqIEludmVyc2Ugb3JkZXIgdmVyc2lvbiBvZiB7QGxpbmsgTFJVQ2FjaGUudmFsdWVzfQogICAqCiAgICogUmV0dXJuIGEgZ2VuZXJhdG9yIHlpZWxkaW5nIHRoZSB2YWx1ZXMgaW4gdGhlIGNhY2hlLAogICAqIGluIG9yZGVyIGZyb20gbGVhc3QgcmVjZW50bHkgdXNlZCB0byBtb3N0IHJlY2VudGx5IHVzZWQuCiAgICovCiAgKnJ2YWx1ZXMoKSB7CiAgICBmb3IgKGNvbnN0IGkgb2YgdGhpcy4jcmluZGV4ZXMoKSkgewogICAgICBjb25zdCB2ID0gdGhpcy4jdmFsTGlzdFtpXTsKICAgICAgaWYgKHYgIT09IHZvaWQgMCAmJiAhdGhpcy4jaXNCYWNrZ3JvdW5kRmV0Y2godGhpcy4jdmFsTGlzdFtpXSkpIHsKICAgICAgICB5aWVsZCB0aGlzLiN2YWxMaXN0W2ldOwogICAgICB9CiAgICB9CiAgfQogIC8qKgogICAqIEl0ZXJhdGluZyBvdmVyIHRoZSBjYWNoZSBpdHNlbGYgeWllbGRzIHRoZSBzYW1lIHJlc3VsdHMgYXMKICAgKiB7QGxpbmsgTFJVQ2FjaGUuZW50cmllc30KICAgKi8KICBbU3ltYm9sLml0ZXJhdG9yXSgpIHsKICAgIHJldHVybiB0aGlzLmVudHJpZXMoKTsKICB9CiAgLyoqCiAgICogRmluZCBhIHZhbHVlIGZvciB3aGljaCB0aGUgc3VwcGxpZWQgZm4gbWV0aG9kIHJldHVybnMgYSB0cnV0aHkgdmFsdWUsCiAgICogc2ltaWxhciB0byBBcnJheS5maW5kKCkuICBmbiBpcyBjYWxsZWQgYXMgZm4odmFsdWUsIGtleSwgY2FjaGUpLgogICAqLwogIGZpbmQoZm4sIGdldE9wdGlvbnMgPSB7fSkgewogICAgZm9yIChjb25zdCBpIG9mIHRoaXMuI2luZGV4ZXMoKSkgewogICAgICBjb25zdCB2ID0gdGhpcy4jdmFsTGlzdFtpXTsKICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLiNpc0JhY2tncm91bmRGZXRjaCh2KSA/IHYuX19zdGFsZVdoaWxlRmV0Y2hpbmcgOiB2OwogICAgICBpZiAodmFsdWUgPT09IHZvaWQgMCkKICAgICAgICBjb250aW51ZTsKICAgICAgaWYgKGZuKHZhbHVlLCB0aGlzLiNrZXlMaXN0W2ldLCB0aGlzKSkgewogICAgICAgIHJldHVybiB0aGlzLmdldCh0aGlzLiNrZXlMaXN0W2ldLCBnZXRPcHRpb25zKTsKICAgICAgfQogICAgfQogIH0KICAvKioKICAgKiBDYWxsIHRoZSBzdXBwbGllZCBmdW5jdGlvbiBvbiBlYWNoIGl0ZW0gaW4gdGhlIGNhY2hlLCBpbiBvcmRlciBmcm9tCiAgICogbW9zdCByZWNlbnRseSB1c2VkIHRvIGxlYXN0IHJlY2VudGx5IHVzZWQuICBmbiBpcyBjYWxsZWQgYXMKICAgKiBmbih2YWx1ZSwga2V5LCBjYWNoZSkuICBEb2VzIG5vdCB1cGRhdGUgYWdlIG9yIHJlY2VudHkgb2YgdXNlLgogICAqIERvZXMgbm90IGl0ZXJhdGUgb3ZlciBzdGFsZSB2YWx1ZXMuCiAgICovCiAgZm9yRWFjaChmbiwgdGhpc3AgPSB0aGlzKSB7CiAgICBmb3IgKGNvbnN0IGkgb2YgdGhpcy4jaW5kZXhlcygpKSB7CiAgICAgIGNvbnN0IHYgPSB0aGlzLiN2YWxMaXN0W2ldOwogICAgICBjb25zdCB2YWx1ZSA9IHRoaXMuI2lzQmFja2dyb3VuZEZldGNoKHYpID8gdi5fX3N0YWxlV2hpbGVGZXRjaGluZyA6IHY7CiAgICAgIGlmICh2YWx1ZSA9PT0gdm9pZCAwKQogICAgICAgIGNvbnRpbnVlOwogICAgICBmbi5jYWxsKHRoaXNwLCB2YWx1ZSwgdGhpcy4ja2V5TGlzdFtpXSwgdGhpcyk7CiAgICB9CiAgfQogIC8qKgogICAqIFRoZSBzYW1lIGFzIHtAbGluayBMUlVDYWNoZS5mb3JFYWNofSBidXQgaXRlbXMgYXJlIGl0ZXJhdGVkIG92ZXIgaW4KICAgKiByZXZlcnNlIG9yZGVyLiAgKGllLCBsZXNzIHJlY2VudGx5IHVzZWQgaXRlbXMgYXJlIGl0ZXJhdGVkIG92ZXIgZmlyc3QuKQogICAqLwogIHJmb3JFYWNoKGZuLCB0aGlzcCA9IHRoaXMpIHsKICAgIGZvciAoY29uc3QgaSBvZiB0aGlzLiNyaW5kZXhlcygpKSB7CiAgICAgIGNvbnN0IHYgPSB0aGlzLiN2YWxMaXN0W2ldOwogICAgICBjb25zdCB2YWx1ZSA9IHRoaXMuI2lzQmFja2dyb3VuZEZldGNoKHYpID8gdi5fX3N0YWxlV2hpbGVGZXRjaGluZyA6IHY7CiAgICAgIGlmICh2YWx1ZSA9PT0gdm9pZCAwKQogICAgICAgIGNvbnRpbnVlOwogICAgICBmbi5jYWxsKHRoaXNwLCB2YWx1ZSwgdGhpcy4ja2V5TGlzdFtpXSwgdGhpcyk7CiAgICB9CiAgfQogIC8qKgogICAqIERlbGV0ZSBhbnkgc3RhbGUgZW50cmllcy4gUmV0dXJucyB0cnVlIGlmIGFueXRoaW5nIHdhcyByZW1vdmVkLAogICAqIGZhbHNlIG90aGVyd2lzZS4KICAgKi8KICBwdXJnZVN0YWxlKCkgewogICAgbGV0IGRlbGV0ZWQgPSBmYWxzZTsKICAgIGZvciAoY29uc3QgaSBvZiB0aGlzLiNyaW5kZXhlcyh7IGFsbG93U3RhbGU6IHRydWUgfSkpIHsKICAgICAgaWYgKHRoaXMuI2lzU3RhbGUoaSkpIHsKICAgICAgICB0aGlzLmRlbGV0ZSh0aGlzLiNrZXlMaXN0W2ldKTsKICAgICAgICBkZWxldGVkID0gdHJ1ZTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGRlbGV0ZWQ7CiAgfQogIC8qKgogICAqIFJldHVybiBhbiBhcnJheSBvZiBba2V5LCB7QGxpbmsgTFJVQ2FjaGUuRW50cnl9XSB0dXBsZXMgd2hpY2ggY2FuIGJlCiAgICogcGFzc2VkIHRvIGNhY2hlLmxvYWQoKQogICAqLwogIGR1bXAoKSB7CiAgICBjb25zdCBhcnIgPSBbXTsKICAgIGZvciAoY29uc3QgaSBvZiB0aGlzLiNpbmRleGVzKHsgYWxsb3dTdGFsZTogdHJ1ZSB9KSkgewogICAgICBjb25zdCBrZXkgPSB0aGlzLiNrZXlMaXN0W2ldOwogICAgICBjb25zdCB2ID0gdGhpcy4jdmFsTGlzdFtpXTsKICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLiNpc0JhY2tncm91bmRGZXRjaCh2KSA/IHYuX19zdGFsZVdoaWxlRmV0Y2hpbmcgOiB2OwogICAgICBpZiAodmFsdWUgPT09IHZvaWQgMCB8fCBrZXkgPT09IHZvaWQgMCkKICAgICAgICBjb250aW51ZTsKICAgICAgY29uc3QgZW50cnkyID0geyB2YWx1ZSB9OwogICAgICBpZiAodGhpcy4jdHRscyAmJiB0aGlzLiNzdGFydHMpIHsKICAgICAgICBlbnRyeTIudHRsID0gdGhpcy4jdHRsc1tpXTsKICAgICAgICBjb25zdCBhZ2UgPSBwZXJmLm5vdygpIC0gdGhpcy4jc3RhcnRzW2ldOwogICAgICAgIGVudHJ5Mi5zdGFydCA9IE1hdGguZmxvb3IoRGF0ZS5ub3coKSAtIGFnZSk7CiAgICAgIH0KICAgICAgaWYgKHRoaXMuI3NpemVzKSB7CiAgICAgICAgZW50cnkyLnNpemUgPSB0aGlzLiNzaXplc1tpXTsKICAgICAgfQogICAgICBhcnIudW5zaGlmdChba2V5LCBlbnRyeTJdKTsKICAgIH0KICAgIHJldHVybiBhcnI7CiAgfQogIC8qKgogICAqIFJlc2V0IHRoZSBjYWNoZSBhbmQgbG9hZCBpbiB0aGUgaXRlbXMgaW4gZW50cmllcyBpbiB0aGUgb3JkZXIgbGlzdGVkLgogICAqIE5vdGUgdGhhdCB0aGUgc2hhcGUgb2YgdGhlIHJlc3VsdGluZyBjYWNoZSBtYXkgYmUgZGlmZmVyZW50IGlmIHRoZQogICAqIHNhbWUgb3B0aW9ucyBhcmUgbm90IHVzZWQgaW4gYm90aCBjYWNoZXMuCiAgICovCiAgbG9hZChhcnIpIHsKICAgIHRoaXMuY2xlYXIoKTsKICAgIGZvciAoY29uc3QgW2tleSwgZW50cnkyXSBvZiBhcnIpIHsKICAgICAgaWYgKGVudHJ5Mi5zdGFydCkgewogICAgICAgIGNvbnN0IGFnZSA9IERhdGUubm93KCkgLSBlbnRyeTIuc3RhcnQ7CiAgICAgICAgZW50cnkyLnN0YXJ0ID0gcGVyZi5ub3coKSAtIGFnZTsKICAgICAgfQogICAgICB0aGlzLnNldChrZXksIGVudHJ5Mi52YWx1ZSwgZW50cnkyKTsKICAgIH0KICB9CiAgLyoqCiAgICogQWRkIGEgdmFsdWUgdG8gdGhlIGNhY2hlLgogICAqCiAgICogTm90ZTogaWYgYHVuZGVmaW5lZGAgaXMgc3BlY2lmaWVkIGFzIGEgdmFsdWUsIHRoaXMgaXMgYW4gYWxpYXMgZm9yCiAgICoge0BsaW5rIExSVUNhY2hlI2RlbGV0ZX0KICAgKi8KICBzZXQoaywgdiwgc2V0T3B0aW9ucyA9IHt9KSB7CiAgICBpZiAodiA9PT0gdm9pZCAwKSB7CiAgICAgIHRoaXMuZGVsZXRlKGspOwogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIGNvbnN0IHsgdHRsID0gdGhpcy50dGwsIHN0YXJ0LCBub0Rpc3Bvc2VPblNldCA9IHRoaXMubm9EaXNwb3NlT25TZXQsIHNpemVDYWxjdWxhdGlvbiA9IHRoaXMuc2l6ZUNhbGN1bGF0aW9uLCBzdGF0dXMgfSA9IHNldE9wdGlvbnM7CiAgICBsZXQgeyBub1VwZGF0ZVRUTCA9IHRoaXMubm9VcGRhdGVUVEwgfSA9IHNldE9wdGlvbnM7CiAgICBjb25zdCBzaXplID0gdGhpcy4jcmVxdWlyZVNpemUoaywgdiwgc2V0T3B0aW9ucy5zaXplIHx8IDAsIHNpemVDYWxjdWxhdGlvbik7CiAgICBpZiAodGhpcy5tYXhFbnRyeVNpemUgJiYgc2l6ZSA+IHRoaXMubWF4RW50cnlTaXplKSB7CiAgICAgIGlmIChzdGF0dXMpIHsKICAgICAgICBzdGF0dXMuc2V0ID0gIm1pc3MiOwogICAgICAgIHN0YXR1cy5tYXhFbnRyeVNpemVFeGNlZWRlZCA9IHRydWU7CiAgICAgIH0KICAgICAgdGhpcy5kZWxldGUoayk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgbGV0IGluZGV4ID0gdGhpcy4jc2l6ZSA9PT0gMCA/IHZvaWQgMCA6IHRoaXMuI2tleU1hcC5nZXQoayk7CiAgICBpZiAoaW5kZXggPT09IHZvaWQgMCkgewogICAgICBpbmRleCA9IHRoaXMuI3NpemUgPT09IDAgPyB0aGlzLiN0YWlsIDogdGhpcy4jZnJlZS5sZW5ndGggIT09IDAgPyB0aGlzLiNmcmVlLnBvcCgpIDogdGhpcy4jc2l6ZSA9PT0gdGhpcy4jbWF4ID8gdGhpcy4jZXZpY3QoZmFsc2UpIDogdGhpcy4jc2l6ZTsKICAgICAgdGhpcy4ja2V5TGlzdFtpbmRleF0gPSBrOwogICAgICB0aGlzLiN2YWxMaXN0W2luZGV4XSA9IHY7CiAgICAgIHRoaXMuI2tleU1hcC5zZXQoaywgaW5kZXgpOwogICAgICB0aGlzLiNuZXh0W3RoaXMuI3RhaWxdID0gaW5kZXg7CiAgICAgIHRoaXMuI3ByZXZbaW5kZXhdID0gdGhpcy4jdGFpbDsKICAgICAgdGhpcy4jdGFpbCA9IGluZGV4OwogICAgICB0aGlzLiNzaXplKys7CiAgICAgIHRoaXMuI2FkZEl0ZW1TaXplKGluZGV4LCBzaXplLCBzdGF0dXMpOwogICAgICBpZiAoc3RhdHVzKQogICAgICAgIHN0YXR1cy5zZXQgPSAiYWRkIjsKICAgICAgbm9VcGRhdGVUVEwgPSBmYWxzZTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuI21vdmVUb1RhaWwoaW5kZXgpOwogICAgICBjb25zdCBvbGRWYWwgPSB0aGlzLiN2YWxMaXN0W2luZGV4XTsKICAgICAgaWYgKHYgIT09IG9sZFZhbCkgewogICAgICAgIGlmICh0aGlzLiNoYXNGZXRjaE1ldGhvZCAmJiB0aGlzLiNpc0JhY2tncm91bmRGZXRjaChvbGRWYWwpKSB7CiAgICAgICAgICBvbGRWYWwuX19hYm9ydENvbnRyb2xsZXIuYWJvcnQobmV3IEVycm9yKCJyZXBsYWNlZCIpKTsKICAgICAgICAgIGNvbnN0IHsgX19zdGFsZVdoaWxlRmV0Y2hpbmc6IHMgfSA9IG9sZFZhbDsKICAgICAgICAgIGlmIChzICE9PSB2b2lkIDAgJiYgIW5vRGlzcG9zZU9uU2V0KSB7CiAgICAgICAgICAgIGlmICh0aGlzLiNoYXNEaXNwb3NlKSB7CiAgICAgICAgICAgICAgdGhpcy4jZGlzcG9zZT8uKHMsIGssICJzZXQiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy4jaGFzRGlzcG9zZUFmdGVyKSB7CiAgICAgICAgICAgICAgdGhpcy4jZGlzcG9zZWQ/LnB1c2goW3MsIGssICJzZXQiXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKCFub0Rpc3Bvc2VPblNldCkgewogICAgICAgICAgaWYgKHRoaXMuI2hhc0Rpc3Bvc2UpIHsKICAgICAgICAgICAgdGhpcy4jZGlzcG9zZT8uKG9sZFZhbCwgaywgInNldCIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHRoaXMuI2hhc0Rpc3Bvc2VBZnRlcikgewogICAgICAgICAgICB0aGlzLiNkaXNwb3NlZD8ucHVzaChbb2xkVmFsLCBrLCAic2V0Il0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0aGlzLiNyZW1vdmVJdGVtU2l6ZShpbmRleCk7CiAgICAgICAgdGhpcy4jYWRkSXRlbVNpemUoaW5kZXgsIHNpemUsIHN0YXR1cyk7CiAgICAgICAgdGhpcy4jdmFsTGlzdFtpbmRleF0gPSB2OwogICAgICAgIGlmIChzdGF0dXMpIHsKICAgICAgICAgIHN0YXR1cy5zZXQgPSAicmVwbGFjZSI7CiAgICAgICAgICBjb25zdCBvbGRWYWx1ZSA9IG9sZFZhbCAmJiB0aGlzLiNpc0JhY2tncm91bmRGZXRjaChvbGRWYWwpID8gb2xkVmFsLl9fc3RhbGVXaGlsZUZldGNoaW5nIDogb2xkVmFsOwogICAgICAgICAgaWYgKG9sZFZhbHVlICE9PSB2b2lkIDApCiAgICAgICAgICAgIHN0YXR1cy5vbGRWYWx1ZSA9IG9sZFZhbHVlOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChzdGF0dXMpIHsKICAgICAgICBzdGF0dXMuc2V0ID0gInVwZGF0ZSI7CiAgICAgIH0KICAgIH0KICAgIGlmICh0dGwgIT09IDAgJiYgIXRoaXMuI3R0bHMpIHsKICAgICAgdGhpcy4jaW5pdGlhbGl6ZVRUTFRyYWNraW5nKCk7CiAgICB9CiAgICBpZiAodGhpcy4jdHRscykgewogICAgICBpZiAoIW5vVXBkYXRlVFRMKSB7CiAgICAgICAgdGhpcy4jc2V0SXRlbVRUTChpbmRleCwgdHRsLCBzdGFydCk7CiAgICAgIH0KICAgICAgaWYgKHN0YXR1cykKICAgICAgICB0aGlzLiNzdGF0dXNUVEwoc3RhdHVzLCBpbmRleCk7CiAgICB9CiAgICBpZiAoIW5vRGlzcG9zZU9uU2V0ICYmIHRoaXMuI2hhc0Rpc3Bvc2VBZnRlciAmJiB0aGlzLiNkaXNwb3NlZCkgewogICAgICBjb25zdCBkdCA9IHRoaXMuI2Rpc3Bvc2VkOwogICAgICBsZXQgdGFzazsKICAgICAgd2hpbGUgKHRhc2sgPSBkdD8uc2hpZnQoKSkgewogICAgICAgIHRoaXMuI2Rpc3Bvc2VBZnRlcj8uKC4uLnRhc2spOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgICogRXZpY3QgdGhlIGxlYXN0IHJlY2VudGx5IHVzZWQgaXRlbSwgcmV0dXJuaW5nIGl0cyB2YWx1ZSBvcgogICAqIGB1bmRlZmluZWRgIGlmIGNhY2hlIGlzIGVtcHR5LgogICAqLwogIHBvcCgpIHsKICAgIHRyeSB7CiAgICAgIHdoaWxlICh0aGlzLiNzaXplKSB7CiAgICAgICAgY29uc3QgdmFsID0gdGhpcy4jdmFsTGlzdFt0aGlzLiNoZWFkXTsKICAgICAgICB0aGlzLiNldmljdCh0cnVlKTsKICAgICAgICBpZiAodGhpcy4jaXNCYWNrZ3JvdW5kRmV0Y2godmFsKSkgewogICAgICAgICAgaWYgKHZhbC5fX3N0YWxlV2hpbGVGZXRjaGluZykgewogICAgICAgICAgICByZXR1cm4gdmFsLl9fc3RhbGVXaGlsZUZldGNoaW5nOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAodmFsICE9PSB2b2lkIDApIHsKICAgICAgICAgIHJldHVybiB2YWw7CiAgICAgICAgfQogICAgICB9CiAgICB9IGZpbmFsbHkgewogICAgICBpZiAodGhpcy4jaGFzRGlzcG9zZUFmdGVyICYmIHRoaXMuI2Rpc3Bvc2VkKSB7CiAgICAgICAgY29uc3QgZHQgPSB0aGlzLiNkaXNwb3NlZDsKICAgICAgICBsZXQgdGFzazsKICAgICAgICB3aGlsZSAodGFzayA9IGR0Py5zaGlmdCgpKSB7CiAgICAgICAgICB0aGlzLiNkaXNwb3NlQWZ0ZXI/LiguLi50YXNrKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CiAgI2V2aWN0KGZyZWUpIHsKICAgIGNvbnN0IGhlYWQgPSB0aGlzLiNoZWFkOwogICAgY29uc3QgayA9IHRoaXMuI2tleUxpc3RbaGVhZF07CiAgICBjb25zdCB2ID0gdGhpcy4jdmFsTGlzdFtoZWFkXTsKICAgIGlmICh0aGlzLiNoYXNGZXRjaE1ldGhvZCAmJiB0aGlzLiNpc0JhY2tncm91bmRGZXRjaCh2KSkgewogICAgICB2Ll9fYWJvcnRDb250cm9sbGVyLmFib3J0KG5ldyBFcnJvcigiZXZpY3RlZCIpKTsKICAgIH0gZWxzZSBpZiAodGhpcy4jaGFzRGlzcG9zZSB8fCB0aGlzLiNoYXNEaXNwb3NlQWZ0ZXIpIHsKICAgICAgaWYgKHRoaXMuI2hhc0Rpc3Bvc2UpIHsKICAgICAgICB0aGlzLiNkaXNwb3NlPy4odiwgaywgImV2aWN0Iik7CiAgICAgIH0KICAgICAgaWYgKHRoaXMuI2hhc0Rpc3Bvc2VBZnRlcikgewogICAgICAgIHRoaXMuI2Rpc3Bvc2VkPy5wdXNoKFt2LCBrLCAiZXZpY3QiXSk7CiAgICAgIH0KICAgIH0KICAgIHRoaXMuI3JlbW92ZUl0ZW1TaXplKGhlYWQpOwogICAgaWYgKGZyZWUpIHsKICAgICAgdGhpcy4ja2V5TGlzdFtoZWFkXSA9IHZvaWQgMDsKICAgICAgdGhpcy4jdmFsTGlzdFtoZWFkXSA9IHZvaWQgMDsKICAgICAgdGhpcy4jZnJlZS5wdXNoKGhlYWQpOwogICAgfQogICAgaWYgKHRoaXMuI3NpemUgPT09IDEpIHsKICAgICAgdGhpcy4jaGVhZCA9IHRoaXMuI3RhaWwgPSAwOwogICAgICB0aGlzLiNmcmVlLmxlbmd0aCA9IDA7CiAgICB9IGVsc2UgewogICAgICB0aGlzLiNoZWFkID0gdGhpcy4jbmV4dFtoZWFkXTsKICAgIH0KICAgIHRoaXMuI2tleU1hcC5kZWxldGUoayk7CiAgICB0aGlzLiNzaXplLS07CiAgICByZXR1cm4gaGVhZDsKICB9CiAgLyoqCiAgICogQ2hlY2sgaWYgYSBrZXkgaXMgaW4gdGhlIGNhY2hlLCB3aXRob3V0IHVwZGF0aW5nIHRoZSByZWNlbmN5IG9mIHVzZS4KICAgKiBXaWxsIHJldHVybiBmYWxzZSBpZiB0aGUgaXRlbSBpcyBzdGFsZSwgZXZlbiB0aG91Z2ggaXQgaXMgdGVjaG5pY2FsbHkKICAgKiBpbiB0aGUgY2FjaGUuCiAgICoKICAgKiBXaWxsIG5vdCB1cGRhdGUgaXRlbSBhZ2UgdW5sZXNzCiAgICoge0BsaW5rIExSVUNhY2hlLk9wdGlvbnNCYXNlLnVwZGF0ZUFnZU9uSGFzfSBpcyBzZXQuCiAgICovCiAgaGFzKGssIGhhc09wdGlvbnMgPSB7fSkgewogICAgY29uc3QgeyB1cGRhdGVBZ2VPbkhhcyA9IHRoaXMudXBkYXRlQWdlT25IYXMsIHN0YXR1cyB9ID0gaGFzT3B0aW9uczsKICAgIGNvbnN0IGluZGV4ID0gdGhpcy4ja2V5TWFwLmdldChrKTsKICAgIGlmIChpbmRleCAhPT0gdm9pZCAwKSB7CiAgICAgIGNvbnN0IHYgPSB0aGlzLiN2YWxMaXN0W2luZGV4XTsKICAgICAgaWYgKHRoaXMuI2lzQmFja2dyb3VuZEZldGNoKHYpICYmIHYuX19zdGFsZVdoaWxlRmV0Y2hpbmcgPT09IHZvaWQgMCkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBpZiAoIXRoaXMuI2lzU3RhbGUoaW5kZXgpKSB7CiAgICAgICAgaWYgKHVwZGF0ZUFnZU9uSGFzKSB7CiAgICAgICAgICB0aGlzLiN1cGRhdGVJdGVtQWdlKGluZGV4KTsKICAgICAgICB9CiAgICAgICAgaWYgKHN0YXR1cykgewogICAgICAgICAgc3RhdHVzLmhhcyA9ICJoaXQiOwogICAgICAgICAgdGhpcy4jc3RhdHVzVFRMKHN0YXR1cywgaW5kZXgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSBlbHNlIGlmIChzdGF0dXMpIHsKICAgICAgICBzdGF0dXMuaGFzID0gInN0YWxlIjsKICAgICAgICB0aGlzLiNzdGF0dXNUVEwoc3RhdHVzLCBpbmRleCk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoc3RhdHVzKSB7CiAgICAgIHN0YXR1cy5oYXMgPSAibWlzcyI7CiAgICB9CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIC8qKgogICAqIExpa2Uge0BsaW5rIExSVUNhY2hlI2dldH0gYnV0IGRvZXNuJ3QgdXBkYXRlIHJlY2VuY3kgb3IgZGVsZXRlIHN0YWxlCiAgICogaXRlbXMuCiAgICoKICAgKiBSZXR1cm5zIGB1bmRlZmluZWRgIGlmIHRoZSBpdGVtIGlzIHN0YWxlLCB1bmxlc3MKICAgKiB7QGxpbmsgTFJVQ2FjaGUuT3B0aW9uc0Jhc2UuYWxsb3dTdGFsZX0gaXMgc2V0LgogICAqLwogIHBlZWsoaywgcGVla09wdGlvbnMgPSB7fSkgewogICAgY29uc3QgeyBhbGxvd1N0YWxlID0gdGhpcy5hbGxvd1N0YWxlIH0gPSBwZWVrT3B0aW9uczsKICAgIGNvbnN0IGluZGV4ID0gdGhpcy4ja2V5TWFwLmdldChrKTsKICAgIGlmIChpbmRleCAhPT0gdm9pZCAwICYmIChhbGxvd1N0YWxlIHx8ICF0aGlzLiNpc1N0YWxlKGluZGV4KSkpIHsKICAgICAgY29uc3QgdiA9IHRoaXMuI3ZhbExpc3RbaW5kZXhdOwogICAgICByZXR1cm4gdGhpcy4jaXNCYWNrZ3JvdW5kRmV0Y2godikgPyB2Ll9fc3RhbGVXaGlsZUZldGNoaW5nIDogdjsKICAgIH0KICB9CiAgI2JhY2tncm91bmRGZXRjaChrLCBpbmRleCwgb3B0aW9ucywgY29udGV4dCkgewogICAgY29uc3QgdiA9IGluZGV4ID09PSB2b2lkIDAgPyB2b2lkIDAgOiB0aGlzLiN2YWxMaXN0W2luZGV4XTsKICAgIGlmICh0aGlzLiNpc0JhY2tncm91bmRGZXRjaCh2KSkgewogICAgICByZXR1cm4gdjsKICAgIH0KICAgIGNvbnN0IGFjID0gbmV3IEFDKCk7CiAgICBjb25zdCB7IHNpZ25hbCB9ID0gb3B0aW9uczsKICAgIHNpZ25hbD8uYWRkRXZlbnRMaXN0ZW5lcigiYWJvcnQiLCAoKSA9PiBhYy5hYm9ydChzaWduYWwucmVhc29uKSwgewogICAgICBzaWduYWw6IGFjLnNpZ25hbAogICAgfSk7CiAgICBjb25zdCBmZXRjaE9wdHMgPSB7CiAgICAgIHNpZ25hbDogYWMuc2lnbmFsLAogICAgICBvcHRpb25zLAogICAgICBjb250ZXh0CiAgICB9OwogICAgY29uc3QgY2IgPSAodjIsIHVwZGF0ZUNhY2hlID0gZmFsc2UpID0+IHsKICAgICAgY29uc3QgeyBhYm9ydGVkIH0gPSBhYy5zaWduYWw7CiAgICAgIGNvbnN0IGlnbm9yZUFib3J0ID0gb3B0aW9ucy5pZ25vcmVGZXRjaEFib3J0ICYmIHYyICE9PSB2b2lkIDA7CiAgICAgIGlmIChvcHRpb25zLnN0YXR1cykgewogICAgICAgIGlmIChhYm9ydGVkICYmICF1cGRhdGVDYWNoZSkgewogICAgICAgICAgb3B0aW9ucy5zdGF0dXMuZmV0Y2hBYm9ydGVkID0gdHJ1ZTsKICAgICAgICAgIG9wdGlvbnMuc3RhdHVzLmZldGNoRXJyb3IgPSBhYy5zaWduYWwucmVhc29uOwogICAgICAgICAgaWYgKGlnbm9yZUFib3J0KQogICAgICAgICAgICBvcHRpb25zLnN0YXR1cy5mZXRjaEFib3J0SWdub3JlZCA9IHRydWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG9wdGlvbnMuc3RhdHVzLmZldGNoUmVzb2x2ZWQgPSB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoYWJvcnRlZCAmJiAhaWdub3JlQWJvcnQgJiYgIXVwZGF0ZUNhY2hlKSB7CiAgICAgICAgcmV0dXJuIGZldGNoRmFpbChhYy5zaWduYWwucmVhc29uKTsKICAgICAgfQogICAgICBjb25zdCBiZjIgPSBwOwogICAgICBpZiAodGhpcy4jdmFsTGlzdFtpbmRleF0gPT09IHApIHsKICAgICAgICBpZiAodjIgPT09IHZvaWQgMCkgewogICAgICAgICAgaWYgKGJmMi5fX3N0YWxlV2hpbGVGZXRjaGluZykgewogICAgICAgICAgICB0aGlzLiN2YWxMaXN0W2luZGV4XSA9IGJmMi5fX3N0YWxlV2hpbGVGZXRjaGluZzsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuZGVsZXRlKGspOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAob3B0aW9ucy5zdGF0dXMpCiAgICAgICAgICAgIG9wdGlvbnMuc3RhdHVzLmZldGNoVXBkYXRlZCA9IHRydWU7CiAgICAgICAgICB0aGlzLnNldChrLCB2MiwgZmV0Y2hPcHRzLm9wdGlvbnMpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdjI7CiAgICB9OwogICAgY29uc3QgZWIgPSAoZXIpID0+IHsKICAgICAgaWYgKG9wdGlvbnMuc3RhdHVzKSB7CiAgICAgICAgb3B0aW9ucy5zdGF0dXMuZmV0Y2hSZWplY3RlZCA9IHRydWU7CiAgICAgICAgb3B0aW9ucy5zdGF0dXMuZmV0Y2hFcnJvciA9IGVyOwogICAgICB9CiAgICAgIHJldHVybiBmZXRjaEZhaWwoZXIpOwogICAgfTsKICAgIGNvbnN0IGZldGNoRmFpbCA9IChlcikgPT4gewogICAgICBjb25zdCB7IGFib3J0ZWQgfSA9IGFjLnNpZ25hbDsKICAgICAgY29uc3QgYWxsb3dTdGFsZUFib3J0ZWQgPSBhYm9ydGVkICYmIG9wdGlvbnMuYWxsb3dTdGFsZU9uRmV0Y2hBYm9ydDsKICAgICAgY29uc3QgYWxsb3dTdGFsZSA9IGFsbG93U3RhbGVBYm9ydGVkIHx8IG9wdGlvbnMuYWxsb3dTdGFsZU9uRmV0Y2hSZWplY3Rpb247CiAgICAgIGNvbnN0IG5vRGVsZXRlID0gYWxsb3dTdGFsZSB8fCBvcHRpb25zLm5vRGVsZXRlT25GZXRjaFJlamVjdGlvbjsKICAgICAgY29uc3QgYmYyID0gcDsKICAgICAgaWYgKHRoaXMuI3ZhbExpc3RbaW5kZXhdID09PSBwKSB7CiAgICAgICAgY29uc3QgZGVsID0gIW5vRGVsZXRlIHx8IGJmMi5fX3N0YWxlV2hpbGVGZXRjaGluZyA9PT0gdm9pZCAwOwogICAgICAgIGlmIChkZWwpIHsKICAgICAgICAgIHRoaXMuZGVsZXRlKGspOwogICAgICAgIH0gZWxzZSBpZiAoIWFsbG93U3RhbGVBYm9ydGVkKSB7CiAgICAgICAgICB0aGlzLiN2YWxMaXN0W2luZGV4XSA9IGJmMi5fX3N0YWxlV2hpbGVGZXRjaGluZzsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKGFsbG93U3RhbGUpIHsKICAgICAgICBpZiAob3B0aW9ucy5zdGF0dXMgJiYgYmYyLl9fc3RhbGVXaGlsZUZldGNoaW5nICE9PSB2b2lkIDApIHsKICAgICAgICAgIG9wdGlvbnMuc3RhdHVzLnJldHVybmVkU3RhbGUgPSB0cnVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYmYyLl9fc3RhbGVXaGlsZUZldGNoaW5nOwogICAgICB9IGVsc2UgaWYgKGJmMi5fX3JldHVybmVkID09PSBiZjIpIHsKICAgICAgICB0aHJvdyBlcjsKICAgICAgfQogICAgfTsKICAgIGNvbnN0IHBjYWxsID0gKHJlcywgcmVqKSA9PiB7CiAgICAgIGNvbnN0IGZtcCA9IHRoaXMuI2ZldGNoTWV0aG9kPy4oaywgdiwgZmV0Y2hPcHRzKTsKICAgICAgaWYgKGZtcCAmJiBmbXAgaW5zdGFuY2VvZiBQcm9taXNlKSB7CiAgICAgICAgZm1wLnRoZW4oKHYyKSA9PiByZXModjIgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHYyKSwgcmVqKTsKICAgICAgfQogICAgICBhYy5zaWduYWwuYWRkRXZlbnRMaXN0ZW5lcigiYWJvcnQiLCAoKSA9PiB7CiAgICAgICAgaWYgKCFvcHRpb25zLmlnbm9yZUZldGNoQWJvcnQgfHwgb3B0aW9ucy5hbGxvd1N0YWxlT25GZXRjaEFib3J0KSB7CiAgICAgICAgICByZXModm9pZCAwKTsKICAgICAgICAgIGlmIChvcHRpb25zLmFsbG93U3RhbGVPbkZldGNoQWJvcnQpIHsKICAgICAgICAgICAgcmVzID0gKHYyKSA9PiBjYih2MiwgdHJ1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgIH07CiAgICBpZiAob3B0aW9ucy5zdGF0dXMpCiAgICAgIG9wdGlvbnMuc3RhdHVzLmZldGNoRGlzcGF0Y2hlZCA9IHRydWU7CiAgICBjb25zdCBwID0gbmV3IFByb21pc2UocGNhbGwpLnRoZW4oY2IsIGViKTsKICAgIGNvbnN0IGJmID0gT2JqZWN0LmFzc2lnbihwLCB7CiAgICAgIF9fYWJvcnRDb250cm9sbGVyOiBhYywKICAgICAgX19zdGFsZVdoaWxlRmV0Y2hpbmc6IHYsCiAgICAgIF9fcmV0dXJuZWQ6IHZvaWQgMAogICAgfSk7CiAgICBpZiAoaW5kZXggPT09IHZvaWQgMCkgewogICAgICB0aGlzLnNldChrLCBiZiwgeyAuLi5mZXRjaE9wdHMub3B0aW9ucywgc3RhdHVzOiB2b2lkIDAgfSk7CiAgICAgIGluZGV4ID0gdGhpcy4ja2V5TWFwLmdldChrKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuI3ZhbExpc3RbaW5kZXhdID0gYmY7CiAgICB9CiAgICByZXR1cm4gYmY7CiAgfQogICNpc0JhY2tncm91bmRGZXRjaChwKSB7CiAgICBpZiAoIXRoaXMuI2hhc0ZldGNoTWV0aG9kKQogICAgICByZXR1cm4gZmFsc2U7CiAgICBjb25zdCBiID0gcDsKICAgIHJldHVybiAhIWIgJiYgYiBpbnN0YW5jZW9mIFByb21pc2UgJiYgYi5oYXNPd25Qcm9wZXJ0eSgiX19zdGFsZVdoaWxlRmV0Y2hpbmciKSAmJiBiLl9fYWJvcnRDb250cm9sbGVyIGluc3RhbmNlb2YgQUM7CiAgfQogIGFzeW5jIGZldGNoKGssIGZldGNoT3B0aW9ucyA9IHt9KSB7CiAgICBjb25zdCB7CiAgICAgIC8vIGdldCBvcHRpb25zCiAgICAgIGFsbG93U3RhbGUgPSB0aGlzLmFsbG93U3RhbGUsCiAgICAgIHVwZGF0ZUFnZU9uR2V0ID0gdGhpcy51cGRhdGVBZ2VPbkdldCwKICAgICAgbm9EZWxldGVPblN0YWxlR2V0ID0gdGhpcy5ub0RlbGV0ZU9uU3RhbGVHZXQsCiAgICAgIC8vIHNldCBvcHRpb25zCiAgICAgIHR0bCA9IHRoaXMudHRsLAogICAgICBub0Rpc3Bvc2VPblNldCA9IHRoaXMubm9EaXNwb3NlT25TZXQsCiAgICAgIHNpemUgPSAwLAogICAgICBzaXplQ2FsY3VsYXRpb24gPSB0aGlzLnNpemVDYWxjdWxhdGlvbiwKICAgICAgbm9VcGRhdGVUVEwgPSB0aGlzLm5vVXBkYXRlVFRMLAogICAgICAvLyBmZXRjaCBleGNsdXNpdmUgb3B0aW9ucwogICAgICBub0RlbGV0ZU9uRmV0Y2hSZWplY3Rpb24gPSB0aGlzLm5vRGVsZXRlT25GZXRjaFJlamVjdGlvbiwKICAgICAgYWxsb3dTdGFsZU9uRmV0Y2hSZWplY3Rpb24gPSB0aGlzLmFsbG93U3RhbGVPbkZldGNoUmVqZWN0aW9uLAogICAgICBpZ25vcmVGZXRjaEFib3J0ID0gdGhpcy5pZ25vcmVGZXRjaEFib3J0LAogICAgICBhbGxvd1N0YWxlT25GZXRjaEFib3J0ID0gdGhpcy5hbGxvd1N0YWxlT25GZXRjaEFib3J0LAogICAgICBjb250ZXh0LAogICAgICBmb3JjZVJlZnJlc2ggPSBmYWxzZSwKICAgICAgc3RhdHVzLAogICAgICBzaWduYWwKICAgIH0gPSBmZXRjaE9wdGlvbnM7CiAgICBpZiAoIXRoaXMuI2hhc0ZldGNoTWV0aG9kKSB7CiAgICAgIGlmIChzdGF0dXMpCiAgICAgICAgc3RhdHVzLmZldGNoID0gImdldCI7CiAgICAgIHJldHVybiB0aGlzLmdldChrLCB7CiAgICAgICAgYWxsb3dTdGFsZSwKICAgICAgICB1cGRhdGVBZ2VPbkdldCwKICAgICAgICBub0RlbGV0ZU9uU3RhbGVHZXQsCiAgICAgICAgc3RhdHVzCiAgICAgIH0pOwogICAgfQogICAgY29uc3Qgb3B0aW9ucyA9IHsKICAgICAgYWxsb3dTdGFsZSwKICAgICAgdXBkYXRlQWdlT25HZXQsCiAgICAgIG5vRGVsZXRlT25TdGFsZUdldCwKICAgICAgdHRsLAogICAgICBub0Rpc3Bvc2VPblNldCwKICAgICAgc2l6ZSwKICAgICAgc2l6ZUNhbGN1bGF0aW9uLAogICAgICBub1VwZGF0ZVRUTCwKICAgICAgbm9EZWxldGVPbkZldGNoUmVqZWN0aW9uLAogICAgICBhbGxvd1N0YWxlT25GZXRjaFJlamVjdGlvbiwKICAgICAgYWxsb3dTdGFsZU9uRmV0Y2hBYm9ydCwKICAgICAgaWdub3JlRmV0Y2hBYm9ydCwKICAgICAgc3RhdHVzLAogICAgICBzaWduYWwKICAgIH07CiAgICBsZXQgaW5kZXggPSB0aGlzLiNrZXlNYXAuZ2V0KGspOwogICAgaWYgKGluZGV4ID09PSB2b2lkIDApIHsKICAgICAgaWYgKHN0YXR1cykKICAgICAgICBzdGF0dXMuZmV0Y2ggPSAibWlzcyI7CiAgICAgIGNvbnN0IHAgPSB0aGlzLiNiYWNrZ3JvdW5kRmV0Y2goaywgaW5kZXgsIG9wdGlvbnMsIGNvbnRleHQpOwogICAgICByZXR1cm4gcC5fX3JldHVybmVkID0gcDsKICAgIH0gZWxzZSB7CiAgICAgIGNvbnN0IHYgPSB0aGlzLiN2YWxMaXN0W2luZGV4XTsKICAgICAgaWYgKHRoaXMuI2lzQmFja2dyb3VuZEZldGNoKHYpKSB7CiAgICAgICAgY29uc3Qgc3RhbGUgPSBhbGxvd1N0YWxlICYmIHYuX19zdGFsZVdoaWxlRmV0Y2hpbmcgIT09IHZvaWQgMDsKICAgICAgICBpZiAoc3RhdHVzKSB7CiAgICAgICAgICBzdGF0dXMuZmV0Y2ggPSAiaW5mbGlnaHQiOwogICAgICAgICAgaWYgKHN0YWxlKQogICAgICAgICAgICBzdGF0dXMucmV0dXJuZWRTdGFsZSA9IHRydWU7CiAgICAgICAgfQogICAgICAgIHJldHVybiBzdGFsZSA/IHYuX19zdGFsZVdoaWxlRmV0Y2hpbmcgOiB2Ll9fcmV0dXJuZWQgPSB2OwogICAgICB9CiAgICAgIGNvbnN0IGlzU3RhbGUgPSB0aGlzLiNpc1N0YWxlKGluZGV4KTsKICAgICAgaWYgKCFmb3JjZVJlZnJlc2ggJiYgIWlzU3RhbGUpIHsKICAgICAgICBpZiAoc3RhdHVzKQogICAgICAgICAgc3RhdHVzLmZldGNoID0gImhpdCI7CiAgICAgICAgdGhpcy4jbW92ZVRvVGFpbChpbmRleCk7CiAgICAgICAgaWYgKHVwZGF0ZUFnZU9uR2V0KSB7CiAgICAgICAgICB0aGlzLiN1cGRhdGVJdGVtQWdlKGluZGV4KTsKICAgICAgICB9CiAgICAgICAgaWYgKHN0YXR1cykKICAgICAgICAgIHRoaXMuI3N0YXR1c1RUTChzdGF0dXMsIGluZGV4KTsKICAgICAgICByZXR1cm4gdjsKICAgICAgfQogICAgICBjb25zdCBwID0gdGhpcy4jYmFja2dyb3VuZEZldGNoKGssIGluZGV4LCBvcHRpb25zLCBjb250ZXh0KTsKICAgICAgY29uc3QgaGFzU3RhbGUgPSBwLl9fc3RhbGVXaGlsZUZldGNoaW5nICE9PSB2b2lkIDA7CiAgICAgIGNvbnN0IHN0YWxlVmFsID0gaGFzU3RhbGUgJiYgYWxsb3dTdGFsZTsKICAgICAgaWYgKHN0YXR1cykgewogICAgICAgIHN0YXR1cy5mZXRjaCA9IGlzU3RhbGUgPyAic3RhbGUiIDogInJlZnJlc2giOwogICAgICAgIGlmIChzdGFsZVZhbCAmJiBpc1N0YWxlKQogICAgICAgICAgc3RhdHVzLnJldHVybmVkU3RhbGUgPSB0cnVlOwogICAgICB9CiAgICAgIHJldHVybiBzdGFsZVZhbCA/IHAuX19zdGFsZVdoaWxlRmV0Y2hpbmcgOiBwLl9fcmV0dXJuZWQgPSBwOwogICAgfQogIH0KICAvKioKICAgKiBSZXR1cm4gYSB2YWx1ZSBmcm9tIHRoZSBjYWNoZS4gV2lsbCB1cGRhdGUgdGhlIHJlY2VuY3kgb2YgdGhlIGNhY2hlCiAgICogZW50cnkgZm91bmQuCiAgICoKICAgKiBJZiB0aGUga2V5IGlzIG5vdCBmb3VuZCwgZ2V0KCkgd2lsbCByZXR1cm4gYHVuZGVmaW5lZGAuCiAgICovCiAgZ2V0KGssIGdldE9wdGlvbnMgPSB7fSkgewogICAgY29uc3QgeyBhbGxvd1N0YWxlID0gdGhpcy5hbGxvd1N0YWxlLCB1cGRhdGVBZ2VPbkdldCA9IHRoaXMudXBkYXRlQWdlT25HZXQsIG5vRGVsZXRlT25TdGFsZUdldCA9IHRoaXMubm9EZWxldGVPblN0YWxlR2V0LCBzdGF0dXMgfSA9IGdldE9wdGlvbnM7CiAgICBjb25zdCBpbmRleCA9IHRoaXMuI2tleU1hcC5nZXQoayk7CiAgICBpZiAoaW5kZXggIT09IHZvaWQgMCkgewogICAgICBjb25zdCB2YWx1ZSA9IHRoaXMuI3ZhbExpc3RbaW5kZXhdOwogICAgICBjb25zdCBmZXRjaGluZyA9IHRoaXMuI2lzQmFja2dyb3VuZEZldGNoKHZhbHVlKTsKICAgICAgaWYgKHN0YXR1cykKICAgICAgICB0aGlzLiNzdGF0dXNUVEwoc3RhdHVzLCBpbmRleCk7CiAgICAgIGlmICh0aGlzLiNpc1N0YWxlKGluZGV4KSkgewogICAgICAgIGlmIChzdGF0dXMpCiAgICAgICAgICBzdGF0dXMuZ2V0ID0gInN0YWxlIjsKICAgICAgICBpZiAoIWZldGNoaW5nKSB7CiAgICAgICAgICBpZiAoIW5vRGVsZXRlT25TdGFsZUdldCkgewogICAgICAgICAgICB0aGlzLmRlbGV0ZShrKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChzdGF0dXMgJiYgYWxsb3dTdGFsZSkKICAgICAgICAgICAgc3RhdHVzLnJldHVybmVkU3RhbGUgPSB0cnVlOwogICAgICAgICAgcmV0dXJuIGFsbG93U3RhbGUgPyB2YWx1ZSA6IHZvaWQgMDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKHN0YXR1cyAmJiBhbGxvd1N0YWxlICYmIHZhbHVlLl9fc3RhbGVXaGlsZUZldGNoaW5nICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgc3RhdHVzLnJldHVybmVkU3RhbGUgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGFsbG93U3RhbGUgPyB2YWx1ZS5fX3N0YWxlV2hpbGVGZXRjaGluZyA6IHZvaWQgMDsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKHN0YXR1cykKICAgICAgICAgIHN0YXR1cy5nZXQgPSAiaGl0IjsKICAgICAgICBpZiAoZmV0Y2hpbmcpIHsKICAgICAgICAgIHJldHVybiB2YWx1ZS5fX3N0YWxlV2hpbGVGZXRjaGluZzsKICAgICAgICB9CiAgICAgICAgdGhpcy4jbW92ZVRvVGFpbChpbmRleCk7CiAgICAgICAgaWYgKHVwZGF0ZUFnZU9uR2V0KSB7CiAgICAgICAgICB0aGlzLiN1cGRhdGVJdGVtQWdlKGluZGV4KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICB9CiAgICB9IGVsc2UgaWYgKHN0YXR1cykgewogICAgICBzdGF0dXMuZ2V0ID0gIm1pc3MiOwogICAgfQogIH0KICAjY29ubmVjdChwLCBuKSB7CiAgICB0aGlzLiNwcmV2W25dID0gcDsKICAgIHRoaXMuI25leHRbcF0gPSBuOwogIH0KICAjbW92ZVRvVGFpbChpbmRleCkgewogICAgaWYgKGluZGV4ICE9PSB0aGlzLiN0YWlsKSB7CiAgICAgIGlmIChpbmRleCA9PT0gdGhpcy4jaGVhZCkgewogICAgICAgIHRoaXMuI2hlYWQgPSB0aGlzLiNuZXh0W2luZGV4XTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLiNjb25uZWN0KHRoaXMuI3ByZXZbaW5kZXhdLCB0aGlzLiNuZXh0W2luZGV4XSk7CiAgICAgIH0KICAgICAgdGhpcy4jY29ubmVjdCh0aGlzLiN0YWlsLCBpbmRleCk7CiAgICAgIHRoaXMuI3RhaWwgPSBpbmRleDsKICAgIH0KICB9CiAgLyoqCiAgICogRGVsZXRlcyBhIGtleSBvdXQgb2YgdGhlIGNhY2hlLgogICAqIFJldHVybnMgdHJ1ZSBpZiB0aGUga2V5IHdhcyBkZWxldGVkLCBmYWxzZSBvdGhlcndpc2UuCiAgICovCiAgZGVsZXRlKGspIHsKICAgIGxldCBkZWxldGVkID0gZmFsc2U7CiAgICBpZiAodGhpcy4jc2l6ZSAhPT0gMCkgewogICAgICBjb25zdCBpbmRleCA9IHRoaXMuI2tleU1hcC5nZXQoayk7CiAgICAgIGlmIChpbmRleCAhPT0gdm9pZCAwKSB7CiAgICAgICAgZGVsZXRlZCA9IHRydWU7CiAgICAgICAgaWYgKHRoaXMuI3NpemUgPT09IDEpIHsKICAgICAgICAgIHRoaXMuY2xlYXIoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy4jcmVtb3ZlSXRlbVNpemUoaW5kZXgpOwogICAgICAgICAgY29uc3QgdiA9IHRoaXMuI3ZhbExpc3RbaW5kZXhdOwogICAgICAgICAgaWYgKHRoaXMuI2lzQmFja2dyb3VuZEZldGNoKHYpKSB7CiAgICAgICAgICAgIHYuX19hYm9ydENvbnRyb2xsZXIuYWJvcnQobmV3IEVycm9yKCJkZWxldGVkIikpOwogICAgICAgICAgfSBlbHNlIGlmICh0aGlzLiNoYXNEaXNwb3NlIHx8IHRoaXMuI2hhc0Rpc3Bvc2VBZnRlcikgewogICAgICAgICAgICBpZiAodGhpcy4jaGFzRGlzcG9zZSkgewogICAgICAgICAgICAgIHRoaXMuI2Rpc3Bvc2U/Lih2LCBrLCAiZGVsZXRlIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMuI2hhc0Rpc3Bvc2VBZnRlcikgewogICAgICAgICAgICAgIHRoaXMuI2Rpc3Bvc2VkPy5wdXNoKFt2LCBrLCAiZGVsZXRlIl0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLiNrZXlNYXAuZGVsZXRlKGspOwogICAgICAgICAgdGhpcy4ja2V5TGlzdFtpbmRleF0gPSB2b2lkIDA7CiAgICAgICAgICB0aGlzLiN2YWxMaXN0W2luZGV4XSA9IHZvaWQgMDsKICAgICAgICAgIGlmIChpbmRleCA9PT0gdGhpcy4jdGFpbCkgewogICAgICAgICAgICB0aGlzLiN0YWlsID0gdGhpcy4jcHJldltpbmRleF07CiAgICAgICAgICB9IGVsc2UgaWYgKGluZGV4ID09PSB0aGlzLiNoZWFkKSB7CiAgICAgICAgICAgIHRoaXMuI2hlYWQgPSB0aGlzLiNuZXh0W2luZGV4XTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuI25leHRbdGhpcy4jcHJldltpbmRleF1dID0gdGhpcy4jbmV4dFtpbmRleF07CiAgICAgICAgICAgIHRoaXMuI3ByZXZbdGhpcy4jbmV4dFtpbmRleF1dID0gdGhpcy4jcHJldltpbmRleF07CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLiNzaXplLS07CiAgICAgICAgICB0aGlzLiNmcmVlLnB1c2goaW5kZXgpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgaWYgKHRoaXMuI2hhc0Rpc3Bvc2VBZnRlciAmJiB0aGlzLiNkaXNwb3NlZD8ubGVuZ3RoKSB7CiAgICAgIGNvbnN0IGR0ID0gdGhpcy4jZGlzcG9zZWQ7CiAgICAgIGxldCB0YXNrOwogICAgICB3aGlsZSAodGFzayA9IGR0Py5zaGlmdCgpKSB7CiAgICAgICAgdGhpcy4jZGlzcG9zZUFmdGVyPy4oLi4udGFzayk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBkZWxldGVkOwogIH0KICAvKioKICAgKiBDbGVhciB0aGUgY2FjaGUgZW50aXJlbHksIHRocm93aW5nIGF3YXkgYWxsIHZhbHVlcy4KICAgKi8KICBjbGVhcigpIHsKICAgIGZvciAoY29uc3QgaW5kZXggb2YgdGhpcy4jcmluZGV4ZXMoeyBhbGxvd1N0YWxlOiB0cnVlIH0pKSB7CiAgICAgIGNvbnN0IHYgPSB0aGlzLiN2YWxMaXN0W2luZGV4XTsKICAgICAgaWYgKHRoaXMuI2lzQmFja2dyb3VuZEZldGNoKHYpKSB7CiAgICAgICAgdi5fX2Fib3J0Q29udHJvbGxlci5hYm9ydChuZXcgRXJyb3IoImRlbGV0ZWQiKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3QgayA9IHRoaXMuI2tleUxpc3RbaW5kZXhdOwogICAgICAgIGlmICh0aGlzLiNoYXNEaXNwb3NlKSB7CiAgICAgICAgICB0aGlzLiNkaXNwb3NlPy4odiwgaywgImRlbGV0ZSIpOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy4jaGFzRGlzcG9zZUFmdGVyKSB7CiAgICAgICAgICB0aGlzLiNkaXNwb3NlZD8ucHVzaChbdiwgaywgImRlbGV0ZSJdKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHRoaXMuI2tleU1hcC5jbGVhcigpOwogICAgdGhpcy4jdmFsTGlzdC5maWxsKHZvaWQgMCk7CiAgICB0aGlzLiNrZXlMaXN0LmZpbGwodm9pZCAwKTsKICAgIGlmICh0aGlzLiN0dGxzICYmIHRoaXMuI3N0YXJ0cykgewogICAgICB0aGlzLiN0dGxzLmZpbGwoMCk7CiAgICAgIHRoaXMuI3N0YXJ0cy5maWxsKDApOwogICAgfQogICAgaWYgKHRoaXMuI3NpemVzKSB7CiAgICAgIHRoaXMuI3NpemVzLmZpbGwoMCk7CiAgICB9CiAgICB0aGlzLiNoZWFkID0gMDsKICAgIHRoaXMuI3RhaWwgPSAwOwogICAgdGhpcy4jZnJlZS5sZW5ndGggPSAwOwogICAgdGhpcy4jY2FsY3VsYXRlZFNpemUgPSAwOwogICAgdGhpcy4jc2l6ZSA9IDA7CiAgICBpZiAodGhpcy4jaGFzRGlzcG9zZUFmdGVyICYmIHRoaXMuI2Rpc3Bvc2VkKSB7CiAgICAgIGNvbnN0IGR0ID0gdGhpcy4jZGlzcG9zZWQ7CiAgICAgIGxldCB0YXNrOwogICAgICB3aGlsZSAodGFzayA9IGR0Py5zaGlmdCgpKSB7CiAgICAgICAgdGhpcy4jZGlzcG9zZUFmdGVyPy4oLi4udGFzayk7CiAgICAgIH0KICAgIH0KICB9Cn0KY29uc3QgcHJvYyA9IHR5cGVvZiBwcm9jZXNzID09PSAib2JqZWN0IiAmJiBwcm9jZXNzID8gcHJvY2VzcyA6IHsKICBzdGRvdXQ6IG51bGwsCiAgc3RkZXJyOiBudWxsCn07CmNvbnN0IGlzU3RyZWFtID0gKHMpID0+ICEhcyAmJiB0eXBlb2YgcyA9PT0gIm9iamVjdCIgJiYgKHMgaW5zdGFuY2VvZiBNaW5pcGFzcyB8fCBzIGluc3RhbmNlb2YgU3RyZWFtIHx8IGlzUmVhZGFibGUocykgfHwgaXNXcml0YWJsZShzKSk7CmNvbnN0IGlzUmVhZGFibGUgPSAocykgPT4gISFzICYmIHR5cGVvZiBzID09PSAib2JqZWN0IiAmJiBzIGluc3RhbmNlb2YgRXZlbnRFbWl0dGVyICYmIHR5cGVvZiBzLnBpcGUgPT09ICJmdW5jdGlvbiIgJiYgLy8gbm9kZSBjb3JlIFdyaXRhYmxlIHN0cmVhbXMgaGF2ZSBhIHBpcGUoKSBtZXRob2QsIGJ1dCBpdCB0aHJvd3MKcy5waXBlICE9PSBTdHJlYW0uV3JpdGFibGUucHJvdG90eXBlLnBpcGU7CmNvbnN0IGlzV3JpdGFibGUgPSAocykgPT4gISFzICYmIHR5cGVvZiBzID09PSAib2JqZWN0IiAmJiBzIGluc3RhbmNlb2YgRXZlbnRFbWl0dGVyICYmIHR5cGVvZiBzLndyaXRlID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBzLmVuZCA9PT0gImZ1bmN0aW9uIjsKY29uc3QgRU9GID0gU3ltYm9sKCJFT0YiKTsKY29uc3QgTUFZQkVfRU1JVF9FTkQgPSBTeW1ib2woIm1heWJlRW1pdEVuZCIpOwpjb25zdCBFTUlUVEVEX0VORCA9IFN5bWJvbCgiZW1pdHRlZEVuZCIpOwpjb25zdCBFTUlUVElOR19FTkQgPSBTeW1ib2woImVtaXR0aW5nRW5kIik7CmNvbnN0IEVNSVRURURfRVJST1IgPSBTeW1ib2woImVtaXR0ZWRFcnJvciIpOwpjb25zdCBDTE9TRUQgPSBTeW1ib2woImNsb3NlZCIpOwpjb25zdCBSRUFEID0gU3ltYm9sKCJyZWFkIik7CmNvbnN0IEZMVVNIID0gU3ltYm9sKCJmbHVzaCIpOwpjb25zdCBGTFVTSENIVU5LID0gU3ltYm9sKCJmbHVzaENodW5rIik7CmNvbnN0IEVOQ09ESU5HID0gU3ltYm9sKCJlbmNvZGluZyIpOwpjb25zdCBERUNPREVSID0gU3ltYm9sKCJkZWNvZGVyIik7CmNvbnN0IEZMT1dJTkcgPSBTeW1ib2woImZsb3dpbmciKTsKY29uc3QgUEFVU0VEID0gU3ltYm9sKCJwYXVzZWQiKTsKY29uc3QgUkVTVU1FID0gU3ltYm9sKCJyZXN1bWUiKTsKY29uc3QgQlVGRkVSID0gU3ltYm9sKCJidWZmZXIiKTsKY29uc3QgUElQRVMgPSBTeW1ib2woInBpcGVzIik7CmNvbnN0IEJVRkZFUkxFTkdUSCA9IFN5bWJvbCgiYnVmZmVyTGVuZ3RoIik7CmNvbnN0IEJVRkZFUlBVU0ggPSBTeW1ib2woImJ1ZmZlclB1c2giKTsKY29uc3QgQlVGRkVSU0hJRlQgPSBTeW1ib2woImJ1ZmZlclNoaWZ0Iik7CmNvbnN0IE9CSkVDVE1PREUgPSBTeW1ib2woIm9iamVjdE1vZGUiKTsKY29uc3QgREVTVFJPWUVEID0gU3ltYm9sKCJkZXN0cm95ZWQiKTsKY29uc3QgRVJST1IgPSBTeW1ib2woImVycm9yIik7CmNvbnN0IEVNSVREQVRBID0gU3ltYm9sKCJlbWl0RGF0YSIpOwpjb25zdCBFTUlURU5EID0gU3ltYm9sKCJlbWl0RW5kIik7CmNvbnN0IEVNSVRFTkQyID0gU3ltYm9sKCJlbWl0RW5kMiIpOwpjb25zdCBBU1lOQyA9IFN5bWJvbCgiYXN5bmMiKTsKY29uc3QgQUJPUlQgPSBTeW1ib2woImFib3J0Iik7CmNvbnN0IEFCT1JURUQgPSBTeW1ib2woImFib3J0ZWQiKTsKY29uc3QgU0lHTkFMID0gU3ltYm9sKCJzaWduYWwiKTsKY29uc3QgREFUQUxJU1RFTkVSUyA9IFN5bWJvbCgiZGF0YUxpc3RlbmVycyIpOwpjb25zdCBESVNDQVJERUQgPSBTeW1ib2woImRpc2NhcmRlZCIpOwpjb25zdCBkZWZlciA9IChmbikgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbihmbik7CmNvbnN0IG5vZGVmZXIgPSAoZm4pID0+IGZuKCk7CmNvbnN0IGlzRW5kaXNoID0gKGV2KSA9PiBldiA9PT0gImVuZCIgfHwgZXYgPT09ICJmaW5pc2giIHx8IGV2ID09PSAicHJlZmluaXNoIjsKY29uc3QgaXNBcnJheUJ1ZmZlckxpa2UgPSAoYikgPT4gYiBpbnN0YW5jZW9mIEFycmF5QnVmZmVyIHx8ICEhYiAmJiB0eXBlb2YgYiA9PT0gIm9iamVjdCIgJiYgYi5jb25zdHJ1Y3RvciAmJiBiLmNvbnN0cnVjdG9yLm5hbWUgPT09ICJBcnJheUJ1ZmZlciIgJiYgYi5ieXRlTGVuZ3RoID49IDA7CmNvbnN0IGlzQXJyYXlCdWZmZXJWaWV3ID0gKGIpID0+ICFCdWZmZXIuaXNCdWZmZXIoYikgJiYgQXJyYXlCdWZmZXIuaXNWaWV3KGIpOwpjbGFzcyBQaXBlIHsKICBzcmM7CiAgZGVzdDsKICBvcHRzOwogIG9uZHJhaW47CiAgY29uc3RydWN0b3Ioc3JjLCBkZXN0LCBvcHRzKSB7CiAgICB0aGlzLnNyYyA9IHNyYzsKICAgIHRoaXMuZGVzdCA9IGRlc3Q7CiAgICB0aGlzLm9wdHMgPSBvcHRzOwogICAgdGhpcy5vbmRyYWluID0gKCkgPT4gc3JjW1JFU1VNRV0oKTsKICAgIHRoaXMuZGVzdC5vbigiZHJhaW4iLCB0aGlzLm9uZHJhaW4pOwogIH0KICB1bnBpcGUoKSB7CiAgICB0aGlzLmRlc3QucmVtb3ZlTGlzdGVuZXIoImRyYWluIiwgdGhpcy5vbmRyYWluKTsKICB9CiAgLy8gb25seSBoZXJlIGZvciB0aGUgcHJvdG90eXBlCiAgLyogYzggaWdub3JlIHN0YXJ0ICovCiAgcHJveHlFcnJvcnMoX2VyKSB7CiAgfQogIC8qIGM4IGlnbm9yZSBzdG9wICovCiAgZW5kKCkgewogICAgdGhpcy51bnBpcGUoKTsKICAgIGlmICh0aGlzLm9wdHMuZW5kKQogICAgICB0aGlzLmRlc3QuZW5kKCk7CiAgfQp9CmNsYXNzIFBpcGVQcm94eUVycm9ycyBleHRlbmRzIFBpcGUgewogIHVucGlwZSgpIHsKICAgIHRoaXMuc3JjLnJlbW92ZUxpc3RlbmVyKCJlcnJvciIsIHRoaXMucHJveHlFcnJvcnMpOwogICAgc3VwZXIudW5waXBlKCk7CiAgfQogIGNvbnN0cnVjdG9yKHNyYywgZGVzdCwgb3B0cykgewogICAgc3VwZXIoc3JjLCBkZXN0LCBvcHRzKTsKICAgIHRoaXMucHJveHlFcnJvcnMgPSAoZXIpID0+IGRlc3QuZW1pdCgiZXJyb3IiLCBlcik7CiAgICBzcmMub24oImVycm9yIiwgdGhpcy5wcm94eUVycm9ycyk7CiAgfQp9CmNvbnN0IGlzT2JqZWN0TW9kZU9wdGlvbnMgPSAobykgPT4gISFvLm9iamVjdE1vZGU7CmNvbnN0IGlzRW5jb2RpbmdPcHRpb25zID0gKG8pID0+ICFvLm9iamVjdE1vZGUgJiYgISFvLmVuY29kaW5nICYmIG8uZW5jb2RpbmcgIT09ICJidWZmZXIiOwpjbGFzcyBNaW5pcGFzcyBleHRlbmRzIEV2ZW50RW1pdHRlciB7CiAgW0ZMT1dJTkddID0gZmFsc2U7CiAgW1BBVVNFRF0gPSBmYWxzZTsKICBbUElQRVNdID0gW107CiAgW0JVRkZFUl0gPSBbXTsKICBbT0JKRUNUTU9ERV07CiAgW0VOQ09ESU5HXTsKICBbQVNZTkNdOwogIFtERUNPREVSXTsKICBbRU9GXSA9IGZhbHNlOwogIFtFTUlUVEVEX0VORF0gPSBmYWxzZTsKICBbRU1JVFRJTkdfRU5EXSA9IGZhbHNlOwogIFtDTE9TRURdID0gZmFsc2U7CiAgW0VNSVRURURfRVJST1JdID0gbnVsbDsKICBbQlVGRkVSTEVOR1RIXSA9IDA7CiAgW0RFU1RST1lFRF0gPSBmYWxzZTsKICBbU0lHTkFMXTsKICBbQUJPUlRFRF0gPSBmYWxzZTsKICBbREFUQUxJU1RFTkVSU10gPSAwOwogIFtESVNDQVJERURdID0gZmFsc2U7CiAgLyoqCiAgICogdHJ1ZSBpZiB0aGUgc3RyZWFtIGNhbiBiZSB3cml0dGVuCiAgICovCiAgd3JpdGFibGUgPSB0cnVlOwogIC8qKgogICAqIHRydWUgaWYgdGhlIHN0cmVhbSBjYW4gYmUgcmVhZAogICAqLwogIHJlYWRhYmxlID0gdHJ1ZTsKICAvKioKICAgKiBJZiBgUlR5cGVgIGlzIEJ1ZmZlciwgdGhlbiBvcHRpb25zIGRvIG5vdCBuZWVkIHRvIGJlIHByb3ZpZGVkLgogICAqIE90aGVyd2lzZSwgYW4gb3B0aW9ucyBvYmplY3QgbXVzdCBiZSBwcm92aWRlZCB0byBzcGVjaWZ5IGVpdGhlcgogICAqIHtAbGluayBNaW5pcGFzcy5TaGFyZWRPcHRpb25zLm9iamVjdE1vZGV9IG9yCiAgICoge0BsaW5rIE1pbmlwYXNzLlNoYXJlZE9wdGlvbnMuZW5jb2Rpbmd9LCBhcyBhcHByb3ByaWF0ZS4KICAgKi8KICBjb25zdHJ1Y3RvciguLi5hcmdzKSB7CiAgICBjb25zdCBvcHRpb25zID0gYXJnc1swXSB8fCB7fTsKICAgIHN1cGVyKCk7CiAgICBpZiAob3B0aW9ucy5vYmplY3RNb2RlICYmIHR5cGVvZiBvcHRpb25zLmVuY29kaW5nID09PSAic3RyaW5nIikgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJFbmNvZGluZyBhbmQgb2JqZWN0TW9kZSBtYXkgbm90IGJlIHVzZWQgdG9nZXRoZXIiKTsKICAgIH0KICAgIGlmIChpc09iamVjdE1vZGVPcHRpb25zKG9wdGlvbnMpKSB7CiAgICAgIHRoaXNbT0JKRUNUTU9ERV0gPSB0cnVlOwogICAgICB0aGlzW0VOQ09ESU5HXSA9IG51bGw7CiAgICB9IGVsc2UgaWYgKGlzRW5jb2RpbmdPcHRpb25zKG9wdGlvbnMpKSB7CiAgICAgIHRoaXNbRU5DT0RJTkddID0gb3B0aW9ucy5lbmNvZGluZzsKICAgICAgdGhpc1tPQkpFQ1RNT0RFXSA9IGZhbHNlOwogICAgfSBlbHNlIHsKICAgICAgdGhpc1tPQkpFQ1RNT0RFXSA9IGZhbHNlOwogICAgICB0aGlzW0VOQ09ESU5HXSA9IG51bGw7CiAgICB9CiAgICB0aGlzW0FTWU5DXSA9ICEhb3B0aW9ucy5hc3luYzsKICAgIHRoaXNbREVDT0RFUl0gPSB0aGlzW0VOQ09ESU5HXSA/IG5ldyBTdHJpbmdEZWNvZGVyKHRoaXNbRU5DT0RJTkddKSA6IG51bGw7CiAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLmRlYnVnRXhwb3NlQnVmZmVyID09PSB0cnVlKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCAiYnVmZmVyIiwgeyBnZXQ6ICgpID0+IHRoaXNbQlVGRkVSXSB9KTsKICAgIH0KICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMuZGVidWdFeHBvc2VQaXBlcyA9PT0gdHJ1ZSkgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgInBpcGVzIiwgeyBnZXQ6ICgpID0+IHRoaXNbUElQRVNdIH0pOwogICAgfQogICAgY29uc3QgeyBzaWduYWwgfSA9IG9wdGlvbnM7CiAgICBpZiAoc2lnbmFsKSB7CiAgICAgIHRoaXNbU0lHTkFMXSA9IHNpZ25hbDsKICAgICAgaWYgKHNpZ25hbC5hYm9ydGVkKSB7CiAgICAgICAgdGhpc1tBQk9SVF0oKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzaWduYWwuYWRkRXZlbnRMaXN0ZW5lcigiYWJvcnQiLCAoKSA9PiB0aGlzW0FCT1JUXSgpKTsKICAgICAgfQogICAgfQogIH0KICAvKioKICAgKiBUaGUgYW1vdW50IG9mIGRhdGEgc3RvcmVkIGluIHRoZSBidWZmZXIgd2FpdGluZyB0byBiZSByZWFkLgogICAqCiAgICogRm9yIEJ1ZmZlciBzdHJpbmdzLCB0aGlzIHdpbGwgYmUgdGhlIHRvdGFsIGJ5dGUgbGVuZ3RoLgogICAqIEZvciBzdHJpbmcgZW5jb2Rpbmcgc3RyZWFtcywgdGhpcyB3aWxsIGJlIHRoZSBzdHJpbmcgY2hhcmFjdGVyIGxlbmd0aCwKICAgKiBhY2NvcmRpbmcgdG8gSmF2YVNjcmlwdCdzIGBzdHJpbmcubGVuZ3RoYCBsb2dpYy4KICAgKiBGb3Igb2JqZWN0TW9kZSBzdHJlYW1zLCB0aGlzIGlzIGEgY291bnQgb2YgdGhlIGl0ZW1zIHdhaXRpbmcgdG8gYmUKICAgKiBlbWl0dGVkLgogICAqLwogIGdldCBidWZmZXJMZW5ndGgoKSB7CiAgICByZXR1cm4gdGhpc1tCVUZGRVJMRU5HVEhdOwogIH0KICAvKioKICAgKiBUaGUgYEJ1ZmZlckVuY29kaW5nYCBjdXJyZW50bHkgaW4gdXNlLCBvciBgbnVsbGAKICAgKi8KICBnZXQgZW5jb2RpbmcoKSB7CiAgICByZXR1cm4gdGhpc1tFTkNPRElOR107CiAgfQogIC8qKgogICAqIEBkZXByZWNhdGVkIC0gVGhpcyBpcyBhIHJlYWQgb25seSBwcm9wZXJ0eQogICAqLwogIHNldCBlbmNvZGluZyhfZW5jKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoIkVuY29kaW5nIG11c3QgYmUgc2V0IGF0IGluc3RhbnRpYXRpb24gdGltZSIpOwogIH0KICAvKioKICAgKiBAZGVwcmVjYXRlZCAtIEVuY29kaW5nIG1heSBvbmx5IGJlIHNldCBhdCBpbnN0YW50aWF0aW9uIHRpbWUKICAgKi8KICBzZXRFbmNvZGluZyhfZW5jKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoIkVuY29kaW5nIG11c3QgYmUgc2V0IGF0IGluc3RhbnRpYXRpb24gdGltZSIpOwogIH0KICAvKioKICAgKiBUcnVlIGlmIHRoaXMgaXMgYW4gb2JqZWN0TW9kZSBzdHJlYW0KICAgKi8KICBnZXQgb2JqZWN0TW9kZSgpIHsKICAgIHJldHVybiB0aGlzW09CSkVDVE1PREVdOwogIH0KICAvKioKICAgKiBAZGVwcmVjYXRlZCAtIFRoaXMgaXMgYSByZWFkLW9ubHkgcHJvcGVydHkKICAgKi8KICBzZXQgb2JqZWN0TW9kZShfb20pIHsKICAgIHRocm93IG5ldyBFcnJvcigib2JqZWN0TW9kZSBtdXN0IGJlIHNldCBhdCBpbnN0YW50aWF0aW9uIHRpbWUiKTsKICB9CiAgLyoqCiAgICogdHJ1ZSBpZiB0aGlzIGlzIGFuIGFzeW5jIHN0cmVhbQogICAqLwogIGdldCBbImFzeW5jIl0oKSB7CiAgICByZXR1cm4gdGhpc1tBU1lOQ107CiAgfQogIC8qKgogICAqIFNldCB0byB0cnVlIHRvIG1ha2UgdGhpcyBzdHJlYW0gYXN5bmMuCiAgICoKICAgKiBPbmNlIHNldCwgaXQgY2Fubm90IGJlIHVuc2V0LCBhcyB0aGlzIHdvdWxkIHBvdGVudGlhbGx5IGNhdXNlIGluY29ycmVjdAogICAqIGJlaGF2aW9yLiAgSWUsIGEgc3luYyBzdHJlYW0gY2FuIGJlIG1hZGUgYXN5bmMsIGJ1dCBhbiBhc3luYyBzdHJlYW0KICAgKiBjYW5ub3QgYmUgc2FmZWx5IG1hZGUgc3luYy4KICAgKi8KICBzZXQgWyJhc3luYyJdKGEpIHsKICAgIHRoaXNbQVNZTkNdID0gdGhpc1tBU1lOQ10gfHwgISFhOwogIH0KICAvLyBkcm9wIGV2ZXJ5dGhpbmcgYW5kIGdldCBvdXQgb2YgdGhlIGZsb3cgY29tcGxldGVseQogIFtBQk9SVF0oKSB7CiAgICB0aGlzW0FCT1JURURdID0gdHJ1ZTsKICAgIHRoaXMuZW1pdCgiYWJvcnQiLCB0aGlzW1NJR05BTF0/LnJlYXNvbik7CiAgICB0aGlzLmRlc3Ryb3kodGhpc1tTSUdOQUxdPy5yZWFzb24pOwogIH0KICAvKioKICAgKiBUcnVlIGlmIHRoZSBzdHJlYW0gaGFzIGJlZW4gYWJvcnRlZC4KICAgKi8KICBnZXQgYWJvcnRlZCgpIHsKICAgIHJldHVybiB0aGlzW0FCT1JURURdOwogIH0KICAvKioKICAgKiBOby1vcCBzZXR0ZXIuIFN0cmVhbSBhYm9ydGVkIHN0YXR1cyBpcyBzZXQgdmlhIHRoZSBBYm9ydFNpZ25hbCBwcm92aWRlZAogICAqIGluIHRoZSBjb25zdHJ1Y3RvciBvcHRpb25zLgogICAqLwogIHNldCBhYm9ydGVkKF8pIHsKICB9CiAgd3JpdGUoY2h1bmssIGVuY29kaW5nLCBjYikgewogICAgaWYgKHRoaXNbQUJPUlRFRF0pCiAgICAgIHJldHVybiBmYWxzZTsKICAgIGlmICh0aGlzW0VPRl0pCiAgICAgIHRocm93IG5ldyBFcnJvcigid3JpdGUgYWZ0ZXIgZW5kIik7CiAgICBpZiAodGhpc1tERVNUUk9ZRURdKSB7CiAgICAgIHRoaXMuZW1pdCgiZXJyb3IiLCBPYmplY3QuYXNzaWduKG5ldyBFcnJvcigiQ2Fubm90IGNhbGwgd3JpdGUgYWZ0ZXIgYSBzdHJlYW0gd2FzIGRlc3Ryb3llZCIpLCB7IGNvZGU6ICJFUlJfU1RSRUFNX0RFU1RST1lFRCIgfSkpOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIGlmICh0eXBlb2YgZW5jb2RpbmcgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgY2IgPSBlbmNvZGluZzsKICAgICAgZW5jb2RpbmcgPSAidXRmOCI7CiAgICB9CiAgICBpZiAoIWVuY29kaW5nKQogICAgICBlbmNvZGluZyA9ICJ1dGY4IjsKICAgIGNvbnN0IGZuID0gdGhpc1tBU1lOQ10gPyBkZWZlciA6IG5vZGVmZXI7CiAgICBpZiAoIXRoaXNbT0JKRUNUTU9ERV0gJiYgIUJ1ZmZlci5pc0J1ZmZlcihjaHVuaykpIHsKICAgICAgaWYgKGlzQXJyYXlCdWZmZXJWaWV3KGNodW5rKSkgewogICAgICAgIGNodW5rID0gQnVmZmVyLmZyb20oY2h1bmsuYnVmZmVyLCBjaHVuay5ieXRlT2Zmc2V0LCBjaHVuay5ieXRlTGVuZ3RoKTsKICAgICAgfSBlbHNlIGlmIChpc0FycmF5QnVmZmVyTGlrZShjaHVuaykpIHsKICAgICAgICBjaHVuayA9IEJ1ZmZlci5mcm9tKGNodW5rKTsKICAgICAgfSBlbHNlIGlmICh0eXBlb2YgY2h1bmsgIT09ICJzdHJpbmciKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJOb24tY29udGlndW91cyBkYXRhIHdyaXR0ZW4gdG8gbm9uLW9iamVjdE1vZGUgc3RyZWFtIik7CiAgICAgIH0KICAgIH0KICAgIGlmICh0aGlzW09CSkVDVE1PREVdKSB7CiAgICAgIGlmICh0aGlzW0ZMT1dJTkddICYmIHRoaXNbQlVGRkVSTEVOR1RIXSAhPT0gMCkKICAgICAgICB0aGlzW0ZMVVNIXSh0cnVlKTsKICAgICAgaWYgKHRoaXNbRkxPV0lOR10pCiAgICAgICAgdGhpcy5lbWl0KCJkYXRhIiwgY2h1bmspOwogICAgICBlbHNlCiAgICAgICAgdGhpc1tCVUZGRVJQVVNIXShjaHVuayk7CiAgICAgIGlmICh0aGlzW0JVRkZFUkxFTkdUSF0gIT09IDApCiAgICAgICAgdGhpcy5lbWl0KCJyZWFkYWJsZSIpOwogICAgICBpZiAoY2IpCiAgICAgICAgZm4oY2IpOwogICAgICByZXR1cm4gdGhpc1tGTE9XSU5HXTsKICAgIH0KICAgIGlmICghY2h1bmsubGVuZ3RoKSB7CiAgICAgIGlmICh0aGlzW0JVRkZFUkxFTkdUSF0gIT09IDApCiAgICAgICAgdGhpcy5lbWl0KCJyZWFkYWJsZSIpOwogICAgICBpZiAoY2IpCiAgICAgICAgZm4oY2IpOwogICAgICByZXR1cm4gdGhpc1tGTE9XSU5HXTsKICAgIH0KICAgIGlmICh0eXBlb2YgY2h1bmsgPT09ICJzdHJpbmciICYmIC8vIHVubGVzcyBpdCBpcyBhIHN0cmluZyBhbHJlYWR5IHJlYWR5IGZvciB1cyB0byB1c2UKICAgICEoZW5jb2RpbmcgPT09IHRoaXNbRU5DT0RJTkddICYmICF0aGlzW0RFQ09ERVJdPy5sYXN0TmVlZCkpIHsKICAgICAgY2h1bmsgPSBCdWZmZXIuZnJvbShjaHVuaywgZW5jb2RpbmcpOwogICAgfQogICAgaWYgKEJ1ZmZlci5pc0J1ZmZlcihjaHVuaykgJiYgdGhpc1tFTkNPRElOR10pIHsKICAgICAgY2h1bmsgPSB0aGlzW0RFQ09ERVJdLndyaXRlKGNodW5rKTsKICAgIH0KICAgIGlmICh0aGlzW0ZMT1dJTkddICYmIHRoaXNbQlVGRkVSTEVOR1RIXSAhPT0gMCkKICAgICAgdGhpc1tGTFVTSF0odHJ1ZSk7CiAgICBpZiAodGhpc1tGTE9XSU5HXSkKICAgICAgdGhpcy5lbWl0KCJkYXRhIiwgY2h1bmspOwogICAgZWxzZQogICAgICB0aGlzW0JVRkZFUlBVU0hdKGNodW5rKTsKICAgIGlmICh0aGlzW0JVRkZFUkxFTkdUSF0gIT09IDApCiAgICAgIHRoaXMuZW1pdCgicmVhZGFibGUiKTsKICAgIGlmIChjYikKICAgICAgZm4oY2IpOwogICAgcmV0dXJuIHRoaXNbRkxPV0lOR107CiAgfQogIC8qKgogICAqIExvdy1sZXZlbCBleHBsaWNpdCByZWFkIG1ldGhvZC4KICAgKgogICAqIEluIG9iamVjdE1vZGUsIHRoZSBhcmd1bWVudCBpcyBpZ25vcmVkLCBhbmQgb25lIGl0ZW0gaXMgcmV0dXJuZWQgaWYKICAgKiBhdmFpbGFibGUuCiAgICoKICAgKiBgbmAgaXMgdGhlIG51bWJlciBvZiBieXRlcyAob3IgaW4gdGhlIGNhc2Ugb2YgZW5jb2Rpbmcgc3RyZWFtcywKICAgKiBjaGFyYWN0ZXJzKSB0byBjb25zdW1lLiBJZiBgbmAgaXMgbm90IHByb3ZpZGVkLCB0aGVuIHRoZSBlbnRpcmUgYnVmZmVyCiAgICogaXMgcmV0dXJuZWQsIG9yIGBudWxsYCBpcyByZXR1cm5lZCBpZiBubyBkYXRhIGlzIGF2YWlsYWJsZS4KICAgKgogICAqIElmIGBuYCBpcyBncmVhdGVyIHRoYXQgdGhlIGFtb3VudCBvZiBkYXRhIGluIHRoZSBpbnRlcm5hbCBidWZmZXIsCiAgICogdGhlbiBgbnVsbGAgaXMgcmV0dXJuZWQuCiAgICovCiAgcmVhZChuKSB7CiAgICBpZiAodGhpc1tERVNUUk9ZRURdKQogICAgICByZXR1cm4gbnVsbDsKICAgIHRoaXNbRElTQ0FSREVEXSA9IGZhbHNlOwogICAgaWYgKHRoaXNbQlVGRkVSTEVOR1RIXSA9PT0gMCB8fCBuID09PSAwIHx8IG4gJiYgbiA+IHRoaXNbQlVGRkVSTEVOR1RIXSkgewogICAgICB0aGlzW01BWUJFX0VNSVRfRU5EXSgpOwogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIGlmICh0aGlzW09CSkVDVE1PREVdKQogICAgICBuID0gbnVsbDsKICAgIGlmICh0aGlzW0JVRkZFUl0ubGVuZ3RoID4gMSAmJiAhdGhpc1tPQkpFQ1RNT0RFXSkgewogICAgICB0aGlzW0JVRkZFUl0gPSBbCiAgICAgICAgdGhpc1tFTkNPRElOR10gPyB0aGlzW0JVRkZFUl0uam9pbigiIikgOiBCdWZmZXIuY29uY2F0KHRoaXNbQlVGRkVSXSwgdGhpc1tCVUZGRVJMRU5HVEhdKQogICAgICBdOwogICAgfQogICAgY29uc3QgcmV0ID0gdGhpc1tSRUFEXShuIHx8IG51bGwsIHRoaXNbQlVGRkVSXVswXSk7CiAgICB0aGlzW01BWUJFX0VNSVRfRU5EXSgpOwogICAgcmV0dXJuIHJldDsKICB9CiAgW1JFQURdKG4sIGNodW5rKSB7CiAgICBpZiAodGhpc1tPQkpFQ1RNT0RFXSkKICAgICAgdGhpc1tCVUZGRVJTSElGVF0oKTsKICAgIGVsc2UgewogICAgICBjb25zdCBjID0gY2h1bms7CiAgICAgIGlmIChuID09PSBjLmxlbmd0aCB8fCBuID09PSBudWxsKQogICAgICAgIHRoaXNbQlVGRkVSU0hJRlRdKCk7CiAgICAgIGVsc2UgaWYgKHR5cGVvZiBjID09PSAic3RyaW5nIikgewogICAgICAgIHRoaXNbQlVGRkVSXVswXSA9IGMuc2xpY2Uobik7CiAgICAgICAgY2h1bmsgPSBjLnNsaWNlKDAsIG4pOwogICAgICAgIHRoaXNbQlVGRkVSTEVOR1RIXSAtPSBuOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXNbQlVGRkVSXVswXSA9IGMuc3ViYXJyYXkobik7CiAgICAgICAgY2h1bmsgPSBjLnN1YmFycmF5KDAsIG4pOwogICAgICAgIHRoaXNbQlVGRkVSTEVOR1RIXSAtPSBuOwogICAgICB9CiAgICB9CiAgICB0aGlzLmVtaXQoImRhdGEiLCBjaHVuayk7CiAgICBpZiAoIXRoaXNbQlVGRkVSXS5sZW5ndGggJiYgIXRoaXNbRU9GXSkKICAgICAgdGhpcy5lbWl0KCJkcmFpbiIpOwogICAgcmV0dXJuIGNodW5rOwogIH0KICBlbmQoY2h1bmssIGVuY29kaW5nLCBjYikgewogICAgaWYgKHR5cGVvZiBjaHVuayA9PT0gImZ1bmN0aW9uIikgewogICAgICBjYiA9IGNodW5rOwogICAgICBjaHVuayA9IHZvaWQgMDsKICAgIH0KICAgIGlmICh0eXBlb2YgZW5jb2RpbmcgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgY2IgPSBlbmNvZGluZzsKICAgICAgZW5jb2RpbmcgPSAidXRmOCI7CiAgICB9CiAgICBpZiAoY2h1bmsgIT09IHZvaWQgMCkKICAgICAgdGhpcy53cml0ZShjaHVuaywgZW5jb2RpbmcpOwogICAgaWYgKGNiKQogICAgICB0aGlzLm9uY2UoImVuZCIsIGNiKTsKICAgIHRoaXNbRU9GXSA9IHRydWU7CiAgICB0aGlzLndyaXRhYmxlID0gZmFsc2U7CiAgICBpZiAodGhpc1tGTE9XSU5HXSB8fCAhdGhpc1tQQVVTRURdKQogICAgICB0aGlzW01BWUJFX0VNSVRfRU5EXSgpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIC8vIGRvbid0IGxldCB0aGUgaW50ZXJuYWwgcmVzdW1lIGJlIG92ZXJ3cml0dGVuCiAgW1JFU1VNRV0oKSB7CiAgICBpZiAodGhpc1tERVNUUk9ZRURdKQogICAgICByZXR1cm47CiAgICBpZiAoIXRoaXNbREFUQUxJU1RFTkVSU10gJiYgIXRoaXNbUElQRVNdLmxlbmd0aCkgewogICAgICB0aGlzW0RJU0NBUkRFRF0gPSB0cnVlOwogICAgfQogICAgdGhpc1tQQVVTRURdID0gZmFsc2U7CiAgICB0aGlzW0ZMT1dJTkddID0gdHJ1ZTsKICAgIHRoaXMuZW1pdCgicmVzdW1lIik7CiAgICBpZiAodGhpc1tCVUZGRVJdLmxlbmd0aCkKICAgICAgdGhpc1tGTFVTSF0oKTsKICAgIGVsc2UgaWYgKHRoaXNbRU9GXSkKICAgICAgdGhpc1tNQVlCRV9FTUlUX0VORF0oKTsKICAgIGVsc2UKICAgICAgdGhpcy5lbWl0KCJkcmFpbiIpOwogIH0KICAvKioKICAgKiBSZXN1bWUgdGhlIHN0cmVhbSBpZiBpdCBpcyBjdXJyZW50bHkgaW4gYSBwYXVzZWQgc3RhdGUKICAgKgogICAqIElmIGNhbGxlZCB3aGVuIHRoZXJlIGFyZSBubyBwaXBlIGRlc3RpbmF0aW9ucyBvciBgZGF0YWAgZXZlbnQgbGlzdGVuZXJzLAogICAqIHRoaXMgd2lsbCBwbGFjZSB0aGUgc3RyZWFtIGluIGEgImRpc2NhcmRlZCIgc3RhdGUsIHdoZXJlIGFsbCBkYXRhIHdpbGwKICAgKiBiZSB0aHJvd24gYXdheS4gVGhlIGRpc2NhcmRlZCBzdGF0ZSBpcyByZW1vdmVkIGlmIGEgcGlwZSBkZXN0aW5hdGlvbiBvcgogICAqIGRhdGEgaGFuZGxlciBpcyBhZGRlZCwgaWYgcGF1c2UoKSBpcyBjYWxsZWQsIG9yIGlmIGFueSBzeW5jaHJvbm91cyBvcgogICAqIGFzeW5jaHJvbm91cyBpdGVyYXRpb24gaXMgc3RhcnRlZC4KICAgKi8KICByZXN1bWUoKSB7CiAgICByZXR1cm4gdGhpc1tSRVNVTUVdKCk7CiAgfQogIC8qKgogICAqIFBhdXNlIHRoZSBzdHJlYW0KICAgKi8KICBwYXVzZSgpIHsKICAgIHRoaXNbRkxPV0lOR10gPSBmYWxzZTsKICAgIHRoaXNbUEFVU0VEXSA9IHRydWU7CiAgICB0aGlzW0RJU0NBUkRFRF0gPSBmYWxzZTsKICB9CiAgLyoqCiAgICogdHJ1ZSBpZiB0aGUgc3RyZWFtIGhhcyBiZWVuIGZvcmNpYmx5IGRlc3Ryb3llZAogICAqLwogIGdldCBkZXN0cm95ZWQoKSB7CiAgICByZXR1cm4gdGhpc1tERVNUUk9ZRURdOwogIH0KICAvKioKICAgKiB0cnVlIGlmIHRoZSBzdHJlYW0gaXMgY3VycmVudGx5IGluIGEgZmxvd2luZyBzdGF0ZSwgbWVhbmluZyB0aGF0CiAgICogYW55IHdyaXRlcyB3aWxsIGJlIGltbWVkaWF0ZWx5IGVtaXR0ZWQuCiAgICovCiAgZ2V0IGZsb3dpbmcoKSB7CiAgICByZXR1cm4gdGhpc1tGTE9XSU5HXTsKICB9CiAgLyoqCiAgICogdHJ1ZSBpZiB0aGUgc3RyZWFtIGlzIGN1cnJlbnRseSBpbiBhIHBhdXNlZCBzdGF0ZQogICAqLwogIGdldCBwYXVzZWQoKSB7CiAgICByZXR1cm4gdGhpc1tQQVVTRURdOwogIH0KICBbQlVGRkVSUFVTSF0oY2h1bmspIHsKICAgIGlmICh0aGlzW09CSkVDVE1PREVdKQogICAgICB0aGlzW0JVRkZFUkxFTkdUSF0gKz0gMTsKICAgIGVsc2UKICAgICAgdGhpc1tCVUZGRVJMRU5HVEhdICs9IGNodW5rLmxlbmd0aDsKICAgIHRoaXNbQlVGRkVSXS5wdXNoKGNodW5rKTsKICB9CiAgW0JVRkZFUlNISUZUXSgpIHsKICAgIGlmICh0aGlzW09CSkVDVE1PREVdKQogICAgICB0aGlzW0JVRkZFUkxFTkdUSF0gLT0gMTsKICAgIGVsc2UKICAgICAgdGhpc1tCVUZGRVJMRU5HVEhdIC09IHRoaXNbQlVGRkVSXVswXS5sZW5ndGg7CiAgICByZXR1cm4gdGhpc1tCVUZGRVJdLnNoaWZ0KCk7CiAgfQogIFtGTFVTSF0obm9EcmFpbiA9IGZhbHNlKSB7CiAgICBkbyB7CiAgICB9IHdoaWxlICh0aGlzW0ZMVVNIQ0hVTktdKHRoaXNbQlVGRkVSU0hJRlRdKCkpICYmIHRoaXNbQlVGRkVSXS5sZW5ndGgpOwogICAgaWYgKCFub0RyYWluICYmICF0aGlzW0JVRkZFUl0ubGVuZ3RoICYmICF0aGlzW0VPRl0pCiAgICAgIHRoaXMuZW1pdCgiZHJhaW4iKTsKICB9CiAgW0ZMVVNIQ0hVTktdKGNodW5rKSB7CiAgICB0aGlzLmVtaXQoImRhdGEiLCBjaHVuayk7CiAgICByZXR1cm4gdGhpc1tGTE9XSU5HXTsKICB9CiAgLyoqCiAgICogUGlwZSBhbGwgZGF0YSBlbWl0dGVkIGJ5IHRoaXMgc3RyZWFtIGludG8gdGhlIGRlc3RpbmF0aW9uIHByb3ZpZGVkLgogICAqCiAgICogVHJpZ2dlcnMgdGhlIGZsb3cgb2YgZGF0YS4KICAgKi8KICBwaXBlKGRlc3QsIG9wdHMpIHsKICAgIGlmICh0aGlzW0RFU1RST1lFRF0pCiAgICAgIHJldHVybiBkZXN0OwogICAgdGhpc1tESVNDQVJERURdID0gZmFsc2U7CiAgICBjb25zdCBlbmRlZCA9IHRoaXNbRU1JVFRFRF9FTkRdOwogICAgb3B0cyA9IG9wdHMgfHwge307CiAgICBpZiAoZGVzdCA9PT0gcHJvYy5zdGRvdXQgfHwgZGVzdCA9PT0gcHJvYy5zdGRlcnIpCiAgICAgIG9wdHMuZW5kID0gZmFsc2U7CiAgICBlbHNlCiAgICAgIG9wdHMuZW5kID0gb3B0cy5lbmQgIT09IGZhbHNlOwogICAgb3B0cy5wcm94eUVycm9ycyA9ICEhb3B0cy5wcm94eUVycm9yczsKICAgIGlmIChlbmRlZCkgewogICAgICBpZiAob3B0cy5lbmQpCiAgICAgICAgZGVzdC5lbmQoKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXNbUElQRVNdLnB1c2goIW9wdHMucHJveHlFcnJvcnMgPyBuZXcgUGlwZSh0aGlzLCBkZXN0LCBvcHRzKSA6IG5ldyBQaXBlUHJveHlFcnJvcnModGhpcywgZGVzdCwgb3B0cykpOwogICAgICBpZiAodGhpc1tBU1lOQ10pCiAgICAgICAgZGVmZXIoKCkgPT4gdGhpc1tSRVNVTUVdKCkpOwogICAgICBlbHNlCiAgICAgICAgdGhpc1tSRVNVTUVdKCk7CiAgICB9CiAgICByZXR1cm4gZGVzdDsKICB9CiAgLyoqCiAgICogRnVsbHkgdW5ob29rIGEgcGlwZWQgZGVzdGluYXRpb24gc3RyZWFtLgogICAqCiAgICogSWYgdGhlIGRlc3RpbmF0aW9uIHN0cmVhbSB3YXMgdGhlIG9ubHkgY29uc3VtZXIgb2YgdGhpcyBzdHJlYW0gKGllLAogICAqIHRoZXJlIGFyZSBubyBvdGhlciBwaXBlZCBkZXN0aW5hdGlvbnMgb3IgYCdkYXRhJ2AgZXZlbnQgbGlzdGVuZXJzKQogICAqIHRoZW4gdGhlIGZsb3cgb2YgZGF0YSB3aWxsIHN0b3AgdW50aWwgdGhlcmUgaXMgYW5vdGhlciBjb25zdW1lciBvcgogICAqIHtAbGluayBNaW5pcGFzcyNyZXN1bWV9IGlzIGV4cGxpY2l0bHkgY2FsbGVkLgogICAqLwogIHVucGlwZShkZXN0KSB7CiAgICBjb25zdCBwID0gdGhpc1tQSVBFU10uZmluZCgocDIpID0+IHAyLmRlc3QgPT09IGRlc3QpOwogICAgaWYgKHApIHsKICAgICAgaWYgKHRoaXNbUElQRVNdLmxlbmd0aCA9PT0gMSkgewogICAgICAgIGlmICh0aGlzW0ZMT1dJTkddICYmIHRoaXNbREFUQUxJU1RFTkVSU10gPT09IDApIHsKICAgICAgICAgIHRoaXNbRkxPV0lOR10gPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgdGhpc1tQSVBFU10gPSBbXTsKICAgICAgfSBlbHNlCiAgICAgICAgdGhpc1tQSVBFU10uc3BsaWNlKHRoaXNbUElQRVNdLmluZGV4T2YocCksIDEpOwogICAgICBwLnVucGlwZSgpOwogICAgfQogIH0KICAvKioKICAgKiBBbGlhcyBmb3Ige0BsaW5rIE1pbmlwYXNzI29ufQogICAqLwogIGFkZExpc3RlbmVyKGV2LCBoYW5kbGVyKSB7CiAgICByZXR1cm4gdGhpcy5vbihldiwgaGFuZGxlcik7CiAgfQogIC8qKgogICAqIE1vc3RseSBpZGVudGljYWwgdG8gYEV2ZW50RW1pdHRlci5vbmAsIHdpdGggdGhlIGZvbGxvd2luZwogICAqIGJlaGF2aW9yIGRpZmZlcmVuY2VzIHRvIHByZXZlbnQgZGF0YSBsb3NzIGFuZCB1bm5lY2Vzc2FyeSBoYW5nczoKICAgKgogICAqIC0gQWRkaW5nIGEgJ2RhdGEnIGV2ZW50IGhhbmRsZXIgd2lsbCB0cmlnZ2VyIHRoZSBmbG93IG9mIGRhdGEKICAgKgogICAqIC0gQWRkaW5nIGEgJ3JlYWRhYmxlJyBldmVudCBoYW5kbGVyIHdoZW4gdGhlcmUgaXMgZGF0YSB3YWl0aW5nIHRvIGJlIHJlYWQKICAgKiAgIHdpbGwgY2F1c2UgJ3JlYWRhYmxlJyB0byBiZSBlbWl0dGVkIGltbWVkaWF0ZWx5LgogICAqCiAgICogLSBBZGRpbmcgYW4gJ2VuZGlzaCcgZXZlbnQgaGFuZGxlciAoJ2VuZCcsICdmaW5pc2gnLCBldGMuKSB3aGljaCBoYXMKICAgKiAgIGFscmVhZHkgcGFzc2VkIHdpbGwgY2F1c2UgdGhlIGV2ZW50IHRvIGJlIGVtaXR0ZWQgaW1tZWRpYXRlbHkgYW5kIGFsbAogICAqICAgaGFuZGxlcnMgcmVtb3ZlZC4KICAgKgogICAqIC0gQWRkaW5nIGFuICdlcnJvcicgZXZlbnQgaGFuZGxlciBhZnRlciBhbiBlcnJvciBoYXMgYmVlbiBlbWl0dGVkIHdpbGwKICAgKiAgIGNhdXNlIHRoZSBldmVudCB0byBiZSByZS1lbWl0dGVkIGltbWVkaWF0ZWx5IHdpdGggdGhlIGVycm9yIHByZXZpb3VzbHkKICAgKiAgIHJhaXNlZC4KICAgKi8KICBvbihldiwgaGFuZGxlcikgewogICAgY29uc3QgcmV0ID0gc3VwZXIub24oZXYsIGhhbmRsZXIpOwogICAgaWYgKGV2ID09PSAiZGF0YSIpIHsKICAgICAgdGhpc1tESVNDQVJERURdID0gZmFsc2U7CiAgICAgIHRoaXNbREFUQUxJU1RFTkVSU10rKzsKICAgICAgaWYgKCF0aGlzW1BJUEVTXS5sZW5ndGggJiYgIXRoaXNbRkxPV0lOR10pIHsKICAgICAgICB0aGlzW1JFU1VNRV0oKTsKICAgICAgfQogICAgfSBlbHNlIGlmIChldiA9PT0gInJlYWRhYmxlIiAmJiB0aGlzW0JVRkZFUkxFTkdUSF0gIT09IDApIHsKICAgICAgc3VwZXIuZW1pdCgicmVhZGFibGUiKTsKICAgIH0gZWxzZSBpZiAoaXNFbmRpc2goZXYpICYmIHRoaXNbRU1JVFRFRF9FTkRdKSB7CiAgICAgIHN1cGVyLmVtaXQoZXYpOwogICAgICB0aGlzLnJlbW92ZUFsbExpc3RlbmVycyhldik7CiAgICB9IGVsc2UgaWYgKGV2ID09PSAiZXJyb3IiICYmIHRoaXNbRU1JVFRFRF9FUlJPUl0pIHsKICAgICAgY29uc3QgaCA9IGhhbmRsZXI7CiAgICAgIGlmICh0aGlzW0FTWU5DXSkKICAgICAgICBkZWZlcigoKSA9PiBoLmNhbGwodGhpcywgdGhpc1tFTUlUVEVEX0VSUk9SXSkpOwogICAgICBlbHNlCiAgICAgICAgaC5jYWxsKHRoaXMsIHRoaXNbRU1JVFRFRF9FUlJPUl0pOwogICAgfQogICAgcmV0dXJuIHJldDsKICB9CiAgLyoqCiAgICogQWxpYXMgZm9yIHtAbGluayBNaW5pcGFzcyNvZmZ9CiAgICovCiAgcmVtb3ZlTGlzdGVuZXIoZXYsIGhhbmRsZXIpIHsKICAgIHJldHVybiB0aGlzLm9mZihldiwgaGFuZGxlcik7CiAgfQogIC8qKgogICAqIE1vc3RseSBpZGVudGljYWwgdG8gYEV2ZW50RW1pdHRlci5vZmZgCiAgICoKICAgKiBJZiBhICdkYXRhJyBldmVudCBoYW5kbGVyIGlzIHJlbW92ZWQsIGFuZCBpdCB3YXMgdGhlIGxhc3QgY29uc3VtZXIKICAgKiAoaWUsIHRoZXJlIGFyZSBubyBwaXBlIGRlc3RpbmF0aW9ucyBvciBvdGhlciAnZGF0YScgZXZlbnQgbGlzdGVuZXJzKSwKICAgKiB0aGVuIHRoZSBmbG93IG9mIGRhdGEgd2lsbCBzdG9wIHVudGlsIHRoZXJlIGlzIGFub3RoZXIgY29uc3VtZXIgb3IKICAgKiB7QGxpbmsgTWluaXBhc3MjcmVzdW1lfSBpcyBleHBsaWNpdGx5IGNhbGxlZC4KICAgKi8KICBvZmYoZXYsIGhhbmRsZXIpIHsKICAgIGNvbnN0IHJldCA9IHN1cGVyLm9mZihldiwgaGFuZGxlcik7CiAgICBpZiAoZXYgPT09ICJkYXRhIikgewogICAgICB0aGlzW0RBVEFMSVNURU5FUlNdID0gdGhpcy5saXN0ZW5lcnMoImRhdGEiKS5sZW5ndGg7CiAgICAgIGlmICh0aGlzW0RBVEFMSVNURU5FUlNdID09PSAwICYmICF0aGlzW0RJU0NBUkRFRF0gJiYgIXRoaXNbUElQRVNdLmxlbmd0aCkgewogICAgICAgIHRoaXNbRkxPV0lOR10gPSBmYWxzZTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJldDsKICB9CiAgLyoqCiAgICogTW9zdGx5IGlkZW50aWNhbCB0byBgRXZlbnRFbWl0dGVyLnJlbW92ZUFsbExpc3RlbmVyc2AKICAgKgogICAqIElmIGFsbCAnZGF0YScgZXZlbnQgaGFuZGxlcnMgYXJlIHJlbW92ZWQsIGFuZCB0aGV5IHdlcmUgdGhlIGxhc3QgY29uc3VtZXIKICAgKiAoaWUsIHRoZXJlIGFyZSBubyBwaXBlIGRlc3RpbmF0aW9ucyksIHRoZW4gdGhlIGZsb3cgb2YgZGF0YSB3aWxsIHN0b3AKICAgKiB1bnRpbCB0aGVyZSBpcyBhbm90aGVyIGNvbnN1bWVyIG9yIHtAbGluayBNaW5pcGFzcyNyZXN1bWV9IGlzIGV4cGxpY2l0bHkKICAgKiBjYWxsZWQuCiAgICovCiAgcmVtb3ZlQWxsTGlzdGVuZXJzKGV2KSB7CiAgICBjb25zdCByZXQgPSBzdXBlci5yZW1vdmVBbGxMaXN0ZW5lcnMoZXYpOwogICAgaWYgKGV2ID09PSAiZGF0YSIgfHwgZXYgPT09IHZvaWQgMCkgewogICAgICB0aGlzW0RBVEFMSVNURU5FUlNdID0gMDsKICAgICAgaWYgKCF0aGlzW0RJU0NBUkRFRF0gJiYgIXRoaXNbUElQRVNdLmxlbmd0aCkgewogICAgICAgIHRoaXNbRkxPV0lOR10gPSBmYWxzZTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJldDsKICB9CiAgLyoqCiAgICogdHJ1ZSBpZiB0aGUgJ2VuZCcgZXZlbnQgaGFzIGJlZW4gZW1pdHRlZAogICAqLwogIGdldCBlbWl0dGVkRW5kKCkgewogICAgcmV0dXJuIHRoaXNbRU1JVFRFRF9FTkRdOwogIH0KICBbTUFZQkVfRU1JVF9FTkRdKCkgewogICAgaWYgKCF0aGlzW0VNSVRUSU5HX0VORF0gJiYgIXRoaXNbRU1JVFRFRF9FTkRdICYmICF0aGlzW0RFU1RST1lFRF0gJiYgdGhpc1tCVUZGRVJdLmxlbmd0aCA9PT0gMCAmJiB0aGlzW0VPRl0pIHsKICAgICAgdGhpc1tFTUlUVElOR19FTkRdID0gdHJ1ZTsKICAgICAgdGhpcy5lbWl0KCJlbmQiKTsKICAgICAgdGhpcy5lbWl0KCJwcmVmaW5pc2giKTsKICAgICAgdGhpcy5lbWl0KCJmaW5pc2giKTsKICAgICAgaWYgKHRoaXNbQ0xPU0VEXSkKICAgICAgICB0aGlzLmVtaXQoImNsb3NlIik7CiAgICAgIHRoaXNbRU1JVFRJTkdfRU5EXSA9IGZhbHNlOwogICAgfQogIH0KICAvKioKICAgKiBNb3N0bHkgaWRlbnRpY2FsIHRvIGBFdmVudEVtaXR0ZXIuZW1pdGAsIHdpdGggdGhlIGZvbGxvd2luZwogICAqIGJlaGF2aW9yIGRpZmZlcmVuY2VzIHRvIHByZXZlbnQgZGF0YSBsb3NzIGFuZCB1bm5lY2Vzc2FyeSBoYW5nczoKICAgKgogICAqIElmIHRoZSBzdHJlYW0gaGFzIGJlZW4gZGVzdHJveWVkLCBhbmQgdGhlIGV2ZW50IGlzIHNvbWV0aGluZyBvdGhlcgogICAqIHRoYW4gJ2Nsb3NlJyBvciAnZXJyb3InLCB0aGVuIGBmYWxzZWAgaXMgcmV0dXJuZWQgYW5kIG5vIGhhbmRsZXJzCiAgICogYXJlIGNhbGxlZC4KICAgKgogICAqIElmIHRoZSBldmVudCBpcyAnZW5kJywgYW5kIGhhcyBhbHJlYWR5IGJlZW4gZW1pdHRlZCwgdGhlbiB0aGUgZXZlbnQKICAgKiBpcyBpZ25vcmVkLiBJZiB0aGUgc3RyZWFtIGlzIGluIGEgcGF1c2VkIG9yIG5vbi1mbG93aW5nIHN0YXRlLCB0aGVuCiAgICogdGhlIGV2ZW50IHdpbGwgYmUgZGVmZXJyZWQgdW50aWwgZGF0YSBmbG93IHJlc3VtZXMuIElmIHRoZSBzdHJlYW0gaXMKICAgKiBhc3luYywgdGhlbiBoYW5kbGVycyB3aWxsIGJlIGNhbGxlZCBvbiB0aGUgbmV4dCB0aWNrIHJhdGhlciB0aGFuCiAgICogaW1tZWRpYXRlbHkuCiAgICoKICAgKiBJZiB0aGUgZXZlbnQgaXMgJ2Nsb3NlJywgYW5kICdlbmQnIGhhcyBub3QgeWV0IGJlZW4gZW1pdHRlZCwgdGhlbgogICAqIHRoZSBldmVudCB3aWxsIGJlIGRlZmVycmVkIHVudGlsIGFmdGVyICdlbmQnIGlzIGVtaXR0ZWQuCiAgICoKICAgKiBJZiB0aGUgZXZlbnQgaXMgJ2Vycm9yJywgYW5kIGFuIEFib3J0U2lnbmFsIHdhcyBwcm92aWRlZCBmb3IgdGhlIHN0cmVhbSwKICAgKiBhbmQgdGhlcmUgYXJlIG5vIGxpc3RlbmVycywgdGhlbiB0aGUgZXZlbnQgaXMgaWdub3JlZCwgbWF0Y2hpbmcgdGhlCiAgICogYmVoYXZpb3Igb2Ygbm9kZSBjb3JlIHN0cmVhbXMgaW4gdGhlIHByZXNlbnNlIG9mIGFuIEFib3J0U2lnbmFsLgogICAqCiAgICogSWYgdGhlIGV2ZW50IGlzICdmaW5pc2gnIG9yICdwcmVmaW5pc2gnLCB0aGVuIGFsbCBsaXN0ZW5lcnMgd2lsbCBiZQogICAqIHJlbW92ZWQgYWZ0ZXIgZW1pdHRpbmcgdGhlIGV2ZW50LCB0byBwcmV2ZW50IGRvdWJsZS1maXJpbmcuCiAgICovCiAgZW1pdChldiwgLi4uYXJncykgewogICAgY29uc3QgZGF0YSA9IGFyZ3NbMF07CiAgICBpZiAoZXYgIT09ICJlcnJvciIgJiYgZXYgIT09ICJjbG9zZSIgJiYgZXYgIT09IERFU1RST1lFRCAmJiB0aGlzW0RFU1RST1lFRF0pIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSBlbHNlIGlmIChldiA9PT0gImRhdGEiKSB7CiAgICAgIHJldHVybiAhdGhpc1tPQkpFQ1RNT0RFXSAmJiAhZGF0YSA/IGZhbHNlIDogdGhpc1tBU1lOQ10gPyAoZGVmZXIoKCkgPT4gdGhpc1tFTUlUREFUQV0oZGF0YSkpLCB0cnVlKSA6IHRoaXNbRU1JVERBVEFdKGRhdGEpOwogICAgfSBlbHNlIGlmIChldiA9PT0gImVuZCIpIHsKICAgICAgcmV0dXJuIHRoaXNbRU1JVEVORF0oKTsKICAgIH0gZWxzZSBpZiAoZXYgPT09ICJjbG9zZSIpIHsKICAgICAgdGhpc1tDTE9TRURdID0gdHJ1ZTsKICAgICAgaWYgKCF0aGlzW0VNSVRURURfRU5EXSAmJiAhdGhpc1tERVNUUk9ZRURdKQogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgY29uc3QgcmV0MiA9IHN1cGVyLmVtaXQoImNsb3NlIik7CiAgICAgIHRoaXMucmVtb3ZlQWxsTGlzdGVuZXJzKCJjbG9zZSIpOwogICAgICByZXR1cm4gcmV0MjsKICAgIH0gZWxzZSBpZiAoZXYgPT09ICJlcnJvciIpIHsKICAgICAgdGhpc1tFTUlUVEVEX0VSUk9SXSA9IGRhdGE7CiAgICAgIHN1cGVyLmVtaXQoRVJST1IsIGRhdGEpOwogICAgICBjb25zdCByZXQyID0gIXRoaXNbU0lHTkFMXSB8fCB0aGlzLmxpc3RlbmVycygiZXJyb3IiKS5sZW5ndGggPyBzdXBlci5lbWl0KCJlcnJvciIsIGRhdGEpIDogZmFsc2U7CiAgICAgIHRoaXNbTUFZQkVfRU1JVF9FTkRdKCk7CiAgICAgIHJldHVybiByZXQyOwogICAgfSBlbHNlIGlmIChldiA9PT0gInJlc3VtZSIpIHsKICAgICAgY29uc3QgcmV0MiA9IHN1cGVyLmVtaXQoInJlc3VtZSIpOwogICAgICB0aGlzW01BWUJFX0VNSVRfRU5EXSgpOwogICAgICByZXR1cm4gcmV0MjsKICAgIH0gZWxzZSBpZiAoZXYgPT09ICJmaW5pc2giIHx8IGV2ID09PSAicHJlZmluaXNoIikgewogICAgICBjb25zdCByZXQyID0gc3VwZXIuZW1pdChldik7CiAgICAgIHRoaXMucmVtb3ZlQWxsTGlzdGVuZXJzKGV2KTsKICAgICAgcmV0dXJuIHJldDI7CiAgICB9CiAgICBjb25zdCByZXQgPSBzdXBlci5lbWl0KGV2LCAuLi5hcmdzKTsKICAgIHRoaXNbTUFZQkVfRU1JVF9FTkRdKCk7CiAgICByZXR1cm4gcmV0OwogIH0KICBbRU1JVERBVEFdKGRhdGEpIHsKICAgIGZvciAoY29uc3QgcCBvZiB0aGlzW1BJUEVTXSkgewogICAgICBpZiAocC5kZXN0LndyaXRlKGRhdGEpID09PSBmYWxzZSkKICAgICAgICB0aGlzLnBhdXNlKCk7CiAgICB9CiAgICBjb25zdCByZXQgPSB0aGlzW0RJU0NBUkRFRF0gPyBmYWxzZSA6IHN1cGVyLmVtaXQoImRhdGEiLCBkYXRhKTsKICAgIHRoaXNbTUFZQkVfRU1JVF9FTkRdKCk7CiAgICByZXR1cm4gcmV0OwogIH0KICBbRU1JVEVORF0oKSB7CiAgICBpZiAodGhpc1tFTUlUVEVEX0VORF0pCiAgICAgIHJldHVybiBmYWxzZTsKICAgIHRoaXNbRU1JVFRFRF9FTkRdID0gdHJ1ZTsKICAgIHRoaXMucmVhZGFibGUgPSBmYWxzZTsKICAgIHJldHVybiB0aGlzW0FTWU5DXSA/IChkZWZlcigoKSA9PiB0aGlzW0VNSVRFTkQyXSgpKSwgdHJ1ZSkgOiB0aGlzW0VNSVRFTkQyXSgpOwogIH0KICBbRU1JVEVORDJdKCkgewogICAgaWYgKHRoaXNbREVDT0RFUl0pIHsKICAgICAgY29uc3QgZGF0YSA9IHRoaXNbREVDT0RFUl0uZW5kKCk7CiAgICAgIGlmIChkYXRhKSB7CiAgICAgICAgZm9yIChjb25zdCBwIG9mIHRoaXNbUElQRVNdKSB7CiAgICAgICAgICBwLmRlc3Qud3JpdGUoZGF0YSk7CiAgICAgICAgfQogICAgICAgIGlmICghdGhpc1tESVNDQVJERURdKQogICAgICAgICAgc3VwZXIuZW1pdCgiZGF0YSIsIGRhdGEpOwogICAgICB9CiAgICB9CiAgICBmb3IgKGNvbnN0IHAgb2YgdGhpc1tQSVBFU10pIHsKICAgICAgcC5lbmQoKTsKICAgIH0KICAgIGNvbnN0IHJldCA9IHN1cGVyLmVtaXQoImVuZCIpOwogICAgdGhpcy5yZW1vdmVBbGxMaXN0ZW5lcnMoImVuZCIpOwogICAgcmV0dXJuIHJldDsKICB9CiAgLyoqCiAgICogUmV0dXJuIGEgUHJvbWlzZSB0aGF0IHJlc29sdmVzIHRvIGFuIGFycmF5IG9mIGFsbCBlbWl0dGVkIGRhdGEgb25jZQogICAqIHRoZSBzdHJlYW0gZW5kcy4KICAgKi8KICBhc3luYyBjb2xsZWN0KCkgewogICAgY29uc3QgYnVmID0gT2JqZWN0LmFzc2lnbihbXSwgewogICAgICBkYXRhTGVuZ3RoOiAwCiAgICB9KTsKICAgIGlmICghdGhpc1tPQkpFQ1RNT0RFXSkKICAgICAgYnVmLmRhdGFMZW5ndGggPSAwOwogICAgY29uc3QgcCA9IHRoaXMucHJvbWlzZSgpOwogICAgdGhpcy5vbigiZGF0YSIsIChjKSA9PiB7CiAgICAgIGJ1Zi5wdXNoKGMpOwogICAgICBpZiAoIXRoaXNbT0JKRUNUTU9ERV0pCiAgICAgICAgYnVmLmRhdGFMZW5ndGggKz0gYy5sZW5ndGg7CiAgICB9KTsKICAgIGF3YWl0IHA7CiAgICByZXR1cm4gYnVmOwogIH0KICAvKioKICAgKiBSZXR1cm4gYSBQcm9taXNlIHRoYXQgcmVzb2x2ZXMgdG8gdGhlIGNvbmNhdGVuYXRpb24gb2YgYWxsIGVtaXR0ZWQgZGF0YQogICAqIG9uY2UgdGhlIHN0cmVhbSBlbmRzLgogICAqCiAgICogTm90IGFsbG93ZWQgb24gb2JqZWN0TW9kZSBzdHJlYW1zLgogICAqLwogIGFzeW5jIGNvbmNhdCgpIHsKICAgIGlmICh0aGlzW09CSkVDVE1PREVdKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiY2Fubm90IGNvbmNhdCBpbiBvYmplY3RNb2RlIik7CiAgICB9CiAgICBjb25zdCBidWYgPSBhd2FpdCB0aGlzLmNvbGxlY3QoKTsKICAgIHJldHVybiB0aGlzW0VOQ09ESU5HXSA/IGJ1Zi5qb2luKCIiKSA6IEJ1ZmZlci5jb25jYXQoYnVmLCBidWYuZGF0YUxlbmd0aCk7CiAgfQogIC8qKgogICAqIFJldHVybiBhIHZvaWQgUHJvbWlzZSB0aGF0IHJlc29sdmVzIG9uY2UgdGhlIHN0cmVhbSBlbmRzLgogICAqLwogIGFzeW5jIHByb21pc2UoKSB7CiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgICB0aGlzLm9uKERFU1RST1lFRCwgKCkgPT4gcmVqZWN0KG5ldyBFcnJvcigic3RyZWFtIGRlc3Ryb3llZCIpKSk7CiAgICAgIHRoaXMub24oImVycm9yIiwgKGVyKSA9PiByZWplY3QoZXIpKTsKICAgICAgdGhpcy5vbigiZW5kIiwgKCkgPT4gcmVzb2x2ZSgpKTsKICAgIH0pOwogIH0KICAvKioKICAgKiBBc3luY2hyb25vdXMgYGZvciBhd2FpdCBvZmAgaXRlcmF0aW9uLgogICAqCiAgICogVGhpcyB3aWxsIGNvbnRpbnVlIGVtaXR0aW5nIGFsbCBjaHVua3MgdW50aWwgdGhlIHN0cmVhbSB0ZXJtaW5hdGVzLgogICAqLwogIFtTeW1ib2wuYXN5bmNJdGVyYXRvcl0oKSB7CiAgICB0aGlzW0RJU0NBUkRFRF0gPSBmYWxzZTsKICAgIGxldCBzdG9wcGVkID0gZmFsc2U7CiAgICBjb25zdCBzdG9wID0gYXN5bmMgKCkgPT4gewogICAgICB0aGlzLnBhdXNlKCk7CiAgICAgIHN0b3BwZWQgPSB0cnVlOwogICAgICByZXR1cm4geyB2YWx1ZTogdm9pZCAwLCBkb25lOiB0cnVlIH07CiAgICB9OwogICAgY29uc3QgbmV4dCA9ICgpID0+IHsKICAgICAgaWYgKHN0b3BwZWQpCiAgICAgICAgcmV0dXJuIHN0b3AoKTsKICAgICAgY29uc3QgcmVzID0gdGhpcy5yZWFkKCk7CiAgICAgIGlmIChyZXMgIT09IG51bGwpCiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IGRvbmU6IGZhbHNlLCB2YWx1ZTogcmVzIH0pOwogICAgICBpZiAodGhpc1tFT0ZdKQogICAgICAgIHJldHVybiBzdG9wKCk7CiAgICAgIGxldCByZXNvbHZlOwogICAgICBsZXQgcmVqZWN0OwogICAgICBjb25zdCBvbmVyciA9IChlcikgPT4gewogICAgICAgIHRoaXMub2ZmKCJkYXRhIiwgb25kYXRhKTsKICAgICAgICB0aGlzLm9mZigiZW5kIiwgb25lbmQpOwogICAgICAgIHRoaXMub2ZmKERFU1RST1lFRCwgb25kZXN0cm95KTsKICAgICAgICBzdG9wKCk7CiAgICAgICAgcmVqZWN0KGVyKTsKICAgICAgfTsKICAgICAgY29uc3Qgb25kYXRhID0gKHZhbHVlKSA9PiB7CiAgICAgICAgdGhpcy5vZmYoImVycm9yIiwgb25lcnIpOwogICAgICAgIHRoaXMub2ZmKCJlbmQiLCBvbmVuZCk7CiAgICAgICAgdGhpcy5vZmYoREVTVFJPWUVELCBvbmRlc3Ryb3kpOwogICAgICAgIHRoaXMucGF1c2UoKTsKICAgICAgICByZXNvbHZlKHsgdmFsdWUsIGRvbmU6ICEhdGhpc1tFT0ZdIH0pOwogICAgICB9OwogICAgICBjb25zdCBvbmVuZCA9ICgpID0+IHsKICAgICAgICB0aGlzLm9mZigiZXJyb3IiLCBvbmVycik7CiAgICAgICAgdGhpcy5vZmYoImRhdGEiLCBvbmRhdGEpOwogICAgICAgIHRoaXMub2ZmKERFU1RST1lFRCwgb25kZXN0cm95KTsKICAgICAgICBzdG9wKCk7CiAgICAgICAgcmVzb2x2ZSh7IGRvbmU6IHRydWUsIHZhbHVlOiB2b2lkIDAgfSk7CiAgICAgIH07CiAgICAgIGNvbnN0IG9uZGVzdHJveSA9ICgpID0+IG9uZXJyKG5ldyBFcnJvcigic3RyZWFtIGRlc3Ryb3llZCIpKTsKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXMyLCByZWopID0+IHsKICAgICAgICByZWplY3QgPSByZWo7CiAgICAgICAgcmVzb2x2ZSA9IHJlczI7CiAgICAgICAgdGhpcy5vbmNlKERFU1RST1lFRCwgb25kZXN0cm95KTsKICAgICAgICB0aGlzLm9uY2UoImVycm9yIiwgb25lcnIpOwogICAgICAgIHRoaXMub25jZSgiZW5kIiwgb25lbmQpOwogICAgICAgIHRoaXMub25jZSgiZGF0YSIsIG9uZGF0YSk7CiAgICAgIH0pOwogICAgfTsKICAgIHJldHVybiB7CiAgICAgIG5leHQsCiAgICAgIHRocm93OiBzdG9wLAogICAgICByZXR1cm46IHN0b3AsCiAgICAgIFtTeW1ib2wuYXN5bmNJdGVyYXRvcl0oKSB7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KICAgIH07CiAgfQogIC8qKgogICAqIFN5bmNocm9ub3VzIGBmb3Igb2ZgIGl0ZXJhdGlvbi4KICAgKgogICAqIFRoZSBpdGVyYXRpb24gd2lsbCB0ZXJtaW5hdGUgd2hlbiB0aGUgaW50ZXJuYWwgYnVmZmVyIHJ1bnMgb3V0LCBldmVuCiAgICogaWYgdGhlIHN0cmVhbSBoYXMgbm90IHlldCB0ZXJtaW5hdGVkLgogICAqLwogIFtTeW1ib2wuaXRlcmF0b3JdKCkgewogICAgdGhpc1tESVNDQVJERURdID0gZmFsc2U7CiAgICBsZXQgc3RvcHBlZCA9IGZhbHNlOwogICAgY29uc3Qgc3RvcCA9ICgpID0+IHsKICAgICAgdGhpcy5wYXVzZSgpOwogICAgICB0aGlzLm9mZihFUlJPUiwgc3RvcCk7CiAgICAgIHRoaXMub2ZmKERFU1RST1lFRCwgc3RvcCk7CiAgICAgIHRoaXMub2ZmKCJlbmQiLCBzdG9wKTsKICAgICAgc3RvcHBlZCA9IHRydWU7CiAgICAgIHJldHVybiB7IGRvbmU6IHRydWUsIHZhbHVlOiB2b2lkIDAgfTsKICAgIH07CiAgICBjb25zdCBuZXh0ID0gKCkgPT4gewogICAgICBpZiAoc3RvcHBlZCkKICAgICAgICByZXR1cm4gc3RvcCgpOwogICAgICBjb25zdCB2YWx1ZSA9IHRoaXMucmVhZCgpOwogICAgICByZXR1cm4gdmFsdWUgPT09IG51bGwgPyBzdG9wKCkgOiB7IGRvbmU6IGZhbHNlLCB2YWx1ZSB9OwogICAgfTsKICAgIHRoaXMub25jZSgiZW5kIiwgc3RvcCk7CiAgICB0aGlzLm9uY2UoRVJST1IsIHN0b3ApOwogICAgdGhpcy5vbmNlKERFU1RST1lFRCwgc3RvcCk7CiAgICByZXR1cm4gewogICAgICBuZXh0LAogICAgICB0aHJvdzogc3RvcCwKICAgICAgcmV0dXJuOiBzdG9wLAogICAgICBbU3ltYm9sLml0ZXJhdG9yXSgpIHsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQogICAgfTsKICB9CiAgLyoqCiAgICogRGVzdHJveSBhIHN0cmVhbSwgcHJldmVudGluZyBpdCBmcm9tIGJlaW5nIHVzZWQgZm9yIGFueSBmdXJ0aGVyIHB1cnBvc2UuCiAgICoKICAgKiBJZiB0aGUgc3RyZWFtIGhhcyBhIGBjbG9zZSgpYCBtZXRob2QsIHRoZW4gaXQgd2lsbCBiZSBjYWxsZWQgb24KICAgKiBkZXN0cnVjdGlvbi4KICAgKgogICAqIEFmdGVyIGRlc3RydWN0aW9uLCBhbnkgYXR0ZW1wdCB0byB3cml0ZSBkYXRhLCByZWFkIGRhdGEsIG9yIGVtaXQgbW9zdAogICAqIGV2ZW50cyB3aWxsIGJlIGlnbm9yZWQuCiAgICoKICAgKiBJZiBhbiBlcnJvciBhcmd1bWVudCBpcyBwcm92aWRlZCwgdGhlbiBpdCB3aWxsIGJlIGVtaXR0ZWQgaW4gYW4KICAgKiAnZXJyb3InIGV2ZW50LgogICAqLwogIGRlc3Ryb3koZXIpIHsKICAgIGlmICh0aGlzW0RFU1RST1lFRF0pIHsKICAgICAgaWYgKGVyKQogICAgICAgIHRoaXMuZW1pdCgiZXJyb3IiLCBlcik7CiAgICAgIGVsc2UKICAgICAgICB0aGlzLmVtaXQoREVTVFJPWUVEKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICB0aGlzW0RFU1RST1lFRF0gPSB0cnVlOwogICAgdGhpc1tESVNDQVJERURdID0gdHJ1ZTsKICAgIHRoaXNbQlVGRkVSXS5sZW5ndGggPSAwOwogICAgdGhpc1tCVUZGRVJMRU5HVEhdID0gMDsKICAgIGNvbnN0IHdjID0gdGhpczsKICAgIGlmICh0eXBlb2Ygd2MuY2xvc2UgPT09ICJmdW5jdGlvbiIgJiYgIXRoaXNbQ0xPU0VEXSkKICAgICAgd2MuY2xvc2UoKTsKICAgIGlmIChlcikKICAgICAgdGhpcy5lbWl0KCJlcnJvciIsIGVyKTsKICAgIGVsc2UKICAgICAgdGhpcy5lbWl0KERFU1RST1lFRCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgICogQWxpYXMgZm9yIHtAbGluayBpc1N0cmVhbX0KICAgKgogICAqIEZvcm1lciBleHBvcnQgbG9jYXRpb24sIG1haW50YWluZWQgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LgogICAqCiAgICogQGRlcHJlY2F0ZWQKICAgKi8KICBzdGF0aWMgZ2V0IGlzU3RyZWFtKCkgewogICAgcmV0dXJuIGlzU3RyZWFtOwogIH0KfQpjb25zdCByZWFscGF0aFN5bmMgPSByZWFscGF0aFN5bmMkMS5uYXRpdmU7CmNvbnN0IGRlZmF1bHRGUyA9IHsKICBsc3RhdFN5bmMsCiAgcmVhZGRpciwKICByZWFkZGlyU3luYywKICByZWFkbGlua1N5bmMsCiAgcmVhbHBhdGhTeW5jLAogIHByb21pc2VzOiB7CiAgICBsc3RhdCwKICAgIHJlYWRkaXI6IHJlYWRkaXIkMSwKICAgIHJlYWRsaW5rLAogICAgcmVhbHBhdGgKICB9Cn07CmNvbnN0IGZzRnJvbU9wdGlvbiA9IChmc09wdGlvbikgPT4gIWZzT3B0aW9uIHx8IGZzT3B0aW9uID09PSBkZWZhdWx0RlMgfHwgZnNPcHRpb24gPT09IHJlcXVpcmUkJDAgPyBkZWZhdWx0RlMgOiB7CiAgLi4uZGVmYXVsdEZTLAogIC4uLmZzT3B0aW9uLAogIHByb21pc2VzOiB7CiAgICAuLi5kZWZhdWx0RlMucHJvbWlzZXMsCiAgICAuLi5mc09wdGlvbi5wcm9taXNlcyB8fCB7fQogIH0KfTsKY29uc3QgdW5jRHJpdmVSZWdleHAgPSAvXlxcXFxcP1xcKFthLXpdOilcXD8kL2k7CmNvbnN0IHVuY1RvRHJpdmUgPSAocm9vdFBhdGgpID0+IHJvb3RQYXRoLnJlcGxhY2UoL1wvL2csICJcXCIpLnJlcGxhY2UodW5jRHJpdmVSZWdleHAsICIkMVxcIik7CmNvbnN0IGVpdGhlclNlcCA9IC9bXFxcL10vOwpjb25zdCBVTktOT1dOID0gMDsKY29uc3QgSUZJRk8gPSAxOwpjb25zdCBJRkNIUiA9IDI7CmNvbnN0IElGRElSID0gNDsKY29uc3QgSUZCTEsgPSA2Owpjb25zdCBJRlJFRyA9IDg7CmNvbnN0IElGTE5LID0gMTA7CmNvbnN0IElGU09DSyA9IDEyOwpjb25zdCBJRk1UID0gMTU7CmNvbnN0IElGTVRfVU5LTk9XTiA9IH5JRk1UOwpjb25zdCBSRUFERElSX0NBTExFRCA9IDE2Owpjb25zdCBMU1RBVF9DQUxMRUQgPSAzMjsKY29uc3QgRU5PVERJUiA9IDY0Owpjb25zdCBFTk9FTlQgPSAxMjg7CmNvbnN0IEVOT1JFQURMSU5LID0gMjU2Owpjb25zdCBFTk9SRUFMUEFUSCA9IDUxMjsKY29uc3QgRU5PQ0hJTEQgPSBFTk9URElSIHwgRU5PRU5UIHwgRU5PUkVBTFBBVEg7CmNvbnN0IFRZUEVNQVNLID0gMTAyMzsKY29uc3QgZW50VG9UeXBlID0gKHMpID0+IHMuaXNGaWxlKCkgPyBJRlJFRyA6IHMuaXNEaXJlY3RvcnkoKSA/IElGRElSIDogcy5pc1N5bWJvbGljTGluaygpID8gSUZMTksgOiBzLmlzQ2hhcmFjdGVyRGV2aWNlKCkgPyBJRkNIUiA6IHMuaXNCbG9ja0RldmljZSgpID8gSUZCTEsgOiBzLmlzU29ja2V0KCkgPyBJRlNPQ0sgOiBzLmlzRklGTygpID8gSUZJRk8gOiBVTktOT1dOOwpjb25zdCBub3JtYWxpemVDYWNoZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CmNvbnN0IG5vcm1hbGl6ZSA9IChzKSA9PiB7CiAgY29uc3QgYyA9IG5vcm1hbGl6ZUNhY2hlLmdldChzKTsKICBpZiAoYykKICAgIHJldHVybiBjOwogIGNvbnN0IG4gPSBzLm5vcm1hbGl6ZSgiTkZLRCIpOwogIG5vcm1hbGl6ZUNhY2hlLnNldChzLCBuKTsKICByZXR1cm4gbjsKfTsKY29uc3Qgbm9ybWFsaXplTm9jYXNlQ2FjaGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwpjb25zdCBub3JtYWxpemVOb2Nhc2UgPSAocykgPT4gewogIGNvbnN0IGMgPSBub3JtYWxpemVOb2Nhc2VDYWNoZS5nZXQocyk7CiAgaWYgKGMpCiAgICByZXR1cm4gYzsKICBjb25zdCBuID0gbm9ybWFsaXplKHMudG9Mb3dlckNhc2UoKSk7CiAgbm9ybWFsaXplTm9jYXNlQ2FjaGUuc2V0KHMsIG4pOwogIHJldHVybiBuOwp9OwpjbGFzcyBSZXNvbHZlQ2FjaGUgZXh0ZW5kcyBMUlVDYWNoZSB7CiAgY29uc3RydWN0b3IoKSB7CiAgICBzdXBlcih7IG1heDogMjU2IH0pOwogIH0KfQpjbGFzcyBDaGlsZHJlbkNhY2hlIGV4dGVuZHMgTFJVQ2FjaGUgewogIGNvbnN0cnVjdG9yKG1heFNpemUgPSAxNiAqIDEwMjQpIHsKICAgIHN1cGVyKHsKICAgICAgbWF4U2l6ZSwKICAgICAgLy8gcGFyZW50ICsgY2hpbGRyZW4KICAgICAgc2l6ZUNhbGN1bGF0aW9uOiAoYSkgPT4gYS5sZW5ndGggKyAxCiAgICB9KTsKICB9Cn0KY29uc3Qgc2V0QXNDd2QgPSBTeW1ib2woIlBhdGhTY3Vycnkgc2V0QXNDd2QiKTsKY2xhc3MgUGF0aEJhc2UgewogIC8qKgogICAqIHRoZSBiYXNlbmFtZSBvZiB0aGlzIHBhdGgKICAgKgogICAqICoqSW1wb3J0YW50Kio6ICphbHdheXMqIHRlc3QgdGhlIHBhdGggbmFtZSBhZ2FpbnN0IGFueSB0ZXN0IHN0cmluZwogICAqIHVzaW5ndGhlIHtAbGluayBpc05hbWVkfSBtZXRob2QsIGFuZCBub3QgYnkgZGlyZWN0bHkgY29tcGFyaW5nIHRoaXMKICAgKiBzdHJpbmcuIE90aGVyd2lzZSwgdW5pY29kZSBwYXRoIHN0cmluZ3MgdGhhdCB0aGUgc3lzdGVtIHNlZXMgYXMgaWRlbnRpY2FsCiAgICogd2lsbCBub3QgYmUgcHJvcGVybHkgdHJlYXRlZCBhcyB0aGUgc2FtZSBwYXRoLCBsZWFkaW5nIHRvIGluY29ycmVjdAogICAqIGJlaGF2aW9yIGFuZCBwb3NzaWJsZSBzZWN1cml0eSBpc3N1ZXMuCiAgICovCiAgbmFtZTsKICAvKioKICAgKiB0aGUgUGF0aCBlbnRyeSBjb3JyZXNwb25kaW5nIHRvIHRoZSBwYXRoIHJvb3QuCiAgICoKICAgKiBAaW50ZXJuYWwKICAgKi8KICByb290OwogIC8qKgogICAqIEFsbCByb290cyBmb3VuZCB3aXRoaW4gdGhlIGN1cnJlbnQgUGF0aFNjdXJyeSBmYW1pbHkKICAgKgogICAqIEBpbnRlcm5hbAogICAqLwogIHJvb3RzOwogIC8qKgogICAqIGEgcmVmZXJlbmNlIHRvIHRoZSBwYXJlbnQgcGF0aCwgb3IgdW5kZWZpbmVkIGluIHRoZSBjYXNlIG9mIHJvb3QgZW50cmllcwogICAqCiAgICogQGludGVybmFsCiAgICovCiAgcGFyZW50OwogIC8qKgogICAqIGJvb2xlYW4gaW5kaWNhdGluZyB3aGV0aGVyIHBhdGhzIGFyZSBjb21wYXJlZCBjYXNlLWluc2Vuc2l0aXZlbHkKICAgKiBAaW50ZXJuYWwKICAgKi8KICBub2Nhc2U7CiAgLy8gcG90ZW50aWFsIGRlZmF1bHQgZnMgb3ZlcnJpZGUKICAjZnM7CiAgLy8gU3RhdHMgZmllbGRzCiAgI2RldjsKICBnZXQgZGV2KCkgewogICAgcmV0dXJuIHRoaXMuI2RldjsKICB9CiAgI21vZGU7CiAgZ2V0IG1vZGUoKSB7CiAgICByZXR1cm4gdGhpcy4jbW9kZTsKICB9CiAgI25saW5rOwogIGdldCBubGluaygpIHsKICAgIHJldHVybiB0aGlzLiNubGluazsKICB9CiAgI3VpZDsKICBnZXQgdWlkKCkgewogICAgcmV0dXJuIHRoaXMuI3VpZDsKICB9CiAgI2dpZDsKICBnZXQgZ2lkKCkgewogICAgcmV0dXJuIHRoaXMuI2dpZDsKICB9CiAgI3JkZXY7CiAgZ2V0IHJkZXYoKSB7CiAgICByZXR1cm4gdGhpcy4jcmRldjsKICB9CiAgI2Jsa3NpemU7CiAgZ2V0IGJsa3NpemUoKSB7CiAgICByZXR1cm4gdGhpcy4jYmxrc2l6ZTsKICB9CiAgI2lubzsKICBnZXQgaW5vKCkgewogICAgcmV0dXJuIHRoaXMuI2lubzsKICB9CiAgI3NpemU7CiAgZ2V0IHNpemUoKSB7CiAgICByZXR1cm4gdGhpcy4jc2l6ZTsKICB9CiAgI2Jsb2NrczsKICBnZXQgYmxvY2tzKCkgewogICAgcmV0dXJuIHRoaXMuI2Jsb2NrczsKICB9CiAgI2F0aW1lTXM7CiAgZ2V0IGF0aW1lTXMoKSB7CiAgICByZXR1cm4gdGhpcy4jYXRpbWVNczsKICB9CiAgI210aW1lTXM7CiAgZ2V0IG10aW1lTXMoKSB7CiAgICByZXR1cm4gdGhpcy4jbXRpbWVNczsKICB9CiAgI2N0aW1lTXM7CiAgZ2V0IGN0aW1lTXMoKSB7CiAgICByZXR1cm4gdGhpcy4jY3RpbWVNczsKICB9CiAgI2JpcnRodGltZU1zOwogIGdldCBiaXJ0aHRpbWVNcygpIHsKICAgIHJldHVybiB0aGlzLiNiaXJ0aHRpbWVNczsKICB9CiAgI2F0aW1lOwogIGdldCBhdGltZSgpIHsKICAgIHJldHVybiB0aGlzLiNhdGltZTsKICB9CiAgI210aW1lOwogIGdldCBtdGltZSgpIHsKICAgIHJldHVybiB0aGlzLiNtdGltZTsKICB9CiAgI2N0aW1lOwogIGdldCBjdGltZSgpIHsKICAgIHJldHVybiB0aGlzLiNjdGltZTsKICB9CiAgI2JpcnRodGltZTsKICBnZXQgYmlydGh0aW1lKCkgewogICAgcmV0dXJuIHRoaXMuI2JpcnRodGltZTsKICB9CiAgI21hdGNoTmFtZTsKICAjZGVwdGg7CiAgI2Z1bGxwYXRoOwogICNmdWxscGF0aFBvc2l4OwogICNyZWxhdGl2ZTsKICAjcmVsYXRpdmVQb3NpeDsKICAjdHlwZTsKICAjY2hpbGRyZW47CiAgI2xpbmtUYXJnZXQ7CiAgI3JlYWxwYXRoOwogIC8qKgogICAqIFRoaXMgcHJvcGVydHkgaXMgZm9yIGNvbXBhdGliaWxpdHkgd2l0aCB0aGUgRGlyZW50IGNsYXNzIGFzIG9mCiAgICogTm9kZSB2MjAsIHdoZXJlIERpcmVudFsncGF0aCddIHJlZmVycyB0byB0aGUgcGF0aCBvZiB0aGUgZGlyZWN0b3J5CiAgICogdGhhdCB3YXMgcGFzc2VkIHRvIHJlYWRkaXIuICBTbywgc29tZXdoYXQgY291bnRlcmludHVpdGl2ZWx5LCB0aGlzCiAgICogcHJvcGVydHkgcmVmZXJzIHRvIHRoZSAqcGFyZW50KiBwYXRoLCBub3QgdGhlIHBhdGggb2JqZWN0IGl0c2VsZi4KICAgKiBGb3Igcm9vdCBlbnRyaWVzLCBpdCdzIHRoZSBwYXRoIHRvIHRoZSBlbnRyeSBpdHNlbGYuCiAgICovCiAgZ2V0IHBhdGgoKSB7CiAgICByZXR1cm4gKHRoaXMucGFyZW50IHx8IHRoaXMpLmZ1bGxwYXRoKCk7CiAgfQogIC8qKgogICAqIERvIG5vdCBjcmVhdGUgbmV3IFBhdGggb2JqZWN0cyBkaXJlY3RseS4gIFRoZXkgc2hvdWxkIGFsd2F5cyBiZSBhY2Nlc3NlZAogICAqIHZpYSB0aGUgUGF0aFNjdXJyeSBjbGFzcyBvciBvdGhlciBtZXRob2RzIG9uIHRoZSBQYXRoIGNsYXNzLgogICAqCiAgICogQGludGVybmFsCiAgICovCiAgY29uc3RydWN0b3IobmFtZSwgdHlwZSA9IFVOS05PV04sIHJvb3QsIHJvb3RzLCBub2Nhc2UsIGNoaWxkcmVuLCBvcHRzKSB7CiAgICB0aGlzLm5hbWUgPSBuYW1lOwogICAgdGhpcy4jbWF0Y2hOYW1lID0gbm9jYXNlID8gbm9ybWFsaXplTm9jYXNlKG5hbWUpIDogbm9ybWFsaXplKG5hbWUpOwogICAgdGhpcy4jdHlwZSA9IHR5cGUgJiBUWVBFTUFTSzsKICAgIHRoaXMubm9jYXNlID0gbm9jYXNlOwogICAgdGhpcy5yb290cyA9IHJvb3RzOwogICAgdGhpcy5yb290ID0gcm9vdCB8fCB0aGlzOwogICAgdGhpcy4jY2hpbGRyZW4gPSBjaGlsZHJlbjsKICAgIHRoaXMuI2Z1bGxwYXRoID0gb3B0cy5mdWxscGF0aDsKICAgIHRoaXMuI3JlbGF0aXZlID0gb3B0cy5yZWxhdGl2ZTsKICAgIHRoaXMuI3JlbGF0aXZlUG9zaXggPSBvcHRzLnJlbGF0aXZlUG9zaXg7CiAgICB0aGlzLnBhcmVudCA9IG9wdHMucGFyZW50OwogICAgaWYgKHRoaXMucGFyZW50KSB7CiAgICAgIHRoaXMuI2ZzID0gdGhpcy5wYXJlbnQuI2ZzOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy4jZnMgPSBmc0Zyb21PcHRpb24ob3B0cy5mcyk7CiAgICB9CiAgfQogIC8qKgogICAqIFJldHVybnMgdGhlIGRlcHRoIG9mIHRoZSBQYXRoIG9iamVjdCBmcm9tIGl0cyByb290LgogICAqCiAgICogRm9yIGV4YW1wbGUsIGEgcGF0aCBhdCBgL2Zvby9iYXJgIHdvdWxkIGhhdmUgYSBkZXB0aCBvZiAyLgogICAqLwogIGRlcHRoKCkgewogICAgaWYgKHRoaXMuI2RlcHRoICE9PSB2b2lkIDApCiAgICAgIHJldHVybiB0aGlzLiNkZXB0aDsKICAgIGlmICghdGhpcy5wYXJlbnQpCiAgICAgIHJldHVybiB0aGlzLiNkZXB0aCA9IDA7CiAgICByZXR1cm4gdGhpcy4jZGVwdGggPSB0aGlzLnBhcmVudC5kZXB0aCgpICsgMTsKICB9CiAgLyoqCiAgICogQGludGVybmFsCiAgICovCiAgY2hpbGRyZW5DYWNoZSgpIHsKICAgIHJldHVybiB0aGlzLiNjaGlsZHJlbjsKICB9CiAgLyoqCiAgICogR2V0IHRoZSBQYXRoIG9iamVjdCByZWZlcmVuY2VkIGJ5IHRoZSBzdHJpbmcgcGF0aCwgcmVzb2x2ZWQgZnJvbSB0aGlzIFBhdGgKICAgKi8KICByZXNvbHZlKHBhdGgyKSB7CiAgICBpZiAoIXBhdGgyKSB7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgY29uc3Qgcm9vdFBhdGggPSB0aGlzLmdldFJvb3RTdHJpbmcocGF0aDIpOwogICAgY29uc3QgZGlyID0gcGF0aDIuc3Vic3RyaW5nKHJvb3RQYXRoLmxlbmd0aCk7CiAgICBjb25zdCBkaXJQYXJ0cyA9IGRpci5zcGxpdCh0aGlzLnNwbGl0U2VwKTsKICAgIGNvbnN0IHJlc3VsdCA9IHJvb3RQYXRoID8gdGhpcy5nZXRSb290KHJvb3RQYXRoKS4jcmVzb2x2ZVBhcnRzKGRpclBhcnRzKSA6IHRoaXMuI3Jlc29sdmVQYXJ0cyhkaXJQYXJ0cyk7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICAjcmVzb2x2ZVBhcnRzKGRpclBhcnRzKSB7CiAgICBsZXQgcCA9IHRoaXM7CiAgICBmb3IgKGNvbnN0IHBhcnQgb2YgZGlyUGFydHMpIHsKICAgICAgcCA9IHAuY2hpbGQocGFydCk7CiAgICB9CiAgICByZXR1cm4gcDsKICB9CiAgLyoqCiAgICogUmV0dXJucyB0aGUgY2FjaGVkIGNoaWxkcmVuIFBhdGggb2JqZWN0cywgaWYgc3RpbGwgYXZhaWxhYmxlLiAgSWYgdGhleQogICAqIGhhdmUgZmFsbGVuIG91dCBvZiB0aGUgY2FjaGUsIHRoZW4gcmV0dXJucyBhbiBlbXB0eSBhcnJheSwgYW5kIHJlc2V0cyB0aGUKICAgKiBSRUFERElSX0NBTExFRCBiaXQsIHNvIHRoYXQgZnV0dXJlIGNhbGxzIHRvIHJlYWRkaXIoKSB3aWxsIHJlcXVpcmUgYW4gZnMKICAgKiBsb29rdXAuCiAgICoKICAgKiBAaW50ZXJuYWwKICAgKi8KICBjaGlsZHJlbigpIHsKICAgIGNvbnN0IGNhY2hlZCA9IHRoaXMuI2NoaWxkcmVuLmdldCh0aGlzKTsKICAgIGlmIChjYWNoZWQpIHsKICAgICAgcmV0dXJuIGNhY2hlZDsKICAgIH0KICAgIGNvbnN0IGNoaWxkcmVuID0gT2JqZWN0LmFzc2lnbihbXSwgeyBwcm92aXNpb25hbDogMCB9KTsKICAgIHRoaXMuI2NoaWxkcmVuLnNldCh0aGlzLCBjaGlsZHJlbik7CiAgICB0aGlzLiN0eXBlICY9IH5SRUFERElSX0NBTExFRDsKICAgIHJldHVybiBjaGlsZHJlbjsKICB9CiAgLyoqCiAgICogUmVzb2x2ZXMgYSBwYXRoIHBvcnRpb24gYW5kIHJldHVybnMgb3IgY3JlYXRlcyB0aGUgY2hpbGQgUGF0aC4KICAgKgogICAqIFJldHVybnMgYHRoaXNgIGlmIHBhdGhQYXJ0IGlzIGAnJ2Agb3IgYCcuJ2AsIG9yIGBwYXJlbnRgIGlmIHBhdGhQYXJ0IGlzCiAgICogYCcuLidgLgogICAqCiAgICogVGhpcyBzaG91bGQgbm90IGJlIGNhbGxlZCBkaXJlY3RseS4gIElmIGBwYXRoUGFydGAgY29udGFpbnMgYW55IHBhdGgKICAgKiBzZXBhcmF0b3JzLCBpdCB3aWxsIGxlYWQgdG8gdW5zYWZlIHVuZGVmaW5lZCBiZWhhdmlvci4KICAgKgogICAqIFVzZSBgUGF0aC5yZXNvbHZlKClgIGluc3RlYWQuCiAgICoKICAgKiBAaW50ZXJuYWwKICAgKi8KICBjaGlsZChwYXRoUGFydCwgb3B0cykgewogICAgaWYgKHBhdGhQYXJ0ID09PSAiIiB8fCBwYXRoUGFydCA9PT0gIi4iKSB7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgaWYgKHBhdGhQYXJ0ID09PSAiLi4iKSB7CiAgICAgIHJldHVybiB0aGlzLnBhcmVudCB8fCB0aGlzOwogICAgfQogICAgY29uc3QgY2hpbGRyZW4gPSB0aGlzLmNoaWxkcmVuKCk7CiAgICBjb25zdCBuYW1lID0gdGhpcy5ub2Nhc2UgPyBub3JtYWxpemVOb2Nhc2UocGF0aFBhcnQpIDogbm9ybWFsaXplKHBhdGhQYXJ0KTsKICAgIGZvciAoY29uc3QgcCBvZiBjaGlsZHJlbikgewogICAgICBpZiAocC4jbWF0Y2hOYW1lID09PSBuYW1lKSB7CiAgICAgICAgcmV0dXJuIHA7CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IHMgPSB0aGlzLnBhcmVudCA/IHRoaXMuc2VwIDogIiI7CiAgICBjb25zdCBmdWxscGF0aCA9IHRoaXMuI2Z1bGxwYXRoID8gdGhpcy4jZnVsbHBhdGggKyBzICsgcGF0aFBhcnQgOiB2b2lkIDA7CiAgICBjb25zdCBwY2hpbGQgPSB0aGlzLm5ld0NoaWxkKHBhdGhQYXJ0LCBVTktOT1dOLCB7CiAgICAgIC4uLm9wdHMsCiAgICAgIHBhcmVudDogdGhpcywKICAgICAgZnVsbHBhdGgKICAgIH0pOwogICAgaWYgKCF0aGlzLmNhblJlYWRkaXIoKSkgewogICAgICBwY2hpbGQuI3R5cGUgfD0gRU5PRU5UOwogICAgfQogICAgY2hpbGRyZW4ucHVzaChwY2hpbGQpOwogICAgcmV0dXJuIHBjaGlsZDsKICB9CiAgLyoqCiAgICogVGhlIHJlbGF0aXZlIHBhdGggZnJvbSB0aGUgY3dkLiBJZiBpdCBkb2VzIG5vdCBzaGFyZSBhbiBhbmNlc3RvciB3aXRoCiAgICogdGhlIGN3ZCwgdGhlbiB0aGlzIGVuZHMgdXAgYmVpbmcgZXF1aXZhbGVudCB0byB0aGUgZnVsbHBhdGgoKQogICAqLwogIHJlbGF0aXZlKCkgewogICAgaWYgKHRoaXMuI3JlbGF0aXZlICE9PSB2b2lkIDApIHsKICAgICAgcmV0dXJuIHRoaXMuI3JlbGF0aXZlOwogICAgfQogICAgY29uc3QgbmFtZSA9IHRoaXMubmFtZTsKICAgIGNvbnN0IHAgPSB0aGlzLnBhcmVudDsKICAgIGlmICghcCkgewogICAgICByZXR1cm4gdGhpcy4jcmVsYXRpdmUgPSB0aGlzLm5hbWU7CiAgICB9CiAgICBjb25zdCBwdiA9IHAucmVsYXRpdmUoKTsKICAgIHJldHVybiBwdiArICghcHYgfHwgIXAucGFyZW50ID8gIiIgOiB0aGlzLnNlcCkgKyBuYW1lOwogIH0KICAvKioKICAgKiBUaGUgcmVsYXRpdmUgcGF0aCBmcm9tIHRoZSBjd2QsIHVzaW5nIC8gYXMgdGhlIHBhdGggc2VwYXJhdG9yLgogICAqIElmIGl0IGRvZXMgbm90IHNoYXJlIGFuIGFuY2VzdG9yIHdpdGgKICAgKiB0aGUgY3dkLCB0aGVuIHRoaXMgZW5kcyB1cCBiZWluZyBlcXVpdmFsZW50IHRvIHRoZSBmdWxscGF0aFBvc2l4KCkKICAgKiBPbiBwb3NpeCBzeXN0ZW1zLCB0aGlzIGlzIGlkZW50aWNhbCB0byByZWxhdGl2ZSgpLgogICAqLwogIHJlbGF0aXZlUG9zaXgoKSB7CiAgICBpZiAodGhpcy5zZXAgPT09ICIvIikKICAgICAgcmV0dXJuIHRoaXMucmVsYXRpdmUoKTsKICAgIGlmICh0aGlzLiNyZWxhdGl2ZVBvc2l4ICE9PSB2b2lkIDApCiAgICAgIHJldHVybiB0aGlzLiNyZWxhdGl2ZVBvc2l4OwogICAgY29uc3QgbmFtZSA9IHRoaXMubmFtZTsKICAgIGNvbnN0IHAgPSB0aGlzLnBhcmVudDsKICAgIGlmICghcCkgewogICAgICByZXR1cm4gdGhpcy4jcmVsYXRpdmVQb3NpeCA9IHRoaXMuZnVsbHBhdGhQb3NpeCgpOwogICAgfQogICAgY29uc3QgcHYgPSBwLnJlbGF0aXZlUG9zaXgoKTsKICAgIHJldHVybiBwdiArICghcHYgfHwgIXAucGFyZW50ID8gIiIgOiAiLyIpICsgbmFtZTsKICB9CiAgLyoqCiAgICogVGhlIGZ1bGx5IHJlc29sdmVkIHBhdGggc3RyaW5nIGZvciB0aGlzIFBhdGggZW50cnkKICAgKi8KICBmdWxscGF0aCgpIHsKICAgIGlmICh0aGlzLiNmdWxscGF0aCAhPT0gdm9pZCAwKSB7CiAgICAgIHJldHVybiB0aGlzLiNmdWxscGF0aDsKICAgIH0KICAgIGNvbnN0IG5hbWUgPSB0aGlzLm5hbWU7CiAgICBjb25zdCBwID0gdGhpcy5wYXJlbnQ7CiAgICBpZiAoIXApIHsKICAgICAgcmV0dXJuIHRoaXMuI2Z1bGxwYXRoID0gdGhpcy5uYW1lOwogICAgfQogICAgY29uc3QgcHYgPSBwLmZ1bGxwYXRoKCk7CiAgICBjb25zdCBmcCA9IHB2ICsgKCFwLnBhcmVudCA/ICIiIDogdGhpcy5zZXApICsgbmFtZTsKICAgIHJldHVybiB0aGlzLiNmdWxscGF0aCA9IGZwOwogIH0KICAvKioKICAgKiBPbiBwbGF0Zm9ybXMgb3RoZXIgdGhhbiB3aW5kb3dzLCB0aGlzIGlzIGlkZW50aWNhbCB0byBmdWxscGF0aC4KICAgKgogICAqIE9uIHdpbmRvd3MsIHRoaXMgaXMgb3ZlcnJpZGRlbiB0byByZXR1cm4gdGhlIGZvcndhcmQtc2xhc2ggZm9ybSBvZiB0aGUKICAgKiBmdWxsIFVOQyBwYXRoLgogICAqLwogIGZ1bGxwYXRoUG9zaXgoKSB7CiAgICBpZiAodGhpcy4jZnVsbHBhdGhQb3NpeCAhPT0gdm9pZCAwKQogICAgICByZXR1cm4gdGhpcy4jZnVsbHBhdGhQb3NpeDsKICAgIGlmICh0aGlzLnNlcCA9PT0gIi8iKQogICAgICByZXR1cm4gdGhpcy4jZnVsbHBhdGhQb3NpeCA9IHRoaXMuZnVsbHBhdGgoKTsKICAgIGlmICghdGhpcy5wYXJlbnQpIHsKICAgICAgY29uc3QgcDIgPSB0aGlzLmZ1bGxwYXRoKCkucmVwbGFjZSgvXFwvZywgIi8iKTsKICAgICAgaWYgKC9eW2Etel06XC8vaS50ZXN0KHAyKSkgewogICAgICAgIHJldHVybiB0aGlzLiNmdWxscGF0aFBvc2l4ID0gYC8vPy8ke3AyfWA7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHRoaXMuI2Z1bGxwYXRoUG9zaXggPSBwMjsKICAgICAgfQogICAgfQogICAgY29uc3QgcCA9IHRoaXMucGFyZW50OwogICAgY29uc3QgcGZwcCA9IHAuZnVsbHBhdGhQb3NpeCgpOwogICAgY29uc3QgZnBwID0gcGZwcCArICghcGZwcCB8fCAhcC5wYXJlbnQgPyAiIiA6ICIvIikgKyB0aGlzLm5hbWU7CiAgICByZXR1cm4gdGhpcy4jZnVsbHBhdGhQb3NpeCA9IGZwcDsKICB9CiAgLyoqCiAgICogSXMgdGhlIFBhdGggb2YgYW4gdW5rbm93biB0eXBlPwogICAqCiAgICogTm90ZSB0aGF0IHdlIG1pZ2h0IGtub3cgKnNvbWV0aGluZyogYWJvdXQgaXQgaWYgdGhlcmUgaGFzIGJlZW4gYSBwcmV2aW91cwogICAqIGZpbGVzeXN0ZW0gb3BlcmF0aW9uLCBmb3IgZXhhbXBsZSB0aGF0IGl0IGRvZXMgbm90IGV4aXN0LCBvciBpcyBub3QgYQogICAqIGxpbmssIG9yIHdoZXRoZXIgaXQgaGFzIGNoaWxkIGVudHJpZXMuCiAgICovCiAgaXNVbmtub3duKCkgewogICAgcmV0dXJuICh0aGlzLiN0eXBlICYgSUZNVCkgPT09IFVOS05PV047CiAgfQogIGlzVHlwZSh0eXBlKSB7CiAgICByZXR1cm4gdGhpc1tgaXMke3R5cGV9YF0oKTsKICB9CiAgZ2V0VHlwZSgpIHsKICAgIHJldHVybiB0aGlzLmlzVW5rbm93bigpID8gIlVua25vd24iIDogdGhpcy5pc0RpcmVjdG9yeSgpID8gIkRpcmVjdG9yeSIgOiB0aGlzLmlzRmlsZSgpID8gIkZpbGUiIDogdGhpcy5pc1N5bWJvbGljTGluaygpID8gIlN5bWJvbGljTGluayIgOiB0aGlzLmlzRklGTygpID8gIkZJRk8iIDogdGhpcy5pc0NoYXJhY3RlckRldmljZSgpID8gIkNoYXJhY3RlckRldmljZSIgOiB0aGlzLmlzQmxvY2tEZXZpY2UoKSA/ICJCbG9ja0RldmljZSIgOiAoCiAgICAgIC8qIGM4IGlnbm9yZSBzdGFydCAqLwogICAgICB0aGlzLmlzU29ja2V0KCkgPyAiU29ja2V0IiA6ICJVbmtub3duIgogICAgKTsKICB9CiAgLyoqCiAgICogSXMgdGhlIFBhdGggYSByZWd1bGFyIGZpbGU/CiAgICovCiAgaXNGaWxlKCkgewogICAgcmV0dXJuICh0aGlzLiN0eXBlICYgSUZNVCkgPT09IElGUkVHOwogIH0KICAvKioKICAgKiBJcyB0aGUgUGF0aCBhIGRpcmVjdG9yeT8KICAgKi8KICBpc0RpcmVjdG9yeSgpIHsKICAgIHJldHVybiAodGhpcy4jdHlwZSAmIElGTVQpID09PSBJRkRJUjsKICB9CiAgLyoqCiAgICogSXMgdGhlIHBhdGggYSBjaGFyYWN0ZXIgZGV2aWNlPwogICAqLwogIGlzQ2hhcmFjdGVyRGV2aWNlKCkgewogICAgcmV0dXJuICh0aGlzLiN0eXBlICYgSUZNVCkgPT09IElGQ0hSOwogIH0KICAvKioKICAgKiBJcyB0aGUgcGF0aCBhIGJsb2NrIGRldmljZT8KICAgKi8KICBpc0Jsb2NrRGV2aWNlKCkgewogICAgcmV0dXJuICh0aGlzLiN0eXBlICYgSUZNVCkgPT09IElGQkxLOwogIH0KICAvKioKICAgKiBJcyB0aGUgcGF0aCBhIEZJRk8gcGlwZT8KICAgKi8KICBpc0ZJRk8oKSB7CiAgICByZXR1cm4gKHRoaXMuI3R5cGUgJiBJRk1UKSA9PT0gSUZJRk87CiAgfQogIC8qKgogICAqIElzIHRoZSBwYXRoIGEgc29ja2V0PwogICAqLwogIGlzU29ja2V0KCkgewogICAgcmV0dXJuICh0aGlzLiN0eXBlICYgSUZNVCkgPT09IElGU09DSzsKICB9CiAgLyoqCiAgICogSXMgdGhlIHBhdGggYSBzeW1ib2xpYyBsaW5rPwogICAqLwogIGlzU3ltYm9saWNMaW5rKCkgewogICAgcmV0dXJuICh0aGlzLiN0eXBlICYgSUZMTkspID09PSBJRkxOSzsKICB9CiAgLyoqCiAgICogUmV0dXJuIHRoZSBlbnRyeSBpZiBpdCBoYXMgYmVlbiBzdWJqZWN0IG9mIGEgc3VjY2Vzc2Z1bCBsc3RhdCwgb3IKICAgKiB1bmRlZmluZWQgb3RoZXJ3aXNlLgogICAqCiAgICogRG9lcyBub3QgcmVhZCB0aGUgZmlsZXN5c3RlbSwgc28gYW4gdW5kZWZpbmVkIHJlc3VsdCAqY291bGQqIHNpbXBseQogICAqIG1lYW4gdGhhdCB3ZSBoYXZlbid0IGNhbGxlZCBsc3RhdCBvbiBpdC4KICAgKi8KICBsc3RhdENhY2hlZCgpIHsKICAgIHJldHVybiB0aGlzLiN0eXBlICYgTFNUQVRfQ0FMTEVEID8gdGhpcyA6IHZvaWQgMDsKICB9CiAgLyoqCiAgICogUmV0dXJuIHRoZSBjYWNoZWQgbGluayB0YXJnZXQgaWYgdGhlIGVudHJ5IGhhcyBiZWVuIHRoZSBzdWJqZWN0IG9mIGEKICAgKiBzdWNjZXNzZnVsIHJlYWRsaW5rLCBvciB1bmRlZmluZWQgb3RoZXJ3aXNlLgogICAqCiAgICogRG9lcyBub3QgcmVhZCB0aGUgZmlsZXN5c3RlbSwgc28gYW4gdW5kZWZpbmVkIHJlc3VsdCAqY291bGQqIGp1c3QgbWVhbiB3ZQogICAqIGRvbid0IGhhdmUgYW55IGNhY2hlZCBkYXRhLiBPbmx5IHVzZSBpdCBpZiB5b3UgYXJlIHZlcnkgc3VyZSB0aGF0IGEKICAgKiByZWFkbGluaygpIGhhcyBiZWVuIGNhbGxlZCBhdCBzb21lIHBvaW50LgogICAqLwogIHJlYWRsaW5rQ2FjaGVkKCkgewogICAgcmV0dXJuIHRoaXMuI2xpbmtUYXJnZXQ7CiAgfQogIC8qKgogICAqIFJldHVybnMgdGhlIGNhY2hlZCByZWFscGF0aCB0YXJnZXQgaWYgdGhlIGVudHJ5IGhhcyBiZWVuIHRoZSBzdWJqZWN0CiAgICogb2YgYSBzdWNjZXNzZnVsIHJlYWxwYXRoLCBvciB1bmRlZmluZWQgb3RoZXJ3aXNlLgogICAqCiAgICogRG9lcyBub3QgcmVhZCB0aGUgZmlsZXN5c3RlbSwgc28gYW4gdW5kZWZpbmVkIHJlc3VsdCAqY291bGQqIGp1c3QgbWVhbiB3ZQogICAqIGRvbid0IGhhdmUgYW55IGNhY2hlZCBkYXRhLiBPbmx5IHVzZSBpdCBpZiB5b3UgYXJlIHZlcnkgc3VyZSB0aGF0IGEKICAgKiByZWFscGF0aCgpIGhhcyBiZWVuIGNhbGxlZCBhdCBzb21lIHBvaW50LgogICAqLwogIHJlYWxwYXRoQ2FjaGVkKCkgewogICAgcmV0dXJuIHRoaXMuI3JlYWxwYXRoOwogIH0KICAvKioKICAgKiBSZXR1cm5zIHRoZSBjYWNoZWQgY2hpbGQgUGF0aCBlbnRyaWVzIGFycmF5IGlmIHRoZSBlbnRyeSBoYXMgYmVlbiB0aGUKICAgKiBzdWJqZWN0IG9mIGEgc3VjY2Vzc2Z1bCByZWFkZGlyKCksIG9yIFtdIG90aGVyd2lzZS4KICAgKgogICAqIERvZXMgbm90IHJlYWQgdGhlIGZpbGVzeXN0ZW0sIHNvIGFuIGVtcHR5IGFycmF5ICpjb3VsZCoganVzdCBtZWFuIHdlCiAgICogZG9uJ3QgaGF2ZSBhbnkgY2FjaGVkIGRhdGEuIE9ubHkgdXNlIGl0IGlmIHlvdSBhcmUgdmVyeSBzdXJlIHRoYXQgYQogICAqIHJlYWRkaXIoKSBoYXMgYmVlbiBjYWxsZWQgcmVjZW50bHkgZW5vdWdoIHRvIHN0aWxsIGJlIHZhbGlkLgogICAqLwogIHJlYWRkaXJDYWNoZWQoKSB7CiAgICBjb25zdCBjaGlsZHJlbiA9IHRoaXMuY2hpbGRyZW4oKTsKICAgIHJldHVybiBjaGlsZHJlbi5zbGljZSgwLCBjaGlsZHJlbi5wcm92aXNpb25hbCk7CiAgfQogIC8qKgogICAqIFJldHVybiB0cnVlIGlmIGl0J3Mgd29ydGggdHJ5aW5nIHRvIHJlYWRsaW5rLiAgSWUsIHdlIGRvbid0ICh5ZXQpIGhhdmUKICAgKiBhbnkgaW5kaWNhdGlvbiB0aGF0IHJlYWRsaW5rIHdpbGwgZGVmaW5pdGVseSBmYWlsLgogICAqCiAgICogUmV0dXJucyBmYWxzZSBpZiB0aGUgcGF0aCBpcyBrbm93biB0byBub3QgYmUgYSBzeW1saW5rLCBpZiBhIHByZXZpb3VzCiAgICogcmVhZGxpbmsgZmFpbGVkLCBvciBpZiB0aGUgZW50cnkgZG9lcyBub3QgZXhpc3QuCiAgICovCiAgY2FuUmVhZGxpbmsoKSB7CiAgICBpZiAodGhpcy4jbGlua1RhcmdldCkKICAgICAgcmV0dXJuIHRydWU7CiAgICBpZiAoIXRoaXMucGFyZW50KQogICAgICByZXR1cm4gZmFsc2U7CiAgICBjb25zdCBpZm10ID0gdGhpcy4jdHlwZSAmIElGTVQ7CiAgICByZXR1cm4gIShpZm10ICE9PSBVTktOT1dOICYmIGlmbXQgIT09IElGTE5LIHx8IHRoaXMuI3R5cGUgJiBFTk9SRUFETElOSyB8fCB0aGlzLiN0eXBlICYgRU5PRU5UKTsKICB9CiAgLyoqCiAgICogUmV0dXJuIHRydWUgaWYgcmVhZGRpciBoYXMgcHJldmlvdXNseSBiZWVuIHN1Y2Nlc3NmdWxseSBjYWxsZWQgb24gdGhpcwogICAqIHBhdGgsIGluZGljYXRpbmcgdGhhdCBjYWNoZWRSZWFkZGlyKCkgaXMgbGlrZWx5IHZhbGlkLgogICAqLwogIGNhbGxlZFJlYWRkaXIoKSB7CiAgICByZXR1cm4gISEodGhpcy4jdHlwZSAmIFJFQURESVJfQ0FMTEVEKTsKICB9CiAgLyoqCiAgICogUmV0dXJucyB0cnVlIGlmIHRoZSBwYXRoIGlzIGtub3duIHRvIG5vdCBleGlzdC4gVGhhdCBpcywgYSBwcmV2aW91cyBsc3RhdAogICAqIG9yIHJlYWRkaXIgZmFpbGVkIHRvIHZlcmlmeSBpdHMgZXhpc3RlbmNlIHdoZW4gdGhhdCB3b3VsZCBoYXZlIGJlZW4KICAgKiBleHBlY3RlZCwgb3IgYSBwYXJlbnQgZW50cnkgd2FzIG1hcmtlZCBlaXRoZXIgZW5vZW50IG9yIGVub3RkaXIuCiAgICovCiAgaXNFTk9FTlQoKSB7CiAgICByZXR1cm4gISEodGhpcy4jdHlwZSAmIEVOT0VOVCk7CiAgfQogIC8qKgogICAqIFJldHVybiB0cnVlIGlmIHRoZSBwYXRoIGlzIGEgbWF0Y2ggZm9yIHRoZSBnaXZlbiBwYXRoIG5hbWUuICBUaGlzIGhhbmRsZXMKICAgKiBjYXNlIHNlbnNpdGl2aXR5IGFuZCB1bmljb2RlIG5vcm1hbGl6YXRpb24uCiAgICoKICAgKiBOb3RlOiBldmVuIG9uIGNhc2Utc2Vuc2l0aXZlIHN5c3RlbXMsIGl0IGlzICoqbm90Kiogc2FmZSB0byB0ZXN0IHRoZQogICAqIGVxdWFsaXR5IG9mIHRoZSBgLm5hbWVgIHByb3BlcnR5IHRvIGRldGVybWluZSB3aGV0aGVyIGEgZ2l2ZW4gcGF0aG5hbWUKICAgKiBtYXRjaGVzLCBkdWUgdG8gdW5pY29kZSBub3JtYWxpemF0aW9uIG1pc21hdGNoZXMuCiAgICoKICAgKiBBbHdheXMgdXNlIHRoaXMgbWV0aG9kIGluc3RlYWQgb2YgdGVzdGluZyB0aGUgYHBhdGgubmFtZWAgcHJvcGVydHkKICAgKiBkaXJlY3RseS4KICAgKi8KICBpc05hbWVkKG4pIHsKICAgIHJldHVybiAhdGhpcy5ub2Nhc2UgPyB0aGlzLiNtYXRjaE5hbWUgPT09IG5vcm1hbGl6ZShuKSA6IHRoaXMuI21hdGNoTmFtZSA9PT0gbm9ybWFsaXplTm9jYXNlKG4pOwogIH0KICAvKioKICAgKiBSZXR1cm4gdGhlIFBhdGggb2JqZWN0IGNvcnJlc3BvbmRpbmcgdG8gdGhlIHRhcmdldCBvZiBhIHN5bWJvbGljIGxpbmsuCiAgICoKICAgKiBJZiB0aGUgUGF0aCBpcyBub3QgYSBzeW1ib2xpYyBsaW5rLCBvciBpZiB0aGUgcmVhZGxpbmsgY2FsbCBmYWlscyBmb3IgYW55CiAgICogcmVhc29uLCBgdW5kZWZpbmVkYCBpcyByZXR1cm5lZC4KICAgKgogICAqIFJlc3VsdCBpcyBjYWNoZWQsIGFuZCB0aHVzIG1heSBiZSBvdXRkYXRlZCBpZiB0aGUgZmlsZXN5c3RlbSBpcyBtdXRhdGVkLgogICAqLwogIGFzeW5jIHJlYWRsaW5rKCkgewogICAgY29uc3QgdGFyZ2V0ID0gdGhpcy4jbGlua1RhcmdldDsKICAgIGlmICh0YXJnZXQpIHsKICAgICAgcmV0dXJuIHRhcmdldDsKICAgIH0KICAgIGlmICghdGhpcy5jYW5SZWFkbGluaygpKSB7CiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB9CiAgICBpZiAoIXRoaXMucGFyZW50KSB7CiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB9CiAgICB0cnkgewogICAgICBjb25zdCByZWFkID0gYXdhaXQgdGhpcy4jZnMucHJvbWlzZXMucmVhZGxpbmsodGhpcy5mdWxscGF0aCgpKTsKICAgICAgY29uc3QgbGlua1RhcmdldCA9IHRoaXMucGFyZW50LnJlc29sdmUocmVhZCk7CiAgICAgIGlmIChsaW5rVGFyZ2V0KSB7CiAgICAgICAgcmV0dXJuIHRoaXMuI2xpbmtUYXJnZXQgPSBsaW5rVGFyZ2V0OwogICAgICB9CiAgICB9IGNhdGNoIChlcikgewogICAgICB0aGlzLiNyZWFkbGlua0ZhaWwoZXIuY29kZSk7CiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB9CiAgfQogIC8qKgogICAqIFN5bmNocm9ub3VzIHtAbGluayBQYXRoQmFzZS5yZWFkbGlua30KICAgKi8KICByZWFkbGlua1N5bmMoKSB7CiAgICBjb25zdCB0YXJnZXQgPSB0aGlzLiNsaW5rVGFyZ2V0OwogICAgaWYgKHRhcmdldCkgewogICAgICByZXR1cm4gdGFyZ2V0OwogICAgfQogICAgaWYgKCF0aGlzLmNhblJlYWRsaW5rKCkpIHsKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIH0KICAgIGlmICghdGhpcy5wYXJlbnQpIHsKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIH0KICAgIHRyeSB7CiAgICAgIGNvbnN0IHJlYWQgPSB0aGlzLiNmcy5yZWFkbGlua1N5bmModGhpcy5mdWxscGF0aCgpKTsKICAgICAgY29uc3QgbGlua1RhcmdldCA9IHRoaXMucGFyZW50LnJlc29sdmUocmVhZCk7CiAgICAgIGlmIChsaW5rVGFyZ2V0KSB7CiAgICAgICAgcmV0dXJuIHRoaXMuI2xpbmtUYXJnZXQgPSBsaW5rVGFyZ2V0OwogICAgICB9CiAgICB9IGNhdGNoIChlcikgewogICAgICB0aGlzLiNyZWFkbGlua0ZhaWwoZXIuY29kZSk7CiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB9CiAgfQogICNyZWFkZGlyU3VjY2VzcyhjaGlsZHJlbikgewogICAgdGhpcy4jdHlwZSB8PSBSRUFERElSX0NBTExFRDsKICAgIGZvciAobGV0IHAgPSBjaGlsZHJlbi5wcm92aXNpb25hbDsgcCA8IGNoaWxkcmVuLmxlbmd0aDsgcCsrKSB7CiAgICAgIGNoaWxkcmVuW3BdLiNtYXJrRU5PRU5UKCk7CiAgICB9CiAgfQogICNtYXJrRU5PRU5UKCkgewogICAgaWYgKHRoaXMuI3R5cGUgJiBFTk9FTlQpCiAgICAgIHJldHVybjsKICAgIHRoaXMuI3R5cGUgPSAodGhpcy4jdHlwZSB8IEVOT0VOVCkgJiBJRk1UX1VOS05PV047CiAgICB0aGlzLiNtYXJrQ2hpbGRyZW5FTk9FTlQoKTsKICB9CiAgI21hcmtDaGlsZHJlbkVOT0VOVCgpIHsKICAgIGNvbnN0IGNoaWxkcmVuID0gdGhpcy5jaGlsZHJlbigpOwogICAgY2hpbGRyZW4ucHJvdmlzaW9uYWwgPSAwOwogICAgZm9yIChjb25zdCBwIG9mIGNoaWxkcmVuKSB7CiAgICAgIHAuI21hcmtFTk9FTlQoKTsKICAgIH0KICB9CiAgI21hcmtFTk9SRUFMUEFUSCgpIHsKICAgIHRoaXMuI3R5cGUgfD0gRU5PUkVBTFBBVEg7CiAgICB0aGlzLiNtYXJrRU5PVERJUigpOwogIH0KICAvLyBzYXZlIHRoZSBpbmZvcm1hdGlvbiB3aGVuIHdlIGtub3cgdGhlIGVudHJ5IGlzIG5vdCBhIGRpcgogICNtYXJrRU5PVERJUigpIHsKICAgIGlmICh0aGlzLiN0eXBlICYgRU5PVERJUikKICAgICAgcmV0dXJuOwogICAgbGV0IHQgPSB0aGlzLiN0eXBlOwogICAgaWYgKCh0ICYgSUZNVCkgPT09IElGRElSKQogICAgICB0ICY9IElGTVRfVU5LTk9XTjsKICAgIHRoaXMuI3R5cGUgPSB0IHwgRU5PVERJUjsKICAgIHRoaXMuI21hcmtDaGlsZHJlbkVOT0VOVCgpOwogIH0KICAjcmVhZGRpckZhaWwoY29kZSA9ICIiKSB7CiAgICBpZiAoY29kZSA9PT0gIkVOT1RESVIiIHx8IGNvZGUgPT09ICJFUEVSTSIpIHsKICAgICAgdGhpcy4jbWFya0VOT1RESVIoKTsKICAgIH0gZWxzZSBpZiAoY29kZSA9PT0gIkVOT0VOVCIpIHsKICAgICAgdGhpcy4jbWFya0VOT0VOVCgpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5jaGlsZHJlbigpLnByb3Zpc2lvbmFsID0gMDsKICAgIH0KICB9CiAgI2xzdGF0RmFpbChjb2RlID0gIiIpIHsKICAgIGlmIChjb2RlID09PSAiRU5PVERJUiIpIHsKICAgICAgY29uc3QgcCA9IHRoaXMucGFyZW50OwogICAgICBwLiNtYXJrRU5PVERJUigpOwogICAgfSBlbHNlIGlmIChjb2RlID09PSAiRU5PRU5UIikgewogICAgICB0aGlzLiNtYXJrRU5PRU5UKCk7CiAgICB9CiAgfQogICNyZWFkbGlua0ZhaWwoY29kZSA9ICIiKSB7CiAgICBsZXQgdGVyID0gdGhpcy4jdHlwZTsKICAgIHRlciB8PSBFTk9SRUFETElOSzsKICAgIGlmIChjb2RlID09PSAiRU5PRU5UIikKICAgICAgdGVyIHw9IEVOT0VOVDsKICAgIGlmIChjb2RlID09PSAiRUlOVkFMIiB8fCBjb2RlID09PSAiVU5LTk9XTiIpIHsKICAgICAgdGVyICY9IElGTVRfVU5LTk9XTjsKICAgIH0KICAgIHRoaXMuI3R5cGUgPSB0ZXI7CiAgICBpZiAoY29kZSA9PT0gIkVOT1RESVIiICYmIHRoaXMucGFyZW50KSB7CiAgICAgIHRoaXMucGFyZW50LiNtYXJrRU5PVERJUigpOwogICAgfQogIH0KICAjcmVhZGRpckFkZENoaWxkKGUsIGMpIHsKICAgIHJldHVybiB0aGlzLiNyZWFkZGlyTWF5YmVQcm9tb3RlQ2hpbGQoZSwgYykgfHwgdGhpcy4jcmVhZGRpckFkZE5ld0NoaWxkKGUsIGMpOwogIH0KICAjcmVhZGRpckFkZE5ld0NoaWxkKGUsIGMpIHsKICAgIGNvbnN0IHR5cGUgPSBlbnRUb1R5cGUoZSk7CiAgICBjb25zdCBjaGlsZCA9IHRoaXMubmV3Q2hpbGQoZS5uYW1lLCB0eXBlLCB7IHBhcmVudDogdGhpcyB9KTsKICAgIGNvbnN0IGlmbXQgPSBjaGlsZC4jdHlwZSAmIElGTVQ7CiAgICBpZiAoaWZtdCAhPT0gSUZESVIgJiYgaWZtdCAhPT0gSUZMTksgJiYgaWZtdCAhPT0gVU5LTk9XTikgewogICAgICBjaGlsZC4jdHlwZSB8PSBFTk9URElSOwogICAgfQogICAgYy51bnNoaWZ0KGNoaWxkKTsKICAgIGMucHJvdmlzaW9uYWwrKzsKICAgIHJldHVybiBjaGlsZDsKICB9CiAgI3JlYWRkaXJNYXliZVByb21vdGVDaGlsZChlLCBjKSB7CiAgICBmb3IgKGxldCBwID0gYy5wcm92aXNpb25hbDsgcCA8IGMubGVuZ3RoOyBwKyspIHsKICAgICAgY29uc3QgcGNoaWxkID0gY1twXTsKICAgICAgY29uc3QgbmFtZSA9IHRoaXMubm9jYXNlID8gbm9ybWFsaXplTm9jYXNlKGUubmFtZSkgOiBub3JtYWxpemUoZS5uYW1lKTsKICAgICAgaWYgKG5hbWUgIT09IHBjaGlsZC4jbWF0Y2hOYW1lKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuI3JlYWRkaXJQcm9tb3RlQ2hpbGQoZSwgcGNoaWxkLCBwLCBjKTsKICAgIH0KICB9CiAgI3JlYWRkaXJQcm9tb3RlQ2hpbGQoZSwgcCwgaW5kZXgsIGMpIHsKICAgIGNvbnN0IHYgPSBwLm5hbWU7CiAgICBwLiN0eXBlID0gcC4jdHlwZSAmIElGTVRfVU5LTk9XTiB8IGVudFRvVHlwZShlKTsKICAgIGlmICh2ICE9PSBlLm5hbWUpCiAgICAgIHAubmFtZSA9IGUubmFtZTsKICAgIGlmIChpbmRleCAhPT0gYy5wcm92aXNpb25hbCkgewogICAgICBpZiAoaW5kZXggPT09IGMubGVuZ3RoIC0gMSkKICAgICAgICBjLnBvcCgpOwogICAgICBlbHNlCiAgICAgICAgYy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICBjLnVuc2hpZnQocCk7CiAgICB9CiAgICBjLnByb3Zpc2lvbmFsKys7CiAgICByZXR1cm4gcDsKICB9CiAgLyoqCiAgICogQ2FsbCBsc3RhdCgpIG9uIHRoaXMgUGF0aCwgYW5kIHVwZGF0ZSBhbGwga25vd24gaW5mb3JtYXRpb24gdGhhdCBjYW4gYmUKICAgKiBkZXRlcm1pbmVkLgogICAqCiAgICogTm90ZSB0aGF0IHVubGlrZSBgZnMubHN0YXQoKWAsIHRoZSByZXR1cm5lZCB2YWx1ZSBkb2VzIG5vdCBjb250YWluIHNvbWUKICAgKiBpbmZvcm1hdGlvbiwgc3VjaCBhcyBgbW9kZWAsIGBkZXZgLCBgbmxpbmtgLCBhbmQgYGlub2AuICBJZiB0aGF0CiAgICogaW5mb3JtYXRpb24gaXMgcmVxdWlyZWQsIHlvdSB3aWxsIG5lZWQgdG8gY2FsbCBgZnMubHN0YXRgIHlvdXJzZWxmLgogICAqCiAgICogSWYgdGhlIFBhdGggcmVmZXJzIHRvIGEgbm9uZXhpc3RlbnQgZmlsZSwgb3IgaWYgdGhlIGxzdGF0IGNhbGwgZmFpbHMgZm9yCiAgICogYW55IHJlYXNvbiwgYHVuZGVmaW5lZGAgaXMgcmV0dXJuZWQuICBPdGhlcndpc2UgdGhlIHVwZGF0ZWQgUGF0aCBvYmplY3QgaXMKICAgKiByZXR1cm5lZC4KICAgKgogICAqIFJlc3VsdHMgYXJlIGNhY2hlZCwgYW5kIHRodXMgbWF5IGJlIG91dCBvZiBkYXRlIGlmIHRoZSBmaWxlc3lzdGVtIGlzCiAgICogbXV0YXRlZC4KICAgKi8KICBhc3luYyBsc3RhdCgpIHsKICAgIGlmICgodGhpcy4jdHlwZSAmIEVOT0VOVCkgPT09IDApIHsKICAgICAgdHJ5IHsKICAgICAgICB0aGlzLiNhcHBseVN0YXQoYXdhaXQgdGhpcy4jZnMucHJvbWlzZXMubHN0YXQodGhpcy5mdWxscGF0aCgpKSk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0gY2F0Y2ggKGVyKSB7CiAgICAgICAgdGhpcy4jbHN0YXRGYWlsKGVyLmNvZGUpOwogICAgICB9CiAgICB9CiAgfQogIC8qKgogICAqIHN5bmNocm9ub3VzIHtAbGluayBQYXRoQmFzZS5sc3RhdH0KICAgKi8KICBsc3RhdFN5bmMoKSB7CiAgICBpZiAoKHRoaXMuI3R5cGUgJiBFTk9FTlQpID09PSAwKSB7CiAgICAgIHRyeSB7CiAgICAgICAgdGhpcy4jYXBwbHlTdGF0KHRoaXMuI2ZzLmxzdGF0U3luYyh0aGlzLmZ1bGxwYXRoKCkpKTsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfSBjYXRjaCAoZXIpIHsKICAgICAgICB0aGlzLiNsc3RhdEZhaWwoZXIuY29kZSk7CiAgICAgIH0KICAgIH0KICB9CiAgI2FwcGx5U3RhdChzdCkgewogICAgY29uc3QgeyBhdGltZSwgYXRpbWVNcywgYmlydGh0aW1lLCBiaXJ0aHRpbWVNcywgYmxrc2l6ZSwgYmxvY2tzLCBjdGltZSwgY3RpbWVNcywgZGV2LCBnaWQsIGlubywgbW9kZTogbW9kZTIsIG10aW1lLCBtdGltZU1zLCBubGluaywgcmRldiwgc2l6ZSwgdWlkIH0gPSBzdDsKICAgIHRoaXMuI2F0aW1lID0gYXRpbWU7CiAgICB0aGlzLiNhdGltZU1zID0gYXRpbWVNczsKICAgIHRoaXMuI2JpcnRodGltZSA9IGJpcnRodGltZTsKICAgIHRoaXMuI2JpcnRodGltZU1zID0gYmlydGh0aW1lTXM7CiAgICB0aGlzLiNibGtzaXplID0gYmxrc2l6ZTsKICAgIHRoaXMuI2Jsb2NrcyA9IGJsb2NrczsKICAgIHRoaXMuI2N0aW1lID0gY3RpbWU7CiAgICB0aGlzLiNjdGltZU1zID0gY3RpbWVNczsKICAgIHRoaXMuI2RldiA9IGRldjsKICAgIHRoaXMuI2dpZCA9IGdpZDsKICAgIHRoaXMuI2lubyA9IGlubzsKICAgIHRoaXMuI21vZGUgPSBtb2RlMjsKICAgIHRoaXMuI210aW1lID0gbXRpbWU7CiAgICB0aGlzLiNtdGltZU1zID0gbXRpbWVNczsKICAgIHRoaXMuI25saW5rID0gbmxpbms7CiAgICB0aGlzLiNyZGV2ID0gcmRldjsKICAgIHRoaXMuI3NpemUgPSBzaXplOwogICAgdGhpcy4jdWlkID0gdWlkOwogICAgY29uc3QgaWZtdCA9IGVudFRvVHlwZShzdCk7CiAgICB0aGlzLiN0eXBlID0gdGhpcy4jdHlwZSAmIElGTVRfVU5LTk9XTiB8IGlmbXQgfCBMU1RBVF9DQUxMRUQ7CiAgICBpZiAoaWZtdCAhPT0gVU5LTk9XTiAmJiBpZm10ICE9PSBJRkRJUiAmJiBpZm10ICE9PSBJRkxOSykgewogICAgICB0aGlzLiN0eXBlIHw9IEVOT1RESVI7CiAgICB9CiAgfQogICNvblJlYWRkaXJDQiA9IFtdOwogICNyZWFkZGlyQ0JJbkZsaWdodCA9IGZhbHNlOwogICNjYWxsT25SZWFkZGlyQ0IoY2hpbGRyZW4pIHsKICAgIHRoaXMuI3JlYWRkaXJDQkluRmxpZ2h0ID0gZmFsc2U7CiAgICBjb25zdCBjYnMgPSB0aGlzLiNvblJlYWRkaXJDQi5zbGljZSgpOwogICAgdGhpcy4jb25SZWFkZGlyQ0IubGVuZ3RoID0gMDsKICAgIGNicy5mb3JFYWNoKChjYikgPT4gY2IobnVsbCwgY2hpbGRyZW4pKTsKICB9CiAgLyoqCiAgICogU3RhbmRhcmQgbm9kZS1zdHlsZSBjYWxsYmFjayBpbnRlcmZhY2UgdG8gZ2V0IGxpc3Qgb2YgZGlyZWN0b3J5IGVudHJpZXMuCiAgICoKICAgKiBJZiB0aGUgUGF0aCBjYW5ub3Qgb3IgZG9lcyBub3QgY29udGFpbiBhbnkgY2hpbGRyZW4sIHRoZW4gYW4gZW1wdHkgYXJyYXkKICAgKiBpcyByZXR1cm5lZC4KICAgKgogICAqIFJlc3VsdHMgYXJlIGNhY2hlZCwgYW5kIHRodXMgbWF5IGJlIG91dCBvZiBkYXRlIGlmIHRoZSBmaWxlc3lzdGVtIGlzCiAgICogbXV0YXRlZC4KICAgKgogICAqIEBwYXJhbSBjYiBUaGUgY2FsbGJhY2sgY2FsbGVkIHdpdGggKGVyLCBlbnRyaWVzKS4gIE5vdGUgdGhhdCB0aGUgYGVyYAogICAqIHBhcmFtIGlzIHNvbWV3aGF0IGV4dHJhbmVvdXMsIGFzIGFsbCByZWFkZGlyKCkgZXJyb3JzIGFyZSBoYW5kbGVkIGFuZAogICAqIHNpbXBseSByZXN1bHQgaW4gYW4gZW1wdHkgc2V0IG9mIGVudHJpZXMgYmVpbmcgcmV0dXJuZWQuCiAgICogQHBhcmFtIGFsbG93WmFsZ28gQm9vbGVhbiBpbmRpY2F0aW5nIHRoYXQgaW1tZWRpYXRlbHkga25vd24gcmVzdWx0cyBzaG91bGQKICAgKiAqbm90KiBiZSBkZWZlcnJlZCB3aXRoIGBxdWV1ZU1pY3JvdGFza2AuIERlZmF1bHRzIHRvIGBmYWxzZWAuIFJlbGVhc2UKICAgKiB6YWxnbyBhdCB5b3VyIHBlcmlsLCB0aGUgZGFyayBwb255IGxvcmQgaXMgZGV2aW91cyBhbmQgdW5mb3JnaXZpbmcuCiAgICovCiAgcmVhZGRpckNCKGNiLCBhbGxvd1phbGdvID0gZmFsc2UpIHsKICAgIGlmICghdGhpcy5jYW5SZWFkZGlyKCkpIHsKICAgICAgaWYgKGFsbG93WmFsZ28pCiAgICAgICAgY2IobnVsbCwgW10pOwogICAgICBlbHNlCiAgICAgICAgcXVldWVNaWNyb3Rhc2soKCkgPT4gY2IobnVsbCwgW10pKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgY2hpbGRyZW4gPSB0aGlzLmNoaWxkcmVuKCk7CiAgICBpZiAodGhpcy5jYWxsZWRSZWFkZGlyKCkpIHsKICAgICAgY29uc3QgYyA9IGNoaWxkcmVuLnNsaWNlKDAsIGNoaWxkcmVuLnByb3Zpc2lvbmFsKTsKICAgICAgaWYgKGFsbG93WmFsZ28pCiAgICAgICAgY2IobnVsbCwgYyk7CiAgICAgIGVsc2UKICAgICAgICBxdWV1ZU1pY3JvdGFzaygoKSA9PiBjYihudWxsLCBjKSk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuI29uUmVhZGRpckNCLnB1c2goY2IpOwogICAgaWYgKHRoaXMuI3JlYWRkaXJDQkluRmxpZ2h0KSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuI3JlYWRkaXJDQkluRmxpZ2h0ID0gdHJ1ZTsKICAgIGNvbnN0IGZ1bGxwYXRoID0gdGhpcy5mdWxscGF0aCgpOwogICAgdGhpcy4jZnMucmVhZGRpcihmdWxscGF0aCwgeyB3aXRoRmlsZVR5cGVzOiB0cnVlIH0sIChlciwgZW50cmllcykgPT4gewogICAgICBpZiAoZXIpIHsKICAgICAgICB0aGlzLiNyZWFkZGlyRmFpbChlci5jb2RlKTsKICAgICAgICBjaGlsZHJlbi5wcm92aXNpb25hbCA9IDA7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZm9yIChjb25zdCBlIG9mIGVudHJpZXMpIHsKICAgICAgICAgIHRoaXMuI3JlYWRkaXJBZGRDaGlsZChlLCBjaGlsZHJlbik7CiAgICAgICAgfQogICAgICAgIHRoaXMuI3JlYWRkaXJTdWNjZXNzKGNoaWxkcmVuKTsKICAgICAgfQogICAgICB0aGlzLiNjYWxsT25SZWFkZGlyQ0IoY2hpbGRyZW4uc2xpY2UoMCwgY2hpbGRyZW4ucHJvdmlzaW9uYWwpKTsKICAgICAgcmV0dXJuOwogICAgfSk7CiAgfQogICNhc3luY1JlYWRkaXJJbkZsaWdodDsKICAvKioKICAgKiBSZXR1cm4gYW4gYXJyYXkgb2Yga25vd24gY2hpbGQgZW50cmllcy4KICAgKgogICAqIElmIHRoZSBQYXRoIGNhbm5vdCBvciBkb2VzIG5vdCBjb250YWluIGFueSBjaGlsZHJlbiwgdGhlbiBhbiBlbXB0eSBhcnJheQogICAqIGlzIHJldHVybmVkLgogICAqCiAgICogUmVzdWx0cyBhcmUgY2FjaGVkLCBhbmQgdGh1cyBtYXkgYmUgb3V0IG9mIGRhdGUgaWYgdGhlIGZpbGVzeXN0ZW0gaXMKICAgKiBtdXRhdGVkLgogICAqLwogIGFzeW5jIHJlYWRkaXIoKSB7CiAgICBpZiAoIXRoaXMuY2FuUmVhZGRpcigpKSB7CiAgICAgIHJldHVybiBbXTsKICAgIH0KICAgIGNvbnN0IGNoaWxkcmVuID0gdGhpcy5jaGlsZHJlbigpOwogICAgaWYgKHRoaXMuY2FsbGVkUmVhZGRpcigpKSB7CiAgICAgIHJldHVybiBjaGlsZHJlbi5zbGljZSgwLCBjaGlsZHJlbi5wcm92aXNpb25hbCk7CiAgICB9CiAgICBjb25zdCBmdWxscGF0aCA9IHRoaXMuZnVsbHBhdGgoKTsKICAgIGlmICh0aGlzLiNhc3luY1JlYWRkaXJJbkZsaWdodCkgewogICAgICBhd2FpdCB0aGlzLiNhc3luY1JlYWRkaXJJbkZsaWdodDsKICAgIH0gZWxzZSB7CiAgICAgIGxldCByZXNvbHZlID0gKCkgPT4gewogICAgICB9OwogICAgICB0aGlzLiNhc3luY1JlYWRkaXJJbkZsaWdodCA9IG5ldyBQcm9taXNlKChyZXMpID0+IHJlc29sdmUgPSByZXMpOwogICAgICB0cnkgewogICAgICAgIGZvciAoY29uc3QgZSBvZiBhd2FpdCB0aGlzLiNmcy5wcm9taXNlcy5yZWFkZGlyKGZ1bGxwYXRoLCB7CiAgICAgICAgICB3aXRoRmlsZVR5cGVzOiB0cnVlCiAgICAgICAgfSkpIHsKICAgICAgICAgIHRoaXMuI3JlYWRkaXJBZGRDaGlsZChlLCBjaGlsZHJlbik7CiAgICAgICAgfQogICAgICAgIHRoaXMuI3JlYWRkaXJTdWNjZXNzKGNoaWxkcmVuKTsKICAgICAgfSBjYXRjaCAoZXIpIHsKICAgICAgICB0aGlzLiNyZWFkZGlyRmFpbChlci5jb2RlKTsKICAgICAgICBjaGlsZHJlbi5wcm92aXNpb25hbCA9IDA7CiAgICAgIH0KICAgICAgdGhpcy4jYXN5bmNSZWFkZGlySW5GbGlnaHQgPSB2b2lkIDA7CiAgICAgIHJlc29sdmUoKTsKICAgIH0KICAgIHJldHVybiBjaGlsZHJlbi5zbGljZSgwLCBjaGlsZHJlbi5wcm92aXNpb25hbCk7CiAgfQogIC8qKgogICAqIHN5bmNocm9ub3VzIHtAbGluayBQYXRoQmFzZS5yZWFkZGlyfQogICAqLwogIHJlYWRkaXJTeW5jKCkgewogICAgaWYgKCF0aGlzLmNhblJlYWRkaXIoKSkgewogICAgICByZXR1cm4gW107CiAgICB9CiAgICBjb25zdCBjaGlsZHJlbiA9IHRoaXMuY2hpbGRyZW4oKTsKICAgIGlmICh0aGlzLmNhbGxlZFJlYWRkaXIoKSkgewogICAgICByZXR1cm4gY2hpbGRyZW4uc2xpY2UoMCwgY2hpbGRyZW4ucHJvdmlzaW9uYWwpOwogICAgfQogICAgY29uc3QgZnVsbHBhdGggPSB0aGlzLmZ1bGxwYXRoKCk7CiAgICB0cnkgewogICAgICBmb3IgKGNvbnN0IGUgb2YgdGhpcy4jZnMucmVhZGRpclN5bmMoZnVsbHBhdGgsIHsKICAgICAgICB3aXRoRmlsZVR5cGVzOiB0cnVlCiAgICAgIH0pKSB7CiAgICAgICAgdGhpcy4jcmVhZGRpckFkZENoaWxkKGUsIGNoaWxkcmVuKTsKICAgICAgfQogICAgICB0aGlzLiNyZWFkZGlyU3VjY2VzcyhjaGlsZHJlbik7CiAgICB9IGNhdGNoIChlcikgewogICAgICB0aGlzLiNyZWFkZGlyRmFpbChlci5jb2RlKTsKICAgICAgY2hpbGRyZW4ucHJvdmlzaW9uYWwgPSAwOwogICAgfQogICAgcmV0dXJuIGNoaWxkcmVuLnNsaWNlKDAsIGNoaWxkcmVuLnByb3Zpc2lvbmFsKTsKICB9CiAgY2FuUmVhZGRpcigpIHsKICAgIGlmICh0aGlzLiN0eXBlICYgRU5PQ0hJTEQpCiAgICAgIHJldHVybiBmYWxzZTsKICAgIGNvbnN0IGlmbXQgPSBJRk1UICYgdGhpcy4jdHlwZTsKICAgIGlmICghKGlmbXQgPT09IFVOS05PV04gfHwgaWZtdCA9PT0gSUZESVIgfHwgaWZtdCA9PT0gSUZMTkspKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHJldHVybiB0cnVlOwogIH0KICBzaG91bGRXYWxrKGRpcnMsIHdhbGtGaWx0ZXIpIHsKICAgIHJldHVybiAodGhpcy4jdHlwZSAmIElGRElSKSA9PT0gSUZESVIgJiYgISh0aGlzLiN0eXBlICYgRU5PQ0hJTEQpICYmICFkaXJzLmhhcyh0aGlzKSAmJiAoIXdhbGtGaWx0ZXIgfHwgd2Fsa0ZpbHRlcih0aGlzKSk7CiAgfQogIC8qKgogICAqIFJldHVybiB0aGUgUGF0aCBvYmplY3QgY29ycmVzcG9uZGluZyB0byBwYXRoIGFzIHJlc29sdmVkCiAgICogYnkgcmVhbHBhdGgoMykuCiAgICoKICAgKiBJZiB0aGUgcmVhbHBhdGggY2FsbCBmYWlscyBmb3IgYW55IHJlYXNvbiwgYHVuZGVmaW5lZGAgaXMgcmV0dXJuZWQuCiAgICoKICAgKiBSZXN1bHQgaXMgY2FjaGVkLCBhbmQgdGh1cyBtYXkgYmUgb3V0ZGF0ZWQgaWYgdGhlIGZpbGVzeXN0ZW0gaXMgbXV0YXRlZC4KICAgKiBPbiBzdWNjZXNzLCByZXR1cm5zIGEgUGF0aCBvYmplY3QuCiAgICovCiAgYXN5bmMgcmVhbHBhdGgoKSB7CiAgICBpZiAodGhpcy4jcmVhbHBhdGgpCiAgICAgIHJldHVybiB0aGlzLiNyZWFscGF0aDsKICAgIGlmICgoRU5PUkVBTFBBVEggfCBFTk9SRUFETElOSyB8IEVOT0VOVCkgJiB0aGlzLiN0eXBlKQogICAgICByZXR1cm4gdm9pZCAwOwogICAgdHJ5IHsKICAgICAgY29uc3QgcnAgPSBhd2FpdCB0aGlzLiNmcy5wcm9taXNlcy5yZWFscGF0aCh0aGlzLmZ1bGxwYXRoKCkpOwogICAgICByZXR1cm4gdGhpcy4jcmVhbHBhdGggPSB0aGlzLnJlc29sdmUocnApOwogICAgfSBjYXRjaCAoXykgewogICAgICB0aGlzLiNtYXJrRU5PUkVBTFBBVEgoKTsKICAgIH0KICB9CiAgLyoqCiAgICogU3luY2hyb25vdXMge0BsaW5rIHJlYWxwYXRofQogICAqLwogIHJlYWxwYXRoU3luYygpIHsKICAgIGlmICh0aGlzLiNyZWFscGF0aCkKICAgICAgcmV0dXJuIHRoaXMuI3JlYWxwYXRoOwogICAgaWYgKChFTk9SRUFMUEFUSCB8IEVOT1JFQURMSU5LIHwgRU5PRU5UKSAmIHRoaXMuI3R5cGUpCiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB0cnkgewogICAgICBjb25zdCBycCA9IHRoaXMuI2ZzLnJlYWxwYXRoU3luYyh0aGlzLmZ1bGxwYXRoKCkpOwogICAgICByZXR1cm4gdGhpcy4jcmVhbHBhdGggPSB0aGlzLnJlc29sdmUocnApOwogICAgfSBjYXRjaCAoXykgewogICAgICB0aGlzLiNtYXJrRU5PUkVBTFBBVEgoKTsKICAgIH0KICB9CiAgLyoqCiAgICogSW50ZXJuYWwgbWV0aG9kIHRvIG1hcmsgdGhpcyBQYXRoIG9iamVjdCBhcyB0aGUgc2N1cnJ5IGN3ZCwKICAgKiBjYWxsZWQgYnkge0BsaW5rIFBhdGhTY3VycnkjY2hkaXJ9CiAgICoKICAgKiBAaW50ZXJuYWwKICAgKi8KICBbc2V0QXNDd2RdKG9sZEN3ZCkgewogICAgaWYgKG9sZEN3ZCA9PT0gdGhpcykKICAgICAgcmV0dXJuOwogICAgY29uc3QgY2hhbmdlZCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KFtdKTsKICAgIGxldCBycCA9IFtdOwogICAgbGV0IHAgPSB0aGlzOwogICAgd2hpbGUgKHAgJiYgcC5wYXJlbnQpIHsKICAgICAgY2hhbmdlZC5hZGQocCk7CiAgICAgIHAuI3JlbGF0aXZlID0gcnAuam9pbih0aGlzLnNlcCk7CiAgICAgIHAuI3JlbGF0aXZlUG9zaXggPSBycC5qb2luKCIvIik7CiAgICAgIHAgPSBwLnBhcmVudDsKICAgICAgcnAucHVzaCgiLi4iKTsKICAgIH0KICAgIHAgPSBvbGRDd2Q7CiAgICB3aGlsZSAocCAmJiBwLnBhcmVudCAmJiAhY2hhbmdlZC5oYXMocCkpIHsKICAgICAgcC4jcmVsYXRpdmUgPSB2b2lkIDA7CiAgICAgIHAuI3JlbGF0aXZlUG9zaXggPSB2b2lkIDA7CiAgICAgIHAgPSBwLnBhcmVudDsKICAgIH0KICB9Cn0KY2xhc3MgUGF0aFdpbjMyIGV4dGVuZHMgUGF0aEJhc2UgewogIC8qKgogICAqIFNlcGFyYXRvciBmb3IgZ2VuZXJhdGluZyBwYXRoIHN0cmluZ3MuCiAgICovCiAgc2VwID0gIlxcIjsKICAvKioKICAgKiBTZXBhcmF0b3IgZm9yIHBhcnNpbmcgcGF0aCBzdHJpbmdzLgogICAqLwogIHNwbGl0U2VwID0gZWl0aGVyU2VwOwogIC8qKgogICAqIERvIG5vdCBjcmVhdGUgbmV3IFBhdGggb2JqZWN0cyBkaXJlY3RseS4gIFRoZXkgc2hvdWxkIGFsd2F5cyBiZSBhY2Nlc3NlZAogICAqIHZpYSB0aGUgUGF0aFNjdXJyeSBjbGFzcyBvciBvdGhlciBtZXRob2RzIG9uIHRoZSBQYXRoIGNsYXNzLgogICAqCiAgICogQGludGVybmFsCiAgICovCiAgY29uc3RydWN0b3IobmFtZSwgdHlwZSA9IFVOS05PV04sIHJvb3QsIHJvb3RzLCBub2Nhc2UsIGNoaWxkcmVuLCBvcHRzKSB7CiAgICBzdXBlcihuYW1lLCB0eXBlLCByb290LCByb290cywgbm9jYXNlLCBjaGlsZHJlbiwgb3B0cyk7CiAgfQogIC8qKgogICAqIEBpbnRlcm5hbAogICAqLwogIG5ld0NoaWxkKG5hbWUsIHR5cGUgPSBVTktOT1dOLCBvcHRzID0ge30pIHsKICAgIHJldHVybiBuZXcgUGF0aFdpbjMyKG5hbWUsIHR5cGUsIHRoaXMucm9vdCwgdGhpcy5yb290cywgdGhpcy5ub2Nhc2UsIHRoaXMuY2hpbGRyZW5DYWNoZSgpLCBvcHRzKTsKICB9CiAgLyoqCiAgICogQGludGVybmFsCiAgICovCiAgZ2V0Um9vdFN0cmluZyhwYXRoMikgewogICAgcmV0dXJuIHdpbjMyLnBhcnNlKHBhdGgyKS5yb290OwogIH0KICAvKioKICAgKiBAaW50ZXJuYWwKICAgKi8KICBnZXRSb290KHJvb3RQYXRoKSB7CiAgICByb290UGF0aCA9IHVuY1RvRHJpdmUocm9vdFBhdGgudG9VcHBlckNhc2UoKSk7CiAgICBpZiAocm9vdFBhdGggPT09IHRoaXMucm9vdC5uYW1lKSB7CiAgICAgIHJldHVybiB0aGlzLnJvb3Q7CiAgICB9CiAgICBmb3IgKGNvbnN0IFtjb21wYXJlLCByb290XSBvZiBPYmplY3QuZW50cmllcyh0aGlzLnJvb3RzKSkgewogICAgICBpZiAodGhpcy5zYW1lUm9vdChyb290UGF0aCwgY29tcGFyZSkpIHsKICAgICAgICByZXR1cm4gdGhpcy5yb290c1tyb290UGF0aF0gPSByb290OwogICAgICB9CiAgICB9CiAgICByZXR1cm4gdGhpcy5yb290c1tyb290UGF0aF0gPSBuZXcgUGF0aFNjdXJyeVdpbjMyKHJvb3RQYXRoLCB0aGlzKS5yb290OwogIH0KICAvKioKICAgKiBAaW50ZXJuYWwKICAgKi8KICBzYW1lUm9vdChyb290UGF0aCwgY29tcGFyZSA9IHRoaXMucm9vdC5uYW1lKSB7CiAgICByb290UGF0aCA9IHJvb3RQYXRoLnRvVXBwZXJDYXNlKCkucmVwbGFjZSgvXC8vZywgIlxcIikucmVwbGFjZSh1bmNEcml2ZVJlZ2V4cCwgIiQxXFwiKTsKICAgIHJldHVybiByb290UGF0aCA9PT0gY29tcGFyZTsKICB9Cn0KY2xhc3MgUGF0aFBvc2l4IGV4dGVuZHMgUGF0aEJhc2UgewogIC8qKgogICAqIHNlcGFyYXRvciBmb3IgcGFyc2luZyBwYXRoIHN0cmluZ3MKICAgKi8KICBzcGxpdFNlcCA9ICIvIjsKICAvKioKICAgKiBzZXBhcmF0b3IgZm9yIGdlbmVyYXRpbmcgcGF0aCBzdHJpbmdzCiAgICovCiAgc2VwID0gIi8iOwogIC8qKgogICAqIERvIG5vdCBjcmVhdGUgbmV3IFBhdGggb2JqZWN0cyBkaXJlY3RseS4gIFRoZXkgc2hvdWxkIGFsd2F5cyBiZSBhY2Nlc3NlZAogICAqIHZpYSB0aGUgUGF0aFNjdXJyeSBjbGFzcyBvciBvdGhlciBtZXRob2RzIG9uIHRoZSBQYXRoIGNsYXNzLgogICAqCiAgICogQGludGVybmFsCiAgICovCiAgY29uc3RydWN0b3IobmFtZSwgdHlwZSA9IFVOS05PV04sIHJvb3QsIHJvb3RzLCBub2Nhc2UsIGNoaWxkcmVuLCBvcHRzKSB7CiAgICBzdXBlcihuYW1lLCB0eXBlLCByb290LCByb290cywgbm9jYXNlLCBjaGlsZHJlbiwgb3B0cyk7CiAgfQogIC8qKgogICAqIEBpbnRlcm5hbAogICAqLwogIGdldFJvb3RTdHJpbmcocGF0aDIpIHsKICAgIHJldHVybiBwYXRoMi5zdGFydHNXaXRoKCIvIikgPyAiLyIgOiAiIjsKICB9CiAgLyoqCiAgICogQGludGVybmFsCiAgICovCiAgZ2V0Um9vdChfcm9vdFBhdGgpIHsKICAgIHJldHVybiB0aGlzLnJvb3Q7CiAgfQogIC8qKgogICAqIEBpbnRlcm5hbAogICAqLwogIG5ld0NoaWxkKG5hbWUsIHR5cGUgPSBVTktOT1dOLCBvcHRzID0ge30pIHsKICAgIHJldHVybiBuZXcgUGF0aFBvc2l4KG5hbWUsIHR5cGUsIHRoaXMucm9vdCwgdGhpcy5yb290cywgdGhpcy5ub2Nhc2UsIHRoaXMuY2hpbGRyZW5DYWNoZSgpLCBvcHRzKTsKICB9Cn0KY2xhc3MgUGF0aFNjdXJyeUJhc2UgewogIC8qKgogICAqIFRoZSByb290IFBhdGggZW50cnkgZm9yIHRoZSBjdXJyZW50IHdvcmtpbmcgZGlyZWN0b3J5IG9mIHRoaXMgU2N1cnJ5CiAgICovCiAgcm9vdDsKICAvKioKICAgKiBUaGUgc3RyaW5nIHBhdGggZm9yIHRoZSByb290IG9mIHRoaXMgU2N1cnJ5J3MgY3VycmVudCB3b3JraW5nIGRpcmVjdG9yeQogICAqLwogIHJvb3RQYXRoOwogIC8qKgogICAqIEEgY29sbGVjdGlvbiBvZiBhbGwgcm9vdHMgZW5jb3VudGVyZWQsIHJlZmVyZW5jZWQgYnkgcm9vdFBhdGgKICAgKi8KICByb290czsKICAvKioKICAgKiBUaGUgUGF0aCBlbnRyeSBjb3JyZXNwb25kaW5nIHRvIHRoaXMgUGF0aFNjdXJyeSdzIGN1cnJlbnQgd29ya2luZyBkaXJlY3RvcnkuCiAgICovCiAgY3dkOwogICNyZXNvbHZlQ2FjaGU7CiAgI3Jlc29sdmVQb3NpeENhY2hlOwogICNjaGlsZHJlbjsKICAvKioKICAgKiBQZXJmb3JtIHBhdGggY29tcGFyaXNvbnMgY2FzZS1pbnNlbnNpdGl2ZWx5LgogICAqCiAgICogRGVmYXVsdHMgdHJ1ZSBvbiBEYXJ3aW4gYW5kIFdpbmRvd3Mgc3lzdGVtcywgZmFsc2UgZWxzZXdoZXJlLgogICAqLwogIG5vY2FzZTsKICAjZnM7CiAgLyoqCiAgICogVGhpcyBjbGFzcyBzaG91bGQgbm90IGJlIGluc3RhbnRpYXRlZCBkaXJlY3RseS4KICAgKgogICAqIFVzZSBQYXRoU2N1cnJ5V2luMzIsIFBhdGhTY3VycnlEYXJ3aW4sIFBhdGhTY3VycnlQb3NpeCwgb3IgUGF0aFNjdXJyeQogICAqCiAgICogQGludGVybmFsCiAgICovCiAgY29uc3RydWN0b3IoY3dkID0gcHJvY2Vzcy5jd2QoKSwgcGF0aEltcGwsIHNlcDIsIHsgbm9jYXNlLCBjaGlsZHJlbkNhY2hlU2l6ZSA9IDE2ICogMTAyNCwgZnM6IGZzMiA9IGRlZmF1bHRGUyB9ID0ge30pIHsKICAgIHRoaXMuI2ZzID0gZnNGcm9tT3B0aW9uKGZzMik7CiAgICBpZiAoY3dkIGluc3RhbmNlb2YgVVJMIHx8IGN3ZC5zdGFydHNXaXRoKCJmaWxlOi8vIikpIHsKICAgICAgY3dkID0gZmlsZVVSTFRvUGF0aChjd2QpOwogICAgfQogICAgY29uc3QgY3dkUGF0aCA9IHBhdGhJbXBsLnJlc29sdmUoY3dkKTsKICAgIHRoaXMucm9vdHMgPSAvKiBAX19QVVJFX18gKi8gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgIHRoaXMucm9vdFBhdGggPSB0aGlzLnBhcnNlUm9vdFBhdGgoY3dkUGF0aCk7CiAgICB0aGlzLiNyZXNvbHZlQ2FjaGUgPSBuZXcgUmVzb2x2ZUNhY2hlKCk7CiAgICB0aGlzLiNyZXNvbHZlUG9zaXhDYWNoZSA9IG5ldyBSZXNvbHZlQ2FjaGUoKTsKICAgIHRoaXMuI2NoaWxkcmVuID0gbmV3IENoaWxkcmVuQ2FjaGUoY2hpbGRyZW5DYWNoZVNpemUpOwogICAgY29uc3Qgc3BsaXQgPSBjd2RQYXRoLnN1YnN0cmluZyh0aGlzLnJvb3RQYXRoLmxlbmd0aCkuc3BsaXQoc2VwMik7CiAgICBpZiAoc3BsaXQubGVuZ3RoID09PSAxICYmICFzcGxpdFswXSkgewogICAgICBzcGxpdC5wb3AoKTsKICAgIH0KICAgIGlmIChub2Nhc2UgPT09IHZvaWQgMCkgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJtdXN0IHByb3ZpZGUgbm9jYXNlIHNldHRpbmcgdG8gUGF0aFNjdXJyeUJhc2UgY3RvciIpOwogICAgfQogICAgdGhpcy5ub2Nhc2UgPSBub2Nhc2U7CiAgICB0aGlzLnJvb3QgPSB0aGlzLm5ld1Jvb3QodGhpcy4jZnMpOwogICAgdGhpcy5yb290c1t0aGlzLnJvb3RQYXRoXSA9IHRoaXMucm9vdDsKICAgIGxldCBwcmV2ID0gdGhpcy5yb290OwogICAgbGV0IGxlbiA9IHNwbGl0Lmxlbmd0aCAtIDE7CiAgICBjb25zdCBqb2luU2VwID0gcGF0aEltcGwuc2VwOwogICAgbGV0IGFicyA9IHRoaXMucm9vdFBhdGg7CiAgICBsZXQgc2F3Rmlyc3QgPSBmYWxzZTsKICAgIGZvciAoY29uc3QgcGFydCBvZiBzcGxpdCkgewogICAgICBjb25zdCBsID0gbGVuLS07CiAgICAgIHByZXYgPSBwcmV2LmNoaWxkKHBhcnQsIHsKICAgICAgICByZWxhdGl2ZTogbmV3IEFycmF5KGwpLmZpbGwoIi4uIikuam9pbihqb2luU2VwKSwKICAgICAgICByZWxhdGl2ZVBvc2l4OiBuZXcgQXJyYXkobCkuZmlsbCgiLi4iKS5qb2luKCIvIiksCiAgICAgICAgZnVsbHBhdGg6IGFicyArPSAoc2F3Rmlyc3QgPyAiIiA6IGpvaW5TZXApICsgcGFydAogICAgICB9KTsKICAgICAgc2F3Rmlyc3QgPSB0cnVlOwogICAgfQogICAgdGhpcy5jd2QgPSBwcmV2OwogIH0KICAvKioKICAgKiBHZXQgdGhlIGRlcHRoIG9mIGEgcHJvdmlkZWQgcGF0aCwgc3RyaW5nLCBvciB0aGUgY3dkCiAgICovCiAgZGVwdGgocGF0aDIgPSB0aGlzLmN3ZCkgewogICAgaWYgKHR5cGVvZiBwYXRoMiA9PT0gInN0cmluZyIpIHsKICAgICAgcGF0aDIgPSB0aGlzLmN3ZC5yZXNvbHZlKHBhdGgyKTsKICAgIH0KICAgIHJldHVybiBwYXRoMi5kZXB0aCgpOwogIH0KICAvKioKICAgKiBSZXR1cm4gdGhlIGNhY2hlIG9mIGNoaWxkIGVudHJpZXMuICBFeHBvc2VkIHNvIHN1YmNsYXNzZXMgY2FuIGNyZWF0ZQogICAqIGNoaWxkIFBhdGggb2JqZWN0cyBpbiBhIHBsYXRmb3JtLXNwZWNpZmljIHdheS4KICAgKgogICAqIEBpbnRlcm5hbAogICAqLwogIGNoaWxkcmVuQ2FjaGUoKSB7CiAgICByZXR1cm4gdGhpcy4jY2hpbGRyZW47CiAgfQogIC8qKgogICAqIFJlc29sdmUgb25lIG9yIG1vcmUgcGF0aCBzdHJpbmdzIHRvIGEgcmVzb2x2ZWQgc3RyaW5nCiAgICoKICAgKiBTYW1lIGludGVyZmFjZSBhcyByZXF1aXJlKCdwYXRoJykucmVzb2x2ZS4KICAgKgogICAqIE11Y2ggZmFzdGVyIHRoYW4gcGF0aC5yZXNvbHZlKCkgd2hlbiBjYWxsZWQgbXVsdGlwbGUgdGltZXMgZm9yIHRoZSBzYW1lCiAgICogcGF0aCwgYmVjYXVzZSB0aGUgcmVzb2x2ZWQgUGF0aCBvYmplY3RzIGFyZSBjYWNoZWQuICBNdWNoIHNsb3dlcgogICAqIG90aGVyd2lzZS4KICAgKi8KICByZXNvbHZlKC4uLnBhdGhzKSB7CiAgICBsZXQgciA9ICIiOwogICAgZm9yIChsZXQgaSA9IHBhdGhzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgIGNvbnN0IHAgPSBwYXRoc1tpXTsKICAgICAgaWYgKCFwIHx8IHAgPT09ICIuIikKICAgICAgICBjb250aW51ZTsKICAgICAgciA9IHIgPyBgJHtwfS8ke3J9YCA6IHA7CiAgICAgIGlmICh0aGlzLmlzQWJzb2x1dGUocCkpIHsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogICAgY29uc3QgY2FjaGVkID0gdGhpcy4jcmVzb2x2ZUNhY2hlLmdldChyKTsKICAgIGlmIChjYWNoZWQgIT09IHZvaWQgMCkgewogICAgICByZXR1cm4gY2FjaGVkOwogICAgfQogICAgY29uc3QgcmVzdWx0ID0gdGhpcy5jd2QucmVzb2x2ZShyKS5mdWxscGF0aCgpOwogICAgdGhpcy4jcmVzb2x2ZUNhY2hlLnNldChyLCByZXN1bHQpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgLyoqCiAgICogUmVzb2x2ZSBvbmUgb3IgbW9yZSBwYXRoIHN0cmluZ3MgdG8gYSByZXNvbHZlZCBzdHJpbmcsIHJldHVybmluZwogICAqIHRoZSBwb3NpeCBwYXRoLiAgSWRlbnRpY2FsIHRvIC5yZXNvbHZlKCkgb24gcG9zaXggc3lzdGVtcywgYnV0IG9uCiAgICogd2luZG93cyB3aWxsIHJldHVybiBhIGZvcndhcmQtc2xhc2ggc2VwYXJhdGVkIFVOQyBwYXRoLgogICAqCiAgICogU2FtZSBpbnRlcmZhY2UgYXMgcmVxdWlyZSgncGF0aCcpLnJlc29sdmUuCiAgICoKICAgKiBNdWNoIGZhc3RlciB0aGFuIHBhdGgucmVzb2x2ZSgpIHdoZW4gY2FsbGVkIG11bHRpcGxlIHRpbWVzIGZvciB0aGUgc2FtZQogICAqIHBhdGgsIGJlY2F1c2UgdGhlIHJlc29sdmVkIFBhdGggb2JqZWN0cyBhcmUgY2FjaGVkLiAgTXVjaCBzbG93ZXIKICAgKiBvdGhlcndpc2UuCiAgICovCiAgcmVzb2x2ZVBvc2l4KC4uLnBhdGhzKSB7CiAgICBsZXQgciA9ICIiOwogICAgZm9yIChsZXQgaSA9IHBhdGhzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgIGNvbnN0IHAgPSBwYXRoc1tpXTsKICAgICAgaWYgKCFwIHx8IHAgPT09ICIuIikKICAgICAgICBjb250aW51ZTsKICAgICAgciA9IHIgPyBgJHtwfS8ke3J9YCA6IHA7CiAgICAgIGlmICh0aGlzLmlzQWJzb2x1dGUocCkpIHsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogICAgY29uc3QgY2FjaGVkID0gdGhpcy4jcmVzb2x2ZVBvc2l4Q2FjaGUuZ2V0KHIpOwogICAgaWYgKGNhY2hlZCAhPT0gdm9pZCAwKSB7CiAgICAgIHJldHVybiBjYWNoZWQ7CiAgICB9CiAgICBjb25zdCByZXN1bHQgPSB0aGlzLmN3ZC5yZXNvbHZlKHIpLmZ1bGxwYXRoUG9zaXgoKTsKICAgIHRoaXMuI3Jlc29sdmVQb3NpeENhY2hlLnNldChyLCByZXN1bHQpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgLyoqCiAgICogZmluZCB0aGUgcmVsYXRpdmUgcGF0aCBmcm9tIHRoZSBjd2QgdG8gdGhlIHN1cHBsaWVkIHBhdGggc3RyaW5nIG9yIGVudHJ5CiAgICovCiAgcmVsYXRpdmUoZW50cnkyID0gdGhpcy5jd2QpIHsKICAgIGlmICh0eXBlb2YgZW50cnkyID09PSAic3RyaW5nIikgewogICAgICBlbnRyeTIgPSB0aGlzLmN3ZC5yZXNvbHZlKGVudHJ5Mik7CiAgICB9CiAgICByZXR1cm4gZW50cnkyLnJlbGF0aXZlKCk7CiAgfQogIC8qKgogICAqIGZpbmQgdGhlIHJlbGF0aXZlIHBhdGggZnJvbSB0aGUgY3dkIHRvIHRoZSBzdXBwbGllZCBwYXRoIHN0cmluZyBvcgogICAqIGVudHJ5LCB1c2luZyAvIGFzIHRoZSBwYXRoIGRlbGltaXRlciwgZXZlbiBvbiBXaW5kb3dzLgogICAqLwogIHJlbGF0aXZlUG9zaXgoZW50cnkyID0gdGhpcy5jd2QpIHsKICAgIGlmICh0eXBlb2YgZW50cnkyID09PSAic3RyaW5nIikgewogICAgICBlbnRyeTIgPSB0aGlzLmN3ZC5yZXNvbHZlKGVudHJ5Mik7CiAgICB9CiAgICByZXR1cm4gZW50cnkyLnJlbGF0aXZlUG9zaXgoKTsKICB9CiAgLyoqCiAgICogUmV0dXJuIHRoZSBiYXNlbmFtZSBmb3IgdGhlIHByb3ZpZGVkIHN0cmluZyBvciBQYXRoIG9iamVjdAogICAqLwogIGJhc2VuYW1lKGVudHJ5MiA9IHRoaXMuY3dkKSB7CiAgICBpZiAodHlwZW9mIGVudHJ5MiA9PT0gInN0cmluZyIpIHsKICAgICAgZW50cnkyID0gdGhpcy5jd2QucmVzb2x2ZShlbnRyeTIpOwogICAgfQogICAgcmV0dXJuIGVudHJ5Mi5uYW1lOwogIH0KICAvKioKICAgKiBSZXR1cm4gdGhlIGRpcm5hbWUgZm9yIHRoZSBwcm92aWRlZCBzdHJpbmcgb3IgUGF0aCBvYmplY3QKICAgKi8KICBkaXJuYW1lKGVudHJ5MiA9IHRoaXMuY3dkKSB7CiAgICBpZiAodHlwZW9mIGVudHJ5MiA9PT0gInN0cmluZyIpIHsKICAgICAgZW50cnkyID0gdGhpcy5jd2QucmVzb2x2ZShlbnRyeTIpOwogICAgfQogICAgcmV0dXJuIChlbnRyeTIucGFyZW50IHx8IGVudHJ5MikuZnVsbHBhdGgoKTsKICB9CiAgYXN5bmMgcmVhZGRpcihlbnRyeTIgPSB0aGlzLmN3ZCwgb3B0cyA9IHsKICAgIHdpdGhGaWxlVHlwZXM6IHRydWUKICB9KSB7CiAgICBpZiAodHlwZW9mIGVudHJ5MiA9PT0gInN0cmluZyIpIHsKICAgICAgZW50cnkyID0gdGhpcy5jd2QucmVzb2x2ZShlbnRyeTIpOwogICAgfSBlbHNlIGlmICghKGVudHJ5MiBpbnN0YW5jZW9mIFBhdGhCYXNlKSkgewogICAgICBvcHRzID0gZW50cnkyOwogICAgICBlbnRyeTIgPSB0aGlzLmN3ZDsKICAgIH0KICAgIGNvbnN0IHsgd2l0aEZpbGVUeXBlcyB9ID0gb3B0czsKICAgIGlmICghZW50cnkyLmNhblJlYWRkaXIoKSkgewogICAgICByZXR1cm4gW107CiAgICB9IGVsc2UgewogICAgICBjb25zdCBwID0gYXdhaXQgZW50cnkyLnJlYWRkaXIoKTsKICAgICAgcmV0dXJuIHdpdGhGaWxlVHlwZXMgPyBwIDogcC5tYXAoKGUpID0+IGUubmFtZSk7CiAgICB9CiAgfQogIHJlYWRkaXJTeW5jKGVudHJ5MiA9IHRoaXMuY3dkLCBvcHRzID0gewogICAgd2l0aEZpbGVUeXBlczogdHJ1ZQogIH0pIHsKICAgIGlmICh0eXBlb2YgZW50cnkyID09PSAic3RyaW5nIikgewogICAgICBlbnRyeTIgPSB0aGlzLmN3ZC5yZXNvbHZlKGVudHJ5Mik7CiAgICB9IGVsc2UgaWYgKCEoZW50cnkyIGluc3RhbmNlb2YgUGF0aEJhc2UpKSB7CiAgICAgIG9wdHMgPSBlbnRyeTI7CiAgICAgIGVudHJ5MiA9IHRoaXMuY3dkOwogICAgfQogICAgY29uc3QgeyB3aXRoRmlsZVR5cGVzID0gdHJ1ZSB9ID0gb3B0czsKICAgIGlmICghZW50cnkyLmNhblJlYWRkaXIoKSkgewogICAgICByZXR1cm4gW107CiAgICB9IGVsc2UgaWYgKHdpdGhGaWxlVHlwZXMpIHsKICAgICAgcmV0dXJuIGVudHJ5Mi5yZWFkZGlyU3luYygpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGVudHJ5Mi5yZWFkZGlyU3luYygpLm1hcCgoZSkgPT4gZS5uYW1lKTsKICAgIH0KICB9CiAgLyoqCiAgICogQ2FsbCBsc3RhdCgpIG9uIHRoZSBzdHJpbmcgb3IgUGF0aCBvYmplY3QsIGFuZCB1cGRhdGUgYWxsIGtub3duCiAgICogaW5mb3JtYXRpb24gdGhhdCBjYW4gYmUgZGV0ZXJtaW5lZC4KICAgKgogICAqIE5vdGUgdGhhdCB1bmxpa2UgYGZzLmxzdGF0KClgLCB0aGUgcmV0dXJuZWQgdmFsdWUgZG9lcyBub3QgY29udGFpbiBzb21lCiAgICogaW5mb3JtYXRpb24sIHN1Y2ggYXMgYG1vZGVgLCBgZGV2YCwgYG5saW5rYCwgYW5kIGBpbm9gLiAgSWYgdGhhdAogICAqIGluZm9ybWF0aW9uIGlzIHJlcXVpcmVkLCB5b3Ugd2lsbCBuZWVkIHRvIGNhbGwgYGZzLmxzdGF0YCB5b3Vyc2VsZi4KICAgKgogICAqIElmIHRoZSBQYXRoIHJlZmVycyB0byBhIG5vbmV4aXN0ZW50IGZpbGUsIG9yIGlmIHRoZSBsc3RhdCBjYWxsIGZhaWxzIGZvcgogICAqIGFueSByZWFzb24sIGB1bmRlZmluZWRgIGlzIHJldHVybmVkLiAgT3RoZXJ3aXNlIHRoZSB1cGRhdGVkIFBhdGggb2JqZWN0IGlzCiAgICogcmV0dXJuZWQuCiAgICoKICAgKiBSZXN1bHRzIGFyZSBjYWNoZWQsIGFuZCB0aHVzIG1heSBiZSBvdXQgb2YgZGF0ZSBpZiB0aGUgZmlsZXN5c3RlbSBpcwogICAqIG11dGF0ZWQuCiAgICovCiAgYXN5bmMgbHN0YXQoZW50cnkyID0gdGhpcy5jd2QpIHsKICAgIGlmICh0eXBlb2YgZW50cnkyID09PSAic3RyaW5nIikgewogICAgICBlbnRyeTIgPSB0aGlzLmN3ZC5yZXNvbHZlKGVudHJ5Mik7CiAgICB9CiAgICByZXR1cm4gZW50cnkyLmxzdGF0KCk7CiAgfQogIC8qKgogICAqIHN5bmNocm9ub3VzIHtAbGluayBQYXRoU2N1cnJ5QmFzZS5sc3RhdH0KICAgKi8KICBsc3RhdFN5bmMoZW50cnkyID0gdGhpcy5jd2QpIHsKICAgIGlmICh0eXBlb2YgZW50cnkyID09PSAic3RyaW5nIikgewogICAgICBlbnRyeTIgPSB0aGlzLmN3ZC5yZXNvbHZlKGVudHJ5Mik7CiAgICB9CiAgICByZXR1cm4gZW50cnkyLmxzdGF0U3luYygpOwogIH0KICBhc3luYyByZWFkbGluayhlbnRyeTIgPSB0aGlzLmN3ZCwgeyB3aXRoRmlsZVR5cGVzIH0gPSB7CiAgICB3aXRoRmlsZVR5cGVzOiBmYWxzZQogIH0pIHsKICAgIGlmICh0eXBlb2YgZW50cnkyID09PSAic3RyaW5nIikgewogICAgICBlbnRyeTIgPSB0aGlzLmN3ZC5yZXNvbHZlKGVudHJ5Mik7CiAgICB9IGVsc2UgaWYgKCEoZW50cnkyIGluc3RhbmNlb2YgUGF0aEJhc2UpKSB7CiAgICAgIHdpdGhGaWxlVHlwZXMgPSBlbnRyeTIud2l0aEZpbGVUeXBlczsKICAgICAgZW50cnkyID0gdGhpcy5jd2Q7CiAgICB9CiAgICBjb25zdCBlID0gYXdhaXQgZW50cnkyLnJlYWRsaW5rKCk7CiAgICByZXR1cm4gd2l0aEZpbGVUeXBlcyA/IGUgOiBlPy5mdWxscGF0aCgpOwogIH0KICByZWFkbGlua1N5bmMoZW50cnkyID0gdGhpcy5jd2QsIHsgd2l0aEZpbGVUeXBlcyB9ID0gewogICAgd2l0aEZpbGVUeXBlczogZmFsc2UKICB9KSB7CiAgICBpZiAodHlwZW9mIGVudHJ5MiA9PT0gInN0cmluZyIpIHsKICAgICAgZW50cnkyID0gdGhpcy5jd2QucmVzb2x2ZShlbnRyeTIpOwogICAgfSBlbHNlIGlmICghKGVudHJ5MiBpbnN0YW5jZW9mIFBhdGhCYXNlKSkgewogICAgICB3aXRoRmlsZVR5cGVzID0gZW50cnkyLndpdGhGaWxlVHlwZXM7CiAgICAgIGVudHJ5MiA9IHRoaXMuY3dkOwogICAgfQogICAgY29uc3QgZSA9IGVudHJ5Mi5yZWFkbGlua1N5bmMoKTsKICAgIHJldHVybiB3aXRoRmlsZVR5cGVzID8gZSA6IGU/LmZ1bGxwYXRoKCk7CiAgfQogIGFzeW5jIHJlYWxwYXRoKGVudHJ5MiA9IHRoaXMuY3dkLCB7IHdpdGhGaWxlVHlwZXMgfSA9IHsKICAgIHdpdGhGaWxlVHlwZXM6IGZhbHNlCiAgfSkgewogICAgaWYgKHR5cGVvZiBlbnRyeTIgPT09ICJzdHJpbmciKSB7CiAgICAgIGVudHJ5MiA9IHRoaXMuY3dkLnJlc29sdmUoZW50cnkyKTsKICAgIH0gZWxzZSBpZiAoIShlbnRyeTIgaW5zdGFuY2VvZiBQYXRoQmFzZSkpIHsKICAgICAgd2l0aEZpbGVUeXBlcyA9IGVudHJ5Mi53aXRoRmlsZVR5cGVzOwogICAgICBlbnRyeTIgPSB0aGlzLmN3ZDsKICAgIH0KICAgIGNvbnN0IGUgPSBhd2FpdCBlbnRyeTIucmVhbHBhdGgoKTsKICAgIHJldHVybiB3aXRoRmlsZVR5cGVzID8gZSA6IGU/LmZ1bGxwYXRoKCk7CiAgfQogIHJlYWxwYXRoU3luYyhlbnRyeTIgPSB0aGlzLmN3ZCwgeyB3aXRoRmlsZVR5cGVzIH0gPSB7CiAgICB3aXRoRmlsZVR5cGVzOiBmYWxzZQogIH0pIHsKICAgIGlmICh0eXBlb2YgZW50cnkyID09PSAic3RyaW5nIikgewogICAgICBlbnRyeTIgPSB0aGlzLmN3ZC5yZXNvbHZlKGVudHJ5Mik7CiAgICB9IGVsc2UgaWYgKCEoZW50cnkyIGluc3RhbmNlb2YgUGF0aEJhc2UpKSB7CiAgICAgIHdpdGhGaWxlVHlwZXMgPSBlbnRyeTIud2l0aEZpbGVUeXBlczsKICAgICAgZW50cnkyID0gdGhpcy5jd2Q7CiAgICB9CiAgICBjb25zdCBlID0gZW50cnkyLnJlYWxwYXRoU3luYygpOwogICAgcmV0dXJuIHdpdGhGaWxlVHlwZXMgPyBlIDogZT8uZnVsbHBhdGgoKTsKICB9CiAgYXN5bmMgd2FsayhlbnRyeTIgPSB0aGlzLmN3ZCwgb3B0cyA9IHt9KSB7CiAgICBpZiAodHlwZW9mIGVudHJ5MiA9PT0gInN0cmluZyIpIHsKICAgICAgZW50cnkyID0gdGhpcy5jd2QucmVzb2x2ZShlbnRyeTIpOwogICAgfSBlbHNlIGlmICghKGVudHJ5MiBpbnN0YW5jZW9mIFBhdGhCYXNlKSkgewogICAgICBvcHRzID0gZW50cnkyOwogICAgICBlbnRyeTIgPSB0aGlzLmN3ZDsKICAgIH0KICAgIGNvbnN0IHsgd2l0aEZpbGVUeXBlcyA9IHRydWUsIGZvbGxvdyA9IGZhbHNlLCBmaWx0ZXI6IGZpbHRlcjIsIHdhbGtGaWx0ZXIgfSA9IG9wdHM7CiAgICBjb25zdCByZXN1bHRzID0gW107CiAgICBpZiAoIWZpbHRlcjIgfHwgZmlsdGVyMihlbnRyeTIpKSB7CiAgICAgIHJlc3VsdHMucHVzaCh3aXRoRmlsZVR5cGVzID8gZW50cnkyIDogZW50cnkyLmZ1bGxwYXRoKCkpOwogICAgfQogICAgY29uc3QgZGlycyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICBjb25zdCB3YWxrID0gKGRpciwgY2IpID0+IHsKICAgICAgZGlycy5hZGQoZGlyKTsKICAgICAgZGlyLnJlYWRkaXJDQigoZXIsIGVudHJpZXMpID0+IHsKICAgICAgICBpZiAoZXIpIHsKICAgICAgICAgIHJldHVybiBjYihlcik7CiAgICAgICAgfQogICAgICAgIGxldCBsZW4gPSBlbnRyaWVzLmxlbmd0aDsKICAgICAgICBpZiAoIWxlbikKICAgICAgICAgIHJldHVybiBjYigpOwogICAgICAgIGNvbnN0IG5leHQgPSAoKSA9PiB7CiAgICAgICAgICBpZiAoLS1sZW4gPT09IDApIHsKICAgICAgICAgICAgY2IoKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGZvciAoY29uc3QgZSBvZiBlbnRyaWVzKSB7CiAgICAgICAgICBpZiAoIWZpbHRlcjIgfHwgZmlsdGVyMihlKSkgewogICAgICAgICAgICByZXN1bHRzLnB1c2god2l0aEZpbGVUeXBlcyA/IGUgOiBlLmZ1bGxwYXRoKCkpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGZvbGxvdyAmJiBlLmlzU3ltYm9saWNMaW5rKCkpIHsKICAgICAgICAgICAgZS5yZWFscGF0aCgpLnRoZW4oKHIpID0+IHI/LmlzVW5rbm93bigpID8gci5sc3RhdCgpIDogcikudGhlbigocikgPT4gcj8uc2hvdWxkV2FsayhkaXJzLCB3YWxrRmlsdGVyKSA/IHdhbGsociwgbmV4dCkgOiBuZXh0KCkpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKGUuc2hvdWxkV2FsayhkaXJzLCB3YWxrRmlsdGVyKSkgewogICAgICAgICAgICAgIHdhbGsoZSwgbmV4dCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbmV4dCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LCB0cnVlKTsKICAgIH07CiAgICBjb25zdCBzdGFydCA9IGVudHJ5MjsKICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzLCByZWopID0+IHsKICAgICAgd2FsayhzdGFydCwgKGVyKSA9PiB7CiAgICAgICAgaWYgKGVyKQogICAgICAgICAgcmV0dXJuIHJlaihlcik7CiAgICAgICAgcmVzKHJlc3VsdHMpOwogICAgICB9KTsKICAgIH0pOwogIH0KICB3YWxrU3luYyhlbnRyeTIgPSB0aGlzLmN3ZCwgb3B0cyA9IHt9KSB7CiAgICBpZiAodHlwZW9mIGVudHJ5MiA9PT0gInN0cmluZyIpIHsKICAgICAgZW50cnkyID0gdGhpcy5jd2QucmVzb2x2ZShlbnRyeTIpOwogICAgfSBlbHNlIGlmICghKGVudHJ5MiBpbnN0YW5jZW9mIFBhdGhCYXNlKSkgewogICAgICBvcHRzID0gZW50cnkyOwogICAgICBlbnRyeTIgPSB0aGlzLmN3ZDsKICAgIH0KICAgIGNvbnN0IHsgd2l0aEZpbGVUeXBlcyA9IHRydWUsIGZvbGxvdyA9IGZhbHNlLCBmaWx0ZXI6IGZpbHRlcjIsIHdhbGtGaWx0ZXIgfSA9IG9wdHM7CiAgICBjb25zdCByZXN1bHRzID0gW107CiAgICBpZiAoIWZpbHRlcjIgfHwgZmlsdGVyMihlbnRyeTIpKSB7CiAgICAgIHJlc3VsdHMucHVzaCh3aXRoRmlsZVR5cGVzID8gZW50cnkyIDogZW50cnkyLmZ1bGxwYXRoKCkpOwogICAgfQogICAgY29uc3QgZGlycyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KFtlbnRyeTJdKTsKICAgIGZvciAoY29uc3QgZGlyIG9mIGRpcnMpIHsKICAgICAgY29uc3QgZW50cmllcyA9IGRpci5yZWFkZGlyU3luYygpOwogICAgICBmb3IgKGNvbnN0IGUgb2YgZW50cmllcykgewogICAgICAgIGlmICghZmlsdGVyMiB8fCBmaWx0ZXIyKGUpKSB7CiAgICAgICAgICByZXN1bHRzLnB1c2god2l0aEZpbGVUeXBlcyA/IGUgOiBlLmZ1bGxwYXRoKCkpOwogICAgICAgIH0KICAgICAgICBsZXQgciA9IGU7CiAgICAgICAgaWYgKGUuaXNTeW1ib2xpY0xpbmsoKSkgewogICAgICAgICAgaWYgKCEoZm9sbG93ICYmIChyID0gZS5yZWFscGF0aFN5bmMoKSkpKQogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIGlmIChyLmlzVW5rbm93bigpKQogICAgICAgICAgICByLmxzdGF0U3luYygpOwogICAgICAgIH0KICAgICAgICBpZiAoci5zaG91bGRXYWxrKGRpcnMsIHdhbGtGaWx0ZXIpKSB7CiAgICAgICAgICBkaXJzLmFkZChyKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXN1bHRzOwogIH0KICAvKioKICAgKiBTdXBwb3J0IGZvciBgZm9yIGF3YWl0YAogICAqCiAgICogQWxpYXMgZm9yIHtAbGluayBQYXRoU2N1cnJ5QmFzZS5pdGVyYXRlfQogICAqCiAgICogTm90ZTogQXMgb2YgTm9kZSAxOSwgdGhpcyBpcyB2ZXJ5IHNsb3csIGNvbXBhcmVkIHRvIG90aGVyIG1ldGhvZHMgb2YKICAgKiB3YWxraW5nLiAgQ29uc2lkZXIgdXNpbmcge0BsaW5rIFBhdGhTY3VycnlCYXNlLnN0cmVhbX0gaWYgbWVtb3J5IG92ZXJoZWFkCiAgICogYW5kIGJhY2twcmVzc3VyZSBhcmUgY29uY2VybnMsIG9yIHtAbGluayBQYXRoU2N1cnJ5QmFzZS53YWxrfSBpZiBub3QuCiAgICovCiAgW1N5bWJvbC5hc3luY0l0ZXJhdG9yXSgpIHsKICAgIHJldHVybiB0aGlzLml0ZXJhdGUoKTsKICB9CiAgaXRlcmF0ZShlbnRyeTIgPSB0aGlzLmN3ZCwgb3B0aW9ucyA9IHt9KSB7CiAgICBpZiAodHlwZW9mIGVudHJ5MiA9PT0gInN0cmluZyIpIHsKICAgICAgZW50cnkyID0gdGhpcy5jd2QucmVzb2x2ZShlbnRyeTIpOwogICAgfSBlbHNlIGlmICghKGVudHJ5MiBpbnN0YW5jZW9mIFBhdGhCYXNlKSkgewogICAgICBvcHRpb25zID0gZW50cnkyOwogICAgICBlbnRyeTIgPSB0aGlzLmN3ZDsKICAgIH0KICAgIHJldHVybiB0aGlzLnN0cmVhbShlbnRyeTIsIG9wdGlvbnMpW1N5bWJvbC5hc3luY0l0ZXJhdG9yXSgpOwogIH0KICAvKioKICAgKiBJdGVyYXRpbmcgb3ZlciBhIFBhdGhTY3VycnkgcGVyZm9ybXMgYSBzeW5jaHJvbm91cyB3YWxrLgogICAqCiAgICogQWxpYXMgZm9yIHtAbGluayBQYXRoU2N1cnJ5QmFzZS5pdGVyYXRlU3luY30KICAgKi8KICBbU3ltYm9sLml0ZXJhdG9yXSgpIHsKICAgIHJldHVybiB0aGlzLml0ZXJhdGVTeW5jKCk7CiAgfQogICppdGVyYXRlU3luYyhlbnRyeTIgPSB0aGlzLmN3ZCwgb3B0cyA9IHt9KSB7CiAgICBpZiAodHlwZW9mIGVudHJ5MiA9PT0gInN0cmluZyIpIHsKICAgICAgZW50cnkyID0gdGhpcy5jd2QucmVzb2x2ZShlbnRyeTIpOwogICAgfSBlbHNlIGlmICghKGVudHJ5MiBpbnN0YW5jZW9mIFBhdGhCYXNlKSkgewogICAgICBvcHRzID0gZW50cnkyOwogICAgICBlbnRyeTIgPSB0aGlzLmN3ZDsKICAgIH0KICAgIGNvbnN0IHsgd2l0aEZpbGVUeXBlcyA9IHRydWUsIGZvbGxvdyA9IGZhbHNlLCBmaWx0ZXI6IGZpbHRlcjIsIHdhbGtGaWx0ZXIgfSA9IG9wdHM7CiAgICBpZiAoIWZpbHRlcjIgfHwgZmlsdGVyMihlbnRyeTIpKSB7CiAgICAgIHlpZWxkIHdpdGhGaWxlVHlwZXMgPyBlbnRyeTIgOiBlbnRyeTIuZnVsbHBhdGgoKTsKICAgIH0KICAgIGNvbnN0IGRpcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldChbZW50cnkyXSk7CiAgICBmb3IgKGNvbnN0IGRpciBvZiBkaXJzKSB7CiAgICAgIGNvbnN0IGVudHJpZXMgPSBkaXIucmVhZGRpclN5bmMoKTsKICAgICAgZm9yIChjb25zdCBlIG9mIGVudHJpZXMpIHsKICAgICAgICBpZiAoIWZpbHRlcjIgfHwgZmlsdGVyMihlKSkgewogICAgICAgICAgeWllbGQgd2l0aEZpbGVUeXBlcyA/IGUgOiBlLmZ1bGxwYXRoKCk7CiAgICAgICAgfQogICAgICAgIGxldCByID0gZTsKICAgICAgICBpZiAoZS5pc1N5bWJvbGljTGluaygpKSB7CiAgICAgICAgICBpZiAoIShmb2xsb3cgJiYgKHIgPSBlLnJlYWxwYXRoU3luYygpKSkpCiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgaWYgKHIuaXNVbmtub3duKCkpCiAgICAgICAgICAgIHIubHN0YXRTeW5jKCk7CiAgICAgICAgfQogICAgICAgIGlmIChyLnNob3VsZFdhbGsoZGlycywgd2Fsa0ZpbHRlcikpIHsKICAgICAgICAgIGRpcnMuYWRkKHIpOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KICBzdHJlYW0oZW50cnkyID0gdGhpcy5jd2QsIG9wdHMgPSB7fSkgewogICAgaWYgKHR5cGVvZiBlbnRyeTIgPT09ICJzdHJpbmciKSB7CiAgICAgIGVudHJ5MiA9IHRoaXMuY3dkLnJlc29sdmUoZW50cnkyKTsKICAgIH0gZWxzZSBpZiAoIShlbnRyeTIgaW5zdGFuY2VvZiBQYXRoQmFzZSkpIHsKICAgICAgb3B0cyA9IGVudHJ5MjsKICAgICAgZW50cnkyID0gdGhpcy5jd2Q7CiAgICB9CiAgICBjb25zdCB7IHdpdGhGaWxlVHlwZXMgPSB0cnVlLCBmb2xsb3cgPSBmYWxzZSwgZmlsdGVyOiBmaWx0ZXIyLCB3YWxrRmlsdGVyIH0gPSBvcHRzOwogICAgY29uc3QgcmVzdWx0cyA9IG5ldyBNaW5pcGFzcyh7IG9iamVjdE1vZGU6IHRydWUgfSk7CiAgICBpZiAoIWZpbHRlcjIgfHwgZmlsdGVyMihlbnRyeTIpKSB7CiAgICAgIHJlc3VsdHMud3JpdGUod2l0aEZpbGVUeXBlcyA/IGVudHJ5MiA6IGVudHJ5Mi5mdWxscGF0aCgpKTsKICAgIH0KICAgIGNvbnN0IGRpcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgY29uc3QgcXVldWUgPSBbZW50cnkyXTsKICAgIGxldCBwcm9jZXNzaW5nID0gMDsKICAgIGNvbnN0IHByb2Nlc3MyID0gKCkgPT4gewogICAgICBsZXQgcGF1c2VkID0gZmFsc2U7CiAgICAgIHdoaWxlICghcGF1c2VkKSB7CiAgICAgICAgY29uc3QgZGlyID0gcXVldWUuc2hpZnQoKTsKICAgICAgICBpZiAoIWRpcikgewogICAgICAgICAgaWYgKHByb2Nlc3NpbmcgPT09IDApCiAgICAgICAgICAgIHJlc3VsdHMuZW5kKCk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHByb2Nlc3NpbmcrKzsKICAgICAgICBkaXJzLmFkZChkaXIpOwogICAgICAgIGNvbnN0IG9uUmVhZGRpciA9IChlciwgZW50cmllcywgZGlkUmVhbHBhdGhzID0gZmFsc2UpID0+IHsKICAgICAgICAgIGlmIChlcikKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdHMuZW1pdCgiZXJyb3IiLCBlcik7CiAgICAgICAgICBpZiAoZm9sbG93ICYmICFkaWRSZWFscGF0aHMpIHsKICAgICAgICAgICAgY29uc3QgcHJvbWlzZXMgPSBbXTsKICAgICAgICAgICAgZm9yIChjb25zdCBlIG9mIGVudHJpZXMpIHsKICAgICAgICAgICAgICBpZiAoZS5pc1N5bWJvbGljTGluaygpKSB7CiAgICAgICAgICAgICAgICBwcm9taXNlcy5wdXNoKGUucmVhbHBhdGgoKS50aGVuKChyKSA9PiByPy5pc1Vua25vd24oKSA/IHIubHN0YXQoKSA6IHIpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHByb21pc2VzLmxlbmd0aCkgewogICAgICAgICAgICAgIFByb21pc2UuYWxsKHByb21pc2VzKS50aGVuKCgpID0+IG9uUmVhZGRpcihudWxsLCBlbnRyaWVzLCB0cnVlKSk7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKGNvbnN0IGUgb2YgZW50cmllcykgewogICAgICAgICAgICBpZiAoZSAmJiAoIWZpbHRlcjIgfHwgZmlsdGVyMihlKSkpIHsKICAgICAgICAgICAgICBpZiAoIXJlc3VsdHMud3JpdGUod2l0aEZpbGVUeXBlcyA/IGUgOiBlLmZ1bGxwYXRoKCkpKSB7CiAgICAgICAgICAgICAgICBwYXVzZWQgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcHJvY2Vzc2luZy0tOwogICAgICAgICAgZm9yIChjb25zdCBlIG9mIGVudHJpZXMpIHsKICAgICAgICAgICAgY29uc3QgciA9IGUucmVhbHBhdGhDYWNoZWQoKSB8fCBlOwogICAgICAgICAgICBpZiAoci5zaG91bGRXYWxrKGRpcnMsIHdhbGtGaWx0ZXIpKSB7CiAgICAgICAgICAgICAgcXVldWUucHVzaChyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHBhdXNlZCAmJiAhcmVzdWx0cy5mbG93aW5nKSB7CiAgICAgICAgICAgIHJlc3VsdHMub25jZSgiZHJhaW4iLCBwcm9jZXNzMik7CiAgICAgICAgICB9IGVsc2UgaWYgKCFzeW5jMikgewogICAgICAgICAgICBwcm9jZXNzMigpOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgbGV0IHN5bmMyID0gdHJ1ZTsKICAgICAgICBkaXIucmVhZGRpckNCKG9uUmVhZGRpciwgdHJ1ZSk7CiAgICAgICAgc3luYzIgPSBmYWxzZTsKICAgICAgfQogICAgfTsKICAgIHByb2Nlc3MyKCk7CiAgICByZXR1cm4gcmVzdWx0czsKICB9CiAgc3RyZWFtU3luYyhlbnRyeTIgPSB0aGlzLmN3ZCwgb3B0cyA9IHt9KSB7CiAgICBpZiAodHlwZW9mIGVudHJ5MiA9PT0gInN0cmluZyIpIHsKICAgICAgZW50cnkyID0gdGhpcy5jd2QucmVzb2x2ZShlbnRyeTIpOwogICAgfSBlbHNlIGlmICghKGVudHJ5MiBpbnN0YW5jZW9mIFBhdGhCYXNlKSkgewogICAgICBvcHRzID0gZW50cnkyOwogICAgICBlbnRyeTIgPSB0aGlzLmN3ZDsKICAgIH0KICAgIGNvbnN0IHsgd2l0aEZpbGVUeXBlcyA9IHRydWUsIGZvbGxvdyA9IGZhbHNlLCBmaWx0ZXI6IGZpbHRlcjIsIHdhbGtGaWx0ZXIgfSA9IG9wdHM7CiAgICBjb25zdCByZXN1bHRzID0gbmV3IE1pbmlwYXNzKHsgb2JqZWN0TW9kZTogdHJ1ZSB9KTsKICAgIGNvbnN0IGRpcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgaWYgKCFmaWx0ZXIyIHx8IGZpbHRlcjIoZW50cnkyKSkgewogICAgICByZXN1bHRzLndyaXRlKHdpdGhGaWxlVHlwZXMgPyBlbnRyeTIgOiBlbnRyeTIuZnVsbHBhdGgoKSk7CiAgICB9CiAgICBjb25zdCBxdWV1ZSA9IFtlbnRyeTJdOwogICAgbGV0IHByb2Nlc3NpbmcgPSAwOwogICAgY29uc3QgcHJvY2VzczIgPSAoKSA9PiB7CiAgICAgIGxldCBwYXVzZWQgPSBmYWxzZTsKICAgICAgd2hpbGUgKCFwYXVzZWQpIHsKICAgICAgICBjb25zdCBkaXIgPSBxdWV1ZS5zaGlmdCgpOwogICAgICAgIGlmICghZGlyKSB7CiAgICAgICAgICBpZiAocHJvY2Vzc2luZyA9PT0gMCkKICAgICAgICAgICAgcmVzdWx0cy5lbmQoKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgcHJvY2Vzc2luZysrOwogICAgICAgIGRpcnMuYWRkKGRpcik7CiAgICAgICAgY29uc3QgZW50cmllcyA9IGRpci5yZWFkZGlyU3luYygpOwogICAgICAgIGZvciAoY29uc3QgZSBvZiBlbnRyaWVzKSB7CiAgICAgICAgICBpZiAoIWZpbHRlcjIgfHwgZmlsdGVyMihlKSkgewogICAgICAgICAgICBpZiAoIXJlc3VsdHMud3JpdGUod2l0aEZpbGVUeXBlcyA/IGUgOiBlLmZ1bGxwYXRoKCkpKSB7CiAgICAgICAgICAgICAgcGF1c2VkID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBwcm9jZXNzaW5nLS07CiAgICAgICAgZm9yIChjb25zdCBlIG9mIGVudHJpZXMpIHsKICAgICAgICAgIGxldCByID0gZTsKICAgICAgICAgIGlmIChlLmlzU3ltYm9saWNMaW5rKCkpIHsKICAgICAgICAgICAgaWYgKCEoZm9sbG93ICYmIChyID0gZS5yZWFscGF0aFN5bmMoKSkpKQogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICBpZiAoci5pc1Vua25vd24oKSkKICAgICAgICAgICAgICByLmxzdGF0U3luYygpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHIuc2hvdWxkV2FsayhkaXJzLCB3YWxrRmlsdGVyKSkgewogICAgICAgICAgICBxdWV1ZS5wdXNoKHIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICBpZiAocGF1c2VkICYmICFyZXN1bHRzLmZsb3dpbmcpCiAgICAgICAgcmVzdWx0cy5vbmNlKCJkcmFpbiIsIHByb2Nlc3MyKTsKICAgIH07CiAgICBwcm9jZXNzMigpOwogICAgcmV0dXJuIHJlc3VsdHM7CiAgfQogIGNoZGlyKHBhdGgyID0gdGhpcy5jd2QpIHsKICAgIGNvbnN0IG9sZEN3ZCA9IHRoaXMuY3dkOwogICAgdGhpcy5jd2QgPSB0eXBlb2YgcGF0aDIgPT09ICJzdHJpbmciID8gdGhpcy5jd2QucmVzb2x2ZShwYXRoMikgOiBwYXRoMjsKICAgIHRoaXMuY3dkW3NldEFzQ3dkXShvbGRDd2QpOwogIH0KfQpjbGFzcyBQYXRoU2N1cnJ5V2luMzIgZXh0ZW5kcyBQYXRoU2N1cnJ5QmFzZSB7CiAgLyoqCiAgICogc2VwYXJhdG9yIGZvciBnZW5lcmF0aW5nIHBhdGggc3RyaW5ncwogICAqLwogIHNlcCA9ICJcXCI7CiAgY29uc3RydWN0b3IoY3dkID0gcHJvY2Vzcy5jd2QoKSwgb3B0cyA9IHt9KSB7CiAgICBjb25zdCB7IG5vY2FzZSA9IHRydWUgfSA9IG9wdHM7CiAgICBzdXBlcihjd2QsIHdpbjMyLCAiXFwiLCB7IC4uLm9wdHMsIG5vY2FzZSB9KTsKICAgIHRoaXMubm9jYXNlID0gbm9jYXNlOwogICAgZm9yIChsZXQgcCA9IHRoaXMuY3dkOyBwOyBwID0gcC5wYXJlbnQpIHsKICAgICAgcC5ub2Nhc2UgPSB0aGlzLm5vY2FzZTsKICAgIH0KICB9CiAgLyoqCiAgICogQGludGVybmFsCiAgICovCiAgcGFyc2VSb290UGF0aChkaXIpIHsKICAgIHJldHVybiB3aW4zMi5wYXJzZShkaXIpLnJvb3QudG9VcHBlckNhc2UoKTsKICB9CiAgLyoqCiAgICogQGludGVybmFsCiAgICovCiAgbmV3Um9vdChmczIpIHsKICAgIHJldHVybiBuZXcgUGF0aFdpbjMyKHRoaXMucm9vdFBhdGgsIElGRElSLCB2b2lkIDAsIHRoaXMucm9vdHMsIHRoaXMubm9jYXNlLCB0aGlzLmNoaWxkcmVuQ2FjaGUoKSwgeyBmczogZnMyIH0pOwogIH0KICAvKioKICAgKiBSZXR1cm4gdHJ1ZSBpZiB0aGUgcHJvdmlkZWQgcGF0aCBzdHJpbmcgaXMgYW4gYWJzb2x1dGUgcGF0aAogICAqLwogIGlzQWJzb2x1dGUocCkgewogICAgcmV0dXJuIHAuc3RhcnRzV2l0aCgiLyIpIHx8IHAuc3RhcnRzV2l0aCgiXFwiKSB8fCAvXlthLXpdOihcL3xcXCkvaS50ZXN0KHApOwogIH0KfQpjbGFzcyBQYXRoU2N1cnJ5UG9zaXggZXh0ZW5kcyBQYXRoU2N1cnJ5QmFzZSB7CiAgLyoqCiAgICogc2VwYXJhdG9yIGZvciBnZW5lcmF0aW5nIHBhdGggc3RyaW5ncwogICAqLwogIHNlcCA9ICIvIjsKICBjb25zdHJ1Y3Rvcihjd2QgPSBwcm9jZXNzLmN3ZCgpLCBvcHRzID0ge30pIHsKICAgIGNvbnN0IHsgbm9jYXNlID0gZmFsc2UgfSA9IG9wdHM7CiAgICBzdXBlcihjd2QsIHBvc2l4LCAiLyIsIHsgLi4ub3B0cywgbm9jYXNlIH0pOwogICAgdGhpcy5ub2Nhc2UgPSBub2Nhc2U7CiAgfQogIC8qKgogICAqIEBpbnRlcm5hbAogICAqLwogIHBhcnNlUm9vdFBhdGgoX2RpcikgewogICAgcmV0dXJuICIvIjsKICB9CiAgLyoqCiAgICogQGludGVybmFsCiAgICovCiAgbmV3Um9vdChmczIpIHsKICAgIHJldHVybiBuZXcgUGF0aFBvc2l4KHRoaXMucm9vdFBhdGgsIElGRElSLCB2b2lkIDAsIHRoaXMucm9vdHMsIHRoaXMubm9jYXNlLCB0aGlzLmNoaWxkcmVuQ2FjaGUoKSwgeyBmczogZnMyIH0pOwogIH0KICAvKioKICAgKiBSZXR1cm4gdHJ1ZSBpZiB0aGUgcHJvdmlkZWQgcGF0aCBzdHJpbmcgaXMgYW4gYWJzb2x1dGUgcGF0aAogICAqLwogIGlzQWJzb2x1dGUocCkgewogICAgcmV0dXJuIHAuc3RhcnRzV2l0aCgiLyIpOwogIH0KfQpjbGFzcyBQYXRoU2N1cnJ5RGFyd2luIGV4dGVuZHMgUGF0aFNjdXJyeVBvc2l4IHsKICBjb25zdHJ1Y3Rvcihjd2QgPSBwcm9jZXNzLmN3ZCgpLCBvcHRzID0ge30pIHsKICAgIGNvbnN0IHsgbm9jYXNlID0gdHJ1ZSB9ID0gb3B0czsKICAgIHN1cGVyKGN3ZCwgeyAuLi5vcHRzLCBub2Nhc2UgfSk7CiAgfQp9CnByb2Nlc3MucGxhdGZvcm0gPT09ICJ3aW4zMiIgPyBQYXRoV2luMzIgOiBQYXRoUG9zaXg7CmNvbnN0IFBhdGhTY3VycnkgPSBwcm9jZXNzLnBsYXRmb3JtID09PSAid2luMzIiID8gUGF0aFNjdXJyeVdpbjMyIDogcHJvY2Vzcy5wbGF0Zm9ybSA9PT0gImRhcndpbiIgPyBQYXRoU2N1cnJ5RGFyd2luIDogUGF0aFNjdXJyeVBvc2l4Owpjb25zdCBpc1BhdHRlcm5MaXN0ID0gKHBsKSA9PiBwbC5sZW5ndGggPj0gMTsKY29uc3QgaXNHbG9iTGlzdCA9IChnbCkgPT4gZ2wubGVuZ3RoID49IDE7CmNsYXNzIFBhdHRlcm4gewogICNwYXR0ZXJuTGlzdDsKICAjZ2xvYkxpc3Q7CiAgI2luZGV4OwogIGxlbmd0aDsKICAjcGxhdGZvcm07CiAgI3Jlc3Q7CiAgI2dsb2JTdHJpbmc7CiAgI2lzRHJpdmU7CiAgI2lzVU5DOwogICNpc0Fic29sdXRlOwogICNmb2xsb3dHbG9ic3RhciA9IHRydWU7CiAgY29uc3RydWN0b3IocGF0dGVybkxpc3QsIGdsb2JMaXN0LCBpbmRleCwgcGxhdGZvcm0pIHsKICAgIGlmICghaXNQYXR0ZXJuTGlzdChwYXR0ZXJuTGlzdCkpIHsKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiZW1wdHkgcGF0dGVybiBsaXN0Iik7CiAgICB9CiAgICBpZiAoIWlzR2xvYkxpc3QoZ2xvYkxpc3QpKSB7CiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoImVtcHR5IGdsb2IgbGlzdCIpOwogICAgfQogICAgaWYgKGdsb2JMaXN0Lmxlbmd0aCAhPT0gcGF0dGVybkxpc3QubGVuZ3RoKSB7CiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIm1pc21hdGNoZWQgcGF0dGVybiBsaXN0IGFuZCBnbG9iIGxpc3QgbGVuZ3RocyIpOwogICAgfQogICAgdGhpcy5sZW5ndGggPSBwYXR0ZXJuTGlzdC5sZW5ndGg7CiAgICBpZiAoaW5kZXggPCAwIHx8IGluZGV4ID49IHRoaXMubGVuZ3RoKSB7CiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoImluZGV4IG91dCBvZiByYW5nZSIpOwogICAgfQogICAgdGhpcy4jcGF0dGVybkxpc3QgPSBwYXR0ZXJuTGlzdDsKICAgIHRoaXMuI2dsb2JMaXN0ID0gZ2xvYkxpc3Q7CiAgICB0aGlzLiNpbmRleCA9IGluZGV4OwogICAgdGhpcy4jcGxhdGZvcm0gPSBwbGF0Zm9ybTsKICAgIGlmICh0aGlzLiNpbmRleCA9PT0gMCkgewogICAgICBpZiAodGhpcy5pc1VOQygpKSB7CiAgICAgICAgY29uc3QgW3AwLCBwMSwgcDIsIHAzLCAuLi5wcmVzdF0gPSB0aGlzLiNwYXR0ZXJuTGlzdDsKICAgICAgICBjb25zdCBbZzAsIGcxLCBnMiwgZzMsIC4uLmdyZXN0XSA9IHRoaXMuI2dsb2JMaXN0OwogICAgICAgIGlmIChwcmVzdFswXSA9PT0gIiIpIHsKICAgICAgICAgIHByZXN0LnNoaWZ0KCk7CiAgICAgICAgICBncmVzdC5zaGlmdCgpOwogICAgICAgIH0KICAgICAgICBjb25zdCBwID0gW3AwLCBwMSwgcDIsIHAzLCAiIl0uam9pbigiLyIpOwogICAgICAgIGNvbnN0IGcgPSBbZzAsIGcxLCBnMiwgZzMsICIiXS5qb2luKCIvIik7CiAgICAgICAgdGhpcy4jcGF0dGVybkxpc3QgPSBbcCwgLi4ucHJlc3RdOwogICAgICAgIHRoaXMuI2dsb2JMaXN0ID0gW2csIC4uLmdyZXN0XTsKICAgICAgICB0aGlzLmxlbmd0aCA9IHRoaXMuI3BhdHRlcm5MaXN0Lmxlbmd0aDsKICAgICAgfSBlbHNlIGlmICh0aGlzLmlzRHJpdmUoKSB8fCB0aGlzLmlzQWJzb2x1dGUoKSkgewogICAgICAgIGNvbnN0IFtwMSwgLi4ucHJlc3RdID0gdGhpcy4jcGF0dGVybkxpc3Q7CiAgICAgICAgY29uc3QgW2cxLCAuLi5ncmVzdF0gPSB0aGlzLiNnbG9iTGlzdDsKICAgICAgICBpZiAocHJlc3RbMF0gPT09ICIiKSB7CiAgICAgICAgICBwcmVzdC5zaGlmdCgpOwogICAgICAgICAgZ3Jlc3Quc2hpZnQoKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgcCA9IHAxICsgIi8iOwogICAgICAgIGNvbnN0IGcgPSBnMSArICIvIjsKICAgICAgICB0aGlzLiNwYXR0ZXJuTGlzdCA9IFtwLCAuLi5wcmVzdF07CiAgICAgICAgdGhpcy4jZ2xvYkxpc3QgPSBbZywgLi4uZ3Jlc3RdOwogICAgICAgIHRoaXMubGVuZ3RoID0gdGhpcy4jcGF0dGVybkxpc3QubGVuZ3RoOwogICAgICB9CiAgICB9CiAgfQogIC8qKgogICAqIFRoZSBmaXJzdCBlbnRyeSBpbiB0aGUgcGFyc2VkIGxpc3Qgb2YgcGF0dGVybnMKICAgKi8KICBwYXR0ZXJuKCkgewogICAgcmV0dXJuIHRoaXMuI3BhdHRlcm5MaXN0W3RoaXMuI2luZGV4XTsKICB9CiAgLyoqCiAgICogdHJ1ZSBvZiBpZiBwYXR0ZXJuKCkgcmV0dXJucyBhIHN0cmluZwogICAqLwogIGlzU3RyaW5nKCkgewogICAgcmV0dXJuIHR5cGVvZiB0aGlzLiNwYXR0ZXJuTGlzdFt0aGlzLiNpbmRleF0gPT09ICJzdHJpbmciOwogIH0KICAvKioKICAgKiB0cnVlIG9mIGlmIHBhdHRlcm4oKSByZXR1cm5zIEdMT0JTVEFSCiAgICovCiAgaXNHbG9ic3RhcigpIHsKICAgIHJldHVybiB0aGlzLiNwYXR0ZXJuTGlzdFt0aGlzLiNpbmRleF0gPT09IEdMT0JTVEFSOwogIH0KICAvKioKICAgKiB0cnVlIGlmIHBhdHRlcm4oKSByZXR1cm5zIGEgcmVnZXhwCiAgICovCiAgaXNSZWdFeHAoKSB7CiAgICByZXR1cm4gdGhpcy4jcGF0dGVybkxpc3RbdGhpcy4jaW5kZXhdIGluc3RhbmNlb2YgUmVnRXhwOwogIH0KICAvKioKICAgKiBUaGUgLy1qb2luZWQgc2V0IG9mIGdsb2IgcGFydHMgdGhhdCBtYWtlIHVwIHRoaXMgcGF0dGVybgogICAqLwogIGdsb2JTdHJpbmcoKSB7CiAgICByZXR1cm4gdGhpcy4jZ2xvYlN0cmluZyA9IHRoaXMuI2dsb2JTdHJpbmcgfHwgKHRoaXMuI2luZGV4ID09PSAwID8gdGhpcy5pc0Fic29sdXRlKCkgPyB0aGlzLiNnbG9iTGlzdFswXSArIHRoaXMuI2dsb2JMaXN0LnNsaWNlKDEpLmpvaW4oIi8iKSA6IHRoaXMuI2dsb2JMaXN0LmpvaW4oIi8iKSA6IHRoaXMuI2dsb2JMaXN0LnNsaWNlKHRoaXMuI2luZGV4KS5qb2luKCIvIikpOwogIH0KICAvKioKICAgKiB0cnVlIGlmIHRoZXJlIGFyZSBtb3JlIHBhdHRlcm4gcGFydHMgYWZ0ZXIgdGhpcyBvbmUKICAgKi8KICBoYXNNb3JlKCkgewogICAgcmV0dXJuIHRoaXMubGVuZ3RoID4gdGhpcy4jaW5kZXggKyAxOwogIH0KICAvKioKICAgKiBUaGUgcmVzdCBvZiB0aGUgcGF0dGVybiBhZnRlciB0aGlzIHBhcnQsIG9yIG51bGwgaWYgdGhpcyBpcyB0aGUgZW5kCiAgICovCiAgcmVzdCgpIHsKICAgIGlmICh0aGlzLiNyZXN0ICE9PSB2b2lkIDApCiAgICAgIHJldHVybiB0aGlzLiNyZXN0OwogICAgaWYgKCF0aGlzLmhhc01vcmUoKSkKICAgICAgcmV0dXJuIHRoaXMuI3Jlc3QgPSBudWxsOwogICAgdGhpcy4jcmVzdCA9IG5ldyBQYXR0ZXJuKHRoaXMuI3BhdHRlcm5MaXN0LCB0aGlzLiNnbG9iTGlzdCwgdGhpcy4jaW5kZXggKyAxLCB0aGlzLiNwbGF0Zm9ybSk7CiAgICB0aGlzLiNyZXN0LiNpc0Fic29sdXRlID0gdGhpcy4jaXNBYnNvbHV0ZTsKICAgIHRoaXMuI3Jlc3QuI2lzVU5DID0gdGhpcy4jaXNVTkM7CiAgICB0aGlzLiNyZXN0LiNpc0RyaXZlID0gdGhpcy4jaXNEcml2ZTsKICAgIHJldHVybiB0aGlzLiNyZXN0OwogIH0KICAvKioKICAgKiB0cnVlIGlmIHRoZSBwYXR0ZXJuIHJlcHJlc2VudHMgYSAvL3VuYy9wYXRoLyBvbiB3aW5kb3dzCiAgICovCiAgaXNVTkMoKSB7CiAgICBjb25zdCBwbCA9IHRoaXMuI3BhdHRlcm5MaXN0OwogICAgcmV0dXJuIHRoaXMuI2lzVU5DICE9PSB2b2lkIDAgPyB0aGlzLiNpc1VOQyA6IHRoaXMuI2lzVU5DID0gdGhpcy4jcGxhdGZvcm0gPT09ICJ3aW4zMiIgJiYgdGhpcy4jaW5kZXggPT09IDAgJiYgcGxbMF0gPT09ICIiICYmIHBsWzFdID09PSAiIiAmJiB0eXBlb2YgcGxbMl0gPT09ICJzdHJpbmciICYmICEhcGxbMl0gJiYgdHlwZW9mIHBsWzNdID09PSAic3RyaW5nIiAmJiAhIXBsWzNdOwogIH0KICAvLyBwYXR0ZXJuIGxpa2UgQzovLi4uCiAgLy8gc3BsaXQgPSBbJ0M6JywgLi4uXQogIC8vIFhYWDogd291bGQgYmUgbmljZSB0byBoYW5kbGUgcGF0dGVybnMgbGlrZSBgYzoqYCB0byB0ZXN0IHRoZSBjd2QKICAvLyBpbiBjOiBmb3IgKiwgYnV0IEkgZG9uJ3Qga25vdyBvZiBhIHdheSB0byBldmVuIGZpZ3VyZSBvdXQgd2hhdCB0aGF0CiAgLy8gY3dkIGlzIHdpdGhvdXQgYWN0dWFsbHkgY2hkaXInaW5nIGludG8gaXQ/CiAgLyoqCiAgICogVHJ1ZSBpZiB0aGUgcGF0dGVybiBzdGFydHMgd2l0aCBhIGRyaXZlIGxldHRlciBvbiBXaW5kb3dzCiAgICovCiAgaXNEcml2ZSgpIHsKICAgIGNvbnN0IHBsID0gdGhpcy4jcGF0dGVybkxpc3Q7CiAgICByZXR1cm4gdGhpcy4jaXNEcml2ZSAhPT0gdm9pZCAwID8gdGhpcy4jaXNEcml2ZSA6IHRoaXMuI2lzRHJpdmUgPSB0aGlzLiNwbGF0Zm9ybSA9PT0gIndpbjMyIiAmJiB0aGlzLiNpbmRleCA9PT0gMCAmJiB0aGlzLmxlbmd0aCA+IDEgJiYgdHlwZW9mIHBsWzBdID09PSAic3RyaW5nIiAmJiAvXlthLXpdOiQvaS50ZXN0KHBsWzBdKTsKICB9CiAgLy8gcGF0dGVybiA9ICcvJyBvciAnLy4uLicgb3IgJy94Ly4uLicKICAvLyBzcGxpdCA9IFsnJywgJyddIG9yIFsnJywgLi4uXSBvciBbJycsICd4JywgLi4uXQogIC8vIERyaXZlIGFuZCBVTkMgYm90aCBjb25zaWRlcmVkIGFic29sdXRlIG9uIHdpbmRvd3MKICAvKioKICAgKiBUcnVlIGlmIHRoZSBwYXR0ZXJuIGlzIHJvb3RlZCBvbiBhbiBhYnNvbHV0ZSBwYXRoCiAgICovCiAgaXNBYnNvbHV0ZSgpIHsKICAgIGNvbnN0IHBsID0gdGhpcy4jcGF0dGVybkxpc3Q7CiAgICByZXR1cm4gdGhpcy4jaXNBYnNvbHV0ZSAhPT0gdm9pZCAwID8gdGhpcy4jaXNBYnNvbHV0ZSA6IHRoaXMuI2lzQWJzb2x1dGUgPSBwbFswXSA9PT0gIiIgJiYgcGwubGVuZ3RoID4gMSB8fCB0aGlzLmlzRHJpdmUoKSB8fCB0aGlzLmlzVU5DKCk7CiAgfQogIC8qKgogICAqIGNvbnN1bWUgdGhlIHJvb3Qgb2YgdGhlIHBhdHRlcm4sIGFuZCByZXR1cm4gaXQKICAgKi8KICByb290KCkgewogICAgY29uc3QgcCA9IHRoaXMuI3BhdHRlcm5MaXN0WzBdOwogICAgcmV0dXJuIHR5cGVvZiBwID09PSAic3RyaW5nIiAmJiB0aGlzLmlzQWJzb2x1dGUoKSAmJiB0aGlzLiNpbmRleCA9PT0gMCA/IHAgOiAiIjsKICB9CiAgLyoqCiAgICogQ2hlY2sgdG8gc2VlIGlmIHRoZSBjdXJyZW50IGdsb2JzdGFyIHBhdHRlcm4gaXMgYWxsb3dlZCB0byBmb2xsb3cKICAgKiBhIHN5bWJvbGljIGxpbmsuCiAgICovCiAgY2hlY2tGb2xsb3dHbG9ic3RhcigpIHsKICAgIHJldHVybiAhKHRoaXMuI2luZGV4ID09PSAwIHx8ICF0aGlzLmlzR2xvYnN0YXIoKSB8fCAhdGhpcy4jZm9sbG93R2xvYnN0YXIpOwogIH0KICAvKioKICAgKiBNYXJrIHRoYXQgdGhlIGN1cnJlbnQgZ2xvYnN0YXIgcGF0dGVybiBpcyBmb2xsb3dpbmcgYSBzeW1ib2xpYyBsaW5rCiAgICovCiAgbWFya0ZvbGxvd0dsb2JzdGFyKCkgewogICAgaWYgKHRoaXMuI2luZGV4ID09PSAwIHx8ICF0aGlzLmlzR2xvYnN0YXIoKSB8fCAhdGhpcy4jZm9sbG93R2xvYnN0YXIpCiAgICAgIHJldHVybiBmYWxzZTsKICAgIHRoaXMuI2ZvbGxvd0dsb2JzdGFyID0gZmFsc2U7CiAgICByZXR1cm4gdHJ1ZTsKICB9Cn0KY29uc3QgZGVmYXVsdFBsYXRmb3JtJDEgPSB0eXBlb2YgcHJvY2VzcyA9PT0gIm9iamVjdCIgJiYgcHJvY2VzcyAmJiB0eXBlb2YgcHJvY2Vzcy5wbGF0Zm9ybSA9PT0gInN0cmluZyIgPyBwcm9jZXNzLnBsYXRmb3JtIDogImxpbnV4IjsKY2xhc3MgSWdub3JlIHsKICByZWxhdGl2ZTsKICByZWxhdGl2ZUNoaWxkcmVuOwogIGFic29sdXRlOwogIGFic29sdXRlQ2hpbGRyZW47CiAgY29uc3RydWN0b3IoaWdub3JlZCwgeyBub2JyYWNlLCBub2Nhc2UsIG5vZXh0LCBub2dsb2JzdGFyLCBwbGF0Zm9ybSA9IGRlZmF1bHRQbGF0Zm9ybSQxIH0pIHsKICAgIHRoaXMucmVsYXRpdmUgPSBbXTsKICAgIHRoaXMuYWJzb2x1dGUgPSBbXTsKICAgIHRoaXMucmVsYXRpdmVDaGlsZHJlbiA9IFtdOwogICAgdGhpcy5hYnNvbHV0ZUNoaWxkcmVuID0gW107CiAgICBjb25zdCBtbW9wdHMgPSB7CiAgICAgIGRvdDogdHJ1ZSwKICAgICAgbm9icmFjZSwKICAgICAgbm9jYXNlLAogICAgICBub2V4dCwKICAgICAgbm9nbG9ic3RhciwKICAgICAgb3B0aW1pemF0aW9uTGV2ZWw6IDIsCiAgICAgIHBsYXRmb3JtLAogICAgICBub2NvbW1lbnQ6IHRydWUsCiAgICAgIG5vbmVnYXRlOiB0cnVlCiAgICB9OwogICAgZm9yIChjb25zdCBpZ24gb2YgaWdub3JlZCkgewogICAgICBjb25zdCBtbSA9IG5ldyBNaW5pbWF0Y2goaWduLCBtbW9wdHMpOwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG1tLnNldC5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IHBhcnNlZCA9IG1tLnNldFtpXTsKICAgICAgICBjb25zdCBnbG9iUGFydHMgPSBtbS5nbG9iUGFydHNbaV07CiAgICAgICAgY29uc3QgcCA9IG5ldyBQYXR0ZXJuKHBhcnNlZCwgZ2xvYlBhcnRzLCAwLCBwbGF0Zm9ybSk7CiAgICAgICAgY29uc3QgbSA9IG5ldyBNaW5pbWF0Y2gocC5nbG9iU3RyaW5nKCksIG1tb3B0cyk7CiAgICAgICAgY29uc3QgY2hpbGRyZW4gPSBnbG9iUGFydHNbZ2xvYlBhcnRzLmxlbmd0aCAtIDFdID09PSAiKioiOwogICAgICAgIGNvbnN0IGFic29sdXRlID0gcC5pc0Fic29sdXRlKCk7CiAgICAgICAgaWYgKGFic29sdXRlKQogICAgICAgICAgdGhpcy5hYnNvbHV0ZS5wdXNoKG0pOwogICAgICAgIGVsc2UKICAgICAgICAgIHRoaXMucmVsYXRpdmUucHVzaChtKTsKICAgICAgICBpZiAoY2hpbGRyZW4pIHsKICAgICAgICAgIGlmIChhYnNvbHV0ZSkKICAgICAgICAgICAgdGhpcy5hYnNvbHV0ZUNoaWxkcmVuLnB1c2gobSk7CiAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHRoaXMucmVsYXRpdmVDaGlsZHJlbi5wdXNoKG0pOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KICBpZ25vcmVkKHApIHsKICAgIGNvbnN0IGZ1bGxwYXRoID0gcC5mdWxscGF0aCgpOwogICAgY29uc3QgZnVsbHBhdGhzID0gYCR7ZnVsbHBhdGh9L2A7CiAgICBjb25zdCByZWxhdGl2ZSA9IHAucmVsYXRpdmUoKSB8fCAiLiI7CiAgICBjb25zdCByZWxhdGl2ZXMgPSBgJHtyZWxhdGl2ZX0vYDsKICAgIGZvciAoY29uc3QgbSBvZiB0aGlzLnJlbGF0aXZlKSB7CiAgICAgIGlmIChtLm1hdGNoKHJlbGF0aXZlKSB8fCBtLm1hdGNoKHJlbGF0aXZlcykpCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICBmb3IgKGNvbnN0IG0gb2YgdGhpcy5hYnNvbHV0ZSkgewogICAgICBpZiAobS5tYXRjaChmdWxscGF0aCkgfHwgbS5tYXRjaChmdWxscGF0aHMpKQogICAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgcmV0dXJuIGZhbHNlOwogIH0KICBjaGlsZHJlbklnbm9yZWQocCkgewogICAgY29uc3QgZnVsbHBhdGggPSBwLmZ1bGxwYXRoKCkgKyAiLyI7CiAgICBjb25zdCByZWxhdGl2ZSA9IChwLnJlbGF0aXZlKCkgfHwgIi4iKSArICIvIjsKICAgIGZvciAoY29uc3QgbSBvZiB0aGlzLnJlbGF0aXZlQ2hpbGRyZW4pIHsKICAgICAgaWYgKG0ubWF0Y2gocmVsYXRpdmUpKQogICAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgZm9yIChjb25zdCBtIG9mIHRoaXMuYWJzb2x1dGVDaGlsZHJlbikgewogICAgICBpZiAobS5tYXRjaChmdWxscGF0aCkpCiAgICAgICAgOwogICAgfQogICAgcmV0dXJuIGZhbHNlOwogIH0KfQpjbGFzcyBIYXNXYWxrZWRDYWNoZSB7CiAgc3RvcmU7CiAgY29uc3RydWN0b3Ioc3RvcmUgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpKSB7CiAgICB0aGlzLnN0b3JlID0gc3RvcmU7CiAgfQogIGNvcHkoKSB7CiAgICByZXR1cm4gbmV3IEhhc1dhbGtlZENhY2hlKG5ldyBNYXAodGhpcy5zdG9yZSkpOwogIH0KICBoYXNXYWxrZWQodGFyZ2V0LCBwYXR0ZXJuKSB7CiAgICByZXR1cm4gdGhpcy5zdG9yZS5nZXQodGFyZ2V0LmZ1bGxwYXRoKCkpPy5oYXMocGF0dGVybi5nbG9iU3RyaW5nKCkpOwogIH0KICBzdG9yZVdhbGtlZCh0YXJnZXQsIHBhdHRlcm4pIHsKICAgIGNvbnN0IGZ1bGxwYXRoID0gdGFyZ2V0LmZ1bGxwYXRoKCk7CiAgICBjb25zdCBjYWNoZWQgPSB0aGlzLnN0b3JlLmdldChmdWxscGF0aCk7CiAgICBpZiAoY2FjaGVkKQogICAgICBjYWNoZWQuYWRkKHBhdHRlcm4uZ2xvYlN0cmluZygpKTsKICAgIGVsc2UKICAgICAgdGhpcy5zdG9yZS5zZXQoZnVsbHBhdGgsIC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KFtwYXR0ZXJuLmdsb2JTdHJpbmcoKV0pKTsKICB9Cn0KY2xhc3MgTWF0Y2hSZWNvcmQgewogIHN0b3JlID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICBhZGQodGFyZ2V0LCBhYnNvbHV0ZSwgaWZEaXIpIHsKICAgIGNvbnN0IG4gPSAoYWJzb2x1dGUgPyAyIDogMCkgfCAoaWZEaXIgPyAxIDogMCk7CiAgICBjb25zdCBjdXJyZW50ID0gdGhpcy5zdG9yZS5nZXQodGFyZ2V0KTsKICAgIHRoaXMuc3RvcmUuc2V0KHRhcmdldCwgY3VycmVudCA9PT0gdm9pZCAwID8gbiA6IG4gJiBjdXJyZW50KTsKICB9CiAgLy8gbWF0Y2gsIGFic29sdXRlLCBpZmRpcgogIGVudHJpZXMoKSB7CiAgICByZXR1cm4gWy4uLnRoaXMuc3RvcmUuZW50cmllcygpXS5tYXAoKFtwYXRoMiwgbl0pID0+IFsKICAgICAgcGF0aDIsCiAgICAgICEhKG4gJiAyKSwKICAgICAgISEobiAmIDEpCiAgICBdKTsKICB9Cn0KY2xhc3MgU3ViV2Fsa3MgewogIHN0b3JlID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICBhZGQodGFyZ2V0LCBwYXR0ZXJuKSB7CiAgICBpZiAoIXRhcmdldC5jYW5SZWFkZGlyKCkpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3Qgc3VicyA9IHRoaXMuc3RvcmUuZ2V0KHRhcmdldCk7CiAgICBpZiAoc3VicykgewogICAgICBpZiAoIXN1YnMuZmluZCgocCkgPT4gcC5nbG9iU3RyaW5nKCkgPT09IHBhdHRlcm4uZ2xvYlN0cmluZygpKSkgewogICAgICAgIHN1YnMucHVzaChwYXR0ZXJuKTsKICAgICAgfQogICAgfSBlbHNlCiAgICAgIHRoaXMuc3RvcmUuc2V0KHRhcmdldCwgW3BhdHRlcm5dKTsKICB9CiAgZ2V0KHRhcmdldCkgewogICAgY29uc3Qgc3VicyA9IHRoaXMuc3RvcmUuZ2V0KHRhcmdldCk7CiAgICBpZiAoIXN1YnMpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJhdHRlbXB0aW5nIHRvIHdhbGsgdW5rbm93biBwYXRoIik7CiAgICB9CiAgICByZXR1cm4gc3ViczsKICB9CiAgZW50cmllcygpIHsKICAgIHJldHVybiB0aGlzLmtleXMoKS5tYXAoKGspID0+IFtrLCB0aGlzLnN0b3JlLmdldChrKV0pOwogIH0KICBrZXlzKCkgewogICAgcmV0dXJuIFsuLi50aGlzLnN0b3JlLmtleXMoKV0uZmlsdGVyKCh0KSA9PiB0LmNhblJlYWRkaXIoKSk7CiAgfQp9CmNsYXNzIFByb2Nlc3NvciB7CiAgaGFzV2Fsa2VkQ2FjaGU7CiAgbWF0Y2hlcyA9IG5ldyBNYXRjaFJlY29yZCgpOwogIHN1YndhbGtzID0gbmV3IFN1YldhbGtzKCk7CiAgcGF0dGVybnM7CiAgZm9sbG93OwogIGRvdDsKICBvcHRzOwogIGNvbnN0cnVjdG9yKG9wdHMsIGhhc1dhbGtlZENhY2hlKSB7CiAgICB0aGlzLm9wdHMgPSBvcHRzOwogICAgdGhpcy5mb2xsb3cgPSAhIW9wdHMuZm9sbG93OwogICAgdGhpcy5kb3QgPSAhIW9wdHMuZG90OwogICAgdGhpcy5oYXNXYWxrZWRDYWNoZSA9IGhhc1dhbGtlZENhY2hlID8gaGFzV2Fsa2VkQ2FjaGUuY29weSgpIDogbmV3IEhhc1dhbGtlZENhY2hlKCk7CiAgfQogIHByb2Nlc3NQYXR0ZXJucyh0YXJnZXQsIHBhdHRlcm5zKSB7CiAgICB0aGlzLnBhdHRlcm5zID0gcGF0dGVybnM7CiAgICBjb25zdCBwcm9jZXNzaW5nU2V0ID0gcGF0dGVybnMubWFwKChwKSA9PiBbdGFyZ2V0LCBwXSk7CiAgICBmb3IgKGxldCBbdCwgcGF0dGVybl0gb2YgcHJvY2Vzc2luZ1NldCkgewogICAgICB0aGlzLmhhc1dhbGtlZENhY2hlLnN0b3JlV2Fsa2VkKHQsIHBhdHRlcm4pOwogICAgICBjb25zdCByb290ID0gcGF0dGVybi5yb290KCk7CiAgICAgIGNvbnN0IGFic29sdXRlID0gcGF0dGVybi5pc0Fic29sdXRlKCkgJiYgdGhpcy5vcHRzLmFic29sdXRlICE9PSBmYWxzZTsKICAgICAgaWYgKHJvb3QpIHsKICAgICAgICB0ID0gdC5yZXNvbHZlKHJvb3QgPT09ICIvIiAmJiB0aGlzLm9wdHMucm9vdCAhPT0gdm9pZCAwID8gdGhpcy5vcHRzLnJvb3QgOiByb290KTsKICAgICAgICBjb25zdCByZXN0MiA9IHBhdHRlcm4ucmVzdCgpOwogICAgICAgIGlmICghcmVzdDIpIHsKICAgICAgICAgIHRoaXMubWF0Y2hlcy5hZGQodCwgdHJ1ZSwgZmFsc2UpOwogICAgICAgICAgY29udGludWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHBhdHRlcm4gPSByZXN0MjsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKHQuaXNFTk9FTlQoKSkKICAgICAgICBjb250aW51ZTsKICAgICAgbGV0IHA7CiAgICAgIGxldCByZXN0OwogICAgICBsZXQgY2hhbmdlZCA9IGZhbHNlOwogICAgICB3aGlsZSAodHlwZW9mIChwID0gcGF0dGVybi5wYXR0ZXJuKCkpID09PSAic3RyaW5nIiAmJiAocmVzdCA9IHBhdHRlcm4ucmVzdCgpKSkgewogICAgICAgIGNvbnN0IGMgPSB0LnJlc29sdmUocCk7CiAgICAgICAgdCA9IGM7CiAgICAgICAgcGF0dGVybiA9IHJlc3Q7CiAgICAgICAgY2hhbmdlZCA9IHRydWU7CiAgICAgIH0KICAgICAgcCA9IHBhdHRlcm4ucGF0dGVybigpOwogICAgICByZXN0ID0gcGF0dGVybi5yZXN0KCk7CiAgICAgIGlmIChjaGFuZ2VkKSB7CiAgICAgICAgaWYgKHRoaXMuaGFzV2Fsa2VkQ2FjaGUuaGFzV2Fsa2VkKHQsIHBhdHRlcm4pKQogICAgICAgICAgY29udGludWU7CiAgICAgICAgdGhpcy5oYXNXYWxrZWRDYWNoZS5zdG9yZVdhbGtlZCh0LCBwYXR0ZXJuKTsKICAgICAgfQogICAgICBpZiAodHlwZW9mIHAgPT09ICJzdHJpbmciKSB7CiAgICAgICAgY29uc3QgaWZEaXIgPSBwID09PSAiLi4iIHx8IHAgPT09ICIiIHx8IHAgPT09ICIuIjsKICAgICAgICB0aGlzLm1hdGNoZXMuYWRkKHQucmVzb2x2ZShwKSwgYWJzb2x1dGUsIGlmRGlyKTsKICAgICAgICBjb250aW51ZTsKICAgICAgfSBlbHNlIGlmIChwID09PSBHTE9CU1RBUikgewogICAgICAgIGlmICghdC5pc1N5bWJvbGljTGluaygpIHx8IHRoaXMuZm9sbG93IHx8IHBhdHRlcm4uY2hlY2tGb2xsb3dHbG9ic3RhcigpKSB7CiAgICAgICAgICB0aGlzLnN1YndhbGtzLmFkZCh0LCBwYXR0ZXJuKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgcnAgPSByZXN0Py5wYXR0ZXJuKCk7CiAgICAgICAgY29uc3QgcnJlc3QgPSByZXN0Py5yZXN0KCk7CiAgICAgICAgaWYgKCFyZXN0IHx8IChycCA9PT0gIiIgfHwgcnAgPT09ICIuIikgJiYgIXJyZXN0KSB7CiAgICAgICAgICB0aGlzLm1hdGNoZXMuYWRkKHQsIGFic29sdXRlLCBycCA9PT0gIiIgfHwgcnAgPT09ICIuIik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChycCA9PT0gIi4uIikgewogICAgICAgICAgICBjb25zdCB0cCA9IHQucGFyZW50IHx8IHQ7CiAgICAgICAgICAgIGlmICghcnJlc3QpCiAgICAgICAgICAgICAgdGhpcy5tYXRjaGVzLmFkZCh0cCwgYWJzb2x1dGUsIHRydWUpOwogICAgICAgICAgICBlbHNlIGlmICghdGhpcy5oYXNXYWxrZWRDYWNoZS5oYXNXYWxrZWQodHAsIHJyZXN0KSkgewogICAgICAgICAgICAgIHRoaXMuc3Vid2Fsa3MuYWRkKHRwLCBycmVzdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAocCBpbnN0YW5jZW9mIFJlZ0V4cCkgewogICAgICAgIHRoaXMuc3Vid2Fsa3MuYWRkKHQsIHBhdHRlcm4pOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9CiAgc3Vid2Fsa1RhcmdldHMoKSB7CiAgICByZXR1cm4gdGhpcy5zdWJ3YWxrcy5rZXlzKCk7CiAgfQogIGNoaWxkKCkgewogICAgcmV0dXJuIG5ldyBQcm9jZXNzb3IodGhpcy5vcHRzLCB0aGlzLmhhc1dhbGtlZENhY2hlKTsKICB9CiAgLy8gcmV0dXJuIGEgbmV3IFByb2Nlc3NvciBjb250YWluaW5nIHRoZSBzdWJ3YWxrcyBmb3IgZWFjaAogIC8vIGNoaWxkIGVudHJ5LCBhbmQgYSBzZXQgb2YgbWF0Y2hlcywgYW5kCiAgLy8gYSBoYXNXYWxrZWRDYWNoZSB0aGF0J3MgYSBjb3B5IG9mIHRoaXMgb25lCiAgLy8gdGhlbiB3ZSdyZSBnb2luZyB0byBjYWxsCiAgZmlsdGVyRW50cmllcyhwYXJlbnQsIGVudHJpZXMpIHsKICAgIGNvbnN0IHBhdHRlcm5zID0gdGhpcy5zdWJ3YWxrcy5nZXQocGFyZW50KTsKICAgIGNvbnN0IHJlc3VsdHMgPSB0aGlzLmNoaWxkKCk7CiAgICBmb3IgKGNvbnN0IGUgb2YgZW50cmllcykgewogICAgICBmb3IgKGNvbnN0IHBhdHRlcm4gb2YgcGF0dGVybnMpIHsKICAgICAgICBjb25zdCBhYnNvbHV0ZSA9IHBhdHRlcm4uaXNBYnNvbHV0ZSgpOwogICAgICAgIGNvbnN0IHAgPSBwYXR0ZXJuLnBhdHRlcm4oKTsKICAgICAgICBjb25zdCByZXN0ID0gcGF0dGVybi5yZXN0KCk7CiAgICAgICAgaWYgKHAgPT09IEdMT0JTVEFSKSB7CiAgICAgICAgICByZXN1bHRzLnRlc3RHbG9ic3RhcihlLCBwYXR0ZXJuLCByZXN0LCBhYnNvbHV0ZSk7CiAgICAgICAgfSBlbHNlIGlmIChwIGluc3RhbmNlb2YgUmVnRXhwKSB7CiAgICAgICAgICByZXN1bHRzLnRlc3RSZWdFeHAoZSwgcCwgcmVzdCwgYWJzb2x1dGUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXN1bHRzLnRlc3RTdHJpbmcoZSwgcCwgcmVzdCwgYWJzb2x1dGUpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3VsdHM7CiAgfQogIHRlc3RHbG9ic3RhcihlLCBwYXR0ZXJuLCByZXN0LCBhYnNvbHV0ZSkgewogICAgaWYgKHRoaXMuZG90IHx8ICFlLm5hbWUuc3RhcnRzV2l0aCgiLiIpKSB7CiAgICAgIGlmICghcGF0dGVybi5oYXNNb3JlKCkpIHsKICAgICAgICB0aGlzLm1hdGNoZXMuYWRkKGUsIGFic29sdXRlLCBmYWxzZSk7CiAgICAgIH0KICAgICAgaWYgKGUuY2FuUmVhZGRpcigpKSB7CiAgICAgICAgaWYgKHRoaXMuZm9sbG93IHx8ICFlLmlzU3ltYm9saWNMaW5rKCkpIHsKICAgICAgICAgIHRoaXMuc3Vid2Fsa3MuYWRkKGUsIHBhdHRlcm4pOwogICAgICAgIH0gZWxzZSBpZiAoZS5pc1N5bWJvbGljTGluaygpKSB7CiAgICAgICAgICBpZiAocmVzdCAmJiBwYXR0ZXJuLmNoZWNrRm9sbG93R2xvYnN0YXIoKSkgewogICAgICAgICAgICB0aGlzLnN1YndhbGtzLmFkZChlLCByZXN0KTsKICAgICAgICAgIH0gZWxzZSBpZiAocGF0dGVybi5tYXJrRm9sbG93R2xvYnN0YXIoKSkgewogICAgICAgICAgICB0aGlzLnN1YndhbGtzLmFkZChlLCBwYXR0ZXJuKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGlmIChyZXN0KSB7CiAgICAgIGNvbnN0IHJwID0gcmVzdC5wYXR0ZXJuKCk7CiAgICAgIGlmICh0eXBlb2YgcnAgPT09ICJzdHJpbmciICYmIC8vIGRvdHMgYW5kIGVtcHR5IHdlcmUgaGFuZGxlZCBhbHJlYWR5CiAgICAgIHJwICE9PSAiLi4iICYmIHJwICE9PSAiIiAmJiBycCAhPT0gIi4iKSB7CiAgICAgICAgdGhpcy50ZXN0U3RyaW5nKGUsIHJwLCByZXN0LnJlc3QoKSwgYWJzb2x1dGUpOwogICAgICB9IGVsc2UgaWYgKHJwID09PSAiLi4iKSB7CiAgICAgICAgY29uc3QgZXAgPSBlLnBhcmVudCB8fCBlOwogICAgICAgIHRoaXMuc3Vid2Fsa3MuYWRkKGVwLCByZXN0KTsKICAgICAgfSBlbHNlIGlmIChycCBpbnN0YW5jZW9mIFJlZ0V4cCkgewogICAgICAgIHRoaXMudGVzdFJlZ0V4cChlLCBycCwgcmVzdC5yZXN0KCksIGFic29sdXRlKTsKICAgICAgfQogICAgfQogIH0KICB0ZXN0UmVnRXhwKGUsIHAsIHJlc3QsIGFic29sdXRlKSB7CiAgICBpZiAoIXAudGVzdChlLm5hbWUpKQogICAgICByZXR1cm47CiAgICBpZiAoIXJlc3QpIHsKICAgICAgdGhpcy5tYXRjaGVzLmFkZChlLCBhYnNvbHV0ZSwgZmFsc2UpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5zdWJ3YWxrcy5hZGQoZSwgcmVzdCk7CiAgICB9CiAgfQogIHRlc3RTdHJpbmcoZSwgcCwgcmVzdCwgYWJzb2x1dGUpIHsKICAgIGlmICghZS5pc05hbWVkKHApKQogICAgICByZXR1cm47CiAgICBpZiAoIXJlc3QpIHsKICAgICAgdGhpcy5tYXRjaGVzLmFkZChlLCBhYnNvbHV0ZSwgZmFsc2UpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5zdWJ3YWxrcy5hZGQoZSwgcmVzdCk7CiAgICB9CiAgfQp9CmNvbnN0IG1ha2VJZ25vcmUgPSAoaWdub3JlLCBvcHRzKSA9PiB0eXBlb2YgaWdub3JlID09PSAic3RyaW5nIiA/IG5ldyBJZ25vcmUoW2lnbm9yZV0sIG9wdHMpIDogQXJyYXkuaXNBcnJheShpZ25vcmUpID8gbmV3IElnbm9yZShpZ25vcmUsIG9wdHMpIDogaWdub3JlOwpjbGFzcyBHbG9iVXRpbCB7CiAgcGF0aDsKICBwYXR0ZXJuczsKICBvcHRzOwogIHNlZW4gPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogIHBhdXNlZCA9IGZhbHNlOwogIGFib3J0ZWQgPSBmYWxzZTsKICAjb25SZXN1bWUgPSBbXTsKICAjaWdub3JlOwogICNzZXA7CiAgc2lnbmFsOwogIG1heERlcHRoOwogIGNvbnN0cnVjdG9yKHBhdHRlcm5zLCBwYXRoMiwgb3B0cykgewogICAgdGhpcy5wYXR0ZXJucyA9IHBhdHRlcm5zOwogICAgdGhpcy5wYXRoID0gcGF0aDI7CiAgICB0aGlzLm9wdHMgPSBvcHRzOwogICAgdGhpcy4jc2VwID0gIW9wdHMucG9zaXggJiYgb3B0cy5wbGF0Zm9ybSA9PT0gIndpbjMyIiA/ICJcXCIgOiAiLyI7CiAgICBpZiAob3B0cy5pZ25vcmUpIHsKICAgICAgdGhpcy4jaWdub3JlID0gbWFrZUlnbm9yZShvcHRzLmlnbm9yZSwgb3B0cyk7CiAgICB9CiAgICB0aGlzLm1heERlcHRoID0gb3B0cy5tYXhEZXB0aCB8fCBJbmZpbml0eTsKICAgIGlmIChvcHRzLnNpZ25hbCkgewogICAgICB0aGlzLnNpZ25hbCA9IG9wdHMuc2lnbmFsOwogICAgICB0aGlzLnNpZ25hbC5hZGRFdmVudExpc3RlbmVyKCJhYm9ydCIsICgpID0+IHsKICAgICAgICB0aGlzLiNvblJlc3VtZS5sZW5ndGggPSAwOwogICAgICB9KTsKICAgIH0KICB9CiAgI2lnbm9yZWQocGF0aDIpIHsKICAgIHJldHVybiB0aGlzLnNlZW4uaGFzKHBhdGgyKSB8fCAhIXRoaXMuI2lnbm9yZT8uaWdub3JlZD8uKHBhdGgyKTsKICB9CiAgI2NoaWxkcmVuSWdub3JlZChwYXRoMikgewogICAgcmV0dXJuICEhdGhpcy4jaWdub3JlPy5jaGlsZHJlbklnbm9yZWQ/LihwYXRoMik7CiAgfQogIC8vIGJhY2twcmVzc3VyZSBtZWNoYW5pc20KICBwYXVzZSgpIHsKICAgIHRoaXMucGF1c2VkID0gdHJ1ZTsKICB9CiAgcmVzdW1lKCkgewogICAgaWYgKHRoaXMuc2lnbmFsPy5hYm9ydGVkKQogICAgICByZXR1cm47CiAgICB0aGlzLnBhdXNlZCA9IGZhbHNlOwogICAgbGV0IGZuID0gdm9pZCAwOwogICAgd2hpbGUgKCF0aGlzLnBhdXNlZCAmJiAoZm4gPSB0aGlzLiNvblJlc3VtZS5zaGlmdCgpKSkgewogICAgICBmbigpOwogICAgfQogIH0KICBvblJlc3VtZShmbikgewogICAgaWYgKHRoaXMuc2lnbmFsPy5hYm9ydGVkKQogICAgICByZXR1cm47CiAgICBpZiAoIXRoaXMucGF1c2VkKSB7CiAgICAgIGZuKCk7CiAgICB9IGVsc2UgewogICAgICB0aGlzLiNvblJlc3VtZS5wdXNoKGZuKTsKICAgIH0KICB9CiAgLy8gZG8gdGhlIHJlcXVpc2l0ZSByZWFscGF0aC9zdGF0IGNoZWNraW5nLCBhbmQgcmV0dXJuIHRoZSBwYXRoCiAgLy8gdG8gYWRkIG9yIHVuZGVmaW5lZCB0byBmaWx0ZXIgaXQgb3V0LgogIGFzeW5jIG1hdGNoQ2hlY2soZSwgaWZEaXIpIHsKICAgIGlmIChpZkRpciAmJiB0aGlzLm9wdHMubm9kaXIpCiAgICAgIHJldHVybiB2b2lkIDA7CiAgICBsZXQgcnBjOwogICAgaWYgKHRoaXMub3B0cy5yZWFscGF0aCkgewogICAgICBycGMgPSBlLnJlYWxwYXRoQ2FjaGVkKCkgfHwgYXdhaXQgZS5yZWFscGF0aCgpOwogICAgICBpZiAoIXJwYykKICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICBlID0gcnBjOwogICAgfQogICAgY29uc3QgbmVlZFN0YXQgPSBlLmlzVW5rbm93bigpIHx8IHRoaXMub3B0cy5zdGF0OwogICAgcmV0dXJuIHRoaXMubWF0Y2hDaGVja1Rlc3QobmVlZFN0YXQgPyBhd2FpdCBlLmxzdGF0KCkgOiBlLCBpZkRpcik7CiAgfQogIG1hdGNoQ2hlY2tUZXN0KGUsIGlmRGlyKSB7CiAgICByZXR1cm4gZSAmJiAodGhpcy5tYXhEZXB0aCA9PT0gSW5maW5pdHkgfHwgZS5kZXB0aCgpIDw9IHRoaXMubWF4RGVwdGgpICYmICghaWZEaXIgfHwgZS5jYW5SZWFkZGlyKCkpICYmICghdGhpcy5vcHRzLm5vZGlyIHx8ICFlLmlzRGlyZWN0b3J5KCkpICYmICF0aGlzLiNpZ25vcmVkKGUpID8gZSA6IHZvaWQgMDsKICB9CiAgbWF0Y2hDaGVja1N5bmMoZSwgaWZEaXIpIHsKICAgIGlmIChpZkRpciAmJiB0aGlzLm9wdHMubm9kaXIpCiAgICAgIHJldHVybiB2b2lkIDA7CiAgICBsZXQgcnBjOwogICAgaWYgKHRoaXMub3B0cy5yZWFscGF0aCkgewogICAgICBycGMgPSBlLnJlYWxwYXRoQ2FjaGVkKCkgfHwgZS5yZWFscGF0aFN5bmMoKTsKICAgICAgaWYgKCFycGMpCiAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgZSA9IHJwYzsKICAgIH0KICAgIGNvbnN0IG5lZWRTdGF0ID0gZS5pc1Vua25vd24oKSB8fCB0aGlzLm9wdHMuc3RhdDsKICAgIHJldHVybiB0aGlzLm1hdGNoQ2hlY2tUZXN0KG5lZWRTdGF0ID8gZS5sc3RhdFN5bmMoKSA6IGUsIGlmRGlyKTsKICB9CiAgbWF0Y2hGaW5pc2goZSwgYWJzb2x1dGUpIHsKICAgIGlmICh0aGlzLiNpZ25vcmVkKGUpKQogICAgICByZXR1cm47CiAgICBjb25zdCBhYnMgPSB0aGlzLm9wdHMuYWJzb2x1dGUgPT09IHZvaWQgMCA/IGFic29sdXRlIDogdGhpcy5vcHRzLmFic29sdXRlOwogICAgdGhpcy5zZWVuLmFkZChlKTsKICAgIGNvbnN0IG1hcmsgPSB0aGlzLm9wdHMubWFyayAmJiBlLmlzRGlyZWN0b3J5KCkgPyB0aGlzLiNzZXAgOiAiIjsKICAgIGlmICh0aGlzLm9wdHMud2l0aEZpbGVUeXBlcykgewogICAgICB0aGlzLm1hdGNoRW1pdChlKTsKICAgIH0gZWxzZSBpZiAoYWJzKSB7CiAgICAgIGNvbnN0IGFiczIgPSB0aGlzLm9wdHMucG9zaXggPyBlLmZ1bGxwYXRoUG9zaXgoKSA6IGUuZnVsbHBhdGgoKTsKICAgICAgdGhpcy5tYXRjaEVtaXQoYWJzMiArIG1hcmspOwogICAgfSBlbHNlIHsKICAgICAgY29uc3QgcmVsID0gdGhpcy5vcHRzLnBvc2l4ID8gZS5yZWxhdGl2ZVBvc2l4KCkgOiBlLnJlbGF0aXZlKCk7CiAgICAgIGNvbnN0IHByZSA9IHRoaXMub3B0cy5kb3RSZWxhdGl2ZSAmJiAhcmVsLnN0YXJ0c1dpdGgoIi4uIiArIHRoaXMuI3NlcCkgPyAiLiIgKyB0aGlzLiNzZXAgOiAiIjsKICAgICAgdGhpcy5tYXRjaEVtaXQoIXJlbCA/ICIuIiArIG1hcmsgOiBwcmUgKyByZWwgKyBtYXJrKTsKICAgIH0KICB9CiAgYXN5bmMgbWF0Y2goZSwgYWJzb2x1dGUsIGlmRGlyKSB7CiAgICBjb25zdCBwID0gYXdhaXQgdGhpcy5tYXRjaENoZWNrKGUsIGlmRGlyKTsKICAgIGlmIChwKQogICAgICB0aGlzLm1hdGNoRmluaXNoKHAsIGFic29sdXRlKTsKICB9CiAgbWF0Y2hTeW5jKGUsIGFic29sdXRlLCBpZkRpcikgewogICAgY29uc3QgcCA9IHRoaXMubWF0Y2hDaGVja1N5bmMoZSwgaWZEaXIpOwogICAgaWYgKHApCiAgICAgIHRoaXMubWF0Y2hGaW5pc2gocCwgYWJzb2x1dGUpOwogIH0KICB3YWxrQ0IodGFyZ2V0LCBwYXR0ZXJucywgY2IpIHsKICAgIGlmICh0aGlzLnNpZ25hbD8uYWJvcnRlZCkKICAgICAgY2IoKTsKICAgIHRoaXMud2Fsa0NCMih0YXJnZXQsIHBhdHRlcm5zLCBuZXcgUHJvY2Vzc29yKHRoaXMub3B0cyksIGNiKTsKICB9CiAgd2Fsa0NCMih0YXJnZXQsIHBhdHRlcm5zLCBwcm9jZXNzb3IsIGNiKSB7CiAgICBpZiAodGhpcy4jY2hpbGRyZW5JZ25vcmVkKHRhcmdldCkpCiAgICAgIHJldHVybiBjYigpOwogICAgaWYgKHRoaXMuc2lnbmFsPy5hYm9ydGVkKQogICAgICBjYigpOwogICAgaWYgKHRoaXMucGF1c2VkKSB7CiAgICAgIHRoaXMub25SZXN1bWUoKCkgPT4gdGhpcy53YWxrQ0IyKHRhcmdldCwgcGF0dGVybnMsIHByb2Nlc3NvciwgY2IpKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgcHJvY2Vzc29yLnByb2Nlc3NQYXR0ZXJucyh0YXJnZXQsIHBhdHRlcm5zKTsKICAgIGxldCB0YXNrcyA9IDE7CiAgICBjb25zdCBuZXh0ID0gKCkgPT4gewogICAgICBpZiAoLS10YXNrcyA9PT0gMCkKICAgICAgICBjYigpOwogICAgfTsKICAgIGZvciAoY29uc3QgW20sIGFic29sdXRlLCBpZkRpcl0gb2YgcHJvY2Vzc29yLm1hdGNoZXMuZW50cmllcygpKSB7CiAgICAgIGlmICh0aGlzLiNpZ25vcmVkKG0pKQogICAgICAgIGNvbnRpbnVlOwogICAgICB0YXNrcysrOwogICAgICB0aGlzLm1hdGNoKG0sIGFic29sdXRlLCBpZkRpcikudGhlbigoKSA9PiBuZXh0KCkpOwogICAgfQogICAgZm9yIChjb25zdCB0IG9mIHByb2Nlc3Nvci5zdWJ3YWxrVGFyZ2V0cygpKSB7CiAgICAgIGlmICh0aGlzLm1heERlcHRoICE9PSBJbmZpbml0eSAmJiB0LmRlcHRoKCkgPj0gdGhpcy5tYXhEZXB0aCkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIHRhc2tzKys7CiAgICAgIGNvbnN0IGNoaWxkcmVuQ2FjaGVkID0gdC5yZWFkZGlyQ2FjaGVkKCk7CiAgICAgIGlmICh0LmNhbGxlZFJlYWRkaXIoKSkKICAgICAgICB0aGlzLndhbGtDQjModCwgY2hpbGRyZW5DYWNoZWQsIHByb2Nlc3NvciwgbmV4dCk7CiAgICAgIGVsc2UgewogICAgICAgIHQucmVhZGRpckNCKChfLCBlbnRyaWVzKSA9PiB0aGlzLndhbGtDQjModCwgZW50cmllcywgcHJvY2Vzc29yLCBuZXh0KSwgdHJ1ZSk7CiAgICAgIH0KICAgIH0KICAgIG5leHQoKTsKICB9CiAgd2Fsa0NCMyh0YXJnZXQsIGVudHJpZXMsIHByb2Nlc3NvciwgY2IpIHsKICAgIHByb2Nlc3NvciA9IHByb2Nlc3Nvci5maWx0ZXJFbnRyaWVzKHRhcmdldCwgZW50cmllcyk7CiAgICBsZXQgdGFza3MgPSAxOwogICAgY29uc3QgbmV4dCA9ICgpID0+IHsKICAgICAgaWYgKC0tdGFza3MgPT09IDApCiAgICAgICAgY2IoKTsKICAgIH07CiAgICBmb3IgKGNvbnN0IFttLCBhYnNvbHV0ZSwgaWZEaXJdIG9mIHByb2Nlc3Nvci5tYXRjaGVzLmVudHJpZXMoKSkgewogICAgICBpZiAodGhpcy4jaWdub3JlZChtKSkKICAgICAgICBjb250aW51ZTsKICAgICAgdGFza3MrKzsKICAgICAgdGhpcy5tYXRjaChtLCBhYnNvbHV0ZSwgaWZEaXIpLnRoZW4oKCkgPT4gbmV4dCgpKTsKICAgIH0KICAgIGZvciAoY29uc3QgW3RhcmdldDIsIHBhdHRlcm5zXSBvZiBwcm9jZXNzb3Iuc3Vid2Fsa3MuZW50cmllcygpKSB7CiAgICAgIHRhc2tzKys7CiAgICAgIHRoaXMud2Fsa0NCMih0YXJnZXQyLCBwYXR0ZXJucywgcHJvY2Vzc29yLmNoaWxkKCksIG5leHQpOwogICAgfQogICAgbmV4dCgpOwogIH0KICB3YWxrQ0JTeW5jKHRhcmdldCwgcGF0dGVybnMsIGNiKSB7CiAgICBpZiAodGhpcy5zaWduYWw/LmFib3J0ZWQpCiAgICAgIGNiKCk7CiAgICB0aGlzLndhbGtDQjJTeW5jKHRhcmdldCwgcGF0dGVybnMsIG5ldyBQcm9jZXNzb3IodGhpcy5vcHRzKSwgY2IpOwogIH0KICB3YWxrQ0IyU3luYyh0YXJnZXQsIHBhdHRlcm5zLCBwcm9jZXNzb3IsIGNiKSB7CiAgICBpZiAodGhpcy4jY2hpbGRyZW5JZ25vcmVkKHRhcmdldCkpCiAgICAgIHJldHVybiBjYigpOwogICAgaWYgKHRoaXMuc2lnbmFsPy5hYm9ydGVkKQogICAgICBjYigpOwogICAgaWYgKHRoaXMucGF1c2VkKSB7CiAgICAgIHRoaXMub25SZXN1bWUoKCkgPT4gdGhpcy53YWxrQ0IyU3luYyh0YXJnZXQsIHBhdHRlcm5zLCBwcm9jZXNzb3IsIGNiKSk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHByb2Nlc3Nvci5wcm9jZXNzUGF0dGVybnModGFyZ2V0LCBwYXR0ZXJucyk7CiAgICBsZXQgdGFza3MgPSAxOwogICAgY29uc3QgbmV4dCA9ICgpID0+IHsKICAgICAgaWYgKC0tdGFza3MgPT09IDApCiAgICAgICAgY2IoKTsKICAgIH07CiAgICBmb3IgKGNvbnN0IFttLCBhYnNvbHV0ZSwgaWZEaXJdIG9mIHByb2Nlc3Nvci5tYXRjaGVzLmVudHJpZXMoKSkgewogICAgICBpZiAodGhpcy4jaWdub3JlZChtKSkKICAgICAgICBjb250aW51ZTsKICAgICAgdGhpcy5tYXRjaFN5bmMobSwgYWJzb2x1dGUsIGlmRGlyKTsKICAgIH0KICAgIGZvciAoY29uc3QgdCBvZiBwcm9jZXNzb3Iuc3Vid2Fsa1RhcmdldHMoKSkgewogICAgICBpZiAodGhpcy5tYXhEZXB0aCAhPT0gSW5maW5pdHkgJiYgdC5kZXB0aCgpID49IHRoaXMubWF4RGVwdGgpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICB0YXNrcysrOwogICAgICBjb25zdCBjaGlsZHJlbiA9IHQucmVhZGRpclN5bmMoKTsKICAgICAgdGhpcy53YWxrQ0IzU3luYyh0LCBjaGlsZHJlbiwgcHJvY2Vzc29yLCBuZXh0KTsKICAgIH0KICAgIG5leHQoKTsKICB9CiAgd2Fsa0NCM1N5bmModGFyZ2V0LCBlbnRyaWVzLCBwcm9jZXNzb3IsIGNiKSB7CiAgICBwcm9jZXNzb3IgPSBwcm9jZXNzb3IuZmlsdGVyRW50cmllcyh0YXJnZXQsIGVudHJpZXMpOwogICAgbGV0IHRhc2tzID0gMTsKICAgIGNvbnN0IG5leHQgPSAoKSA9PiB7CiAgICAgIGlmICgtLXRhc2tzID09PSAwKQogICAgICAgIGNiKCk7CiAgICB9OwogICAgZm9yIChjb25zdCBbbSwgYWJzb2x1dGUsIGlmRGlyXSBvZiBwcm9jZXNzb3IubWF0Y2hlcy5lbnRyaWVzKCkpIHsKICAgICAgaWYgKHRoaXMuI2lnbm9yZWQobSkpCiAgICAgICAgY29udGludWU7CiAgICAgIHRoaXMubWF0Y2hTeW5jKG0sIGFic29sdXRlLCBpZkRpcik7CiAgICB9CiAgICBmb3IgKGNvbnN0IFt0YXJnZXQyLCBwYXR0ZXJuc10gb2YgcHJvY2Vzc29yLnN1YndhbGtzLmVudHJpZXMoKSkgewogICAgICB0YXNrcysrOwogICAgICB0aGlzLndhbGtDQjJTeW5jKHRhcmdldDIsIHBhdHRlcm5zLCBwcm9jZXNzb3IuY2hpbGQoKSwgbmV4dCk7CiAgICB9CiAgICBuZXh0KCk7CiAgfQp9CmNsYXNzIEdsb2JXYWxrZXIgZXh0ZW5kcyBHbG9iVXRpbCB7CiAgbWF0Y2hlczsKICBjb25zdHJ1Y3RvcihwYXR0ZXJucywgcGF0aDIsIG9wdHMpIHsKICAgIHN1cGVyKHBhdHRlcm5zLCBwYXRoMiwgb3B0cyk7CiAgICB0aGlzLm1hdGNoZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogIH0KICBtYXRjaEVtaXQoZSkgewogICAgdGhpcy5tYXRjaGVzLmFkZChlKTsKICB9CiAgYXN5bmMgd2FsaygpIHsKICAgIGlmICh0aGlzLnNpZ25hbD8uYWJvcnRlZCkKICAgICAgdGhyb3cgdGhpcy5zaWduYWwucmVhc29uOwogICAgaWYgKHRoaXMucGF0aC5pc1Vua25vd24oKSkgewogICAgICBhd2FpdCB0aGlzLnBhdGgubHN0YXQoKTsKICAgIH0KICAgIGF3YWl0IG5ldyBQcm9taXNlKChyZXMsIHJlaikgPT4gewogICAgICB0aGlzLndhbGtDQih0aGlzLnBhdGgsIHRoaXMucGF0dGVybnMsICgpID0+IHsKICAgICAgICBpZiAodGhpcy5zaWduYWw/LmFib3J0ZWQpIHsKICAgICAgICAgIHJlaih0aGlzLnNpZ25hbC5yZWFzb24pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXModGhpcy5tYXRjaGVzKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSk7CiAgICByZXR1cm4gdGhpcy5tYXRjaGVzOwogIH0KICB3YWxrU3luYygpIHsKICAgIGlmICh0aGlzLnNpZ25hbD8uYWJvcnRlZCkKICAgICAgdGhyb3cgdGhpcy5zaWduYWwucmVhc29uOwogICAgaWYgKHRoaXMucGF0aC5pc1Vua25vd24oKSkgewogICAgICB0aGlzLnBhdGgubHN0YXRTeW5jKCk7CiAgICB9CiAgICB0aGlzLndhbGtDQlN5bmModGhpcy5wYXRoLCB0aGlzLnBhdHRlcm5zLCAoKSA9PiB7CiAgICAgIGlmICh0aGlzLnNpZ25hbD8uYWJvcnRlZCkKICAgICAgICB0aHJvdyB0aGlzLnNpZ25hbC5yZWFzb247CiAgICB9KTsKICAgIHJldHVybiB0aGlzLm1hdGNoZXM7CiAgfQp9CmNsYXNzIEdsb2JTdHJlYW0gZXh0ZW5kcyBHbG9iVXRpbCB7CiAgcmVzdWx0czsKICBjb25zdHJ1Y3RvcihwYXR0ZXJucywgcGF0aDIsIG9wdHMpIHsKICAgIHN1cGVyKHBhdHRlcm5zLCBwYXRoMiwgb3B0cyk7CiAgICB0aGlzLnJlc3VsdHMgPSBuZXcgTWluaXBhc3MoewogICAgICBzaWduYWw6IHRoaXMuc2lnbmFsLAogICAgICBvYmplY3RNb2RlOiB0cnVlCiAgICB9KTsKICAgIHRoaXMucmVzdWx0cy5vbigiZHJhaW4iLCAoKSA9PiB0aGlzLnJlc3VtZSgpKTsKICAgIHRoaXMucmVzdWx0cy5vbigicmVzdW1lIiwgKCkgPT4gdGhpcy5yZXN1bWUoKSk7CiAgfQogIG1hdGNoRW1pdChlKSB7CiAgICB0aGlzLnJlc3VsdHMud3JpdGUoZSk7CiAgICBpZiAoIXRoaXMucmVzdWx0cy5mbG93aW5nKQogICAgICB0aGlzLnBhdXNlKCk7CiAgfQogIHN0cmVhbSgpIHsKICAgIGNvbnN0IHRhcmdldCA9IHRoaXMucGF0aDsKICAgIGlmICh0YXJnZXQuaXNVbmtub3duKCkpIHsKICAgICAgdGFyZ2V0LmxzdGF0KCkudGhlbigoKSA9PiB7CiAgICAgICAgdGhpcy53YWxrQ0IodGFyZ2V0LCB0aGlzLnBhdHRlcm5zLCAoKSA9PiB0aGlzLnJlc3VsdHMuZW5kKCkpOwogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMud2Fsa0NCKHRhcmdldCwgdGhpcy5wYXR0ZXJucywgKCkgPT4gdGhpcy5yZXN1bHRzLmVuZCgpKTsKICAgIH0KICAgIHJldHVybiB0aGlzLnJlc3VsdHM7CiAgfQogIHN0cmVhbVN5bmMoKSB7CiAgICBpZiAodGhpcy5wYXRoLmlzVW5rbm93bigpKSB7CiAgICAgIHRoaXMucGF0aC5sc3RhdFN5bmMoKTsKICAgIH0KICAgIHRoaXMud2Fsa0NCU3luYyh0aGlzLnBhdGgsIHRoaXMucGF0dGVybnMsICgpID0+IHRoaXMucmVzdWx0cy5lbmQoKSk7CiAgICByZXR1cm4gdGhpcy5yZXN1bHRzOwogIH0KfQpjb25zdCBkZWZhdWx0UGxhdGZvcm0gPSB0eXBlb2YgcHJvY2VzcyA9PT0gIm9iamVjdCIgJiYgcHJvY2VzcyAmJiB0eXBlb2YgcHJvY2Vzcy5wbGF0Zm9ybSA9PT0gInN0cmluZyIgPyBwcm9jZXNzLnBsYXRmb3JtIDogImxpbnV4IjsKY2xhc3MgR2xvYiB7CiAgYWJzb2x1dGU7CiAgY3dkOwogIHJvb3Q7CiAgZG90OwogIGRvdFJlbGF0aXZlOwogIGZvbGxvdzsKICBpZ25vcmU7CiAgbWFnaWNhbEJyYWNlczsKICBtYXJrOwogIG1hdGNoQmFzZTsKICBtYXhEZXB0aDsKICBub2JyYWNlOwogIG5vY2FzZTsKICBub2RpcjsKICBub2V4dDsKICBub2dsb2JzdGFyOwogIHBhdHRlcm47CiAgcGxhdGZvcm07CiAgcmVhbHBhdGg7CiAgc2N1cnJ5OwogIHN0YXQ7CiAgc2lnbmFsOwogIHdpbmRvd3NQYXRoc05vRXNjYXBlOwogIHdpdGhGaWxlVHlwZXM7CiAgLyoqCiAgICogVGhlIG9wdGlvbnMgcHJvdmlkZWQgdG8gdGhlIGNvbnN0cnVjdG9yLgogICAqLwogIG9wdHM7CiAgLyoqCiAgICogQW4gYXJyYXkgb2YgcGFyc2VkIGltbXV0YWJsZSB7QGxpbmsgUGF0dGVybn0gb2JqZWN0cy4KICAgKi8KICBwYXR0ZXJuczsKICAvKioKICAgKiBBbGwgb3B0aW9ucyBhcmUgc3RvcmVkIGFzIHByb3BlcnRpZXMgb24gdGhlIGBHbG9iYCBvYmplY3QuCiAgICoKICAgKiBTZWUge0BsaW5rIEdsb2JPcHRpb25zfSBmb3IgZnVsbCBvcHRpb25zIGRlc2NyaXB0aW9ucy4KICAgKgogICAqIE5vdGUgdGhhdCBhIHByZXZpb3VzIGBHbG9iYCBvYmplY3QgY2FuIGJlIHBhc3NlZCBhcyB0aGUKICAgKiBgR2xvYk9wdGlvbnNgIHRvIGFub3RoZXIgYEdsb2JgIGluc3RhbnRpYXRpb24gdG8gcmUtdXNlIHNldHRpbmdzCiAgICogYW5kIGNhY2hlcyB3aXRoIGEgbmV3IHBhdHRlcm4uCiAgICoKICAgKiBUcmF2ZXJzYWwgZnVuY3Rpb25zIGNhbiBiZSBjYWxsZWQgbXVsdGlwbGUgdGltZXMgdG8gcnVuIHRoZSB3YWxrCiAgICogYWdhaW4uCiAgICovCiAgY29uc3RydWN0b3IocGF0dGVybiwgb3B0cykgewogICAgaWYgKCFvcHRzKQogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJnbG9iIG9wdGlvbnMgcmVxdWlyZWQiKTsKICAgIHRoaXMud2l0aEZpbGVUeXBlcyA9ICEhb3B0cy53aXRoRmlsZVR5cGVzOwogICAgdGhpcy5zaWduYWwgPSBvcHRzLnNpZ25hbDsKICAgIHRoaXMuZm9sbG93ID0gISFvcHRzLmZvbGxvdzsKICAgIHRoaXMuZG90ID0gISFvcHRzLmRvdDsKICAgIHRoaXMuZG90UmVsYXRpdmUgPSAhIW9wdHMuZG90UmVsYXRpdmU7CiAgICB0aGlzLm5vZGlyID0gISFvcHRzLm5vZGlyOwogICAgdGhpcy5tYXJrID0gISFvcHRzLm1hcms7CiAgICBpZiAoIW9wdHMuY3dkKSB7CiAgICAgIHRoaXMuY3dkID0gIiI7CiAgICB9IGVsc2UgaWYgKG9wdHMuY3dkIGluc3RhbmNlb2YgVVJMIHx8IG9wdHMuY3dkLnN0YXJ0c1dpdGgoImZpbGU6Ly8iKSkgewogICAgICBvcHRzLmN3ZCA9IGZpbGVVUkxUb1BhdGgob3B0cy5jd2QpOwogICAgfQogICAgdGhpcy5jd2QgPSBvcHRzLmN3ZCB8fCAiIjsKICAgIHRoaXMucm9vdCA9IG9wdHMucm9vdDsKICAgIHRoaXMubWFnaWNhbEJyYWNlcyA9ICEhb3B0cy5tYWdpY2FsQnJhY2VzOwogICAgdGhpcy5ub2JyYWNlID0gISFvcHRzLm5vYnJhY2U7CiAgICB0aGlzLm5vZXh0ID0gISFvcHRzLm5vZXh0OwogICAgdGhpcy5yZWFscGF0aCA9ICEhb3B0cy5yZWFscGF0aDsKICAgIHRoaXMuYWJzb2x1dGUgPSBvcHRzLmFic29sdXRlOwogICAgdGhpcy5ub2dsb2JzdGFyID0gISFvcHRzLm5vZ2xvYnN0YXI7CiAgICB0aGlzLm1hdGNoQmFzZSA9ICEhb3B0cy5tYXRjaEJhc2U7CiAgICB0aGlzLm1heERlcHRoID0gdHlwZW9mIG9wdHMubWF4RGVwdGggPT09ICJudW1iZXIiID8gb3B0cy5tYXhEZXB0aCA6IEluZmluaXR5OwogICAgdGhpcy5zdGF0ID0gISFvcHRzLnN0YXQ7CiAgICB0aGlzLmlnbm9yZSA9IG9wdHMuaWdub3JlOwogICAgaWYgKHRoaXMud2l0aEZpbGVUeXBlcyAmJiB0aGlzLmFic29sdXRlICE9PSB2b2lkIDApIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJjYW5ub3Qgc2V0IGFic29sdXRlIGFuZCB3aXRoRmlsZVR5cGVzOnRydWUiKTsKICAgIH0KICAgIGlmICh0eXBlb2YgcGF0dGVybiA9PT0gInN0cmluZyIpIHsKICAgICAgcGF0dGVybiA9IFtwYXR0ZXJuXTsKICAgIH0KICAgIHRoaXMud2luZG93c1BhdGhzTm9Fc2NhcGUgPSAhIW9wdHMud2luZG93c1BhdGhzTm9Fc2NhcGUgfHwgb3B0cy5hbGxvd1dpbmRvd3NFc2NhcGUgPT09IGZhbHNlOwogICAgaWYgKHRoaXMud2luZG93c1BhdGhzTm9Fc2NhcGUpIHsKICAgICAgcGF0dGVybiA9IHBhdHRlcm4ubWFwKChwKSA9PiBwLnJlcGxhY2UoL1xcL2csICIvIikpOwogICAgfQogICAgaWYgKHRoaXMubWF0Y2hCYXNlKSB7CiAgICAgIGlmIChvcHRzLm5vZ2xvYnN0YXIpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJiYXNlIG1hdGNoaW5nIHJlcXVpcmVzIGdsb2JzdGFyIik7CiAgICAgIH0KICAgICAgcGF0dGVybiA9IHBhdHRlcm4ubWFwKChwKSA9PiBwLmluY2x1ZGVzKCIvIikgPyBwIDogYC4vKiovJHtwfWApOwogICAgfQogICAgdGhpcy5wYXR0ZXJuID0gcGF0dGVybjsKICAgIHRoaXMucGxhdGZvcm0gPSBvcHRzLnBsYXRmb3JtIHx8IGRlZmF1bHRQbGF0Zm9ybTsKICAgIHRoaXMub3B0cyA9IHsgLi4ub3B0cywgcGxhdGZvcm06IHRoaXMucGxhdGZvcm0gfTsKICAgIGlmIChvcHRzLnNjdXJyeSkgewogICAgICB0aGlzLnNjdXJyeSA9IG9wdHMuc2N1cnJ5OwogICAgICBpZiAob3B0cy5ub2Nhc2UgIT09IHZvaWQgMCAmJiBvcHRzLm5vY2FzZSAhPT0gb3B0cy5zY3Vycnkubm9jYXNlKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJub2Nhc2Ugb3B0aW9uIGNvbnRyYWRpY3RzIHByb3ZpZGVkIHNjdXJyeSBvcHRpb24iKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgY29uc3QgU2N1cnJ5ID0gb3B0cy5wbGF0Zm9ybSA9PT0gIndpbjMyIiA/IFBhdGhTY3VycnlXaW4zMiA6IG9wdHMucGxhdGZvcm0gPT09ICJkYXJ3aW4iID8gUGF0aFNjdXJyeURhcndpbiA6IG9wdHMucGxhdGZvcm0gPyBQYXRoU2N1cnJ5UG9zaXggOiBQYXRoU2N1cnJ5OwogICAgICB0aGlzLnNjdXJyeSA9IG5ldyBTY3VycnkodGhpcy5jd2QsIHsKICAgICAgICBub2Nhc2U6IG9wdHMubm9jYXNlLAogICAgICAgIGZzOiBvcHRzLmZzCiAgICAgIH0pOwogICAgfQogICAgdGhpcy5ub2Nhc2UgPSB0aGlzLnNjdXJyeS5ub2Nhc2U7CiAgICBjb25zdCBub2Nhc2VNYWdpY09ubHkgPSB0aGlzLnBsYXRmb3JtID09PSAiZGFyd2luIiB8fCB0aGlzLnBsYXRmb3JtID09PSAid2luMzIiOwogICAgY29uc3QgbW1vID0gewogICAgICAvLyBkZWZhdWx0IG5vY2FzZSBiYXNlZCBvbiBwbGF0Zm9ybQogICAgICAuLi5vcHRzLAogICAgICBkb3Q6IHRoaXMuZG90LAogICAgICBtYXRjaEJhc2U6IHRoaXMubWF0Y2hCYXNlLAogICAgICBub2JyYWNlOiB0aGlzLm5vYnJhY2UsCiAgICAgIG5vY2FzZTogdGhpcy5ub2Nhc2UsCiAgICAgIG5vY2FzZU1hZ2ljT25seSwKICAgICAgbm9jb21tZW50OiB0cnVlLAogICAgICBub2V4dDogdGhpcy5ub2V4dCwKICAgICAgbm9uZWdhdGU6IHRydWUsCiAgICAgIG9wdGltaXphdGlvbkxldmVsOiAyLAogICAgICBwbGF0Zm9ybTogdGhpcy5wbGF0Zm9ybSwKICAgICAgd2luZG93c1BhdGhzTm9Fc2NhcGU6IHRoaXMud2luZG93c1BhdGhzTm9Fc2NhcGUsCiAgICAgIGRlYnVnOiAhIXRoaXMub3B0cy5kZWJ1ZwogICAgfTsKICAgIGNvbnN0IG1tcyA9IHRoaXMucGF0dGVybi5tYXAoKHApID0+IG5ldyBNaW5pbWF0Y2gocCwgbW1vKSk7CiAgICBjb25zdCBbbWF0Y2hTZXQsIGdsb2JQYXJ0c10gPSBtbXMucmVkdWNlKChzZXQsIG0pID0+IHsKICAgICAgc2V0WzBdLnB1c2goLi4ubS5zZXQpOwogICAgICBzZXRbMV0ucHVzaCguLi5tLmdsb2JQYXJ0cyk7CiAgICAgIHJldHVybiBzZXQ7CiAgICB9LCBbW10sIFtdXSk7CiAgICB0aGlzLnBhdHRlcm5zID0gbWF0Y2hTZXQubWFwKChzZXQsIGkpID0+IHsKICAgICAgcmV0dXJuIG5ldyBQYXR0ZXJuKHNldCwgZ2xvYlBhcnRzW2ldLCAwLCB0aGlzLnBsYXRmb3JtKTsKICAgIH0pOwogIH0KICBhc3luYyB3YWxrKCkgewogICAgcmV0dXJuIFsKICAgICAgLi4uYXdhaXQgbmV3IEdsb2JXYWxrZXIodGhpcy5wYXR0ZXJucywgdGhpcy5zY3VycnkuY3dkLCB7CiAgICAgICAgLi4udGhpcy5vcHRzLAogICAgICAgIG1heERlcHRoOiB0aGlzLm1heERlcHRoICE9PSBJbmZpbml0eSA/IHRoaXMubWF4RGVwdGggKyB0aGlzLnNjdXJyeS5jd2QuZGVwdGgoKSA6IEluZmluaXR5LAogICAgICAgIHBsYXRmb3JtOiB0aGlzLnBsYXRmb3JtLAogICAgICAgIG5vY2FzZTogdGhpcy5ub2Nhc2UKICAgICAgfSkud2FsaygpCiAgICBdOwogIH0KICB3YWxrU3luYygpIHsKICAgIHJldHVybiBbCiAgICAgIC4uLm5ldyBHbG9iV2Fsa2VyKHRoaXMucGF0dGVybnMsIHRoaXMuc2N1cnJ5LmN3ZCwgewogICAgICAgIC4uLnRoaXMub3B0cywKICAgICAgICBtYXhEZXB0aDogdGhpcy5tYXhEZXB0aCAhPT0gSW5maW5pdHkgPyB0aGlzLm1heERlcHRoICsgdGhpcy5zY3VycnkuY3dkLmRlcHRoKCkgOiBJbmZpbml0eSwKICAgICAgICBwbGF0Zm9ybTogdGhpcy5wbGF0Zm9ybSwKICAgICAgICBub2Nhc2U6IHRoaXMubm9jYXNlCiAgICAgIH0pLndhbGtTeW5jKCkKICAgIF07CiAgfQogIHN0cmVhbSgpIHsKICAgIHJldHVybiBuZXcgR2xvYlN0cmVhbSh0aGlzLnBhdHRlcm5zLCB0aGlzLnNjdXJyeS5jd2QsIHsKICAgICAgLi4udGhpcy5vcHRzLAogICAgICBtYXhEZXB0aDogdGhpcy5tYXhEZXB0aCAhPT0gSW5maW5pdHkgPyB0aGlzLm1heERlcHRoICsgdGhpcy5zY3VycnkuY3dkLmRlcHRoKCkgOiBJbmZpbml0eSwKICAgICAgcGxhdGZvcm06IHRoaXMucGxhdGZvcm0sCiAgICAgIG5vY2FzZTogdGhpcy5ub2Nhc2UKICAgIH0pLnN0cmVhbSgpOwogIH0KICBzdHJlYW1TeW5jKCkgewogICAgcmV0dXJuIG5ldyBHbG9iU3RyZWFtKHRoaXMucGF0dGVybnMsIHRoaXMuc2N1cnJ5LmN3ZCwgewogICAgICAuLi50aGlzLm9wdHMsCiAgICAgIG1heERlcHRoOiB0aGlzLm1heERlcHRoICE9PSBJbmZpbml0eSA/IHRoaXMubWF4RGVwdGggKyB0aGlzLnNjdXJyeS5jd2QuZGVwdGgoKSA6IEluZmluaXR5LAogICAgICBwbGF0Zm9ybTogdGhpcy5wbGF0Zm9ybSwKICAgICAgbm9jYXNlOiB0aGlzLm5vY2FzZQogICAgfSkuc3RyZWFtU3luYygpOwogIH0KICAvKioKICAgKiBEZWZhdWx0IHN5bmMgaXRlcmF0aW9uIGZ1bmN0aW9uLiBSZXR1cm5zIGEgR2VuZXJhdG9yIHRoYXQKICAgKiBpdGVyYXRlcyBvdmVyIHRoZSByZXN1bHRzLgogICAqLwogIGl0ZXJhdGVTeW5jKCkgewogICAgcmV0dXJuIHRoaXMuc3RyZWFtU3luYygpW1N5bWJvbC5pdGVyYXRvcl0oKTsKICB9CiAgW1N5bWJvbC5pdGVyYXRvcl0oKSB7CiAgICByZXR1cm4gdGhpcy5pdGVyYXRlU3luYygpOwogIH0KICAvKioKICAgKiBEZWZhdWx0IGFzeW5jIGl0ZXJhdGlvbiBmdW5jdGlvbi4gUmV0dXJucyBhbiBBc3luY0dlbmVyYXRvciB0aGF0CiAgICogaXRlcmF0ZXMgb3ZlciB0aGUgcmVzdWx0cy4KICAgKi8KICBpdGVyYXRlKCkgewogICAgcmV0dXJuIHRoaXMuc3RyZWFtKClbU3ltYm9sLmFzeW5jSXRlcmF0b3JdKCk7CiAgfQogIFtTeW1ib2wuYXN5bmNJdGVyYXRvcl0oKSB7CiAgICByZXR1cm4gdGhpcy5pdGVyYXRlKCk7CiAgfQp9CmNvbnN0IGhhc01hZ2ljID0gKHBhdHRlcm4sIG9wdGlvbnMgPSB7fSkgPT4gewogIGlmICghQXJyYXkuaXNBcnJheShwYXR0ZXJuKSkgewogICAgcGF0dGVybiA9IFtwYXR0ZXJuXTsKICB9CiAgZm9yIChjb25zdCBwIG9mIHBhdHRlcm4pIHsKICAgIGlmIChuZXcgTWluaW1hdGNoKHAsIG9wdGlvbnMpLmhhc01hZ2ljKCkpCiAgICAgIHJldHVybiB0cnVlOwogIH0KICByZXR1cm4gZmFsc2U7Cn07CmZ1bmN0aW9uIGdsb2JTdHJlYW1TeW5jKHBhdHRlcm4sIG9wdGlvbnMgPSB7fSkgewogIHJldHVybiBuZXcgR2xvYihwYXR0ZXJuLCBvcHRpb25zKS5zdHJlYW1TeW5jKCk7Cn0KZnVuY3Rpb24gZ2xvYlN0cmVhbShwYXR0ZXJuLCBvcHRpb25zID0ge30pIHsKICByZXR1cm4gbmV3IEdsb2IocGF0dGVybiwgb3B0aW9ucykuc3RyZWFtKCk7Cn0KZnVuY3Rpb24gZ2xvYlN5bmMocGF0dGVybiwgb3B0aW9ucyA9IHt9KSB7CiAgcmV0dXJuIG5ldyBHbG9iKHBhdHRlcm4sIG9wdGlvbnMpLndhbGtTeW5jKCk7Cn0KYXN5bmMgZnVuY3Rpb24gZ2xvYl8ocGF0dGVybiwgb3B0aW9ucyA9IHt9KSB7CiAgcmV0dXJuIG5ldyBHbG9iKHBhdHRlcm4sIG9wdGlvbnMpLndhbGsoKTsKfQpmdW5jdGlvbiBnbG9iSXRlcmF0ZVN5bmMocGF0dGVybiwgb3B0aW9ucyA9IHt9KSB7CiAgcmV0dXJuIG5ldyBHbG9iKHBhdHRlcm4sIG9wdGlvbnMpLml0ZXJhdGVTeW5jKCk7Cn0KZnVuY3Rpb24gZ2xvYkl0ZXJhdGUocGF0dGVybiwgb3B0aW9ucyA9IHt9KSB7CiAgcmV0dXJuIG5ldyBHbG9iKHBhdHRlcm4sIG9wdGlvbnMpLml0ZXJhdGUoKTsKfQpjb25zdCBzdHJlYW1TeW5jID0gZ2xvYlN0cmVhbVN5bmM7CmNvbnN0IHN0cmVhbSA9IE9iamVjdC5hc3NpZ24oZ2xvYlN0cmVhbSwgeyBzeW5jOiBnbG9iU3RyZWFtU3luYyB9KTsKY29uc3QgaXRlcmF0ZVN5bmMgPSBnbG9iSXRlcmF0ZVN5bmM7CmNvbnN0IGl0ZXJhdGUgPSBPYmplY3QuYXNzaWduKGdsb2JJdGVyYXRlLCB7CiAgc3luYzogZ2xvYkl0ZXJhdGVTeW5jCn0pOwpjb25zdCBzeW5jID0gT2JqZWN0LmFzc2lnbihnbG9iU3luYywgewogIHN0cmVhbTogZ2xvYlN0cmVhbVN5bmMsCiAgaXRlcmF0ZTogZ2xvYkl0ZXJhdGVTeW5jCn0pOwpjb25zdCBnbG9iID0gT2JqZWN0LmFzc2lnbihnbG9iXywgewogIGdsb2I6IGdsb2JfLAogIGdsb2JTeW5jLAogIHN5bmMsCiAgZ2xvYlN0cmVhbSwKICBzdHJlYW0sCiAgZ2xvYlN0cmVhbVN5bmMsCiAgc3RyZWFtU3luYywKICBnbG9iSXRlcmF0ZSwKICBpdGVyYXRlLAogIGdsb2JJdGVyYXRlU3luYywKICBpdGVyYXRlU3luYywKICBHbG9iLAogIGhhc01hZ2ljLAogIGVzY2FwZSwKICB1bmVzY2FwZTogdW5lc2NhcGUkMQp9KTsKZ2xvYi5nbG9iID0gZ2xvYjsKY29uc3QgY3VzdG9tRXJyb3JQcmVwYXJlU3RhY2tUcmFjZSA9IChlcnJvciwgc3RhY2spID0+IHsKICBFcnJvci5wcmVwYXJlU3RhY2tUcmFjZSA9IEVycm9yUHJlcGFyZVN0YWNrVHJhY2U7CiAgZXJyb3Iuc3RhY2sgPSBlcnJvci5zdGFjazsKICBFcnJvci5wcmVwYXJlU3RhY2tUcmFjZSA9IGN1c3RvbUVycm9yUHJlcGFyZVN0YWNrVHJhY2U7CiAgZXJyb3Iuc3RhY2sgPSBlcnJvci5zdGFjay5yZXBsYWNlQWxsKAogICAgL2RhdGE6XFN7NzAsfS9nLAogICAgKG1hdGNoMikgPT4gbWF0Y2gyLnNsaWNlKDAsIDcwKSArICIuLi4iCiAgKTsKICByZXR1cm4gZXJyb3Iuc3RhY2s7Cn07CmNvbnN0IEVycm9yUHJlcGFyZVN0YWNrVHJhY2UgPSBFcnJvci5wcmVwYXJlU3RhY2tUcmFjZTsKRXJyb3IucHJlcGFyZVN0YWNrVHJhY2UgPSBjdXN0b21FcnJvclByZXBhcmVTdGFja1RyYWNlOwpsZXQgZW50cnkgPSBnbG9iYWxUaGlzLmVudHJ5OwppZiAoIWVudHJ5KSB7CiAgY29uc3QgcmVxdWlyZTIgPSBjcmVhdGVSZXF1aXJlKCIvIik7CiAgY29uc3QgbWFpblBhdGggPSByZXF1aXJlMi5yZXNvbHZlKHByb2Nlc3MuYXJndlsxXSk7CiAgZW50cnkgPSBhd2FpdCBnbG9iKGAke21haW5QYXRofS57anMsY2pzLG1qcyxqc3gsdHMsY3RzLG10cyx0c3h9YCwgewogICAgaWdub3JlOiBtYWluUGF0aAogIH0pWzBdOwp9CmlmICghZW50cnkpIHsKICB0aHJvdyBuZXcgRE9NRXhjZXB0aW9uKCJFbnRyeSBub3QgZm91bmQiLCAiTm90Rm91bmRFcnJvciIpOwp9CmNvbnN0IHZlcnNpb24gPSAoYXdhaXQgKGF3YWl0IGZldGNoKCJodHRwczovL2Rlbm8uY29tL3ZlcnNpb25zLmpzb24iKSkuanNvbigpKS5jbGkuZmluZCgoeCkgPT4geC5zdGFydHNXaXRoKCJ2MS4iKSkuc2xpY2UoMSk7CnByb2Nlc3MuZW52LkRFTk9fSU5TVEFMTCA9IGpvaW4odG1wZGlyKCksICJkZW5vIik7CmF3YWl0IHBpcGVsaW5lKAogIChhd2FpdCBmZXRjaCgiaHR0cHM6Ly9kZW5vLmxhbmQvaW5zdGFsbC5zaCIpKS5ib2R5LAogIGNyZWF0ZVdyaXRlU3RyZWFtKGpvaW4ocHJvY2Vzcy5lbnYuREVOT19JTlNUQUxMLCAiaW5zdGFsbC5zaCIpKQopOwphd2FpdCAkYHNoICR7am9pbihwcm9jZXNzLmVudi5ERU5PX0lOU1RBTEwsICJpbnN0YWxsLnNoIil9IHYke3ZlcnNpb259YDsKY29yZUV4cG9ydHMuYWRkUGF0aChqb2luKHByb2Nlc3MuZW52LkRFTk9fSU5TVEFMTCwgImJpbiIpKTsKYXdhaXQgJCh7IHN0ZGlvOiAiaW5oZXJpdCIgfSlgZGVubyBydW4gLUFxICR7ZW50cnl9YDsK")